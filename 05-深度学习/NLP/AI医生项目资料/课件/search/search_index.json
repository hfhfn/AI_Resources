{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"1/","text":"1.1 \u80cc\u666f\u4ecb\u7ecd \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u7684\u76f8\u5173\u80cc\u666f\u77e5\u8bc6. \u638c\u63e1\u4f7f\u7528Unit\u5bf9\u8bddAPI. \u4ec0\u4e48\u662f\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\uff1f \u968f\u7740\u4eba\u5de5\u667a\u80fd\u6280\u672f\u7684\u53d1\u5c55, \u804a\u5929\u673a\u5668\u4eba, \u8bed\u97f3\u52a9\u624b\u7b49\u5e94\u7528\u5728\u751f\u6d3b\u4e2d\u968f\u5904\u53ef\u89c1, \u6bd4\u5982\u767e\u5ea6\u7684\u5c0f\u5ea6, \u963f\u91cc\u7684\u5c0f\u871c, \u5fae\u8f6f\u7684\u5c0f\u51b0\u7b49\u7b49. \u5176\u76ee\u7684\u5728\u4e8e\u901a\u8fc7\u4eba\u5de5\u667a\u80fd\u6280\u672f\u8ba9\u673a\u5668\u50cf\u4eba\u7c7b\u4e00\u6837\u80fd\u591f\u8fdb\u884c\u667a\u80fd\u56de\u590d, \u89e3\u51b3\u73b0\u5b9e\u4e2d\u7684\u5404\u79cd\u95ee\u9898. \u4ece\u5904\u7406\u95ee\u9898\u7684\u89d2\u5ea6\u6765\u533a\u5206, \u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u53ef\u5206\u4e3a: \u4efb\u52a1\u5bfc\u5411\u578b: \u5b8c\u6210\u5177\u6709\u660e\u786e\u6307\u5411\u6027\u7684\u4efb\u52a1, \u6bd4\u5982\u9884\u5b9a\u9152\u5e97\u54a8\u8be2, \u5728\u7ebf\u95ee\u8bca\u7b49\u7b49. \u975e\u4efb\u52a1\u5bfc\u5411\u578b: \u6ca1\u6709\u660e\u786e\u76ee\u7684, \u6bd4\u5982\u7b97\u7b97\u672f, \u64ad\u653e\u97f3\u4e50, \u56de\u7b54\u95ee\u9898. \u6211\u4eec\u7684\u5728\u7ebf\u533b\u751f\u9879\u76ee\u5c31\u662f\u4efb\u52a1\u5bfc\u5411\u578b\u7684\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf. 1.2 Unit\u5bf9\u8bddAPI\u7684\u4f7f\u7528 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3Unit\u5e73\u53f0\u7684\u76f8\u5173\u77e5\u8bc6. \u638c\u63e1\u8c03\u7528Unit API\u7684\u5b9e\u73b0\u8fc7\u7a0b. Unit\u5e73\u53f0\u7684\u76f8\u5173\u77e5\u8bc6: Unit\u5e73\u53f0\u662f\u767e\u5ea6\u5927\u8111\u5f00\u653e\u7684\u667a\u80fd\u5bf9\u8bdd\u5b9a\u5236\u4e0e\u670d\u52a1\u5e73\u53f0, \u4e5f\u662f\u5f53\u524d\u6700\u5927\u7684\u4e2d\u6587\u9886\u57df\u5bf9\u8bdd\u5f00\u653e\u5e73\u53f0\u4e4b\u4e00. Unit\u5bf9\u6ce8\u518c\u7528\u6237\u63d0\u4f9b\u514d\u8d39\u7684\u5bf9\u8bdd\u63a5\u53e3\u670d\u52a1, \u6bd4\u5982\u4e2d\u6587\u95f2\u804aAPI, \u767e\u79d1\u95ee\u7b54API, \u8bd7\u53e5\u751f\u6210API\u7b49, \u901a\u8fc7\u8fd9\u4e9bAPI\u6211\u4eec\u53ef\u4ee5\u611f\u53d7\u4e00\u4e0b\u667a\u80fd\u5bf9\u8bdd\u7684\u9b45\u529b, \u540c\u65f6\u5b83\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u4efb\u52a1\u5bfc\u5411\u578b\u5bf9\u8bdd\u7cfb\u7edf\u65e0\u6cd5\u5339\u914d\u7528\u6237\u8f93\u5165\u65f6\u7684\u6700\u7ec8\u9009\u62e9. Unit\u95f2\u804aAPI\u6f14\u793a: \u7528\u6237\u8f93\u5165 >>> \"\u4f60\u597d\" Unit\u56de\u590d >>> \"\u4f60\u597d,\u60f3\u804a\u4ec0\u4e48\u5462~\" \u7528\u6237\u8f93\u5165 >>> \"\u6211\u60f3\u6709\u4e00\u4e2a\u5973\u670b\u53cb!\" Unit\u56de\u590d >>> \"\u6211\u4e5f\u662f\u60f3\u8981\u4e00\u4e2a\u5973\u670b\u53cb~\" \u7528\u6237\u8f93\u5165 >>> \"\u665a\u5403\u5565\u5462\u60f3\u60f3\" Unit\u56de\u590d >>> \"\u60f3\u5403\u706b\u9505\" \u8c03\u7528Unit API\u7684\u5b9e\u73b0\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u6ce8\u518c\u767b\u5f55\u767e\u5ea6\u8d26\u6237, \u8fdb\u5165Unit\u63a7\u5236\u53f0\u521b\u5efa\u81ea\u5df1\u7684\u673a\u5668\u4eba. \u7b2c\u4e8c\u6b65: \u8fdb\u884c\u76f8\u5173\u914d\u7f6e, \u83b7\u5f97\u8bf7\u6c42API\u63a5\u53e3\u9700\u8981\u7684API Key\u4e0eSecret Key. \u7b2c\u4e09\u6b65: \u5728\u670d\u52a1\u5668\u4e0a\u7f16\u5199API\u8c03\u7528\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5. \u7b2c\u4e00\u6b65: \u6ce8\u518c\u767b\u5f55\u767e\u5ea6\u8d26\u6237, \u8fdb\u5165Unit\u63a7\u5236\u53f0\u521b\u5efa\u81ea\u5df1\u7684\u673a\u5668\u4eba. \u7b2c\u4e8c\u6b65: \u8fdb\u884c\u76f8\u5173\u914d\u7f6e, \u83b7\u5f97\u8bf7\u6c42API\u63a5\u53e3\u9700\u8981\u7684API Key\u4e0eSecret Key. \u70b9\u51fb\u83b7\u53d6API Key\u8fdb\u5165\u767e\u5ea6\u4e91\u5e94\u7528\u7ba1\u7406\u9875\u9762. \u70b9\u51fb\u521b\u5efa\u5e94\u7528, \u8fdb\u5165\u5e94\u7528\u4fe1\u606f\u8868\u5355\u586b\u5199\u9875\u9762. \u586b\u5199\u5b8c\u6bd5\u540e, \u70b9\u51fb\u7acb\u5373\u521b\u5efa, \u6210\u529f\u540e\u4f1a\u63d0\u793a\u521b\u5efa\u5b8c\u6bd5. \u70b9\u51fb\u8fd4\u56de\u5e94\u7528\u5217\u8868. \u53ef\u4ee5\u770b\u5230\u521b\u5efa\u7684API Key\u548cSecret Key, \u81f3\u6b64\u521b\u5efa\u6d41\u7a0b\u7ed3\u675f. \u7b2c\u4e09\u6b65: \u5728\u670d\u52a1\u5668\u4e0a\u7f16\u5199API\u8c03\u7528\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5 import json import random import requests # client_id \u4e3a\u5b98\u7f51\u83b7\u53d6\u7684AK\uff0c client_secret \u4e3a\u5b98\u7f51\u83b7\u53d6\u7684SK client_id = \"1xhPonkmHqwolDt3GCICLX39\" client_secret = \"SRYsfjMGNuW8G265paMXLEjDTjO6O4RC\" def unit_chat(chat_input, user_id=\"88888\"): \"\"\" description:\u8c03\u7528\u767e\u5ea6UNIT\u63a5\u53e3\uff0c\u56de\u590d\u804a\u5929\u5185\u5bb9 Parameters ---------- chat_input : str \u7528\u6237\u53d1\u9001\u5929\u5185\u5bb9 user_id : str \u53d1\u8d77\u804a\u5929\u7528\u6237ID\uff0c\u53ef\u4efb\u610f\u5b9a\u4e49 Return ---------- \u8fd4\u56deunit\u56de\u590d\u5185\u5bb9 \"\"\" # \u8bbe\u7f6e\u9ed8\u8ba4\u56de\u590d\u5185\u5bb9, \u4e00\u65e6\u63a5\u53e3\u51fa\u73b0\u5f02\u5e38, \u56de\u590d\u8be5\u5185\u5bb9 chat_reply = \"\u4e0d\u597d\u610f\u601d\uff0c\u4ffa\u4eec\u6b63\u5728\u5b66\u4e60\u4e2d\uff0c\u968f\u540e\u56de\u590d\u4f60\u3002\" # \u6839\u636e client_id \u4e0e client_secret \u83b7\u53d6access_token url = \"https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=%s&client_secret=%s\" % ( client_id, client_secret) res = requests.get(url) access_token = eval(res.text)[\"access_token\"] # \u6839\u636e access_token \u83b7\u53d6\u804a\u5929\u673a\u5668\u4eba\u63a5\u53e3\u6570\u636e unit_chatbot_url = \"https://aip.baidubce.com/rpc/2.0/unit/service/chat?access_token=\" + access_token # \u62fc\u88c5\u804a\u5929\u63a5\u53e3\u5bf9\u5e94\u8bf7\u6c42\u53d1\u9001\u6570\u636e\uff0c\u4e3b\u8981\u662f\u586b\u5145 query \u503c post_data = { \"log_id\": str(random.random()), \"request\": { \"query\": chat_input, \"user_id\": user_id }, \"session_id\": \"\", \"service_id\": \"S23245\", \"version\": \"2.0\" } # \u5c06\u5c01\u88c5\u597d\u7684\u6570\u636e\u4f5c\u4e3a\u8bf7\u6c42\u5185\u5bb9, \u53d1\u9001\u7ed9Unit\u804a\u5929\u673a\u5668\u4eba\u63a5\u53e3, \u5e76\u5f97\u5230\u8fd4\u56de\u7ed3\u679c res = requests.post(url=unit_chatbot_url, json=post_data) # \u83b7\u53d6\u804a\u5929\u63a5\u53e3\u8fd4\u56de\u6570\u636e unit_chat_obj = json.loads(res.content) # print(unit_chat_obj) # \u6253\u5370\u8fd4\u56de\u7684\u7ed3\u679c # \u5224\u65ad\u804a\u5929\u63a5\u53e3\u8fd4\u56de\u6570\u636e\u662f\u5426\u51fa\u9519 error_code == 0 \u5219\u8868\u793a\u8bf7\u6c42\u6b63\u786e if unit_chat_obj[\"error_code\"] != 0: return chat_reply # \u89e3\u6790\u804a\u5929\u63a5\u53e3\u8fd4\u56de\u6570\u636e\uff0c\u627e\u5230\u8fd4\u56de\u6587\u672c\u5185\u5bb9 result -> response_list -> schema -> intent_confidence(>0) -> action_list -> say unit_chat_obj_result = unit_chat_obj[\"result\"] unit_chat_response_list = unit_chat_obj_result[\"response_list\"] # \u968f\u673a\u9009\u53d6\u4e00\u4e2a\"\u610f\u56fe\u7f6e\u4fe1\u5ea6\"[+response_list[].schema.intent_confidence]\u4e0d\u4e3a0\u7684\u6280\u80fd\u4f5c\u4e3a\u56de\u7b54 unit_chat_response_obj = random.choice( [unit_chat_response for unit_chat_response in unit_chat_response_list if unit_chat_response[\"schema\"][\"intent_confidence\"] > 0.0]) unit_chat_response_action_list = unit_chat_response_obj[\"action_list\"] unit_chat_response_action_obj = random.choice(unit_chat_response_action_list) unit_chat_response_say = unit_chat_response_action_obj[\"say\"] return unit_chat_response_say if __name__ == '__main__': while True: chat_input = input(\"\u8bf7\u8f93\u5165:\") print(chat_input) chat_reply = unit_chat(chat_input) print(\"\u7528\u6237\u8f93\u5165 >>>\", chat_input) print(\"Unit\u56de\u590d >>>\", chat_reply) if chat_input == 'Q' or chat_input == 'q': break \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/unit.py \u8c03\u7528: python unit.py \u8f93\u51fa\u6548\u679c: \u8bf7\u8f93\u5165:\u4f60\u597d\u554a \u4f60\u597d\u554a \u7528\u6237\u8f93\u5165 >>> \u4f60\u597d\u554a Unit\u56de\u590d >>> \u4f60\u4e5f\u597d\u554a~ \u8bf7\u8f93\u5165:\u4eca\u5929\u5929\u6c14\u68d2\u68d2\u54d2 \u4eca\u5929\u5929\u6c14\u68d2\u68d2\u54d2 \u7528\u6237\u8f93\u5165 >>> \u4eca\u5929\u5929\u6c14\u68d2\u68d2\u54d2 Unit\u56de\u590d >>> \u5fc5\u987b\u7684 \u8bf7\u8f93\u5165:\u665a\u996d\u5403\u70b9\u4ec0\u4e48? \u665a\u996d\u5403\u70b9\u4ec0\u4e48? \u7528\u6237\u8f93\u5165 >>> \u665a\u996d\u5403\u70b9\u4ec0\u4e48? Unit\u56de\u590d >>> \u665a\u996d\u6ca1\u5403\uff0c\u51cf\u80a5 \u8bf7\u8f93\u5165: \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u7684\u76f8\u5173\u80cc\u666f\u77e5\u8bc6: \u4ec0\u4e48\u662f\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf \u4ece\u5904\u7406\u95ee\u9898\u7684\u76ee\u7684\u6765\u533a\u5206, \u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u7684\u5206\u7c7b \u6211\u4eec\u7684\u5728\u7ebf\u533b\u751f\u9879\u76ee\u5c31\u662f\u4efb\u52a1\u5bfc\u5411\u578b\u7684\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf. \u5b66\u4e60\u4e86Unit\u5e73\u53f0\u7684\u76f8\u5173\u77e5\u8bc6: Unit\u5e73\u53f0\u662f\u767e\u5ea6\u5927\u8111\u5f00\u653e\u7684\u667a\u80fd\u5bf9\u8bdd\u5b9a\u5236\u4e0e\u670d\u52a1\u5e73\u53f0, \u4e5f\u662f\u5f53\u524d\u6700\u5927\u7684\u4e2d\u6587\u9886\u57df\u5bf9\u8bdd\u5f00\u653e\u5e73\u53f0\u4e4b\u4e00. \u5b66\u4e60\u4e86\u8c03\u7528Unit API\u7684\u5b9e\u73b0\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u6ce8\u518c\u767b\u5f55\u767e\u5ea6\u8d26\u6237, \u8fdb\u5165Unit\u63a7\u5236\u53f0\u521b\u5efa\u81ea\u5df1\u7684\u673a\u5668\u4eba. \u7b2c\u4e8c\u6b65: \u8fdb\u884c\u76f8\u5173\u914d\u7f6e, \u83b7\u5f97\u8bf7\u6c42API\u63a5\u53e3\u9700\u8981\u7684API Key\u4e0eSecret Key. \u7b2c\u4e09\u6b65: \u5728\u670d\u52a1\u5668\u4e0a\u7f16\u5199API\u8c03\u7528\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5.","title":"\u7b2c\u4e00\u7ae0:\u80cc\u666f\u4ecb\u7ecd\u4e0eUnit\u7684\u4f7f\u7528"},{"location":"1/#11","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u7684\u76f8\u5173\u80cc\u666f\u77e5\u8bc6. \u638c\u63e1\u4f7f\u7528Unit\u5bf9\u8bddAPI. \u4ec0\u4e48\u662f\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\uff1f \u968f\u7740\u4eba\u5de5\u667a\u80fd\u6280\u672f\u7684\u53d1\u5c55, \u804a\u5929\u673a\u5668\u4eba, \u8bed\u97f3\u52a9\u624b\u7b49\u5e94\u7528\u5728\u751f\u6d3b\u4e2d\u968f\u5904\u53ef\u89c1, \u6bd4\u5982\u767e\u5ea6\u7684\u5c0f\u5ea6, \u963f\u91cc\u7684\u5c0f\u871c, \u5fae\u8f6f\u7684\u5c0f\u51b0\u7b49\u7b49. \u5176\u76ee\u7684\u5728\u4e8e\u901a\u8fc7\u4eba\u5de5\u667a\u80fd\u6280\u672f\u8ba9\u673a\u5668\u50cf\u4eba\u7c7b\u4e00\u6837\u80fd\u591f\u8fdb\u884c\u667a\u80fd\u56de\u590d, \u89e3\u51b3\u73b0\u5b9e\u4e2d\u7684\u5404\u79cd\u95ee\u9898. \u4ece\u5904\u7406\u95ee\u9898\u7684\u89d2\u5ea6\u6765\u533a\u5206, \u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u53ef\u5206\u4e3a: \u4efb\u52a1\u5bfc\u5411\u578b: \u5b8c\u6210\u5177\u6709\u660e\u786e\u6307\u5411\u6027\u7684\u4efb\u52a1, \u6bd4\u5982\u9884\u5b9a\u9152\u5e97\u54a8\u8be2, \u5728\u7ebf\u95ee\u8bca\u7b49\u7b49. \u975e\u4efb\u52a1\u5bfc\u5411\u578b: \u6ca1\u6709\u660e\u786e\u76ee\u7684, \u6bd4\u5982\u7b97\u7b97\u672f, \u64ad\u653e\u97f3\u4e50, \u56de\u7b54\u95ee\u9898. \u6211\u4eec\u7684\u5728\u7ebf\u533b\u751f\u9879\u76ee\u5c31\u662f\u4efb\u52a1\u5bfc\u5411\u578b\u7684\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf.","title":"1.1 \u80cc\u666f\u4ecb\u7ecd"},{"location":"1/#12-unitapi","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3Unit\u5e73\u53f0\u7684\u76f8\u5173\u77e5\u8bc6. \u638c\u63e1\u8c03\u7528Unit API\u7684\u5b9e\u73b0\u8fc7\u7a0b. Unit\u5e73\u53f0\u7684\u76f8\u5173\u77e5\u8bc6: Unit\u5e73\u53f0\u662f\u767e\u5ea6\u5927\u8111\u5f00\u653e\u7684\u667a\u80fd\u5bf9\u8bdd\u5b9a\u5236\u4e0e\u670d\u52a1\u5e73\u53f0, \u4e5f\u662f\u5f53\u524d\u6700\u5927\u7684\u4e2d\u6587\u9886\u57df\u5bf9\u8bdd\u5f00\u653e\u5e73\u53f0\u4e4b\u4e00. Unit\u5bf9\u6ce8\u518c\u7528\u6237\u63d0\u4f9b\u514d\u8d39\u7684\u5bf9\u8bdd\u63a5\u53e3\u670d\u52a1, \u6bd4\u5982\u4e2d\u6587\u95f2\u804aAPI, \u767e\u79d1\u95ee\u7b54API, \u8bd7\u53e5\u751f\u6210API\u7b49, \u901a\u8fc7\u8fd9\u4e9bAPI\u6211\u4eec\u53ef\u4ee5\u611f\u53d7\u4e00\u4e0b\u667a\u80fd\u5bf9\u8bdd\u7684\u9b45\u529b, \u540c\u65f6\u5b83\u4e5f\u53ef\u4ee5\u4f5c\u4e3a\u4efb\u52a1\u5bfc\u5411\u578b\u5bf9\u8bdd\u7cfb\u7edf\u65e0\u6cd5\u5339\u914d\u7528\u6237\u8f93\u5165\u65f6\u7684\u6700\u7ec8\u9009\u62e9. Unit\u95f2\u804aAPI\u6f14\u793a: \u7528\u6237\u8f93\u5165 >>> \"\u4f60\u597d\" Unit\u56de\u590d >>> \"\u4f60\u597d,\u60f3\u804a\u4ec0\u4e48\u5462~\" \u7528\u6237\u8f93\u5165 >>> \"\u6211\u60f3\u6709\u4e00\u4e2a\u5973\u670b\u53cb!\" Unit\u56de\u590d >>> \"\u6211\u4e5f\u662f\u60f3\u8981\u4e00\u4e2a\u5973\u670b\u53cb~\" \u7528\u6237\u8f93\u5165 >>> \"\u665a\u5403\u5565\u5462\u60f3\u60f3\" Unit\u56de\u590d >>> \"\u60f3\u5403\u706b\u9505\" \u8c03\u7528Unit API\u7684\u5b9e\u73b0\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u6ce8\u518c\u767b\u5f55\u767e\u5ea6\u8d26\u6237, \u8fdb\u5165Unit\u63a7\u5236\u53f0\u521b\u5efa\u81ea\u5df1\u7684\u673a\u5668\u4eba. \u7b2c\u4e8c\u6b65: \u8fdb\u884c\u76f8\u5173\u914d\u7f6e, \u83b7\u5f97\u8bf7\u6c42API\u63a5\u53e3\u9700\u8981\u7684API Key\u4e0eSecret Key. \u7b2c\u4e09\u6b65: \u5728\u670d\u52a1\u5668\u4e0a\u7f16\u5199API\u8c03\u7528\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5. \u7b2c\u4e00\u6b65: \u6ce8\u518c\u767b\u5f55\u767e\u5ea6\u8d26\u6237, \u8fdb\u5165Unit\u63a7\u5236\u53f0\u521b\u5efa\u81ea\u5df1\u7684\u673a\u5668\u4eba. \u7b2c\u4e8c\u6b65: \u8fdb\u884c\u76f8\u5173\u914d\u7f6e, \u83b7\u5f97\u8bf7\u6c42API\u63a5\u53e3\u9700\u8981\u7684API Key\u4e0eSecret Key. \u70b9\u51fb\u83b7\u53d6API Key\u8fdb\u5165\u767e\u5ea6\u4e91\u5e94\u7528\u7ba1\u7406\u9875\u9762. \u70b9\u51fb\u521b\u5efa\u5e94\u7528, \u8fdb\u5165\u5e94\u7528\u4fe1\u606f\u8868\u5355\u586b\u5199\u9875\u9762. \u586b\u5199\u5b8c\u6bd5\u540e, \u70b9\u51fb\u7acb\u5373\u521b\u5efa, \u6210\u529f\u540e\u4f1a\u63d0\u793a\u521b\u5efa\u5b8c\u6bd5. \u70b9\u51fb\u8fd4\u56de\u5e94\u7528\u5217\u8868. \u53ef\u4ee5\u770b\u5230\u521b\u5efa\u7684API Key\u548cSecret Key, \u81f3\u6b64\u521b\u5efa\u6d41\u7a0b\u7ed3\u675f. \u7b2c\u4e09\u6b65: \u5728\u670d\u52a1\u5668\u4e0a\u7f16\u5199API\u8c03\u7528\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5 import json import random import requests # client_id \u4e3a\u5b98\u7f51\u83b7\u53d6\u7684AK\uff0c client_secret \u4e3a\u5b98\u7f51\u83b7\u53d6\u7684SK client_id = \"1xhPonkmHqwolDt3GCICLX39\" client_secret = \"SRYsfjMGNuW8G265paMXLEjDTjO6O4RC\" def unit_chat(chat_input, user_id=\"88888\"): \"\"\" description:\u8c03\u7528\u767e\u5ea6UNIT\u63a5\u53e3\uff0c\u56de\u590d\u804a\u5929\u5185\u5bb9 Parameters ---------- chat_input : str \u7528\u6237\u53d1\u9001\u5929\u5185\u5bb9 user_id : str \u53d1\u8d77\u804a\u5929\u7528\u6237ID\uff0c\u53ef\u4efb\u610f\u5b9a\u4e49 Return ---------- \u8fd4\u56deunit\u56de\u590d\u5185\u5bb9 \"\"\" # \u8bbe\u7f6e\u9ed8\u8ba4\u56de\u590d\u5185\u5bb9, \u4e00\u65e6\u63a5\u53e3\u51fa\u73b0\u5f02\u5e38, \u56de\u590d\u8be5\u5185\u5bb9 chat_reply = \"\u4e0d\u597d\u610f\u601d\uff0c\u4ffa\u4eec\u6b63\u5728\u5b66\u4e60\u4e2d\uff0c\u968f\u540e\u56de\u590d\u4f60\u3002\" # \u6839\u636e client_id \u4e0e client_secret \u83b7\u53d6access_token url = \"https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=%s&client_secret=%s\" % ( client_id, client_secret) res = requests.get(url) access_token = eval(res.text)[\"access_token\"] # \u6839\u636e access_token \u83b7\u53d6\u804a\u5929\u673a\u5668\u4eba\u63a5\u53e3\u6570\u636e unit_chatbot_url = \"https://aip.baidubce.com/rpc/2.0/unit/service/chat?access_token=\" + access_token # \u62fc\u88c5\u804a\u5929\u63a5\u53e3\u5bf9\u5e94\u8bf7\u6c42\u53d1\u9001\u6570\u636e\uff0c\u4e3b\u8981\u662f\u586b\u5145 query \u503c post_data = { \"log_id\": str(random.random()), \"request\": { \"query\": chat_input, \"user_id\": user_id }, \"session_id\": \"\", \"service_id\": \"S23245\", \"version\": \"2.0\" } # \u5c06\u5c01\u88c5\u597d\u7684\u6570\u636e\u4f5c\u4e3a\u8bf7\u6c42\u5185\u5bb9, \u53d1\u9001\u7ed9Unit\u804a\u5929\u673a\u5668\u4eba\u63a5\u53e3, \u5e76\u5f97\u5230\u8fd4\u56de\u7ed3\u679c res = requests.post(url=unit_chatbot_url, json=post_data) # \u83b7\u53d6\u804a\u5929\u63a5\u53e3\u8fd4\u56de\u6570\u636e unit_chat_obj = json.loads(res.content) # print(unit_chat_obj) # \u6253\u5370\u8fd4\u56de\u7684\u7ed3\u679c # \u5224\u65ad\u804a\u5929\u63a5\u53e3\u8fd4\u56de\u6570\u636e\u662f\u5426\u51fa\u9519 error_code == 0 \u5219\u8868\u793a\u8bf7\u6c42\u6b63\u786e if unit_chat_obj[\"error_code\"] != 0: return chat_reply # \u89e3\u6790\u804a\u5929\u63a5\u53e3\u8fd4\u56de\u6570\u636e\uff0c\u627e\u5230\u8fd4\u56de\u6587\u672c\u5185\u5bb9 result -> response_list -> schema -> intent_confidence(>0) -> action_list -> say unit_chat_obj_result = unit_chat_obj[\"result\"] unit_chat_response_list = unit_chat_obj_result[\"response_list\"] # \u968f\u673a\u9009\u53d6\u4e00\u4e2a\"\u610f\u56fe\u7f6e\u4fe1\u5ea6\"[+response_list[].schema.intent_confidence]\u4e0d\u4e3a0\u7684\u6280\u80fd\u4f5c\u4e3a\u56de\u7b54 unit_chat_response_obj = random.choice( [unit_chat_response for unit_chat_response in unit_chat_response_list if unit_chat_response[\"schema\"][\"intent_confidence\"] > 0.0]) unit_chat_response_action_list = unit_chat_response_obj[\"action_list\"] unit_chat_response_action_obj = random.choice(unit_chat_response_action_list) unit_chat_response_say = unit_chat_response_action_obj[\"say\"] return unit_chat_response_say if __name__ == '__main__': while True: chat_input = input(\"\u8bf7\u8f93\u5165:\") print(chat_input) chat_reply = unit_chat(chat_input) print(\"\u7528\u6237\u8f93\u5165 >>>\", chat_input) print(\"Unit\u56de\u590d >>>\", chat_reply) if chat_input == 'Q' or chat_input == 'q': break \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/unit.py \u8c03\u7528: python unit.py \u8f93\u51fa\u6548\u679c: \u8bf7\u8f93\u5165:\u4f60\u597d\u554a \u4f60\u597d\u554a \u7528\u6237\u8f93\u5165 >>> \u4f60\u597d\u554a Unit\u56de\u590d >>> \u4f60\u4e5f\u597d\u554a~ \u8bf7\u8f93\u5165:\u4eca\u5929\u5929\u6c14\u68d2\u68d2\u54d2 \u4eca\u5929\u5929\u6c14\u68d2\u68d2\u54d2 \u7528\u6237\u8f93\u5165 >>> \u4eca\u5929\u5929\u6c14\u68d2\u68d2\u54d2 Unit\u56de\u590d >>> \u5fc5\u987b\u7684 \u8bf7\u8f93\u5165:\u665a\u996d\u5403\u70b9\u4ec0\u4e48? \u665a\u996d\u5403\u70b9\u4ec0\u4e48? \u7528\u6237\u8f93\u5165 >>> \u665a\u996d\u5403\u70b9\u4ec0\u4e48? Unit\u56de\u590d >>> \u665a\u996d\u6ca1\u5403\uff0c\u51cf\u80a5 \u8bf7\u8f93\u5165: \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u7684\u76f8\u5173\u80cc\u666f\u77e5\u8bc6: \u4ec0\u4e48\u662f\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf \u4ece\u5904\u7406\u95ee\u9898\u7684\u76ee\u7684\u6765\u533a\u5206, \u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf\u7684\u5206\u7c7b \u6211\u4eec\u7684\u5728\u7ebf\u533b\u751f\u9879\u76ee\u5c31\u662f\u4efb\u52a1\u5bfc\u5411\u578b\u7684\u667a\u80fd\u5bf9\u8bdd\u7cfb\u7edf. \u5b66\u4e60\u4e86Unit\u5e73\u53f0\u7684\u76f8\u5173\u77e5\u8bc6: Unit\u5e73\u53f0\u662f\u767e\u5ea6\u5927\u8111\u5f00\u653e\u7684\u667a\u80fd\u5bf9\u8bdd\u5b9a\u5236\u4e0e\u670d\u52a1\u5e73\u53f0, \u4e5f\u662f\u5f53\u524d\u6700\u5927\u7684\u4e2d\u6587\u9886\u57df\u5bf9\u8bdd\u5f00\u653e\u5e73\u53f0\u4e4b\u4e00. \u5b66\u4e60\u4e86\u8c03\u7528Unit API\u7684\u5b9e\u73b0\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u6ce8\u518c\u767b\u5f55\u767e\u5ea6\u8d26\u6237, \u8fdb\u5165Unit\u63a7\u5236\u53f0\u521b\u5efa\u81ea\u5df1\u7684\u673a\u5668\u4eba. \u7b2c\u4e8c\u6b65: \u8fdb\u884c\u76f8\u5173\u914d\u7f6e, \u83b7\u5f97\u8bf7\u6c42API\u63a5\u53e3\u9700\u8981\u7684API Key\u4e0eSecret Key. \u7b2c\u4e09\u6b65: \u5728\u670d\u52a1\u5668\u4e0a\u7f16\u5199API\u8c03\u7528\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5.","title":"1.2 Unit\u5bf9\u8bddAPI\u7684\u4f7f\u7528"},{"location":"10/","text":"AI\u533b\u751f\u5b89\u88c5\u90e8\u7f72\u624b\u518c \u6ce8\u610f\u4e8b\u9879: \u8fd9\u4e2a\u5b89\u88c5\u624b\u518c\u53ea\u9002\u7528\u4e8e\u64cd\u4f5c\u7cfb\u7edf: centos7. \u5b89\u88c5\u90e8\u7f72\u6b65\u9aa4: 1: \u62f7\u8d1d\u5fc5\u5907\u6587\u4ef6. 2: \u5b89\u88c5Anaconda\u79d1\u5b66\u8ba1\u7b97\u73af\u5883, \u5305\u62ecpython2, pip, pandas, numpy, matplotplib\u7b49\u79d1\u5b66\u8ba1\u7b97\u5305. # \u5c06\u73af\u5883\u5305\u5b89\u88c5\u5728/root/\u76ee\u5f55\u4e0b cd /root curl -O https://repo.anaconda.com/archive/Anaconda3-5.2.0-Linux-x86_64.sh sh Anaconda3-2019.07-Linux-x86_64.sh # \u914d\u7f6e~/.bashrc, \u6dfb\u52a0\u4e00\u884c: export PATH=/root/anaconda/bin/:$PATH 3: \u5b89\u88c5\u9879\u76ee\u9700\u8981\u7684\u82e5\u5e72\u72ec\u7acb\u5de5\u5177. # \u5b89\u88c5Flask pip install Flask==1.1.1 # \u5b89\u88c5Redis\u6570\u636e\u5e93 yum install redis -y # \u5b89\u88c5python\u4e2d\u7684redis\u9a71\u52a8 pip install redis # \u5b89\u88c5gunicorn pip install gunicorn==20.0.4 # \u5b89\u88c5supervisor yum install supervisor -y # \u5b89\u88c5lsof yum install lsof -y 4: \u5b89\u88c5\u9879\u76ee\u9700\u8981\u7684\u91cd\u8981\u5de5\u5177Pytorch. # \u5b89\u88c5pytorch pip install pytorch 5: \u5b89\u88c5\u56fe\u6570\u636e\u5e93neo4j. # \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868 cd /tmp wget http://debian.neo4j.org/neotechnology.gpg.key rpm --import neotechnology.gpg.key cat <<EOF> /etc/yum.repos.d/neo4j.repo # \u5199\u5165\u4e0b\u9762\u5185\u5bb9 [neo4j] name=Neo4j RPM Repository baseurl=http://yum.neo4j.org/stable enabled=1 gpgcheck=1 # \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5 yum install neo4j-3.3.5 # \u7b2c\u4e09\u6b65: \u4f7f\u7528\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6 cp /data/neo4j.conf /etc/neo4j/neo4j.conf 6: \u542f\u52a8neo4j\u56fe\u6570\u636e\u5e93\u5e76\u67e5\u770b\u72b6\u6001. # \u542f\u52a8neo4j\u547d\u4ee4 neo4j start # \u67e5\u770b\u72b6\u6001\u547d\u4ee4 neo4j status 7: \u4f7f\u7528\u811a\u672c\u751f\u6210\u56fe\u8c31. # \u6267\u884c\u5df2\u7ecf\u5199\u597d\u7684\u811a\u672c\u4ee3\u7801, \u5c06\u6570\u636e\u5199\u5165\u5230neo4j\u6570\u636e\u5e93\u4e2d python /data/doctor_offline/neo4j_write.py 8: \u4f7f\u7528\u811a\u672c\u8bad\u7ec3\u6a21\u578b. # \u5728\u7ebf\u90e8\u5206\u53ea\u6709\u4e00\u4e2a\u6a21\u578bbert-chinese cd /data/doctor_online/bert_server/ python train.py 9: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1. # \u542f\u52a8werobot\u670d\u52a1, \u4f7f\u5f97\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5fae\u4fe1\u63a5\u53e3\u548cAI\u533b\u751f\u5b8c\u6210\u5bf9\u8bdd. nohup python /data/wr.py & 10: \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1. # supervisor\u914d\u7f6e\u6587\u4ef6\u7b80\u8981\u5206\u6790 # \u6587\u4ef6\u8def\u5f84\u4f4d\u7f6e/data/doctor_online/main_serve/supervisor.conf ; \u4f7f\u7528gunicorn\u542f\u52a8\u57fa\u4e8eFlask\u6846\u67b6\u7684\u4e3b\u8981\u903b\u8f91\u670d\u52a1 [program:main_server] command=gunicorn -w 1 -b 0.0.0.0:5000 app:app ; the program (relative uses PATH, can take args) stopsignal=QUIT ; signal used to kill process (default TERM) stopasgroup=false ; send stop signal to the UNIX process group (default false) killasgroup=false ; SIGKILL the UNIX process group (def false) stdout_logfile=./log/main_server_out ; stdout log path, NONE for none; default AUTO stdout_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) stderr_logfile=./log/main_server_error ; stderr log path, NONE for none; default AUTO stderr_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ; \u542f\u52a8redis\u670d\u52a1\uff0c\u4f5c\u4e3a\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93 [program:redis] command=redis-server # \u4f7f\u7528supervisord\u547d\u4ee4, \u8bfb\u53d6\u6307\u5b9a\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 supervisord -c /data/doctor_online/main_serve/supervisor.conf # \u67e5\u770b\u542f\u52a8\u7684\u670d\u52a1\u72b6\u6001 supervisorctl status 11: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1. # \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1, \u4ee3\u7801\u5df2\u7ecf\u9884\u5148\u7f16\u5199\u597d # \u811a\u672cstart.sh\u4e2d\u7684\u5185\u5bb9\u662f gunicorn -w 1 -b 0.0.0.0:5001 app:app nohup sh /data/doctor_online/bert_serve/start.sh & 12: \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u56fe\u6570\u636e\u67e5\u8be2): # neo4j\u670d\u52a1\u5728\u4e4b\u524d\u5e94\u8be5\u4e00\u76f4\u5904\u5728\u542f\u52a8\u72b6\u6001 neo4j start # \u67e5\u770b\u670d\u52a1\u542f\u52a8\u72b6\u6001: neo4j status 13: \u8fdb\u884c\u6d4b\u8bd5. \u6d4b\u8bd51: \u5173\u6ce8\u516c\u4f17\u53f7(\u65b0\u7528\u6237), \u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\". \u6d4b\u8bd52: (\u8001\u7528\u6237)\u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\"\u540e, \u7ee7\u7eed\u53d1\u9001\"\u5e76\u4e14\u5de6\u8179\u90e8\u6709\u4e00\u4e9b\u7ea2\u70b9\".","title":"\u9644\u5f55:\u73af\u5883\u5b89\u88c5\u90e8\u7f72\u624b\u518c"},{"location":"10/#ai","text":"\u6ce8\u610f\u4e8b\u9879: \u8fd9\u4e2a\u5b89\u88c5\u624b\u518c\u53ea\u9002\u7528\u4e8e\u64cd\u4f5c\u7cfb\u7edf: centos7. \u5b89\u88c5\u90e8\u7f72\u6b65\u9aa4: 1: \u62f7\u8d1d\u5fc5\u5907\u6587\u4ef6. 2: \u5b89\u88c5Anaconda\u79d1\u5b66\u8ba1\u7b97\u73af\u5883, \u5305\u62ecpython2, pip, pandas, numpy, matplotplib\u7b49\u79d1\u5b66\u8ba1\u7b97\u5305. # \u5c06\u73af\u5883\u5305\u5b89\u88c5\u5728/root/\u76ee\u5f55\u4e0b cd /root curl -O https://repo.anaconda.com/archive/Anaconda3-5.2.0-Linux-x86_64.sh sh Anaconda3-2019.07-Linux-x86_64.sh # \u914d\u7f6e~/.bashrc, \u6dfb\u52a0\u4e00\u884c: export PATH=/root/anaconda/bin/:$PATH 3: \u5b89\u88c5\u9879\u76ee\u9700\u8981\u7684\u82e5\u5e72\u72ec\u7acb\u5de5\u5177. # \u5b89\u88c5Flask pip install Flask==1.1.1 # \u5b89\u88c5Redis\u6570\u636e\u5e93 yum install redis -y # \u5b89\u88c5python\u4e2d\u7684redis\u9a71\u52a8 pip install redis # \u5b89\u88c5gunicorn pip install gunicorn==20.0.4 # \u5b89\u88c5supervisor yum install supervisor -y # \u5b89\u88c5lsof yum install lsof -y 4: \u5b89\u88c5\u9879\u76ee\u9700\u8981\u7684\u91cd\u8981\u5de5\u5177Pytorch. # \u5b89\u88c5pytorch pip install pytorch 5: \u5b89\u88c5\u56fe\u6570\u636e\u5e93neo4j. # \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868 cd /tmp wget http://debian.neo4j.org/neotechnology.gpg.key rpm --import neotechnology.gpg.key cat <<EOF> /etc/yum.repos.d/neo4j.repo # \u5199\u5165\u4e0b\u9762\u5185\u5bb9 [neo4j] name=Neo4j RPM Repository baseurl=http://yum.neo4j.org/stable enabled=1 gpgcheck=1 # \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5 yum install neo4j-3.3.5 # \u7b2c\u4e09\u6b65: \u4f7f\u7528\u81ea\u5df1\u7684\u914d\u7f6e\u6587\u4ef6 cp /data/neo4j.conf /etc/neo4j/neo4j.conf 6: \u542f\u52a8neo4j\u56fe\u6570\u636e\u5e93\u5e76\u67e5\u770b\u72b6\u6001. # \u542f\u52a8neo4j\u547d\u4ee4 neo4j start # \u67e5\u770b\u72b6\u6001\u547d\u4ee4 neo4j status 7: \u4f7f\u7528\u811a\u672c\u751f\u6210\u56fe\u8c31. # \u6267\u884c\u5df2\u7ecf\u5199\u597d\u7684\u811a\u672c\u4ee3\u7801, \u5c06\u6570\u636e\u5199\u5165\u5230neo4j\u6570\u636e\u5e93\u4e2d python /data/doctor_offline/neo4j_write.py 8: \u4f7f\u7528\u811a\u672c\u8bad\u7ec3\u6a21\u578b. # \u5728\u7ebf\u90e8\u5206\u53ea\u6709\u4e00\u4e2a\u6a21\u578bbert-chinese cd /data/doctor_online/bert_server/ python train.py 9: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1. # \u542f\u52a8werobot\u670d\u52a1, \u4f7f\u5f97\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u5fae\u4fe1\u63a5\u53e3\u548cAI\u533b\u751f\u5b8c\u6210\u5bf9\u8bdd. nohup python /data/wr.py & 10: \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1. # supervisor\u914d\u7f6e\u6587\u4ef6\u7b80\u8981\u5206\u6790 # \u6587\u4ef6\u8def\u5f84\u4f4d\u7f6e/data/doctor_online/main_serve/supervisor.conf ; \u4f7f\u7528gunicorn\u542f\u52a8\u57fa\u4e8eFlask\u6846\u67b6\u7684\u4e3b\u8981\u903b\u8f91\u670d\u52a1 [program:main_server] command=gunicorn -w 1 -b 0.0.0.0:5000 app:app ; the program (relative uses PATH, can take args) stopsignal=QUIT ; signal used to kill process (default TERM) stopasgroup=false ; send stop signal to the UNIX process group (default false) killasgroup=false ; SIGKILL the UNIX process group (def false) stdout_logfile=./log/main_server_out ; stdout log path, NONE for none; default AUTO stdout_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) stderr_logfile=./log/main_server_error ; stderr log path, NONE for none; default AUTO stderr_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ; \u542f\u52a8redis\u670d\u52a1\uff0c\u4f5c\u4e3a\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93 [program:redis] command=redis-server # \u4f7f\u7528supervisord\u547d\u4ee4, \u8bfb\u53d6\u6307\u5b9a\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 supervisord -c /data/doctor_online/main_serve/supervisor.conf # \u67e5\u770b\u542f\u52a8\u7684\u670d\u52a1\u72b6\u6001 supervisorctl status 11: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1. # \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1, \u4ee3\u7801\u5df2\u7ecf\u9884\u5148\u7f16\u5199\u597d # \u811a\u672cstart.sh\u4e2d\u7684\u5185\u5bb9\u662f gunicorn -w 1 -b 0.0.0.0:5001 app:app nohup sh /data/doctor_online/bert_serve/start.sh & 12: \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u56fe\u6570\u636e\u67e5\u8be2): # neo4j\u670d\u52a1\u5728\u4e4b\u524d\u5e94\u8be5\u4e00\u76f4\u5904\u5728\u542f\u52a8\u72b6\u6001 neo4j start # \u67e5\u770b\u670d\u52a1\u542f\u52a8\u72b6\u6001: neo4j status 13: \u8fdb\u884c\u6d4b\u8bd5. \u6d4b\u8bd51: \u5173\u6ce8\u516c\u4f17\u53f7(\u65b0\u7528\u6237), \u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\". \u6d4b\u8bd52: (\u8001\u7528\u6237)\u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\"\u540e, \u7ee7\u7eed\u53d1\u9001\"\u5e76\u4e14\u5de6\u8179\u90e8\u6709\u4e00\u4e9b\u7ea2\u70b9\".","title":"AI\u533b\u751f\u5b89\u88c5\u90e8\u7f72\u624b\u518c"},{"location":"2/","text":"2.1 \u5728\u7ebf\u533b\u751f\u7684\u603b\u4f53\u67b6\u6784 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u5728\u7ebf\u533b\u751f\u9879\u76ee\u7684\u603b\u4f53\u67b6\u6784 \u9879\u76ee\u6574\u4f53\u67b6\u6784\u56fe: \u67b6\u6784\u56fe\u5206\u6790: \u6574\u4e2a\u9879\u76ee\u5206\u4e3a: \u5728\u7ebf\u90e8\u5206\u548c\u79bb\u7ebf\u90e8\u5206 \u5728\u7ebf\u90e8\u5206\u5305\u62ec: werobot\u670d\u52a1\u6a21\u5757, \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u6a21\u5757, \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u6a21\u5757, \u4f1a\u8bdd\u7ba1\u7406\u6a21\u5757(redis), \u56fe\u6570\u636e\u5e93\u6a21\u5757\u4ee5\u53ca\u89c4\u5219\u5bf9\u8bdd/Unit\u6a21\u5757. \u79bb\u7ebf\u90e8\u5206\u5305\u62ec: \u7ed3\u6784\u4e0e\u975e\u7ed3\u6784\u5316\u6570\u636e\u91c7\u96c6\u6a21\u5757, NER\u6a21\u578b\u4f7f\u7528\u6a21\u5757, \u4ee5\u53ca\u5b9e\u4f53\u5ba1\u6838\u6a21\u578b\u4f7f\u7528\u6a21\u5757. \u5728\u7ebf\u90e8\u5206\u6570\u636e\u6d41: \u4ece\u7528\u6237\u8bf7\u6c42\u5f00\u59cb, \u901a\u8fc7werobot\u670d\u52a1, \u5728werobot\u670d\u52a1\u5185\u90e8\u8bf7\u6c42\u4e3b\u670d\u52a1, \u5728\u4e3b\u670d\u52a1\u4e2d\u5c06\u8c03\u7528\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93redis, \u8c03\u7528\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1, \u4ee5\u53ca\u8c03\u7528\u56fe\u6570\u636e\u5e93, \u6700\u540e\u5c06\u67e5\u8be2\u7ed3\u679c\u8f93\u9001\u7ed9\u5bf9\u8bdd\u89c4\u5219\u6a21\u7248\u6216\u8005\u4f7f\u7528Unit\u5bf9\u8bddAPI\u56de\u590d. \u79bb\u7ebf\u90e8\u5206\u6570\u636e\u6d41: \u4ece\u6570\u636e\u91c7\u96c6\u5f00\u59cb, \u5c06\u83b7\u5f97\u7ed3\u6784\u5316\u548c\u975e\u7ed3\u6784\u5316\u7684\u6570\u636e, \u5bf9\u4e8e\u7ed3\u6784\u5316\u6570\u636e\u5c06\u76f4\u63a5\u4f7f\u7528\u5b9e\u4f53\u5ba1\u6838\u6a21\u578b\u8fdb\u884c\u5ba1\u6838, \u7136\u540e\u5199\u5165\u56fe\u6570\u636e\u5e93; \u5bf9\u4e8e\u975e\u7ed3\u6784\u5316\u6570\u636e, \u5c06\u4f7f\u7528NER\u6a21\u578b\u8fdb\u884c\u5b9e\u4f53\u62bd\u53d6, \u7136\u540e\u901a\u8fc7\u5b9e\u4f53\u5ba1\u6838\u540e\u518d\u5199\u5165\u56fe\u6570\u636e\u5e93. 2.2 \u603b\u4f53\u67b6\u6784\u4e2d\u7684\u5de5\u5177\u4ecb\u7ecd \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u603b\u4f53\u67b6\u6784\u4e2d\u4f7f\u7528\u4e86\u54ea\u4e9b\u5de5\u5177. \u638c\u63e1\u603b\u4f53\u67b6\u6784\u4e2d\u5404\u4e2a\u5de5\u5177\u7684\u7b80\u4ecb, \u4f5c\u7528, \u5b89\u88c5\u548c\u57fa\u672c\u4f7f\u7528\u65b9\u6cd5. \u603b\u4f53\u67b6\u6784\u4e2d\u4f7f\u7528\u7684\u5de5\u5177: Flask web\u670d\u52a1\u6846\u67b6 Redis\u6570\u636e\u5e93 Gunicorn\u670d\u52a1\u7ec4\u4ef6 Supervisor\u670d\u52a1\u76d1\u63a7\u5668 Neo4j\u56fe\u6570\u636e\u5e93 Flask web\u670d\u52a1\u6846\u67b6: \u7b80\u4ecb: Flask\u6846\u67b6\u662f\u5f53\u4e0b\u6700\u53d7\u6b22\u8fce\u7684python\u8f7b\u91cf\u7ea7\u6846\u67b6, \u4e5f\u662fpytorch\u5b98\u7f51\u6307\u5b9a\u7684\u90e8\u7f72\u6846\u67b6. Flask\u7684\u57fa\u672c\u6a21\u5f0f\u4e3a\u5728\u7a0b\u5e8f\u91cc\u5c06\u4e00\u4e2a\u89c6\u56fe\u51fd\u6570\u5206\u914d\u7ed9\u4e00\u4e2aURL\uff0c\u6bcf\u5f53\u7528\u6237\u8bbf\u95ee\u8fd9\u4e2aURL\u65f6\uff0c\u7cfb\u7edf\u5c31\u4f1a\u6267\u884c\u7ed9\u8be5URL\u5206\u914d\u597d\u7684\u89c6\u56fe\u51fd\u6570\uff0c\u83b7\u53d6\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u5176\u5de5\u4f5c\u8fc7\u7a0b\u89c1\u56fe. \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Flask\u6846\u67b6\u662f\u4e3b\u903b\u8f91\u670d\u52a1\u548c\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u4f7f\u7528\u7684\u670d\u52a1\u6846\u67b6. \u5b89\u88c5: # \u4f7f\u7528pip\u5b89\u88c5Flask pip install Flask==1.1.1 \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: # \u5bfc\u5165Flask\u7c7b from flask import Flask # \u521b\u5efa\u4e00\u4e2a\u8be5\u7c7b\u7684\u5b9e\u4f8bapp, \u53c2\u6570\u4e3a__name__, \u8fd9\u4e2a\u53c2\u6570\u662f\u5fc5\u9700\u7684\uff0c # \u8fd9\u6837Flask\u624d\u80fd\u77e5\u9053\u5728\u54ea\u91cc\u53ef\u627e\u5230\u6a21\u677f\u548c\u9759\u6001\u6587\u4ef6\u7b49\u4e1c\u897f. app = Flask(__name__) # \u4f7f\u7528route()\u88c5\u9970\u5668\u6765\u544a\u8bc9Flask\u89e6\u53d1\u51fd\u6570\u7684URL @app.route('/') def hello_world(): \"\"\"\u8bf7\u6c42\u6307\u5b9a\u7684url\u540e\uff0c\u6267\u884c\u7684\u4e3b\u8981\u903b\u8f91\u51fd\u6570\"\"\" # \u5728\u7528\u6237\u6d4f\u89c8\u5668\u4e2d\u663e\u793a\u4fe1\u606f:'Hello, World!' return 'Hello, World!' if __name__ == '__main__': app.run(host=\"0.0.0.0\", port=5000) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_onine/main_serve/app.py \u542f\u52a8\u670d\u52a1: python app.py \u542f\u52a8\u6548\u679c: \u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00\u5730\u5740http://0.0.0.0:5000\u53ef\u770b\u89c1\u6253\u5370\u4e86'Hello, World'. Redis\u6570\u636e\u5e93: \u7b80\u4ecb: Redis\uff08\u5168\u79f0\uff1aRemote Dictionary Server \u8fdc\u7a0b\u5b57\u5178\u670d\u52a1\uff09\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u4f7f\u7528ANSI C\u8bed\u8a00\u7f16\u5199\u3001\u652f\u6301\u7f51\u7edc\u3001\u53ef\u57fa\u4e8e\u5185\u5b58\u4ea6\u53ef\u6301\u4e45\u5316\u7684\u65e5\u5fd7\u578b\u3001Key-Value\u6570\u636e\u5e93\uff0c\u5e76\u63d0\u4f9b\u591a\u79cd\u8bed\u8a00\u7684API. \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Redis\u7528\u4e8e\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93, \u4fdd\u5b58\u7528\u6237\u804a\u5929\u5386\u53f2. \u5b89\u88c5: # \u4f7f\u7528yum\u5b89\u88c5redis yum install redis -y \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: Redis\u652f\u6301\u56db\u79cd\u6570\u636e\u7ed3\u6784\u7684\u5b58\u50a8: String(\u5b57\u7b26\u4e32), Hash(\u6563\u5217), List(\u5217\u8868), Set(\u96c6\u5408), Sorted Set(\u6709\u5e8f\u96c6\u5408). \u5728\u8fd9\u91cc\u6211\u4eec\u5c06\u7740\u91cd\u4ecb\u7ecd\u5982\u4f55\u5728python\u4e2d\u4f7f\u7528Hash(\u6563\u5217)\u8fdb\u884c\u8bfb\u5199. \u5b89\u88c5python\u4e2d\u7684redis\u9a71\u52a8: # \u4f7f\u7528pip\u8fdb\u884c\u5b89\u88c5 pip install redis \u542f\u52a8redis\u670d\u52a1: # \u542f\u52a8redis-server, \u8fd9\u91cc\u4f7f\u7528\u4e86\u9ed8\u8ba4\u914d\u7f6e, \u7aef\u53e3\u662f6379. redis-server \u5728python\u4e2d\u4f7f\u7528Hash(\u6563\u5217)\u8fdb\u884c\u8bfb\u5199: # coding=utf-8 # redis\u914d\u7f6e REDIS_CONFIG = { \"host\": \"0.0.0.0\", \"port\": 6379 } # \u5bfc\u5165redis\u9a71\u52a8 import redis # \u521b\u5efa\u4e00\u4e2aredis\u8fde\u63a5\u6c60 pool = redis.ConnectionPool( **REDIS_CONFIG) # \u4ece\u8fde\u63a5\u6c60\u4e2d\u521d\u59cb\u5316\u4e00\u4e2a\u6d3b\u8dc3\u7684\u8fde\u63a5\u5bf9\u8c61 r = redis.StrictRedis(connection_pool=pool) # hset\u8868\u793a\u4f7f\u7528hash\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u6570\u636e\u5199\u5165 # uid\u4ee3\u8868\u67d0\u4e2a\u7528\u6237\u7684\u552f\u4e00\u6807\u8bc6 uid = \"8888\" # key\u662f\u9700\u8981\u8bb0\u5f55\u7684\u6570\u636e\u63cf\u8ff0 key = \"\u8be5\u7528\u6237\u6700\u540e\u4e00\u6b21\u8bf4\u7684\u8bdd:\".encode('utf-8') # value\u662f\u9700\u8981\u8bb0\u5f55\u7684\u6570\u636e\u5177\u4f53\u5185\u5bb9 value = \"\u518d\u89c1, \u8463\u5c0f\u59d0\".encode('utf-8') r.hset(uid, key, value) # hget\u8868\u793a\u4f7f\u7528hash\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u6570\u636e\u8bfb\u53d6 result = r.hget(uid, key) print(result.decode('utf-8')) \u8f93\u51fa\u6548\u679c: \u518d\u89c1, \u8463\u5c0f\u59d0 Gunicorn\u670d\u52a1\u7ec4\u4ef6: \u7b80\u4ecb: Gunicorn\u662f\u4e00\u4e2a\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u9ad8\u6027\u80fd\u7684Python WSGI UNIX HTTP\u670d\u52a1\u7ec4\u4ef6(WSGI: Web Server Gateway Interface)\uff0c\u79fb\u690d\u81eaRuby\u7684\u72ec\u89d2\u517d\uff08Unicorn \uff09\u9879\u76ee\uff0c\u5177\u6709\u4f7f\u7528\u975e\u5e38\u7b80\u5355\uff0c\u8f7b\u91cf\u7ea7\u7684\u8d44\u6e90\u6d88\u8017\uff0c\u4ee5\u53ca\u9ad8\u6027\u80fd\u7b49\u7279\u70b9. \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Gunicorn\u548cFlask\u6846\u67b6\u4e00\u540c\u4f7f\u7528, \u80fd\u591f\u5f00\u542f\u670d\u52a1, \u5904\u7406\u8bf7\u6c42,\u56e0\u5176\u9ad8\u6027\u80fd\u7684\u7279\u70b9\u80fd\u591f\u6709\u6548\u51cf\u5c11\u670d\u52a1\u4e22\u5305\u7387. \u5b89\u88c5: # \u4f7f\u7528pip\u5b89\u88c5gunicorn pip install gunicorn==20.0.4 \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: # \u4f7f\u7528\u5176\u542f\u52a8Flask\u670d\u52a1: gunicorn -w 1 -b 0.0.0.0:5000 app:app # -w \u4ee3\u8868\u5f00\u542f\u7684\u8fdb\u7a0b\u6570, \u6211\u4eec\u53ea\u5f00\u542f\u4e00\u4e2a\u8fdb\u7a0b # -b \u670d\u52a1\u7684IP\u5730\u5740\u548c\u7aef\u53e3 # app:app \u662f\u6307\u6267\u884c\u7684\u4e3b\u8981\u5bf9\u8c61\u4f4d\u7f6e, \u5728app.py\u4e2d\u7684app\u5bf9\u8c61 # \u5982\u679c\u4f7f\u5176\u5728\u540e\u53f0\u8fd0\u884c\u53ef\u4f7f\u7528: # nohup gunicorn -w 1 -b 0.0.0.0:5001 app:app & Supervisor\u670d\u52a1\u76d1\u63a7: \u7b80\u4ecb: Supervisor\u662f\u7528Python\u5f00\u53d1\u7684\u4e00\u4e2aclient/server\u670d\u52a1\uff0c\u662fLinux/Unix\u7cfb\u7edf\u4e0b\u7684\u4e00\u4e2a\u8fdb\u7a0b\u7ba1\u7406\u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u76d1\u542c\u3001\u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u4e00\u4e2a\u6216\u591a\u4e2a\u8fdb\u7a0b, \u5e76\u5b88\u62a4\u8fd9\u4e9b\u8fdb\u7a0b\u3002 \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Supervisor\u7528\u4e8e\u76d1\u63a7\u548c\u5b88\u62a4\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u548credis\u6570\u636e\u5e93\u670d\u52a1. \u5b89\u88c5: # \u4f7f\u7528yum\u5b89\u88c5supervisor yum install supervisor -y \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: # \u7f16\u8f91\u914d\u7f6e\u6587\u4ef6, \u6307\u660e\u76d1\u63a7\u548c\u5b88\u62a4\u7684\u8fdb\u7a0b\u5f00\u542f\u547d\u4ee4, # \u8bf7\u67e5\u770b/data/doctor_online/supervisord.conf\u6587\u4ef6 # \u5f00\u542fsupervisor, -c\u7528\u4e8e\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6 sueprvisord -c /data/doctor_online/main_server/supervisord.conf # \u67e5\u770b\u76d1\u63a7\u7684\u8fdb\u7a0b\u72b6\u6001: supervisorctl status # main_server RUNNING pid 31609, uptime 0:32:20 # redis RUNNING pid 31613, uptime 0:32:18 # \u5173\u95edsupervisor supervisorctl shutdown \u8fd8\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u67e5\u770b\u53ef\u89c6\u5316\u76d1\u63a7\u9875\u9762: http://0.0.0.0:9001 Neo4j\u56fe\u6570\u636e\u5e93: \u56e0\u4e3a\u5728\u9879\u76ee\u4e2d, Neo4j\u56fe\u6570\u636e\u5e93\u4f5c\u4e3a\u6838\u5fc3\u7684\u5b58\u50a8\u548c\u67e5\u8be2\u6570\u636e\u5e93, \u56e0\u6b64\u4f1a\u5728 \u7b2c\u4e09\u7ae0: Neo4j\u56fe\u6570\u636e\u5e93 \u4e2d\u5bf9\u5176\u8fdb\u884c\u8be6\u7ec6\u7684\u4ecb\u7ecd. \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u67b6\u6784\u56fe\u5206\u6790: \u6574\u4e2a\u9879\u76ee\u5206\u4e3a: \u5728\u7ebf\u90e8\u5206\u548c\u79bb\u7ebf\u90e8\u5206 \u5728\u7ebf\u90e8\u5206\u5305\u62ec: werobot\u670d\u52a1\u6a21\u5757, \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u6a21\u5757, \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u6a21\u5757, \u4f1a\u8bdd\u7ba1\u7406\u6a21\u5757(redis), \u56fe\u6570\u636e\u5e93\u6a21\u5757\u4ee5\u53ca\u89c4\u5219\u5bf9\u8bdd/Unit\u6a21\u5757. \u79bb\u7ebf\u90e8\u5206\u5305\u62ec: \u7ed3\u6784\u4e0e\u975e\u7ed3\u6784\u5316\u6570\u636e\u91c7\u96c6\u6a21\u5757, NER\u6a21\u578b\u4f7f\u7528\u6a21\u5757, \u4ee5\u53ca\u5b9e\u4f53\u5ba1\u6838\u6a21\u578b\u4f7f\u7528\u6a21\u5757. \u5b66\u4e60\u4e86\u603b\u4f53\u67b6\u6784\u4e2d\u4f7f\u7528\u7684\u5de5\u5177: Flask web\u670d\u52a1\u6846\u67b6 Redis\u6570\u636e\u5e93 Gunicorn\u670d\u52a1\u7ec4\u4ef6 Supervisor\u670d\u52a1\u76d1\u63a7\u5668 Neo4j\u56fe\u6570\u636e\u5e93 Flask web\u670d\u52a1\u6846\u67b6: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Flask\u6846\u67b6\u662f\u4e3b\u903b\u8f91\u670d\u52a1\u548c\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u4f7f\u7528\u7684\u670d\u52a1\u6846\u67b6. Redis\u6570\u636e\u5e93: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Redis\u7528\u4e8e\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93, \u4fdd\u5b58\u7528\u6237\u804a\u5929\u5386\u53f2. Gunicorn\u670d\u52a1\u7ec4\u4ef6: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Gunicorn\u548cFlask\u6846\u67b6\u4e00\u540c\u4f7f\u7528, \u80fd\u591f\u5f00\u542f\u670d\u52a1, \u5904\u7406\u8bf7\u6c42,\u56e0\u5176\u9ad8\u6027\u80fd\u7684\u7279\u70b9\u80fd\u591f\u6709\u6548\u51cf\u5c11\u670d\u52a1\u4e22\u5305\u7387. Supervisor\u670d\u52a1\u76d1\u63a7: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Supervisor\u7528\u4e8e\u76d1\u63a7\u548c\u5b88\u62a4\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u548credis\u6570\u636e\u5e93\u670d\u52a1.","title":"\u7b2c\u4e8c\u7ae0:\u5728\u7ebf\u533b\u751f\u7684\u603b\u4f53\u67b6\u6784\u4e0e\u5de5\u5177\u4ecb\u7ecd"},{"location":"2/#21","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u5728\u7ebf\u533b\u751f\u9879\u76ee\u7684\u603b\u4f53\u67b6\u6784 \u9879\u76ee\u6574\u4f53\u67b6\u6784\u56fe: \u67b6\u6784\u56fe\u5206\u6790: \u6574\u4e2a\u9879\u76ee\u5206\u4e3a: \u5728\u7ebf\u90e8\u5206\u548c\u79bb\u7ebf\u90e8\u5206 \u5728\u7ebf\u90e8\u5206\u5305\u62ec: werobot\u670d\u52a1\u6a21\u5757, \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u6a21\u5757, \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u6a21\u5757, \u4f1a\u8bdd\u7ba1\u7406\u6a21\u5757(redis), \u56fe\u6570\u636e\u5e93\u6a21\u5757\u4ee5\u53ca\u89c4\u5219\u5bf9\u8bdd/Unit\u6a21\u5757. \u79bb\u7ebf\u90e8\u5206\u5305\u62ec: \u7ed3\u6784\u4e0e\u975e\u7ed3\u6784\u5316\u6570\u636e\u91c7\u96c6\u6a21\u5757, NER\u6a21\u578b\u4f7f\u7528\u6a21\u5757, \u4ee5\u53ca\u5b9e\u4f53\u5ba1\u6838\u6a21\u578b\u4f7f\u7528\u6a21\u5757. \u5728\u7ebf\u90e8\u5206\u6570\u636e\u6d41: \u4ece\u7528\u6237\u8bf7\u6c42\u5f00\u59cb, \u901a\u8fc7werobot\u670d\u52a1, \u5728werobot\u670d\u52a1\u5185\u90e8\u8bf7\u6c42\u4e3b\u670d\u52a1, \u5728\u4e3b\u670d\u52a1\u4e2d\u5c06\u8c03\u7528\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93redis, \u8c03\u7528\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1, \u4ee5\u53ca\u8c03\u7528\u56fe\u6570\u636e\u5e93, \u6700\u540e\u5c06\u67e5\u8be2\u7ed3\u679c\u8f93\u9001\u7ed9\u5bf9\u8bdd\u89c4\u5219\u6a21\u7248\u6216\u8005\u4f7f\u7528Unit\u5bf9\u8bddAPI\u56de\u590d. \u79bb\u7ebf\u90e8\u5206\u6570\u636e\u6d41: \u4ece\u6570\u636e\u91c7\u96c6\u5f00\u59cb, \u5c06\u83b7\u5f97\u7ed3\u6784\u5316\u548c\u975e\u7ed3\u6784\u5316\u7684\u6570\u636e, \u5bf9\u4e8e\u7ed3\u6784\u5316\u6570\u636e\u5c06\u76f4\u63a5\u4f7f\u7528\u5b9e\u4f53\u5ba1\u6838\u6a21\u578b\u8fdb\u884c\u5ba1\u6838, \u7136\u540e\u5199\u5165\u56fe\u6570\u636e\u5e93; \u5bf9\u4e8e\u975e\u7ed3\u6784\u5316\u6570\u636e, \u5c06\u4f7f\u7528NER\u6a21\u578b\u8fdb\u884c\u5b9e\u4f53\u62bd\u53d6, \u7136\u540e\u901a\u8fc7\u5b9e\u4f53\u5ba1\u6838\u540e\u518d\u5199\u5165\u56fe\u6570\u636e\u5e93.","title":"2.1 \u5728\u7ebf\u533b\u751f\u7684\u603b\u4f53\u67b6\u6784"},{"location":"2/#22","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u603b\u4f53\u67b6\u6784\u4e2d\u4f7f\u7528\u4e86\u54ea\u4e9b\u5de5\u5177. \u638c\u63e1\u603b\u4f53\u67b6\u6784\u4e2d\u5404\u4e2a\u5de5\u5177\u7684\u7b80\u4ecb, \u4f5c\u7528, \u5b89\u88c5\u548c\u57fa\u672c\u4f7f\u7528\u65b9\u6cd5. \u603b\u4f53\u67b6\u6784\u4e2d\u4f7f\u7528\u7684\u5de5\u5177: Flask web\u670d\u52a1\u6846\u67b6 Redis\u6570\u636e\u5e93 Gunicorn\u670d\u52a1\u7ec4\u4ef6 Supervisor\u670d\u52a1\u76d1\u63a7\u5668 Neo4j\u56fe\u6570\u636e\u5e93 Flask web\u670d\u52a1\u6846\u67b6: \u7b80\u4ecb: Flask\u6846\u67b6\u662f\u5f53\u4e0b\u6700\u53d7\u6b22\u8fce\u7684python\u8f7b\u91cf\u7ea7\u6846\u67b6, \u4e5f\u662fpytorch\u5b98\u7f51\u6307\u5b9a\u7684\u90e8\u7f72\u6846\u67b6. Flask\u7684\u57fa\u672c\u6a21\u5f0f\u4e3a\u5728\u7a0b\u5e8f\u91cc\u5c06\u4e00\u4e2a\u89c6\u56fe\u51fd\u6570\u5206\u914d\u7ed9\u4e00\u4e2aURL\uff0c\u6bcf\u5f53\u7528\u6237\u8bbf\u95ee\u8fd9\u4e2aURL\u65f6\uff0c\u7cfb\u7edf\u5c31\u4f1a\u6267\u884c\u7ed9\u8be5URL\u5206\u914d\u597d\u7684\u89c6\u56fe\u51fd\u6570\uff0c\u83b7\u53d6\u51fd\u6570\u7684\u8fd4\u56de\u503c\uff0c\u5176\u5de5\u4f5c\u8fc7\u7a0b\u89c1\u56fe. \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Flask\u6846\u67b6\u662f\u4e3b\u903b\u8f91\u670d\u52a1\u548c\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u4f7f\u7528\u7684\u670d\u52a1\u6846\u67b6. \u5b89\u88c5: # \u4f7f\u7528pip\u5b89\u88c5Flask pip install Flask==1.1.1 \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: # \u5bfc\u5165Flask\u7c7b from flask import Flask # \u521b\u5efa\u4e00\u4e2a\u8be5\u7c7b\u7684\u5b9e\u4f8bapp, \u53c2\u6570\u4e3a__name__, \u8fd9\u4e2a\u53c2\u6570\u662f\u5fc5\u9700\u7684\uff0c # \u8fd9\u6837Flask\u624d\u80fd\u77e5\u9053\u5728\u54ea\u91cc\u53ef\u627e\u5230\u6a21\u677f\u548c\u9759\u6001\u6587\u4ef6\u7b49\u4e1c\u897f. app = Flask(__name__) # \u4f7f\u7528route()\u88c5\u9970\u5668\u6765\u544a\u8bc9Flask\u89e6\u53d1\u51fd\u6570\u7684URL @app.route('/') def hello_world(): \"\"\"\u8bf7\u6c42\u6307\u5b9a\u7684url\u540e\uff0c\u6267\u884c\u7684\u4e3b\u8981\u903b\u8f91\u51fd\u6570\"\"\" # \u5728\u7528\u6237\u6d4f\u89c8\u5668\u4e2d\u663e\u793a\u4fe1\u606f:'Hello, World!' return 'Hello, World!' if __name__ == '__main__': app.run(host=\"0.0.0.0\", port=5000) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_onine/main_serve/app.py \u542f\u52a8\u670d\u52a1: python app.py \u542f\u52a8\u6548\u679c: \u901a\u8fc7\u6d4f\u89c8\u5668\u6253\u5f00\u5730\u5740http://0.0.0.0:5000\u53ef\u770b\u89c1\u6253\u5370\u4e86'Hello, World'. Redis\u6570\u636e\u5e93: \u7b80\u4ecb: Redis\uff08\u5168\u79f0\uff1aRemote Dictionary Server \u8fdc\u7a0b\u5b57\u5178\u670d\u52a1\uff09\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u4f7f\u7528ANSI C\u8bed\u8a00\u7f16\u5199\u3001\u652f\u6301\u7f51\u7edc\u3001\u53ef\u57fa\u4e8e\u5185\u5b58\u4ea6\u53ef\u6301\u4e45\u5316\u7684\u65e5\u5fd7\u578b\u3001Key-Value\u6570\u636e\u5e93\uff0c\u5e76\u63d0\u4f9b\u591a\u79cd\u8bed\u8a00\u7684API. \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Redis\u7528\u4e8e\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93, \u4fdd\u5b58\u7528\u6237\u804a\u5929\u5386\u53f2. \u5b89\u88c5: # \u4f7f\u7528yum\u5b89\u88c5redis yum install redis -y \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: Redis\u652f\u6301\u56db\u79cd\u6570\u636e\u7ed3\u6784\u7684\u5b58\u50a8: String(\u5b57\u7b26\u4e32), Hash(\u6563\u5217), List(\u5217\u8868), Set(\u96c6\u5408), Sorted Set(\u6709\u5e8f\u96c6\u5408). \u5728\u8fd9\u91cc\u6211\u4eec\u5c06\u7740\u91cd\u4ecb\u7ecd\u5982\u4f55\u5728python\u4e2d\u4f7f\u7528Hash(\u6563\u5217)\u8fdb\u884c\u8bfb\u5199. \u5b89\u88c5python\u4e2d\u7684redis\u9a71\u52a8: # \u4f7f\u7528pip\u8fdb\u884c\u5b89\u88c5 pip install redis \u542f\u52a8redis\u670d\u52a1: # \u542f\u52a8redis-server, \u8fd9\u91cc\u4f7f\u7528\u4e86\u9ed8\u8ba4\u914d\u7f6e, \u7aef\u53e3\u662f6379. redis-server \u5728python\u4e2d\u4f7f\u7528Hash(\u6563\u5217)\u8fdb\u884c\u8bfb\u5199: # coding=utf-8 # redis\u914d\u7f6e REDIS_CONFIG = { \"host\": \"0.0.0.0\", \"port\": 6379 } # \u5bfc\u5165redis\u9a71\u52a8 import redis # \u521b\u5efa\u4e00\u4e2aredis\u8fde\u63a5\u6c60 pool = redis.ConnectionPool( **REDIS_CONFIG) # \u4ece\u8fde\u63a5\u6c60\u4e2d\u521d\u59cb\u5316\u4e00\u4e2a\u6d3b\u8dc3\u7684\u8fde\u63a5\u5bf9\u8c61 r = redis.StrictRedis(connection_pool=pool) # hset\u8868\u793a\u4f7f\u7528hash\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u6570\u636e\u5199\u5165 # uid\u4ee3\u8868\u67d0\u4e2a\u7528\u6237\u7684\u552f\u4e00\u6807\u8bc6 uid = \"8888\" # key\u662f\u9700\u8981\u8bb0\u5f55\u7684\u6570\u636e\u63cf\u8ff0 key = \"\u8be5\u7528\u6237\u6700\u540e\u4e00\u6b21\u8bf4\u7684\u8bdd:\".encode('utf-8') # value\u662f\u9700\u8981\u8bb0\u5f55\u7684\u6570\u636e\u5177\u4f53\u5185\u5bb9 value = \"\u518d\u89c1, \u8463\u5c0f\u59d0\".encode('utf-8') r.hset(uid, key, value) # hget\u8868\u793a\u4f7f\u7528hash\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u6570\u636e\u8bfb\u53d6 result = r.hget(uid, key) print(result.decode('utf-8')) \u8f93\u51fa\u6548\u679c: \u518d\u89c1, \u8463\u5c0f\u59d0 Gunicorn\u670d\u52a1\u7ec4\u4ef6: \u7b80\u4ecb: Gunicorn\u662f\u4e00\u4e2a\u88ab\u5e7f\u6cdb\u4f7f\u7528\u7684\u9ad8\u6027\u80fd\u7684Python WSGI UNIX HTTP\u670d\u52a1\u7ec4\u4ef6(WSGI: Web Server Gateway Interface)\uff0c\u79fb\u690d\u81eaRuby\u7684\u72ec\u89d2\u517d\uff08Unicorn \uff09\u9879\u76ee\uff0c\u5177\u6709\u4f7f\u7528\u975e\u5e38\u7b80\u5355\uff0c\u8f7b\u91cf\u7ea7\u7684\u8d44\u6e90\u6d88\u8017\uff0c\u4ee5\u53ca\u9ad8\u6027\u80fd\u7b49\u7279\u70b9. \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Gunicorn\u548cFlask\u6846\u67b6\u4e00\u540c\u4f7f\u7528, \u80fd\u591f\u5f00\u542f\u670d\u52a1, \u5904\u7406\u8bf7\u6c42,\u56e0\u5176\u9ad8\u6027\u80fd\u7684\u7279\u70b9\u80fd\u591f\u6709\u6548\u51cf\u5c11\u670d\u52a1\u4e22\u5305\u7387. \u5b89\u88c5: # \u4f7f\u7528pip\u5b89\u88c5gunicorn pip install gunicorn==20.0.4 \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: # \u4f7f\u7528\u5176\u542f\u52a8Flask\u670d\u52a1: gunicorn -w 1 -b 0.0.0.0:5000 app:app # -w \u4ee3\u8868\u5f00\u542f\u7684\u8fdb\u7a0b\u6570, \u6211\u4eec\u53ea\u5f00\u542f\u4e00\u4e2a\u8fdb\u7a0b # -b \u670d\u52a1\u7684IP\u5730\u5740\u548c\u7aef\u53e3 # app:app \u662f\u6307\u6267\u884c\u7684\u4e3b\u8981\u5bf9\u8c61\u4f4d\u7f6e, \u5728app.py\u4e2d\u7684app\u5bf9\u8c61 # \u5982\u679c\u4f7f\u5176\u5728\u540e\u53f0\u8fd0\u884c\u53ef\u4f7f\u7528: # nohup gunicorn -w 1 -b 0.0.0.0:5001 app:app & Supervisor\u670d\u52a1\u76d1\u63a7: \u7b80\u4ecb: Supervisor\u662f\u7528Python\u5f00\u53d1\u7684\u4e00\u4e2aclient/server\u670d\u52a1\uff0c\u662fLinux/Unix\u7cfb\u7edf\u4e0b\u7684\u4e00\u4e2a\u8fdb\u7a0b\u7ba1\u7406\u5de5\u5177\u3002\u5b83\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u76d1\u542c\u3001\u542f\u52a8\u3001\u505c\u6b62\u3001\u91cd\u542f\u4e00\u4e2a\u6216\u591a\u4e2a\u8fdb\u7a0b, \u5e76\u5b88\u62a4\u8fd9\u4e9b\u8fdb\u7a0b\u3002 \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Supervisor\u7528\u4e8e\u76d1\u63a7\u548c\u5b88\u62a4\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u548credis\u6570\u636e\u5e93\u670d\u52a1. \u5b89\u88c5: # \u4f7f\u7528yum\u5b89\u88c5supervisor yum install supervisor -y \u57fa\u672c\u4f7f\u7528\u65b9\u6cd5: # \u7f16\u8f91\u914d\u7f6e\u6587\u4ef6, \u6307\u660e\u76d1\u63a7\u548c\u5b88\u62a4\u7684\u8fdb\u7a0b\u5f00\u542f\u547d\u4ee4, # \u8bf7\u67e5\u770b/data/doctor_online/supervisord.conf\u6587\u4ef6 # \u5f00\u542fsupervisor, -c\u7528\u4e8e\u6307\u5b9a\u914d\u7f6e\u6587\u4ef6 sueprvisord -c /data/doctor_online/main_server/supervisord.conf # \u67e5\u770b\u76d1\u63a7\u7684\u8fdb\u7a0b\u72b6\u6001: supervisorctl status # main_server RUNNING pid 31609, uptime 0:32:20 # redis RUNNING pid 31613, uptime 0:32:18 # \u5173\u95edsupervisor supervisorctl shutdown \u8fd8\u53ef\u4ee5\u901a\u8fc7\u6d4f\u89c8\u5668\u67e5\u770b\u53ef\u89c6\u5316\u76d1\u63a7\u9875\u9762: http://0.0.0.0:9001 Neo4j\u56fe\u6570\u636e\u5e93: \u56e0\u4e3a\u5728\u9879\u76ee\u4e2d, Neo4j\u56fe\u6570\u636e\u5e93\u4f5c\u4e3a\u6838\u5fc3\u7684\u5b58\u50a8\u548c\u67e5\u8be2\u6570\u636e\u5e93, \u56e0\u6b64\u4f1a\u5728 \u7b2c\u4e09\u7ae0: Neo4j\u56fe\u6570\u636e\u5e93 \u4e2d\u5bf9\u5176\u8fdb\u884c\u8be6\u7ec6\u7684\u4ecb\u7ecd. \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u67b6\u6784\u56fe\u5206\u6790: \u6574\u4e2a\u9879\u76ee\u5206\u4e3a: \u5728\u7ebf\u90e8\u5206\u548c\u79bb\u7ebf\u90e8\u5206 \u5728\u7ebf\u90e8\u5206\u5305\u62ec: werobot\u670d\u52a1\u6a21\u5757, \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u6a21\u5757, \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u6a21\u5757, \u4f1a\u8bdd\u7ba1\u7406\u6a21\u5757(redis), \u56fe\u6570\u636e\u5e93\u6a21\u5757\u4ee5\u53ca\u89c4\u5219\u5bf9\u8bdd/Unit\u6a21\u5757. \u79bb\u7ebf\u90e8\u5206\u5305\u62ec: \u7ed3\u6784\u4e0e\u975e\u7ed3\u6784\u5316\u6570\u636e\u91c7\u96c6\u6a21\u5757, NER\u6a21\u578b\u4f7f\u7528\u6a21\u5757, \u4ee5\u53ca\u5b9e\u4f53\u5ba1\u6838\u6a21\u578b\u4f7f\u7528\u6a21\u5757. \u5b66\u4e60\u4e86\u603b\u4f53\u67b6\u6784\u4e2d\u4f7f\u7528\u7684\u5de5\u5177: Flask web\u670d\u52a1\u6846\u67b6 Redis\u6570\u636e\u5e93 Gunicorn\u670d\u52a1\u7ec4\u4ef6 Supervisor\u670d\u52a1\u76d1\u63a7\u5668 Neo4j\u56fe\u6570\u636e\u5e93 Flask web\u670d\u52a1\u6846\u67b6: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Flask\u6846\u67b6\u662f\u4e3b\u903b\u8f91\u670d\u52a1\u548c\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u4f7f\u7528\u7684\u670d\u52a1\u6846\u67b6. Redis\u6570\u636e\u5e93: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Redis\u7528\u4e8e\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93, \u4fdd\u5b58\u7528\u6237\u804a\u5929\u5386\u53f2. Gunicorn\u670d\u52a1\u7ec4\u4ef6: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Gunicorn\u548cFlask\u6846\u67b6\u4e00\u540c\u4f7f\u7528, \u80fd\u591f\u5f00\u542f\u670d\u52a1, \u5904\u7406\u8bf7\u6c42,\u56e0\u5176\u9ad8\u6027\u80fd\u7684\u7279\u70b9\u80fd\u591f\u6709\u6548\u51cf\u5c11\u670d\u52a1\u4e22\u5305\u7387. Supervisor\u670d\u52a1\u76d1\u63a7: \u4f5c\u7528: \u5728\u9879\u76ee\u4e2d, Supervisor\u7528\u4e8e\u76d1\u63a7\u548c\u5b88\u62a4\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u548credis\u6570\u636e\u5e93\u670d\u52a1.","title":"2.2 \u603b\u4f53\u67b6\u6784\u4e2d\u7684\u5de5\u5177\u4ecb\u7ecd"},{"location":"3/","text":"3.1 neo4j\u7b80\u4ecb \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3neo4j\u56fe\u6570\u636e\u5e93\u7684\u7b80\u4ecb, \u7248\u672c\u8bf4\u660e. \u4e86\u89e3\u8282\u70b9, \u5173\u7cfb\uff0c\u5c5e\u6027\uff0c\u6807\u7b7e\u7684\u6709\u5173\u6982\u5ff5. neo4j\u7b80\u4ecb: neo4j\u662f\u7531Java\u5b9e\u73b0\u7684\u5f00\u6e90NoSQL\u56fe\u6570\u636e\u5e93.\u81ea\u4ece2003\u5e74\u5f00\u59cb\u7814\u53d1, \u52302007\u5e74\u53d1\u5e03\u7b2c\u4e00\u7248, \u6700\u65b0\u7248\u672c\u4e3a3.3.5, neo4j\u73b0\u5982\u4eca\u5df2\u7ecf\u88ab\u5404\u884c\u5404\u4e1a\u7684\u6570\u5341\u4e07\u5bb6\u516c\u53f8\u548c\u7ec4\u7ec7\u91c7\u7528. neo4j\u5b9e\u73b0\u4e86\u4e13\u4e1a\u6570\u636e\u5e93\u7ea7\u522b\u7684\u56fe\u6570\u636e\u6a21\u578b\u7684\u5b58\u50a8. \u4e0e\u666e\u901a\u7684\u56fe\u5904\u7406\u6216\u5185\u5b58\u7ea7\u6570\u636e\u5e93\u4e0d\u540c, neo4j\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u6570\u636e\u5e93\u7279\u6027, \u5305\u62ecACID\u4e8b\u7269\u7684\u652f\u6301, \u96c6\u7fa4\u652f\u6301, \u5907\u4efd\u4e0e\u6545\u969c\u8f6c\u79fb\u7b49. \u8fd9\u4f7f\u5176\u9002\u5408\u4e8e\u4f01\u4e1a\u7ea7\u751f\u4ea7\u73af\u5883\u4e0b\u7684\u5404\u79cd\u5e94\u7528. neo4j\u7684\u7248\u672c\u8bf4\u660e: \u4f01\u4e1a\u7248: \u9700\u8981\u9ad8\u989d\u7684\u4ed8\u8d39\u83b7\u5f97\u6388\u6743, \u63d0\u4f9b\u9ad8\u53ef\u7528, \u70ed\u5907\u4efd\u7b49\u6027\u80fd. \u793e\u533a\u5f00\u6e90\u7248: \u514d\u8d39\u4f7f\u7528, \u4f46\u53ea\u80fd\u5355\u70b9\u8fd0\u884c. neo4j\u56fe\u5f62\u6570\u636e\u5e93\u7684\u6709\u5173\u6982\u5ff5: \u8282\u70b9 \u8282\u70b9\u662f\u4e3b\u8981\u7684\u6570\u636e\u5143\u7d20, \u8282\u70b9\u901a\u8fc7\u5173\u7cfb\u8fde\u63a5\u5230\u5176\u4ed6\u8282\u70b9, \u8282\u70b9\u53ef\u4ee5\u5177\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5c5e\u6027 (\u5373\u5b58\u50a8\u4e3a\u952e/\u503c\u5bf9\u7684\u5c5e\u6027), \u8282\u70b9\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u7b7e, \u7528\u4e8e\u63cf\u8ff0\u5176\u5728\u56fe\u8868\u4e2d\u7684\u4f5c\u7528. \u793a\u4f8b: Person>\u8282\u70b9. \u53ef\u4ee5\u5c06\u8282\u70b9\u7c7b\u6bd4\u4e3a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u7684\u8868, \u5bf9\u5e94\u7684\u6807\u7b7e\u53ef\u4ee5\u7c7b\u6bd4\u4e3a\u4e0d\u540c\u7684\u8868\u540d, \u5c5e\u6027\u5c31\u662f\u8868\u4e2d\u7684\u5217. \u5173\u7cfb \u5173\u7cfb\u8fde\u63a5\u4e24\u4e2a\u8282\u70b9, \u5173\u7cfb\u662f\u65b9\u5411\u6027\u7684, \u5173\u7cfb\u53ef\u4ee5\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5c5e\u6027(\u5373\u5b58\u50a8\u4e3a\u952e/\u503c\u5bf9\u7684 \u5c5e\u6027). \u5c5e\u6027 \u5c5e\u6027\u662f\u547d\u540d\u503c, \u5176\u4e2d\u540d\u79f0(\u6216\u952e)\u662f\u5b57\u7b26\u4e32, \u5c5e\u6027\u53ef\u4ee5\u88ab\u7d22\u5f15\u548c\u7ea6\u675f, \u53ef\u4ee5\u4ece\u591a\u4e2a\u5c5e\u6027\u521b \u5efa\u590d\u5408\u7d22\u5f15. \u6807\u7b7e \u6807\u7b7e\u7528\u4e8e\u7ec4\u8282\u70b9\u5230\u96c6, \u8282\u70b9\u53ef\u4ee5\u5177\u6709\u591a\u4e2a\u6807\u7b7e, \u5bf9\u6807\u7b7e\u8fdb\u884c\u7d22\u5f15\u4ee5\u52a0\u901f\u5728\u56fe\u4e2d\u67e5\u627e\u8282\u70b9. 3.2 neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5 \u5b66\u4e60\u76ee\u6807: \u638c\u63e1neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5\u6d41\u7a0b\u53ca\u5176\u53ef\u89c6\u5316\u540e\u53f0\u7684\u767b\u9646.. neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5\u6d41\u7a0b: \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868. \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5. \u7b2c\u4e09\u6b65: \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9 /etc/neo4j/neo4j.conf. \u7b2c\u56db\u6b65: \u542f\u52a8neo4j\u6570\u636e\u5e93. \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868 cd /tmp wget http://debian.neo4j.org/neotechnology.gpg.key rpm --import neotechnology.gpg.key cat <<EOF> /etc/yum.repos.d/neo4j.repo # \u5199\u5165\u4e0b\u9762\u5185\u5bb9 [neo4j] name=Neo4j RPM Repository baseurl=http://yum.neo4j.org/stable enabled=1 gpgcheck=1 \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5 yum install neo4j-3.3.5 \u7b2c\u4e09\u6b65: \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u9ed8\u8ba4\u5728/etc/neo4j/neo4j.conf, \u4e3a\u4e86\u65b9\u4fbf\u663e\u793a\u4e0b\u9762\u628a\u4e00\u4e9b\u4fee\u6539\u663e\u793a\u5728\u8fd9\u91cc # \u6570\u636e\u5e93\u7684\u5b58\u50a8\u5e93\u5b58\u50a8\u4f4d\u7f6e\u3001\u65e5\u5fd7\u4f4d\u7f6e\u7b49 dbms.directories.data=/var/lib/neo4j/data dbms.directories.plugins=/var/lib/neo4j/plugins dbms.directories.certificates=/var/lib/neo4j/certificates dbms.directories.logs=/var/log/neo4j dbms.directories.lib=/usr/share/neo4j/lib dbms.directories.run=/var/run/neo4j # \u5bfc\u5165\u7684\u4f4d\u7f6e dbms.directories.import=/var/lib/neo4j/import # \u521d\u59cb\u5316\u5185\u5b58\u5927\u5c0f dbms.memory.heap.initial_size=512m # Bolt \u8fde\u63a5\u5730\u5740 dbms.connector.bolt.enabled=true dbms.connector.bolt.tls_level=OPTIONAL dbms.connector.bolt.listen_address=0.0.0.0:7687 \u7b2c\u56db\u6b65: \u542f\u52a8neo4j\u6570\u636e\u5e93 # \u542f\u52a8\u547d\u4ee4 neo4j start # \u7ec8\u7aef\u663e\u793a\u5982\u4e0b, \u4ee3\u8868\u542f\u52a8\u6210\u529f Active database: graph.db Directories in use: home: /usr/neo4j config: /etc/neo4j logs: /var/log/neo4j plugins: /var/lib/neo4j/plugins import: /var/lib/neo4j/import data: /var/lib/neo4j/data certificates: /var/lib/neo4j/certificates run: /var/run/neo4j Starting Neo4j. neo4j\u7684\u53ef\u89c6\u5316\u7ba1\u7406\u540e\u53f0\u767b\u9646: \u8bbf\u95ee\u5730\u5740: http://0.0.0.0:7474. ConnectURL: bolt://0.0.0.0:7687 Username: neo4j Password: neo4j (\u9ed8\u8ba4) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5\u6d41\u7a0b: \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868. \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5. \u7b2c\u4e09\u6b65: \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9 /etc/neo4j/neo4j.conf. \u7b2c\u56db\u6b65: \u542f\u52a8neo4j\u6570\u636e\u5e93. \u5b66\u4e60\u4e86neo4j\u7684\u53ef\u89c6\u5316\u7ba1\u7406\u540e\u53f0\u767b\u9646: \u8bbf\u95ee\u5730\u5740: http://0.0.0.0:7474. ConnectURL: bolt://0.0.0.0:7687 Username: neo4j Password: neo4j (\u9ed8\u8ba4) 3.3 Cypher\u4ecb\u7ecd\u4e0e\u4f7f\u7528 \u5b66\u4e60\u76ee\u6807 \u4e86\u89e3Cypher\u7684\u57fa\u672c\u6982\u5ff5. \u638c\u63e1Cypher\u7684\u57fa\u672c\u547d\u4ee4\u548c\u8bed\u6cd5. Cypher\u7684\u57fa\u672c\u6982\u5ff5: Cypher\u662fneo4j\u56fe\u6570\u636e\u7684\u67e5\u8be2\u8bed\u8a00, \u7c7b\u4f3c\u4e8emysql\u6570\u636e\u5e93\u7684sql\u8bed\u53e5, \u4f46\u662f\u5b83\u5141\u8bb8\u5bf9\u56fe\u5f62\u8fdb\u884c\u5bcc\u6709\u8868\u73b0\u529b\u548c\u6709\u6548\u7684\u67e5\u8be2\u548c\u66f4\u65b0. Cypher\u7684\u57fa\u672c\u547d\u4ee4\u548c\u8bed\u6cd5: create\u547d\u4ee4 match\u547d\u4ee4 merge\u547d\u4ee4 relationship\u5173\u7cfb\u547d\u4ee4 where\u547d\u4ee4 delete\u547d\u4ee4 sort\u547d\u4ee4 \u5b57\u7b26\u4e32\u51fd\u6570 \u805a\u5408\u51fd\u6570 index\u7d22\u5f15\u547d\u4ee4 create\u547d\u4ee4: \u521b\u5efa\u56fe\u6570\u636e\u4e2d\u7684\u8282\u70b9. \u6f14\u793a: # \u521b\u5efa\u547d\u4ee4\u683c\u5f0f: # \u6b64\u5904create\u662f\u5173\u952e\u5b57, \u521b\u5efa\u8282\u70b9\u540d\u79f0node_name, \u8282\u70b9\u6807\u7b7eNode_Label, \u653e\u5728\u5c0f\u62ec\u53f7\u91cc\u9762() # \u540e\u9762\u628a\u6240\u6709\u5c5e\u4e8e\u8282\u70b9\u6807\u7b7e\u7684\u5c5e\u6027\u653e\u5728\u5927\u62ec\u53f7'{}'\u91cc\u9762, \u4f9d\u6b21\u5199\u51fa\u5c5e\u6027\u540d\u79f0:\u5c5e\u6027\u503c, \u4e0d\u540c\u5c5e\u6027\u7528\u9017\u53f7','\u5206\u9694 # \u4f8b\u5982\u4e0b\u9762\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u8282\u70b9e, \u8282\u70b9\u6807\u7b7e\u662fEmployee, \u62e5\u6709id, name, salary, deptnp\u56db\u4e2a\u5c5e\u6027: CREATE (e:Employee{id:222, name:'Bob', salary:6000, deptnp:12}) \u6548\u679c match\u547d\u4ee4: \u5339\u914d(\u67e5\u8be2)\u5df2\u6709\u6570\u636e. \u6f14\u793a: # match\u547d\u4ee4\u4e13\u95e8\u7528\u6765\u5339\u914d\u67e5\u8be2, \u8282\u70b9\u540d\u79f0:\u8282\u70b9\u6807\u7b7e, \u4f9d\u7136\u653e\u5728\u5c0f\u62ec\u53f7\u5185, \u7136\u540e\u4f7f\u7528return\u8bed\u53e5\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c, \u548cSQL\u5f88\u76f8\u4f3c. MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno \u6548\u679c: merge\u547d\u4ee4: \u82e5\u8282\u70b9\u5b58\u5728, \u5219\u7b49\u6548\u4e0ematch\u547d\u4ee4; \u8282\u70b9\u4e0d\u5b58\u5728, \u5219\u7b49\u6548\u4e8ecreate\u547d\u4ee4. \u6f14\u793a: MERGE (e:Employee {id:146, name:'Lucer', salary:3500, deptno:16}) \u6548\u679c: \u7136\u540e\u518d\u6b21\u7528merge\u67e5\u8be2, \u53d1\u73b0\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u5e76\u6ca1\u6709\u589e\u52a0, \u56e0\u4e3a\u5df2\u7ecf\u5b58\u5728\u76f8\u540c\u7684\u6570\u636e\u4e86, merge\u5339\u914d\u6210\u529f. \u6f14\u793a: MERGE (e:Employee {id:146, name:'Lucer', salary:3500, deptno:16}) \u6548\u679c: \u4f7f\u7528create\u521b\u5efa\u5173\u7cfb: \u5fc5\u987b\u521b\u5efa\u6709\u65b9\u5411\u6027\u7684\u5173\u7cfb, \u5426\u5219\u62a5\u9519. \u6f14\u793a: # \u521b\u5efa\u4e00\u4e2a\u8282\u70b9p1\u5230p2\u7684\u6709\u65b9\u5411\u5173\u7cfb, \u8fd9\u4e2a\u5173\u7cfbr\u7684\u6807\u7b7e\u4e3aBuy, \u4ee3\u8868p1\u8d2d\u4e70\u4e86p2, \u65b9\u5411\u4e3ap1\u6307\u5411p2 CREATE (p1:Profile1)-[r:Buy]->(p2:Profile2) \u6548\u679c: \u4f7f\u7528merge\u521b\u5efa\u5173\u7cfb: \u53ef\u4ee5\u521b\u5efa\u6709/\u65e0\u65b9\u5411\u6027\u7684\u5173\u7cfb. \u6f14\u793a: # \u521b\u5efa\u4e00\u4e2a\u8282\u70b9p1\u5230p2\u7684\u65e0\u65b9\u5411\u5173\u7cfb, \u8fd9\u4e2a\u5173\u7cfbr\u7684\u6807\u7b7e\u4e3amiss, \u4ee3\u8868p1-miss-p2, \u65b9\u5411\u4e3a\u76f8\u4e92\u7684 MERGE (p1:Profile1)-[r:miss]-(p2:Profile2) \u6548\u679c: where\u547d\u4ee4: \u7c7b\u4f3c\u4e8eSQL\u4e2d\u7684\u6dfb\u52a0\u67e5\u8be2\u6761\u4ef6. \u6f14\u793a: # \u67e5\u8be2\u8282\u70b9Employee\u4e2d, id\u503c\u7b49\u4e8e123\u7684\u90a3\u4e2a\u8282\u70b9 MATCH (e:Employee) WHERE e.id=123 RETURN e \u6548\u679c: delete\u547d\u4ee4: \u5220\u9664\u8282\u70b9/\u5173\u7cfb\u53ca\u5176\u5173\u8054\u7684\u5c5e\u6027. \u6f14\u793a: # \u6ce8\u610f: \u5220\u9664\u8282\u70b9\u7684\u540c\u65f6, \u4e5f\u8981\u5220\u9664\u5173\u8054\u7684\u5173\u7cfb\u8fb9 MATCH (c1:CreditCard)-[r]-(c2:Customer) DELETE c1, r, c2 \u6548\u679c: sort\u547d\u4ee4: Cypher\u547d\u4ee4\u4e2d\u7684\u6392\u5e8f\u4f7f\u7528\u7684\u662forder by. \u6f14\u793a: # \u5339\u914d\u67e5\u8be2\u6807\u7b7eEmployee, \u5c06\u6240\u6709\u5339\u914d\u7ed3\u679c\u6309\u7167id\u503c\u5347\u5e8f\u6392\u5217\u540e\u8fd4\u56de\u7ed3\u679c MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno ORDER BY e.id # \u5982\u679c\u8981\u6309\u7167\u964d\u5e8f\u6392\u5e8f, \u53ea\u9700\u8981\u5c06ORDER BY e.salary\u6539\u5199\u4e3aORDER BY e.salary DESC MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno ORDER BY e.salary DESC \u6548\u679c: \u5b57\u7b26\u4e32\u51fd\u6570: toUpper()\u51fd\u6570 toLower()\u51fd\u6570 substring()\u51fd\u6570 replace()\u51fd\u6570 toUpper()\u51fd\u6570: \u5c06\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5927\u5199\u5b57\u6bcd. \u6f14\u793a: MATCH (e:Employee) RETURN e.id, toUpper(e.name), e.salary, e.deptno \u6548\u679c: toLower()\u51fd\u6570: \u8bb2\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5c0f\u5199\u5b57\u6bcd. \u6f14\u793a: MATCH (e:Employee) RETURN e.id, toLower(e.name), e.salary, e.deptno \u6548\u679c: substring()\u51fd\u6570: \u8fd4\u56de\u4e00\u4e2a\u5b50\u5b57\u7b26\u4e32. \u6f14\u793a: # \u8f93\u5165\u5b57\u7b26\u4e32\u4e3ainput_str, \u8fd4\u56de\u4ece\u7d22\u5f15start_index\u5f00\u59cb, \u5230end_index-1\u7ed3\u675f\u7684\u5b50\u5b57\u7b26\u4e32 substring(input_str, start_index, end_index) # \u793a\u4f8b\u4ee3\u7801, \u8fd4\u56de\u5458\u5de5\u540d\u5b57\u7684\u524d\u4e24\u4e2a\u5b57\u6bcd MATCH (e:Employee) RETURN e.id, substring(e.name,0,2), e.salary, e.deptno \u6548\u679c: replace()\u51fd\u6570: \u66ff\u6362\u6389\u5b50\u5b57\u7b26\u4e32. \u6f14\u793a: # \u8f93\u5165\u5b57\u7b26\u4e32\u4e3ainput_str, \u5c06\u8f93\u5165\u5b57\u7b26\u4e32\u4e2d\u7b26\u5408origin_str\u7684\u90e8\u5206, \u66ff\u6362\u6210new_str replace(input_str, origin_str, new_str) # \u793a\u4f8b\u4ee3\u7801, \u5c06\u5458\u5de5\u540d\u5b57\u66ff\u6362\u4e3a\u6dfb\u52a0\u540e\u7f00_HelloWorld MATCH (e:Employee) RETURN e.id, replace(e.name,e.name,e.name + \"_HelloWorld\"), e.salary, e.deptno \u6548\u679c: \u805a\u5408\u51fd\u6570 count()\u51fd\u6570 max()\u51fd\u6570 min()\u51fd\u6570 sum()\u51fd\u6570 avg()\u51fd\u6570 count()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u6761\u6570. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2a\u6570 MATCH (e:Employee) RETURN count( * ) \u6548\u679c: max()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5927\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6700\u9ad8\u7684\u5de5\u8d44\u6570\u5b57 MATCH (e:Employee) RETURN max(e.salary) \u6548\u679c: min()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5c0f\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6700\u4f4e\u7684\u5de5\u8d44\u6570\u5b57 MATCH (e:Employee) RETURN min(e.salary) \u6548\u679c: sum()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5168\u90e8\u52a0\u548c\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6240\u6709\u5458\u5de5\u5de5\u8d44\u7684\u548c MATCH (e:Employee) RETURN sum(e.salary) \u6548\u679c: avg()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5e73\u5747\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6240\u6709\u5458\u5de5\u5de5\u8d44\u7684\u5e73\u5747\u503c MATCH (e:Employee) RETURN avg(e.salary) \u6548\u679c: \u7d22\u5f15index Neo4j\u652f\u6301\u5728\u8282\u70b9\u6216\u5173\u7cfb\u5c5e\u6027\u4e0a\u7684\u7d22\u5f15, \u4ee5\u63d0\u9ad8\u67e5\u8be2\u7684\u6027\u80fd. \u53ef\u4ee5\u4e3a\u5177\u6709\u76f8\u540c\u6807\u7b7e\u540d\u79f0\u7684\u6240\u6709\u8282\u70b9\u7684\u5c5e\u6027\u521b\u5efa\u7d22\u5f15. \u521b\u5efa\u7d22\u5f15: \u4f7f\u7528create index on\u6765\u521b\u5efa\u7d22\u5f15. \u6f14\u793a: # \u521b\u5efa\u8282\u70b9Employee\u4e0a\u9762\u5c5e\u6027id\u7684\u7d22\u5f15 CREATE INDEX ON:Employee(id) \u6548\u679c: \u5220\u9664\u7d22\u5f15: \u4f7f\u7528drop index on\u6765\u5220\u9664\u7d22\u5f15. \u6f14\u793a: # \u5220\u9664\u8282\u70b9Employee\u4e0a\u9762\u5c5e\u6027id\u7684\u7d22\u5f15 DROP INDEX ON:Employee(id) \u6548\u679c: \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86Cypher\u7684\u57fa\u672c\u6982\u5ff5: Cypher\u662fneo4j\u56fe\u6570\u636e\u7684\u67e5\u8be2\u8bed\u8a00, \u7c7b\u4f3c\u4e8emysql\u6570\u636e\u5e93\u7684sql\u8bed\u53e5, \u4f46\u662f\u5b83\u5141\u8bb8\u5bf9\u56fe\u5f62\u8fdb\u884c\u5bcc\u6709\u8868\u73b0\u529b\u548c\u6709\u6548\u7684\u67e5\u8be2\u548c\u66f4\u65b0. Cypher\u7684\u57fa\u672c\u547d\u4ee4\u548c\u8bed\u6cd5: create\u547d\u4ee4 match\u547d\u4ee4 merge\u547d\u4ee4 relationship\u5173\u7cfb\u547d\u4ee4 where\u547d\u4ee4 delete\u547d\u4ee4 sort\u547d\u4ee4 \u5b57\u7b26\u4e32\u51fd\u6570 \u805a\u5408\u51fd\u6570 index\u7d22\u5f15\u547d\u4ee4 create\u547d\u4ee4: \u521b\u5efa\u56fe\u6570\u636e\u4e2d\u7684\u8282\u70b9. CREATE (e:Employee{id:222, name:'Bob', salary:6000, deptnp:12}) match\u547d\u4ee4: \u5339\u914d(\u67e5\u8be2)\u5df2\u6709\u6570\u636e. MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno merge\u547d\u4ee4: \u82e5\u8282\u70b9\u5b58\u5728, \u5219\u7b49\u6548\u4e0ematch\u547d\u4ee4; \u8282\u70b9\u4e0d\u5b58\u5728, \u5219\u7b49\u6548\u4e8ecreate\u547d\u4ee4. MERGE (e:Employee {id:145, name:'Lucy', salary:7500, deptno:12}) \u4f7f\u7528create\u521b\u5efa\u5173\u7cfb: \u5fc5\u987b\u521b\u5efa\u6709\u65b9\u5411\u6027\u7684\u5173\u7cfb, \u5426\u5219\u62a5\u9519. CREATE (p1:Profile1)-[r:Buy]->(p2:Profile2) \u4f7f\u7528merge\u521b\u5efa\u5173\u7cfb: \u53ef\u4ee5\u521b\u5efa\u6709/\u65e0\u65b9\u5411\u6027\u7684\u5173\u7cfb. MERGE (p1:Profile1)-[r:miss]-(p2:Profile2) where\u547d\u4ee4: \u7c7b\u4f3c\u4e8eSQL\u4e2d\u7684\u6dfb\u52a0\u67e5\u8be2\u6761\u4ef6. MATCH (e:Employee) WHERE e.id=123 RETURN e delete\u547d\u4ee4: \u5220\u9664\u8282\u70b9/\u5173\u7cfb\u53ca\u5176\u5173\u8054\u7684\u5c5e\u6027. MATCH (c1:CreditCard)-[r]-(c2:Customer) DELETE c1, r, c2 sort\u547d\u4ee4: Cypher\u547d\u4ee4\u4e2d\u7684\u6392\u5e8f\u4f7f\u7528\u7684\u662forder by. MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno ORDER BY e.id \u5b57\u7b26\u4e32\u51fd\u6570: toUpper()\u51fd\u6570 toLower()\u51fd\u6570 substring()\u51fd\u6570 replace()\u51fd\u6570 toUpper()\u51fd\u6570: \u5c06\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5927\u5199\u5b57\u6bcd. MATCH (e:Employee) RETURN e.id, toUpper(e.name), e.salary, e.deptno toLower()\u51fd\u6570: \u8bb2\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5c0f\u5199\u5b57\u6bcd. MATCH (e:Employee) RETURN e.id, toLower(e.name), e.salary, e.deptno substring()\u51fd\u6570: \u8fd4\u56de\u4e00\u4e2a\u5b50\u5b57\u7b26\u4e32. MATCH (e:Employee) RETURN e.id, substring(e.name,0,2), e.salary, e.deptno replace()\u51fd\u6570: \u66ff\u6362\u6389\u5b50\u5b57\u7b26\u4e32. MATCH (e:Employee) RETURN e.id, replace(e.name,e.name,e.name + \"_HelloWorld\"), e.salary, e.deptno \u805a\u5408\u51fd\u6570 count()\u51fd\u6570 max()\u51fd\u6570 min()\u51fd\u6570 sum()\u51fd\u6570 avg()\u51fd\u6570 count()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u6761\u6570. MATCH (e:Employee) RETURN count( * ) max()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5927\u503c. MATCH (e:Employee) RETURN max(e.salary) min()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5c0f\u503c. MATCH (e:Employee) RETURN min(e.salary) sum()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5168\u90e8\u52a0\u548c\u503c. MATCH (e:Employee) RETURN sum(e.salary) avg()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5e73\u5747\u503c. MATCH (e:Employee) RETURN avg(e.salary) \u7d22\u5f15index Neo4j\u652f\u6301\u5728\u8282\u70b9\u6216\u5173\u7cfb\u5c5e\u6027\u4e0a\u7684\u7d22\u5f15, \u4ee5\u63d0\u9ad8\u67e5\u8be2\u7684\u6027\u80fd. \u53ef\u4ee5\u4e3a\u5177\u6709\u76f8\u540c\u6807\u7b7e\u540d\u79f0\u7684\u6240\u6709\u8282\u70b9\u7684\u5c5e\u6027\u521b\u5efa\u7d22\u5f15. \u521b\u5efa\u7d22\u5f15: \u4f7f\u7528create index on\u6765\u521b\u5efa\u7d22\u5f15. CREATE INDEX ON:Employee(id) \u5220\u9664\u7d22\u5f15: \u4f7f\u7528drop index on\u6765\u5220\u9664\u7d22\u5f15. DROP INDEX ON:Employee(id) 3.4 \u5728Python\u4e2d\u4f7f\u7528neo4j \u5b66\u4e60\u76ee\u6807 \u4e86\u89e3python\u4e2dneo4j-driver\u7684\u76f8\u5173\u77e5\u8bc6. \u638c\u63e1neo4j\u4e2d\u4e8b\u52a1\u6982\u5ff5\u548c\u64cd\u4f5c\u65b9\u6cd5. neo4j-driver\u7b80\u4ecb: neo4j-driver\u662f\u4e00\u4e2apython\u4e2d\u7684package, \u4f5c\u4e3apython\u4e2dneo4j\u7684\u9a71\u52a8, \u5e2e\u52a9\u6211\u4eec\u5728python\u7a0b\u5e8f\u4e2d\u66f4\u597d\u7684\u4f7f\u7528\u56fe\u6570\u636e\u5e93. neo4j-driver\u7684\u5b89\u88c5: pip install neo4j-driver neo4j-driver\u4f7f\u7528\u6f14\u793a: from neo4j import GraphDatabase # \u5173\u4e8eneo4j\u6570\u636e\u5e93\u7684\u7528\u6237\u540d,\u5bc6\u7801\u4fe1\u606f\u5df2\u7ecf\u914d\u7f6e\u5728\u540c\u76ee\u5f55\u4e0b\u7684config.py\u6587\u4ef6\u4e2d from config import NEO4J_CONFIG driver = GraphDatabase.driver( **NEO4J_CONFIG) # \u76f4\u63a5\u7528python\u4ee3\u7801\u5f62\u5f0f\u8bbf\u95ee\u8282\u70b9Company, \u5e76\u8fd4\u56de\u6240\u6709\u8282\u70b9\u4fe1\u606f with driver.session() as session: cypher = \"CREATE(c:Company) SET c.name='\u9ed1\u9a6c\u7a0b\u5e8f\u5458' RETURN c.name\" record = session.run(cypher) result = list(map(lambda x: x[0], record)) print(\"result:\", result) \u8f93\u51fa\u6548\u679c: result: \u9ed1\u9a6c\u7a0b\u5e8f\u5458 \u4e8b\u52a1\u7684\u6982\u5ff5: \u5982\u679c\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\u8981\u4e48\u5168\u90e8\u53d1\u751f\u8981\u4e48\u4e00\u6b65\u4e5f\u4e0d\u6267\u884c\uff0c\u6211\u4eec\u79f0\u8be5\u7ec4\u5904\u7406\u6b65\u9aa4\u4e3a\u4e00\u4e2a\u4e8b\u52a1, \u5b83\u662f\u6570\u636e\u5e93\u4e00\u81f4\u6027\u7684\u4fdd\u8bc1. \u4f7f\u7528\u4e8b\u52a1\u7684\u6f14\u793a: def _some_operations(tx, cat_name, mouse_name): tx.run(\"MERGE (a:Cat{name: $cat_name})\" \"MERGE (b:Mouse{name: $mouse_name})\" \"MERGE (a)-[r:And]-(b)\", cat_name=cat_name, mouse_name=mouse_name) with driver.session() as session: session.write_transaction(_some_operations, \"Tom\", \"Jerry\") \u8f93\u51fa\u6548\u679c: \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86neo4j-driver\u7b80\u4ecb: neo4j-driver\u662f\u4e00\u4e2apython\u4e2d\u7684package, \u4f5c\u4e3apython\u4e2dneo4j\u7684\u9a71\u52a8, \u5e2e\u52a9\u6211\u4eec\u5728python\u7a0b\u5e8f\u4e2d\u66f4\u597d\u7684\u4f7f\u7528\u56fe\u6570\u636e\u5e93. \u5b66\u4e60\u4e86neo4j-driver\u7684\u5b89\u88c5\u548c\u4f7f\u7528\u65b9\u6cd5. \u5b66\u4e60\u4e86\u4e8b\u52a1\u7684\u6982\u5ff5: \u5982\u679c\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\u8981\u4e48\u5168\u90e8\u53d1\u751f\u8981\u4e48\u4e00\u6b65\u4e5f\u4e0d\u6267\u884c\uff0c\u6211\u4eec\u79f0\u8be5\u7ec4\u5904\u7406\u6b65\u9aa4\u4e3a\u4e00\u4e2a\u4e8b\u52a1, \u5b83\u662f\u6570\u636e\u5e93\u4e00\u81f4\u6027\u7684\u4fdd\u8bc1. \u5b66\u4e60\u4e86\u5982\u4f55\u4f7f\u7528\u4e8b\u52a1\u6765\u5411\u56fe\u6570\u636e\u5e93\u4e2d\u5199\u5165\u6570\u636e.","title":"\u7b2c\u4e09\u7ae0:neo4j\u56fe\u6570\u636e\u5e93"},{"location":"3/#31-neo4j","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3neo4j\u56fe\u6570\u636e\u5e93\u7684\u7b80\u4ecb, \u7248\u672c\u8bf4\u660e. \u4e86\u89e3\u8282\u70b9, \u5173\u7cfb\uff0c\u5c5e\u6027\uff0c\u6807\u7b7e\u7684\u6709\u5173\u6982\u5ff5. neo4j\u7b80\u4ecb: neo4j\u662f\u7531Java\u5b9e\u73b0\u7684\u5f00\u6e90NoSQL\u56fe\u6570\u636e\u5e93.\u81ea\u4ece2003\u5e74\u5f00\u59cb\u7814\u53d1, \u52302007\u5e74\u53d1\u5e03\u7b2c\u4e00\u7248, \u6700\u65b0\u7248\u672c\u4e3a3.3.5, neo4j\u73b0\u5982\u4eca\u5df2\u7ecf\u88ab\u5404\u884c\u5404\u4e1a\u7684\u6570\u5341\u4e07\u5bb6\u516c\u53f8\u548c\u7ec4\u7ec7\u91c7\u7528. neo4j\u5b9e\u73b0\u4e86\u4e13\u4e1a\u6570\u636e\u5e93\u7ea7\u522b\u7684\u56fe\u6570\u636e\u6a21\u578b\u7684\u5b58\u50a8. \u4e0e\u666e\u901a\u7684\u56fe\u5904\u7406\u6216\u5185\u5b58\u7ea7\u6570\u636e\u5e93\u4e0d\u540c, neo4j\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u6570\u636e\u5e93\u7279\u6027, \u5305\u62ecACID\u4e8b\u7269\u7684\u652f\u6301, \u96c6\u7fa4\u652f\u6301, \u5907\u4efd\u4e0e\u6545\u969c\u8f6c\u79fb\u7b49. \u8fd9\u4f7f\u5176\u9002\u5408\u4e8e\u4f01\u4e1a\u7ea7\u751f\u4ea7\u73af\u5883\u4e0b\u7684\u5404\u79cd\u5e94\u7528. neo4j\u7684\u7248\u672c\u8bf4\u660e: \u4f01\u4e1a\u7248: \u9700\u8981\u9ad8\u989d\u7684\u4ed8\u8d39\u83b7\u5f97\u6388\u6743, \u63d0\u4f9b\u9ad8\u53ef\u7528, \u70ed\u5907\u4efd\u7b49\u6027\u80fd. \u793e\u533a\u5f00\u6e90\u7248: \u514d\u8d39\u4f7f\u7528, \u4f46\u53ea\u80fd\u5355\u70b9\u8fd0\u884c. neo4j\u56fe\u5f62\u6570\u636e\u5e93\u7684\u6709\u5173\u6982\u5ff5: \u8282\u70b9 \u8282\u70b9\u662f\u4e3b\u8981\u7684\u6570\u636e\u5143\u7d20, \u8282\u70b9\u901a\u8fc7\u5173\u7cfb\u8fde\u63a5\u5230\u5176\u4ed6\u8282\u70b9, \u8282\u70b9\u53ef\u4ee5\u5177\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5c5e\u6027 (\u5373\u5b58\u50a8\u4e3a\u952e/\u503c\u5bf9\u7684\u5c5e\u6027), \u8282\u70b9\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u7b7e, \u7528\u4e8e\u63cf\u8ff0\u5176\u5728\u56fe\u8868\u4e2d\u7684\u4f5c\u7528. \u793a\u4f8b: Person>\u8282\u70b9. \u53ef\u4ee5\u5c06\u8282\u70b9\u7c7b\u6bd4\u4e3a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u7684\u8868, \u5bf9\u5e94\u7684\u6807\u7b7e\u53ef\u4ee5\u7c7b\u6bd4\u4e3a\u4e0d\u540c\u7684\u8868\u540d, \u5c5e\u6027\u5c31\u662f\u8868\u4e2d\u7684\u5217. \u5173\u7cfb \u5173\u7cfb\u8fde\u63a5\u4e24\u4e2a\u8282\u70b9, \u5173\u7cfb\u662f\u65b9\u5411\u6027\u7684, \u5173\u7cfb\u53ef\u4ee5\u6709\u4e00\u4e2a\u6216\u591a\u4e2a\u5c5e\u6027(\u5373\u5b58\u50a8\u4e3a\u952e/\u503c\u5bf9\u7684 \u5c5e\u6027). \u5c5e\u6027 \u5c5e\u6027\u662f\u547d\u540d\u503c, \u5176\u4e2d\u540d\u79f0(\u6216\u952e)\u662f\u5b57\u7b26\u4e32, \u5c5e\u6027\u53ef\u4ee5\u88ab\u7d22\u5f15\u548c\u7ea6\u675f, \u53ef\u4ee5\u4ece\u591a\u4e2a\u5c5e\u6027\u521b \u5efa\u590d\u5408\u7d22\u5f15. \u6807\u7b7e \u6807\u7b7e\u7528\u4e8e\u7ec4\u8282\u70b9\u5230\u96c6, \u8282\u70b9\u53ef\u4ee5\u5177\u6709\u591a\u4e2a\u6807\u7b7e, \u5bf9\u6807\u7b7e\u8fdb\u884c\u7d22\u5f15\u4ee5\u52a0\u901f\u5728\u56fe\u4e2d\u67e5\u627e\u8282\u70b9.","title":"3.1 neo4j\u7b80\u4ecb"},{"location":"3/#32-neo4j","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5\u6d41\u7a0b\u53ca\u5176\u53ef\u89c6\u5316\u540e\u53f0\u7684\u767b\u9646.. neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5\u6d41\u7a0b: \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868. \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5. \u7b2c\u4e09\u6b65: \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9 /etc/neo4j/neo4j.conf. \u7b2c\u56db\u6b65: \u542f\u52a8neo4j\u6570\u636e\u5e93. \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868 cd /tmp wget http://debian.neo4j.org/neotechnology.gpg.key rpm --import neotechnology.gpg.key cat <<EOF> /etc/yum.repos.d/neo4j.repo # \u5199\u5165\u4e0b\u9762\u5185\u5bb9 [neo4j] name=Neo4j RPM Repository baseurl=http://yum.neo4j.org/stable enabled=1 gpgcheck=1 \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5 yum install neo4j-3.3.5 \u7b2c\u4e09\u6b65: \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u9ed8\u8ba4\u5728/etc/neo4j/neo4j.conf, \u4e3a\u4e86\u65b9\u4fbf\u663e\u793a\u4e0b\u9762\u628a\u4e00\u4e9b\u4fee\u6539\u663e\u793a\u5728\u8fd9\u91cc # \u6570\u636e\u5e93\u7684\u5b58\u50a8\u5e93\u5b58\u50a8\u4f4d\u7f6e\u3001\u65e5\u5fd7\u4f4d\u7f6e\u7b49 dbms.directories.data=/var/lib/neo4j/data dbms.directories.plugins=/var/lib/neo4j/plugins dbms.directories.certificates=/var/lib/neo4j/certificates dbms.directories.logs=/var/log/neo4j dbms.directories.lib=/usr/share/neo4j/lib dbms.directories.run=/var/run/neo4j # \u5bfc\u5165\u7684\u4f4d\u7f6e dbms.directories.import=/var/lib/neo4j/import # \u521d\u59cb\u5316\u5185\u5b58\u5927\u5c0f dbms.memory.heap.initial_size=512m # Bolt \u8fde\u63a5\u5730\u5740 dbms.connector.bolt.enabled=true dbms.connector.bolt.tls_level=OPTIONAL dbms.connector.bolt.listen_address=0.0.0.0:7687 \u7b2c\u56db\u6b65: \u542f\u52a8neo4j\u6570\u636e\u5e93 # \u542f\u52a8\u547d\u4ee4 neo4j start # \u7ec8\u7aef\u663e\u793a\u5982\u4e0b, \u4ee3\u8868\u542f\u52a8\u6210\u529f Active database: graph.db Directories in use: home: /usr/neo4j config: /etc/neo4j logs: /var/log/neo4j plugins: /var/lib/neo4j/plugins import: /var/lib/neo4j/import data: /var/lib/neo4j/data certificates: /var/lib/neo4j/certificates run: /var/run/neo4j Starting Neo4j. neo4j\u7684\u53ef\u89c6\u5316\u7ba1\u7406\u540e\u53f0\u767b\u9646: \u8bbf\u95ee\u5730\u5740: http://0.0.0.0:7474. ConnectURL: bolt://0.0.0.0:7687 Username: neo4j Password: neo4j (\u9ed8\u8ba4) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5\u6d41\u7a0b: \u7b2c\u4e00\u6b65: \u5c06neo4j\u5b89\u88c5\u4fe1\u606f\u8f7d\u5165\u5230yum\u68c0\u7d22\u5217\u8868. \u7b2c\u4e8c\u6b65: \u4f7f\u7528yum install\u547d\u4ee4\u5b89\u88c5. \u7b2c\u4e09\u6b65: \u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5185\u5bb9 /etc/neo4j/neo4j.conf. \u7b2c\u56db\u6b65: \u542f\u52a8neo4j\u6570\u636e\u5e93. \u5b66\u4e60\u4e86neo4j\u7684\u53ef\u89c6\u5316\u7ba1\u7406\u540e\u53f0\u767b\u9646: \u8bbf\u95ee\u5730\u5740: http://0.0.0.0:7474. ConnectURL: bolt://0.0.0.0:7687 Username: neo4j Password: neo4j (\u9ed8\u8ba4)","title":"3.2 neo4j\u56fe\u6570\u636e\u5e93\u7684\u5b89\u88c5"},{"location":"3/#33-cypher","text":"\u5b66\u4e60\u76ee\u6807 \u4e86\u89e3Cypher\u7684\u57fa\u672c\u6982\u5ff5. \u638c\u63e1Cypher\u7684\u57fa\u672c\u547d\u4ee4\u548c\u8bed\u6cd5. Cypher\u7684\u57fa\u672c\u6982\u5ff5: Cypher\u662fneo4j\u56fe\u6570\u636e\u7684\u67e5\u8be2\u8bed\u8a00, \u7c7b\u4f3c\u4e8emysql\u6570\u636e\u5e93\u7684sql\u8bed\u53e5, \u4f46\u662f\u5b83\u5141\u8bb8\u5bf9\u56fe\u5f62\u8fdb\u884c\u5bcc\u6709\u8868\u73b0\u529b\u548c\u6709\u6548\u7684\u67e5\u8be2\u548c\u66f4\u65b0. Cypher\u7684\u57fa\u672c\u547d\u4ee4\u548c\u8bed\u6cd5: create\u547d\u4ee4 match\u547d\u4ee4 merge\u547d\u4ee4 relationship\u5173\u7cfb\u547d\u4ee4 where\u547d\u4ee4 delete\u547d\u4ee4 sort\u547d\u4ee4 \u5b57\u7b26\u4e32\u51fd\u6570 \u805a\u5408\u51fd\u6570 index\u7d22\u5f15\u547d\u4ee4 create\u547d\u4ee4: \u521b\u5efa\u56fe\u6570\u636e\u4e2d\u7684\u8282\u70b9. \u6f14\u793a: # \u521b\u5efa\u547d\u4ee4\u683c\u5f0f: # \u6b64\u5904create\u662f\u5173\u952e\u5b57, \u521b\u5efa\u8282\u70b9\u540d\u79f0node_name, \u8282\u70b9\u6807\u7b7eNode_Label, \u653e\u5728\u5c0f\u62ec\u53f7\u91cc\u9762() # \u540e\u9762\u628a\u6240\u6709\u5c5e\u4e8e\u8282\u70b9\u6807\u7b7e\u7684\u5c5e\u6027\u653e\u5728\u5927\u62ec\u53f7'{}'\u91cc\u9762, \u4f9d\u6b21\u5199\u51fa\u5c5e\u6027\u540d\u79f0:\u5c5e\u6027\u503c, \u4e0d\u540c\u5c5e\u6027\u7528\u9017\u53f7','\u5206\u9694 # \u4f8b\u5982\u4e0b\u9762\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u8282\u70b9e, \u8282\u70b9\u6807\u7b7e\u662fEmployee, \u62e5\u6709id, name, salary, deptnp\u56db\u4e2a\u5c5e\u6027: CREATE (e:Employee{id:222, name:'Bob', salary:6000, deptnp:12}) \u6548\u679c match\u547d\u4ee4: \u5339\u914d(\u67e5\u8be2)\u5df2\u6709\u6570\u636e. \u6f14\u793a: # match\u547d\u4ee4\u4e13\u95e8\u7528\u6765\u5339\u914d\u67e5\u8be2, \u8282\u70b9\u540d\u79f0:\u8282\u70b9\u6807\u7b7e, \u4f9d\u7136\u653e\u5728\u5c0f\u62ec\u53f7\u5185, \u7136\u540e\u4f7f\u7528return\u8bed\u53e5\u8fd4\u56de\u67e5\u8be2\u7ed3\u679c, \u548cSQL\u5f88\u76f8\u4f3c. MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno \u6548\u679c: merge\u547d\u4ee4: \u82e5\u8282\u70b9\u5b58\u5728, \u5219\u7b49\u6548\u4e0ematch\u547d\u4ee4; \u8282\u70b9\u4e0d\u5b58\u5728, \u5219\u7b49\u6548\u4e8ecreate\u547d\u4ee4. \u6f14\u793a: MERGE (e:Employee {id:146, name:'Lucer', salary:3500, deptno:16}) \u6548\u679c: \u7136\u540e\u518d\u6b21\u7528merge\u67e5\u8be2, \u53d1\u73b0\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u5e76\u6ca1\u6709\u589e\u52a0, \u56e0\u4e3a\u5df2\u7ecf\u5b58\u5728\u76f8\u540c\u7684\u6570\u636e\u4e86, merge\u5339\u914d\u6210\u529f. \u6f14\u793a: MERGE (e:Employee {id:146, name:'Lucer', salary:3500, deptno:16}) \u6548\u679c: \u4f7f\u7528create\u521b\u5efa\u5173\u7cfb: \u5fc5\u987b\u521b\u5efa\u6709\u65b9\u5411\u6027\u7684\u5173\u7cfb, \u5426\u5219\u62a5\u9519. \u6f14\u793a: # \u521b\u5efa\u4e00\u4e2a\u8282\u70b9p1\u5230p2\u7684\u6709\u65b9\u5411\u5173\u7cfb, \u8fd9\u4e2a\u5173\u7cfbr\u7684\u6807\u7b7e\u4e3aBuy, \u4ee3\u8868p1\u8d2d\u4e70\u4e86p2, \u65b9\u5411\u4e3ap1\u6307\u5411p2 CREATE (p1:Profile1)-[r:Buy]->(p2:Profile2) \u6548\u679c: \u4f7f\u7528merge\u521b\u5efa\u5173\u7cfb: \u53ef\u4ee5\u521b\u5efa\u6709/\u65e0\u65b9\u5411\u6027\u7684\u5173\u7cfb. \u6f14\u793a: # \u521b\u5efa\u4e00\u4e2a\u8282\u70b9p1\u5230p2\u7684\u65e0\u65b9\u5411\u5173\u7cfb, \u8fd9\u4e2a\u5173\u7cfbr\u7684\u6807\u7b7e\u4e3amiss, \u4ee3\u8868p1-miss-p2, \u65b9\u5411\u4e3a\u76f8\u4e92\u7684 MERGE (p1:Profile1)-[r:miss]-(p2:Profile2) \u6548\u679c: where\u547d\u4ee4: \u7c7b\u4f3c\u4e8eSQL\u4e2d\u7684\u6dfb\u52a0\u67e5\u8be2\u6761\u4ef6. \u6f14\u793a: # \u67e5\u8be2\u8282\u70b9Employee\u4e2d, id\u503c\u7b49\u4e8e123\u7684\u90a3\u4e2a\u8282\u70b9 MATCH (e:Employee) WHERE e.id=123 RETURN e \u6548\u679c: delete\u547d\u4ee4: \u5220\u9664\u8282\u70b9/\u5173\u7cfb\u53ca\u5176\u5173\u8054\u7684\u5c5e\u6027. \u6f14\u793a: # \u6ce8\u610f: \u5220\u9664\u8282\u70b9\u7684\u540c\u65f6, \u4e5f\u8981\u5220\u9664\u5173\u8054\u7684\u5173\u7cfb\u8fb9 MATCH (c1:CreditCard)-[r]-(c2:Customer) DELETE c1, r, c2 \u6548\u679c: sort\u547d\u4ee4: Cypher\u547d\u4ee4\u4e2d\u7684\u6392\u5e8f\u4f7f\u7528\u7684\u662forder by. \u6f14\u793a: # \u5339\u914d\u67e5\u8be2\u6807\u7b7eEmployee, \u5c06\u6240\u6709\u5339\u914d\u7ed3\u679c\u6309\u7167id\u503c\u5347\u5e8f\u6392\u5217\u540e\u8fd4\u56de\u7ed3\u679c MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno ORDER BY e.id # \u5982\u679c\u8981\u6309\u7167\u964d\u5e8f\u6392\u5e8f, \u53ea\u9700\u8981\u5c06ORDER BY e.salary\u6539\u5199\u4e3aORDER BY e.salary DESC MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno ORDER BY e.salary DESC \u6548\u679c: \u5b57\u7b26\u4e32\u51fd\u6570: toUpper()\u51fd\u6570 toLower()\u51fd\u6570 substring()\u51fd\u6570 replace()\u51fd\u6570 toUpper()\u51fd\u6570: \u5c06\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5927\u5199\u5b57\u6bcd. \u6f14\u793a: MATCH (e:Employee) RETURN e.id, toUpper(e.name), e.salary, e.deptno \u6548\u679c: toLower()\u51fd\u6570: \u8bb2\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5c0f\u5199\u5b57\u6bcd. \u6f14\u793a: MATCH (e:Employee) RETURN e.id, toLower(e.name), e.salary, e.deptno \u6548\u679c: substring()\u51fd\u6570: \u8fd4\u56de\u4e00\u4e2a\u5b50\u5b57\u7b26\u4e32. \u6f14\u793a: # \u8f93\u5165\u5b57\u7b26\u4e32\u4e3ainput_str, \u8fd4\u56de\u4ece\u7d22\u5f15start_index\u5f00\u59cb, \u5230end_index-1\u7ed3\u675f\u7684\u5b50\u5b57\u7b26\u4e32 substring(input_str, start_index, end_index) # \u793a\u4f8b\u4ee3\u7801, \u8fd4\u56de\u5458\u5de5\u540d\u5b57\u7684\u524d\u4e24\u4e2a\u5b57\u6bcd MATCH (e:Employee) RETURN e.id, substring(e.name,0,2), e.salary, e.deptno \u6548\u679c: replace()\u51fd\u6570: \u66ff\u6362\u6389\u5b50\u5b57\u7b26\u4e32. \u6f14\u793a: # \u8f93\u5165\u5b57\u7b26\u4e32\u4e3ainput_str, \u5c06\u8f93\u5165\u5b57\u7b26\u4e32\u4e2d\u7b26\u5408origin_str\u7684\u90e8\u5206, \u66ff\u6362\u6210new_str replace(input_str, origin_str, new_str) # \u793a\u4f8b\u4ee3\u7801, \u5c06\u5458\u5de5\u540d\u5b57\u66ff\u6362\u4e3a\u6dfb\u52a0\u540e\u7f00_HelloWorld MATCH (e:Employee) RETURN e.id, replace(e.name,e.name,e.name + \"_HelloWorld\"), e.salary, e.deptno \u6548\u679c: \u805a\u5408\u51fd\u6570 count()\u51fd\u6570 max()\u51fd\u6570 min()\u51fd\u6570 sum()\u51fd\u6570 avg()\u51fd\u6570 count()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u6761\u6570. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2a\u6570 MATCH (e:Employee) RETURN count( * ) \u6548\u679c: max()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5927\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6700\u9ad8\u7684\u5de5\u8d44\u6570\u5b57 MATCH (e:Employee) RETURN max(e.salary) \u6548\u679c: min()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5c0f\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6700\u4f4e\u7684\u5de5\u8d44\u6570\u5b57 MATCH (e:Employee) RETURN min(e.salary) \u6548\u679c: sum()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5168\u90e8\u52a0\u548c\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6240\u6709\u5458\u5de5\u5de5\u8d44\u7684\u548c MATCH (e:Employee) RETURN sum(e.salary) \u6548\u679c: avg()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5e73\u5747\u503c. \u6f14\u793a: # \u8fd4\u56de\u5339\u914d\u6807\u7b7eEmployee\u6210\u529f\u7684\u8bb0\u5f55\u4e2d, \u6240\u6709\u5458\u5de5\u5de5\u8d44\u7684\u5e73\u5747\u503c MATCH (e:Employee) RETURN avg(e.salary) \u6548\u679c: \u7d22\u5f15index Neo4j\u652f\u6301\u5728\u8282\u70b9\u6216\u5173\u7cfb\u5c5e\u6027\u4e0a\u7684\u7d22\u5f15, \u4ee5\u63d0\u9ad8\u67e5\u8be2\u7684\u6027\u80fd. \u53ef\u4ee5\u4e3a\u5177\u6709\u76f8\u540c\u6807\u7b7e\u540d\u79f0\u7684\u6240\u6709\u8282\u70b9\u7684\u5c5e\u6027\u521b\u5efa\u7d22\u5f15. \u521b\u5efa\u7d22\u5f15: \u4f7f\u7528create index on\u6765\u521b\u5efa\u7d22\u5f15. \u6f14\u793a: # \u521b\u5efa\u8282\u70b9Employee\u4e0a\u9762\u5c5e\u6027id\u7684\u7d22\u5f15 CREATE INDEX ON:Employee(id) \u6548\u679c: \u5220\u9664\u7d22\u5f15: \u4f7f\u7528drop index on\u6765\u5220\u9664\u7d22\u5f15. \u6f14\u793a: # \u5220\u9664\u8282\u70b9Employee\u4e0a\u9762\u5c5e\u6027id\u7684\u7d22\u5f15 DROP INDEX ON:Employee(id) \u6548\u679c: \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86Cypher\u7684\u57fa\u672c\u6982\u5ff5: Cypher\u662fneo4j\u56fe\u6570\u636e\u7684\u67e5\u8be2\u8bed\u8a00, \u7c7b\u4f3c\u4e8emysql\u6570\u636e\u5e93\u7684sql\u8bed\u53e5, \u4f46\u662f\u5b83\u5141\u8bb8\u5bf9\u56fe\u5f62\u8fdb\u884c\u5bcc\u6709\u8868\u73b0\u529b\u548c\u6709\u6548\u7684\u67e5\u8be2\u548c\u66f4\u65b0. Cypher\u7684\u57fa\u672c\u547d\u4ee4\u548c\u8bed\u6cd5: create\u547d\u4ee4 match\u547d\u4ee4 merge\u547d\u4ee4 relationship\u5173\u7cfb\u547d\u4ee4 where\u547d\u4ee4 delete\u547d\u4ee4 sort\u547d\u4ee4 \u5b57\u7b26\u4e32\u51fd\u6570 \u805a\u5408\u51fd\u6570 index\u7d22\u5f15\u547d\u4ee4 create\u547d\u4ee4: \u521b\u5efa\u56fe\u6570\u636e\u4e2d\u7684\u8282\u70b9. CREATE (e:Employee{id:222, name:'Bob', salary:6000, deptnp:12}) match\u547d\u4ee4: \u5339\u914d(\u67e5\u8be2)\u5df2\u6709\u6570\u636e. MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno merge\u547d\u4ee4: \u82e5\u8282\u70b9\u5b58\u5728, \u5219\u7b49\u6548\u4e0ematch\u547d\u4ee4; \u8282\u70b9\u4e0d\u5b58\u5728, \u5219\u7b49\u6548\u4e8ecreate\u547d\u4ee4. MERGE (e:Employee {id:145, name:'Lucy', salary:7500, deptno:12}) \u4f7f\u7528create\u521b\u5efa\u5173\u7cfb: \u5fc5\u987b\u521b\u5efa\u6709\u65b9\u5411\u6027\u7684\u5173\u7cfb, \u5426\u5219\u62a5\u9519. CREATE (p1:Profile1)-[r:Buy]->(p2:Profile2) \u4f7f\u7528merge\u521b\u5efa\u5173\u7cfb: \u53ef\u4ee5\u521b\u5efa\u6709/\u65e0\u65b9\u5411\u6027\u7684\u5173\u7cfb. MERGE (p1:Profile1)-[r:miss]-(p2:Profile2) where\u547d\u4ee4: \u7c7b\u4f3c\u4e8eSQL\u4e2d\u7684\u6dfb\u52a0\u67e5\u8be2\u6761\u4ef6. MATCH (e:Employee) WHERE e.id=123 RETURN e delete\u547d\u4ee4: \u5220\u9664\u8282\u70b9/\u5173\u7cfb\u53ca\u5176\u5173\u8054\u7684\u5c5e\u6027. MATCH (c1:CreditCard)-[r]-(c2:Customer) DELETE c1, r, c2 sort\u547d\u4ee4: Cypher\u547d\u4ee4\u4e2d\u7684\u6392\u5e8f\u4f7f\u7528\u7684\u662forder by. MATCH (e:Employee) RETURN e.id, e.name, e.salary, e.deptno ORDER BY e.id \u5b57\u7b26\u4e32\u51fd\u6570: toUpper()\u51fd\u6570 toLower()\u51fd\u6570 substring()\u51fd\u6570 replace()\u51fd\u6570 toUpper()\u51fd\u6570: \u5c06\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5927\u5199\u5b57\u6bcd. MATCH (e:Employee) RETURN e.id, toUpper(e.name), e.salary, e.deptno toLower()\u51fd\u6570: \u8bb2\u4e00\u4e2a\u8f93\u5165\u5b57\u7b26\u4e32\u8f6c\u6362\u4e3a\u5c0f\u5199\u5b57\u6bcd. MATCH (e:Employee) RETURN e.id, toLower(e.name), e.salary, e.deptno substring()\u51fd\u6570: \u8fd4\u56de\u4e00\u4e2a\u5b50\u5b57\u7b26\u4e32. MATCH (e:Employee) RETURN e.id, substring(e.name,0,2), e.salary, e.deptno replace()\u51fd\u6570: \u66ff\u6362\u6389\u5b50\u5b57\u7b26\u4e32. MATCH (e:Employee) RETURN e.id, replace(e.name,e.name,e.name + \"_HelloWorld\"), e.salary, e.deptno \u805a\u5408\u51fd\u6570 count()\u51fd\u6570 max()\u51fd\u6570 min()\u51fd\u6570 sum()\u51fd\u6570 avg()\u51fd\u6570 count()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u6761\u6570. MATCH (e:Employee) RETURN count( * ) max()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5927\u503c. MATCH (e:Employee) RETURN max(e.salary) min()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u7684\u6700\u5c0f\u503c. MATCH (e:Employee) RETURN min(e.salary) sum()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5168\u90e8\u52a0\u548c\u503c. MATCH (e:Employee) RETURN sum(e.salary) avg()\u51fd\u6570: \u8fd4\u56de\u7531match\u547d\u4ee4\u5339\u914d\u6210\u529f\u7684\u8bb0\u5f55\u4e2d\u67d0\u5b57\u6bb5\u7684\u5e73\u5747\u503c. MATCH (e:Employee) RETURN avg(e.salary) \u7d22\u5f15index Neo4j\u652f\u6301\u5728\u8282\u70b9\u6216\u5173\u7cfb\u5c5e\u6027\u4e0a\u7684\u7d22\u5f15, \u4ee5\u63d0\u9ad8\u67e5\u8be2\u7684\u6027\u80fd. \u53ef\u4ee5\u4e3a\u5177\u6709\u76f8\u540c\u6807\u7b7e\u540d\u79f0\u7684\u6240\u6709\u8282\u70b9\u7684\u5c5e\u6027\u521b\u5efa\u7d22\u5f15. \u521b\u5efa\u7d22\u5f15: \u4f7f\u7528create index on\u6765\u521b\u5efa\u7d22\u5f15. CREATE INDEX ON:Employee(id) \u5220\u9664\u7d22\u5f15: \u4f7f\u7528drop index on\u6765\u5220\u9664\u7d22\u5f15. DROP INDEX ON:Employee(id)","title":"3.3 Cypher\u4ecb\u7ecd\u4e0e\u4f7f\u7528"},{"location":"3/#34-pythonneo4j","text":"\u5b66\u4e60\u76ee\u6807 \u4e86\u89e3python\u4e2dneo4j-driver\u7684\u76f8\u5173\u77e5\u8bc6. \u638c\u63e1neo4j\u4e2d\u4e8b\u52a1\u6982\u5ff5\u548c\u64cd\u4f5c\u65b9\u6cd5. neo4j-driver\u7b80\u4ecb: neo4j-driver\u662f\u4e00\u4e2apython\u4e2d\u7684package, \u4f5c\u4e3apython\u4e2dneo4j\u7684\u9a71\u52a8, \u5e2e\u52a9\u6211\u4eec\u5728python\u7a0b\u5e8f\u4e2d\u66f4\u597d\u7684\u4f7f\u7528\u56fe\u6570\u636e\u5e93. neo4j-driver\u7684\u5b89\u88c5: pip install neo4j-driver neo4j-driver\u4f7f\u7528\u6f14\u793a: from neo4j import GraphDatabase # \u5173\u4e8eneo4j\u6570\u636e\u5e93\u7684\u7528\u6237\u540d,\u5bc6\u7801\u4fe1\u606f\u5df2\u7ecf\u914d\u7f6e\u5728\u540c\u76ee\u5f55\u4e0b\u7684config.py\u6587\u4ef6\u4e2d from config import NEO4J_CONFIG driver = GraphDatabase.driver( **NEO4J_CONFIG) # \u76f4\u63a5\u7528python\u4ee3\u7801\u5f62\u5f0f\u8bbf\u95ee\u8282\u70b9Company, \u5e76\u8fd4\u56de\u6240\u6709\u8282\u70b9\u4fe1\u606f with driver.session() as session: cypher = \"CREATE(c:Company) SET c.name='\u9ed1\u9a6c\u7a0b\u5e8f\u5458' RETURN c.name\" record = session.run(cypher) result = list(map(lambda x: x[0], record)) print(\"result:\", result) \u8f93\u51fa\u6548\u679c: result: \u9ed1\u9a6c\u7a0b\u5e8f\u5458 \u4e8b\u52a1\u7684\u6982\u5ff5: \u5982\u679c\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\u8981\u4e48\u5168\u90e8\u53d1\u751f\u8981\u4e48\u4e00\u6b65\u4e5f\u4e0d\u6267\u884c\uff0c\u6211\u4eec\u79f0\u8be5\u7ec4\u5904\u7406\u6b65\u9aa4\u4e3a\u4e00\u4e2a\u4e8b\u52a1, \u5b83\u662f\u6570\u636e\u5e93\u4e00\u81f4\u6027\u7684\u4fdd\u8bc1. \u4f7f\u7528\u4e8b\u52a1\u7684\u6f14\u793a: def _some_operations(tx, cat_name, mouse_name): tx.run(\"MERGE (a:Cat{name: $cat_name})\" \"MERGE (b:Mouse{name: $mouse_name})\" \"MERGE (a)-[r:And]-(b)\", cat_name=cat_name, mouse_name=mouse_name) with driver.session() as session: session.write_transaction(_some_operations, \"Tom\", \"Jerry\") \u8f93\u51fa\u6548\u679c: \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86neo4j-driver\u7b80\u4ecb: neo4j-driver\u662f\u4e00\u4e2apython\u4e2d\u7684package, \u4f5c\u4e3apython\u4e2dneo4j\u7684\u9a71\u52a8, \u5e2e\u52a9\u6211\u4eec\u5728python\u7a0b\u5e8f\u4e2d\u66f4\u597d\u7684\u4f7f\u7528\u56fe\u6570\u636e\u5e93. \u5b66\u4e60\u4e86neo4j-driver\u7684\u5b89\u88c5\u548c\u4f7f\u7528\u65b9\u6cd5. \u5b66\u4e60\u4e86\u4e8b\u52a1\u7684\u6982\u5ff5: \u5982\u679c\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\u8981\u4e48\u5168\u90e8\u53d1\u751f\u8981\u4e48\u4e00\u6b65\u4e5f\u4e0d\u6267\u884c\uff0c\u6211\u4eec\u79f0\u8be5\u7ec4\u5904\u7406\u6b65\u9aa4\u4e3a\u4e00\u4e2a\u4e8b\u52a1, \u5b83\u662f\u6570\u636e\u5e93\u4e00\u81f4\u6027\u7684\u4fdd\u8bc1. \u5b66\u4e60\u4e86\u5982\u4f55\u4f7f\u7528\u4e8b\u52a1\u6765\u5411\u56fe\u6570\u636e\u5e93\u4e2d\u5199\u5165\u6570\u636e.","title":"3.4 \u5728Python\u4e2d\u4f7f\u7528neo4j"},{"location":"4/","text":"4.1 \u79bb\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u79bb\u7ebf\u90e8\u5206\u7684\u6570\u636e\u6d41\u6c34\u7ebf\u4ee5\u53ca\u7ec4\u6210\u90e8\u5206. \u4e86\u89e3\u5404\u4e2a\u7ec4\u6210\u90e8\u5206\u7684\u4f5c\u7528. \u79bb\u7ebf\u90e8\u5206\u67b6\u6784\u56fe: \u79bb\u7ebf\u90e8\u5206\u67b6\u6784\u5c55\u5f00\u56fe: \u79bb\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790: \u6839\u636e\u67b6\u6784\u5c55\u5f00\u56fe\u56fe\uff0c\u79bb\u7ebf\u90e8\u5206\u53ef\u5206\u4e3a\u4e24\u6761\u6570\u636e\u6d41\u6c34\u7ebf\uff0c\u5206\u522b\u7528\u4e8e\u5904\u7406\u7ed3\u6784\u5316\u6570\u636e\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e. \u8fd9\u91cc\u79f0\u5b83\u4eec\u4e3a\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf. \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u7ed3\u6784\u5316\u7684\u6709\u5173\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u5185\u5bb9. \u7ed3\u6784\u5316\u6570\u636e\u7684\u6e05\u6d17: \u5bf9\u6293\u53d6\u7684\u5185\u5bb9\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u975e\u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u975e\u7ed3\u6784\u5316\u7684\u5305\u542b\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u6587\u672c. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6e05\u6d17: \u5bf9\u975e\u7ed3\u6784\u5316\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u4f7f\u7528\u6a21\u578b\u4ece\u975e\u7ed3\u6784\u5316\u6587\u672c\u4e2d\u83b7\u53d6\u547d\u540d\u5b9e\u4f53. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u8bf4\u660e: \u56e0\u4e3a\u672c\u9879\u76ee\u662f\u4ee5AI\u4e3a\u6838\u5fc3\u7684\u9879\u76ee, \u56e0\u4e3a\u7ed3\u6784\u5316\u4e0e\u975e\u7ed3\u6784\u5316\u7684\u6570\u636e\u722c\u866b\u548c\u6e05\u6d17\u90e8\u5206\u7684\u5185\u5bb9\u8fd9\u91cc\u4e0d\u505a\u4ecb\u7ecd, \u4f46\u540c\u5b66\u4eec\u8981\u77e5\u9053\u6211\u4eec\u7684\u6570\u636e\u6765\u6e90. 4.2 \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u6570\u636e\u5185\u5bb9. \u638c\u63e1\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u8fc7\u7a0b. \u638c\u63e1\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5199\u5165\u7684\u8fc7\u7a0b. \u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u6570\u636e\u5185\u5bb9: ... \u8e1d\u90e8\u6025\u6027\u97e7\u5e26\u635f\u4f24.csv \u8e1d\u90e8\u626d\u4f24.csv \u8e1d\u90e8\u9aa8\u6298.csv \u8e44\u94c1\u5f62\u80be.csv \u8e7c\u72b6\u9634\u830e.csv \u8e81\u72c2\u6291\u90c1\u75c7.csv \u8e81\u72c2\u75c7.csv \u8e81\u90c1\u75c7.csv \u8eaf\u4f53\u5f62\u5f0f\u969c\u788d.csv \u8eaf\u4f53\u611f\u67d3\u4f34\u53d1\u7684\u7cbe\u795e\u969c\u788d.csv \u8eaf\u4f53\u611f\u67d3\u6240\u81f4\u7cbe\u795e\u969c\u788d.csv \u8eaf\u4f53\u611f\u89c9\u969c\u788d.csv \u8eaf\u4f53\u75be\u75c5\u4f34\u53d1\u7684\u7cbe\u795e\u969c\u788d.csv \u8f6c\u6362\u6027\u969c\u788d.csv \u8f6c\u79fb\u6027\u5c0f\u80a0\u80bf\u7624.csv \u8f6c\u79fb\u6027\u76ae\u80a4\u9499\u5316\u75c5.csv \u8f6c\u79fb\u6027\u809d\u764c.csv \u8f6c\u79fb\u6027\u80f8\u819c\u80bf\u7624.csv \u8f6c\u79fb\u6027\u9aa8\u80bf\u7624.csv \u8f6e\u72b6\u75c5\u6bd2\u6027\u80a0\u708e.csv \u8f6e\u72b6\u75c5\u6bd2\u6240\u81f4\u80c3\u80a0\u708e.csv \u8f6f\u4ea7\u9053\u5f02\u5e38\u6027\u96be\u4ea7.csv ... \u6bcf\u4e2acsv\u6587\u4ef6\u7684\u540d\u5b57\u90fd\u662f\u4e00\u79cd\u75be\u75c5\u540d. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/structured/noreview/ \u4ee5\u8e81\u72c2\u75c7.csv\u4e3a\u4f8b, \u6709\u5982\u4e0b\u5185\u5bb9: \u8e81\u90c1\u6837 \u8e81\u72c2 \u884c\u4e3a\u53ca\u60c5\u7eea\u5f02\u5e38 \u5fc3\u5883\u9ad8\u6da8 \u60c5\u7eea\u8d77\u4f0f\u5927 \u6280\u672f\u72c2\u8e81\u75c7 \u653b\u51fb\u884c\u4e3a \u6613\u6fc0\u60f9 \u601d\u7ef4\u5954\u9038 \u63a7\u5236\u4e0d\u4f4f\u7684\u8054\u60f3 \u7cbe\u795e\u8fd0\u52a8\u6027\u5174\u594b csv\u6587\u4ef6\u7684\u5185\u5bb9\u662f\u8be5\u75be\u75c5\u5bf9\u5e94\u7684\u75c7\u72b6, \u6bcf\u79cd\u75c7\u72b6\u5360\u4e00\u884c. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/structured/noreview/\u8e81\u72c2\u75c7.csv \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u5de5\u4f5c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528AI\u6a21\u578b\u5b9e\u73b0, \u5305\u62ec\u8bad\u7ec3\u6570\u636e\u96c6, \u6a21\u578b\u8bad\u7ec3\u548c\u4f7f\u7528\u7684\u6574\u4e2a\u8fc7\u7a0b, \u56e0\u6b64\u8fd9\u91cc\u5185\u5bb9\u4ee5\u72ec\u7acb\u4e00\u7ae0\u7684\u5f62\u6210\u5448\u73b0\u7ed9\u5927\u5bb6, \u5177\u4f53\u53c2\u89c1 \u7b2c\u4e94\u7ae0: \u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u4efb\u52a1 . \u5220\u9664\u5ba1\u6838\u540e\u7684\u53ef\u80fd\u5b58\u5728\u7684\u7a7a\u6587\u4ef6: # Linux \u547d\u4ee4-- \u5220\u9664\u5f53\u524d\u6587\u4ef6\u5939\u4e0b\u7684\u7a7a\u6587\u4ef6 find ./ -name \"*\" -type f -size 0c | xargs -n 1 rm -f \u4ee3\u7801\u4f4d\u7f6e: \u5728/data/doctor_offline/structured/reviewed/\u76ee\u5f55\u4e0b\u6267\u884c. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u547d\u540d\u5b9e\u4f53\u5199\u5165\u56fe\u6570\u636e\u5e93\u7684\u539f\u56e0: \u5199\u5165\u7684\u6570\u636e\u4f9b\u5728\u7ebf\u90e8\u5206\u8fdb\u884c\u67e5\u8be2\uff0c\u6839\u636e\u7528\u6237\u8f93\u5165\u75c7\u72b6\u6765\u5339\u914d\u5bf9\u5e94\u75be\u75c5. \u5c06\u547d\u540d\u5b9e\u4f53\u5199\u5165\u56fe\u6570\u636e\u5e93\u4ee3\u7801: # \u5f15\u5165\u76f8\u5173\u5305 import os import fileinput from neo4j import GraphDatabase from config import NEO4J_CONFIG driver = GraphDatabase.driver( **NEO4J_CONFIG) def _load_data(path): \"\"\" description: \u5c06path\u76ee\u5f55\u4e0b\u7684csv\u6587\u4ef6\u4ee5\u6307\u5b9a\u683c\u5f0f\u52a0\u8f7d\u5230\u5185\u5b58 :param path: \u5ba1\u6838\u540e\u7684\u75be\u75c5\u5bf9\u5e94\u75c7\u72b6\u7684csv\u6587\u4ef6 :return: \u8fd4\u56de\u75be\u75c5\u5b57\u5178\uff0c\u5b58\u50a8\u5404\u4e2a\u75be\u75c5\u4ee5\u53ca\u4e0e\u4e4b\u5bf9\u5e94\u7684\u75c7\u72b6\u7684\u5b57\u5178 {\u75be\u75c51: [\u75c7\u72b61, \u75c7\u72b62, ...], \u75be\u75c52: [\u75c7\u72b61, \u75c7\u72b62, ...] \"\"\" # \u83b7\u5f97\u75be\u75c5csv\u5217\u8868 disease_csv_list = os.listdir(path) # \u5c06\u540e\u7f00.csv\u53bb\u6389, \u83b7\u5f97\u75be\u75c5\u5217\u8868 disease_list = list(map(lambda x: x.split(\".\")[0], disease_csv_list)) # \u521d\u59cb\u5316\u4e00\u4e2a\u75c7\u72b6\u5217\u8868, \u5b83\u91cc\u9762\u662f\u6bcf\u79cd\u75be\u75c5\u5bf9\u5e94\u7684\u75c7\u72b6\u5217\u8868 symptom_list = [] # \u904d\u5386\u75be\u75c5csv\u5217\u8868 for disease_csv in disease_csv_list: # \u5c06\u75be\u75c5csv\u4e2d\u7684\u6bcf\u4e2a\u75c7\u72b6\u53d6\u51fa\u5b58\u5165symptom\u5217\u8868\u4e2d symptom = list(map(lambda x: x.strip(), fileinput.FileInput(os.path.join(path, disease_csv)))) # \u8fc7\u6ee4\u6389\u6240\u6709\u957f\u5ea6\u5f02\u5e38\u7684\u75c7\u72b6\u540d symptom = list(filter(lambda x: 0<len(x)<100, symptom)) symptom_list.append(symptom) # \u8fd4\u56de\u6307\u5b9a\u683c\u5f0f\u7684\u6570\u636e return dict(zip(disease_list, symptom_list)) def write(path): \"\"\" description: \u5c06csv\u6570\u636e\u5199\u5165\u5230neo4j, \u5e76\u5f62\u6210\u56fe\u8c31 :param path: \u6570\u636e\u6587\u4ef6\u8def\u5f84 \"\"\" # \u4f7f\u7528_load_data\u4ece\u6301\u4e45\u5316\u6587\u4ef6\u4e2d\u52a0\u8f7d\u6570\u636e disease_symptom_dict = _load_data(path) # \u5f00\u542f\u4e00\u4e2aneo4j\u7684session with driver.session() as session: for key, value in disease_symptom_dict.items(): cypher = \"MERGE (a:Disease{name:%r}) RETURN a\" %key session.run(cypher) for v in value: cypher = \"MERGE (b:Symptom{name:%r}) RETURN b\" %v session.run(cypher) cypher = \"MATCH (a:Disease{name:%r}) MATCH (b:Symptom{name:%r}) \\ WITH a,b MERGE(a)-[r:dis_to_sym]-(b)\" %(key, v) session.run(cypher) cypher = \"CREATE INDEX ON:Disease(name)\" session.run(cypher) cypher = \"CREATE INDEX ON:Symptom(name)\" session.run(cypher) \u8c03\u7528: # \u8f93\u5165\u53c2\u6570path\u4e3acsv\u6570\u636e\u6240\u5728\u8def\u5f84 path = \"/data/doctor_offline/structured/reviewed/\" write(path) \u8f93\u51fa\u6548\u679c: \u901a\u8fc7\u53ef\u89c6\u5316\u7ba1\u7406\u540e\u53f0\u67e5\u770b\u5199\u5165\u6548\u679c. 4.3 \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u6570\u636e\u5185\u5bb9. \u638c\u63e1\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u8fc7\u7a0b. \u638c\u63e1\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u8fc7\u7a0b. \u638c\u63e1\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5199\u5165\u7684\u8fc7\u7a0b. \u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u6570\u636e\u5185\u5bb9: ... \u9ebb\u75b9\u6837\u7ea2\u6591\u578b\u836f\u75b9.txt \u9ebb\u75b9\u75c5\u6bd2\u80ba\u708e.txt \u9ebb\u75f9\u6027\u81c2\u4e1b\u795e\u7ecf\u708e.txt \u9ebb\u98ce\u6027\u5468\u56f4\u795e\u7ecf\u75c5.txt \u9ebb\u98ce\u6027\u8461\u8404\u819c\u708e.txt \u9ec4\u4f53\u56ca\u80bf.txt \u9ec4\u6591\u56ca\u6837\u6c34\u80bf.txt \u9ec4\u6591\u88c2\u5b54\u6027\u89c6\u7f51\u819c\u8131\u79bb.txt \u9ec4\u97e7\u5e26\u9aa8\u5316\u75c7.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2160\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2161\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2165\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2162\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2166\u578b.txt \u9ed1\u8272\u4e18\u75b9\u6027\u76ae\u80a4\u75c5.txt ... \u6bcf\u4e2atxt\u6587\u4ef6\u7684\u540d\u5b57\u90fd\u662f\u4e00\u79cd\u75be\u75c5\u540d. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/unstructured/norecognite/ \u4ee5\u9ed1\u8272\u4e18\u75b9\u6027\u76ae\u80a4\u75c5.txt\u4e3a\u4f8b, \u6709\u5982\u4e0b\u5185\u5bb9: \u521d\u5448\u5fae\u5c0f\u3001\u5706\u5f62\u3001\u76ae\u80a4\u8272\u6216\u9ed1\u8272\u589e\u6df1\u7684\u4e18\u75b9\uff0c\u5355\u4e2a\u6216\u5c11\u6570\u53d1\u751f\u4e8e\u988c\u90e8\u6216\u988a\u90e8\uff0c\u76ae\u635f\u9010\u6e10\u589e\u5927\u589e\u591a\uff0c\u6570\u5e74\u4e2d\u53ef\u8fbe\u6570\u767e\uff0c\u9664\u7736\u5468\u5916\u5c1a\u5206\u5e03\u4e8e\u9762\u90e8\u3001\u9888\u90e8\u548c\u80f8\u4e0a\u90e8\u3002\u76ae\u635f\u5927\u5c0f\u5f62\u72b6\u9177\u4f3c\u8102\u6ea2\u6027\u89d2\u5316\u75c5\u53ca\u6241\u5e73\u75a3\u9d92\u3002\u4e0d\u53d1\u751f\u9cde\u5c51\uff0c\u7ed3\u75c2\u548c\u6e83\u75a1\uff0c\u4ea6\u65e0\u7619\u75d2\u53ca\u5176\u4ed6\u4e3b\u89c2\u75c7\u72b6 txt\u4e2d\u662f\u5bf9\u8be5\u75be\u75c5\u75c7\u72b6\u7684\u6587\u672c\u63cf\u8ff0. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/unstructured/norecognite/\u9ed1\u8272\u4e18\u75b9\u6027\u76ae\u80a4\u75c5.txt \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u5de5\u4f5c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528AI\u6a21\u578b\u5b9e\u73b0, \u5305\u62ec\u6a21\u578b\u8bad\u7ec3\u548c\u4f7f\u7528\u7684\u6574\u4e2a\u8fc7\u7a0b, \u56e0\u6b64\u5185\u5bb9\u4ee5\u72ec\u7acb\u4e00\u7ae0\u7684\u5f62\u6210\u5448\u73b0\u7ed9\u5927\u5bb6, \u5177\u4f53\u5185\u5bb9\u5728 \u7b2c\u516d\u7ae0: \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u4efb\u52a1 . \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u540c4.2 \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u7684\u547d\u540d\u5b9e\u4f53\u5ba1\u6838. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u540c4.2 \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93. \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u79bb\u7ebf\u90e8\u5206\u7684\u6570\u636e\u6d41\u6c34\u7ebf\u4ee5\u53ca\u7ec4\u6210\u90e8\u5206. \u6839\u636e\u67b6\u6784\u5c55\u5f00\u56fe\u56fe\uff0c\u79bb\u7ebf\u90e8\u5206\u53ef\u5206\u4e3a\u4e24\u6761\u6570\u636e\u6d41\u6c34\u7ebf\uff0c\u5206\u522b\u7528\u4e8e\u5904\u7406\u7ed3\u6784\u5316\u6570\u636e\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e. \u8fd9\u91cc\u79f0\u5b83\u4eec\u4e3a\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf. \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u7ed3\u6784\u5316\u7684\u6709\u5173\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u5185\u5bb9. \u7ed3\u6784\u5316\u6570\u636e\u7684\u6e05\u6d17: \u5bf9\u6293\u53d6\u7684\u5185\u5bb9\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u975e\u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u975e\u7ed3\u6784\u5316\u7684\u5305\u542b\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u6587\u672c. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6e05\u6d17: \u5bf9\u975e\u7ed3\u6784\u5316\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u4f7f\u7528\u6a21\u578b\u4ece\u975e\u7ed3\u6784\u5316\u6587\u672c\u4e2d\u83b7\u53d6\u547d\u540d\u5b9e\u4f53. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u5b66\u4e60\u4e86\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u6570\u636e\u5185\u5bb9. \u5b66\u4e60\u4e86\u7ed3\u6784\u5316/\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u8fc7\u7a0b. \u5b66\u4e60\u4e86\u7ed3\u6784\u5316/\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5199\u5165\u7684\u8fc7\u7a0b. \u5b66\u4e60\u4e86\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u6570\u636e\u5185\u5bb9. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u8fc7\u7a0b.","title":"\u7b2c\u56db\u7ae0:\u79bb\u7ebf\u90e8\u5206"},{"location":"4/#41","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u79bb\u7ebf\u90e8\u5206\u7684\u6570\u636e\u6d41\u6c34\u7ebf\u4ee5\u53ca\u7ec4\u6210\u90e8\u5206. \u4e86\u89e3\u5404\u4e2a\u7ec4\u6210\u90e8\u5206\u7684\u4f5c\u7528. \u79bb\u7ebf\u90e8\u5206\u67b6\u6784\u56fe: \u79bb\u7ebf\u90e8\u5206\u67b6\u6784\u5c55\u5f00\u56fe: \u79bb\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790: \u6839\u636e\u67b6\u6784\u5c55\u5f00\u56fe\u56fe\uff0c\u79bb\u7ebf\u90e8\u5206\u53ef\u5206\u4e3a\u4e24\u6761\u6570\u636e\u6d41\u6c34\u7ebf\uff0c\u5206\u522b\u7528\u4e8e\u5904\u7406\u7ed3\u6784\u5316\u6570\u636e\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e. \u8fd9\u91cc\u79f0\u5b83\u4eec\u4e3a\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf. \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u7ed3\u6784\u5316\u7684\u6709\u5173\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u5185\u5bb9. \u7ed3\u6784\u5316\u6570\u636e\u7684\u6e05\u6d17: \u5bf9\u6293\u53d6\u7684\u5185\u5bb9\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u975e\u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u975e\u7ed3\u6784\u5316\u7684\u5305\u542b\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u6587\u672c. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6e05\u6d17: \u5bf9\u975e\u7ed3\u6784\u5316\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u4f7f\u7528\u6a21\u578b\u4ece\u975e\u7ed3\u6784\u5316\u6587\u672c\u4e2d\u83b7\u53d6\u547d\u540d\u5b9e\u4f53. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u8bf4\u660e: \u56e0\u4e3a\u672c\u9879\u76ee\u662f\u4ee5AI\u4e3a\u6838\u5fc3\u7684\u9879\u76ee, \u56e0\u4e3a\u7ed3\u6784\u5316\u4e0e\u975e\u7ed3\u6784\u5316\u7684\u6570\u636e\u722c\u866b\u548c\u6e05\u6d17\u90e8\u5206\u7684\u5185\u5bb9\u8fd9\u91cc\u4e0d\u505a\u4ecb\u7ecd, \u4f46\u540c\u5b66\u4eec\u8981\u77e5\u9053\u6211\u4eec\u7684\u6570\u636e\u6765\u6e90.","title":"4.1 \u79bb\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790"},{"location":"4/#42","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u6570\u636e\u5185\u5bb9. \u638c\u63e1\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u8fc7\u7a0b. \u638c\u63e1\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5199\u5165\u7684\u8fc7\u7a0b. \u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u6570\u636e\u5185\u5bb9: ... \u8e1d\u90e8\u6025\u6027\u97e7\u5e26\u635f\u4f24.csv \u8e1d\u90e8\u626d\u4f24.csv \u8e1d\u90e8\u9aa8\u6298.csv \u8e44\u94c1\u5f62\u80be.csv \u8e7c\u72b6\u9634\u830e.csv \u8e81\u72c2\u6291\u90c1\u75c7.csv \u8e81\u72c2\u75c7.csv \u8e81\u90c1\u75c7.csv \u8eaf\u4f53\u5f62\u5f0f\u969c\u788d.csv \u8eaf\u4f53\u611f\u67d3\u4f34\u53d1\u7684\u7cbe\u795e\u969c\u788d.csv \u8eaf\u4f53\u611f\u67d3\u6240\u81f4\u7cbe\u795e\u969c\u788d.csv \u8eaf\u4f53\u611f\u89c9\u969c\u788d.csv \u8eaf\u4f53\u75be\u75c5\u4f34\u53d1\u7684\u7cbe\u795e\u969c\u788d.csv \u8f6c\u6362\u6027\u969c\u788d.csv \u8f6c\u79fb\u6027\u5c0f\u80a0\u80bf\u7624.csv \u8f6c\u79fb\u6027\u76ae\u80a4\u9499\u5316\u75c5.csv \u8f6c\u79fb\u6027\u809d\u764c.csv \u8f6c\u79fb\u6027\u80f8\u819c\u80bf\u7624.csv \u8f6c\u79fb\u6027\u9aa8\u80bf\u7624.csv \u8f6e\u72b6\u75c5\u6bd2\u6027\u80a0\u708e.csv \u8f6e\u72b6\u75c5\u6bd2\u6240\u81f4\u80c3\u80a0\u708e.csv \u8f6f\u4ea7\u9053\u5f02\u5e38\u6027\u96be\u4ea7.csv ... \u6bcf\u4e2acsv\u6587\u4ef6\u7684\u540d\u5b57\u90fd\u662f\u4e00\u79cd\u75be\u75c5\u540d. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/structured/noreview/ \u4ee5\u8e81\u72c2\u75c7.csv\u4e3a\u4f8b, \u6709\u5982\u4e0b\u5185\u5bb9: \u8e81\u90c1\u6837 \u8e81\u72c2 \u884c\u4e3a\u53ca\u60c5\u7eea\u5f02\u5e38 \u5fc3\u5883\u9ad8\u6da8 \u60c5\u7eea\u8d77\u4f0f\u5927 \u6280\u672f\u72c2\u8e81\u75c7 \u653b\u51fb\u884c\u4e3a \u6613\u6fc0\u60f9 \u601d\u7ef4\u5954\u9038 \u63a7\u5236\u4e0d\u4f4f\u7684\u8054\u60f3 \u7cbe\u795e\u8fd0\u52a8\u6027\u5174\u594b csv\u6587\u4ef6\u7684\u5185\u5bb9\u662f\u8be5\u75be\u75c5\u5bf9\u5e94\u7684\u75c7\u72b6, \u6bcf\u79cd\u75c7\u72b6\u5360\u4e00\u884c. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/structured/noreview/\u8e81\u72c2\u75c7.csv \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u5de5\u4f5c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528AI\u6a21\u578b\u5b9e\u73b0, \u5305\u62ec\u8bad\u7ec3\u6570\u636e\u96c6, \u6a21\u578b\u8bad\u7ec3\u548c\u4f7f\u7528\u7684\u6574\u4e2a\u8fc7\u7a0b, \u56e0\u6b64\u8fd9\u91cc\u5185\u5bb9\u4ee5\u72ec\u7acb\u4e00\u7ae0\u7684\u5f62\u6210\u5448\u73b0\u7ed9\u5927\u5bb6, \u5177\u4f53\u53c2\u89c1 \u7b2c\u4e94\u7ae0: \u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u4efb\u52a1 . \u5220\u9664\u5ba1\u6838\u540e\u7684\u53ef\u80fd\u5b58\u5728\u7684\u7a7a\u6587\u4ef6: # Linux \u547d\u4ee4-- \u5220\u9664\u5f53\u524d\u6587\u4ef6\u5939\u4e0b\u7684\u7a7a\u6587\u4ef6 find ./ -name \"*\" -type f -size 0c | xargs -n 1 rm -f \u4ee3\u7801\u4f4d\u7f6e: \u5728/data/doctor_offline/structured/reviewed/\u76ee\u5f55\u4e0b\u6267\u884c. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u547d\u540d\u5b9e\u4f53\u5199\u5165\u56fe\u6570\u636e\u5e93\u7684\u539f\u56e0: \u5199\u5165\u7684\u6570\u636e\u4f9b\u5728\u7ebf\u90e8\u5206\u8fdb\u884c\u67e5\u8be2\uff0c\u6839\u636e\u7528\u6237\u8f93\u5165\u75c7\u72b6\u6765\u5339\u914d\u5bf9\u5e94\u75be\u75c5. \u5c06\u547d\u540d\u5b9e\u4f53\u5199\u5165\u56fe\u6570\u636e\u5e93\u4ee3\u7801: # \u5f15\u5165\u76f8\u5173\u5305 import os import fileinput from neo4j import GraphDatabase from config import NEO4J_CONFIG driver = GraphDatabase.driver( **NEO4J_CONFIG) def _load_data(path): \"\"\" description: \u5c06path\u76ee\u5f55\u4e0b\u7684csv\u6587\u4ef6\u4ee5\u6307\u5b9a\u683c\u5f0f\u52a0\u8f7d\u5230\u5185\u5b58 :param path: \u5ba1\u6838\u540e\u7684\u75be\u75c5\u5bf9\u5e94\u75c7\u72b6\u7684csv\u6587\u4ef6 :return: \u8fd4\u56de\u75be\u75c5\u5b57\u5178\uff0c\u5b58\u50a8\u5404\u4e2a\u75be\u75c5\u4ee5\u53ca\u4e0e\u4e4b\u5bf9\u5e94\u7684\u75c7\u72b6\u7684\u5b57\u5178 {\u75be\u75c51: [\u75c7\u72b61, \u75c7\u72b62, ...], \u75be\u75c52: [\u75c7\u72b61, \u75c7\u72b62, ...] \"\"\" # \u83b7\u5f97\u75be\u75c5csv\u5217\u8868 disease_csv_list = os.listdir(path) # \u5c06\u540e\u7f00.csv\u53bb\u6389, \u83b7\u5f97\u75be\u75c5\u5217\u8868 disease_list = list(map(lambda x: x.split(\".\")[0], disease_csv_list)) # \u521d\u59cb\u5316\u4e00\u4e2a\u75c7\u72b6\u5217\u8868, \u5b83\u91cc\u9762\u662f\u6bcf\u79cd\u75be\u75c5\u5bf9\u5e94\u7684\u75c7\u72b6\u5217\u8868 symptom_list = [] # \u904d\u5386\u75be\u75c5csv\u5217\u8868 for disease_csv in disease_csv_list: # \u5c06\u75be\u75c5csv\u4e2d\u7684\u6bcf\u4e2a\u75c7\u72b6\u53d6\u51fa\u5b58\u5165symptom\u5217\u8868\u4e2d symptom = list(map(lambda x: x.strip(), fileinput.FileInput(os.path.join(path, disease_csv)))) # \u8fc7\u6ee4\u6389\u6240\u6709\u957f\u5ea6\u5f02\u5e38\u7684\u75c7\u72b6\u540d symptom = list(filter(lambda x: 0<len(x)<100, symptom)) symptom_list.append(symptom) # \u8fd4\u56de\u6307\u5b9a\u683c\u5f0f\u7684\u6570\u636e return dict(zip(disease_list, symptom_list)) def write(path): \"\"\" description: \u5c06csv\u6570\u636e\u5199\u5165\u5230neo4j, \u5e76\u5f62\u6210\u56fe\u8c31 :param path: \u6570\u636e\u6587\u4ef6\u8def\u5f84 \"\"\" # \u4f7f\u7528_load_data\u4ece\u6301\u4e45\u5316\u6587\u4ef6\u4e2d\u52a0\u8f7d\u6570\u636e disease_symptom_dict = _load_data(path) # \u5f00\u542f\u4e00\u4e2aneo4j\u7684session with driver.session() as session: for key, value in disease_symptom_dict.items(): cypher = \"MERGE (a:Disease{name:%r}) RETURN a\" %key session.run(cypher) for v in value: cypher = \"MERGE (b:Symptom{name:%r}) RETURN b\" %v session.run(cypher) cypher = \"MATCH (a:Disease{name:%r}) MATCH (b:Symptom{name:%r}) \\ WITH a,b MERGE(a)-[r:dis_to_sym]-(b)\" %(key, v) session.run(cypher) cypher = \"CREATE INDEX ON:Disease(name)\" session.run(cypher) cypher = \"CREATE INDEX ON:Symptom(name)\" session.run(cypher) \u8c03\u7528: # \u8f93\u5165\u53c2\u6570path\u4e3acsv\u6570\u636e\u6240\u5728\u8def\u5f84 path = \"/data/doctor_offline/structured/reviewed/\" write(path) \u8f93\u51fa\u6548\u679c: \u901a\u8fc7\u53ef\u89c6\u5316\u7ba1\u7406\u540e\u53f0\u67e5\u770b\u5199\u5165\u6548\u679c.","title":"4.2 \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf"},{"location":"4/#43","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u6570\u636e\u5185\u5bb9. \u638c\u63e1\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u8fc7\u7a0b. \u638c\u63e1\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u8fc7\u7a0b. \u638c\u63e1\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5199\u5165\u7684\u8fc7\u7a0b. \u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u6570\u636e\u5185\u5bb9: ... \u9ebb\u75b9\u6837\u7ea2\u6591\u578b\u836f\u75b9.txt \u9ebb\u75b9\u75c5\u6bd2\u80ba\u708e.txt \u9ebb\u75f9\u6027\u81c2\u4e1b\u795e\u7ecf\u708e.txt \u9ebb\u98ce\u6027\u5468\u56f4\u795e\u7ecf\u75c5.txt \u9ebb\u98ce\u6027\u8461\u8404\u819c\u708e.txt \u9ec4\u4f53\u56ca\u80bf.txt \u9ec4\u6591\u56ca\u6837\u6c34\u80bf.txt \u9ec4\u6591\u88c2\u5b54\u6027\u89c6\u7f51\u819c\u8131\u79bb.txt \u9ec4\u97e7\u5e26\u9aa8\u5316\u75c7.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2160\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2161\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2165\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2162\u578b.txt \u9ecf\u591a\u7cd6\u8d2e\u79ef\u75c7\u2166\u578b.txt \u9ed1\u8272\u4e18\u75b9\u6027\u76ae\u80a4\u75c5.txt ... \u6bcf\u4e2atxt\u6587\u4ef6\u7684\u540d\u5b57\u90fd\u662f\u4e00\u79cd\u75be\u75c5\u540d. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/unstructured/norecognite/ \u4ee5\u9ed1\u8272\u4e18\u75b9\u6027\u76ae\u80a4\u75c5.txt\u4e3a\u4f8b, \u6709\u5982\u4e0b\u5185\u5bb9: \u521d\u5448\u5fae\u5c0f\u3001\u5706\u5f62\u3001\u76ae\u80a4\u8272\u6216\u9ed1\u8272\u589e\u6df1\u7684\u4e18\u75b9\uff0c\u5355\u4e2a\u6216\u5c11\u6570\u53d1\u751f\u4e8e\u988c\u90e8\u6216\u988a\u90e8\uff0c\u76ae\u635f\u9010\u6e10\u589e\u5927\u589e\u591a\uff0c\u6570\u5e74\u4e2d\u53ef\u8fbe\u6570\u767e\uff0c\u9664\u7736\u5468\u5916\u5c1a\u5206\u5e03\u4e8e\u9762\u90e8\u3001\u9888\u90e8\u548c\u80f8\u4e0a\u90e8\u3002\u76ae\u635f\u5927\u5c0f\u5f62\u72b6\u9177\u4f3c\u8102\u6ea2\u6027\u89d2\u5316\u75c5\u53ca\u6241\u5e73\u75a3\u9d92\u3002\u4e0d\u53d1\u751f\u9cde\u5c51\uff0c\u7ed3\u75c2\u548c\u6e83\u75a1\uff0c\u4ea6\u65e0\u7619\u75d2\u53ca\u5176\u4ed6\u4e3b\u89c2\u75c7\u72b6 txt\u4e2d\u662f\u5bf9\u8be5\u75be\u75c5\u75c7\u72b6\u7684\u6587\u672c\u63cf\u8ff0. \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_offline/unstructured/norecognite/\u9ed1\u8272\u4e18\u75b9\u6027\u76ae\u80a4\u75c5.txt \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u5de5\u4f5c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528AI\u6a21\u578b\u5b9e\u73b0, \u5305\u62ec\u6a21\u578b\u8bad\u7ec3\u548c\u4f7f\u7528\u7684\u6574\u4e2a\u8fc7\u7a0b, \u56e0\u6b64\u5185\u5bb9\u4ee5\u72ec\u7acb\u4e00\u7ae0\u7684\u5f62\u6210\u5448\u73b0\u7ed9\u5927\u5bb6, \u5177\u4f53\u5185\u5bb9\u5728 \u7b2c\u516d\u7ae0: \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u4efb\u52a1 . \u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u540c4.2 \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u7684\u547d\u540d\u5b9e\u4f53\u5ba1\u6838. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u540c4.2 \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93. \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u79bb\u7ebf\u90e8\u5206\u7684\u6570\u636e\u6d41\u6c34\u7ebf\u4ee5\u53ca\u7ec4\u6210\u90e8\u5206. \u6839\u636e\u67b6\u6784\u5c55\u5f00\u56fe\u56fe\uff0c\u79bb\u7ebf\u90e8\u5206\u53ef\u5206\u4e3a\u4e24\u6761\u6570\u636e\u6d41\u6c34\u7ebf\uff0c\u5206\u522b\u7528\u4e8e\u5904\u7406\u7ed3\u6784\u5316\u6570\u636e\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e. \u8fd9\u91cc\u79f0\u5b83\u4eec\u4e3a\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u548c\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf. \u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u7ed3\u6784\u5316\u7684\u6709\u5173\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u5185\u5bb9. \u7ed3\u6784\u5316\u6570\u636e\u7684\u6e05\u6d17: \u5bf9\u6293\u53d6\u7684\u5185\u5bb9\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u7684\u7ec4\u6210\u90e8\u5206: \u975e\u7ed3\u6784\u5316\u6570\u636e\u722c\u866b: \u4ece\u7f51\u9875\u4e0a\u6293\u53d6\u975e\u7ed3\u6784\u5316\u7684\u5305\u542b\u533b\u5b66\u547d\u540d\u5b9e\u4f53\u7684\u6587\u672c. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6e05\u6d17: \u5bf9\u975e\u7ed3\u6784\u5316\u6570\u636e\u8fdb\u884c\u8fc7\u6ee4\u548c\u6e05\u6d17, \u4ee5\u4fdd\u7559\u9700\u8981\u7684\u90e8\u5206. \u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u4f7f\u7528\u6a21\u578b\u4ece\u975e\u7ed3\u6784\u5316\u6587\u672c\u4e2d\u83b7\u53d6\u547d\u540d\u5b9e\u4f53. \u547d\u540d\u5b9e\u4f53\u5ba1\u6838: \u5bf9\u5f53\u524d\u547d\u540d\u5b9e\u4f53\u8fdb\u884c\u5ba1\u6838, \u6765\u4fdd\u8bc1\u8fd9\u4e9b\u5b9e\u4f53\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42. \u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93: \u5c06\u5ba1\u6838\u540e\u7684\u547d\u540d\u5b9e\u4f53\u5199\u5165\u6570\u636e\u5e93\u4e4b\u4e2d, \u4f9b\u5728\u7ebf\u90e8\u5206\u4f7f\u7528. \u5b66\u4e60\u4e86\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u6570\u636e\u5185\u5bb9. \u5b66\u4e60\u4e86\u7ed3\u6784\u5316/\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u7684\u8fc7\u7a0b. \u5b66\u4e60\u4e86\u7ed3\u6784\u5316/\u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u5199\u5165\u7684\u8fc7\u7a0b. \u5b66\u4e60\u4e86\u9700\u8981\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u6570\u636e\u5185\u5bb9. \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf\u4e2d\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u8fc7\u7a0b.","title":"4.3 \u975e\u7ed3\u6784\u5316\u6570\u636e\u6d41\u6c34\u7ebf"},{"location":"5/","text":"5.1 \u4efb\u52a1\u4ecb\u7ecd\u4e0e\u6a21\u578b\u9009\u7528 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u4efb\u52a1\u7684\u76f8\u5173\u77e5\u8bc6. \u4e86\u89e3\u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0. NE\u5ba1\u6838\u4efb\u52a1: \u4e00\u822c\u5728\u5b9e\u4f53\u8fdb\u5165\u6570\u636e\u5e93\u5b58\u50a8\u524d, \u4e2d\u95f4\u90fd\u4f1a\u6709\u4e00\u9053\u5fc5\u4e0d\u53ef\u5c11\u7684\u5de5\u5e8f, \u5c31\u662f\u5bf9\u8bc6\u522b\u51fa\u6765\u7684\u5b9e\u4f53\u8fdb\u884c\u5408\u6cd5\u6027\u7684\u68c0\u9a8c, \u5373\u547d\u540d\u5b9e\u4f53(NE)\u5ba1\u6838\u4efb\u52a1. \u5b83\u7684\u68c0\u9a8c\u8fc7\u7a0b\u4e0d\u4f7f\u7528\u4e0a\u4e0b\u6587\u4fe1\u606f, \u66f4\u5173\u6ce8\u4e8e\u5b57\u7b26\u672c\u8eab\u7684\u7ec4\u5408\u65b9\u5f0f\u6765\u8fdb\u884c\u5224\u65ad, \u672c\u8d28\u4e0a\uff0c\u5b83\u662f\u4e00\u9879\u77ed\u6587\u672c\u4e8c\u5206\u7c7b\u95ee\u9898. \u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0: \u9488\u5bf9\u77ed\u6587\u672c\u4efb\u52a1, \u65e0\u987b\u6355\u6349\u957f\u8ddd\u79bb\u7684\u5173\u7cfb, \u56e0\u6b64\u6211\u4eec\u4f7f\u7528\u4e86\u4f20\u7edf\u7684RNN\u6a21\u578b\u6765\u89e3\u51b3, \u6027\u80fd\u548c\u6548\u679c\u53ef\u4ee5\u8fbe\u5230\u5f88\u597d\u7684\u5747\u8861. \u77ed\u6587\u672c\u4efb\u52a1\u5f80\u5f80\u9002\u5408\u4f7f\u7528\u5b57\u5d4c\u5165\u7684\u65b9\u5f0f, \u4f46\u662f\u5982\u679c\u4f60\u7684\u8bad\u7ec3\u96c6\u4e0d\u662f\u5f88\u5927,\u6d89\u53ca\u7684\u5b57\u6570\u6709\u9650, \u90a3\u4e48\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u5b57\u5411\u91cf\u8fdb\u884c\u8868\u793a\u5373\u53ef. \u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86bert-chinese\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u83b7\u5f97\u4e2d\u6587\u6c49\u5b57\u7684\u5411\u91cf\u8868\u793a. 5.2 \u8bad\u7ec3\u6570\u636e\u96c6 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u53ca\u5176\u76f8\u5173\u89e3\u91ca. \u638c\u63e1\u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684\u8fc7\u7a0b. \u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f: 1 \u624b\u5185\u808c\u840e\u7f29 0 \u7f29\u840e\u808c\u5185\u624b 1 \u5c3f\u9ed1\u9178 0 \u9178\u9ed1\u5c3f 1 \u5355\u773c\u773c\u524d\u9ed1\u5f71 0 \u5f71\u9ed1\u524d\u773c\u773c\u5355 1 \u5fe7\u90c1 0 \u90c1\u5fe7 1 \u7ea2\u7ec6\u80de\u5bff\u547d\u7f29\u77ed 0 \u77ed\u7f29\u547d\u5bff\u80de\u7ec6\u7ea2 1 \u76ae\u80a4\u9ecf\u86cb\u767d\u6c89\u79ef 0 \u79ef\u6c89\u767d\u86cb\u9ecf\u80a4\u76ae 1 \u773c\u795e\u5f02\u5e38 0 \u5e38\u5f02\u795e\u773c 1 \u9634\u56ca\u5760\u80c0\u75db 0 \u75db\u80c0\u5760\u56ca\u9634 1 \u52a8\u8109\u8840\u6c27\u9971\u548c\u5ea6\u964d\u4f4e 0 \u4f4e\u964d\u5ea6\u548c\u9971\u6c27\u8840\u8109\u52a8 \u6570\u636e\u96c6\u7684\u76f8\u5173\u89e3\u91ca: \u8fd9\u4e9b\u8bad\u7ec3\u96c6\u4e2d\u7684\u6b63\u6837\u672c\u5f80\u5f80\u662f\u57fa\u4e8e\u4eba\u5de5\u5ba1\u6838\u7684\u6807\u51c6\u547d\u540d\u5b9e\u4f53. \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e00\u5217\u4ee3\u8868\u6807\u7b7e, 1\u4e3a\u6b63\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u6587\u5b57\u662f\u547d\u540d\u5b9e\u4f53. 0\u4e3a\u8d1f\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u6587\u5b57\u4e0d\u662f\u547d\u540d\u5b9e\u4f53. \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e8c\u5217\u4e2d\u7684\u547d\u540d\u5b9e\u4f53\u6765\u6e90\u4e8e\u6570\u636e\u5e93\u4e2d\u7684\u75c7\u72b6\u5b9e\u4f53\u540d\u5b57, \u5b83\u662f\u7ed3\u6784\u5316\u722c\u866b\u6293\u53d6\u7684\u6570\u636e. \u800c\u975e\u547d\u540d\u5b9e\u4f53\u5219\u662f\u5b83\u7684\u5b57\u7b26\u4e32\u53cd\u8f6c. \u6b63\u8d1f\u6837\u672c\u7684\u6bd4\u4f8b\u662f1:1. \u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58: import pandas as pd from collections import Counter # \u8bfb\u53d6\u6570\u636e train_data_path = \"./train_data.csv\" train_data= pd.read_csv(train_data_path, header=None, sep=\"\\t\") # \u6253\u5370\u6b63\u8d1f\u6807\u7b7e\u6bd4\u4f8b print(dict(Counter(train_data[0].values))) # \u8f6c\u6362\u6570\u636e\u5230\u5217\u8868\u5f62\u5f0f train_data = train_data.values.tolist() print(train_data[:10]) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u51fa\u6548\u679c: # \u6b63\u8d1f\u6807\u7b7e\u6bd4\u4f8b {1: 5740, 0: 5740} # \u53d6\u51fa10\u6761\u8bad\u7ec3\u6570\u636e\u67e5\u770b [[1, '\u6795\u90e8\u75bc\u75db'], [0, '\u75db\u75bc\u90e8\u6795'], [1, '\u9676\u745f\u5f81\u9633\u6027'], [0, '\u6027\u9633\u5f81\u745f\u9676'], [1, '\u604b\u517d\u578b\u6027\u53d8\u6001'], [0, '\u6001\u53d8\u6027\u578b\u517d\u604b'], [1, '\u8fdb\u98df\u56f0\u96be'], [0, '\u96be\u56f0\u98df\u8fdb'], [1, '\u4f1a\u9634\u7618\u7ba1\u6216\u7aa6\u9053\u5f62\u6210'], [0, '\u6210\u5f62\u9053\u7aa6\u6216\u7ba1\u7618\u9634\u4f1a']] \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u53ca\u5176\u76f8\u5173\u89e3\u91ca. \u5b66\u4e60\u4e86\u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684\u8fc7\u7a0b. 5.3 BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6\u548c\u4f5c\u7528. \u638c\u63e1\u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u8fc7\u7a0b. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b: BERT\u6a21\u578b\u6574\u4f53\u67b6\u6784\u57fa\u4e8eTransformer\u6a21\u578b\u67b6\u6784, BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u89e3\u7801\u5668\u548c\u7f16\u7801\u5668\u5177\u670912\u5c42, \u8f93\u51fa\u5c42\u4e2d\u7684\u7ebf\u6027\u5c42\u5177\u6709768\u4e2a\u8282\u70b9, \u5373\u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u7ef4\u5ea6\u662f768. \u5b83\u4f7f\u7528\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7ed3\u6784\u4e2d, \u5934\u7684\u6570\u91cf\u4e3a12, \u6a21\u578b\u603b\u53c2\u6570\u91cf\u4e3a110M. \u540c\u65f6, \u5b83\u5728\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4e0a\u8fdb\u884c\u8bad\u7ec3, \u56e0\u6b64\u9002\u5408\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4efb\u52a1. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u4f5c\u7528: \u5728\u5b9e\u9645\u7684\u6587\u672c\u4efb\u52a1\u5904\u7406\u4e2d, \u6709\u4e9b\u8bad\u7ec3\u8bed\u6599\u5f88\u96be\u83b7\u5f97, \u4ed6\u4eec\u7684\u603b\u4f53\u6570\u91cf\u548c\u5305\u542b\u7684\u8bcd\u6c47\u603b\u6570\u90fd\u975e\u5e38\u5c11, \u4e0d\u9002\u5408\u7528\u4e8e\u8bad\u7ec3\u5e26\u6709Embedding\u5c42\u7684\u6a21\u578b, \u4f46\u8fd9\u4e9b\u6570\u636e\u4e2d\u5374\u53c8\u8574\u542b\u8fd9\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u89c4\u5f8b\u53ef\u4ee5\u88ab\u6a21\u578b\u6316\u6398, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b,\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9, \u56e0\u4e3a\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u81ea\u5927\u578b\u8bed\u6599, \u80fd\u591f\u4f7f\u5f97\u5f53\u524d\u6587\u672c\u5177\u6709\u610f\u4e49, \u867d\u7136\u8fd9\u4e9b\u610f\u4e49\u53ef\u80fd\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e2a\u7279\u5b9a\u9886\u57df, \u4f46\u662f\u8fd9\u79cd\u7f3a\u9677\u53ef\u4ee5\u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u6765\u8fdb\u884c\u5f25\u8865. \u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801: import torch import torch.nn as nn # \u901a\u8fc7torch.hub(pytorch\u4e2d\u4e13\u6ce8\u4e8e\u8fc1\u79fb\u5b66\u7684\u5de5\u5177)\u83b7\u5f97\u5df2\u7ecf\u8bad\u7ec3\u597d\u7684bert-base-chinese\u6a21\u578b model = torch.hub.load('huggingface/pytorch-transformers', 'model', 'bert-base-chinese') # \u83b7\u5f97\u5bf9\u5e94\u7684\u5b57\u7b26\u6620\u5c04\u5668, \u5b83\u5c06\u628a\u4e2d\u6587\u7684\u6bcf\u4e2a\u5b57\u6620\u5c04\u6210\u4e00\u4e2a\u6570\u5b57 tokenizer = torch.hub.load('huggingface/pytorch-transformers', 'tokenizer', 'bert-base-chinese') def get_bert_encode_for_single(text): \"\"\" description: \u4f7f\u7528bert-chinese\u7f16\u7801\u4e2d\u6587\u6587\u672c :param text: \u8981\u8fdb\u884c\u7f16\u7801\u7684\u6587\u672c :return: \u4f7f\u7528bert\u7f16\u7801\u540e\u7684\u6587\u672c\u5f20\u91cf\u8868\u793a \"\"\" # \u9996\u5148\u4f7f\u7528\u5b57\u7b26\u6620\u5c04\u5668\u5bf9\u6bcf\u4e2a\u6c49\u5b57\u8fdb\u884c\u6620\u5c04 # \u8fd9\u91cc\u9700\u8981\u6ce8\u610f, bert\u7684tokenizer\u6620\u5c04\u540e\u4f1a\u4e3a\u7ed3\u679c\u524d\u540e\u6dfb\u52a0\u5f00\u59cb\u548c\u7ed3\u675f\u6807\u8bb0\u5373101\u548c102 # \u8fd9\u5bf9\u4e8e\u591a\u6bb5\u6587\u672c\u7684\u7f16\u7801\u662f\u6709\u610f\u4e49\u7684, \u4f46\u5728\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u610f\u4e49, \u56e0\u6b64\u4f7f\u7528[1:-1]\u5bf9\u5934\u548c\u5c3e\u8fdb\u884c\u5207\u7247 indexed_tokens = tokenizer.encode(text)[1:-1] # \u4e4b\u540e\u5c06\u5217\u8868\u7ed3\u6784\u8f6c\u5316\u4e3atensor tokens_tensor = torch.tensor([indexed_tokens]) print(tokens_tensor) # \u4f7f\u6a21\u578b\u4e0d\u81ea\u52a8\u8ba1\u7b97\u68af\u5ea6 with torch.no_grad(): # \u8c03\u7528\u6a21\u578b\u83b7\u5f97\u9690\u5c42\u8f93\u51fa encoded_layers, _ = model(tokens_tensor) # \u8f93\u51fa\u7684\u9690\u5c42\u662f\u4e00\u4e2a\u4e09\u7ef4\u5f20\u91cf, \u6700\u5916\u5c42\u4e00\u7ef4\u662f1, \u6211\u4eec\u4f7f\u7528[0]\u964d\u53bb\u5b83. print(encoded_layers.shape) encoded_layers = encoded_layers[0] return encoded_layers \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/bert_chinese_encode.py \u8f93\u5165\u53c2\u6570: text = \"\u4f60\u597d, \u5468\u6770\u4f26\" \u8c03\u7528: outputs = get_bert_encode_for_single(text) print(outputs) print(outputs.shape) \u8f93\u51fa\u6548\u679c: tensor([[ 3.2731e-01, -1.4832e-01, -9.1618e-01, ..., -4.4088e-01, -4.1074e-01, -7.5570e-01], [-1.1287e-01, -7.6269e-01, -6.4861e-01, ..., -8.0478e-01, -5.3600e-01, -3.1953e-01], [-9.3012e-02, -4.4381e-01, -1.1985e+00, ..., -3.6624e-01, -4.7467e-01, -2.6408e-01], [-1.6896e-02, -4.3753e-01, -3.6060e-01, ..., -3.2451e-01, -3.4204e-02, -1.7930e-01], [-1.3159e-01, -3.0048e-01, -2.4193e-01, ..., -4.5756e-02, -2.0958e-01, -1.0649e-01], [-4.0006e-01, -3.4410e-01, -3.8532e-05, ..., 1.9081e-01, 1.7006e-01, -3.6221e-01]]) torch.Size([6, 768]) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6: BERT\u6a21\u578b\u6574\u4f53\u67b6\u6784\u57fa\u4e8eTransformer\u6a21\u578b\u67b6\u6784, BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u89e3\u7801\u5668\u548c\u7f16\u7801\u5668\u5177\u670912\u5c42, \u8f93\u51fa\u5c42\u4e2d\u7684\u7ebf\u6027\u5c42\u5177\u6709768\u4e2a\u8282\u70b9, \u5373\u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u7ef4\u5ea6\u662f768. \u5b83\u4f7f\u7528\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7ed3\u6784\u4e2d, \u5934\u7684\u6570\u91cf\u4e3a12, \u6a21\u578b\u603b\u53c2\u6570\u91cf\u4e3a110M. \u540c\u65f6, \u5b83\u5728\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4e0a\u8fdb\u884c\u8bad\u7ec3, \u56e0\u6b64\u9002\u5408\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4efb\u52a1. \u5b66\u4e60\u4e86BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u4f5c\u7528: \u5728\u5b9e\u9645\u7684\u6587\u672c\u4efb\u52a1\u5904\u7406\u4e2d, \u6709\u4e9b\u8bad\u7ec3\u8bed\u6599\u5f88\u96be\u83b7\u5f97, \u4ed6\u4eec\u7684\u603b\u4f53\u6570\u91cf\u548c\u5305\u542b\u7684\u8bcd\u6c47\u603b\u6570\u90fd\u975e\u5e38\u5c11, \u4e0d\u9002\u5408\u7528\u4e8e\u8bad\u7ec3\u5e26\u6709Embedding\u5c42\u7684\u6a21\u578b, \u4f46\u8fd9\u4e9b\u6570\u636e\u4e2d\u5374\u53c8\u8574\u542b\u8fd9\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u89c4\u5f8b\u53ef\u4ee5\u88ab\u6a21\u578b\u6316\u6398, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b, \u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9, \u56e0\u4e3a\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u81ea\u5927\u578b\u8bed\u6599, \u80fd\u591f\u4f7f\u5f97\u5f53\u524d\u6587\u672c\u5177\u6709\u610f\u4e49, \u867d\u7136\u8fd9\u4e9b\u610f\u4e49\u53ef\u80fd\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e2a\u7279\u5b9a\u9886\u57df, \u4f46\u662f\u8fd9\u79cd\u7f3a\u9677\u53ef\u4ee5\u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u6765\u8fdb\u884c\u5f25\u8865. \u5b66\u4e60\u4e86\u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u51fd\u6570: get_bert_encode_for_single(text) 5.4 \u6784\u5efaRNN\u6a21\u578b \u5b66\u4e60\u76ee\u6807: \u5b66\u4e60RNN\u6a21\u578b\u7684\u5185\u90e8\u7ed3\u6784\u53ca\u8ba1\u7b97\u516c\u5f0f. \u638c\u63e1RNN\u6a21\u578b\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u4f20\u7edfRNN\u7684\u5185\u90e8\u7ed3\u6784\u56fe: \u7ed3\u6784\u89e3\u91ca\u56fe: \u5185\u90e8\u7ed3\u6784\u5206\u6790: * \u6211\u4eec\u628a\u76ee\u5149\u96c6\u4e2d\u5728\u4e2d\u95f4\u7684\u65b9\u5757\u90e8\u5206, \u5b83\u7684\u8f93\u5165\u6709\u4e24\u90e8\u5206, \u5206\u522b\u662fh(t-1)\u4ee5\u53cax(t), \u4ee3\u8868\u4e0a\u4e00\u65f6\u95f4\u6b65\u7684\u9690\u5c42\u8f93\u51fa, \u4ee5\u53ca\u6b64\u65f6\u95f4\u6b65\u7684\u8f93\u5165, \u5b83\u4eec\u8fdb\u5165RNN\u7ed3\u6784\u4f53\u540e, \u4f1a\"\u878d\u5408\"\u5230\u4e00\u8d77, \u8fd9\u79cd\u878d\u5408\u6211\u4eec\u6839\u636e\u7ed3\u6784\u89e3\u91ca\u53ef\u77e5, \u662f\u5c06\u4e8c\u8005\u8fdb\u884c\u62fc\u63a5, \u5f62\u6210\u65b0\u7684\u5f20\u91cf[x(t), h(t-1)], \u4e4b\u540e\u8fd9\u4e2a\u65b0\u7684\u5f20\u91cf\u5c06\u901a\u8fc7\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42(\u7ebf\u6027\u5c42), \u8be5\u5c42>\u4f7f\u7528tanh\u4f5c\u4e3a\u6fc0\u6d3b\u51fd\u6570, \u6700\u7ec8\u5f97\u5230\u8be5\u65f6\u95f4\u6b65\u7684\u8f93\u51fah(t), \u5b83\u5c06\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u65f6\u95f4\u6b65\u7684>\u8f93\u5165\u548cx(t+1)\u4e00\u8d77\u8fdb\u5165\u7ed3\u6784\u4f53. \u4ee5\u6b64\u7c7b\u63a8. \u5185\u90e8\u7ed3\u6784\u8fc7\u7a0b\u6f14\u793a: \u6839\u636e\u7ed3\u6784\u5206\u6790\u5f97\u51fa\u5185\u90e8\u8ba1\u7b97\u516c\u5f0f: \u6fc0\u6d3b\u51fd\u6570tanh\u7684\u4f5c\u7528: * \u7528\u4e8e\u5e2e\u52a9\u8c03\u8282\u6d41\u7ecf\u7f51\u7edc\u7684\u503c, tanh\u51fd\u6570\u5c06\u503c\u538b\u7f29\u5728-1\u548c1\u4e4b\u95f4. \u6784\u5efaRNN\u6a21\u578b\u7684\u4ee3\u7801\u5206\u6790: class RNN(nn.Module): def __init__(self, input_size, hidden_size, output_size): \"\"\"\u521d\u59cb\u5316\u51fd\u6570\u4e2d\u6709\u4e09\u4e2a\u53c2\u6570,\u5206\u522b\u662f\u8f93\u5165\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u5c3a\u5bf8\u5927\u5c0f, \u9690\u5c42\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u5c3a\u5bf8\u5927\u5c0f, \u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u5c3a\u5bf8\u5927\u5c0f\"\"\" super(RNN, self).__init__() # \u4f20\u5165\u9690\u542b\u5c42\u5c3a\u5bf8\u5927\u5c0f self.hidden_size = hidden_size # \u6784\u5efa\u4ece\u8f93\u5165\u5230\u9690\u542b\u5c42\u7684\u7ebf\u6027\u53d8\u5316, \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u5165\u5c3a\u5bf8\u662finput_size + hidden_size # \u8fd9\u662f\u56e0\u4e3a\u5728\u5faa\u73af\u7f51\u7edc\u4e2d, \u6bcf\u6b21\u8f93\u5165\u90fd\u6709\u4e24\u90e8\u5206\u7ec4\u6210\uff0c\u5206\u522b\u662f\u6b64\u65f6\u523b\u7684\u8f93\u5165\u548c\u4e0a\u4e00\u65f6\u523b\u4ea7\u751f\u7684\u8f93\u51fa. # \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u51fa\u5c3a\u5bf8\u662fhidden_size self.i2h = nn.Linear(input_size + hidden_size, hidden_size) # \u6784\u5efa\u4ece\u8f93\u5165\u5230\u8f93\u51fa\u5c42\u7684\u7ebf\u6027\u53d8\u5316, \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u5165\u5c3a\u5bf8\u8fd8\u662finput_size + hidden_size # \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u51fa\u5c3a\u5bf8\u662foutput_size. self.i2o = nn.Linear(input_size + hidden_size, output_size) # \u6700\u540e\u9700\u8981\u5bf9\u8f93\u51fa\u505asoftmax\u5904\u7406, \u83b7\u5f97\u7ed3\u679c. self.softmax = nn.LogSoftmax(dim=-1) def forward(self, input, hidden): \"\"\"\u5728forward\u51fd\u6570\u4e2d, \u53c2\u6570\u5206\u522b\u662f\u89c4\u5b9a\u5c3a\u5bf8\u7684\u8f93\u5165\u5f20\u91cf, \u4ee5\u53ca\u89c4\u5b9a\u5c3a\u5bf8\u7684\u521d\u59cb\u5316\u9690\u5c42\u5f20\u91cf\"\"\" # \u9996\u5148\u4f7f\u7528torch.cat\u5c06input\u4e0ehidden\u8fdb\u884c\u5f20\u91cf\u62fc\u63a5 combined = torch.cat((input, hidden), 1) # \u901a\u8fc7\u8f93\u5165\u5c42\u5230\u9690\u5c42\u53d8\u6362\u83b7\u5f97hidden\u5f20\u91cf hidden = self.i2h(combined) # \u901a\u8fc7\u8f93\u5165\u5230\u8f93\u51fa\u5c42\u53d8\u6362\u83b7\u5f97output\u5f20\u91cf output = self.i2o(combined) # \u5bf9\u8f93\u51fa\u8fdb\u884csoftmax\u5904\u7406 output = self.softmax(output) # \u8fd4\u56de\u8f93\u51fa\u5f20\u91cf\u548c\u6700\u540e\u7684\u9690\u5c42\u7ed3\u679c return output, hidden def initHidden(self): \"\"\"\u9690\u5c42\u521d\u59cb\u5316\u51fd\u6570\"\"\" # \u5c06\u9690\u5c42\u521d\u59cb\u5316\u6210\u4e3a\u4e00\u4e2a1xhidden_size\u7684\u51680\u5f20\u91cf return torch.zeros(1, self.hidden_size) torch.cat\u6f14\u793a: >>> x = torch.randn(2, 3) >>> x tensor([[ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497]]) >>> torch.cat((x, x, x), 0) tensor([[ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497], [ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497], [ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497]]) >>> torch.cat((x, x, x), 1) ensor([[ 0.6580, -1.0969, -0.4614, 0.6580, -1.0969, -0.4614, 0.6580,-1.0969, -0.4614], [-0.1034, -0.5790, 0.1497, -0.1034, -0.5790, 0.1497, -0.1034,-0.5790, 0.1497]]) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/RNN_MODEL.py \u5b9e\u4f8b\u5316\u53c2\u6570: input_size = 768 hidden_size = 128 n_categories = 2 \u8f93\u5165\u53c2\u6570: input = torch.rand(1, input_size) hidden = torch.rand(1, hidden_size) \u8c03\u7528: from RNN_MODEL import RNN rnn = RNN(input_size, hidden_size, n_categories) outputs, hidden = rnn(input, hidden) print(\"outputs:\", outputs) print(\"hidden:\", hidden) \u8f93\u51fa\u6548\u679c: outputs: tensor([[-0.7858, -0.6084]], grad_fn=<LogSoftmaxBackward>) hidden: tensor([[-4.8444e-01, -5.9609e-02, 1.7870e-01, -1.6553e-01, ... , 5.6711e-01]], grad_fn=<AddmmBackward>)) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86RNN\u6a21\u578b\u7684\u5185\u90e8\u7ed3\u6784\u53ca\u8ba1\u7b97\u516c\u5f0f. \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86RNN\u6a21\u578b\u7684\u7c7b: class RNN(nn.Module). 5.5 \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4. \u638c\u63e1\u6a21\u578b\u8bad\u7ec3\u4e2d\u6bcf\u4e2a\u6b65\u9aa4\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58. \u7b2c\u4e00\u6b65: \u6784\u5efa\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570 # \u5bfc\u5165bert\u4e2d\u6587\u7f16\u7801\u7684\u9884\u8bad\u7ec3\u6a21\u578b from bert_chinese_encode import get_bert_encode_for_single def randomTrainingExample(train_data): \"\"\"\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570, train_data\u662f\u8bad\u7ec3\u96c6\u7684\u5217\u8868\u5f62\u5f0f\u6570\u636e\"\"\" # \u4ecetrain_data\u968f\u673a\u9009\u62e9\u4e00\u6761\u6570\u636e category, line = random.choice(train_data) # \u5c06\u91cc\u9762\u7684\u6587\u5b57\u4f7f\u7528bert\u8fdb\u884c\u7f16\u7801, \u83b7\u53d6\u7f16\u7801\u540e\u7684tensor\u7c7b\u578b\u6570\u636e line_tensor = get_bert_encode_for_single(line) # \u5c06\u5206\u7c7b\u6807\u7b7e\u5c01\u88c5\u6210tensor category_tensor = torch.tensor([int(category)]) # \u8fd4\u56de\u56db\u4e2a\u7ed3\u679c return category, line, category_tensor, line_tensor \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u5165\u53c2\u6570: # \u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58\u83b7\u5f97\u7684train_data \u8c03\u7528: # \u9009\u62e910\u6761\u6570\u636e\u8fdb\u884c\u67e5\u770b for i in range(10): category, line, category_tensor, line_tensor = randomTrainingExample(train_data) print('category =', category, '/ line =', line) \u8f93\u51fa\u6548\u679c: category = 1 / line = \u89e6\u89c9\u5931\u8c03 category = 0 / line = \u98a4\u9707\u6027\u7406\u751f category = 0 / line = \u5f81\u538b\u8840\u9ad8\u5a20\u598a category = 1 / line = \u98df\u6b32\u51cf\u9000 category = 0 / line = \u8840\u6de4\u9053\u80a0\u80c3 category = 0 / line = \u5f62\u7578\u8282\u5173 category = 0 / line = \u54b3\u545b\u6c34\u996e category = 0 / line = \u75c7\u75e3\u5de8 category = 1 / line = \u663c\u76f2 category = 1 / line = \u773c\u795e\u5f02\u5e38 \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570 # \u9009\u53d6\u635f\u5931\u51fd\u6570\u4e3aNLLLoss() criterion = nn.NLLLoss() # \u5b66\u4e60\u7387\u4e3a0.005 learning_rate = 0.005 def train(category_tensor, line_tensor): \"\"\"\u6a21\u578b\u8bad\u7ec3\u51fd\u6570, category_tensor\u4ee3\u8868\u7c7b\u522b\u5f20\u91cf, line_tensor\u4ee3\u8868\u7f16\u7801\u540e\u7684\u6587\u672c\u5f20\u91cf\"\"\" # \u521d\u59cb\u5316\u9690\u5c42 hidden = rnn.initHidden() # \u6a21\u578b\u68af\u5ea6\u5f520 rnn.zero_grad() # \u904d\u5386line_tensor\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7684\u5f20\u91cf\u8868\u793a for i in range(line_tensor.size()[0]): # \u7136\u540e\u5c06\u5176\u8f93\u5165\u5230rnn\u6a21\u578b\u4e2d, \u56e0\u4e3a\u6a21\u578b\u8981\u6c42\u662f\u8f93\u5165\u5fc5\u987b\u662f\u4e8c\u7ef4\u5f20\u91cf, \u56e0\u6b64\u9700\u8981\u62d3\u5c55\u4e00\u4e2a\u7ef4\u5ea6, \u5faa\u73af\u8c03\u7528rnn\u76f4\u5230\u6700\u540e\u4e00\u4e2a\u5b57 output, hidden = rnn(line_tensor[i].unsqueeze(0), hidden) # \u6839\u636e\u635f\u5931\u51fd\u6570\u8ba1\u7b97\u635f\u5931, \u8f93\u5165\u5206\u522b\u662frnn\u7684\u8f93\u51fa\u7ed3\u679c\u548c\u771f\u6b63\u7684\u7c7b\u522b\u6807\u7b7e loss = criterion(output, category_tensor) # \u5c06\u8bef\u5dee\u8fdb\u884c\u53cd\u5411\u4f20\u64ad loss.backward() # \u66f4\u65b0\u6a21\u578b\u4e2d\u6240\u6709\u7684\u53c2\u6570 for p in rnn.parameters(): # \u5c06\u53c2\u6570\u7684\u5f20\u91cf\u8868\u793a\u4e0e\u53c2\u6570\u7684\u68af\u5ea6\u4e58\u4ee5\u5b66\u4e60\u7387\u7684\u7ed3\u679c\u76f8\u52a0\u4ee5\u6b64\u6765\u66f4\u65b0\u53c2\u6570 p.data.add_(-learning_rate, p.grad.data) # \u8fd4\u56de\u7ed3\u679c\u548c\u635f\u5931\u7684\u503c return output, loss.item() \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u7b2c\u4e09\u6b65: \u6a21\u578b\u9a8c\u8bc1\u51fd\u6570 def valid(category_tensor, line_tensor): \"\"\"\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570, category_tensor\u4ee3\u8868\u7c7b\u522b\u5f20\u91cf, line_tensor\u4ee3\u8868\u7f16\u7801\u540e\u7684\u6587\u672c\u5f20\u91cf\"\"\" # \u521d\u59cb\u5316\u9690\u5c42 hidden = rnn.initHidden() # \u9a8c\u8bc1\u6a21\u578b\u4e0d\u81ea\u52a8\u6c42\u89e3\u68af\u5ea6 with torch.no_grad(): # \u904d\u5386line_tensor\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7684\u5f20\u91cf\u8868\u793a for i in range(line_tensor.size()[0]): # \u7136\u540e\u5c06\u5176\u8f93\u5165\u5230rnn\u6a21\u578b\u4e2d, \u56e0\u4e3a\u6a21\u578b\u8981\u6c42\u662f\u8f93\u5165\u5fc5\u987b\u662f\u4e8c\u7ef4\u5f20\u91cf, \u56e0\u6b64\u9700\u8981\u62d3\u5c55\u4e00\u4e2a\u7ef4\u5ea6, \u5faa\u73af\u8c03\u7528rnn\u76f4\u5230\u6700\u540e\u4e00\u4e2a\u5b57 output, hidden = rnn(line_tensor[i].unsqueeze(0), hidden) # \u83b7\u5f97\u635f\u5931 loss = criterion(output, category_tensor) # \u8fd4\u56de\u7ed3\u679c\u548c\u635f\u5931\u7684\u503c return output, loss.item() \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570 \u6784\u5efa\u65f6\u95f4\u8ba1\u7b97\u51fd\u6570: import time import math def timeSince(since): \"\u83b7\u5f97\u6bcf\u6b21\u6253\u5370\u7684\u8bad\u7ec3\u8017\u65f6, since\u662f\u8bad\u7ec3\u5f00\u59cb\u65f6\u95f4\" # \u83b7\u5f97\u5f53\u524d\u65f6\u95f4 now = time.time() # \u83b7\u5f97\u65f6\u95f4\u5dee\uff0c\u5c31\u662f\u8bad\u7ec3\u8017\u65f6 s = now - since # \u5c06\u79d2\u8f6c\u5316\u4e3a\u5206\u949f, \u5e76\u53d6\u6574 m = math.floor(s / 60) # \u8ba1\u7b97\u5269\u4e0b\u4e0d\u591f\u51d1\u62101\u5206\u949f\u7684\u79d2\u6570 s -= m * 60 # \u8fd4\u56de\u6307\u5b9a\u683c\u5f0f\u7684\u8017\u65f6 return '%dm %ds' % (m, s) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u5165\u53c2\u6570: # \u5047\u5b9a\u6a21\u578b\u8bad\u7ec3\u5f00\u59cb\u65f6\u95f4\u662f10min\u4e4b\u524d since = time.time() - 10*60 \u8c03\u7528: period = timeSince(since) print(period) \u8f93\u51fa\u6548\u679c: 10m 0s \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7 # \u8bbe\u7f6e\u8fed\u4ee3\u6b21\u6570\u4e3a50000\u6b65 n_iters = 50000 # \u6253\u5370\u95f4\u9694\u4e3a1000\u6b65 plot_every = 1000 # \u521d\u59cb\u5316\u6253\u5370\u95f4\u9694\u4e2d\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387 train_current_loss = 0 train_current_acc = 0 valid_current_loss = 0 valid_current_acc = 0 # \u521d\u59cb\u5316\u76db\u88c5\u6bcf\u6b21\u6253\u5370\u95f4\u9694\u7684\u5e73\u5747\u635f\u5931\u548c\u51c6\u786e\u7387 all_train_losses = [] all_train_acc = [] all_valid_losses = [] all_valid_acc = [] # \u83b7\u53d6\u5f00\u59cb\u65f6\u95f4\u6233 start = time.time() # \u5faa\u73af\u904d\u5386n_iters\u6b21 for iter in range(1, n_iters + 1): # \u8c03\u7528\u4e24\u6b21\u968f\u673a\u51fd\u6570\u5206\u522b\u751f\u6210\u4e00\u6761\u8bad\u7ec3\u548c\u9a8c\u8bc1\u6570\u636e category, line, category_tensor, line_tensor = randomTrainingExample(train_data) category_, line_, category_tensor_, line_tensor_ = randomTrainingExample(train_data) # \u5206\u522b\u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570, \u83b7\u5f97\u8f93\u51fa\u548c\u635f\u5931 train_output, train_loss = train(category_tensor, line_tensor) valid_output, valid_loss = valid(category_tensor_, line_tensor_) # \u8fdb\u884c\u8bad\u7ec3\u635f\u5931, \u9a8c\u8bc1\u635f\u5931\uff0c\u8bad\u7ec3\u51c6\u786e\u7387\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5206\u522b\u7d2f\u52a0 train_current_loss += train_loss train_current_acc += (train_output.argmax(1) == category_tensor).sum().item() valid_current_loss += valid_loss valid_current_acc += (valid_output.argmax(1) == category_tensor_).sum().item() # \u5f53\u8fed\u4ee3\u6b21\u6570\u662f\u6307\u5b9a\u6253\u5370\u95f4\u9694\u7684\u6574\u6570\u500d\u65f6 if iter % plot_every == 0: # \u7528\u521a\u521a\u7d2f\u52a0\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u9664\u4ee5\u95f4\u9694\u6b65\u6570\u5f97\u5230\u5e73\u5747\u503c train_average_loss = train_current_loss / plot_every train_average_acc = train_current_acc/ plot_every valid_average_loss = valid_current_loss / plot_every valid_average_acc = valid_current_acc/ plot_every # \u6253\u5370\u8fed\u4ee3\u6b65, \u8017\u65f6, \u8bad\u7ec3\u635f\u5931\u548c\u51c6\u786e\u7387, \u9a8c\u8bc1\u635f\u5931\u548c\u51c6\u786e\u7387 print(\"Iter:\", iter, \"|\", \"TimeSince:\", timeSince(start)) print(\"Train Loss:\", train_average_loss, \"|\", \"Train Acc:\", train_average_acc) print(\"Valid Loss:\", valid_average_loss, \"|\", \"Valid Acc:\", valid_average_acc) # \u5c06\u7ed3\u679c\u5b58\u5165\u5bf9\u5e94\u7684\u5217\u8868\u4e2d\uff0c\u65b9\u4fbf\u540e\u7eed\u5236\u56fe all_train_losses.append(train_average_loss) all_train_acc.append(train_average_acc) all_valid_losses.append(valid_average_loss) all_valid_acc.append(valid_average_acc) # \u5c06\u8be5\u95f4\u9694\u7684\u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u53ca\u5176\u51c6\u786e\u7387\u5f520 train_current_loss = 0 train_current_acc = 0 valid_current_loss = 0 valid_current_acc = 0 \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u51fa\u6548\u679c: Iter: 1000 | TimeSince: 0m 56s Train Loss: 0.6127021567507527 | Train Acc: 0.747 Valid Loss: 0.6702297774022868 | Valid Acc: 0.7 Iter: 2000 | TimeSince: 1m 52s Train Loss: 0.5190641692602076 | Train Acc: 0.789 Valid Loss: 0.5217500487511397 | Valid Acc: 0.784 Iter: 3000 | TimeSince: 2m 48s Train Loss: 0.5398398997281778 | Train Acc: 0.8 Valid Loss: 0.5844468013737023 | Valid Acc: 0.777 Iter: 4000 | TimeSince: 3m 43s Train Loss: 0.4700755337187358 | Train Acc: 0.822 Valid Loss: 0.5140456306522071 | Valid Acc: 0.802 Iter: 5000 | TimeSince: 4m 38s Train Loss: 0.5260879981063878 | Train Acc: 0.804 Valid Loss: 0.5924804099237979 | Valid Acc: 0.796 Iter: 6000 | TimeSince: 5m 33s Train Loss: 0.4702717279043861 | Train Acc: 0.825 Valid Loss: 0.6675750375208704 | Valid Acc: 0.78 Iter: 7000 | TimeSince: 6m 27s Train Loss: 0.4734503294042624 | Train Acc: 0.833 Valid Loss: 0.6329268293256277 | Valid Acc: 0.784 Iter: 8000 | TimeSince: 7m 23s Train Loss: 0.4258338176879665 | Train Acc: 0.847 Valid Loss: 0.5356959595441066 | Valid Acc: 0.82 Iter: 9000 | TimeSince: 8m 18s Train Loss: 0.45773495503464817 | Train Acc: 0.843 Valid Loss: 0.5413714128659645 | Valid Acc: 0.798 Iter: 10000 | TimeSince: 9m 14s Train Loss: 0.4856756244019302 | Train Acc: 0.835 Valid Loss: 0.5450502399195044 | Valid Acc: 0.813 \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf import matplotlib.pyplot as plt plt.figure(0) plt.plot(all_train_losses, label=\"Train Loss\") plt.plot(all_valid_losses, color=\"red\", label=\"Valid Loss\") plt.legend(loc='upper left') plt.savefig(\"./loss.png\") plt.figure(1) plt.plot(all_train_acc, label=\"Train Acc\") plt.plot(all_valid_acc, color=\"red\", label=\"Valid Acc\") plt.legend(loc='upper left') plt.savefig(\"./acc.png\") \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u5bf9\u7167\u66f2\u7ebf: \u8bad\u7ec3\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u635f\u5931\u5bf9\u7167\u66f2\u7ebf\u4e00\u76f4\u4e0b\u964d, \u8bf4\u660e\u6a21\u578b\u80fd\u591f\u4ece\u6570\u636e\u4e2d\u83b7\u53d6\u89c4\u5f8b\uff0c\u6b63\u5728\u6536\u655b, \u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf\u4e2d\u9a8c\u8bc1\u51c6\u786e\u7387\u4e00\u76f4\u4e0a\u5347\uff0c\u6700\u7ec8\u7ef4\u6301\u57280.98\u5de6\u53f3. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58 # \u4fdd\u5b58\u8def\u5f84 MODEL_PATH = './BERT_RNN.pth' # \u4fdd\u5b58\u6a21\u578b\u53c2\u6570 torch.save(rnn.state_dict(), MODEL_PATH) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u51fa\u6548\u679c: \u5728/data/doctor_offline/review_model/\u8def\u5f84\u4e0b\u751f\u6210BERT_RNN.pth\u6587\u4ef6. \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58. 5.6 \u6a21\u578b\u4f7f\u7528 \u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u6a21\u578b\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u638c\u63e1\u6a21\u578b\u6279\u91cf\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u6a21\u578b\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b: import os import torch import torch.nn as nn # \u5bfc\u5165RNN\u6a21\u578b\u7ed3\u6784 from RNN_MODEL import RNN # \u5bfc\u5165bert\u9884\u8bad\u7ec3\u6a21\u578b\u7f16\u7801\u51fd\u6570 from bert_chinese_encode import get_bert_encode_for_single # \u9884\u52a0\u8f7d\u7684\u6a21\u578b\u53c2\u6570\u8def\u5f84 MODEL_PATH = './BERT_RNN.pth' # \u9690\u5c42\u8282\u70b9\u6570, \u8f93\u5165\u5c42\u5c3a\u5bf8, \u7c7b\u522b\u6570\u90fd\u548c\u8bad\u7ec3\u65f6\u76f8\u540c\u5373\u53ef n_hidden = 128 input_size = 768 n_categories = 2 # \u5b9e\u4f8b\u5316RNN\u6a21\u578b, \u5e76\u52a0\u8f7d\u4fdd\u5b58\u6a21\u578b\u53c2\u6570 rnn = RNN(input_size, n_hidden, n_categories) rnn.load_state_dict(torch.load(MODEL_PATH)) def _test(line_tensor): \"\"\"\u6a21\u578b\u6d4b\u8bd5\u51fd\u6570, \u5b83\u5c06\u7528\u5728\u6a21\u578b\u9884\u6d4b\u51fd\u6570\u4e2d, \u7528\u4e8e\u8c03\u7528RNN\u6a21\u578b\u5e76\u8fd4\u56de\u7ed3\u679c.\u5b83\u7684\u53c2\u6570line_tensor\u4ee3\u8868\u8f93\u5165\u6587\u672c\u7684\u5f20\u91cf\u8868\u793a\"\"\" # \u521d\u59cb\u5316\u9690\u5c42\u5f20\u91cf hidden = rnn.initHidden() # \u4e0e\u8bad\u7ec3\u65f6\u76f8\u540c, \u904d\u5386\u8f93\u5165\u6587\u672c\u7684\u6bcf\u4e00\u4e2a\u5b57\u7b26 for i in range(line_tensor.size()[0]): # \u5c06\u5176\u9010\u6b21\u8f93\u9001\u7ed9rnn\u6a21\u578b output, hidden = rnn(line_tensor[i].unsqueeze(0), hidden) # \u83b7\u5f97rnn\u6a21\u578b\u6700\u7ec8\u7684\u8f93\u51fa return output def predict(input_line): \"\"\"\u6a21\u578b\u9884\u6d4b\u51fd\u6570, \u8f93\u5165\u53c2\u6570input_line\u4ee3\u8868\u9700\u8981\u9884\u6d4b\u7684\u6587\u672c\"\"\" # \u4e0d\u81ea\u52a8\u6c42\u89e3\u68af\u5ea6 with torch.no_grad(): # \u5c06input_line\u4f7f\u7528bert\u6a21\u578b\u8fdb\u884c\u7f16\u7801 output = _test(get_bert_encode_for_single(input_line)) # \u4eceoutput\u4e2d\u53d6\u51fa\u6700\u5927\u503c\u5bf9\u5e94\u7684\u7d22\u5f15, \u6bd4\u8f83\u7684\u7ef4\u5ea6\u662f1 _, topi = output.topk(1, 1) # \u8fd4\u56de\u7ed3\u679c\u6570\u503c return topi.item() tensor.topk\u6f14\u793a: >>> tr = torch.randn(1, 2) >>> tr tensor([[-0.1808, -1.4170]]) >>> tr.topk(1, 1) torch.return_types.topk(values=tensor([[-0.1808]]), indices=tensor([[0]])) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/predict.py \u8f93\u5165\u53c2\u6570: input_line = \"\u70b9\u7600\u6837\u5c16\u9488\u6027\u53d1\u591a\" \u8c03\u7528: result = predict(input_line) print(\"result:\", result) \u8f93\u51fa\u6548\u679c: result: 0 \u6a21\u578b\u6279\u91cf\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b: def batch_predict(input_path, output_path): \"\"\"\u6279\u91cf\u9884\u6d4b\u51fd\u6570, \u4ee5\u539f\u59cb\u6587\u672c(\u5f85\u8bc6\u522b\u7684\u547d\u540d\u5b9e\u4f53\u7ec4\u6210\u7684\u6587\u4ef6)\u8f93\u5165\u8def\u5f84 \u548c\u9884\u6d4b\u8fc7\u6ee4\u540e(\u53bb\u9664\u6389\u975e\u547d\u540d\u5b9e\u4f53\u7684\u6587\u4ef6)\u7684\u8f93\u51fa\u8def\u5f84\u4e3a\u53c2\u6570\"\"\" # \u5f85\u8bc6\u522b\u7684\u547d\u540d\u5b9e\u4f53\u7ec4\u6210\u7684\u6587\u4ef6\u662f\u4ee5\u75be\u75c5\u540d\u79f0\u4e3acsv\u6587\u4ef6\u540d, # \u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\u662f\u8be5\u75be\u75c5\u5bf9\u5e94\u7684\u75c7\u72b6\u547d\u540d\u5b9e\u4f53 # \u8bfb\u53d6\u8def\u5f84\u4e0b\u7684\u6bcf\u4e00\u4e2acsv\u6587\u4ef6\u540d, \u88c5\u5165csv\u5217\u8868\u4e4b\u4e2d csv_list = os.listdir(input_path) # \u904d\u5386\u6bcf\u4e00\u4e2acsv\u6587\u4ef6 for csv in csv_list: # \u4ee5\u8bfb\u7684\u65b9\u5f0f\u6253\u5f00\u6bcf\u4e00\u4e2acsv\u6587\u4ef6 with open(os.path.join(input_path, csv), \"r\") as fr: # \u518d\u4ee5\u5199\u7684\u65b9\u5f0f\u6253\u5f00\u8f93\u51fa\u8def\u5f84\u7684\u540c\u540dcsv\u6587\u4ef6 with open(os.path.join(output_path, csv), \"w\") as fw: # \u8bfb\u53d6csv\u6587\u4ef6\u7684\u6bcf\u4e00\u884c input_line = fr.readline() # \u4f7f\u7528\u6a21\u578b\u8fdb\u884c\u9884\u6d4b res = predict(input_line) # \u5982\u679c\u7ed3\u679c\u4e3a1 if res: # \u8bf4\u660e\u5ba1\u6838\u6210\u529f, \u5199\u5165\u5230\u8f93\u51facsv\u4e2d fw.write(input_line + \"\\n\") else: pass \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/predict.py \u8f93\u5165\u53c2\u6570: input_path = \"/data/doctor_offline/structured/noreview/\" output_path = \"/data/doctor_offline/structured/reviewed/\" \u8c03\u7528: batch_predict(input_path, output_path) \u8f93\u51fa\u6548\u679c: \u5728\u8f93\u51fa\u8def\u5f84\u4e0b\u751f\u6210\u4e0e\u8f93\u5165\u8def\u5f84\u7b49\u6570\u91cf\u7684\u540c\u540dcsv\u6587\u4ef6, \u5185\u90e8\u7684\u75c7\u72b6\u5b9e\u4f53\u662f\u88ab\u5ba1\u6838\u7684\u53ef\u7528\u5b9e\u4f53. \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86\u6a21\u578b\u9884\u6d4b\u7684\u51fd\u6570: predict(input_line). \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86\u6a21\u578b\u6279\u91cf\u9884\u6d4b\u7684\u51fd\u6570: batch_predict(input_path, output_path)","title":"\u7b2c\u4e94\u7ae0:\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u4efb\u52a1"},{"location":"5/#51","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u547d\u540d\u5b9e\u4f53\u5ba1\u6838\u4efb\u52a1\u7684\u76f8\u5173\u77e5\u8bc6. \u4e86\u89e3\u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0. NE\u5ba1\u6838\u4efb\u52a1: \u4e00\u822c\u5728\u5b9e\u4f53\u8fdb\u5165\u6570\u636e\u5e93\u5b58\u50a8\u524d, \u4e2d\u95f4\u90fd\u4f1a\u6709\u4e00\u9053\u5fc5\u4e0d\u53ef\u5c11\u7684\u5de5\u5e8f, \u5c31\u662f\u5bf9\u8bc6\u522b\u51fa\u6765\u7684\u5b9e\u4f53\u8fdb\u884c\u5408\u6cd5\u6027\u7684\u68c0\u9a8c, \u5373\u547d\u540d\u5b9e\u4f53(NE)\u5ba1\u6838\u4efb\u52a1. \u5b83\u7684\u68c0\u9a8c\u8fc7\u7a0b\u4e0d\u4f7f\u7528\u4e0a\u4e0b\u6587\u4fe1\u606f, \u66f4\u5173\u6ce8\u4e8e\u5b57\u7b26\u672c\u8eab\u7684\u7ec4\u5408\u65b9\u5f0f\u6765\u8fdb\u884c\u5224\u65ad, \u672c\u8d28\u4e0a\uff0c\u5b83\u662f\u4e00\u9879\u77ed\u6587\u672c\u4e8c\u5206\u7c7b\u95ee\u9898. \u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0: \u9488\u5bf9\u77ed\u6587\u672c\u4efb\u52a1, \u65e0\u987b\u6355\u6349\u957f\u8ddd\u79bb\u7684\u5173\u7cfb, \u56e0\u6b64\u6211\u4eec\u4f7f\u7528\u4e86\u4f20\u7edf\u7684RNN\u6a21\u578b\u6765\u89e3\u51b3, \u6027\u80fd\u548c\u6548\u679c\u53ef\u4ee5\u8fbe\u5230\u5f88\u597d\u7684\u5747\u8861. \u77ed\u6587\u672c\u4efb\u52a1\u5f80\u5f80\u9002\u5408\u4f7f\u7528\u5b57\u5d4c\u5165\u7684\u65b9\u5f0f, \u4f46\u662f\u5982\u679c\u4f60\u7684\u8bad\u7ec3\u96c6\u4e0d\u662f\u5f88\u5927,\u6d89\u53ca\u7684\u5b57\u6570\u6709\u9650, \u90a3\u4e48\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u5b57\u5411\u91cf\u8fdb\u884c\u8868\u793a\u5373\u53ef. \u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86bert-chinese\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u83b7\u5f97\u4e2d\u6587\u6c49\u5b57\u7684\u5411\u91cf\u8868\u793a.","title":"5.1 \u4efb\u52a1\u4ecb\u7ecd\u4e0e\u6a21\u578b\u9009\u7528"},{"location":"5/#52","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u53ca\u5176\u76f8\u5173\u89e3\u91ca. \u638c\u63e1\u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684\u8fc7\u7a0b. \u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f: 1 \u624b\u5185\u808c\u840e\u7f29 0 \u7f29\u840e\u808c\u5185\u624b 1 \u5c3f\u9ed1\u9178 0 \u9178\u9ed1\u5c3f 1 \u5355\u773c\u773c\u524d\u9ed1\u5f71 0 \u5f71\u9ed1\u524d\u773c\u773c\u5355 1 \u5fe7\u90c1 0 \u90c1\u5fe7 1 \u7ea2\u7ec6\u80de\u5bff\u547d\u7f29\u77ed 0 \u77ed\u7f29\u547d\u5bff\u80de\u7ec6\u7ea2 1 \u76ae\u80a4\u9ecf\u86cb\u767d\u6c89\u79ef 0 \u79ef\u6c89\u767d\u86cb\u9ecf\u80a4\u76ae 1 \u773c\u795e\u5f02\u5e38 0 \u5e38\u5f02\u795e\u773c 1 \u9634\u56ca\u5760\u80c0\u75db 0 \u75db\u80c0\u5760\u56ca\u9634 1 \u52a8\u8109\u8840\u6c27\u9971\u548c\u5ea6\u964d\u4f4e 0 \u4f4e\u964d\u5ea6\u548c\u9971\u6c27\u8840\u8109\u52a8 \u6570\u636e\u96c6\u7684\u76f8\u5173\u89e3\u91ca: \u8fd9\u4e9b\u8bad\u7ec3\u96c6\u4e2d\u7684\u6b63\u6837\u672c\u5f80\u5f80\u662f\u57fa\u4e8e\u4eba\u5de5\u5ba1\u6838\u7684\u6807\u51c6\u547d\u540d\u5b9e\u4f53. \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e00\u5217\u4ee3\u8868\u6807\u7b7e, 1\u4e3a\u6b63\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u6587\u5b57\u662f\u547d\u540d\u5b9e\u4f53. 0\u4e3a\u8d1f\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u6587\u5b57\u4e0d\u662f\u547d\u540d\u5b9e\u4f53. \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e8c\u5217\u4e2d\u7684\u547d\u540d\u5b9e\u4f53\u6765\u6e90\u4e8e\u6570\u636e\u5e93\u4e2d\u7684\u75c7\u72b6\u5b9e\u4f53\u540d\u5b57, \u5b83\u662f\u7ed3\u6784\u5316\u722c\u866b\u6293\u53d6\u7684\u6570\u636e. \u800c\u975e\u547d\u540d\u5b9e\u4f53\u5219\u662f\u5b83\u7684\u5b57\u7b26\u4e32\u53cd\u8f6c. \u6b63\u8d1f\u6837\u672c\u7684\u6bd4\u4f8b\u662f1:1. \u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58: import pandas as pd from collections import Counter # \u8bfb\u53d6\u6570\u636e train_data_path = \"./train_data.csv\" train_data= pd.read_csv(train_data_path, header=None, sep=\"\\t\") # \u6253\u5370\u6b63\u8d1f\u6807\u7b7e\u6bd4\u4f8b print(dict(Counter(train_data[0].values))) # \u8f6c\u6362\u6570\u636e\u5230\u5217\u8868\u5f62\u5f0f train_data = train_data.values.tolist() print(train_data[:10]) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u51fa\u6548\u679c: # \u6b63\u8d1f\u6807\u7b7e\u6bd4\u4f8b {1: 5740, 0: 5740} # \u53d6\u51fa10\u6761\u8bad\u7ec3\u6570\u636e\u67e5\u770b [[1, '\u6795\u90e8\u75bc\u75db'], [0, '\u75db\u75bc\u90e8\u6795'], [1, '\u9676\u745f\u5f81\u9633\u6027'], [0, '\u6027\u9633\u5f81\u745f\u9676'], [1, '\u604b\u517d\u578b\u6027\u53d8\u6001'], [0, '\u6001\u53d8\u6027\u578b\u517d\u604b'], [1, '\u8fdb\u98df\u56f0\u96be'], [0, '\u96be\u56f0\u98df\u8fdb'], [1, '\u4f1a\u9634\u7618\u7ba1\u6216\u7aa6\u9053\u5f62\u6210'], [0, '\u6210\u5f62\u9053\u7aa6\u6216\u7ba1\u7618\u9634\u4f1a']] \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u53ca\u5176\u76f8\u5173\u89e3\u91ca. \u5b66\u4e60\u4e86\u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u7684\u8fc7\u7a0b.","title":"5.2 \u8bad\u7ec3\u6570\u636e\u96c6"},{"location":"5/#53-bert","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6\u548c\u4f5c\u7528. \u638c\u63e1\u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u8fc7\u7a0b. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b: BERT\u6a21\u578b\u6574\u4f53\u67b6\u6784\u57fa\u4e8eTransformer\u6a21\u578b\u67b6\u6784, BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u89e3\u7801\u5668\u548c\u7f16\u7801\u5668\u5177\u670912\u5c42, \u8f93\u51fa\u5c42\u4e2d\u7684\u7ebf\u6027\u5c42\u5177\u6709768\u4e2a\u8282\u70b9, \u5373\u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u7ef4\u5ea6\u662f768. \u5b83\u4f7f\u7528\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7ed3\u6784\u4e2d, \u5934\u7684\u6570\u91cf\u4e3a12, \u6a21\u578b\u603b\u53c2\u6570\u91cf\u4e3a110M. \u540c\u65f6, \u5b83\u5728\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4e0a\u8fdb\u884c\u8bad\u7ec3, \u56e0\u6b64\u9002\u5408\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4efb\u52a1. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u4f5c\u7528: \u5728\u5b9e\u9645\u7684\u6587\u672c\u4efb\u52a1\u5904\u7406\u4e2d, \u6709\u4e9b\u8bad\u7ec3\u8bed\u6599\u5f88\u96be\u83b7\u5f97, \u4ed6\u4eec\u7684\u603b\u4f53\u6570\u91cf\u548c\u5305\u542b\u7684\u8bcd\u6c47\u603b\u6570\u90fd\u975e\u5e38\u5c11, \u4e0d\u9002\u5408\u7528\u4e8e\u8bad\u7ec3\u5e26\u6709Embedding\u5c42\u7684\u6a21\u578b, \u4f46\u8fd9\u4e9b\u6570\u636e\u4e2d\u5374\u53c8\u8574\u542b\u8fd9\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u89c4\u5f8b\u53ef\u4ee5\u88ab\u6a21\u578b\u6316\u6398, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b,\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9, \u56e0\u4e3a\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u81ea\u5927\u578b\u8bed\u6599, \u80fd\u591f\u4f7f\u5f97\u5f53\u524d\u6587\u672c\u5177\u6709\u610f\u4e49, \u867d\u7136\u8fd9\u4e9b\u610f\u4e49\u53ef\u80fd\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e2a\u7279\u5b9a\u9886\u57df, \u4f46\u662f\u8fd9\u79cd\u7f3a\u9677\u53ef\u4ee5\u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u6765\u8fdb\u884c\u5f25\u8865. \u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801: import torch import torch.nn as nn # \u901a\u8fc7torch.hub(pytorch\u4e2d\u4e13\u6ce8\u4e8e\u8fc1\u79fb\u5b66\u7684\u5de5\u5177)\u83b7\u5f97\u5df2\u7ecf\u8bad\u7ec3\u597d\u7684bert-base-chinese\u6a21\u578b model = torch.hub.load('huggingface/pytorch-transformers', 'model', 'bert-base-chinese') # \u83b7\u5f97\u5bf9\u5e94\u7684\u5b57\u7b26\u6620\u5c04\u5668, \u5b83\u5c06\u628a\u4e2d\u6587\u7684\u6bcf\u4e2a\u5b57\u6620\u5c04\u6210\u4e00\u4e2a\u6570\u5b57 tokenizer = torch.hub.load('huggingface/pytorch-transformers', 'tokenizer', 'bert-base-chinese') def get_bert_encode_for_single(text): \"\"\" description: \u4f7f\u7528bert-chinese\u7f16\u7801\u4e2d\u6587\u6587\u672c :param text: \u8981\u8fdb\u884c\u7f16\u7801\u7684\u6587\u672c :return: \u4f7f\u7528bert\u7f16\u7801\u540e\u7684\u6587\u672c\u5f20\u91cf\u8868\u793a \"\"\" # \u9996\u5148\u4f7f\u7528\u5b57\u7b26\u6620\u5c04\u5668\u5bf9\u6bcf\u4e2a\u6c49\u5b57\u8fdb\u884c\u6620\u5c04 # \u8fd9\u91cc\u9700\u8981\u6ce8\u610f, bert\u7684tokenizer\u6620\u5c04\u540e\u4f1a\u4e3a\u7ed3\u679c\u524d\u540e\u6dfb\u52a0\u5f00\u59cb\u548c\u7ed3\u675f\u6807\u8bb0\u5373101\u548c102 # \u8fd9\u5bf9\u4e8e\u591a\u6bb5\u6587\u672c\u7684\u7f16\u7801\u662f\u6709\u610f\u4e49\u7684, \u4f46\u5728\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u610f\u4e49, \u56e0\u6b64\u4f7f\u7528[1:-1]\u5bf9\u5934\u548c\u5c3e\u8fdb\u884c\u5207\u7247 indexed_tokens = tokenizer.encode(text)[1:-1] # \u4e4b\u540e\u5c06\u5217\u8868\u7ed3\u6784\u8f6c\u5316\u4e3atensor tokens_tensor = torch.tensor([indexed_tokens]) print(tokens_tensor) # \u4f7f\u6a21\u578b\u4e0d\u81ea\u52a8\u8ba1\u7b97\u68af\u5ea6 with torch.no_grad(): # \u8c03\u7528\u6a21\u578b\u83b7\u5f97\u9690\u5c42\u8f93\u51fa encoded_layers, _ = model(tokens_tensor) # \u8f93\u51fa\u7684\u9690\u5c42\u662f\u4e00\u4e2a\u4e09\u7ef4\u5f20\u91cf, \u6700\u5916\u5c42\u4e00\u7ef4\u662f1, \u6211\u4eec\u4f7f\u7528[0]\u964d\u53bb\u5b83. print(encoded_layers.shape) encoded_layers = encoded_layers[0] return encoded_layers \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/bert_chinese_encode.py \u8f93\u5165\u53c2\u6570: text = \"\u4f60\u597d, \u5468\u6770\u4f26\" \u8c03\u7528: outputs = get_bert_encode_for_single(text) print(outputs) print(outputs.shape) \u8f93\u51fa\u6548\u679c: tensor([[ 3.2731e-01, -1.4832e-01, -9.1618e-01, ..., -4.4088e-01, -4.1074e-01, -7.5570e-01], [-1.1287e-01, -7.6269e-01, -6.4861e-01, ..., -8.0478e-01, -5.3600e-01, -3.1953e-01], [-9.3012e-02, -4.4381e-01, -1.1985e+00, ..., -3.6624e-01, -4.7467e-01, -2.6408e-01], [-1.6896e-02, -4.3753e-01, -3.6060e-01, ..., -3.2451e-01, -3.4204e-02, -1.7930e-01], [-1.3159e-01, -3.0048e-01, -2.4193e-01, ..., -4.5756e-02, -2.0958e-01, -1.0649e-01], [-4.0006e-01, -3.4410e-01, -3.8532e-05, ..., 1.9081e-01, 1.7006e-01, -3.6221e-01]]) torch.Size([6, 768]) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6: BERT\u6a21\u578b\u6574\u4f53\u67b6\u6784\u57fa\u4e8eTransformer\u6a21\u578b\u67b6\u6784, BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u89e3\u7801\u5668\u548c\u7f16\u7801\u5668\u5177\u670912\u5c42, \u8f93\u51fa\u5c42\u4e2d\u7684\u7ebf\u6027\u5c42\u5177\u6709768\u4e2a\u8282\u70b9, \u5373\u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u7ef4\u5ea6\u662f768. \u5b83\u4f7f\u7528\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7ed3\u6784\u4e2d, \u5934\u7684\u6570\u91cf\u4e3a12, \u6a21\u578b\u603b\u53c2\u6570\u91cf\u4e3a110M. \u540c\u65f6, \u5b83\u5728\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4e0a\u8fdb\u884c\u8bad\u7ec3, \u56e0\u6b64\u9002\u5408\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4efb\u52a1. \u5b66\u4e60\u4e86BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u4f5c\u7528: \u5728\u5b9e\u9645\u7684\u6587\u672c\u4efb\u52a1\u5904\u7406\u4e2d, \u6709\u4e9b\u8bad\u7ec3\u8bed\u6599\u5f88\u96be\u83b7\u5f97, \u4ed6\u4eec\u7684\u603b\u4f53\u6570\u91cf\u548c\u5305\u542b\u7684\u8bcd\u6c47\u603b\u6570\u90fd\u975e\u5e38\u5c11, \u4e0d\u9002\u5408\u7528\u4e8e\u8bad\u7ec3\u5e26\u6709Embedding\u5c42\u7684\u6a21\u578b, \u4f46\u8fd9\u4e9b\u6570\u636e\u4e2d\u5374\u53c8\u8574\u542b\u8fd9\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u89c4\u5f8b\u53ef\u4ee5\u88ab\u6a21\u578b\u6316\u6398, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b, \u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9, \u56e0\u4e3a\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u81ea\u5927\u578b\u8bed\u6599, \u80fd\u591f\u4f7f\u5f97\u5f53\u524d\u6587\u672c\u5177\u6709\u610f\u4e49, \u867d\u7136\u8fd9\u4e9b\u610f\u4e49\u53ef\u80fd\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e2a\u7279\u5b9a\u9886\u57df, \u4f46\u662f\u8fd9\u79cd\u7f3a\u9677\u53ef\u4ee5\u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u6765\u8fdb\u884c\u5f25\u8865. \u5b66\u4e60\u4e86\u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u51fd\u6570: get_bert_encode_for_single(text)","title":"5.3 BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b"},{"location":"5/#54-rnn","text":"\u5b66\u4e60\u76ee\u6807: \u5b66\u4e60RNN\u6a21\u578b\u7684\u5185\u90e8\u7ed3\u6784\u53ca\u8ba1\u7b97\u516c\u5f0f. \u638c\u63e1RNN\u6a21\u578b\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u4f20\u7edfRNN\u7684\u5185\u90e8\u7ed3\u6784\u56fe: \u7ed3\u6784\u89e3\u91ca\u56fe: \u5185\u90e8\u7ed3\u6784\u5206\u6790: * \u6211\u4eec\u628a\u76ee\u5149\u96c6\u4e2d\u5728\u4e2d\u95f4\u7684\u65b9\u5757\u90e8\u5206, \u5b83\u7684\u8f93\u5165\u6709\u4e24\u90e8\u5206, \u5206\u522b\u662fh(t-1)\u4ee5\u53cax(t), \u4ee3\u8868\u4e0a\u4e00\u65f6\u95f4\u6b65\u7684\u9690\u5c42\u8f93\u51fa, \u4ee5\u53ca\u6b64\u65f6\u95f4\u6b65\u7684\u8f93\u5165, \u5b83\u4eec\u8fdb\u5165RNN\u7ed3\u6784\u4f53\u540e, \u4f1a\"\u878d\u5408\"\u5230\u4e00\u8d77, \u8fd9\u79cd\u878d\u5408\u6211\u4eec\u6839\u636e\u7ed3\u6784\u89e3\u91ca\u53ef\u77e5, \u662f\u5c06\u4e8c\u8005\u8fdb\u884c\u62fc\u63a5, \u5f62\u6210\u65b0\u7684\u5f20\u91cf[x(t), h(t-1)], \u4e4b\u540e\u8fd9\u4e2a\u65b0\u7684\u5f20\u91cf\u5c06\u901a\u8fc7\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42(\u7ebf\u6027\u5c42), \u8be5\u5c42>\u4f7f\u7528tanh\u4f5c\u4e3a\u6fc0\u6d3b\u51fd\u6570, \u6700\u7ec8\u5f97\u5230\u8be5\u65f6\u95f4\u6b65\u7684\u8f93\u51fah(t), \u5b83\u5c06\u4f5c\u4e3a\u4e0b\u4e00\u4e2a\u65f6\u95f4\u6b65\u7684>\u8f93\u5165\u548cx(t+1)\u4e00\u8d77\u8fdb\u5165\u7ed3\u6784\u4f53. \u4ee5\u6b64\u7c7b\u63a8. \u5185\u90e8\u7ed3\u6784\u8fc7\u7a0b\u6f14\u793a: \u6839\u636e\u7ed3\u6784\u5206\u6790\u5f97\u51fa\u5185\u90e8\u8ba1\u7b97\u516c\u5f0f: \u6fc0\u6d3b\u51fd\u6570tanh\u7684\u4f5c\u7528: * \u7528\u4e8e\u5e2e\u52a9\u8c03\u8282\u6d41\u7ecf\u7f51\u7edc\u7684\u503c, tanh\u51fd\u6570\u5c06\u503c\u538b\u7f29\u5728-1\u548c1\u4e4b\u95f4. \u6784\u5efaRNN\u6a21\u578b\u7684\u4ee3\u7801\u5206\u6790: class RNN(nn.Module): def __init__(self, input_size, hidden_size, output_size): \"\"\"\u521d\u59cb\u5316\u51fd\u6570\u4e2d\u6709\u4e09\u4e2a\u53c2\u6570,\u5206\u522b\u662f\u8f93\u5165\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u5c3a\u5bf8\u5927\u5c0f, \u9690\u5c42\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u5c3a\u5bf8\u5927\u5c0f, \u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u5c3a\u5bf8\u5927\u5c0f\"\"\" super(RNN, self).__init__() # \u4f20\u5165\u9690\u542b\u5c42\u5c3a\u5bf8\u5927\u5c0f self.hidden_size = hidden_size # \u6784\u5efa\u4ece\u8f93\u5165\u5230\u9690\u542b\u5c42\u7684\u7ebf\u6027\u53d8\u5316, \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u5165\u5c3a\u5bf8\u662finput_size + hidden_size # \u8fd9\u662f\u56e0\u4e3a\u5728\u5faa\u73af\u7f51\u7edc\u4e2d, \u6bcf\u6b21\u8f93\u5165\u90fd\u6709\u4e24\u90e8\u5206\u7ec4\u6210\uff0c\u5206\u522b\u662f\u6b64\u65f6\u523b\u7684\u8f93\u5165\u548c\u4e0a\u4e00\u65f6\u523b\u4ea7\u751f\u7684\u8f93\u51fa. # \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u51fa\u5c3a\u5bf8\u662fhidden_size self.i2h = nn.Linear(input_size + hidden_size, hidden_size) # \u6784\u5efa\u4ece\u8f93\u5165\u5230\u8f93\u51fa\u5c42\u7684\u7ebf\u6027\u53d8\u5316, \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u5165\u5c3a\u5bf8\u8fd8\u662finput_size + hidden_size # \u8fd9\u4e2a\u7ebf\u6027\u5c42\u7684\u8f93\u51fa\u5c3a\u5bf8\u662foutput_size. self.i2o = nn.Linear(input_size + hidden_size, output_size) # \u6700\u540e\u9700\u8981\u5bf9\u8f93\u51fa\u505asoftmax\u5904\u7406, \u83b7\u5f97\u7ed3\u679c. self.softmax = nn.LogSoftmax(dim=-1) def forward(self, input, hidden): \"\"\"\u5728forward\u51fd\u6570\u4e2d, \u53c2\u6570\u5206\u522b\u662f\u89c4\u5b9a\u5c3a\u5bf8\u7684\u8f93\u5165\u5f20\u91cf, \u4ee5\u53ca\u89c4\u5b9a\u5c3a\u5bf8\u7684\u521d\u59cb\u5316\u9690\u5c42\u5f20\u91cf\"\"\" # \u9996\u5148\u4f7f\u7528torch.cat\u5c06input\u4e0ehidden\u8fdb\u884c\u5f20\u91cf\u62fc\u63a5 combined = torch.cat((input, hidden), 1) # \u901a\u8fc7\u8f93\u5165\u5c42\u5230\u9690\u5c42\u53d8\u6362\u83b7\u5f97hidden\u5f20\u91cf hidden = self.i2h(combined) # \u901a\u8fc7\u8f93\u5165\u5230\u8f93\u51fa\u5c42\u53d8\u6362\u83b7\u5f97output\u5f20\u91cf output = self.i2o(combined) # \u5bf9\u8f93\u51fa\u8fdb\u884csoftmax\u5904\u7406 output = self.softmax(output) # \u8fd4\u56de\u8f93\u51fa\u5f20\u91cf\u548c\u6700\u540e\u7684\u9690\u5c42\u7ed3\u679c return output, hidden def initHidden(self): \"\"\"\u9690\u5c42\u521d\u59cb\u5316\u51fd\u6570\"\"\" # \u5c06\u9690\u5c42\u521d\u59cb\u5316\u6210\u4e3a\u4e00\u4e2a1xhidden_size\u7684\u51680\u5f20\u91cf return torch.zeros(1, self.hidden_size) torch.cat\u6f14\u793a: >>> x = torch.randn(2, 3) >>> x tensor([[ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497]]) >>> torch.cat((x, x, x), 0) tensor([[ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497], [ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497], [ 0.6580, -1.0969, -0.4614], [-0.1034, -0.5790, 0.1497]]) >>> torch.cat((x, x, x), 1) ensor([[ 0.6580, -1.0969, -0.4614, 0.6580, -1.0969, -0.4614, 0.6580,-1.0969, -0.4614], [-0.1034, -0.5790, 0.1497, -0.1034, -0.5790, 0.1497, -0.1034,-0.5790, 0.1497]]) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/RNN_MODEL.py \u5b9e\u4f8b\u5316\u53c2\u6570: input_size = 768 hidden_size = 128 n_categories = 2 \u8f93\u5165\u53c2\u6570: input = torch.rand(1, input_size) hidden = torch.rand(1, hidden_size) \u8c03\u7528: from RNN_MODEL import RNN rnn = RNN(input_size, hidden_size, n_categories) outputs, hidden = rnn(input, hidden) print(\"outputs:\", outputs) print(\"hidden:\", hidden) \u8f93\u51fa\u6548\u679c: outputs: tensor([[-0.7858, -0.6084]], grad_fn=<LogSoftmaxBackward>) hidden: tensor([[-4.8444e-01, -5.9609e-02, 1.7870e-01, -1.6553e-01, ... , 5.6711e-01]], grad_fn=<AddmmBackward>)) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86RNN\u6a21\u578b\u7684\u5185\u90e8\u7ed3\u6784\u53ca\u8ba1\u7b97\u516c\u5f0f. \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86RNN\u6a21\u578b\u7684\u7c7b: class RNN(nn.Module).","title":"5.4 \u6784\u5efaRNN\u6a21\u578b"},{"location":"5/#55","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4. \u638c\u63e1\u6a21\u578b\u8bad\u7ec3\u4e2d\u6bcf\u4e2a\u6b65\u9aa4\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58. \u7b2c\u4e00\u6b65: \u6784\u5efa\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570 # \u5bfc\u5165bert\u4e2d\u6587\u7f16\u7801\u7684\u9884\u8bad\u7ec3\u6a21\u578b from bert_chinese_encode import get_bert_encode_for_single def randomTrainingExample(train_data): \"\"\"\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570, train_data\u662f\u8bad\u7ec3\u96c6\u7684\u5217\u8868\u5f62\u5f0f\u6570\u636e\"\"\" # \u4ecetrain_data\u968f\u673a\u9009\u62e9\u4e00\u6761\u6570\u636e category, line = random.choice(train_data) # \u5c06\u91cc\u9762\u7684\u6587\u5b57\u4f7f\u7528bert\u8fdb\u884c\u7f16\u7801, \u83b7\u53d6\u7f16\u7801\u540e\u7684tensor\u7c7b\u578b\u6570\u636e line_tensor = get_bert_encode_for_single(line) # \u5c06\u5206\u7c7b\u6807\u7b7e\u5c01\u88c5\u6210tensor category_tensor = torch.tensor([int(category)]) # \u8fd4\u56de\u56db\u4e2a\u7ed3\u679c return category, line, category_tensor, line_tensor \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u5165\u53c2\u6570: # \u5c06\u6570\u636e\u96c6\u52a0\u8f7d\u5230\u5185\u5b58\u83b7\u5f97\u7684train_data \u8c03\u7528: # \u9009\u62e910\u6761\u6570\u636e\u8fdb\u884c\u67e5\u770b for i in range(10): category, line, category_tensor, line_tensor = randomTrainingExample(train_data) print('category =', category, '/ line =', line) \u8f93\u51fa\u6548\u679c: category = 1 / line = \u89e6\u89c9\u5931\u8c03 category = 0 / line = \u98a4\u9707\u6027\u7406\u751f category = 0 / line = \u5f81\u538b\u8840\u9ad8\u5a20\u598a category = 1 / line = \u98df\u6b32\u51cf\u9000 category = 0 / line = \u8840\u6de4\u9053\u80a0\u80c3 category = 0 / line = \u5f62\u7578\u8282\u5173 category = 0 / line = \u54b3\u545b\u6c34\u996e category = 0 / line = \u75c7\u75e3\u5de8 category = 1 / line = \u663c\u76f2 category = 1 / line = \u773c\u795e\u5f02\u5e38 \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570 # \u9009\u53d6\u635f\u5931\u51fd\u6570\u4e3aNLLLoss() criterion = nn.NLLLoss() # \u5b66\u4e60\u7387\u4e3a0.005 learning_rate = 0.005 def train(category_tensor, line_tensor): \"\"\"\u6a21\u578b\u8bad\u7ec3\u51fd\u6570, category_tensor\u4ee3\u8868\u7c7b\u522b\u5f20\u91cf, line_tensor\u4ee3\u8868\u7f16\u7801\u540e\u7684\u6587\u672c\u5f20\u91cf\"\"\" # \u521d\u59cb\u5316\u9690\u5c42 hidden = rnn.initHidden() # \u6a21\u578b\u68af\u5ea6\u5f520 rnn.zero_grad() # \u904d\u5386line_tensor\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7684\u5f20\u91cf\u8868\u793a for i in range(line_tensor.size()[0]): # \u7136\u540e\u5c06\u5176\u8f93\u5165\u5230rnn\u6a21\u578b\u4e2d, \u56e0\u4e3a\u6a21\u578b\u8981\u6c42\u662f\u8f93\u5165\u5fc5\u987b\u662f\u4e8c\u7ef4\u5f20\u91cf, \u56e0\u6b64\u9700\u8981\u62d3\u5c55\u4e00\u4e2a\u7ef4\u5ea6, \u5faa\u73af\u8c03\u7528rnn\u76f4\u5230\u6700\u540e\u4e00\u4e2a\u5b57 output, hidden = rnn(line_tensor[i].unsqueeze(0), hidden) # \u6839\u636e\u635f\u5931\u51fd\u6570\u8ba1\u7b97\u635f\u5931, \u8f93\u5165\u5206\u522b\u662frnn\u7684\u8f93\u51fa\u7ed3\u679c\u548c\u771f\u6b63\u7684\u7c7b\u522b\u6807\u7b7e loss = criterion(output, category_tensor) # \u5c06\u8bef\u5dee\u8fdb\u884c\u53cd\u5411\u4f20\u64ad loss.backward() # \u66f4\u65b0\u6a21\u578b\u4e2d\u6240\u6709\u7684\u53c2\u6570 for p in rnn.parameters(): # \u5c06\u53c2\u6570\u7684\u5f20\u91cf\u8868\u793a\u4e0e\u53c2\u6570\u7684\u68af\u5ea6\u4e58\u4ee5\u5b66\u4e60\u7387\u7684\u7ed3\u679c\u76f8\u52a0\u4ee5\u6b64\u6765\u66f4\u65b0\u53c2\u6570 p.data.add_(-learning_rate, p.grad.data) # \u8fd4\u56de\u7ed3\u679c\u548c\u635f\u5931\u7684\u503c return output, loss.item() \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u7b2c\u4e09\u6b65: \u6a21\u578b\u9a8c\u8bc1\u51fd\u6570 def valid(category_tensor, line_tensor): \"\"\"\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570, category_tensor\u4ee3\u8868\u7c7b\u522b\u5f20\u91cf, line_tensor\u4ee3\u8868\u7f16\u7801\u540e\u7684\u6587\u672c\u5f20\u91cf\"\"\" # \u521d\u59cb\u5316\u9690\u5c42 hidden = rnn.initHidden() # \u9a8c\u8bc1\u6a21\u578b\u4e0d\u81ea\u52a8\u6c42\u89e3\u68af\u5ea6 with torch.no_grad(): # \u904d\u5386line_tensor\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7684\u5f20\u91cf\u8868\u793a for i in range(line_tensor.size()[0]): # \u7136\u540e\u5c06\u5176\u8f93\u5165\u5230rnn\u6a21\u578b\u4e2d, \u56e0\u4e3a\u6a21\u578b\u8981\u6c42\u662f\u8f93\u5165\u5fc5\u987b\u662f\u4e8c\u7ef4\u5f20\u91cf, \u56e0\u6b64\u9700\u8981\u62d3\u5c55\u4e00\u4e2a\u7ef4\u5ea6, \u5faa\u73af\u8c03\u7528rnn\u76f4\u5230\u6700\u540e\u4e00\u4e2a\u5b57 output, hidden = rnn(line_tensor[i].unsqueeze(0), hidden) # \u83b7\u5f97\u635f\u5931 loss = criterion(output, category_tensor) # \u8fd4\u56de\u7ed3\u679c\u548c\u635f\u5931\u7684\u503c return output, loss.item() \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570 \u6784\u5efa\u65f6\u95f4\u8ba1\u7b97\u51fd\u6570: import time import math def timeSince(since): \"\u83b7\u5f97\u6bcf\u6b21\u6253\u5370\u7684\u8bad\u7ec3\u8017\u65f6, since\u662f\u8bad\u7ec3\u5f00\u59cb\u65f6\u95f4\" # \u83b7\u5f97\u5f53\u524d\u65f6\u95f4 now = time.time() # \u83b7\u5f97\u65f6\u95f4\u5dee\uff0c\u5c31\u662f\u8bad\u7ec3\u8017\u65f6 s = now - since # \u5c06\u79d2\u8f6c\u5316\u4e3a\u5206\u949f, \u5e76\u53d6\u6574 m = math.floor(s / 60) # \u8ba1\u7b97\u5269\u4e0b\u4e0d\u591f\u51d1\u62101\u5206\u949f\u7684\u79d2\u6570 s -= m * 60 # \u8fd4\u56de\u6307\u5b9a\u683c\u5f0f\u7684\u8017\u65f6 return '%dm %ds' % (m, s) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u5165\u53c2\u6570: # \u5047\u5b9a\u6a21\u578b\u8bad\u7ec3\u5f00\u59cb\u65f6\u95f4\u662f10min\u4e4b\u524d since = time.time() - 10*60 \u8c03\u7528: period = timeSince(since) print(period) \u8f93\u51fa\u6548\u679c: 10m 0s \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7 # \u8bbe\u7f6e\u8fed\u4ee3\u6b21\u6570\u4e3a50000\u6b65 n_iters = 50000 # \u6253\u5370\u95f4\u9694\u4e3a1000\u6b65 plot_every = 1000 # \u521d\u59cb\u5316\u6253\u5370\u95f4\u9694\u4e2d\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387 train_current_loss = 0 train_current_acc = 0 valid_current_loss = 0 valid_current_acc = 0 # \u521d\u59cb\u5316\u76db\u88c5\u6bcf\u6b21\u6253\u5370\u95f4\u9694\u7684\u5e73\u5747\u635f\u5931\u548c\u51c6\u786e\u7387 all_train_losses = [] all_train_acc = [] all_valid_losses = [] all_valid_acc = [] # \u83b7\u53d6\u5f00\u59cb\u65f6\u95f4\u6233 start = time.time() # \u5faa\u73af\u904d\u5386n_iters\u6b21 for iter in range(1, n_iters + 1): # \u8c03\u7528\u4e24\u6b21\u968f\u673a\u51fd\u6570\u5206\u522b\u751f\u6210\u4e00\u6761\u8bad\u7ec3\u548c\u9a8c\u8bc1\u6570\u636e category, line, category_tensor, line_tensor = randomTrainingExample(train_data) category_, line_, category_tensor_, line_tensor_ = randomTrainingExample(train_data) # \u5206\u522b\u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570, \u83b7\u5f97\u8f93\u51fa\u548c\u635f\u5931 train_output, train_loss = train(category_tensor, line_tensor) valid_output, valid_loss = valid(category_tensor_, line_tensor_) # \u8fdb\u884c\u8bad\u7ec3\u635f\u5931, \u9a8c\u8bc1\u635f\u5931\uff0c\u8bad\u7ec3\u51c6\u786e\u7387\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5206\u522b\u7d2f\u52a0 train_current_loss += train_loss train_current_acc += (train_output.argmax(1) == category_tensor).sum().item() valid_current_loss += valid_loss valid_current_acc += (valid_output.argmax(1) == category_tensor_).sum().item() # \u5f53\u8fed\u4ee3\u6b21\u6570\u662f\u6307\u5b9a\u6253\u5370\u95f4\u9694\u7684\u6574\u6570\u500d\u65f6 if iter % plot_every == 0: # \u7528\u521a\u521a\u7d2f\u52a0\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u9664\u4ee5\u95f4\u9694\u6b65\u6570\u5f97\u5230\u5e73\u5747\u503c train_average_loss = train_current_loss / plot_every train_average_acc = train_current_acc/ plot_every valid_average_loss = valid_current_loss / plot_every valid_average_acc = valid_current_acc/ plot_every # \u6253\u5370\u8fed\u4ee3\u6b65, \u8017\u65f6, \u8bad\u7ec3\u635f\u5931\u548c\u51c6\u786e\u7387, \u9a8c\u8bc1\u635f\u5931\u548c\u51c6\u786e\u7387 print(\"Iter:\", iter, \"|\", \"TimeSince:\", timeSince(start)) print(\"Train Loss:\", train_average_loss, \"|\", \"Train Acc:\", train_average_acc) print(\"Valid Loss:\", valid_average_loss, \"|\", \"Valid Acc:\", valid_average_acc) # \u5c06\u7ed3\u679c\u5b58\u5165\u5bf9\u5e94\u7684\u5217\u8868\u4e2d\uff0c\u65b9\u4fbf\u540e\u7eed\u5236\u56fe all_train_losses.append(train_average_loss) all_train_acc.append(train_average_acc) all_valid_losses.append(valid_average_loss) all_valid_acc.append(valid_average_acc) # \u5c06\u8be5\u95f4\u9694\u7684\u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u53ca\u5176\u51c6\u786e\u7387\u5f520 train_current_loss = 0 train_current_acc = 0 valid_current_loss = 0 valid_current_acc = 0 \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u51fa\u6548\u679c: Iter: 1000 | TimeSince: 0m 56s Train Loss: 0.6127021567507527 | Train Acc: 0.747 Valid Loss: 0.6702297774022868 | Valid Acc: 0.7 Iter: 2000 | TimeSince: 1m 52s Train Loss: 0.5190641692602076 | Train Acc: 0.789 Valid Loss: 0.5217500487511397 | Valid Acc: 0.784 Iter: 3000 | TimeSince: 2m 48s Train Loss: 0.5398398997281778 | Train Acc: 0.8 Valid Loss: 0.5844468013737023 | Valid Acc: 0.777 Iter: 4000 | TimeSince: 3m 43s Train Loss: 0.4700755337187358 | Train Acc: 0.822 Valid Loss: 0.5140456306522071 | Valid Acc: 0.802 Iter: 5000 | TimeSince: 4m 38s Train Loss: 0.5260879981063878 | Train Acc: 0.804 Valid Loss: 0.5924804099237979 | Valid Acc: 0.796 Iter: 6000 | TimeSince: 5m 33s Train Loss: 0.4702717279043861 | Train Acc: 0.825 Valid Loss: 0.6675750375208704 | Valid Acc: 0.78 Iter: 7000 | TimeSince: 6m 27s Train Loss: 0.4734503294042624 | Train Acc: 0.833 Valid Loss: 0.6329268293256277 | Valid Acc: 0.784 Iter: 8000 | TimeSince: 7m 23s Train Loss: 0.4258338176879665 | Train Acc: 0.847 Valid Loss: 0.5356959595441066 | Valid Acc: 0.82 Iter: 9000 | TimeSince: 8m 18s Train Loss: 0.45773495503464817 | Train Acc: 0.843 Valid Loss: 0.5413714128659645 | Valid Acc: 0.798 Iter: 10000 | TimeSince: 9m 14s Train Loss: 0.4856756244019302 | Train Acc: 0.835 Valid Loss: 0.5450502399195044 | Valid Acc: 0.813 \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf import matplotlib.pyplot as plt plt.figure(0) plt.plot(all_train_losses, label=\"Train Loss\") plt.plot(all_valid_losses, color=\"red\", label=\"Valid Loss\") plt.legend(loc='upper left') plt.savefig(\"./loss.png\") plt.figure(1) plt.plot(all_train_acc, label=\"Train Acc\") plt.plot(all_valid_acc, color=\"red\", label=\"Valid Acc\") plt.legend(loc='upper left') plt.savefig(\"./acc.png\") \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u5bf9\u7167\u66f2\u7ebf: \u8bad\u7ec3\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u635f\u5931\u5bf9\u7167\u66f2\u7ebf\u4e00\u76f4\u4e0b\u964d, \u8bf4\u660e\u6a21\u578b\u80fd\u591f\u4ece\u6570\u636e\u4e2d\u83b7\u53d6\u89c4\u5f8b\uff0c\u6b63\u5728\u6536\u655b, \u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf\u4e2d\u9a8c\u8bc1\u51c6\u786e\u7387\u4e00\u76f4\u4e0a\u5347\uff0c\u6700\u7ec8\u7ef4\u6301\u57280.98\u5de6\u53f3. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58 # \u4fdd\u5b58\u8def\u5f84 MODEL_PATH = './BERT_RNN.pth' # \u4fdd\u5b58\u6a21\u578b\u53c2\u6570 torch.save(rnn.state_dict(), MODEL_PATH) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/train.py \u8f93\u51fa\u6548\u679c: \u5728/data/doctor_offline/review_model/\u8def\u5f84\u4e0b\u751f\u6210BERT_RNN.pth\u6587\u4ef6. \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u968f\u673a\u9009\u53d6\u6570\u636e\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58.","title":"5.5 \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3"},{"location":"5/#56","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u6a21\u578b\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u638c\u63e1\u6a21\u578b\u6279\u91cf\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u6a21\u578b\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b: import os import torch import torch.nn as nn # \u5bfc\u5165RNN\u6a21\u578b\u7ed3\u6784 from RNN_MODEL import RNN # \u5bfc\u5165bert\u9884\u8bad\u7ec3\u6a21\u578b\u7f16\u7801\u51fd\u6570 from bert_chinese_encode import get_bert_encode_for_single # \u9884\u52a0\u8f7d\u7684\u6a21\u578b\u53c2\u6570\u8def\u5f84 MODEL_PATH = './BERT_RNN.pth' # \u9690\u5c42\u8282\u70b9\u6570, \u8f93\u5165\u5c42\u5c3a\u5bf8, \u7c7b\u522b\u6570\u90fd\u548c\u8bad\u7ec3\u65f6\u76f8\u540c\u5373\u53ef n_hidden = 128 input_size = 768 n_categories = 2 # \u5b9e\u4f8b\u5316RNN\u6a21\u578b, \u5e76\u52a0\u8f7d\u4fdd\u5b58\u6a21\u578b\u53c2\u6570 rnn = RNN(input_size, n_hidden, n_categories) rnn.load_state_dict(torch.load(MODEL_PATH)) def _test(line_tensor): \"\"\"\u6a21\u578b\u6d4b\u8bd5\u51fd\u6570, \u5b83\u5c06\u7528\u5728\u6a21\u578b\u9884\u6d4b\u51fd\u6570\u4e2d, \u7528\u4e8e\u8c03\u7528RNN\u6a21\u578b\u5e76\u8fd4\u56de\u7ed3\u679c.\u5b83\u7684\u53c2\u6570line_tensor\u4ee3\u8868\u8f93\u5165\u6587\u672c\u7684\u5f20\u91cf\u8868\u793a\"\"\" # \u521d\u59cb\u5316\u9690\u5c42\u5f20\u91cf hidden = rnn.initHidden() # \u4e0e\u8bad\u7ec3\u65f6\u76f8\u540c, \u904d\u5386\u8f93\u5165\u6587\u672c\u7684\u6bcf\u4e00\u4e2a\u5b57\u7b26 for i in range(line_tensor.size()[0]): # \u5c06\u5176\u9010\u6b21\u8f93\u9001\u7ed9rnn\u6a21\u578b output, hidden = rnn(line_tensor[i].unsqueeze(0), hidden) # \u83b7\u5f97rnn\u6a21\u578b\u6700\u7ec8\u7684\u8f93\u51fa return output def predict(input_line): \"\"\"\u6a21\u578b\u9884\u6d4b\u51fd\u6570, \u8f93\u5165\u53c2\u6570input_line\u4ee3\u8868\u9700\u8981\u9884\u6d4b\u7684\u6587\u672c\"\"\" # \u4e0d\u81ea\u52a8\u6c42\u89e3\u68af\u5ea6 with torch.no_grad(): # \u5c06input_line\u4f7f\u7528bert\u6a21\u578b\u8fdb\u884c\u7f16\u7801 output = _test(get_bert_encode_for_single(input_line)) # \u4eceoutput\u4e2d\u53d6\u51fa\u6700\u5927\u503c\u5bf9\u5e94\u7684\u7d22\u5f15, \u6bd4\u8f83\u7684\u7ef4\u5ea6\u662f1 _, topi = output.topk(1, 1) # \u8fd4\u56de\u7ed3\u679c\u6570\u503c return topi.item() tensor.topk\u6f14\u793a: >>> tr = torch.randn(1, 2) >>> tr tensor([[-0.1808, -1.4170]]) >>> tr.topk(1, 1) torch.return_types.topk(values=tensor([[-0.1808]]), indices=tensor([[0]])) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/predict.py \u8f93\u5165\u53c2\u6570: input_line = \"\u70b9\u7600\u6837\u5c16\u9488\u6027\u53d1\u591a\" \u8c03\u7528: result = predict(input_line) print(\"result:\", result) \u8f93\u51fa\u6548\u679c: result: 0 \u6a21\u578b\u6279\u91cf\u9884\u6d4b\u7684\u5b9e\u73b0\u8fc7\u7a0b: def batch_predict(input_path, output_path): \"\"\"\u6279\u91cf\u9884\u6d4b\u51fd\u6570, \u4ee5\u539f\u59cb\u6587\u672c(\u5f85\u8bc6\u522b\u7684\u547d\u540d\u5b9e\u4f53\u7ec4\u6210\u7684\u6587\u4ef6)\u8f93\u5165\u8def\u5f84 \u548c\u9884\u6d4b\u8fc7\u6ee4\u540e(\u53bb\u9664\u6389\u975e\u547d\u540d\u5b9e\u4f53\u7684\u6587\u4ef6)\u7684\u8f93\u51fa\u8def\u5f84\u4e3a\u53c2\u6570\"\"\" # \u5f85\u8bc6\u522b\u7684\u547d\u540d\u5b9e\u4f53\u7ec4\u6210\u7684\u6587\u4ef6\u662f\u4ee5\u75be\u75c5\u540d\u79f0\u4e3acsv\u6587\u4ef6\u540d, # \u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\u662f\u8be5\u75be\u75c5\u5bf9\u5e94\u7684\u75c7\u72b6\u547d\u540d\u5b9e\u4f53 # \u8bfb\u53d6\u8def\u5f84\u4e0b\u7684\u6bcf\u4e00\u4e2acsv\u6587\u4ef6\u540d, \u88c5\u5165csv\u5217\u8868\u4e4b\u4e2d csv_list = os.listdir(input_path) # \u904d\u5386\u6bcf\u4e00\u4e2acsv\u6587\u4ef6 for csv in csv_list: # \u4ee5\u8bfb\u7684\u65b9\u5f0f\u6253\u5f00\u6bcf\u4e00\u4e2acsv\u6587\u4ef6 with open(os.path.join(input_path, csv), \"r\") as fr: # \u518d\u4ee5\u5199\u7684\u65b9\u5f0f\u6253\u5f00\u8f93\u51fa\u8def\u5f84\u7684\u540c\u540dcsv\u6587\u4ef6 with open(os.path.join(output_path, csv), \"w\") as fw: # \u8bfb\u53d6csv\u6587\u4ef6\u7684\u6bcf\u4e00\u884c input_line = fr.readline() # \u4f7f\u7528\u6a21\u578b\u8fdb\u884c\u9884\u6d4b res = predict(input_line) # \u5982\u679c\u7ed3\u679c\u4e3a1 if res: # \u8bf4\u660e\u5ba1\u6838\u6210\u529f, \u5199\u5165\u5230\u8f93\u51facsv\u4e2d fw.write(input_line + \"\\n\") else: pass \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_offline/review_model/predict.py \u8f93\u5165\u53c2\u6570: input_path = \"/data/doctor_offline/structured/noreview/\" output_path = \"/data/doctor_offline/structured/reviewed/\" \u8c03\u7528: batch_predict(input_path, output_path) \u8f93\u51fa\u6548\u679c: \u5728\u8f93\u51fa\u8def\u5f84\u4e0b\u751f\u6210\u4e0e\u8f93\u5165\u8def\u5f84\u7b49\u6570\u91cf\u7684\u540c\u540dcsv\u6587\u4ef6, \u5185\u90e8\u7684\u75c7\u72b6\u5b9e\u4f53\u662f\u88ab\u5ba1\u6838\u7684\u53ef\u7528\u5b9e\u4f53. \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86\u6a21\u578b\u9884\u6d4b\u7684\u51fd\u6570: predict(input_line). \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86\u6a21\u578b\u6279\u91cf\u9884\u6d4b\u7684\u51fd\u6570: batch_predict(input_path, output_path)","title":"5.6 \u6a21\u578b\u4f7f\u7528"},{"location":"6/","text":"6.1 \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u4ecb\u7ecd \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u4ec0\u4e48\u662f\u547d\u540d\u5b9e\u4f53\u8bc6\u522b \u4e86\u89e3\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u4f5c\u7528 \u4e86\u89e3\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u5e38\u7528\u65b9\u6cd5 \u4e86\u89e3\u533b\u5b66\u6587\u672c\u7279\u5f81 \u4ec0\u4e48\u662f\u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u547d\u540d\u5b9e\u4f53\u8bc6\u522b(Named Entity Recognition\uff0cNER)\u5c31\u662f\u4ece\u4e00\u6bb5\u81ea\u7136\u8bed\u8a00\u6587\u672c\u4e2d\u627e\u51fa\u76f8\u5173\u5b9e\u4f53\uff0c\u5e76\u6807\u6ce8\u51fa\u5176\u4f4d\u7f6e\u4ee5\u53ca\u7c7b\u578b\u3002\u662f\u4fe1\u606f\u63d0\u53d6, \u95ee\u7b54\u7cfb\u7edf, \u53e5\u6cd5\u5206\u6790, \u673a\u5668\u7ffb\u8bd1\u7b49\u5e94\u7528\u9886\u57df\u7684\u91cd\u8981\u57fa\u7840\u5de5\u5177, \u5728\u81ea\u7136\u8bed\u8a00\u5904\u7406\u6280\u672f\u8d70\u5411\u5b9e\u7528\u5316\u7684\u8fc7\u7a0b\u4e2d\u5360\u6709\u91cd\u8981\u5730\u4f4d. \u5305\u542b\u884c\u4e1a, \u9886\u57df\u4e13\u6709\u540d\u8bcd, \u5982\u4eba\u540d, \u5730\u540d, \u516c\u53f8\u540d, \u673a\u6784\u540d, \u65e5\u671f, \u65f6\u95f4, \u75be\u75c5\u540d, \u75c7\u72b6\u540d, \u624b\u672f\u540d\u79f0, \u8f6f\u4ef6\u540d\u79f0\u7b49\u3002\u5177\u4f53\u53ef\u53c2\u770b\u5982\u4e0b\u793a\u4f8b\u56fe\uff1a \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u4f5c\u7528: \u8bc6\u522b\u4e13\u6709\u540d\u8bcd, \u4e3a\u6587\u672c\u7ed3\u6784\u5316\u63d0\u4f9b\u652f\u6301. \u4e3b\u4f53\u8bc6\u522b, \u8f85\u52a9\u53e5\u6cd5\u5206\u6790. \u5b9e\u4f53\u5173\u7cfb\u62bd\u53d6, \u6709\u5229\u4e8e\u77e5\u8bc6\u63a8\u7406. \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u5e38\u7528\u65b9\u6cd5: \u57fa\u4e8e\u89c4\u5219: \u9488\u5bf9\u6709\u7279\u6b8a\u4e0a\u4e0b\u6587\u7684\u5b9e\u4f53, \u6216\u5b9e\u4f53\u672c\u8eab\u6709\u5f88\u591a\u7279\u5f81\u7684\u6587\u672c, \u4f7f\u7528\u89c4\u5219\u7684\u65b9\u6cd5\u7b80\u5355\u4e14\u6709\u6548. \u6bd4\u5982\u62bd\u53d6\u6587\u672c\u4e2d\u7269\u54c1\u4ef7\u683c, \u5982\u679c\u6587\u672c\u4e2d\u6240\u6709\u5546\u54c1\u4ef7\u683c\u90fd\u662f\u201c\u6570\u5b57+\u5143\u201d\u7684\u5f62\u5f0f, \u5219\u53ef\u4ee5\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f\u201d\\d*.?\\d+\u5143\u201d\u8fdb\u884c\u62bd\u53d6. \u4f46\u5982\u679c\u5f85\u62bd\u53d6\u6587\u672c\u4e2d\u4ef7\u683c\u7684\u8868\u8fbe\u65b9\u5f0f\u591a\u79cd\u591a\u6837, \u4f8b\u5982\u201c\u4e00\u5343\u516b\u767e\u4e07\u201d, \u201c\u4f0d\u4f70\u8d30\u62fe\u5706\u201d, \u201c2000\u4e07\u5143\u201d, \u9047\u5230\u8fd9\u4e9b\u60c5\u51b5\u5c31\u8981\u4fee\u6539\u89c4\u5219\u6765\u6ee1\u8db3\u6240\u6709\u53ef\u80fd\u7684\u60c5\u51b5. \u968f\u7740\u8bed\u6599\u6570\u91cf\u7684\u589e\u52a0, \u9762\u5bf9\u7684\u60c5\u51b5\u4e5f\u8d8a\u6765\u8d8a\u590d\u6742, \u89c4\u5219\u4e4b\u95f4\u4e5f\u53ef\u80fd\u53d1\u751f\u51b2\u7a81, \u6574\u4e2a\u7cfb\u7edf\u4e5f\u53ef\u80fd\u53d8\u5f97\u4e0d\u53ef\u7ef4\u62a4. \u56e0\u6b64\u57fa\u4e8e\u89c4\u5219\u7684\u65b9\u5f0f\u6bd4\u8f83\u9002\u5408\u534a\u7ed3\u6784\u5316\u6216\u6bd4\u8f83\u89c4\u8303\u7684\u6587\u672c\u4e2d\u7684\u8fdb\u884c\u62bd\u53d6\u4efb\u52a1, \u7ed3\u5408\u4e1a\u52a1\u9700\u6c42\u80fd\u591f\u8fbe\u5230\u4e00\u5b9a\u7684\u6548\u679c. \u4f18\u70b9: \u7b80\u5355, \u5feb\u901f. \u7f3a\u70b9: \u9002\u7528\u6027\u5dee, \u7ef4\u62a4\u6210\u672c\u9ad8\u540e\u671f\u751a\u81f3\u4e0d\u80fd\u7ef4\u62a4. \u57fa\u4e8e\u6a21\u578b: \u4ece\u6a21\u578b\u7684\u89d2\u5ea6\u6765\u770b, \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u95ee\u9898\u5b9e\u9645\u4e0a\u662f\u5e8f\u5217\u6807\u6ce8\u95ee\u9898. \u5e8f\u5217\u6807\u6ce8\u95ee\u9898\u6307\u7684\u662f\u6a21\u578b\u7684\u8f93\u5165\u662f\u4e00\u4e2a\u5e8f\u5217, \u5305\u62ec\u6587\u5b57, \u65f6\u95f4\u7b49, \u8f93\u51fa\u4e5f\u662f\u4e00\u4e2a\u5e8f\u5217. \u9488\u5bf9\u8f93\u5165\u5e8f\u5217\u7684\u6bcf\u4e00\u4e2a\u5355\u5143, \u8f93\u51fa\u4e00\u4e2a\u7279\u5b9a\u7684\u6807\u7b7e. \u4ee5\u4e2d\u6587\u5206\u8bcd\u4efb\u52a1\u8fdb\u884c\u4e3e\u4f8b, \u4f8b\u5982\u8f93\u5165\u5e8f\u5217\u662f\u4e00\u4e32\u6587\u5b57: \"\u6211\u662f\u4e2d\u56fd\u4eba\", \u8f93\u51fa\u5e8f\u5217\u662f\u4e00\u4e32\u6807\u7b7e: \"OOBII\", \u5176\u4e2d\"BIO\"\u7ec4\u6210\u4e86\u4e00\u79cd\u4e2d\u6587\u5206\u8bcd\u7684\u6807\u7b7e\u4f53\u7cfb: B\u8868\u793a\u8fd9\u4e2a\u5b57\u662f\u8bcd\u7684\u5f00\u59cb, I\u8868\u793a\u8bcd\u7684\u4e2d\u95f4\u5230\u7ed3\u5c3e, O\u8868\u793a\u5176\u4ed6\u7c7b\u578b\u8bcd. \u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8f93\u51fa\u5e8f\u5217\"OOBII\"\u8fdb\u884c\u89e3\u7801, \u5f97\u5230\u5206\u8bcd\u7ed3\u679c\"\u6211\\\u662f\\\u4e2d\u56fd\u4eba\". \u5e8f\u5217\u6807\u6ce8\u95ee\u9898\u6db5\u76d6\u4e86\u81ea\u7136\u8bed\u8a00\u5904\u7406\u4e2d\u7684\u5f88\u591a\u4efb\u52a1, \u5305\u62ec\u8bed\u97f3\u8bc6\u522b, \u4e2d\u6587\u5206\u8bcd, \u673a\u5668\u7ffb\u8bd1, \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7b49, \u800c\u5e38\u89c1\u7684\u5e8f\u5217\u6807\u6ce8\u6a21\u578b\u5305\u62ecHMM, CRF, RNN, LSTM, GRU\u7b49\u6a21\u578b. \u5176\u4e2d\u5728\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u6280\u672f\u4e0a, \u76ee\u524d\u4e3b\u6d41\u7684\u6280\u672f\u662f\u901a\u8fc7BiLSTM+CRF\u6a21\u578b\u8fdb\u884c\u5e8f\u5217\u6807\u6ce8, \u4e5f\u662f\u9879\u76ee\u4e2d\u8981\u7528\u5230\u7684\u6a21\u578b. \u533b\u5b66\u6587\u672c\u7279\u5f81: \u7b80\u77ed\u7cbe\u70bc \u5f62\u5bb9\u8bcd\u76f8\u5bf9\u8f83\u5c11 \u6cdb\u5316\u6027\u76f8\u5bf9\u8f83\u5c0f \u533b\u5b66\u540d\u8bcd\u9519\u5b57\u7387\u6bd4\u8f83\u9ad8 \u540c\u4e49\u8bcd\u3001\u7b80\u79f0\u6bd4\u8f83\u591a \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u4ec0\u4e48\u662f\u547d\u540d\u5b9e\u4f53\u8bc6\u522b \u5b66\u4e60\u4e86\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u4f5c\u7528 \u5b66\u4e60\u4e86\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u5e38\u7528\u65b9\u6cd5 \u5b66\u4e60\u4e86\u533b\u5b66\u6587\u672c\u7279\u5f81 6.2 BiLSTM\u4ecb\u7ecd \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3BiLSTM\u7f51\u7edc\u7ed3\u6784. \u638c\u63e1BiLSTM\u6a21\u578b\u5b9e\u73b0. BiLSTM\u7f51\u7edc\u7ed3\u6784: \u6240\u8c13\u7684BiLSTM\uff0c\u5c31\u662f(Bidirectional LSTM)\u53cc\u5411LSTM. \u5355\u5411\u7684LSTM\u6a21\u578b\u53ea\u80fd\u6355\u6349\u5230\u4ece\u524d\u5411\u540e\u4f20\u9012\u7684\u4fe1\u606f, \u800c\u53cc\u5411\u7684\u7f51\u7edc\u53ef\u4ee5\u540c\u65f6\u6355\u6349\u6b63\u5411\u4fe1\u606f\u548c\u53cd\u5411\u4fe1\u606f, \u4f7f\u5f97\u5bf9\u6587\u672c\u4fe1\u606f\u7684\u5229\u7528\u66f4\u5168\u9762, \u6548\u679c\u4e5f\u66f4\u597d. \u5728BiLSTM\u7f51\u7edc\u6700\u7ec8\u7684\u8f93\u51fa\u5c42\u540e\u9762\u589e\u52a0\u4e86\u4e00\u4e2a\u7ebf\u6027\u5c42, \u7528\u6765\u5c06BiLSTM\u4ea7\u751f\u7684\u9690\u85cf\u5c42\u8f93\u51fa\u7ed3\u679c\u6295\u5c04\u5230\u5177\u6709\u67d0\u79cd\u8868\u8fbe\u6807\u7b7e\u7279\u5f81\u610f\u4e49\u7684\u533a\u95f4, \u5177\u4f53\u5982\u4e0b\u56fe\u6240\u793a\uff1a BiLSTM\u6a21\u578b\u5b9e\u73b0: \u7b2c\u4e00\u6b65: \u5b9e\u73b0\u7c7b\u7684\u521d\u59cb\u5316\u548c\u7f51\u7edc\u7ed3\u6784\u7684\u642d\u5efa. \u7b2c\u4e8c\u6b65: \u5b9e\u73b0\u6587\u672c\u5411\u91cf\u5316\u7684\u51fd\u6570. \u7b2c\u4e09\u6b65: \u5b9e\u73b0\u7f51\u7edc\u7684\u524d\u5411\u8ba1\u7b97. \u7b2c\u4e00\u6b65: \u5b9e\u73b0\u7c7b\u7684\u521d\u59cb\u5316\u548c\u7f51\u7edc\u7ed3\u6784\u7684\u642d\u5efa. # \u672c\u6bb5\u4ee3\u7801\u6784\u5efa\u7c7bBiLSTM, \u5b8c\u6210\u521d\u59cb\u5316\u548c\u7f51\u7edc\u7ed3\u6784\u7684\u642d\u5efa # \u603b\u51713\u5c42: \u8bcd\u5d4c\u5165\u5c42, \u53cc\u5411LSTM\u5c42, \u5168\u8fde\u63a5\u7ebf\u6027\u5c42 import torch import torch.nn as nn class BiLSTM(nn.Module): \"\"\" description: BiLSTM \u6a21\u578b\u5b9a\u4e49 \"\"\" def __init__(self, vocab_size, tag_to_id, input_feature_size, hidden_size, batch_size, sentence_length, num_layers=1, batch_first=True): \"\"\" description: \u6a21\u578b\u521d\u59cb\u5316 :param vocab_size: \u6240\u6709\u53e5\u5b50\u5305\u542b\u5b57\u7b26\u5927\u5c0f :param tag_to_id: \u6807\u7b7e\u4e0e id \u5bf9\u7167 :param input_feature_size: \u5b57\u5d4c\u5165\u7ef4\u5ea6( \u5373LSTM\u8f93\u5165\u5c42\u7ef4\u5ea6 input_size ) :param hidden_size: \u9690\u85cf\u5c42\u5411\u91cf\u7ef4\u5ea6 :param batch_size: \u6279\u8bad\u7ec3\u5927\u5c0f :param sentence_length \u53e5\u5b50\u957f\u5ea6 :param num_layers: \u5806\u53e0 LSTM \u5c42\u6570 :param batch_first: \u662f\u5426\u5c06batch_size\u653e\u7f6e\u5230\u77e9\u9635\u7684\u7b2c\u4e00\u7ef4\u5ea6 \"\"\" # \u7c7b\u7ee7\u627f\u521d\u59cb\u5316\u51fd\u6570 super(BiLSTM, self).__init__() # \u8bbe\u7f6e\u6807\u7b7e\u4e0eid\u5bf9\u7167 self.tag_to_id = tag_to_id # \u8bbe\u7f6e\u6807\u7b7e\u5927\u5c0f, \u5bf9\u5e94BiLSTM\u6700\u7ec8\u8f93\u51fa\u5206\u6570\u77e9\u9635\u5bbd\u5ea6 self.tag_size = len(tag_to_id) # \u8bbe\u5b9aLSTM\u8f93\u5165\u7279\u5f81\u5927\u5c0f, \u5bf9\u5e94\u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6\u5927\u5c0f self.embedding_size = input_feature_size # \u8bbe\u7f6e\u9690\u85cf\u5c42\u7ef4\u5ea6, \u82e5\u4e3a\u53cc\u5411\u65f6\u60f3\u8981\u5f97\u5230\u540c\u6837\u5927\u5c0f\u7684\u5411\u91cf, \u9700\u8981\u9664\u4ee52 self.hidden_size = hidden_size // 2 # \u8bbe\u7f6e\u6279\u6b21\u5927\u5c0f, \u5bf9\u5e94\u6bcf\u4e2a\u6279\u6b21\u7684\u6837\u672c\u6761\u6570, \u53ef\u4ee5\u7406\u89e3\u4e3a\u8f93\u5165\u5f20\u91cf\u7684\u7b2c\u4e00\u4e2a\u7ef4\u5ea6 self.batch_size = batch_size # \u8bbe\u5b9a\u53e5\u5b50\u957f\u5ea6 self.sentence_length = sentence_length # \u8bbe\u5b9a\u662f\u5426\u5c06batch_size\u653e\u7f6e\u5230\u77e9\u9635\u7684\u7b2c\u4e00\u7ef4\u5ea6, \u53d6\u503cTrue, \u6216False self.batch_first = batch_first # \u8bbe\u7f6e\u7f51\u7edc\u7684LSTM\u5c42\u6570 self.num_layers = num_layers # \u6784\u5efa\u8bcd\u5d4c\u5165\u5c42: \u5b57\u5411\u91cf, \u7ef4\u5ea6\u4e3a\u603b\u5355\u8bcd\u6570\u91cf\u4e0e\u8bcd\u5d4c\u5165\u7ef4\u5ea6 # \u53c2\u6570: \u603b\u4f53\u5b57\u5e93\u7684\u5355\u8bcd\u6570\u91cf, \u6bcf\u4e2a\u5b57\u88ab\u5d4c\u5165\u7684\u7ef4\u5ea6 self.embedding = nn.Embedding(vocab_size, self.embedding_size) # \u6784\u5efa\u53cc\u5411LSTM\u5c42: BiLSTM (\u53c2\u6570: input_size \u5b57\u5411\u91cf\u7ef4\u5ea6(\u5373\u8f93\u5165\u5c42\u5927\u5c0f), # hidden_size \u9690\u85cf\u5c42\u7ef4\u5ea6, # num_layers \u5c42\u6570, # bidirectional \u662f\u5426\u4e3a\u53cc\u5411, # batch_first \u662f\u5426\u6279\u6b21\u5927\u5c0f\u5728\u7b2c\u4e00\u4f4d) self.bilstm = nn.LSTM(input_size=input_feature_size, hidden_size=self.hidden_size, num_layers=num_layers, bidirectional=True, batch_first=batch_first) # \u6784\u5efa\u5168\u8fde\u63a5\u7ebf\u6027\u5c42: \u5c06BiLSTM\u7684\u8f93\u51fa\u5c42\u8fdb\u884c\u7ebf\u6027\u53d8\u6362 self.linear = nn.Linear(hidden_size, self.tag_size) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u7801\u8868\u4e0eid\u5bf9\u7167 char_to_id = {\"\u53cc\": 0, \"\u80ba\": 1, \"\u89c1\": 2, \"\u591a\": 3, \"\u53d1\": 4, \"\u6591\": 5, \"\u7247\": 6, \"\u72b6\": 7, \"\u7a0d\": 8, \"\u9ad8\": 9, \"\u5bc6\": 10, \"\u5ea6\": 11, \"\u5f71\": 12, \"\u3002\": 13} # \u53c2\u65702:\u6807\u7b7e\u7801\u8868\u5bf9\u7167 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4} # \u53c2\u65703:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u65704:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u65705:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65706:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u65707:\u5806\u53e0 LSTM \u5c42\u6570 NUM_LAYERS = 1 \u8c03\u7528: # \u521d\u59cb\u5316\u6a21\u578b model = BiLSTM(vocab_size=len(char_to_id), tag_to_id=tag_to_id, input_feature_size=EMBEDDING_DIM, hidden_size=HIDDEN_DIM, batch_size=BATCH_SIZE, sentence_length=SENTENCE_LENGTH, num_layers=NUM_LAYERS) print(model) \u8f93\u51fa\u6548\u679c: BiLSTM( (embedding): Embedding(14, 200) (bilstm): LSTM(200, 50, batch_first=True, bidirectional=True) (linear): Linear(in_features=100, out_features=5, bias=True) ) \u7b2c\u4e8c\u6b65:\u5b9e\u73b0\u6587\u672c\u5411\u91cf\u5316\u7684\u51fd\u6570. # \u672c\u51fd\u6570\u5b9e\u73b0\u5c06\u4e2d\u6587\u6587\u672c\u6620\u5c04\u4e3a\u6570\u5b57\u5316\u7684\u5f20\u91cf def sentence_map(sentence_list, char_to_id, max_length): \"\"\" description: \u5c06\u53e5\u5b50\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7b26\u6620\u5c04\u5230\u7801\u8868\u4e2d :param sentence: \u5f85\u6620\u5c04\u53e5\u5b50, \u7c7b\u578b\u4e3a\u5b57\u7b26\u4e32\u6216\u5217\u8868 :param char_to_id: \u7801\u8868, \u7c7b\u578b\u4e3a\u5b57\u5178, \u683c\u5f0f\u4e3a{\"\u5b571\": 1, \"\u5b572\": 2} :return: \u6bcf\u4e00\u4e2a\u5b57\u5bf9\u5e94\u7684\u7f16\u7801, \u7c7b\u578b\u4e3atensor \"\"\" # \u5b57\u7b26\u4e32\u6309\u7167\u9006\u5e8f\u8fdb\u884c\u6392\u5e8f, \u4e0d\u662f\u5fc5\u987b\u64cd\u4f5c sentence_list.sort(key=lambda c:len(c), reverse=True) # \u5b9a\u4e49\u53e5\u5b50\u6620\u5c04\u5217\u8868 sentence_map_list = [] for sentence in sentence_list: # \u751f\u6210\u53e5\u5b50\u4e2d\u6bcf\u4e2a\u5b57\u5bf9\u5e94\u7684 id \u5217\u8868 sentence_id_list = [char_to_id[c] for c in sentence] # \u8ba1\u7b97\u6240\u8981\u586b\u5145 0 \u7684\u957f\u5ea6 padding_list = [0] * (max_length-len(sentence)) # \u7ec4\u5408 sentence_id_list.extend(padding_list) # \u5c06\u586b\u5145\u540e\u7684\u5217\u8868\u52a0\u5165\u53e5\u5b50\u6620\u5c04\u603b\u8868\u4e2d sentence_map_list.append(sentence_id_list) # \u8fd4\u56de\u53e5\u5b50\u6620\u5c04\u96c6\u5408, \u8f6c\u4e3a\u6807\u91cf return torch.tensor(sentence_map_list, dtype=torch.long) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u53e5\u5b50\u96c6\u5408 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\"] # \u53c2\u65702:\u7801\u8868\u4e0eid\u5bf9\u7167 char_to_id = {\"<PAD>\":0} # \u53c2\u65703:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: # \u83b7\u53d6\u53e5\u5b50\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57 for _char in sentence: # \u5224\u65ad\u662f\u5426\u5728\u7801\u8868 id \u5bf9\u7167\u5b57\u5178\u4e2d\u5b58\u5728 if _char not in char_to_id: # \u52a0\u5165\u5b57\u7b26id\u5bf9\u7167\u5b57\u5178 char_to_id[_char] = len(char_to_id) # \u5c06\u53e5\u5b50\u8f6c\u4e3a id \u5e76\u7528 tensor \u5305\u88c5 sentences_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) print(\"sentences_sequence:\\n\", sentences_sequence) \u8f93\u51fa\u6548\u679c: sentences_sequence: tensor([[14, 15, 16, 17, 18, 16, 19, 20, 21, 13, 22, 23, 24, 25, 26, 27, 28, 29, 30, 0], [14, 15, 26, 27, 18, 49, 50, 12, 21, 13, 22, 51, 52, 25, 53, 54, 55, 29, 30, 0], [14, 15, 53, 56, 18, 49, 50, 18, 26, 27, 57, 58, 59, 22, 51, 52, 55, 29, 0, 0], [37, 63, 64, 65, 66, 55, 13, 22, 61, 51, 52, 25, 67, 68, 69, 70, 71, 13, 0, 0], [37, 38, 39, 7, 8, 40, 41, 42, 43, 44, 45, 46, 47, 48, 0, 0, 0, 0, 0, 0], [16, 17, 18, 53, 56, 12, 59, 60, 22, 61, 51, 52, 12, 62, 0, 0, 0, 0, 0, 0], [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 0, 0, 0, 0, 0, 0, 0], [31, 32, 24, 33, 34, 35, 36, 13, 30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]) \u7b2c\u4e09\u6b65: \u5b9e\u73b0\u7f51\u7edc\u7684\u524d\u5411\u8ba1\u7b97. # \u672c\u51fd\u6570\u5b9e\u73b0\u7c7bBiLSTM\u4e2d\u7684\u524d\u5411\u8ba1\u7b97\u51fd\u6570forward() def forward(self, sentences_sequence): \"\"\" description: \u5c06\u53e5\u5b50\u5229\u7528BiLSTM\u8fdb\u884c\u7279\u5f81\u8ba1\u7b97\uff0c\u5206\u522b\u7ecf\u8fc7Embedding->BiLSTM->Linear\uff0c \u83b7\u5f97\u53d1\u5c04\u77e9\u9635\uff08emission scores\uff09 :param sentences_sequence: \u53e5\u5b50\u5e8f\u5217\u5bf9\u5e94\u7684\u7f16\u7801\uff0c \u82e5\u8bbe\u5b9a batch_first \u4e3a True\uff0c \u5219\u6279\u91cf\u8f93\u5165\u7684 sequence \u7684 shape \u4e3a(batch_size, sequence_length) :return: \u8fd4\u56de\u5f53\u524d\u53e5\u5b50\u7279\u5f81\uff0c\u8f6c\u5316\u4e3a tag_size \u7684\u7ef4\u5ea6\u7684\u7279\u5f81 \"\"\" # \u521d\u59cb\u5316\u9690\u85cf\u72b6\u6001\u503c h0 = torch.randn(self.num_layers * 2, self.batch_size, self.hidden_size) # \u521d\u59cb\u5316\u5355\u5143\u72b6\u6001\u503c c0 = torch.randn(self.num_layers * 2, self.batch_size, self.hidden_size) # \u751f\u6210\u5b57\u5411\u91cf\uff0c shape \u4e3a(batch, sequence_length, input_feature_size) # \u6ce8\uff1aembedding cuda \u4f18\u5316\u4ec5\u652f\u6301 SGD \u3001 SparseAdam input_features = self.embedding(sentences_sequence) # \u5c06\u5b57\u5411\u91cf\u4e0e\u521d\u59cb\u503c(\u9690\u85cf\u72b6\u6001 h0 , \u5355\u5143\u72b6\u6001 c0 )\u4f20\u5165 LSTM \u7ed3\u6784\u4e2d # \u8f93\u51fa\u5305\u542b\u5982\u4e0b\u5185\u5bb9\uff1a # 1, \u8ba1\u7b97\u7684\u8f93\u51fa\u7279\u5f81\uff0cshape \u4e3a(batch, sentence_length, hidden_size) # \u987a\u5e8f\u4e3a\u8bbe\u5b9a batch_first \u4e3a True \u60c5\u51b5, \u82e5\u672a\u8bbe\u5b9a\u5219 batch \u5728\u7b2c\u4e8c\u4f4d # 2, \u6700\u540e\u5f97\u5230\u7684\u9690\u85cf\u72b6\u6001 hn \uff0c shape \u4e3a(num_layers * num_directions, batch, hidden_size) # 3, \u6700\u540e\u5f97\u5230\u7684\u5355\u5143\u72b6\u6001 cn \uff0c shape \u4e3a(num_layers * num_directions, batch, hidden_size) output, (hn, cn) = self.bilstm(input_features, (h0, c0)) # \u5c06\u8f93\u51fa\u7279\u5f81\u8fdb\u884c\u7ebf\u6027\u53d8\u6362\uff0c\u8f6c\u4e3a shape \u4e3a (batch, sequence_length, tag_size) \u5927\u5c0f\u7684\u7279\u5f81 sequence_features = self.linear(output) # \u8f93\u51fa\u7ebf\u6027\u53d8\u6362\u4e3a tag \u6620\u5c04\u957f\u5ea6\u7684\u7279\u5f81 return sequence_features \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u6807\u7b7e\u7801\u8868\u5bf9\u7167 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4} # \u53c2\u65702:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u65703:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u65704:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65705:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u65706:\u5806\u53e0 LSTM \u5c42\u6570 NUM_LAYERS = 1 char_to_id = {\"<PAD>\":0} SENTENCE_LENGTH = 20 \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM(vocab_size=len(char_to_id), tag_to_id=tag_to_id, input_feature_size=EMBEDDING_DIM, \\ hidden_size=HIDDEN_DIM, batch_size=BATCH_SIZE, sentence_length=SENTENCE_LENGTH, num_layers=NUM_LAYERS) sentence_features = model(sentence_sequence) print(\"sequence_features:\\n\", sentence_features) \u8f93\u51fa\u6548\u679c: sequence_features: tensor([[[ 4.0880e-02, -5.8926e-02, -9.3971e-02, 8.4794e-03, -2.9872e-01], [ 2.9434e-02, -2.5901e-01, -2.0811e-01, 1.3794e-02, -1.8743e-01], [-2.7899e-02, -3.4636e-01, 1.3382e-02, 2.2684e-02, -1.2067e-01], [-1.9069e-01, -2.6668e-01, -5.7182e-02, 2.1566e-01, 1.1443e-01], ... [-1.6844e-01, -4.0699e-02, 2.6328e-02, 1.3513e-01, -2.4445e-01], [-7.3070e-02, 1.2032e-01, 2.2346e-01, 1.8993e-01, 8.3171e-02], [-1.6808e-01, 2.1454e-02, 3.2424e-01, 8.0905e-03, -1.5961e-01], [-1.9504e-01, -4.9296e-02, 1.7219e-01, 8.9345e-02, -1.4214e-01]], ... [[-3.4836e-03, 2.6217e-01, 1.9355e-01, 1.8084e-01, -1.6086e-01], [-9.1231e-02, -8.4838e-04, 1.0575e-01, 2.2864e-01, 1.6104e-02], [-8.7726e-02, -7.6956e-02, -7.0301e-02, 1.7199e-01, -6.5375e-02], [-5.9306e-02, -5.4701e-02, -9.3267e-02, 3.2478e-01, -4.0474e-02], [-1.1326e-01, 4.8365e-02, -1.7994e-01, 8.1722e-02, 1.8604e-01], ... [-5.8271e-02, -6.5781e-02, 9.9232e-02, 4.8524e-02, -8.2799e-02], [-6.8400e-02, -9.1515e-02, 1.1352e-01, 1.0674e-02, -8.2739e-02], [-9.1461e-02, -1.2304e-01, 1.2540e-01, -4.2065e-02, -8.3091e-02], [-1.5834e-01, -8.7316e-02, 7.0567e-02, -8.8845e-02, -7.0867e-02]], [[-1.4069e-01, 4.9171e-02, 1.4314e-01, -1.5284e-02, -1.4395e-01], [ 6.5296e-02, 9.3255e-03, -2.8411e-02, 1.5143e-01, 7.8252e-02], [ 4.1765e-03, -1.4635e-01, -4.9798e-02, 2.7597e-01, -1.0256e-01], ... [-3.9810e-02, -7.6746e-03, 1.2418e-01, 4.9897e-02, -8.4538e-02], [-3.4474e-02, -1.0586e-02, 1.3861e-01, 4.0395e-02, -8.3676e-02], [-3.4092e-02, -2.3208e-02, 1.6097e-01, 2.3498e-02, -8.3332e-02], [-4.6900e-02, -5.0335e-02, 1.8982e-01, 3.6287e-03, -7.8078e-02], [-6.4105e-02, -4.2628e-02, 1.8999e-01, -2.9888e-02, -1.1875e-01]]], grad_fn=<AddBackward0>) \u8f93\u51fa\u7ed3\u679c\u8bf4\u660e: \u8be5\u8f93\u51fa\u7ed3\u679c\u4e3a\u8f93\u5165\u6279\u6b21\u4e2d\u53e5\u5b50\u7684\u7279\u5f81, \u5229\u7528\u7ebf\u6027\u53d8\u6362\u5206\u522b\u5bf9\u5e94\u5230\u6bcf\u4e2atag\u7684\u5f97\u5206. \u4f8b\u5982\u4e0a\u8ff0\u6807\u91cf\u7b2c\u4e00\u4e2a\u503c\uff1a [ 4.0880e-02, -5.8926e-02, -9.3971e-02, 8.4794e-03, -2.9872e-01] \u8868\u793a\u7684\u610f\u601d\u4e3a\u7b2c\u4e00\u4e2a\u53e5\u5b50\u7b2c\u4e00\u4e2a\u5b57\u5206\u522b\u88ab\u6807\u8bb0\u4e3a[\"O\", \"B-dis\", \"I-dis\", \"B-sym\", \"I-sym\"]\u7684\u5206\u6570, \u7531\u6b64\u53ef\u4ee5\u5224\u65ad, \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d, \u7b2c\u4e00\u4e2a\u5b57\u88ab\u6807\u6ce8\u4e3a\"O\"\u7684\u5206\u6570\u6700\u9ad8. \u5c0f\u8282\u603b\u7ed3: \u4e86\u89e3\u4e86BiLSTM\u7f51\u7edc\u7ed3\u6784 \u8bbe\u7f6e\u9690\u85cf\u5c42\u7ef4\u5ea6\u7684\u65f6\u5019, \u9700\u8981\u5c06hidden_size // 2 \u603b\u5171\u67093\u5c42\u9700\u8981\u6784\u5efa, \u5206\u522b\u662f\u8bcd\u5d4c\u5165\u5c42, \u53cc\u5411LSTM\u5c42, \u5168\u8fde\u63a5\u7ebf\u6027\u5c42 \u5728\u4ee3\u7801\u5c42\u9762, \u53cc\u5411LSTM\u5c31\u662f\u5c06nn.LSTM()\u4e2d\u7684\u53c2\u6570bidirectional\u8bbe\u7f6e\u4e3aTrue \u638c\u63e1\u4e86BiLSTM\u7f51\u7edc\u7684\u4ee3\u7801\u5b9e\u73b0 \u6784\u5efa\u7c7bBiLSTM\u7684\u521d\u59cb\u5316\u51fd\u6570 \u6dfb\u52a0\u6587\u672c\u5411\u91cf\u5316\u7684\u8f85\u52a9\u51fd\u6570, \u6ce8\u610fpadding\u586b\u5145\u4e3a\u76f8\u540c\u957f\u5ea6\u7684Tensor \u8981\u6ce8\u610fforward\u51fd\u6570\u4e2d\u4e0d\u540c\u5f20\u91cf\u7684\u5f62\u72b6\u7ea6\u5b9a 6.3 CRF\u4ecb\u7ecd \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3CRF\u7684\u6982\u5ff5\u548c\u4f5c\u7528 \u4e86\u89e3\u8f6c\u79fb\u6982\u7387\u77e9\u9635 \u4e86\u89e3\u53d1\u5c04\u6982\u7387\u77e9\u9635 CRF\u7684\u6982\u5ff5\u548c\u4f5c\u7528: CRF(\u5168\u79f0Conditional Random Fields), \u6761\u4ef6\u968f\u673a\u573a. \u662f\u7ed9\u5b9a\u8f93\u5165\u5e8f\u5217\u7684\u6761\u4ef6\u4e0b, \u6c42\u89e3\u8f93\u51fa\u5e8f\u5217\u7684\u6761\u4ef6\u6982\u7387\u5206\u5e03\u6a21\u578b. \u4e0b\u9762\u4e3e\u4e24\u4e2a\u5e94\u7528\u573a\u666f\u7684\u4f8b\u5b50: \u573a\u666f\u4e00: \u5047\u8bbe\u6709\u4e00\u5806\u65e5\u5e38\u751f\u6d3b\u7684\u7ed9\u5c0f\u670b\u53cb\u6392\u62cd\u7684\u89c6\u9891\u7247\u6bb5, \u53ef\u80fd\u7684\u72b6\u6001\u6709\u7761\u89c9\u3001\u5403\u996d\u3001\u559d\u6c34\u3001\u6d17\u6fa1\u3001\u5237\u7259\u3001\u73a9\u800d\u7b49, \u5927\u90e8\u5206\u60c5\u51b5, \u6211\u4eec\u662f\u80fd\u591f\u8bc6\u522b\u51fa\u89c6\u9891\u7247\u6bb5\u7684\u72b6\u6001. \u4f46\u5982\u679c\u4f60\u53ea\u662f\u770b\u5230\u4e00\u5c0f\u6bb5\u62ff\u676f\u5b50\u7684\u89c6\u9891, \u5728\u6ca1\u6709\u524d\u540e\u76f8\u8fde\u7684\u89c6\u9891\u4f5c\u4e3a\u524d\u540e\u6587\u53c2\u7167\u7684\u60c5\u51b5\u4e0b, \u6211\u4eec\u5f88\u96be\u77e5\u9053\u62ff\u676f\u5b50\u662f\u8981\u5237\u7259\u8fd8\u662f\u559d\u6c34. \u8fd9\u65f6, \u53ef\u4ee5\u7528\u5230CRF\u6a21\u578b. \u573a\u666f\u4e8c: \u5047\u8bbe\u6709\u5206\u597d\u8bcd\u7684\u53e5\u5b50, \u6211\u4eec\u8981\u5224\u65ad\u6bcf\u4e2a\u8bcd\u7684\u8bcd\u6027, \u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e9b\u8bcd\u6765\u8bf4, \u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u76f8\u90bb\u8bcd\u7684\u8bcd\u6027\u7684\u60c5\u51b5\u4e0b, \u662f\u5f88\u96be\u51c6\u786e\u5224\u65ad\u6bcf\u4e2a\u8bcd\u7684\u8bcd\u6027\u7684. \u8fd9\u65f6, \u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u5230CRF. \u57fa\u672c\u5b9a\u4e49: \u6211\u4eec\u5c06\u968f\u673a\u53d8\u91cf\u7684\u96c6\u5408\u79f0\u4e3a\u968f\u673a\u8fc7\u7a0b. \u7531\u4e00\u4e2a\u7a7a\u95f4\u53d8\u91cf\u7d22\u5f15\u7684\u968f\u673a\u8fc7\u7a0b, \u6211\u4eec\u5c06\u5176\u79f0\u4e3a\u968f\u673a\u573a. \u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d, \u505a\u8bcd\u6027\u6807\u6ce8\u65f6, \u53ef\u4ee5\u5c06{\u540d\u8bcd\u3001\u52a8\u8bcd\u3001\u5f62\u5bb9\u8bcd\u3001\u526f\u8bcd}\u8fd9\u4e9b\u8bcd\u6027\u5b9a\u4e49\u4e3a\u968f\u673a\u53d8\u91cf, \u7136\u540e\u4ece\u4e2d\u9009\u62e9\u76f8\u5e94\u7684\u8bcd\u6027, \u800c\u8fd9\u7ec4\u968f\u673a\u53d8\u91cf\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u9075\u5faa\u67d0\u79cd\u6982\u7387\u5206\u5e03, \u5c06\u8fd9\u4e9b\u8bcd\u6027\u6309\u7167\u5bf9\u5e94\u7684\u6982\u7387\u8d4b\u503c\u7ed9\u76f8\u5e94\u7684\u8bcd, \u5c31\u5b8c\u6210\u4e86\u53e5\u5b50\u7684\u8bcd\u6027\u6807\u6ce8. \u5173\u4e8e\u6761\u4ef6\u968f\u673a\u573a\u4e0e\u9a6c\u5c14\u79d1\u592b\u5047\u8bbe: \u524d\u9762\u8bfe\u7a0b\u6211\u4eec\u4ecb\u7ecd\u8fc7\u9a6c\u5c14\u79d1\u592b\u5047\u8bbe, \u4e5f\u5c31\u662f\u5f53\u524d\u4f4d\u7f6e\u7684\u53d6\u503c\u53ea\u548c\u4e0e\u5b83\u76f8\u90bb\u7684\u4f4d\u7f6e\u7684\u503c\u6709\u5173, \u548c\u5b83\u4e0d\u76f8\u90bb\u7684\u4f4d\u7f6e\u7684\u503c\u65e0\u5173. \u5e94\u7528\u5230\u6211\u4eec\u4e0a\u9762\u7684\u8bcd\u6027\u6807\u6ce8\u4f8b\u5b50\u4e2d, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u8bcd\u7684\u8bcd\u6027\u662f\u6839\u636e\u524d\u4e00\u4e2a\u8bcd\u548c\u540e\u4e00\u4e2a\u8bcd\u7684\u8bcd\u6027\u6765\u51b3\u5b9a\u7684, \u7b49\u6548\u4e8e\u4ece\u8bcd\u6027\u524d\u540e\u6587\u7684\u6982\u7387\u6765\u7ed9\u51fa\u5f53\u524d\u8bcd\u7684\u8bcd\u6027\u5224\u65ad\u7ed3\u679c. \u73b0\u5b9e\u4e2d\u53ef\u4ee5\u505a\u5982\u4e0b\u5047\u8bbe: \u5047\u8bbe\u4e00\u4e2a\u52a8\u8bcd\u6216\u8005\u526f\u8bcd\u540e\u9762\u4e0d\u4f1a\u8fde\u63a5\u540c\u6837\u7684\u52a8\u8bcd\u6216\u8005\u526f\u8bcd, \u8fd9\u6837\u7684\u6982\u7387\u5f88\u9ad8. \u90a3\u4e48, \u53ef\u4ee5\u5047\u5b9a\u8fd9\u79cd\u7ed9\u5b9a\u9690\u85cf\u72b6\u6001(\u4e5f\u5c31\u662f\u8bcd\u6027\u5e8f\u5217)\u7684\u60c5\u51b5\u4e0b, \u6765\u8ba1\u7b97\u89c2\u6d4b\u72b6\u6001\u7684\u8ba1\u7b97\u8fc7\u7a0b. \u672c\u8d28\u4e0aCRF\u6a21\u578b\u8003\u8651\u5230\u4e86\u89c2\u6d4b\u72b6\u6001\u8fd9\u4e2a\u5148\u9a8c\u6761\u4ef6, \u8fd9\u4e5f\u662f\u6761\u4ef6\u968f\u673a\u573a\u4e2d\u7684\u6761\u4ef6\u4e00\u8bcd\u7684\u542b\u4e49. \u8f6c\u79fb\u6982\u7387\u77e9\u9635: \u9996\u5148\u5047\u8bbe\u6211\u4eec\u9700\u8981\u6807\u6ce8\u7684\u5b9e\u4f53\u7c7b\u578b\u6709\u4e00\u4e0b\u51e0\u7c7b\uff1a {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4} # \u5176\u4e2ddis\u8868\u793a\u75be\u75c5(disease), sym\u8868\u793a\u75c7\u72b6(symptom), B\u8868\u793a\u547d\u540d\u5b9e\u4f53\u5f00\u5934, I\u8868\u793a\u547d\u540d\u5b9e\u4f53\u4e2d\u95f4\u5230\u7ed3\u5c3e, O\u8868\u793a\u5176\u4ed6\u7c7b\u578b. \u56e0\u6b64\u6211\u4eec\u5f88\u5bb9\u6613\u77e5\u9053\u6bcf\u4e2a\u5b57\u7684\u53ef\u80fd\u6807\u6ce8\u7c7b\u578b\u6709\u4ee5\u4e0a\u4e94\u79cd\u53ef\u80fd\u6027, \u90a3\u4e48\u5728\u4e00\u4e2a\u53e5\u5b50\u4e2d, \u7531\u4e0a\u4e00\u4e2a\u5b57\u5230\u4e0b\u4e00\u4e2a\u5b57\u7684\u6982\u7387\u4e58\u79ef\u5c31\u67095 \u00d7 5\u79cd\u53ef\u80fd\u6027, \u5177\u4f53\u89c1\u4e0b\u56fe\u6240\u793a: \u6700\u7ec8\u8bad\u7ec3\u51fa\u6765\u7ed3\u679c\u5927\u81f4\u4f1a\u5982\u4e0a\u56fe\u6240\u793a, \u5176\u4e2d\u4e0b\u6807\u7d22\u5f15\u4e3a(i, j)\u7684\u65b9\u683c\u4ee3\u8868\u5982\u679c\u5f53\u524d\u5b57\u7b26\u662f\u7b2ci\u884c\u8868\u793a\u7684\u6807\u7b7e, \u90a3\u4e48\u4e0b\u4e00\u4e2a\u5b57\u7b26\u8868\u793a\u7b2cj\u5217\u8868\u793a\u7684\u6807\u7b7e\u6240\u5bf9\u5e94\u7684\u6982\u7387\u503c. \u4ee5\u7b2c\u4e8c\u884c\u4e3a\u4f8b, \u5047\u8bbe\u5f53\u524d\u7b2ci\u4e2a\u5b57\u7684\u6807\u7b7e\u4e3aB-dis, \u90a3\u4e48\u7b2ci+1\u4e2a\u5b57\u6700\u5927\u53ef\u80fd\u51fa\u73b0\u7684\u6982\u7387\u5e94\u8be5\u662fI-dis. \u53d1\u5c04\u6982\u7387\u77e9\u9635: \u53d1\u5c04\u6982\u7387, \u662f\u6307\u5df2\u77e5\u5f53\u524d\u6807\u7b7e\u7684\u60c5\u51b5\u4e0b, \u5bf9\u5e94\u6240\u51fa\u73b0\u5b57\u7b26\u7684\u6982\u7387. \u901a\u4fd7\u7406\u89e3\u5c31\u662f\u5f53\u524d\u6807\u7b7e\u6bd4\u8f83\u53ef\u80fd\u51fa\u73b0\u7684\u6587\u5b57\u6709\u54ea\u4e9b, \u53ca\u5176\u5bf9\u5e94\u51fa\u73b0\u7684\u6982\u7387. \u4e0b\u9762\u662f\u51e0\u6bb5\u533b\u7597\u6587\u672c\u6570\u636e\u7684\u6807\u6ce8\u7ed3\u679c: \u53ef\u4ee5\u5f97\u5230\u4ee5\u4e0a\u53e5\u5b50\u7684\u8f6c\u79fb\u77e9\u9635\u6982\u7387\u5982\u4e0b\uff1a \u5bf9\u5e94\u7684\u53d1\u5c04\u77e9\u9635\u53ef\u4ee5\u7406\u89e3\u4e3a\u5982\u4e0b\u56fe\u6240\u793a\u7ed3\u679c\uff1a \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86CRF\u7684\u6982\u5ff5\u548c\u4f5c\u7528 \u6982\u5ff5: \u6761\u4ef6\u968f\u673a\u573a, \u4e00\u79cd\u6761\u4ef6\u6982\u7387\u5206\u5e03\u6a21\u578b \u4f5c\u7528: \u589e\u52a0\u4e86\u5148\u9a8c\u6761\u4ef6, \u53ef\u4ee5\u66f4\u597d\u7684\u5b8c\u6210\u5b9e\u4f53\u5e8f\u5217\u7684\u8bc6\u522b \u5b66\u4e60\u4e86\u8f6c\u79fb\u6982\u7387\u77e9\u9635 \u5b66\u4e60\u4e86\u53d1\u5c04\u6982\u7387\u77e9\u9635 6.4 BiLSTM+CRF\u6a21\u578b \u5b66\u4e60\u76ee\u6807: \u638c\u63e1BiLSTM+CRF\u6a21\u578b\u7ed3\u6784 \u638c\u63e1\u635f\u5931\u51fd\u6570\u7684\u5b9a\u4e49 \u638c\u63e1BiLSTM_CRF\u6a21\u578b\u7684\u5b9e\u73b0 BiLSTM+CRF\u6a21\u578b\u7ed3\u6784: 1, \u6a21\u578b\u7684\u6807\u7b7e\u5b9a\u4e49\u4e0e\u6574\u4f53\u67b6\u6784 2, \u6a21\u578b\u5185\u90e8\u7684\u5206\u5c42\u5c55\u5f00 3, CRF\u5c42\u7684\u4f5c\u7528 1, \u6a21\u578b\u7684\u6807\u7b7e\u5b9a\u4e49\u4e0e\u6574\u4f53\u67b6\u6784: \u5047\u8bbe\u6211\u4eec\u7684\u6570\u636e\u96c6\u4e2d\u6709\u4e24\u7c7b\u5b9e\u4f53-\u4eba\u540d, \u5730\u540d, \u4e0e\u4e4b\u5bf9\u5e94\u7684\u5728\u8bad\u7ec3\u96c6\u4e2d\u67095\u7c7b\u6807\u7b7e\u5982\u4e0b\u6240\u793a: B-Person, I-Person, B-Organization, I-Organization, O # B-Person: \u4eba\u540d\u7684\u5f00\u59cb # I-Person: \u4eba\u540d\u7684\u4e2d\u95f4\u90e8\u5206 # B-Organization: \u5730\u540d\u7684\u5f00\u59cb # I-Organization: \u5730\u540d\u7684\u4e2d\u95f4\u90e8\u5206 # O: \u5176\u4ed6\u975e\u4eba\u540d, \u975e\u5730\u540d\u7684\u6807\u7b7e \u5047\u8bbe\u4e00\u4e2a\u53e5\u5b50\u67095\u4e2a\u5355\u8bcd\u6784\u6210, (w0, w1, w2, w3, w4), \u6bcf\u4e00\u4e2a\u5355\u5143\u90fd\u4ee3\u8868\u7740\u7531\u5b57\u5d4c\u5165\u6784\u6210\u7684\u5411\u91cf. \u5176\u4e2d\u5b57\u5d4c\u5165\u662f\u968f\u673a\u521d\u59cb\u5316\u7684, \u8bcd\u5d4c\u5165\u662f\u901a\u8fc7\u6570\u636e\u8bad\u7ec3\u5f97\u5230\u7684, \u6240\u6709\u7684\u5d4c\u5165\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u90fd\u4f1a\u8c03\u6574\u5230\u6700\u4f18\u89e3. \u8fd9\u4e9b\u5b57\u5d4c\u5165\u6216\u8bcd\u5d4c\u5165\u4f5c\u4e3aBiLSTM+CRF\u6a21\u578b\u7684\u8f93\u5165, \u800c\u8f93\u51fa\u7684\u662f\u53e5\u5b50\u4e2d\u6bcf\u4e2a\u5355\u5143\u7684\u6807\u7b7e. 2, \u6a21\u578b\u5185\u90e8\u7684\u5206\u5c42\u5c55\u5f00: \u6574\u4e2a\u6a21\u578b\u660e\u663e\u6709\u4e24\u5c42, \u7b2c\u4e00\u5c42\u662fBiLSTM\u5c42, \u7b2c\u4e8c\u5c42\u662fCRF\u5c42, \u5c06\u5c42\u7684\u5185\u90e8\u5c55\u5f00\u5982\u4e0b\u56fe\u6240\u793a: BiLSTM\u5c42\u7684\u8f93\u51fa\u4e3a\u6bcf\u4e00\u4e2a\u6807\u7b7e\u7684\u9884\u6d4b\u5206\u503c, \u4f8b\u5982\u5bf9\u4e8e\u5355\u8bcdw0, BiLSTM\u5c42\u8f93\u51fa\u662f 1.5 (B-Person), 0.9 (I-Person), 0.1 (B-Organization), 0.08 (I-Organization), 0.05 (O) \u8fd9\u4e9b\u5206\u503c\u5c06\u4f5c\u4e3aCRF\u5c42\u7684\u8f93\u5165. 3, CRF\u5c42\u7684\u4f5c\u7528: \u5982\u679c\u6ca1\u6709CRF\u5c42, \u4e5f\u53ef\u4ee5\u8bad\u7ec3\u4e00\u4e2aBiLSTM\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u6a21\u578b, \u5982\u4e0b\u56fe\u6240\u793a: \u7531\u4e8eBiLSTM\u7684\u8f93\u51fa\u4e3a\u5355\u5143\u7684\u6bcf\u4e00\u4e2a\u6807\u7b7e\u5206\u503c, \u6211\u4eec\u53ef\u4ee5\u6311\u9009\u5206\u503c\u6700\u9ad8\u7684\u4e00\u4e2a\u4f5c\u4e3a\u8be5\u5355\u5143\u7684\u6807\u7b7e.\u4f8b\u5982, \u5bf9\u4e8e\u5355\u8bcdw0, \"B-Person\"\u7684\u5206\u503c-1.5\u662f\u6240\u6709\u6807\u7b7e\u5f97\u5206\u4e2d\u6700\u9ad8\u7684, \u56e0\u6b64\u53ef\u4ee5\u6311\u9009\"B-Person\"\u4f5c\u4e3a\u5355\u8bcdw0\u7684\u9884\u6d4b\u6807\u7b7e. \u540c\u7406, \u53ef\u4ee5\u5f97\u5230w1 - \"I-Person\", w2 - \"O\", w3 - \"B-Organization\", w4 - \"O\" \u867d\u7136\u6309\u7167\u4e0a\u8ff0\u65b9\u6cd5, \u5728\u6ca1\u6709CRF\u5c42\u7684\u6761\u4ef6\u4e0b\u6211\u4eec\u4e5f\u53ef\u4ee5\u5f97\u5230x\u4e2d\u6bcf\u4e2a\u5355\u5143\u7684\u9884\u6d4b\u6807\u7b7e, \u4f46\u662f\u4e0d\u80fd\u4fdd\u8bc1\u6807\u7b7e\u7684\u9884\u6d4b\u6bcf\u6b21\u90fd\u662f\u6b63\u786e\u7684. \u5982\u679c\u51fa\u73b0\u4e0b\u56fe\u7684BiLSTM\u5c42\u8f93\u51fa\u7ed3\u679c, \u5219\u660e\u663e\u9884\u6d4b\u662f\u9519\u8bef\u7684. CRF\u5c42\u80fd\u4ece\u8bad\u7ec3\u6570\u636e\u4e2d\u83b7\u5f97\u7ea6\u675f\u6027\u7684\u89c4\u5219. CRF\u5c42\u53ef\u4ee5\u4e3a\u6700\u540e\u9884\u6d4b\u7684\u6807\u7b7e\u6dfb\u52a0\u4e00\u4e9b\u7ea6\u675f\u6765\u4fdd\u8bc1\u9884\u6d4b\u7684\u6807\u7b7e\u662f\u5408\u6cd5\u7684. \u5728\u8bad\u7ec3\u6570\u636e\u8bad\u7ec3\u7684\u8fc7\u7a0b\u4e2d, \u8fd9\u4e9b\u7ea6\u675f\u53ef\u4ee5\u901a\u8fc7CRF\u5c42\u81ea\u52a8\u5b66\u4e60\u5230. 1: \u53e5\u5b50\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8bcd\u603b\u662f\u4ee5\u6807\u7b7e\"B-\"\u6216\u8005\"O\"\u5f00\u59cb, \u800c\u4e0d\u662f\"I-\"\u5f00\u59cb. 2: \u6807\u7b7e\"B-label1 I-label2 I-label3 ......\", \u5176\u4e2d\u7684label1, label2, label3\u5e94\u8be5\u5c5e\u4e8e\u540c\u4e00\u7c7b\u5b9e\u4f53. \u6bd4\u5982, \"B-Person I-Person\"\u662f\u5408\u6cd5\u7684\u5e8f\u5217, \u4f46\u662f\"B-Person I-Organization\"\u662f\u975e\u6cd5\u7684\u5e8f\u5217. 3: \u6807\u7b7e\u5e8f\u5217\"O I-label\"\u662f\u975e\u6cd5\u5e8f\u5217, \u4efb\u610f\u5b9e\u4f53\u6807\u7b7e\u7684\u9996\u4e2a\u6807\u7b7e\u5e94\u8be5\u662f\"B-\", \u800c\u4e0d\u662f\"I-\". \u6bd4\u5982, \"O B-label\"\u624d\u662f\u5408\u6cd5\u7684\u5e8f\u5217 \u6709\u4e86\u4e0a\u8ff0\u8fd9\u4e9b\u7ea6\u675f, \u6807\u7b7e\u5e8f\u5217\u7684\u9884\u6d4b\u4e2d\u975e\u6cd5\u5e8f\u5217\u51fa\u73b0\u7684\u6982\u7387\u5c06\u4f1a\u5927\u5927\u964d\u4f4e. \u635f\u5931\u51fd\u6570\u7684\u5b9a\u4e49: BiLSTM\u5c42\u7684\u8f93\u51fa\u7ef4\u5ea6\u662ftag_size, \u4e5f\u5c31\u662f\u6bcf\u4e2a\u5355\u8bcdw_i\u6620\u5c04\u5230tag\u7684\u53d1\u5c04\u6982\u7387\u503c, \u5047\u8bbeBiLSTM\u7684\u8f93\u51fa\u77e9\u9635\u662fP, \u5176\u4e2dP(i,j)\u4ee3\u8868\u5355\u8bcdw_i\u6620\u5c04\u5230tag_j\u7684\u975e\u5f52\u4e00\u5316\u6982\u7387. \u5bf9\u4e8eCRF\u5c42, \u5047\u8bbe\u5b58\u5728\u4e00\u4e2a\u8f6c\u79fb\u77e9\u9635A, \u5176\u4e2dA(i,j)\u4ee3\u8868tag_j\u8f6c\u79fb\u5230tag_i\u7684\u6982\u7387. \u5bf9\u4e8e\u8f93\u5165\u5e8f\u5217X\u5bf9\u5e94\u7684\u8f93\u51fatag\u5e8f\u5217y, \u5b9a\u4e49\u5206\u6570\u5982\u4e0b(\u672c\u8d28\u4e0a\u5c31\u662f\u53d1\u5c04\u6982\u7387\u548c\u8f6c\u79fb\u6982\u7387\u7684\u7d2f\u52a0\u548c): \u5229\u7528softmax\u51fd\u6570, \u4e3a\u6bcf\u4e00\u4e2a\u6b63\u786e\u7684tag\u5e8f\u5217y\u5b9a\u4e49\u4e00\u4e2a\u6982\u7387\u503c, \u5728\u771f\u5b9e\u7684\u8bad\u7ec3\u4e2d, \u53ea\u9700\u8981\u6700\u5927\u5316\u4f3c\u7136\u6982\u7387p(y|X)\u5373\u53ef, \u5177\u4f53\u4f7f\u7528\u5bf9\u6570\u4f3c\u7136\u5982\u4e0b: BiLSTM+CRF\u6a21\u578b\u7684\u5b9e\u73b0: \u7b2c\u4e00\u6b65: \u6784\u5efa\u795e\u7ecf\u7f51\u7edc \u7b2c\u4e8c\u6b65: \u6587\u672c\u4fe1\u606f\u5f20\u91cf\u5316 \u7b2c\u4e09\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e00\u9879\u7684\u5206\u503c \u7b2c\u56db\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e8c\u9879\u7684\u5206\u503c \u7b2c\u4e94\u6b65: \u7ef4\u7279\u6bd4\u7b97\u6cd5\u7684\u5b9e\u73b0 \u7b2c\u516d\u6b65: \u5b8c\u5584BiLSTM_CRF\u7c7b\u7684\u5168\u90e8\u529f\u80fd \u7b2c\u4e00\u6b65: \u6784\u5efa\u795e\u7ecf\u7f51\u7edc # \u5bfc\u5165\u76f8\u5173\u5305\u4e0e\u6a21\u5757 import torch import torch.nn as nn class BiLSTM_CRF(nn.Module): def __init__(self, vocab_size, tag_to_ix, embedding_dim, hidden_dim, num_layers, batch_size, sequence_length): ''' description: \u6a21\u578b\u521d\u59cb\u5316 :param vocab_size: \u6240\u6709\u53e5\u5b50\u5305\u542b\u5b57\u7b26\u5927\u5c0f :param tag_to_ix: \u6807\u7b7e\u4e0eid\u5bf9\u7167\u5b57\u5178 :param embedding_dim: \u5b57\u5d4c\u5165\u7ef4\u5ea6(\u5373LSTM\u8f93\u5165\u5c42\u7ef4\u5ea6input_size) :param hidden_dim: \u9690\u85cf\u5c42\u5411\u91cf\u7ef4\u5ea6 :param num_layers: \u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 :param batch_size: \u6279\u6b21\u7684\u6570\u91cf :param sequence_length: \u8bed\u53e5\u7684\u9650\u5236\u6700\u5927\u957f\u5ea6 ''' # \u7ee7\u627f\u51fd\u6570\u7684\u521d\u59cb\u5316 super(BiLSTM_CRF, self).__init__() # \u8bbe\u7f6e\u6807\u7b7e\u4e0eid\u5bf9\u7167 self.tag_to_ix = tag_to_ix # \u8bbe\u7f6e\u6807\u7b7e\u5927\u5c0f\uff0c\u5bf9\u5e94 BiLSTM \u6700\u7ec8\u8f93\u51fa\u5206\u6570\u77e9\u9635\u5bbd\u5ea6 self.tagset_size = len(tag_to_ix) # \u8bbe\u5b9a LSTM \u8f93\u5165\u7279\u5f81\u5927\u5c0f self.embedding_dim = embedding_dim # \u8bbe\u7f6e\u9690\u85cf\u5c42\u7ef4\u5ea6 self.hidden_dim = hidden_dim # \u8bbe\u7f6e\u5355\u8bcd\u603b\u6570\u7684\u5927\u5c0f self.vocab_size = vocab_size # \u8bbe\u7f6e\u9690\u85cf\u5c42\u7684\u6570\u91cf self.num_layers = num_layers # \u8bbe\u7f6e\u8bed\u53e5\u7684\u6700\u5927\u9650\u5236\u957f\u5ea6 self.sequence_length = sequence_length # \u8bbe\u7f6e\u6279\u6b21\u7684\u5927\u5c0f self.batch_size = batch_size # \u6784\u5efa\u8bcd\u5d4c\u5165\u5c42, \u4e24\u4e2a\u53c2\u6570\u5206\u522b\u662f\u5355\u8bcd\u603b\u6570, \u8bcd\u5d4c\u5165\u7ef4\u5ea6 self.word_embeds = nn.Embedding(vocab_size, embedding_dim) # \u6784\u5efa\u53cc\u5411LSTM\u5c42, \u8f93\u5165\u53c2\u6570\u5305\u62ec\u8bcd\u5d4c\u5165\u7ef4\u5ea6, \u9690\u85cf\u5c42\u5927\u5c0f, \u5806\u53e0\u7684LSTM\u5c42\u6570, \u662f\u5426\u53cc\u5411\u6807\u5fd7\u4f4d self.lstm = nn.LSTM(embedding_dim, hidden_dim // 2, num_layers=self.num_layers, bidirectional=True) # \u6784\u5efa\u5168\u8fde\u63a5\u7ebf\u6027\u5c42, \u4e00\u7aef\u5bf9\u63a5LSTM\u9690\u85cf\u5c42, \u53e6\u4e00\u7aef\u5bf9\u63a5\u8f93\u51fa\u5c42, \u76f8\u5e94\u7684\u7ef4\u5ea6\u5c31\u662f\u6807\u7b7e\u6570\u91cftagset_size self.hidden2tag = nn.Linear(hidden_dim, self.tagset_size) # \u521d\u59cb\u5316\u8f6c\u79fb\u77e9\u9635, \u8f6c\u79fb\u77e9\u9635\u662f\u4e00\u4e2a\u65b9\u9635[tagset_size, tagset_size] self.transitions = nn.Parameter(torch.randn(self.tagset_size, self.tagset_size)) # \u6309\u7167\u635f\u5931\u51fd\u6570\u5c0f\u8282\u7684\u5b9a\u4e49, \u4efb\u610f\u7684\u5408\u6cd5\u53e5\u5b50\u4e0d\u4f1a\u8f6c\u79fb\u5230\"START_TAG\", \u56e0\u6b64\u8bbe\u7f6e\u4e3a-10000 # \u540c\u7406, \u4efb\u610f\u5408\u6cd5\u7684\u53e5\u5b50\u4e0d\u4f1a\u4ece\"STOP_TAG\"\u7ee7\u7eed\u5411\u4e0b\u8f6c\u79fb, \u4e5f\u8bbe\u7f6e\u4e3a-10000 self.transitions.data[tag_to_ix[START_TAG], :] = -10000 self.transitions.data[:, tag_to_ix[STOP_TAG]] = -10000 # \u521d\u59cb\u5316\u9690\u85cf\u5c42, \u5229\u7528\u5355\u72ec\u7684\u7c7b\u51fd\u6570init_hidden()\u6765\u5b8c\u6210 self.hidden = self.init_hidden() # \u5b9a\u4e49\u7c7b\u5185\u90e8\u4e13\u95e8\u7528\u4e8e\u521d\u59cb\u5316\u9690\u85cf\u5c42\u7684\u51fd\u6570 def init_hidden(self): # \u4e3a\u4e86\u7b26\u5408LSTM\u7684\u8f93\u5165\u8981\u6c42, \u6211\u4eec\u8fd4\u56deh0, c0, \u8fd9\u4e24\u4e2a\u5f20\u91cf\u7684shape\u5b8c\u5168\u4e00\u81f4 # \u9700\u8981\u6ce8\u610f\u7684\u662fshape: [2 * num_layers, batch_size, hidden_dim / 2] return (torch.randn(2 * self.num_layers, self.batch_size, self.hidden_dim // 2), torch.randn(2 * self.num_layers, self.batch_size, self.hidden_dim // 2)) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: # \u5f00\u59cb\u5b57\u7b26\u548c\u7ed3\u675f\u5b57\u7b26 START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u5b57\u7b26\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 char_to_id = {\"\u53cc\": 0, \"\u80ba\": 1, \"\u89c1\": 2, \"\u591a\": 3, \"\u53d1\": 4, \"\u6591\": 5, \"\u7247\": 6, \"\u72b6\": 7, \"\u7a0d\": 8, \"\u9ad8\": 9, \"\u5bc6\": 10, \"\u5ea6\": 11, \"\u5f71\": 12, \"\u3002\": 13} \u8c03\u7528: model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, sequence_length=SENTENCE_LENGTH) print(model) \u8f93\u51fa\u6548\u679c: BiLSTM( (word_embeds): Embedding(14, 200) (lstm): LSTM(200, 50, bidirectional=True) (hidden2tag): Linear(in_features=100, out_features=7, bias=True) ) \u7b2c\u4e8c\u6b65: \u6587\u672c\u4fe1\u606f\u5f20\u91cf\u5316 # \u51fd\u6570sentence_map\u5b8c\u6210\u4e2d\u6587\u6587\u672c\u4fe1\u606f\u7684\u6570\u5b57\u7f16\u7801, \u53d8\u6210\u5f20\u91cf def sentence_map(sentence_list, char_to_id, max_length): # \u5bf9\u4e00\u4e2a\u6279\u6b21\u7684\u6240\u6709\u8bed\u53e5\u6309\u7167\u957f\u77ed\u8fdb\u884c\u6392\u5e8f, \u6b64\u6b65\u9aa4\u975e\u5fc5\u987b sentence_list.sort(key=lambda c:len(c), reverse=True) # \u5b9a\u4e49\u4e00\u4e2a\u6700\u7ec8\u5b58\u50a8\u7ed3\u679c\u7279\u5f81\u5411\u91cf\u7684\u7a7a\u5217\u8868 sentence_map_list = [] # \u5faa\u73af\u904d\u5386\u4e00\u4e2a\u6279\u6b21\u5185\u7684\u6240\u6709\u8bed\u53e5 for sentence in sentence_list: # \u91c7\u7528\u5217\u8868\u751f\u6210\u5f0f\u5b8c\u6210\u5b57\u7b26\u5230id\u7684\u6620\u5c04 sentence_id_list = [char_to_id[c] for c in sentence] # \u957f\u5ea6\u4e0d\u591f\u7684\u90e8\u5206\u75280\u586b\u5145 padding_list = [0] * (max_length-len(sentence)) # \u5c06\u6bcf\u4e00\u4e2a\u8bed\u53e5\u5411\u91cf\u6269\u5145\u6210\u76f8\u540c\u957f\u5ea6\u7684\u5411\u91cf sentence_id_list.extend(padding_list) # \u8ffd\u52a0\u8fdb\u6700\u7ec8\u5b58\u50a8\u7ed3\u679c\u7684\u5217\u8868\u4e2d sentence_map_list.append(sentence_id_list) # \u8fd4\u56de\u4e00\u4e2a\u6807\u91cf\u7c7b\u578b\u503c\u7684\u5f20\u91cf return torch.tensor(sentence_map_list, dtype=torch.long) # \u5728\u7c7b\u4e2d\u5c06\u6587\u672c\u4fe1\u606f\u7ecf\u8fc7\u8bcd\u5d4c\u5165\u5c42, BiLSTM\u5c42, \u7ebf\u6027\u5c42\u7684\u5904\u7406, \u6700\u7ec8\u8f93\u51fa\u53e5\u5b50\u5f20\u91cf def _get_lstm_features(self, sentence): self.hidden = self.init_hidden() # a = self.word_embeds(sentence) # print(a.shape) torch.Size([8, 20, 200]) # LSTM\u7684\u8f93\u5165\u8981\u6c42\u5f62\u72b6\u4e3a [sequence_length, batch_size, embedding_dim] # LSTM\u7684\u9690\u85cf\u5c42h0\u8981\u6c42\u5f62\u72b6\u4e3a [num_layers * direction, batch_size, hidden_dim] embeds = self.word_embeds(sentence).view(self.sequence_length, self.batch_size, -1) # LSTM\u7684\u4e24\u4e2a\u8f93\u5165\u53c2\u6570: \u8bcd\u5d4c\u5165\u540e\u7684\u5f20\u91cf, \u968f\u673a\u521d\u59cb\u5316\u7684\u9690\u85cf\u5c42\u5f20\u91cf lstm_out, self.hidden = self.lstm(embeds, self.hidden) # \u8981\u4fdd\u8bc1\u8f93\u51fa\u5f20\u91cf\u7684shape: [sequence_length, batch_size, hidden_dim] lstm_out = lstm_out.view(self.sequence_length, self.batch_size, self.hidden_dim) # \u5c06BiLSTM\u7684\u8f93\u51fa\u7ecf\u8fc7\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42, \u5f97\u5230\u8f93\u51fa\u5f20\u91cfshape:[sequence_length, batch_size, tagset_size] lstm_feats = self.hidden2tag(lstm_out) return lstm_feats \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] \u8c03\u7528: char_to_id = {\"<PAD>\":0} if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) print(\"sentence_sequence:\\n\", sentence_sequence) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) sentence_features = model._get_lstm_features(sentence_sequence) print(\"sequence_features:\\n\", sentence_features) \u8f93\u51fa\u6548\u679c: sentence_sequence: tensor([[14, 15, 16, 17, 18, 16, 19, 20, 21, 13, 22, 23, 24, 25, 26, 27, 28, 29, 30, 0], [14, 15, 26, 27, 18, 49, 50, 12, 21, 13, 22, 51, 52, 25, 53, 54, 55, 29, 30, 0], [14, 15, 53, 56, 18, 49, 50, 18, 26, 27, 57, 58, 59, 22, 51, 52, 55, 29, 0, 0], [37, 63, 64, 65, 66, 55, 13, 22, 61, 51, 52, 25, 67, 68, 69, 70, 71, 13, 0, 0], [37, 38, 39, 7, 8, 40, 41, 42, 43, 44, 45, 46, 47, 48, 0, 0, 0, 0, 0, 0], [16, 17, 18, 53, 56, 12, 59, 60, 22, 61, 51, 52, 12, 62, 0, 0, 0, 0, 0, 0], [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 0, 0, 0, 0, 0, 0, 0], [31, 32, 24, 33, 34, 35, 36, 13, 30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]) sequence_features: tensor([[[ 0.5118, 0.0895, -0.2030, ..., -0.2605, -0.2138, -0.0192], [ 0.1473, -0.0844, -0.1976, ..., -0.0260, -0.1921, 0.0378], [-0.2201, 0.0790, -0.0173, ..., 0.1551, -0.0899, 0.2035], ..., [-0.2387, 0.4015, -0.1882, ..., -0.0473, -0.0399, -0.2642], [ 0.1203, 0.2065, 0.0764, ..., 0.1412, -0.0817, 0.1800], [ 0.0362, 0.1477, -0.0596, ..., 0.1640, -0.0790, 0.0359]], [[ 0.1481, -0.0057, -0.1339, ..., 0.0348, -0.1515, 0.0797], [ 0.1469, 0.0430, -0.1578, ..., -0.0599, -0.1647, 0.2721], [-0.1601, 0.2572, 0.0821, ..., 0.0455, -0.0430, 0.2123], ..., [-0.0230, 0.3032, -0.2572, ..., -0.1670, -0.0009, -0.1256], [-0.0643, 0.1889, 0.0266, ..., -0.1044, -0.2333, 0.1548], [ 0.1969, 0.4262, -0.0194, ..., 0.1344, 0.0094, -0.0583]], [[ 0.2893, -0.0850, -0.1214, ..., 0.0855, 0.0234, 0.0684], [-0.0185, 0.0532, -0.1170, ..., 0.2265, -0.0688, 0.2116], [-0.0882, -0.0393, -0.0658, ..., 0.0006, -0.1219, 0.1954], ..., [ 0.0035, 0.0627, -0.1165, ..., -0.1742, -0.1552, -0.0772], [-0.1099, 0.2375, -0.0568, ..., -0.0636, -0.1998, 0.1747], [ 0.1005, 0.3047, -0.0009, ..., 0.1359, -0.0076, -0.1088]], ..., [[ 0.3587, 0.0157, -0.1612, ..., 0.0327, -0.3009, -0.2104], [ 0.2939, -0.1935, -0.1481, ..., 0.0349, -0.1136, 0.0226], [ 0.1832, -0.0890, -0.3369, ..., 0.0113, -0.1601, -0.1295], ..., [ 0.1462, 0.0905, -0.1082, ..., 0.1253, -0.0416, -0.0082], [ 0.2161, 0.0444, 0.0300, ..., 0.2624, -0.0970, 0.0016], [-0.0896, -0.0905, -0.1790, ..., 0.0711, -0.0477, -0.1236]], [[ 0.2954, 0.0616, -0.0810, ..., -0.0213, -0.1283, -0.1051], [-0.0038, -0.1580, -0.0555, ..., -0.1327, -0.1139, 0.2161], [ 0.1022, 0.1964, -0.1896, ..., -0.1081, -0.1491, -0.1872], ..., [ 0.3404, -0.0456, -0.2569, ..., 0.0701, -0.1644, -0.0731], [ 0.4573, 0.1885, -0.0779, ..., 0.1605, -0.1966, -0.0589], [ 0.1448, -0.1581, -0.3021, ..., 0.0837, -0.0334, -0.2364]], [[ 0.3556, 0.0299, -0.1570, ..., 0.0512, -0.3286, -0.2882], [ 0.2074, -0.1521, -0.1487, ..., 0.0637, -0.2674, -0.0174], [ 0.0976, -0.0754, -0.2779, ..., -0.1588, -0.2096, -0.3432], ..., [ 0.4961, 0.0583, -0.2965, ..., 0.0363, -0.2933, -0.1551], [ 0.4594, 0.3354, -0.0093, ..., 0.1681, -0.2508, -0.1423], [ 0.0957, -0.0486, -0.2616, ..., 0.0578, -0.0737, -0.2259]]], grad_fn=<AddBackward0>) \u7b2c\u4e09\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e00\u9879\u7684\u5206\u503c # \u82e5\u5e72\u8f85\u52a9\u51fd\u6570, \u5728\u7c7bBiLSTM\u5916\u90e8\u5b9a\u4e49, \u76ee\u7684\u662f\u8f85\u52a9log_sum_exp()\u51fd\u6570\u7684\u8ba1\u7b97 # \u5c06Variable\u7c7b\u578b\u53d8\u91cf\u5185\u90e8\u7684\u771f\u5b9e\u503c, \u4ee5python float\u7c7b\u578b\u8fd4\u56de def to_scalar(var): # var\u662fVariable, \u7ef4\u5ea6\u662f\uff11 # \u8fd4\u56de\u4e00\u4e2apython float\u7c7b\u578b\u7684\u503c return var.view(-1).data.tolist()[0] # \u83b7\u53d6\u6700\u5927\u503c\u7684\u4e0b\u6807 def argmax(vec): # \u8fd4\u56de\u5217\u7684\u7ef4\u5ea6\u4e0a\u7684\u6700\u5927\u503c\u4e0b\u6807, \u6b64\u4e0b\u6807\u662f\u4e00\u4e2a\u6807\u91cffloat _, idx = torch.max(vec, 1) return to_scalar(idx) # \u8f85\u52a9\u5b8c\u6210\u635f\u5931\u51fd\u6570\u4e2d\u7684\u516c\u5f0f\u8ba1\u7b97 def log_sum_exp(vec): # vec\u662f1 * 7, type\u662fVariable max_score = vec[0, argmax(vec)] #max_score\u7ef4\u5ea6\u662f1, max_score.view(1,-1)\u7ef4\u5ea6\u662f1 * 1, max_score.view(1, -1).expand(1, vec.size()[1])\u7684\u7ef4\u5ea61 * 7 # \u7ecf\u8fc7expand()\u4e4b\u540e\u7684\u5f20\u91cf, \u91cc\u9762\u6240\u6709\u7684\u503c\u90fd\u76f8\u540c, \u90fd\u662f\u6700\u5927\u503cmax_score max_score_broadcast = max_score.view(1, -1).expand(1, vec.size()[1]) # vec.size()\u7ef4\u5ea6\u662f1 * 7 # \u5148\u51cf\u53bbmax_score,\u6700\u540e\u518d\u52a0\u4e0amax_score, \u662f\u4e3a\u4e86\u9632\u6b62\u6570\u503c\u7206\u70b8, \u7eaf\u7cb9\u662f\u4ee3\u7801\u4e0a\u7684\u5c0f\u6280\u5de7 return max_score + torch.log(torch.sum(torch.exp(vec - max_score_broadcast))) # \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e00\u9879\u7684\u5206\u503c\u51fd\u6570, \u672c\u8d28\u4e0a\u662f\u53d1\u5c04\u77e9\u9635\u548c\u8f6c\u79fb\u77e9\u9635\u7684\u7d2f\u52a0\u548c def _forward_alg(self, feats): # \u521d\u59cb\u5316\u4e00\u4e2aalphas\u5f20\u91cf, \u4ee3\u8868\u8f6c\u79fb\u77e9\u9635\u7684\u8d77\u59cb\u4f4d\u7f6e init_alphas = torch.full((1, self.tagset_size), -10000.) # init_alphas: [1, 7] , [-10000, -10000, -10000, -10000, -10000, -10000, -10000] # \u4ec5\u4ec5\u628aSTART_TAG\u8d4b\u503c\u4e3a0, \u4ee3\u8868\u7740\u63a5\u4e0b\u6765\u7684\u8f6c\u79fb\u53ea\u80fd\u4eceSTART_TAG\u5f00\u59cb init_alphas[0][self.tag_to_ix[START_TAG]] = 0. # \u524d\u5411\u8ba1\u7b97\u53d8\u91cf\u7684\u8d4b\u503c, \u8fd9\u6837\u5728\u53cd\u5411\u6c42\u5bfc\u7684\u8fc7\u7a0b\u4e2d\u5c31\u53ef\u4ee5\u81ea\u52a8\u66f4\u65b0\u53c2\u6570 forward_var = init_alphas # \u8f93\u5165\u8fdb\u6765\u7684feats: [20, 8, 7], \u4e3a\u4e86\u63a5\u4e0b\u6765\u6309\u53e5\u5b50\u8fdb\u884c\u8ba1\u7b97, \u8981\u5c06batch_size\u653e\u5728\u7b2c\u4e00\u4e2a\u7ef4\u5ea6\u4e0a feats = feats.transpose(1, 0) # feats: [8, 20, 7]\u662f\u4e00\u4e2a3\u7ef4\u77e9\u9635, \u6700\u5916\u5c42\u4ee3\u88688\u4e2a\u53e5\u5b50, \u5185\u5c42\u4ee3\u8868\u6bcf\u4e2a\u53e5\u5b50\u670920\u4e2a\u5b57\u7b26, # \u6bcf\u4e00\u4e2a\u5b57\u7b26\u6620\u5c04\u62107\u4e2a\u6807\u7b7e\u7684\u53d1\u5c04\u6982\u7387 # \u521d\u59cb\u5316\u6700\u7ec8\u7684\u7ed3\u679c\u5f20\u91cf, \u6bcf\u4e2a\u53e5\u5b50\u5bf9\u5e94\u4e00\u4e2a\u5206\u6570 result = torch.zeros((1, self.batch_size)) idx = 0 # \u6309\u884c\u904d\u5386, \u603b\u5171\u5faa\u73afbatch_size\u6b21 for feat_line in feats: # \u904d\u5386\u4e00\u884c\u8bed\u53e5, \u6bcf\u4e00\u4e2afeat\u4ee3\u8868\u4e00\u4e2atime_step for feat in feat_line: # \u5f53\u524dtime_step\u7684\u4e00\u4e2aforward tensors alphas_t = [] # \u5728\u5f53\u524dtime_step, \u904d\u5386\u6240\u6709\u53ef\u80fd\u7684\u8f6c\u79fb\u6807\u7b7e, \u8fdb\u884c\u7d2f\u52a0\u8ba1\u7b97 for next_tag in range(self.tagset_size): # \u5e7f\u64ad\u53d1\u5c04\u77e9\u9635\u7684\u5206\u6570 emit_score = feat[next_tag].view(1, -1).expand(1, self.tagset_size) # \u7b2ci\u4e2atime_step\u5faa\u73af\u65f6, \u8f6c\u79fb\u5230next_tag\u6807\u7b7e\u7684\u8f6c\u79fb\u6982\u7387 trans_score = self.transitions[next_tag].view(1, -1) # \u5c06\u524d\u5411\u77e9\u9635, \u8f6c\u79fb\u77e9\u9635, \u53d1\u5c04\u77e9\u9635\u7d2f\u52a0 next_tag_var = forward_var + trans_score + emit_score # \u8ba1\u7b97log_sum_exp()\u51fd\u6570\u503c # a = log_sum_exp(next_tag_var), \u6ce8\u610f: log_sum_exp()\u51fd\u6570\u4ec5\u4ec5\u8fd4\u56de\u4e00\u4e2a\u5b9e\u6570\u503c # print(a.shape) : tensor(1.0975) , ([]) # b = a.view(1) : tensor([1.0975]), \u6ce8\u610f: a.view(1)\u7684\u64cd\u4f5c\u5c31\u662f\u5c06\u4e00\u4e2a\u6570\u5b57\u53d8\u6210\u4e00\u4e2a\u4e00\u9636\u77e9\u9635, ([]) -> ([1]) # print(b.shape) : ([1]) alphas_t.append(log_sum_exp(next_tag_var).view(1)) # print(alphas_t) : [tensor([337.6004], grad_fn=<ViewBackward>), tensor([337.0469], grad_fn=<ViewBackward>), tensor([337.8497], grad_fn=<ViewBackward>), tensor([337.8668], grad_fn=<ViewBackward>), tensor([338.0186], grad_fn=<ViewBackward>), tensor([-9662.2734], grad_fn=<ViewBackward>), tensor([337.8692], grad_fn=<ViewBackward>)] # temp = torch.cat(alphas_t) # print(temp) : tensor([[ 337.6004, 337.0469, 337.8497, 337.8668, 338.0186, -9662.2734, 337.8692]]) # \u5c06\u5217\u8868\u5f20\u91cf\u8f6c\u53d8\u4e3a\u4e8c\u7ef4\u5f20\u91cf forward_var = torch.cat(alphas_t).view(1, -1) # print(forward_var.shape) : [1, 7] # print(forward_var) : tensor([[ 13.7928, 16.0067, 14.1092, -9984.7852, 15.8380]]) # \u6dfb\u52a0\u6700\u540e\u4e00\u6b65\u8f6c\u79fb\u5230\"STOP_TAG\"\u7684\u5206\u6570, \u5c31\u5b8c\u6210\u4e86\u6574\u6761\u8bed\u53e5\u7684\u5206\u6570\u8ba1\u7b97 terminal_var = forward_var + self.transitions[self.tag_to_ix[STOP_TAG]] # print(terminal_var) : tensor([[ 339.2167, 340.8612, 340.2773, 339.0194, 340.8908, -9659.5732, -9660.0527]]) # \u8ba1\u7b97log_sum_exp()\u51fd\u6570\u503c, \u4f5c\u4e3a\u4e00\u6761\u6837\u672c\u8bed\u53e5\u7684\u6700\u7ec8\u5f97\u5206 alpha = log_sum_exp(terminal_var) # print(alpha) : tensor(341.9394) # \u5c06\u5f97\u5206\u6dfb\u52a0\u8fdb\u7ed3\u679c\u5217\u8868\u4e2d, \u4f5c\u4e3a\u51fd\u6570\u7ed3\u679c\u8fd4\u56de result[0][idx] = alpha idx += 1 return result \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) for epoch in range(1): model.zero_grad() feats = model._get_lstm_features(sentence_sequence) forward_score = model._forward_alg(feats) print(forward_score) \u8f93\u51fa\u6548\u679c: tensor([[ 44.0279, 87.6439, 132.7635, 176.7535, 221.1325, 265.4456, 309.8346, 355.9332]], grad_fn=<CopySlices>) \u7b2c\u56db\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e8c\u9879\u7684\u5206\u503c def _score_sentence(self, feats, tags): # feats: [20, 8, 7] , tags: [8, 20] # \u521d\u59cb\u5316\u4e00\u4e2a0\u503c\u7684tensor, \u4e3a\u540e\u7eed\u7d2f\u52a0\u505a\u51c6\u5907 score = torch.zeros(1) # \u5c06START_TAG\u548c\u771f\u5b9e\u6807\u7b7etags\u505a\u5217\u7ef4\u5ea6\u4e0a\u7684\u62fc\u63a5 temp = torch.tensor(torch.full((self.batch_size, 1), self.tag_to_ix[START_TAG]), dtype=torch.long) tags = torch.cat((temp, tags), dim=1) # \u5c06\u4f20\u5165\u7684feats\u5f62\u72b6\u8f6c\u53d8\u4e3a[bathc_size, sequence_length, tagset_size] feats = feats.transpose(1, 0) # feats: [8, 20, 7] idx = 0 # \u521d\u59cb\u5316\u6700\u7ec8\u7684\u7ed3\u679c\u5206\u6570\u5f20\u91cf, \u6bcf\u4e00\u4e2a\u53e5\u5b50\u5f97\u5230\u4e00\u4e2a\u5206\u6570 result = torch.zeros((1, self.batch_size)) for feat_line in feats: # \u6ce8\u610f: \u6b64\u5904\u533a\u522b\u4e8e\u7b2c\u4e09\u6b65\u7684\u5faa\u73af, \u6700\u91cd\u8981\u7684\u662f\u8fd9\u662f\u5728\u771f\u5b9e\u6807\u7b7e\u6307\u5bfc\u4e0b\u7684\u8f6c\u79fb\u77e9\u9635\u548c\u53d1\u5c04\u77e9\u9635\u7684\u7d2f\u52a0\u5206\u6570 for i, feat in enumerate(feat_line): score = score + self.transitions[tags[idx][i + 1], tags[idx][i]] + feat[tags[idx][i + 1]] # \u6700\u540e\u52a0\u4e0a\u8f6c\u79fb\u5230STOP_TAG\u7684\u5206\u6570 score = score + self.transitions[self.tag_to_ix[STOP_TAG], tags[idx][-1]] result[0][idx] = score idx += 1 return result \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] # \u771f\u5b9e\u6807\u7b7e\u6570\u636e, \u5bf9\u5e94\u4e3atag_to_ix\u4e2d\u7684\u6570\u5b57\u6807\u7b7e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u5c06\u6807\u7b7e\u8f6c\u4e3a\u6807\u91cftags tags = torch.tensor(tag_list, dtype=torch.long) \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) for epoch in range(1): model.zero_grad() feats = model._get_lstm_features(sentence_sequence) gold_score = model._score_sentence(feats, tags) print(gold_score) \u8f93\u51fa\u6548\u679c: tensor([[ 5.3102, 9.0228, 14.7486, 19.5984, 32.4324, 37.9789, 57.8647, 66.8853]], grad_fn=<CopySlices>) \u7b2c\u4e94\u6b65: \u7ef4\u7279\u6bd4\u7b97\u6cd5\u7684\u5b9e\u73b0 # \u6839\u636e\u4f20\u5165\u7684\u8bed\u53e5\u7279\u5f81feats, \u63a8\u65ad\u51fa\u6807\u7b7e\u5e8f\u5217 def _viterbi_decode(self, feats): # \u521d\u59cb\u5316\u6700\u4f73\u8def\u5f84\u7ed3\u679c\u7684\u5b58\u653e\u5217\u8868 result_best_path = [] # \u5c06\u8f93\u5165\u5f20\u91cf\u53d8\u5f62\u4e3a[batch_size, sequence_length, tagset_size] feats = feats.transpose(1, 0) # \u5bf9\u6279\u6b21\u4e2d\u7684\u6bcf\u4e00\u884c\u8bed\u53e5\u8fdb\u884c\u904d\u5386, \u6bcf\u4e2a\u8bed\u53e5\u4ea7\u751f\u4e00\u4e2a\u6700\u4f18\u6807\u6ce8\u5e8f\u5217 for feat_line in feats: backpointers = [] # \u521d\u59cb\u5316\u524d\u5411\u4f20\u64ad\u7684\u5f20\u91cf, \u8bbe\u7f6eSTART_TAG\u7b49\u4e8e0, \u7ea6\u675f\u5408\u6cd5\u5e8f\u5217\u53ea\u80fd\u4eceSTART_TAG\u5f00\u59cb init_vvars = torch.full((1, self.tagset_size), -10000.) init_vvars[0][self.tag_to_ix[START_TAG]] = 0 # \u5728\u7b2ci\u4e2atime_step, \u5f20\u91cfforward_var\u4fdd\u5b58\u7b2ci-1\u4e2atime_step\u7684viterbi\u53d8\u91cf forward_var = init_vvars # \u4f9d\u6b21\u904d\u5386i=0, \u5230\u5e8f\u5217\u6700\u540e\u7684\u6bcf\u4e00\u4e2atime_step for feat in feat_line: # \u4fdd\u5b58\u5f53\u524dtime_step\u7684\u56de\u6eaf\u6307\u9488 bptrs_t = [] # \u4fdd\u5b58\u5f53\u524dtime_step\u7684viterbi\u53d8\u91cf viterbivars_t = [] for next_tag in range(self.tagset_size): # next_tag_var[i]\u4fdd\u5b58\u4e86tag_i \u5728\u524d\u4e00\u4e2atime_step\u7684viterbi\u53d8\u91cf # \u524d\u5411\u4f20\u64ad\u5f20\u91cfforward_var\u52a0\u4e0a\u4ecetag_i\u8f6c\u79fb\u5230next_tag\u7684\u5206\u6570, \u8d4b\u503c\u7ed9next_tag_var # \u6ce8\u610f\u6b64\u5904\u6ca1\u6709\u52a0\u53d1\u5c04\u77e9\u9635\u5206\u6570, \u56e0\u4e3a\u6c42\u6700\u5927\u503c\u4e0d\u9700\u8981\u53d1\u5c04\u77e9\u9635 next_tag_var = forward_var + self.transitions[next_tag] # \u5c06\u6700\u5927\u7684\u6807\u7b7eid\u52a0\u5165\u5230\u5f53\u524dtime_step\u7684\u56de\u6eaf\u5217\u8868\u4e2d best_tag_id = argmax(next_tag_var) bptrs_t.append(best_tag_id) viterbivars_t.append(next_tag_var[0][best_tag_id].view(1)) # \u6b64\u5904\u518d\u5c06\u53d1\u5c04\u77e9\u9635\u5206\u6570feat\u52a0\u4e0a, \u8d4b\u503c\u7ed9forward_var, \u4f5c\u4e3a\u4e0b\u4e00\u4e2atime_step\u7684\u524d\u5411\u4f20\u64ad\u5f20\u91cf forward_var = (torch.cat(viterbivars_t) + feat).view(1, -1) # \u5f53\u524dtime_step\u7684\u56de\u6eaf\u6307\u9488\u6dfb\u52a0\u8fdb\u5f53\u524d\u8fd9\u4e00\u884c\u6837\u672c\u7684\u603b\u4f53\u56de\u6eaf\u6307\u9488\u4e2d backpointers.append(bptrs_t) # \u6700\u540e\u52a0\u4e0a\u8f6c\u79fb\u5230STOP_TAG\u7684\u5206\u6570 terminal_var = forward_var + self.transitions[self.tag_to_ix[STOP_TAG]] best_tag_id = argmax(terminal_var) # path_score\u662f\u6574\u4e2a\u8def\u5f84\u7684\u603b\u5f97\u5206 path_score = terminal_var[0][best_tag_id] # \u6839\u636e\u56de\u6eaf\u6307\u9488, \u89e3\u7801\u6700\u4f73\u8def\u5f84 # \u9996\u5148\u628a\u6700\u540e\u4e00\u6b65\u7684id\u503c\u52a0\u5165 best_path = [best_tag_id] # \u4ece\u540e\u5411\u524d\u56de\u6eaf\u6700\u4f73\u8def\u5f84 for bptrs_t in reversed(backpointers): # \u901a\u8fc7\u7b2ci\u4e2atime_step\u5f97\u5230\u7684\u6700\u4f73id, \u627e\u5230\u7b2ci-1\u4e2atime_step\u7684\u6700\u4f73id best_tag_id = bptrs_t[best_tag_id] best_path.append(best_tag_id) # \u5c06START_TAG\u5220\u9664 start = best_path.pop() # \u786e\u8ba4\u4e00\u4e0b\u6700\u4f73\u8def\u5f84\u4e2d\u7684\u7b2c\u4e00\u4e2a\u6807\u7b7e\u662fSTART_TAG assert start == self.tag_to_ix[START_TAG] # \u56e0\u4e3a\u662f\u4ece\u540e\u5411\u524d\u56de\u6eaf, \u6240\u4ee5\u518d\u6b21\u9006\u5e8f\u5f97\u5230\u603b\u524d\u5411\u540e\u7684\u771f\u5b9e\u8def\u5f84 best_path.reverse() # \u5f53\u524d\u8fd9\u4e00\u884c\u7684\u6837\u672c\u7ed3\u679c\u6dfb\u52a0\u5230\u6700\u7ec8\u7684\u7ed3\u679c\u5217\u8868\u91cc result_best_path.append(best_path) return result_best_path \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e/data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] # \u771f\u5b9e\u6807\u7b7e\u6570\u636e, \u5bf9\u5e94\u4e3atag_to_ix\u4e2d\u7684\u6570\u5b57\u6807\u7b7e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u5c06\u6807\u7b7e\u8f6c\u4e3a\u6807\u91cftags tags = torch.tensor(tag_list, dtype=torch.long) \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) for epoch in range(1): model.zero_grad() feats = model._get_lstm_features(sentence_sequence) result_tags = model._viterbi_decode(feats) print(result_tags) \u8f93\u51fa\u6548\u679c: [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2]] \u7b2c\u516d\u6b65: \u5b8c\u5584BiLSTM\u7c7b\u7684\u5168\u90e8\u529f\u80fd # \u5bf9\u6570\u4f3c\u7136\u51fd\u6570\u7684\u8ba1\u7b97, \u8f93\u5165\u7684\u662f\u6570\u5b57\u5316\u7f16\u7801\u540e\u7684\u8bed\u53e5, \u548c\u771f\u5b9e\u7684\u6807\u7b7e # \u6ce8\u610f: \u8fd9\u4e2a\u51fd\u6570\u662f\u672a\u6765\u771f\u5b9e\u8bad\u7ec3\u4e2d\u8981\u7528\u5230\u7684\"\u865a\u62df\u5316\u7684forward()\" def neg_log_likelihood(self, sentence, tags): # \u7b2c\u4e00\u6b65\u5148\u5f97\u5230BiLSTM\u5c42\u7684\u8f93\u51fa\u7279\u5f81\u5f20\u91cf feats = self._get_lstm_features(sentence) # feats : [20, 8, 7] \u4ee3\u8868\u4e00\u4e2a\u6279\u6b21\u67098\u4e2a\u6837\u672c, \u6bcf\u4e2a\u6837\u672c\u957f\u5ea620 # \u6bcf\u4e00\u4e2aword\u6620\u5c04\u52307\u4e2a\u6807\u7b7e\u7684\u6982\u7387, \u53d1\u5c04\u77e9\u9635 # forward_score \u4ee3\u8868\u516c\u5f0f\u63a8\u5bfc\u4e2d\u635f\u5931\u51fd\u6570loss\u7684\u7b2c\u4e00\u9879 forward_score = self._forward_alg(feats) # gold_score \u4ee3\u8868\u516c\u5f0f\u63a8\u5bfc\u4e2d\u635f\u5931\u51fd\u6570loss\u7684\u7b2c\u4e8c\u9879 gold_score = self._score_sentence(feats, tags) # \u6309\u884c\u6c42\u548c, \u5728torch.sum()\u51fd\u6570\u503c\u4e2d, \u9700\u8981\u8bbe\u7f6edim=1 ; \u540c\u7406, dim=0\u4ee3\u8868\u6309\u5217\u6c42\u548c # \u6ce8\u610f: \u5728\u8fd9\u91cc, \u901a\u8fc7forward_score\u548cgold_score\u7684\u5dee\u503c\u6765\u4f5c\u4e3aloss, \u7528\u6765\u68af\u5ea6\u4e0b\u964d\u8bad\u7ec3\u6a21\u578b return torch.sum(forward_score - gold_score, dim=1) # \u6b64\u5904\u7684forward()\u771f\u5b9e\u573a\u666f\u662f\u7528\u5728\u9884\u6d4b\u90e8\u5206, \u8bad\u7ec3\u7684\u65f6\u5019\u5e76\u6ca1\u6709\u7528\u5230 def forward(self, sentence): # \u83b7\u53d6\u4eceBiLSTM\u5c42\u5f97\u5230\u7684\u53d1\u5c04\u77e9\u9635 lstm_feats = self._get_lstm_features(sentence) # \u901a\u8fc7\u7ef4\u7279\u6bd4\u7b97\u6cd5\u76f4\u63a5\u89e3\u7801\u6700\u4f73\u8def\u5f84 tag_seq = self._viterbi_decode(lstm_feats) return tag_seq \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] # \u771f\u5b9e\u6807\u7b7e\u6570\u636e, \u5bf9\u5e94\u4e3atag_to_ix\u4e2d\u7684\u6570\u5b57\u6807\u7b7e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u5c06\u6807\u7b7e\u8f6c\u4e3a\u6807\u91cftags tags = torch.tensor(tag_list, dtype=torch.long) \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) optimizer = optim.SGD(model.parameters(), lr=0.01, weight_decay=1e-4) for epoch in range(1): model.zero_grad() loss = model.neg_log_likelihood(sentence_sequence, tags) print(loss) loss.backward() optimizer.step() result = model(sentence_sequence) print(result) \u8f93\u51fa\u6548\u679c: tensor([2347.2678], grad_fn=<SumBackward1>) [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]] 6.5 \u6a21\u578b\u8bad\u7ec3 \u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u6570\u636e\u7684\u9884\u5904\u7406\u6d41\u7a0b \u638c\u63e1\u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e\u7684\u65b9\u6cd5 \u638c\u63e1\u6a21\u578b\u8bad\u7ec3\u4ee3\u7801 \u6a21\u578b\u8bad\u7ec3\u7684\u6d41\u7a0b \u7b2c\u4e00\u6b65: \u719f\u6089\u5b57\u7b26\u5230\u6570\u5b57\u7f16\u7801\u7684\u7801\u8868 \u7b2c\u4e8c\u6b65: \u719f\u6089\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u548c\u542b\u4e49\u89e3\u91ca \u7b2c\u4e09\u6b65: \u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e \u7b2c\u56db\u6b65: \u5b8c\u6210\u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u7684\u8bc4\u4f30\u4ee3\u7801 \u7b2c\u4e94\u6b65: \u5b8c\u6210\u8bad\u7ec3\u6a21\u578b\u7684\u4ee3\u7801 \u7b2c\u516d\u6b65: \u7ed8\u5236\u635f\u5931\u66f2\u7ebf\u548c\u8bc4\u4f30\u66f2\u7ebf\u56fe \u7b2c\u4e00\u6b65: \u719f\u6089\u5b57\u7b26\u5230\u6570\u5b57\u7f16\u7801\u7684\u7801\u8868. # \u4ee3\u8868\u4e86\u6570\u636e\u96c6\u4e2d\u6240\u6709\u5b57\u7b26\u5230\u6570\u5b57\u7f16\u7801\u7684\u5b57\u5178\u6620\u5c04 # \u7801\u8868\u53ef\u4ee5\u5305\u542b\u4e2d\u6587\u7b80\u4f53\u3001\u7e41\u4f53\u3001\u82f1\u6587\u5927\u5c0f\u5199\u5b57\u6bcd\u3001\u6570\u5b57\u3001\u4e2d\u82f1\u6587\u6807\u70b9\u7b26\u53f7\u7b49\u7b49 # <PAD>\u4e3a\u586b\u5145\u6807\u8bc6, \u8bad\u7ec3\u65f6\u9700\u8981\u5c06\u53e5\u5b50\u8f6c\u5316\u6210\u77e9\u9635, \u800c\u53e5\u5b50\u957f\u77ed\u4e0d\u4e00, \u9700\u8981\u505apadding\u5904\u7406 { \"<PAD>\": 0, \"\u5391\": 1, \"\u5416\": 2, \"\u5475\": 3, \"\u554a\": 4, \"\u55c4\": 5, \"\u5b36\": 6, ... } \u7801\u8868\u6240\u5728\u4f4d\u7f6e: /data/doctor_offline/ner_model/data/char_to_id.json \u7b2c\u4e8c\u6b65: \u719f\u6089\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u548c\u542b\u4e49\u89e3\u91ca. \u8368 B-dis \u9ebb I-dis \u75b9 I-dis \u8fd9 O \u4e48 O \u75d2 O \u548b O \u529e O \u3002 O \u7a81 O \u7136 O \u5934 B-sym \u6655 I-sym \u5455 B-sym \u5410 I-sym \u3002 O \u8bad\u7ec3\u6570\u636e\u96c6\u7684\u542b\u4e49\u89e3\u91ca: \u6bcf\u4e00\u884c\u5305\u542b\u4e00\u4e2a\u5b57\u4ee5\u53ca\u4e0e\u4e4b\u5bf9\u5e94\u7684\u6807\u7b7e, \u5b57\u4e0e\u6807\u7b7e\u4e4b\u95f4\u901a\u8fc7\\t\u5206\u9694 \u53e5\u5b50\u4e0e\u53e5\u5b50\u4e4b\u95f4\u901a\u8fc7\u7a7a\u884c\u5206\u9694 \u6807\u7b7e\u8bf4\u660e: B-dis: \u75be\u75c5\u5b9e\u4f53\u540d\u8bcd\u8d77\u59cb\u6807\u8bc6 I-dis: \u75be\u75c5\u5b9e\u4f53\u540d\u8bcd\u4e2d\u95f4\u5230\u7ed3\u5c3e\u6807\u8bc6 B-sym: \u75c7\u72b6\u5b9e\u4f53\u540d\u8bcd\u8d77\u59cb\u6807\u8bc6 I-sym: \u75c7\u72b6\u5b9e\u4f53\u540d\u8bcd\u4e2d\u95f4\u5230\u7ed3\u5c3e\u6807\u8bc6 O: \u5176\u4ed6\u975e\u5b9e\u4f53\u90e8\u5206\u6807\u8bc6 \u6570\u636e\u96c6\u6240\u5728\u4f4d\u7f6e: /data/doctor_offline/ner_model/data/train.txt \u5c06\u8bad\u7ec3\u6570\u636e\u96c6\u8f6c\u6362\u4e3a\u6570\u5b57\u5316\u7f16\u7801\u96c6: # \u5bfc\u5165\u5305 import json import numpy as np # \u521b\u5efa\u8bad\u7ec3\u6570\u636e\u96c6, \u4ece\u539f\u59cb\u8bad\u7ec3\u6587\u4ef6\u4e2d\u5c06\u4e2d\u6587\u5b57\u7b26\u8fdb\u884c\u6570\u5b57\u7f16\u7801, \u5e76\u5c06\u6807\u7b7e\u9875\u8fdb\u884c\u6570\u5b57\u7f16\u7801 def create_train_data(train_data_file, result_file, json_file, tag2id, max_length=20): # \u5bfc\u5165json\u683c\u5f0f\u7684\u4e2d\u6587\u5b57\u7b26\u5230id\u7684\u6620\u5c04\u8868 char2id = json.load(open(json_file, mode='r', encoding='utf-8')) char_data, tag_data = [], [] # \u6253\u5f00\u539f\u59cb\u8bad\u7ec3\u6587\u4ef6 with open(train_data_file, mode='r', encoding='utf-8') as f: # \u521d\u59cb\u5316\u4e00\u6761\u8bed\u53e5\u6570\u5b57\u5316\u7f16\u7801\u540e\u7684\u5217\u8868 char_ids = [0] * max_length tag_ids = [0] * max_length idx = 0 for line in f.readlines(): line = line.strip('\\n').strip() # \u5982\u679c\u4e0d\u662f\u7a7a\u884c, \u5e76\u4e14\u5f53\u524d\u8bed\u53e5\u957f\u5ea6\u6ca1\u6709\u8d85\u8fc7max_length, \u5219\u8fdb\u884c\u5b57\u7b26\u5230id\u7684\u6620\u5c04 if len(line) > 0 and line and idx < max_length: ch, tag = line.split('\\t') # \u5982\u679c\u5f53\u524d\u5b57\u7b26\u5b58\u5728\u4e8e\u6620\u5c04\u8868\u4e2d, \u5219\u76f4\u63a5\u6620\u5c04\u4e3a\u5bf9\u5e94\u7684id\u503c if char2id.get(ch): char_ids[idx] = char2id[ch] # \u5426\u5219\u76f4\u63a5\u7528\"UNK\"\u7684id\u503c\u6765\u4ee3\u66ff\u8fd9\u4e2a\u672a\u77e5\u5b57\u7b26 else: char_ids[idx] = char2id['UNK'] # \u5c06\u6807\u7b7e\u4e5f\u8fdb\u884c\u5bf9\u5e94\u7684\u8f6c\u6362 tag_ids[idx] = tag2id[tag] idx += 1 # \u5982\u679c\u662f\u7a7a\u884c, \u6216\u8005\u5f53\u524d\u8bed\u53e5\u957f\u5ea6\u8d85\u8fc7max_length else: # \u5982\u679c\u5f53\u524d\u8bed\u53e5\u957f\u5ea6\u8d85\u8fc7max_length, \u76f4\u63a5\u5c06[0: max_langth]\u7684\u90e8\u5206\u4f5c\u4e3a\u7ed3\u679c if idx <= max_length: char_data.append(char_ids) tag_data.append(tag_ids) # \u9047\u5230\u7a7a\u884c, \u8bf4\u660e\u5f53\u524d\u53e5\u5b50\u5df2\u7ecf\u7ed3\u675f, \u521d\u59cb\u5316\u6e05\u96f6, \u4e3a\u4e0b\u4e00\u4e2a\u53e5\u5b50\u7684\u6620\u5c04\u505a\u51c6\u5907 char_ids = [0] * max_length tag_ids = [0] * max_length idx = 0 # \u5c06\u6570\u5b57\u5316\u7f16\u7801\u540e\u7684\u6570\u636e\u5c01\u88c5\u6210numpy\u7684\u6570\u7ec4\u7c7b\u578b, \u6570\u5b57\u7f16\u7801\u91c7\u7528np.int32 x_data = np.array(char_data, dtype=np.int32) y_data = np.array(tag_data, dtype=np.int32) # \u76f4\u63a5\u5229\u7528np.savez()\u5c06\u6570\u636e\u5b58\u50a8\u4e3a.npz\u7c7b\u578b\u7684\u6587\u4ef6 np.savez(result_file, x_data=x_data, y_data=y_data) print(\"create_train_data Finished!\".center(100, \"-\")) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/preprocess_data.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def json_file = './data/char_to_id.json' # \u53c2\u65702:\u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178 tag2id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65703:\u8bad\u7ec3\u6570\u636e\u6587\u4ef6\u8def\u5f84 train_data_file = './data/train.txt' # \u53c2\u65704:\u521b\u5efa\u7684npz\u6587\u4ef6\u4fdd\u8def\u5f84(\u8bad\u7ec3\u6570\u636e) result_file = './data/train.npz' \u8c03\u7528: if __name__ == '__main__': create_train_data(train_data_file, result_file, json_file, tag2id) \u8f93\u51fa\u6548\u679c: ------------------------------------create_train_data Finished!------------------------------------- \u751f\u6210\u4e86\u65b0\u7684\u6570\u636e\u96c6\u6587\u4ef6: /data/doctor_offline/ner_model/data/train.npz \u7b2c\u4e09\u6b65: \u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e. # \u5bfc\u5165\u76f8\u5173\u7684\u5305 import numpy as np import torch import torch.utils.data as Data # \u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e def load_dataset(data_file, batch_size): # \u5c06\u7b2c\u4e8c\u6b65\u751f\u6210\u7684train.npz\u6587\u4ef6\u5bfc\u5165\u5185\u5b58 data = np.load(data_file) # \u5206\u522b\u53d6\u51fa\u7279\u5f81\u503c\u548c\u6807\u7b7e x_data = data['x_data'] y_data = data['y_data'] # \u5c06\u6570\u636e\u5c01\u88c5\u6210tensor\u5f20\u91cf x = torch.tensor(x_data, dtype=torch.long) y = torch.tensor(y_data, dtype=torch.long) # \u5c06\u6570\u636e\u5c01\u88c5\u6210Tensor\u6570\u636e\u96c6 dataset = Data.TensorDataset(x, y) total_length = len(dataset) # \u91c7\u752880%\u7684\u6570\u636e\u4f5c\u4e3a\u8bad\u7ec3\u96c6, 20%\u7684\u6570\u636e\u4f5c\u4e3a\u6d4b\u8bd5\u96c6 train_length = int(total_length * 0.8) validation_length = total_length - train_length # \u5229\u7528Data.random_split()\u76f4\u63a5\u5207\u5206\u96c6\u5408, \u6309\u716780%, 20%\u7684\u6bd4\u4f8b\u5212\u5206 train_dataset, validation_dataset = Data.random_split(dataset=dataset, lengths=[train_length, validation_length]) # \u5c06\u8bad\u7ec3\u96c6\u8fdb\u884cDataLoader\u5c01\u88c5 # \u53c2\u6570\u8bf4\u660e\u5982\u4e0b: # dataset: \u8bad\u7ec3\u6570\u636e\u96c6 # batch_size: \u4ee3\u8868\u6279\u6b21\u5927\u5c0f, \u82e5\u6570\u636e\u96c6\u603b\u6837\u672c\u6570\u91cf\u65e0\u6cd5\u88abbatch_size\u6574\u9664, \u5219\u6700\u540e\u4e00\u6279\u6570\u636e\u4e3a\u4f59\u6570 # \u82e5\u8bbe\u7f6edrop_last\u4e3aTrue\uff0c \u5219\u81ea\u52a8\u62b9\u53bb\u6700\u540e\u4e0d\u80fd\u88ab\u6574\u9664\u7684\u5269\u4f59\u6279\u6b21 # shuffle: \u662f\u5426\u6bcf\u4e2a\u6279\u6b21\u4e3a\u968f\u673a\u62bd\u53d6, \u82e5\u4e3aTrue, \u5219\u6bcf\u6b21\u8fed\u4ee3\u65f6\u6570\u636e\u4e3a\u968f\u673a\u62bd\u53d6 # num_workers: \u8bbe\u5b9a\u6709\u591a\u5c11\u5b50\u8fdb\u7a0b\u7528\u6765\u505a\u6570\u636e\u52a0\u8f7d, \u9ed8\u8ba4\u4e3a0, \u5373\u6570\u636e\u5c06\u88ab\u52a0\u8f7d\u5230\u4e3b\u8fdb\u7a0b\u4e2d # drop_last: \u662f\u5426\u53bb\u9664\u4e0d\u80fd\u88ab\u6574\u9664\u540e\u7684\u6700\u540e\u6279\u6b21, \u82e5\u4e3aTrue, \u5219\u4e0d\u751f\u6210\u6700\u540e\u4e0d\u80fd\u88ab\u6574\u9664\u5269\u4f59\u7684\u6570\u636e\u5185\u5bb9 # \u4f8b\u5982: dataset\u957f\u5ea6\u4e3a1028, batch_size\u4e3a8, # \u82e5drop_last=True, \u5219\u6700\u540e\u5269\u4f59\u76844(1028/8=128\u4f594)\u6761\u6570\u636e\u5c06\u88ab\u629b\u5f03\u4e0d\u7528 train_loader = Data.DataLoader(dataset=train_dataset, batch_size=batch_size, shuffle=True, num_workers=4, drop_last=True) validation_loader = Data.DataLoader(dataset=validation_dataset, batch_size=batch_size, shuffle=True, num_workers=4, drop_last=True) # \u5c06\u4e24\u4e2a\u6570\u636e\u751f\u6210\u5668\u5c01\u88c5\u4e3a\u4e00\u4e2a\u5b57\u5178\u7c7b\u578b data_loaders = {'train': train_loader, 'validation': validation_loader} # \u5c06\u4e24\u4e2a\u6570\u636e\u96c6\u7684\u957f\u5ea6\u4e5f\u5c01\u88c5\u4e3a\u4e00\u4e2a\u5b57\u5178\u7c7b\u578b data_size = {'train': train_length, 'validation': validation_length} return data_loaders, data_size \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/loader_data.py \u8f93\u5165\u53c2\u6570: # \u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u7f16\u7801\u540e\u7684\u8bad\u7ec3\u6570\u636e\u6587\u4ef6\u8def\u5f84 DATA_FILE = './data/train.npz' \u8c03\u7528: if __name__ == '__main__': data_loader, data_size = load_dataset(DATA_FILE, BATCH_SIZE) print('data_loader:', data_loader, '\\ndata_size:', data_size) \u8f93\u51fa\u6548\u679c: data_loader: {'train': <torch.utils.data.dataloader.DataLoader object at 0x7f29eaafb3d0>, 'validation': <torch.utils.data.dataloader.DataLoader object at 0x7f29eaafb5d0>} data_size: {'train': 5368, 'validation': 1343} \u7b2c\u56db\u6b65: \u5b8c\u6210\u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u7684\u8bc4\u4f30\u4ee3\u7801. # \u8bc4\u4f30\u6a21\u578b\u7684\u51c6\u786e\u7387, \u53ec\u56de\u7387, F1, \u7b49\u6307\u6807 def evaluate(sentence_list, true_tag, predict_tag, id2char, id2tag): ''' sentence_list: \u6587\u672c\u5411\u91cf\u5316\u540e\u7684\u53e5\u5b50\u5411\u91cf\u5217\u8868 true_tag: \u771f\u5b9e\u7684\u6807\u7b7e predict_tag: \u6a21\u578b\u9884\u6d4b\u7684\u6807\u7b7e id2char: id\u503c\u5230\u4e2d\u6587\u5b57\u7b26\u7684\u6620\u5c04\u8868 id2tag: id\u503c\u5230\u6807\u7b7e\u7684\u6620\u5c04\u8868 ''' # \u521d\u59cb\u5316\u771f\u5b9e\u7684\u547d\u540d\u5b9e\u4f53, \u9884\u6d4b\u7684\u547d\u540d\u5b9e\u4f53, \u63a5\u4e0b\u6765\u6bd4\u8f83\u4e24\u8005\u6765\u8bc4\u4f30\u5404\u9879\u6307\u6807 true_entities, true_entity = [], [] predict_entities, predict_entity = [], [] # \u9010\u6761\u904d\u5386\u6279\u6b21\u4e2d\u6240\u6709\u7684\u8bed\u53e5 for line_num, sentence in enumerate(sentence_list): # \u904d\u5386\u4e00\u6761\u6837\u672c\u8bed\u53e5\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7b26\u7f16\u7801(\u8fd9\u91cc\u9762\u662f\u6570\u5b57\u5316\u7f16\u7801) for char_num in range(len(sentence)): # \u7f16\u7801\u4e3a0, \u8868\u793a\u540e\u9762\u90fd\u662f\u586b\u5145\u76840, \u53ef\u4ee5\u7ed3\u675ffor\u5faa\u73af if sentence[char_num]==0: break # \u4f9d\u6b21\u53d6\u51fa\u771f\u5b9e\u7684\u6837\u672c\u5b57\u7b26, \u771f\u5b9e\u7684\u6807\u7b7e, \u9884\u6d4b\u7684\u6807\u7b7e char_text = id2char[sentence[char_num]] true_tag_type = id2tag[true_tag[line_num][char_num]] predict_tag_type = id2tag[predict_tag[line_num][char_num]] # \u5bf9\u771f\u5b9e\u6807\u7b7e\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"B\", \u8868\u793a\u4e00\u4e2a\u5b9e\u4f53\u7684\u5f00\u59cb, \u5c06\"\u5b57\u7b26/\u6807\u7b7e\"\u7684\u683c\u5f0f\u6dfb\u52a0\u8fdb\u5b9e\u4f53\u5217\u8868\u4e2d if true_tag_type[0] == \"B\": true_entity = [char_text + \"/\" + true_tag_type] # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"I\", \u8868\u793a\u5904\u4e8e\u4e00\u4e2a\u5b9e\u4f53\u7684\u4e2d\u95f4 # \u5982\u679c\u771f\u5b9e\u547d\u540d\u5b9e\u4f53\u5217\u8868\u975e\u7a7a, \u5e76\u4e14\u6700\u540e\u4e00\u4e2a\u6dfb\u52a0\u8fdb\u53bb\u7684\u6807\u7b7e\u7c7b\u578b\u548c\u5f53\u524d\u7684\u6807\u7b7e\u7c7b\u578b\u4e00\u6837, \u5219\u7ee7\u7eed\u6dfb\u52a0 # \u610f\u601d\u5c31\u662f\u6bd4\u5982true_entity = [\"\u4e2d/B-Person\", \"\u56fd/I-Person\"], \u6b64\u65f6\u7684\"\u4eba/I-Person\"\u5c31\u53ef\u4ee5\u6dfb\u52a0\u8fdb\u53bb, \u56e0\u4e3a\u90fd\u5c5e\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53 elif true_tag_type[0] == \"I\" and len(true_entity) != 0 and true_entity[-1].split(\"/\")[1][1:] == true_tag_type[1:]: true_entity.append(char_text + \"/\" + true_tag_type) # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"O\", \u5e76\u4e14true_entity\u975e\u7a7a, \u8868\u793a\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u7ed3\u675f\u4e86 elif true_tag_type[0] == \"O\" and len(true_entity) != 0 : # \u6700\u540e\u589e\u52a0\u8fdb\u53bb\u4e00\u4e2a\"\u884c\u53f7_\u5217\u53f7\", \u4f5c\u4e3a\u533a\u5206\u5b9e\u4f53\u7684\u6807\u5fd7 true_entity.append(str(line_num) + \"_\" + str(char_num)) # \u5c06\u8fd9\u4e2a\u5339\u914d\u51fa\u6765\u7684\u5b9e\u4f53\u52a0\u5165\u5230\u7ed3\u679c\u5217\u8868\u4e2d true_entities.append(true_entity) # \u6e05\u7a7atrue_entity, \u4e3a\u4e0b\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u505a\u51c6\u5907 true_entity=[] # \u9664\u4e86\u4e0a\u9762\u4e09\u79cd\u60c5\u51b5, \u8bf4\u660e\u5f53\u524d\u6ca1\u6709\u5339\u914d\u51fa\u4efb\u4f55\u547d\u540d\u5b9e\u4f53, \u5219\u6e05\u7a7atrue_entity, \u7ee7\u7eed\u4e0b\u4e00\u6b21\u5339\u914d else: true_entity=[] # \u5bf9\u9884\u6d4b\u6807\u7b7e\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"B\", \u8868\u793a\u4e00\u4e2a\u5b9e\u4f53\u7684\u5f00\u59cb, \u5c06\"\u5b57\u7b26/\u9884\u6d4b\u6807\u7b7e\"\u7684\u683c\u5f0f\u6dfb\u52a0\u8fdb\u5b9e\u4f53\u5217\u8868\u4e2d if predict_tag_type[0] == \"B\": predict_entity = [char_text + \"/\" + predict_tag_type] # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"I\", \u8868\u793a\u5904\u4e8e\u4e00\u4e2a\u5b9e\u4f53\u7684\u4e2d\u95f4 # \u5982\u679c\u9884\u6d4b\u547d\u540d\u5b9e\u4f53\u5217\u8868\u975e\u7a7a, \u5e76\u4e14\u6700\u540e\u4e00\u4e2a\u6dfb\u52a0\u8fdb\u53bb\u7684\u6807\u7b7e\u7c7b\u578b\u548c\u5f53\u524d\u7684\u6807\u7b7e\u7c7b\u578b\u4e00\u6837, \u5219\u7ee7\u7eed\u6dfb\u52a0 # \u610f\u601d\u5c31\u662f\u6bd4\u5982predict_entity = [\"\u4e2d/B-Person\", \"\u56fd/I-Person\"], \u6b64\u65f6\u7684\"\u4eba/I-Person\"\u5c31\u53ef\u4ee5\u6dfb>\u52a0\u8fdb\u53bb, \u56e0\u4e3a\u90fd\u5c5e\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53 elif predict_tag_type[0] == \"I\" and len(predict_entity) != 0 and predict_entity[-1].split(\"/\")[1][1:] == predict_tag_type[1:]: predict_entity.append(char_text + \"/\" + predict_tag_type) # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"O\", \u5e76\u4e14predict_entity\u975e\u7a7a, \u8868\u793a\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u7ed3\u675f\u4e86 elif predict_tag_type[0] == \"O\" and len(predict_entity) != 0: # \u6700\u540e\u589e\u52a0\u8fdb\u53bb\u4e00\u4e2a\"\u884c\u53f7_\u5217\u53f7\", \u4f5c\u4e3a\u533a\u5206\u5b9e\u4f53\u7684\u6807\u5fd7 predict_entity.append(str(line_num) + \"_\" + str(char_num)) # \u5c06\u8fd9\u4e2a\u5339\u914d\u51fa\u6765\u7684\u5b9e\u4f53\u52a0\u5165\u5230\u7ed3\u679c\u5217\u8868\u4e2d predict_entities.append(predict_entity) # \u6e05\u7a7apredict_entity, \u4e3a\u4e0b\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u505a\u51c6\u5907 predict_entity = [] # \u9664\u4e86\u4e0a\u9762\u4e09\u79cd\u60c5\u51b5, \u8bf4\u660e\u5f53\u524d\u6ca1\u6709\u5339\u914d\u51fa\u4efb\u4f55\u547d\u540d\u5b9e\u4f53, \u5219\u6e05\u7a7apredict_entity, \u7ee7\u7eed\u4e0b\u4e00\u6b21\u5339\u914d else: predict_entity = [] # \u904d\u5386\u6240\u6709\u9884\u6d4b\u5b9e\u4f53\u7684\u5217\u8868, \u53ea\u6709\u90a3\u4e9b\u5728\u771f\u5b9e\u547d\u540d\u5b9e\u4f53\u4e2d\u7684\u624d\u662f\u6b63\u786e\u7684 acc_entities = [entity for entity in predict_entities if entity in true_entities] # \u8ba1\u7b97\u6b63\u786e\u5b9e\u4f53\u7684\u4e2a\u6570, \u9884\u6d4b\u5b9e\u4f53\u7684\u603b\u4e2a\u6570, \u771f\u5b9e\u5b9e\u4f53\u7684\u603b\u4e2a\u6570 acc_entities_length = len(acc_entities) predict_entities_length = len(predict_entities) true_entities_length = len(true_entities) # \u81f3\u5c11\u6b63\u786e\u9884\u6d4b\u4e86\u4e00\u4e2a, \u624d\u8ba1\u7b973\u4e2a\u6307\u6807, \u51c6\u786e\u7387 if acc_entities_length > 0: accuracy = float(acc_entities_length / predict_entities_length) recall = float(acc_entities_length / true_entities_length) f1_score = 2 * accuracy * recall / (accuracy + recall) return accuracy, recall, f1_score, acc_entities_length, predict_entities_length, true_entities_length else: return 0, 0, 0, acc_entities_length, predict_entities_length, true_entities_length \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/evaluate_model.py \u8f93\u5165\u53c2\u6570: # \u771f\u5b9e\u6807\u7b7e\u6570\u636e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u9884\u6d4b\u6807\u7b7e\u6570\u636e predict_tag_list = [ [0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 1, 2, 0, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u7f16\u7801\u4e0e\u5b57\u7b26\u5bf9\u7167\u5b57\u5178 id2char = {0: '<PAD>', 1: '\u786e', 2: '\u8bca', 3: '\u5f25', 4: '\u6f2b', 5: '\u5927', 6: 'b', 7: '\u7ec6', 8: '\u80de', 9: '\u6dcb', 10: '\u5df4', 11: '\u7624', 12: '1', 13: '\u5e74', 14: '\u53cd', 15: '\u590d', 16: '\u54b3', 17: '\u55fd', 18: '\u3001', 19: '\u75f0', 20: '4', 21: '0', 22: ',', 23: '\u518d', 24: '\u53d1', 25: '\u4f34', 26: '\u6c14', 27: '\u4fc3', 28: '5', 29: '\u5929', 30: '\u3002', 31: '\u751f', 32: '\u957f', 33: '\u80b2', 34: '\u8fdf', 35: '\u7f13', 36: '9', 37: '\u53f3', 38: '\u4fa7', 39: '\u5c0f', 40: '\u80ba', 41: '\u764c', 42: '\u7b2c', 43: '\u4e09', 44: '\u6b21', 45: '\u5316', 46: '\u7597', 47: '\u5165', 48: '\u9662', 49: '\u5fc3', 50: '\u60b8', 51: '\u52a0', 52: '\u91cd', 53: '\u80f8', 54: '\u75db', 55: '3', 56: '\u95f7', 57: '2', 58: '\u591a', 59: '\u6708', 60: '\u4f59', 61: ' ', 62: '\u5468', 63: '\u4e0a', 64: '\u80a2', 65: '\u65e0', 66: '\u529b', 67: '\u808c', 68: '\u8089', 69: '\u840e', 70: '\u7f29', 71: '\u534a'} # \u7f16\u7801\u4e0e\u6807\u7b7e\u5bf9\u7167\u5b57\u5178 id2tag = {0: 'O', 1: 'B-dis', 2: 'I-dis', 3: 'B-sym', 4: 'I-sym'} # \u8f93\u5165\u7684\u6570\u5b57\u5316sentences_sequence, \u7531\u4e0b\u9762\u7684sentence_list\u7ecf\u8fc7\u6620\u5c04\u51fd\u6570sentence_map()\u8f6c\u5316\u540e\u5f97\u5230 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] \u8c03\u7528: def sentence_map(sentence_list, char_to_id, max_length): sentence_list.sort(key=lambda c:len(c), reverse=True) sentence_map_list = [] for sentence in sentence_list: sentence_id_list = [char_to_id[c] for c in sentence] padding_list = [0] * (max_length-len(sentence)) sentence_id_list.extend(padding_list) sentence_map_list.append(sentence_id_list) return torch.tensor(sentence_map_list, dtype=torch.long) char_to_id = {\"<PAD>\":0} SENTENCE_LENGTH = 20 for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentences_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) if __name__ == '__main__': accuracy, recall, f1_score, acc_entities_length, predict_entities_length, true_entities_length = evaluate(sentences_sequence.tolist(), tag_list, predict_tag_list, id2char, id2tag) print(\"accuracy:\", accuracy, \"\\nrecall:\", recall, \"\\nf1_score:\", f1_score, \"\\nacc_entities_length:\", acc_entities_length, \"\\npredict_entities_length:\", predict_entities_length, \"\\ntrue_entities_length:\", true_entities_length) \u8f93\u51fa\u6548\u679c: step_acc: 0.8823529411764706 step_recall: 0.9375 f1_score: 0.9090909090909091 acc_entities_length: 15 predict_entities_length: 17 true_entities_length: 16 \u7b2c\u4e94\u6b65: \u5b8c\u6210\u8bad\u7ec3\u6a21\u578b\u7684\u4ee3\u7801. # \u5bfc\u5165\u5305 import json import time from tqdm import tqdm import matplotlib.pyplot as plt import torch import torch.optim as optim from torch.autograd import Variable # \u5bfc\u5165\u4e4b\u524d\u7f16\u5199\u597d\u7684\u5305, \u5305\u62ec\u7c7b, \u6570\u636e\u96c6\u52a0\u8f7d, \u8bc4\u4f30\u51fd\u6570 from bilstm_crf import BiLSTM_CRF from loader_data import load_dataset from evaluate_model import evaluate # \u8bad\u7ec3\u6a21\u578b\u7684\u51fd\u6570 def train(data_loader, data_size, batch_size, embedding_dim, hidden_dim, sentence_length, num_layers, epochs, learning_rate, tag2id, model_saved_path, train_log_path, validate_log_path, train_history_image_path): ''' data_loader: \u6570\u636e\u96c6\u7684\u52a0\u8f7d\u5668, \u4e4b\u524d\u5df2\u7ecf\u901a\u8fc7load_dataset\u5b8c\u6210\u4e86\u6784\u9020 data_size: \u8bad\u7ec3\u96c6\u548c\u6d4b\u8bd5\u96c6\u7684\u6837\u672c\u6570\u91cf batch_size: \u6279\u6b21\u7684\u6837\u672c\u4e2a\u6570 embedding_dim: \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 hidden_dim: \u9690\u85cf\u5c42\u7684\u7ef4\u5ea6 sentence_length: \u6587\u672c\u9650\u5236\u7684\u957f\u5ea6 num_layers: \u795e\u7ecf\u7f51\u7edc\u5806\u53e0\u7684LSTM\u5c42\u6570 epochs: \u8bad\u7ec3\u8fed\u4ee3\u7684\u8f6e\u6b21 learning_rate: \u5b66\u4e60\u7387 tag2id: \u6807\u7b7e\u5230id\u7684\u6620\u5c04\u5b57\u5178 model_saved_path: \u6a21\u578b\u4fdd\u5b58\u7684\u8def\u5f84 train_log_path: \u8bad\u7ec3\u65e5\u5fd7\u4fdd\u5b58\u7684\u8def\u5f84 validate_log_path: \u6d4b\u8bd5\u96c6\u65e5\u5fd7\u4fdd\u5b58\u7684\u8def\u5f84 train_history_image_path: \u8bad\u7ec3\u6570\u636e\u7684\u76f8\u5173\u56fe\u7247\u4fdd\u5b58\u8def\u5f84 ''' # \u5c06\u4e2d\u6587\u5b57\u7b26\u548cid\u7684\u5bf9\u5e94\u7801\u8868\u52a0\u8f7d\u8fdb\u5185\u5b58 char2id = json.load(open(\"./data/char_to_id.json\", mode=\"r\", encoding=\"utf-8\")) # \u521d\u59cb\u5316BiLSTM_CRF\u6a21\u578b model = BiLSTM_CRF(vocab_size=len(char2id), tag_to_ix=tag2id, embedding_dim=embedding_dim, hidden_dim=hidden_dim, batch_size=batch_size, num_layers=num_layers, sequence_length=sentence_length) # \u5b9a\u4e49\u4f18\u5316\u5668, \u4f7f\u7528SGD\u4f5c\u4e3a\u4f18\u5316\u5668(pytorch\u4e2dEmbedding\u652f\u6301\u7684GPU\u52a0\u901f\u4e3aSGD, SparseAdam\uff09 # \u53c2\u6570\u8bf4\u660e\u5982\u4e0b: # lr: \u4f18\u5316\u5668\u5b66\u4e60\u7387 # momentum: \u4f18\u5316\u4e0b\u964d\u7684\u52a8\u91cf\u56e0\u5b50, \u52a0\u901f\u68af\u5ea6\u4e0b\u964d\u8fc7\u7a0b optimizer = optim.SGD(params=model.parameters(), lr=learning_rate, momentum=0.85) # \u8bbe\u5b9a\u4f18\u5316\u5668\u5b66\u4e60\u7387\u66f4\u65b0\u7b56\u7565 # \u53c2\u6570\u8bf4\u660e\u5982\u4e0b: # optimizer: \u4f18\u5316\u5668 # step_size: \u66f4\u65b0\u9891\u7387, \u6bcf\u8fc7\u591a\u5c11\u4e2aepoch\u66f4\u65b0\u4e00\u6b21\u4f18\u5316\u5668\u5b66\u4e60\u7387 # gamma: \u5b66\u4e60\u7387\u8870\u51cf\u5e45\u5ea6, # \u6309\u7167\u4ec0\u4e48\u6bd4\u4f8b\u8c03\u6574(\u8870\u51cf)\u5b66\u4e60\u7387(\u76f8\u5bf9\u4e8e\u4e0a\u4e00\u8f6eepoch), \u9ed8\u8ba40.1 # \u4f8b\u5982: # \u521d\u59cb\u5b66\u4e60\u7387 lr = 0.5, step_size = 20, gamma = 0.1 # lr = 0.5 if epoch < 20 # lr = 0.05 if 20 <= epoch < 40 # lr = 0.005 if 40 <= epoch < 60 scheduler = optim.lr_scheduler.StepLR(optimizer=optimizer, step_size=5, gamma=0.2) # \u521d\u59cb\u5316\u5b58\u653e\u8bad\u7ec3\u4e2d\u635f\u5931, \u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u7b49\u6570\u503c\u6307\u6807 train_loss_list = [] train_acc_list = [] train_recall_list = [] train_f1_list = [] train_log_file = open(train_log_path, mode=\"w\", encoding=\"utf-8\") # \u521d\u59cb\u5316\u5b58\u653e\u6d4b\u8bd5\u4e2d\u635f\u5931, \u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u7b49\u6570\u503c\u6307\u6807 validate_loss_list = [] validate_acc_list = [] validate_recall_list = [] validate_f1_list = [] validate_log_file = open(validate_log_path, mode=\"w\", encoding=\"utf-8\") # \u5229\u7528tag2id\u751f\u6210id\u5230tag\u7684\u6620\u5c04\u5b57\u5178 id2tag = {v:k for k, v in tag2id.items()} # \u5229\u7528char2id\u751f\u6210id\u5230\u5b57\u7b26\u7684\u6620\u5c04\u5b57\u5178 id2char = {v:k for k, v in char2id.items()} # \u6309\u7167\u53c2\u6570epochs\u7684\u8bbe\u5b9a\u6765\u5faa\u73afepochs\u6b21 for epoch in range(epochs): # \u5728\u8fdb\u5ea6\u6761\u6253\u5370\u524d, \u5148\u8f93\u51fa\u5f53\u524d\u6240\u6267\u884c\u6279\u6b21 tqdm.write(\"Epoch {}/{}\".format(epoch + 1, epochs)) # \u5b9a\u4e49\u8981\u8bb0\u5f55\u7684\u6b63\u786e\u603b\u5b9e\u4f53\u6570, \u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length, \\ total_predict_entities_length, \\ total_gold_entities_length = 0, 0, 0 # \u5b9a\u4e49\u6bcfbatch\u6b65\u6570, \u6279\u6b21loss\u603b\u503c, \u51c6\u786e\u5ea6, f1\u503c step, total_loss, correct, f1 = 1, 0.0, 0, 0 # \u5f00\u542f\u5f53\u524depochs\u7684\u8bad\u7ec3\u90e8\u5206 for inputs, labels in tqdm(data_loader[\"train\"]): # \u5c06\u6570\u636e\u4ee5Variable\u8fdb\u884c\u5c01\u88c5 inputs, labels = Variable(inputs), Variable(labels) # \u5728\u8bad\u7ec3\u6a21\u578b\u671f\u95f4, \u8981\u5728\u6bcf\u4e2a\u6837\u672c\u8ba1\u7b97\u68af\u5ea6\u524d\u5c06\u4f18\u5316\u5668\u5f52\u96f6, \u4e0d\u7136\u68af\u5ea6\u4f1a\u88ab\u7d2f\u52a0 optimizer.zero_grad() # \u6b64\u5904\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684neg_log_likelihood()\u51fd\u6570 loss = model.neg_log_likelihood(inputs, labels) # \u83b7\u53d6\u5f53\u524d\u6b65\u7684loss, \u7531tensor\u8f6c\u4e3a\u6570\u5b57 step_loss = loss.data # \u7d2f\u8ba1\u6bcf\u6b65\u635f\u5931\u503c total_loss += step_loss # \u83b7\u53d6\u89e3\u7801\u6700\u4f73\u8def\u5f84\u5217\u8868, \u6b64\u65f6\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684forward()\u51fd\u6570 best_path_list = model(inputs) # \u6a21\u578b\u8bc4\u4f30\u6307\u6807\u503c\u83b7\u53d6\u5305\u62ec:\u5f53\u524d\u6279\u6b21\u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u503c\u4ee5\u53ca\u5bf9\u5e94\u7684\u5b9e\u4f53\u4e2a\u6570 step_acc, step_recall, f1_score, acc_entities_length, \\ predict_entities_length, gold_entities_length = evaluate(inputs.tolist(), labels.tolist(), best_path_list, id2char, id2tag) # \u8bad\u7ec3\u65e5\u5fd7\u5185\u5bb9 log_text = \"Epoch: %s | Step: %s \" \\ \"| loss: %.5f \" \\ \"| acc: %.5f \" \\ \"| recall: %.5f \" \\ \"| f1 score: %.5f\" % \\ (epoch, step, step_loss, step_acc, step_recall,f1_score) # \u5206\u522b\u7d2f\u8ba1\u6b63\u786e\u603b\u5b9e\u4f53\u6570\u3001\u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length += acc_entities_length total_predict_entities_length += predict_entities_length total_gold_entities_length += gold_entities_length # \u5bf9\u635f\u5931\u51fd\u6570\u8fdb\u884c\u53cd\u5411\u4f20\u64ad loss.backward() # \u901a\u8fc7optimizer.step()\u8ba1\u7b97\u635f\u5931, \u68af\u5ea6\u548c\u66f4\u65b0\u53c2\u6570 optimizer.step() # \u8bb0\u5f55\u8bad\u7ec3\u65e5\u5fd7 train_log_file.write(log_text + \"\\n\") step += 1 # \u83b7\u53d6\u5f53\u524depochs\u5e73\u5747\u635f\u5931\u503c(\u6bcf\u4e00\u8f6e\u8fed\u4ee3\u7684\u635f\u5931\u603b\u503c\u9664\u4ee5\u603b\u6570\u636e\u91cf) epoch_loss = total_loss / data_size[\"train\"] # \u8ba1\u7b97\u5f53\u524depochs\u51c6\u786e\u7387 total_acc = total_acc_entities_length / total_predict_entities_length # \u8ba1\u7b97\u5f53\u524depochs\u53ec\u56de\u7387 total_recall = total_acc_entities_length / total_gold_entities_length # \u8ba1\u7b97\u5f53\u524depochs\u7684F1\u503c total_f1 = 0 if total_acc + total_recall != 0: total_f1 = 2 * total_acc * total_recall / (total_acc + total_recall) log_text = \"Epoch: %s \" \\ \"| mean loss: %.5f \" \\ \"| total acc: %.5f \" \\ \"| total recall: %.5f \" \\ \"| total f1 scroe: %.5f\" % (epoch, epoch_loss, total_acc, total_recall, total_f1) # \u5f53\u524depochs\u8bad\u7ec3\u540e\u66f4\u65b0\u5b66\u4e60\u7387, \u5fc5\u987b\u5728\u4f18\u5316\u5668\u66f4\u65b0\u4e4b\u540e scheduler.step() # \u8bb0\u5f55\u5f53\u524depochs\u8bad\u7ec3loss\u503c(\u7528\u4e8e\u56fe\u8868\u5c55\u793a), \u51c6\u786e\u7387, \u53ec\u56de\u7387, f1\u503c train_loss_list.append(epoch_loss) train_acc_list.append(total_acc) train_recall_list.append(total_recall) train_f1_list.append(total_f1) train_log_file.write(log_text + \"\\n\") # \u5b9a\u4e49\u8981\u8bb0\u5f55\u7684\u6b63\u786e\u603b\u5b9e\u4f53\u6570, \u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length, \\ total_predict_entities_length, \\ total_gold_entities_length = 0, 0, 0 # \u5b9a\u4e49\u6bcfbatch\u6b65\u6570, \u6279\u6b21loss\u603b\u503c, \u51c6\u786e\u5ea6, f1\u503c step, total_loss, correct, f1 = 1, 0.0, 0, 0 # \u5f00\u542f\u5f53\u524depochs\u7684\u9a8c\u8bc1\u90e8\u5206 for inputs, labels in tqdm(data_loader[\"validation\"]): # \u5c06\u6570\u636e\u4ee5Variable\u8fdb\u884c\u5c01\u88c5 inputs, labels = Variable(inputs), Variable(labels) # \u6b64\u5904\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684neg_log_likelihood \u51fd\u6570 # \u8fd4\u56de\u6700\u7ec8\u7684CRF\u7684\u5bf9\u6570\u4f3c\u7136\u7ed3\u679c loss = model.neg_log_likelihood(inputs, labels) # \u83b7\u53d6\u5f53\u524d\u6b65\u7684loss\u503c, \u7531tensor\u8f6c\u4e3a\u6570\u5b57 step_loss = loss.data # \u7d2f\u8ba1\u6bcf\u6b65\u635f\u5931\u503c total_loss += step_loss # \u83b7\u53d6\u89e3\u7801\u6700\u4f73\u8def\u5f84\u5217\u8868, \u6b64\u65f6\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684forward()\u51fd\u6570 best_path_list = model(inputs) # \u6a21\u578b\u8bc4\u4f30\u6307\u6807\u503c\u83b7\u53d6: \u5f53\u524d\u6279\u6b21\u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u503c\u4ee5\u53ca\u5bf9\u5e94\u7684\u5b9e\u4f53\u4e2a\u6570 step_acc, step_recall, f1_score, acc_entities_length, \\ predict_entities_length, gold_entities_length = evaluate(inputs.tolist(), labels.tolist(), best_path_list, id_to_char, id_to_tag) # \u8bad\u7ec3\u65e5\u5fd7\u5185\u5bb9 log_text = \"Epoch: %s | Step: %s \" \\ \"| loss: %.5f \" \\ \"| acc: %.5f \" \\ \"| recall: %.5f \" \\ \"| f1 score: %.5f\" % \\ (epoch, step, step_loss, step_acc, step_recall,f1_score) # \u5206\u522b\u7d2f\u8ba1\u6b63\u786e\u603b\u5b9e\u4f53\u6570\u3001\u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length += acc_entities_length total_predict_entities_length += predict_entities_length total_gold_entities_length += gold_entities_length # \u8bb0\u5f55\u9a8c\u8bc1\u96c6\u635f\u5931\u65e5\u5fd7 validate_log_file.write(log_text + \"\\n\") step += 1 # \u83b7\u53d6\u5f53\u524d\u6279\u6b21\u5e73\u5747\u635f\u5931\u503c(\u6bcf\u4e00\u6279\u6b21\u635f\u5931\u603b\u503c\u9664\u4ee5\u6570\u636e\u91cf) epoch_loss = total_loss / data_size[\"validation\"] # \u8ba1\u7b97\u603b\u6279\u6b21\u51c6\u786e\u7387 total_acc = total_acc_entities_length / total_predict_entities_length # \u8ba1\u7b97\u603b\u6279\u6b21\u53ec\u56de\u7387 total_recall = total_acc_entities_length / total_gold_entities_length # \u8ba1\u7b97\u603b\u6279\u6b21F1\u503c total_f1 = 0 if total_acc + total_recall != 0: total_f1 = 2 * total_acc * total_recall / (total_acc + total_recall) log_text = \"Epoch: %s \" \\ \"| mean loss: %.5f \" \\ \"| total acc: %.5f \" \\ \"| total recall: %.5f \" \\ \"| total f1 scroe: %.5f\" % (epoch, epoch_loss, total_acc, total_recall, total_f1) # \u8bb0\u5f55\u5f53\u524d\u6279\u6b21\u9a8c\u8bc1loss\u503c(\u7528\u4e8e\u56fe\u8868\u5c55\u793a)\u51c6\u786e\u7387, \u53ec\u56de\u7387, f1\u503c validate_loss_list.append(epoch_loss) validate_acc_list.append(total_acc) validate_recall_list.append(total_recall) validate_f1_list.append(total_f1) validate_log_file.write(log_text + \"\\n\") # \u4fdd\u5b58\u6a21\u578b torch.save(model.state_dict(), model_saved_path) # \u5c06loss\u4e0b\u964d\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_loss_list, validate_loss_list, train_history_image_path, \"Loss\") # \u5c06\u51c6\u786e\u7387\u63d0\u5347\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_acc_list, validate_acc_list, train_history_image_path, \"Acc\") # \u5c06\u53ec\u56de\u7387\u63d0\u5347\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_recall_list, validate_recall_list, train_history_image_path, \"Recall\") # \u5c06F1\u4e0a\u5347\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_f1_list, validate_f1_list, train_history_image_path, \"F1\") print(\"train Finished\".center(100, \"-\")) # \u6309\u7167\u4f20\u5165\u7684\u4e0d\u540c\u8def\u5f84, \u7ed8\u5236\u4e0d\u540c\u7684\u8bad\u7ec3\u66f2\u7ebf def save_train_history_image(train_history_list, validate_history_list, history_image_path, data_type): # \u6839\u636e\u8bad\u7ec3\u96c6\u7684\u6570\u636e\u5217\u8868, \u7ed8\u5236\u6298\u7ebf\u56fe plt.plot(train_history_list, label=\"Train %s History\" % (data_type)) # \u6839\u636e\u6d4b\u8bd5\u96c6\u7684\u6570\u636e\u5217\u8868, \u7ed8\u5236\u6298\u7ebf\u56fe plt.plot(validate_history_list, label=\"Validate %s History\" % (data_type)) # \u5c06\u56fe\u7247\u653e\u7f6e\u5728\u6700\u4f18\u4f4d\u7f6e plt.legend(loc=\"best\") # \u8bbe\u7f6ex\u8f74\u7684\u56fe\u6807\u4e3a\u8f6e\u6b21Epochs plt.xlabel(\"Epochs\") # \u8bbe\u7f6ey\u8f74\u7684\u56fe\u6807\u4e3a\u53c2\u6570data_type plt.ylabel(data_type) # \u5c06\u7ed8\u5236\u597d\u7684\u56fe\u7247\u4fdd\u5b58\u5728\u7279\u5b9a\u7684\u8def\u5f84\u4e0b\u9762, \u5e76\u4fee\u6539\u56fe\u7247\u540d\u5b57\u4e2d\u7684\"plot\"\u4e3a\u5bf9\u5e94\u7684data_type plt.savefig(history_image_path.replace(\"plot\", data_type)) plt.close() \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/train.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65702:\u8bad\u7ec3\u6570\u636e\u6587\u4ef6\u8def\u5f84 train_data_file_path = \"data/train.npz\" # \u53c2\u65703:\u52a0\u8f7d DataLoader \u6570\u636e data_loader, data_size = load_dataset(train_data_file_path, BATCH_SIZE) # \u53c2\u65704:\u8bb0\u5f55\u5f53\u524d\u8bad\u7ec3\u65f6\u95f4\uff08\u62fc\u6210\u5b57\u7b26\u4e32\u7528\uff09 time_str = time.strftime(\"%Y%m%d_%H%M%S\", time.localtime(time.time())) # \u53c2\u65705:\u6807\u7b7e\u7801\u8868\u5bf9\u7167 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65706:\u8bad\u7ec3\u6587\u4ef6\u5b58\u653e\u8def\u5f84 model_saved_path = \"model/bilstm_crf_state_dict_%s.pt\" % (time_str) # \u53c2\u65707:\u8bad\u7ec3\u65e5\u5fd7\u6587\u4ef6\u5b58\u653e\u8def\u5f84 train_log_path = \"log/train_%s.log\" % (time_str) # \u53c2\u65708:\u9a8c\u8bc1\u6253\u5370\u65e5\u5fd7\u5b58\u653e\u8def\u5f84 validate_log_path = \"log/validate_%s.log\" % (time_str) # \u53c2\u65709:\u8bad\u7ec3\u5386\u53f2\u8bb0\u5f55\u56fe\u5b58\u653e\u8def\u5f84 train_history_image_path = \"log/bilstm_crf_train_plot_%s.png\" % (time_str) # \u53c2\u657010:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u657011:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u657012:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u657013:\u5806\u53e0 LSTM \u5c42\u6570 NUM_LAYERS = 1 # \u53c2\u657014:\u8bad\u7ec3\u6279\u6b21 EPOCHS = 100 # \u53c2\u657015:\u521d\u59cb\u5316\u5b66\u4e60\u7387 LEARNING_RATE = 0.5 \u8c03\u7528: if __name__ == '__main__': train(data_loader, data_size, BATCH_SIZE, EMBEDDING_DIM, HIDDEN_DIM, SENTENCE_LENGTH, NUM_LAYERS, EPOCHS, LEARNING_RATE, tag_to_id, model_saved_path, train_log_path, validate_log_path, train_history_image_path) \u8f93\u51fa\u6548\u679c: \u6a21\u578b\u8bad\u7ec3\u7ed3\u679c\u6587\u4ef6\u4fdd\u5b58\u4f4d\u7f6e:model/bilstm_crf_state_dict_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].pt \u6a21\u578b\u8bad\u7ec3\u65e5\u5fd7\u6587\u4ef6\u4fdd\u5b58\u4f4d\u7f6e:log/train_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].log \u6a21\u578b\u9a8c\u8bc1\u65e5\u5fd7\u6587\u4ef6\u4fdd\u5b58\u4f4d\u7f6e:log/validate_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].log \u6a21\u578b\u8bad\u7ec3\u635f\u5931\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_Loss_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u6a21\u578b\u8bad\u7ec3\u51c6\u786e\u7387\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_Acc_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u6a21\u578b\u8bad\u7ec3\u53ec\u56de\u7387\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_Recall_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u6a21\u578b\u8bad\u7ec3F1\u503c\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_F1_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u8bad\u7ec3\u65e5\u5fd7: Epoch: 0 | train loss: 366.58832 |acc: 0.632 |recall: 0.503 |f1 score: 0.56 | validate loss: 666.032 |acc: 0.591 |recall: 0.457 |f1 score: 0.515 Epoch: 1 | train loss: 123.87159 |acc: 0.743 |recall: 0.687 |f1 score: 0.714 | validate loss: 185.021 |acc: 0.669 |recall: 0.606 |f1 score: 0.636 Epoch: 2 | train loss: 113.04003 |acc: 0.738 |recall: 0.706 |f1 score: 0.722 | validate loss: 107.393 |acc: 0.711 |recall: 0.663 |f1 score: 0.686 Epoch: 3 | train loss: 119.14317 |acc: 0.751 |recall: 0.692 |f1 score: 0.721 | validate loss: 158.381 |acc: 0.713 |recall: 0.64 |f1 score: 0.674 Epoch: 4 | train loss: 105.81506 |acc: 0.741 |recall: 0.699 |f1 score: 0.72 | validate loss: 118.99 |acc: 0.669 |recall: 0.624 |f1 score: 0.646 Epoch: 5 | train loss: 86.67545 |acc: 0.773 |recall: 0.751 |f1 score: 0.762 | validate loss: 123.636 |acc: 0.64 |recall: 0.718 |f1 score: 0.676 Epoch: 6 | train loss: 79.66924 |acc: 0.808 |recall: 0.772 |f1 score: 0.789 | validate loss: 89.771 |acc: 0.735 |recall: 0.714 |f1 score: 0.724 Epoch: 7 | train loss: 85.35771 |acc: 0.766 |recall: 0.752 |f1 score: 0.759 | validate loss: 141.233 |acc: 0.675 |recall: 0.7 |f1 score: 0.687 Epoch: 8 | train loss: 82.38535 |acc: 0.787 |recall: 0.748 |f1 score: 0.767 | validate loss: 108.429 |acc: 0.717 |recall: 0.673 |f1 score: 0.694 Epoch: 9 | train loss: 82.46296 |acc: 0.783 |recall: 0.751 |f1 score: 0.767 | validate loss: 74.716 |acc: 0.692 |recall: 0.702 |f1 score: 0.697 Epoch: 10 | train loss: 75.12292 |acc: 0.814 |recall: 0.779 |f1 score: 0.796 | validate loss: 90.693 |acc: 0.672 |recall: 0.7 |f1 score: 0.686 Epoch: 11 | train loss: 74.89426 |acc: 0.813 |recall: 0.77 |f1 score: 0.791 | validate loss: 77.161 |acc: 0.729 |recall: 0.718 |f1 score: 0.724 Epoch: 12 | train loss: 76.39055 |acc: 0.814 |recall: 0.785 |f1 score: 0.799 | validate loss: 132.545 |acc: 0.806 |recall: 0.685 |f1 score: 0.74 Epoch: 13 | train loss: 75.01093 |acc: 0.814 |recall: 0.787 |f1 score: 0.8 | validate loss: 101.596 |acc: 0.765 |recall: 0.681 |f1 score: 0.721 Epoch: 14 | train loss: 74.35796 |acc: 0.83 |recall: 0.802 |f1 score: 0.816 | validate loss: 92.535 |acc: 0.745 |recall: 0.777 |f1 score: 0.761 Epoch: 15 | train loss: 73.27102 |acc: 0.818 |recall: 0.791 |f1 score: 0.804 | validate loss: 109.51 |acc: 0.68 |recall: 0.76 |f1 score: 0.717 Epoch: 16 | train loss: 67.66725 |acc: 0.841 |recall: 0.811 |f1 score: 0.826 | validate loss: 93.047 |acc: 0.768 |recall: 0.738 |f1 score: 0.753 Epoch: 17 | train loss: 63.75809 |acc: 0.83 |recall: 0.813 |f1 score: 0.822 | validate loss: 76.231 |acc: 0.784 |recall: 0.776 |f1 score: 0.78 Epoch: 18 | train loss: 60.30417 |acc: 0.845 |recall: 0.829 |f1 score: 0.837 | validate loss: 76.019 |acc: 0.806 |recall: 0.758 |f1 score: 0.781 Epoch: 19 | train loss: 60.30238 |acc: 0.849 |recall: 0.823 |f1 score: 0.836 | validate loss: 90.269 |acc: 0.748 |recall: 0.733 |f1 score: 0.741 Epoch: 20 | train loss: 60.20072 |acc: 0.847 |recall: 0.82 |f1 score: 0.833 | validate loss: 61.756 |acc: 0.81 |recall: 0.77 |f1 score: 0.79 Epoch: 21 | train loss: 58.98606 |acc: 0.844 |recall: 0.82 |f1 score: 0.832 | validate loss: 60.799 |acc: 0.765 |recall: 0.754 |f1 score: 0.759 Epoch: 22 | train loss: 60.23671 |acc: 0.848 |recall: 0.828 |f1 score: 0.838 | validate loss: 65.676 |acc: 0.787 |recall: 0.781 |f1 score: 0.784 Epoch: 23 | train loss: 58.57862 |acc: 0.849 |recall: 0.827 |f1 score: 0.838 | validate loss: 65.975 |acc: 0.794 |recall: 0.754 |f1 score: 0.774 Epoch: 24 | train loss: 58.93968 |acc: 0.848 |recall: 0.827 |f1 score: 0.838 | validate loss: 66.994 |acc: 0.784 |recall: 0.746 |f1 score: 0.764 Epoch: 25 | train loss: 59.91834 |acc: 0.862 |recall: 0.828 |f1 score: 0.845 | validate loss: 68.794 |acc: 0.795 |recall: 0.756 |f1 score: 0.775 Epoch: 26 | train loss: 59.09166 |acc: 0.84 |recall: 0.823 |f1 score: 0.831 | validate loss: 68.508 |acc: 0.746 |recall: 0.758 |f1 score: 0.752 Epoch: 27 | train loss: 58.0584 |acc: 0.856 |recall: 0.84 |f1 score: 0.848 | validate loss: 53.158 |acc: 0.802 |recall: 0.774 |f1 score: 0.788 Epoch: 28 | train loss: 54.2857 |acc: 0.858 |recall: 0.834 |f1 score: 0.845 | validate loss: 60.243 |acc: 0.816 |recall: 0.772 |f1 score: 0.793 Epoch: 29 | train loss: 56.44759 |acc: 0.845 |recall: 0.838 |f1 score: 0.841 | validate loss: 56.497 |acc: 0.768 |recall: 0.77 |f1 score: 0.769 Epoch: 30 | train loss: 57.90492 |acc: 0.868 |recall: 0.832 |f1 score: 0.85 | validate loss: 75.158 |acc: 0.773 |recall: 0.762 |f1 score: 0.768 Epoch: 31 | train loss: 56.81468 |acc: 0.861 |recall: 0.835 |f1 score: 0.847 | validate loss: 56.742 |acc: 0.796 |recall: 0.784 |f1 score: 0.79 Epoch: 32 | train loss: 54.72623 |acc: 0.86 |recall: 0.844 |f1 score: 0.852 | validate loss: 63.175 |acc: 0.757 |recall: 0.78 |f1 score: 0.768 Epoch: 33 | train loss: 60.10299 |acc: 0.846 |recall: 0.813 |f1 score: 0.829 | validate loss: 68.994 |acc: 0.768 |recall: 0.724 |f1 score: 0.745 Epoch: 34 | train loss: 59.67491 |acc: 0.849 |recall: 0.826 |f1 score: 0.837 | validate loss: 58.662 |acc: 0.8 |recall: 0.739 |f1 score: 0.769 Epoch: 35 | train loss: 65.01099 |acc: 0.857 |recall: 0.83 |f1 score: 0.844 | validate loss: 69.299 |acc: 0.772 |recall: 0.752 |f1 score: 0.762 Epoch: 36 | train loss: 61.52783 |acc: 0.856 |recall: 0.828 |f1 score: 0.842 | validate loss: 82.373 |acc: 0.761 |recall: 0.777 |f1 score: 0.769 Epoch: 37 | train loss: 66.19576 |acc: 0.844 |recall: 0.822 |f1 score: 0.833 | validate loss: 79.853 |acc: 0.791 |recall: 0.77 |f1 score: 0.781 Epoch: 38 | train loss: 60.32529 |acc: 0.841 |recall: 0.828 |f1 score: 0.835 | validate loss: 69.346 |acc: 0.773 |recall: 0.755 |f1 score: 0.764 Epoch: 39 | train loss: 63.8836 |acc: 0.837 |recall: 0.819 |f1 score: 0.828 | validate loss: 74.759 |acc: 0.732 |recall: 0.759 |f1 score: 0.745 Epoch: 40 | train loss: 67.28363 |acc: 0.838 |recall: 0.824 |f1 score: 0.831 | validate loss: 63.027 |acc: 0.768 |recall: 0.764 |f1 score: 0.766 Epoch: 41 | train loss: 61.40488 |acc: 0.852 |recall: 0.826 |f1 score: 0.839 | validate loss: 58.976 |acc: 0.802 |recall: 0.755 |f1 score: 0.778 Epoch: 42 | train loss: 61.04982 |acc: 0.856 |recall: 0.817 |f1 score: 0.836 | validate loss: 58.47 |acc: 0.783 |recall: 0.74 |f1 score: 0.761 Epoch: 43 | train loss: 64.40567 |acc: 0.849 |recall: 0.821 |f1 score: 0.835 | validate loss: 63.506 |acc: 0.764 |recall: 0.765 |f1 score: 0.765 Epoch: 44 | train loss: 65.09746 |acc: 0.845 |recall: 0.805 |f1 score: 0.825 | validate loss: 65.535 |acc: 0.773 |recall: 0.743 |f1 score: 0.758 Epoch: 45 | train loss: 63.26585 |acc: 0.848 |recall: 0.808 |f1 score: 0.827 | validate loss: 62.477 |acc: 0.789 |recall: 0.733 |f1 score: 0.76 Epoch: 46 | train loss: 63.91504 |acc: 0.847 |recall: 0.812 |f1 score: 0.829 | validate loss: 59.916 |acc: 0.779 |recall: 0.751 |f1 score: 0.765 Epoch: 47 | train loss: 62.3592 |acc: 0.845 |recall: 0.824 |f1 score: 0.835 | validate loss: 63.363 |acc: 0.775 |recall: 0.761 |f1 score: 0.768 Epoch: 48 | train loss: 63.13221 |acc: 0.843 |recall: 0.823 |f1 score: 0.833 | validate loss: 65.71 |acc: 0.767 |recall: 0.755 |f1 score: 0.761 Epoch: 49 | train loss: 64.9964 |acc: 0.845 |recall: 0.811 |f1 score: 0.828 | validate loss: 65.174 |acc: 0.768 |recall: 0.74 |f1 score: 0.754 Epoch: 50 | train loss: 62.40605 |acc: 0.847 |recall: 0.817 |f1 score: 0.832 | validate loss: 60.761 |acc: 0.776 |recall: 0.746 |f1 score: 0.761 Epoch: 51 | train loss: 63.05476 |acc: 0.845 |recall: 0.812 |f1 score: 0.828 | validate loss: 64.217 |acc: 0.764 |recall: 0.748 |f1 score: 0.756 Epoch: 52 | train loss: 59.77727 |acc: 0.84 |recall: 0.831 |f1 score: 0.836 | validate loss: 60.48 |acc: 0.79 |recall: 0.759 |f1 score: 0.774 Epoch: 53 | train loss: 62.7249 |acc: 0.828 |recall: 0.813 |f1 score: 0.821 | validate loss: 64.584 |acc: 0.757 |recall: 0.757 |f1 score: 0.757 Epoch: 54 | train loss: 61.1763 |acc: 0.842 |recall: 0.832 |f1 score: 0.837 | validate loss: 61.088 |acc: 0.775 |recall: 0.768 |f1 score: 0.771 Epoch: 55 | train loss: 64.04366 |acc: 0.835 |recall: 0.816 |f1 score: 0.826 | validate loss: 68.183 |acc: 0.784 |recall: 0.742 |f1 score: 0.762 Epoch: 56 | train loss: 66.76939 |acc: 0.84 |recall: 0.813 |f1 score: 0.827 | validate loss: 67.284 |acc: 0.77 |recall: 0.748 |f1 score: 0.759 Epoch: 57 | train loss: 67.85329 |acc: 0.826 |recall: 0.789 |f1 score: 0.807 | validate loss: 69.961 |acc: 0.766 |recall: 0.732 |f1 score: 0.749 Epoch: 58 | train loss: 64.79573 |acc: 0.84 |recall: 0.812 |f1 score: 0.826 | validate loss: 73.358 |acc: 0.754 |recall: 0.735 |f1 score: 0.745 Epoch: 59 | train loss: 65.36249 |acc: 0.862 |recall: 0.826 |f1 score: 0.844 | validate loss: 66.552 |acc: 0.783 |recall: 0.766 |f1 score: 0.774 Epoch: 60 | train loss: 63.43061 |acc: 0.835 |recall: 0.811 |f1 score: 0.823 | validate loss: 63.138 |acc: 0.771 |recall: 0.746 |f1 score: 0.759 Epoch: 61 | train loss: 62.34639 |acc: 0.848 |recall: 0.825 |f1 score: 0.836 | validate loss: 59.656 |acc: 0.783 |recall: 0.756 |f1 score: 0.769 Epoch: 62 | train loss: 61.83451 |acc: 0.83 |recall: 0.814 |f1 score: 0.822 | validate loss: 60.443 |acc: 0.765 |recall: 0.751 |f1 score: 0.758 Epoch: 63 | train loss: 64.78461 |acc: 0.854 |recall: 0.818 |f1 score: 0.836 | validate loss: 61.125 |acc: 0.786 |recall: 0.748 |f1 score: 0.767 Epoch: 64 | train loss: 63.43409 |acc: 0.838 |recall: 0.818 |f1 score: 0.828 | validate loss: 62.396 |acc: 0.77 |recall: 0.757 |f1 score: 0.764 Epoch: 65 | train loss: 61.20197 |acc: 0.854 |recall: 0.815 |f1 score: 0.834 | validate loss: 59.019 |acc: 0.79 |recall: 0.75 |f1 score: 0.769 Epoch: 66 | train loss: 59.69791 |acc: 0.851 |recall: 0.82 |f1 score: 0.836 | validate loss: 55.06 |acc: 0.789 |recall: 0.754 |f1 score: 0.771 Epoch: 67 | train loss: 63.16074 |acc: 0.836 |recall: 0.811 |f1 score: 0.823 | validate loss: 61.48 |acc: 0.764 |recall: 0.745 |f1 score: 0.755 Epoch: 68 | train loss: 62.15521 |acc: 0.845 |recall: 0.824 |f1 score: 0.835 | validate loss: 62.407 |acc: 0.778 |recall: 0.761 |f1 score: 0.769 Epoch: 69 | train loss: 61.90574 |acc: 0.847 |recall: 0.828 |f1 score: 0.838 | validate loss: 59.801 |acc: 0.781 |recall: 0.762 |f1 score: 0.771 Epoch: 70 | train loss: 60.51348 |acc: 0.852 |recall: 0.827 |f1 score: 0.839 | validate loss: 56.632 |acc: 0.781 |recall: 0.761 |f1 score: 0.771 Epoch: 71 | train loss: 62.78683 |acc: 0.856 |recall: 0.823 |f1 score: 0.84 | validate loss: 62.867 |acc: 0.796 |recall: 0.757 |f1 score: 0.776 Epoch: 72 | train loss: 62.11708 |acc: 0.845 |recall: 0.82 |f1 score: 0.833 | validate loss: 57.211 |acc: 0.784 |recall: 0.754 |f1 score: 0.769 Epoch: 73 | train loss: 63.2298 |acc: 0.839 |recall: 0.816 |f1 score: 0.828 | validate loss: 60.247 |acc: 0.764 |recall: 0.752 |f1 score: 0.758 Epoch: 74 | train loss: 61.87119 |acc: 0.848 |recall: 0.828 |f1 score: 0.838 | validate loss: 59.692 |acc: 0.782 |recall: 0.765 |f1 score: 0.774 Epoch: 75 | train loss: 59.88628 |acc: 0.851 |recall: 0.821 |f1 score: 0.836 | validate loss: 59.461 |acc: 0.78 |recall: 0.755 |f1 score: 0.767 Epoch: 76 | train loss: 61.97182 |acc: 0.858 |recall: 0.812 |f1 score: 0.835 | validate loss: 59.748 |acc: 0.78 |recall: 0.749 |f1 score: 0.765 Epoch: 77 | train loss: 62.2035 |acc: 0.836 |recall: 0.811 |f1 score: 0.823 | validate loss: 56.778 |acc: 0.768 |recall: 0.748 |f1 score: 0.758 Epoch: 78 | train loss: 59.90309 |acc: 0.846 |recall: 0.823 |f1 score: 0.835 | validate loss: 59.424 |acc: 0.771 |recall: 0.76 |f1 score: 0.765 Epoch: 79 | train loss: 62.48097 |acc: 0.844 |recall: 0.821 |f1 score: 0.833 | validate loss: 57.535 |acc: 0.769 |recall: 0.755 |f1 score: 0.762 Epoch: 80 | train loss: 65.83723 |acc: 0.853 |recall: 0.83 |f1 score: 0.842 | validate loss: 60.798 |acc: 0.782 |recall: 0.762 |f1 score: 0.772 Epoch: 81 | train loss: 67.69897 |acc: 0.848 |recall: 0.812 |f1 score: 0.83 | validate loss: 62.135 |acc: 0.78 |recall: 0.746 |f1 score: 0.763 Epoch: 82 | train loss: 64.45554 |acc: 0.863 |recall: 0.845 |f1 score: 0.854 | validate loss: 62.102 |acc: 0.793 |recall: 0.775 |f1 score: 0.784 Epoch: 83 | train loss: 59.9239 |acc: 0.857 |recall: 0.84 |f1 score: 0.848 | validate loss: 57.003 |acc: 0.788 |recall: 0.771 |f1 score: 0.779 Epoch: 84 | train loss: 65.42567 |acc: 0.859 |recall: 0.831 |f1 score: 0.845 | validate loss: 61.993 |acc: 0.788 |recall: 0.763 |f1 score: 0.775 Epoch: 85 | train loss: 62.69893 |acc: 0.852 |recall: 0.828 |f1 score: 0.84 | validate loss: 59.489 |acc: 0.786 |recall: 0.761 |f1 score: 0.773 Epoch: 86 | train loss: 64.58199 |acc: 0.858 |recall: 0.831 |f1 score: 0.845 | validate loss: 60.414 |acc: 0.789 |recall: 0.764 |f1 score: 0.776 Epoch: 87 | train loss: 58.41865 |acc: 0.875 |recall: 0.838 |f1 score: 0.856 | validate loss: 56.525 |acc: 0.805 |recall: 0.768 |f1 score: 0.786 Epoch: 88 | train loss: 61.39529 |acc: 0.848 |recall: 0.824 |f1 score: 0.836 | validate loss: 56.678 |acc: 0.783 |recall: 0.759 |f1 score: 0.771 Epoch: 89 | train loss: 63.69639 |acc: 0.857 |recall: 0.818 |f1 score: 0.837 | validate loss: 59.014 |acc: 0.787 |recall: 0.751 |f1 score: 0.769 Epoch: 90 | train loss: 61.78225 |acc: 0.841 |recall: 0.84 |f1 score: 0.84 | validate loss: 59.58 |acc: 0.773 |recall: 0.775 |f1 score: 0.774 Epoch: 91 | train loss: 58.19114 |acc: 0.845 |recall: 0.826 |f1 score: 0.836 | validate loss: 55.284 |acc: 0.776 |recall: 0.758 |f1 score: 0.767 Epoch: 92 | train loss: 58.67227 |acc: 0.857 |recall: 0.82 |f1 score: 0.838 | validate loss: 54.982 |acc: 0.787 |recall: 0.753 |f1 score: 0.77 Epoch: 93 | train loss: 60.79532 |acc: 0.858 |recall: 0.83 |f1 score: 0.844 | validate loss: 57.808 |acc: 0.792 |recall: 0.764 |f1 score: 0.778 Epoch: 94 | train loss: 56.71145 |acc: 0.872 |recall: 0.851 |f1 score: 0.861 | validate loss: 53.551 |acc: 0.804 |recall: 0.785 |f1 score: 0.795 Epoch: 95 | train loss: 58.791 |acc: 0.864 |recall: 0.83 |f1 score: 0.847 | validate loss: 54.284 |acc: 0.793 |recall: 0.765 |f1 score: 0.779 Epoch: 96 | train loss: 60.07491 |acc: 0.849 |recall: 0.828 |f1 score: 0.839 | validate loss: 55.524 |acc: 0.78 |recall: 0.764 |f1 score: 0.772 Epoch: 97 | train loss: 61.53479 |acc: 0.86 |recall: 0.825 |f1 score: 0.842 | validate loss: 56.891 |acc: 0.796 |recall: 0.759 |f1 score: 0.777 Epoch: 98 | train loss: 61.94878 |acc: 0.85 |recall: 0.836 |f1 score: 0.843 | validate loss: 57.019 |acc: 0.783 |recall: 0.771 |f1 score: 0.777 Epoch: 99 | train loss: 58.49541 |acc: 0.86 |recall: 0.834 |f1 score: 0.847 | validate loss: 56.162 |acc: 0.795 |recall: 0.767 |f1 score: 0.781 \u7b2c\u516d\u6b65: \u7ed8\u5236\u635f\u5931\u66f2\u7ebf\u548c\u8bc4\u4f30\u66f2\u7ebf\u56fe \u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u635f\u5931\u5bf9\u7167\u66f2\u7ebf\u4e00\u76f4\u4e0b\u964d, \u4ece\u7b2c5\u4e2aepoch\u5f00\u59cb, \u8fc5\u901f\u964d\u5230\u6bd4\u8f83\u7406\u60f3\u7684\u4f4d\u7f6e, \u8bf4\u660e\u6a21\u578b\u80fd\u591f\u4ece\u6570\u636e\u4e2d\u83b7\u53d6\u89c4\u5f8b\u4e86, \u5230\u7b2c40\u4e2a\u6279\u6b21\u4e4b\u540e, \u6a21\u578b\u8d8b\u4e8e\u7a33\u5b9a, \u8bf4\u660e\u53c2\u6570\u57fa\u672c\u80fd\u591f\u5df2\u7ecf\u5f97\u5230\u6700\u4f18\u5316\u6548\u679c, \u6b64\u65f6, \u6839\u636e\u5bf9scheduler\u7684\u8bbe\u7f6e, \u901a\u8fc7\u8be5\u65b9\u6cd5\u5df2\u7ecf\u5bf9\u4f18\u5316\u5668\u8fdb\u884c\u4e86\u8fd18\u6b21\u7684\u8fed\u4ee3, \u5e94\u8be5\u5728\u6211\u4eec\u539f\u672c\u8bbe\u7f6e\u7684\u521d\u59cb\u5b66\u4e60\u7387\u57fa\u7840\u4e0a\u7f29\u5c0f\u4e860.2\u76848\u6b21\u65b9\u500d, \u6b64\u65f6\u5e94\u8be5\u627e\u5230\u4e86\u5f53\u524d\u6700\u4f18\u89e3, \u56e0\u6b64\u4e5f\u5c31\u8d8b\u4e8e\u7a33\u5b9a\u4e86. \u8bad\u7ec3\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u9996\u5148\uff0c\u51c6\u786e\u7387\u662f\u6307\u8bc6\u522b \u6b63\u786e\u7684\u5b9e\u4f53 \u5360 \u8bc6\u522b\u51fa\u7684\u5b9e\u4f53 \u4e2d\u7684\u6bd4\u4f8b. \u6839\u636e\u5bf9\u7167\u66f2\u7ebf\u6765\u770b\uff0c\u6574\u4f53\u5b66\u4e60\u7ed3\u679c\u90fd\u5728\u8d8b\u4e8e\u51c6\u786e\u7387\u4e0a\u5347\u65b9\u5411\u589e\u52a0\uff0c\u800c\u4e14\u968f\u7740\u6279\u6b21\u7684\u589e\u52a0\u66f2\u7ebf\u9707\u52a8\u76f8\u5bf9\u5e73\u7a33\uff0c\u4e0d\u8fc7\u53ef\u80fd\u7531\u4e8e\u8bad\u7ec3\u4e0e\u9a8c\u8bc1\u6837\u672c\u5206\u5e03\u4e0d\u5747\u8861\u6216\u8005\u566a\u58f0\u7b49\u539f\u56e0\uff0c\u5bfc\u81f4\u6700\u7ec8\u9a8c\u8bc1\u96c6\u7684\u51c6\u786e\u5ea6\u6ca1\u6709\u8fbe\u5230\u4e0e\u8bad\u7ec3\u96c6\u76f8\u540c\u7684\u60c5\u51b5. \u6700\u7ec8\u7684\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u53ec\u56de\u7387\u5206\u522b\u5728\uff1a0.85\u548c0.78\u5de6\u53f3. \u8bad\u7ec3\u548c\u9a8c\u8bc1\u53ec\u56de\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u5728\u6b64\u53ec\u56de\u7387\u662f\u6307 \u8bc6\u522b\u6b63\u786e\u7684\u5b9e\u4f53 \u5360\u5f53\u524d\u6279\u6b21\u6240\u5305\u542b\u7684 \u6240\u6709\u5b9e\u4f53\u603b\u6570 \u7684\u6bd4\u4f8b. \u5173\u4e8e\u8bad\u7ec3\u548c\u9a8c\u8bc1\u53ec\u56de\u7387\u5bf9\u7167\u66f2\u7ebf\uff0c\u53ef\u4ee5\u770b\u51fa\u53ec\u56de\u7387\u7684\u53d8\u5316\u76f8\u5bf9\u6bd4\u8f83\u5e73\u6ed1\uff0c\u57fa\u672c\u4e0a\u4e5f\u572840\u6b65\u5de6\u53f3\u8d8b\u4e8e\u7a33\u5b9a. \u6700\u7ec8\u7684\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u53ec\u56de\u7387\u5206\u522b\u5728\uff1a0.83\u548c0.75\u5de6\u53f3. \u8bad\u7ec3\u548c\u9a8c\u8bc1F1\u503c\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: F1\u503c\u4e3b\u8981\u662f\u6307\u8bad\u7ec3\u6548\u679c\u800c\u8a00\uff0c\u5728\u4e0d\u591a\u8bc6\u522b\u5b9e\u4f53\u7684\u60c5\u51b5\u4e0b\u540c\u65f6\u63d0\u9ad8\u51c6\u786e\u5ea6\u7684\u8861\u91cf\u6307\u6807. \u5176\u516c\u5f0f\u4e3a\uff1a2\u00d7\u51c6\u786e\u7387\u00d7\u53ec\u56de\u7387 / (\u51c6\u786e\u7387 + \u53ec\u56de\u7387) \u4ece\u66f2\u7ebf\u53ef\u89c1\u6574\u4f53F1\u503c\u4e0a\u5347\u4e0e\u635f\u5931\u3001\u53ec\u56de\u7387\u7684\u66f2\u7ebf\u6bd4\u8f83\u63a5\u8fd1\uff0c\u8bf4\u660e\u5728\u8bc6\u522b\u51fa\u7684\u5b9e\u4f53\u4e2d\uff0c\u6b63\u786e\u7387\u6bd4\u8f83\u95ee\u9898\uff0c\u4e0d\u8fc7\u6839\u636e\u524d\u9762\u7684\u51c6\u786e\u5ea6\u6765\u5206\u6790\uff0c\u53ef\u80fd\u5728\u8bc6\u522b\u8fc7\u7a0b\u4e2d\uff0c\u589e\u52a0\u4e86\u8bc6\u522b\u51fa\u7684\u5b9e\u4f53\u4e2a\u6570\u800c\u5bfc\u81f4\u4e0d\u7a33\u5b9a\u3002\u4ece\u8fd9\u65b9\u9762\u6765\u8bf4\uff0c\u53ef\u4ee5\u9a8c\u8bc1\u6837\u672c\u4e0d\u5747\u8861\u95ee\u9898\u4ee5\u53ca\u566a\u58f0\u5bf9\u6a21\u578b\u7684\u5f71\u54cd\u8fd8\u662f\u6bd4\u8f83\u5927\u7684\u3002 \u4ece\u6574\u4f53\u800c\u8a00\uff0cF1\u503c\u57fa\u672c\u4e5f\u5728\u7b2c40\u6b65\u4e4b\u540e\u8d8b\u4e8e\u7a33\u5b9a\uff0c\u6700\u7ec8\u7684\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u7ed3\u679c\u5728\uff1a0.85\u548c0.75\u5de6\u53f3\u3002 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u6570\u636e\u9884\u5904\u7406\u7684\u76f8\u5173\u65b9\u6cd5 \u539f\u59cb\u6570\u636e\u96c6\u7684\u5b57\u7b26\u7ecf\u8fc7\u6570\u5b57\u5316\u7f16\u7801\u53d8\u6210\u5411\u91cf \u6807\u6ce8\u6570\u636e\u96c6\u7684\u5b57\u7b26\u7ecf\u8fc7\u6570\u5b57\u5316\u7f16\u7801\u53d8\u6210\u5411\u91cf \u5b66\u4e60\u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e\u7684\u65b9\u6cd5 \u5b66\u4e60\u4e86\u6a21\u578b\u8bad\u7ec3\u76f8\u5173\u4ee3\u7801\u7684\u5b9e\u73b0 \u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u8bc4\u4f30\u7684\u4ee3\u7801 \u6a21\u578b\u6784\u5efa\u7c7b\u7684\u5168\u90e8\u5185\u90e8\u51fd\u6570\u4ee3\u7801 \u542f\u52a8\u8bad\u7ec3\u6d41\u7a0b\u7684\u4ee3\u7801 6.6 \u6a21\u578b\u4f7f\u7528 \u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u6a21\u578b\u5355\u6761\u6587\u672c\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0 \u638c\u63e1\u6279\u91cf\u6587\u4ef6\u5939\u6587\u4ef6\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0 \u6a21\u578b\u5355\u6761\u6587\u672c\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0: import os import torch import json from bilstm_crf import BiLSTM_CRF def singel_predict(model_path, content, char_to_id_json_path, batch_size, embedding_dim, hidden_dim, num_layers, sentence_length, offset, target_type_list, tag2id): char_to_id = json.load(open(char_to_id_json_path, mode=\"r\", encoding=\"utf-8\")) # \u5c06\u5b57\u7b26\u4e32\u8f6c\u4e3a\u7801\u8868id\u5217\u8868 char_ids = content_to_id(content, char_to_id) # \u5904\u7406\u6210 batch_size * sentence_length \u7684 tensor \u6570\u636e # \u5b9a\u4e49\u6a21\u578b\u8f93\u5165\u5217\u8868 model_inputs_list, model_input_map_list = build_model_input_list(content, char_ids, batch_size, sentence_length, offset) # \u52a0\u8f7d\u6a21\u578b model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag2id, embedding_dim=embedding_dim, hidden_dim=hidden_dim, batch_size=batch_size, num_layers=num_layers, sequence_length=sentence_length) # \u52a0\u8f7d\u6a21\u578b\u5b57\u5178 model.load_state_dict(torch.load(model_path)) tag_id_dict = {v: k for k, v in tag_to_id.items() if k[2:] in target_type_list} # \u5b9a\u4e49\u8fd4\u56de\u5b9e\u4f53\u5217\u8868 entities = [] with torch.no_grad(): for step, model_inputs in enumerate(model_inputs_list): prediction_value = model(model_inputs) # \u83b7\u53d6\u6bcf\u4e00\u884c\u9884\u6d4b\u7ed3\u679c for line_no, line_value in enumerate(prediction_value): # \u5b9a\u4e49\u5c06\u8981\u8bc6\u522b\u7684\u5b9e\u4f53 entity = None # \u83b7\u53d6\u5f53\u524d\u884c\u6bcf\u4e2a\u5b57\u7684\u9884\u6d4b\u7ed3\u679c for char_idx, tag_id in enumerate(line_value): # \u82e5\u9884\u6d4b\u7ed3\u679c tag_id \u5c5e\u4e8e\u76ee\u6807\u5b57\u5178\u6570\u636e key \u4e2d if tag_id in tag_id_dict: # \u53d6\u7b26\u5408\u5339\u914d\u5b57\u5178id\u7684\u7b2c\u4e00\u4e2a\u5b57\u7b26\uff0c\u5373B, I tag_index = tag_id_dict[tag_id][0] # \u8ba1\u7b97\u5f53\u524d\u5b57\u7b26\u786e\u5207\u7684\u4e0b\u6807\u4f4d\u7f6e current_char = model_input_map_list[step][line_no][char_idx] # \u82e5\u5f53\u524d\u5b57\u6807\u7b7e\u8d77\u59cb\u4e3a B, \u5219\u8bbe\u7f6e\u4e3a\u5b9e\u4f53\u5f00\u59cb if tag_index == \"B\": entity = current_char # \u82e5\u5f53\u524d\u5b57\u6807\u7b7e\u8d77\u59cb\u4e3a I, \u5219\u8fdb\u884c\u5b57\u7b26\u4e32\u8ffd\u52a0 elif tag_index == \"I\" and entity: entity += current_char # \u5f53\u5b9e\u4f53\u4e0d\u4e3a\u7a7a\u4e14\u5f53\u524d\u6807\u7b7e\u7c7b\u578b\u4e3a O \u65f6\uff0c\u52a0\u5165\u5b9e\u4f53\u5217\u8868 if tag_id == tag_to_id[\"O\"] and entity: # \u6ee1\u8db3\u5f53\u524d\u5b57\u7b26\u4e3aO\uff0c\u4e0a\u4e00\u4e2a\u5b57\u7b26\u4e3a\u76ee\u6807\u63d0\u53d6\u5b9e\u4f53\u7ed3\u5c3e\u65f6\uff0c\u5c06\u5176\u52a0\u5165\u5b9e\u4f53\u5217\u8868 entities.append(entity) # \u91cd\u7f6e\u5b9e\u4f53 entity = None return entities def content_to_id(content, char_to_id): # \u5b9a\u4e49\u5b57\u7b26\u4e32\u5bf9\u5e94\u7684\u7801\u8868 id \u5217\u8868 char_ids = [] for char in list(content): # \u5224\u65ad\u82e5\u5b57\u7b26\u4e0d\u5728\u7801\u8868\u5bf9\u5e94\u5b57\u5178\u4e2d\uff0c\u5219\u53d6 NUK \u7684\u7f16\u7801\uff08\u5373 unknown\uff09\uff0c\u5426\u5219\u53d6\u5bf9\u5e94\u7684\u5b57\u7b26\u7f16\u7801 if char_to_id.get(char): char_ids.append(char_to_id[char]) else: char_ids.append(char_to_id[\"UNK\"]) return char_ids def build_model_input_list(content, char_ids, batch_size, sentence_length, offset): # \u5b9a\u4e49\u6a21\u578b\u8f93\u5165\u6570\u636e\u5217\u8868 model_input_list = [] # \u5b9a\u4e49\u6bcf\u4e2a\u6279\u6b21\u53e5\u5b50 id \u6570\u636e batch_sentence_list = [] # \u5c06\u6587\u672c\u5185\u5bb9\u8f6c\u4e3a\u5217\u8868 content_list = list(content) # \u5b9a\u4e49\u4e0e\u6a21\u578b char_id \u5bf9\u7167\u7684\u6587\u5b57 model_input_map_list = [] # \u5b9a\u4e49\u6bcf\u4e2a\u6279\u6b21\u53e5\u5b50\u5b57\u7b26\u6570\u636e batch_sentence_char_list = [] # \u5224\u65ad\u662f\u5426\u9700\u8981 padding if len(char_ids) % sentence_length > 0: # \u5c06\u4e0d\u8db3 batch_size * sentence_length \u7684\u90e8\u5206\u586b\u51450 padding_length = (batch_size * sentence_length - len(char_ids) % batch_size * sentence_length - len(char_ids) % sentence_length) char_ids.extend([0] * padding_length) content_list.extend([\"#\"] * padding_length) # \u8fed\u4ee3\u5b57\u7b26 id \u5217\u8868 # \u6570\u636e\u6ee1\u8db3 batch_size * sentence_length \u5c06\u52a0\u5165 model_input_list for step, idx in enumerate(range(0, len(char_ids) + 1, sentence_length)): # \u8d77\u59cb\u4e0b\u6807\uff0c\u4ece\u7b2c\u4e00\u53e5\u5f00\u59cb\u589e\u52a0 offset \u4e2a\u5b57\u7684\u504f\u79fb start_idx = 0 if idx == 0 else idx - step * offset # \u83b7\u53d6\u957f\u5ea6\u4e3a sentence_length \u7684\u5b57\u7b26 id \u6570\u636e\u96c6 sub_list = char_ids[start_idx:start_idx + sentence_length] # \u83b7\u53d6\u957f\u5ea6\u4e3a sentence_length \u7684\u5b57\u7b26\u6570\u636e\u96c6 sub_char_list = content_list[start_idx:start_idx + sentence_length] # \u52a0\u5165\u6279\u6b21\u6570\u636e\u96c6\u4e2d batch_sentence_list.append(sub_list) # \u6279\u91cf\u53e5\u5b50\u5305\u542b\u5b57\u7b26\u5217\u8868 batch_sentence_char_list.append(sub_char_list) # \u6bcf\u5f53\u6279\u6b21\u957f\u5ea6\u8fbe\u5230 batch_size \u65f6\u5019\uff0c\u5c06\u5176\u52a0\u5165 model_input_list if len(batch_sentence_list) == batch_size: # \u5c06\u6570\u636e\u683c\u5f0f\u8f6c\u4e3a tensor \u683c\u5f0f\uff0c\u5927\u5c0f\u4e3a batch_size * sentence_length model_input_list.append(torch.tensor(batch_sentence_list)) # \u91cd\u7f6e batch_sentence_list batch_sentence_list = [] # \u5c06 char_id \u5bf9\u5e94\u7684\u5b57\u7b26\u52a0\u5165\u6620\u5c04\u8868\u4e2d model_input_map_list.append(batch_sentence_char_list) # \u91cd\u7f6e\u6279\u5b57\u7b26\u4e32\u5185\u5bb9 batch_sentence_char_list = [] # \u8fd4\u56de\u6a21\u578b\u8f93\u5165\u5217\u8868 return model_input_list, model_input_map_list \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/predict.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u5f85\u8bc6\u522b\u6587\u672c content = \"\u672c\u75c5\u662f\u7531DNA\u75c5\u6bd2\u7684\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u6240\u81f4\u3002\u4eba\u7c7b\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u5206\u4e3a\u4e24\u578b\uff0c\" \\ \"\u5373\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u2160\u578b\uff08HSV-\u2160\uff09\u548c\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u2161\u578b\uff08HSV-\u2161\uff09\u3002\" \\ \"\u2160\u578b\u4e3b\u8981\u5f15\u8d77\u751f\u6b96\u5668\u4ee5\u5916\u7684\u76ae\u80a4\u9ecf\u819c\uff08\u53e3\u8154\u9ecf\u819c\uff09\u548c\u5668\u5b98\uff08\u8111\uff09\u7684\u611f\u67d3\u3002\" \\ \"\u2161\u578b\u4e3b\u8981\u5f15\u8d77\u751f\u6b96\u5668\u90e8\u4f4d\u76ae\u80a4\u9ecf\u819c\u611f\u67d3\u3002\" \\ \"\u75c5\u6bd2\u7ecf\u547c\u5438\u9053\u3001\u53e3\u8154\u3001\u751f\u6b96\u5668\u9ecf\u819c\u4ee5\u53ca\u7834\u635f\u76ae\u80a4\u8fdb\u5165\u4f53\u5185\uff0c\" \\ \"\u6f5c\u5c45\u4e8e\u4eba\u4f53\u6b63\u5e38\u9ecf\u819c\u3001\u8840\u6db2\u3001\u553e\u6db2\u53ca\u611f\u89c9\u795e\u7ecf\u8282\u7ec6\u80de\u5185\u3002\" \\ \"\u5f53\u673a\u4f53\u62b5\u6297\u529b\u4e0b\u964d\u65f6\uff0c\u5982\u53d1\u70ed\u80c3\u80a0\u529f\u80fd\u7d0a\u4e71\u3001\u6708\u7ecf\u3001\u75b2\u52b3\u7b49\u65f6\uff0c\" \\ \"\u4f53\u5185\u6f5c\u4f0f\u7684HSV\u88ab\u6fc0\u6d3b\u800c\u53d1\u75c5\u3002\" # \u53c2\u65702:\u6a21\u578b\u4fdd\u5b58\u6587\u4ef6\u8def\u5f84 model_path = \"model/bilstm_crf_state_dict_20200129_210417.pt\" # \u53c2\u65703:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65704:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 300 # \u53c2\u65705:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 128 # \u53c2\u65706:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 100 # \u53c2\u65707:\u504f\u79fb\u91cf OFFSET = 10 # \u53c2\u65708:\u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65709:\u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def\u5f84 char_to_id_json_path = \"./data/char_to_id.json\" # \u53c2\u657010:\u9884\u6d4b\u7ed3\u679c\u5b58\u50a8\u8def\u5f84 prediction_result_path = \"prediction_result\" # \u53c2\u657011:\u5f85\u5339\u914d\u6807\u7b7e\u7c7b\u578b target_type_list = [\"sym\"] \u8c03\u7528: # \u5355\u72ec\u6587\u672c\u9884\u6d4b, \u83b7\u5f97\u5b9e\u4f53\u7ed3\u679c entities = singel_predict(model_path, content, char_to_id_json_path, BATCH_SIZE, EMBEDDING_DIM, HIDDEN_DIM, SENTENCE_LENGTH, OFFSET, target_type_list, tag_to_id) # \u6253\u5370\u5b9e\u4f53\u7ed3\u679c print(\"entities:\\n\", entities) \u8f93\u51fa\u6548\u679c: entities: ['\u611f\u67d3', '\u53d1\u70ed', '##'] \u6279\u91cf\u6587\u4ef6\u5939\u6587\u4ef6\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0: def batch_predict(data_path, model_path, char_to_id_json_path, batch_size, embedding_dim, hidden_dim, sentence_length, offset, target_type_list, prediction_result_path, tag_to_id): \"\"\" description: \u6279\u91cf\u9884\u6d4b\uff0c\u67e5\u8be2\u6587\u4ef6\u76ee\u5f55\u4e0b\u6570\u636e, \u4ece\u4e2d\u63d0\u53d6\u7b26\u5408\u6761\u4ef6\u7684\u5b9e\u4f53\u5e76\u5b58\u50a8\u81f3\u65b0\u7684\u76ee\u5f55\u4e0bprediction_result_path :param data_path: \u6570\u636e\u6587\u4ef6\u8def\u5f84 :param model_path: \u6a21\u578b\u6587\u4ef6\u8def\u5f84 :param char_to_id_json_path: \u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def\u5f84 :param batch_size: \u8bad\u7ec3\u6279\u6b21\u5927\u5c0f :param embedding_dim: \u5b57\u5411\u91cf\u7ef4\u5ea6 :param hidden_dim: BiLSTM \u9690\u85cf\u5c42\u5411\u91cf\u7ef4\u5ea6 :param sentence_length: \u53e5\u5b50\u957f\u5ea6(\u53e5\u5b50\u505a\u4e86padding) :param offset: \u8bbe\u5b9a\u504f\u79fb\u91cf, \u5f53\u5b57\u7b26\u4e32\u8d85\u51fasentence_length\u65f6, \u6362\u884c\u65f6\u589e\u52a0\u504f\u79fb\u91cf :param target_type_list: \u5f85\u5339\u914d\u7c7b\u578b\uff0c\u7b26\u5408\u6761\u4ef6\u7684\u5b9e\u4f53\u5c06\u4f1a\u88ab\u63d0\u53d6\u51fa\u6765 :param prediction_result_path: \u9884\u6d4b\u7ed3\u679c\u4fdd\u5b58\u8def\u5f84 :param tag_to_id: \u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178, \u6807\u7b7e\u5bf9\u5e94 id :return: \u65e0\u8fd4\u56de \"\"\" # \u8fed\u4ee3\u8def\u5f84, \u8bfb\u53d6\u6587\u4ef6\u540d for fn in os.listdir(data_path): # \u62fc\u88c5\u5168\u8def\u5f84 fullpath = os.path.join(data_path, fn) # \u5b9a\u4e49\u8f93\u51fa\u7ed3\u679c\u6587\u4ef6 entities_file = open(os.path.join(prediction_result_path, fn), mode=\"w\", encoding=\"utf-8\") with open(fullpath, mode=\"r\", encoding=\"utf-8\") as f: # \u8bfb\u53d6\u6587\u4ef6\u5185\u5bb9 content = f.readline() # \u8c03\u7528\u5355\u4e2a\u9884\u6d4b\u6a21\u578b\uff0c\u8f93\u51fa\u4e3a\u76ee\u6807\u7c7b\u578b\u5b9e\u4f53\u6587\u672c\u5217\u8868 entities = singel_predict(model_path, content, char_to_id_json_path, batch_size, embedding_dim, hidden_dim, sentence_length, offset, target_type_list, tag_to_id) # \u5199\u5165\u8bc6\u522b\u7ed3\u679c\u6587\u4ef6 entities_file.write(\"\\n\".join(entities)) print(\"batch_predict Finished\".center(100, \"-\")) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/predict.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u6a21\u578b\u4fdd\u5b58\u8def\u5f84 model_path = \"model/bilstm_crf_state_dict_20191219_220256.pt\" # \u53c2\u65702:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65703:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u65704:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u65705:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u65706:\u504f\u79fb\u91cf OFFSET = 10 # \u53c2\u65707:\u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65708:\u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def\u5f84 char_to_id_json_path = \"./data/char_to_id.json\" # \u53c2\u65709:\u9884\u6d4b\u7ed3\u679c\u5b58\u50a8\u8def\u5f84 prediction_result_path = \"prediction_result\" # \u53c2\u657010:\u5f85\u5339\u914d\u6807\u7b7e\u7c7b\u578b target_type_list = [\"sym\"] # \u53c2\u657011:\u5f85\u9884\u6d4b\u6587\u672c\u6587\u4ef6\u6240\u5728\u76ee\u5f55 data_path = \"origin_data\" \u8c03\u7528: # \u6279\u91cf\u6587\u672c\u9884\u6d4b, \u5e76\u5c06\u7ed3\u679c\u5199\u5165\u6587\u4ef6\u4e2d batch_predict(data_path, model_path, char_to_id_json_path, BATCH_SIZE, EMBEDDING_DIM, HIDDEN_DIM, SENTENCE_LENGTH, OFFSET, target_type_list, prediction_result_path, tag_to_id) \u8f93\u51fa\u6548\u679c: \u5c06\u8bc6\u522b\u7ed3\u679c\u4fdd\u5b58\u81f3prediction_result_path\u6307\u5b9a\u7684\u76ee\u5f55\u4e0b, \u540d\u79f0\u4e0e\u6e90\u6587\u4ef6\u4e00\u81f4, \u5185\u5bb9\u4e3a\u6bcf\u884c\u5b58\u50a8\u8bc6\u522b\u5b9e\u4f53\u540d\u79f0 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u6a21\u578b\u5355\u6761\u6587\u672c\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0 \u5b66\u4e60\u4e86\u6279\u91cf\u6587\u4ef6\u5939\u6587\u4ef6\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0","title":"\u7b2c\u516d\u7ae0:\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u4efb\u52a1"},{"location":"6/#61","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u4ec0\u4e48\u662f\u547d\u540d\u5b9e\u4f53\u8bc6\u522b \u4e86\u89e3\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u4f5c\u7528 \u4e86\u89e3\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u5e38\u7528\u65b9\u6cd5 \u4e86\u89e3\u533b\u5b66\u6587\u672c\u7279\u5f81 \u4ec0\u4e48\u662f\u547d\u540d\u5b9e\u4f53\u8bc6\u522b: \u547d\u540d\u5b9e\u4f53\u8bc6\u522b(Named Entity Recognition\uff0cNER)\u5c31\u662f\u4ece\u4e00\u6bb5\u81ea\u7136\u8bed\u8a00\u6587\u672c\u4e2d\u627e\u51fa\u76f8\u5173\u5b9e\u4f53\uff0c\u5e76\u6807\u6ce8\u51fa\u5176\u4f4d\u7f6e\u4ee5\u53ca\u7c7b\u578b\u3002\u662f\u4fe1\u606f\u63d0\u53d6, \u95ee\u7b54\u7cfb\u7edf, \u53e5\u6cd5\u5206\u6790, \u673a\u5668\u7ffb\u8bd1\u7b49\u5e94\u7528\u9886\u57df\u7684\u91cd\u8981\u57fa\u7840\u5de5\u5177, \u5728\u81ea\u7136\u8bed\u8a00\u5904\u7406\u6280\u672f\u8d70\u5411\u5b9e\u7528\u5316\u7684\u8fc7\u7a0b\u4e2d\u5360\u6709\u91cd\u8981\u5730\u4f4d. \u5305\u542b\u884c\u4e1a, \u9886\u57df\u4e13\u6709\u540d\u8bcd, \u5982\u4eba\u540d, \u5730\u540d, \u516c\u53f8\u540d, \u673a\u6784\u540d, \u65e5\u671f, \u65f6\u95f4, \u75be\u75c5\u540d, \u75c7\u72b6\u540d, \u624b\u672f\u540d\u79f0, \u8f6f\u4ef6\u540d\u79f0\u7b49\u3002\u5177\u4f53\u53ef\u53c2\u770b\u5982\u4e0b\u793a\u4f8b\u56fe\uff1a \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u4f5c\u7528: \u8bc6\u522b\u4e13\u6709\u540d\u8bcd, \u4e3a\u6587\u672c\u7ed3\u6784\u5316\u63d0\u4f9b\u652f\u6301. \u4e3b\u4f53\u8bc6\u522b, \u8f85\u52a9\u53e5\u6cd5\u5206\u6790. \u5b9e\u4f53\u5173\u7cfb\u62bd\u53d6, \u6709\u5229\u4e8e\u77e5\u8bc6\u63a8\u7406. \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u5e38\u7528\u65b9\u6cd5: \u57fa\u4e8e\u89c4\u5219: \u9488\u5bf9\u6709\u7279\u6b8a\u4e0a\u4e0b\u6587\u7684\u5b9e\u4f53, \u6216\u5b9e\u4f53\u672c\u8eab\u6709\u5f88\u591a\u7279\u5f81\u7684\u6587\u672c, \u4f7f\u7528\u89c4\u5219\u7684\u65b9\u6cd5\u7b80\u5355\u4e14\u6709\u6548. \u6bd4\u5982\u62bd\u53d6\u6587\u672c\u4e2d\u7269\u54c1\u4ef7\u683c, \u5982\u679c\u6587\u672c\u4e2d\u6240\u6709\u5546\u54c1\u4ef7\u683c\u90fd\u662f\u201c\u6570\u5b57+\u5143\u201d\u7684\u5f62\u5f0f, \u5219\u53ef\u4ee5\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f\u201d\\d*.?\\d+\u5143\u201d\u8fdb\u884c\u62bd\u53d6. \u4f46\u5982\u679c\u5f85\u62bd\u53d6\u6587\u672c\u4e2d\u4ef7\u683c\u7684\u8868\u8fbe\u65b9\u5f0f\u591a\u79cd\u591a\u6837, \u4f8b\u5982\u201c\u4e00\u5343\u516b\u767e\u4e07\u201d, \u201c\u4f0d\u4f70\u8d30\u62fe\u5706\u201d, \u201c2000\u4e07\u5143\u201d, \u9047\u5230\u8fd9\u4e9b\u60c5\u51b5\u5c31\u8981\u4fee\u6539\u89c4\u5219\u6765\u6ee1\u8db3\u6240\u6709\u53ef\u80fd\u7684\u60c5\u51b5. \u968f\u7740\u8bed\u6599\u6570\u91cf\u7684\u589e\u52a0, \u9762\u5bf9\u7684\u60c5\u51b5\u4e5f\u8d8a\u6765\u8d8a\u590d\u6742, \u89c4\u5219\u4e4b\u95f4\u4e5f\u53ef\u80fd\u53d1\u751f\u51b2\u7a81, \u6574\u4e2a\u7cfb\u7edf\u4e5f\u53ef\u80fd\u53d8\u5f97\u4e0d\u53ef\u7ef4\u62a4. \u56e0\u6b64\u57fa\u4e8e\u89c4\u5219\u7684\u65b9\u5f0f\u6bd4\u8f83\u9002\u5408\u534a\u7ed3\u6784\u5316\u6216\u6bd4\u8f83\u89c4\u8303\u7684\u6587\u672c\u4e2d\u7684\u8fdb\u884c\u62bd\u53d6\u4efb\u52a1, \u7ed3\u5408\u4e1a\u52a1\u9700\u6c42\u80fd\u591f\u8fbe\u5230\u4e00\u5b9a\u7684\u6548\u679c. \u4f18\u70b9: \u7b80\u5355, \u5feb\u901f. \u7f3a\u70b9: \u9002\u7528\u6027\u5dee, \u7ef4\u62a4\u6210\u672c\u9ad8\u540e\u671f\u751a\u81f3\u4e0d\u80fd\u7ef4\u62a4. \u57fa\u4e8e\u6a21\u578b: \u4ece\u6a21\u578b\u7684\u89d2\u5ea6\u6765\u770b, \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u95ee\u9898\u5b9e\u9645\u4e0a\u662f\u5e8f\u5217\u6807\u6ce8\u95ee\u9898. \u5e8f\u5217\u6807\u6ce8\u95ee\u9898\u6307\u7684\u662f\u6a21\u578b\u7684\u8f93\u5165\u662f\u4e00\u4e2a\u5e8f\u5217, \u5305\u62ec\u6587\u5b57, \u65f6\u95f4\u7b49, \u8f93\u51fa\u4e5f\u662f\u4e00\u4e2a\u5e8f\u5217. \u9488\u5bf9\u8f93\u5165\u5e8f\u5217\u7684\u6bcf\u4e00\u4e2a\u5355\u5143, \u8f93\u51fa\u4e00\u4e2a\u7279\u5b9a\u7684\u6807\u7b7e. \u4ee5\u4e2d\u6587\u5206\u8bcd\u4efb\u52a1\u8fdb\u884c\u4e3e\u4f8b, \u4f8b\u5982\u8f93\u5165\u5e8f\u5217\u662f\u4e00\u4e32\u6587\u5b57: \"\u6211\u662f\u4e2d\u56fd\u4eba\", \u8f93\u51fa\u5e8f\u5217\u662f\u4e00\u4e32\u6807\u7b7e: \"OOBII\", \u5176\u4e2d\"BIO\"\u7ec4\u6210\u4e86\u4e00\u79cd\u4e2d\u6587\u5206\u8bcd\u7684\u6807\u7b7e\u4f53\u7cfb: B\u8868\u793a\u8fd9\u4e2a\u5b57\u662f\u8bcd\u7684\u5f00\u59cb, I\u8868\u793a\u8bcd\u7684\u4e2d\u95f4\u5230\u7ed3\u5c3e, O\u8868\u793a\u5176\u4ed6\u7c7b\u578b\u8bcd. \u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u8f93\u51fa\u5e8f\u5217\"OOBII\"\u8fdb\u884c\u89e3\u7801, \u5f97\u5230\u5206\u8bcd\u7ed3\u679c\"\u6211\\\u662f\\\u4e2d\u56fd\u4eba\". \u5e8f\u5217\u6807\u6ce8\u95ee\u9898\u6db5\u76d6\u4e86\u81ea\u7136\u8bed\u8a00\u5904\u7406\u4e2d\u7684\u5f88\u591a\u4efb\u52a1, \u5305\u62ec\u8bed\u97f3\u8bc6\u522b, \u4e2d\u6587\u5206\u8bcd, \u673a\u5668\u7ffb\u8bd1, \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7b49, \u800c\u5e38\u89c1\u7684\u5e8f\u5217\u6807\u6ce8\u6a21\u578b\u5305\u62ecHMM, CRF, RNN, LSTM, GRU\u7b49\u6a21\u578b. \u5176\u4e2d\u5728\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u6280\u672f\u4e0a, \u76ee\u524d\u4e3b\u6d41\u7684\u6280\u672f\u662f\u901a\u8fc7BiLSTM+CRF\u6a21\u578b\u8fdb\u884c\u5e8f\u5217\u6807\u6ce8, \u4e5f\u662f\u9879\u76ee\u4e2d\u8981\u7528\u5230\u7684\u6a21\u578b. \u533b\u5b66\u6587\u672c\u7279\u5f81: \u7b80\u77ed\u7cbe\u70bc \u5f62\u5bb9\u8bcd\u76f8\u5bf9\u8f83\u5c11 \u6cdb\u5316\u6027\u76f8\u5bf9\u8f83\u5c0f \u533b\u5b66\u540d\u8bcd\u9519\u5b57\u7387\u6bd4\u8f83\u9ad8 \u540c\u4e49\u8bcd\u3001\u7b80\u79f0\u6bd4\u8f83\u591a \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u4ec0\u4e48\u662f\u547d\u540d\u5b9e\u4f53\u8bc6\u522b \u5b66\u4e60\u4e86\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u7684\u4f5c\u7528 \u5b66\u4e60\u4e86\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u5e38\u7528\u65b9\u6cd5 \u5b66\u4e60\u4e86\u533b\u5b66\u6587\u672c\u7279\u5f81","title":"6.1 \u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u4ecb\u7ecd"},{"location":"6/#62-bilstm","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3BiLSTM\u7f51\u7edc\u7ed3\u6784. \u638c\u63e1BiLSTM\u6a21\u578b\u5b9e\u73b0. BiLSTM\u7f51\u7edc\u7ed3\u6784: \u6240\u8c13\u7684BiLSTM\uff0c\u5c31\u662f(Bidirectional LSTM)\u53cc\u5411LSTM. \u5355\u5411\u7684LSTM\u6a21\u578b\u53ea\u80fd\u6355\u6349\u5230\u4ece\u524d\u5411\u540e\u4f20\u9012\u7684\u4fe1\u606f, \u800c\u53cc\u5411\u7684\u7f51\u7edc\u53ef\u4ee5\u540c\u65f6\u6355\u6349\u6b63\u5411\u4fe1\u606f\u548c\u53cd\u5411\u4fe1\u606f, \u4f7f\u5f97\u5bf9\u6587\u672c\u4fe1\u606f\u7684\u5229\u7528\u66f4\u5168\u9762, \u6548\u679c\u4e5f\u66f4\u597d. \u5728BiLSTM\u7f51\u7edc\u6700\u7ec8\u7684\u8f93\u51fa\u5c42\u540e\u9762\u589e\u52a0\u4e86\u4e00\u4e2a\u7ebf\u6027\u5c42, \u7528\u6765\u5c06BiLSTM\u4ea7\u751f\u7684\u9690\u85cf\u5c42\u8f93\u51fa\u7ed3\u679c\u6295\u5c04\u5230\u5177\u6709\u67d0\u79cd\u8868\u8fbe\u6807\u7b7e\u7279\u5f81\u610f\u4e49\u7684\u533a\u95f4, \u5177\u4f53\u5982\u4e0b\u56fe\u6240\u793a\uff1a BiLSTM\u6a21\u578b\u5b9e\u73b0: \u7b2c\u4e00\u6b65: \u5b9e\u73b0\u7c7b\u7684\u521d\u59cb\u5316\u548c\u7f51\u7edc\u7ed3\u6784\u7684\u642d\u5efa. \u7b2c\u4e8c\u6b65: \u5b9e\u73b0\u6587\u672c\u5411\u91cf\u5316\u7684\u51fd\u6570. \u7b2c\u4e09\u6b65: \u5b9e\u73b0\u7f51\u7edc\u7684\u524d\u5411\u8ba1\u7b97. \u7b2c\u4e00\u6b65: \u5b9e\u73b0\u7c7b\u7684\u521d\u59cb\u5316\u548c\u7f51\u7edc\u7ed3\u6784\u7684\u642d\u5efa. # \u672c\u6bb5\u4ee3\u7801\u6784\u5efa\u7c7bBiLSTM, \u5b8c\u6210\u521d\u59cb\u5316\u548c\u7f51\u7edc\u7ed3\u6784\u7684\u642d\u5efa # \u603b\u51713\u5c42: \u8bcd\u5d4c\u5165\u5c42, \u53cc\u5411LSTM\u5c42, \u5168\u8fde\u63a5\u7ebf\u6027\u5c42 import torch import torch.nn as nn class BiLSTM(nn.Module): \"\"\" description: BiLSTM \u6a21\u578b\u5b9a\u4e49 \"\"\" def __init__(self, vocab_size, tag_to_id, input_feature_size, hidden_size, batch_size, sentence_length, num_layers=1, batch_first=True): \"\"\" description: \u6a21\u578b\u521d\u59cb\u5316 :param vocab_size: \u6240\u6709\u53e5\u5b50\u5305\u542b\u5b57\u7b26\u5927\u5c0f :param tag_to_id: \u6807\u7b7e\u4e0e id \u5bf9\u7167 :param input_feature_size: \u5b57\u5d4c\u5165\u7ef4\u5ea6( \u5373LSTM\u8f93\u5165\u5c42\u7ef4\u5ea6 input_size ) :param hidden_size: \u9690\u85cf\u5c42\u5411\u91cf\u7ef4\u5ea6 :param batch_size: \u6279\u8bad\u7ec3\u5927\u5c0f :param sentence_length \u53e5\u5b50\u957f\u5ea6 :param num_layers: \u5806\u53e0 LSTM \u5c42\u6570 :param batch_first: \u662f\u5426\u5c06batch_size\u653e\u7f6e\u5230\u77e9\u9635\u7684\u7b2c\u4e00\u7ef4\u5ea6 \"\"\" # \u7c7b\u7ee7\u627f\u521d\u59cb\u5316\u51fd\u6570 super(BiLSTM, self).__init__() # \u8bbe\u7f6e\u6807\u7b7e\u4e0eid\u5bf9\u7167 self.tag_to_id = tag_to_id # \u8bbe\u7f6e\u6807\u7b7e\u5927\u5c0f, \u5bf9\u5e94BiLSTM\u6700\u7ec8\u8f93\u51fa\u5206\u6570\u77e9\u9635\u5bbd\u5ea6 self.tag_size = len(tag_to_id) # \u8bbe\u5b9aLSTM\u8f93\u5165\u7279\u5f81\u5927\u5c0f, \u5bf9\u5e94\u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6\u5927\u5c0f self.embedding_size = input_feature_size # \u8bbe\u7f6e\u9690\u85cf\u5c42\u7ef4\u5ea6, \u82e5\u4e3a\u53cc\u5411\u65f6\u60f3\u8981\u5f97\u5230\u540c\u6837\u5927\u5c0f\u7684\u5411\u91cf, \u9700\u8981\u9664\u4ee52 self.hidden_size = hidden_size // 2 # \u8bbe\u7f6e\u6279\u6b21\u5927\u5c0f, \u5bf9\u5e94\u6bcf\u4e2a\u6279\u6b21\u7684\u6837\u672c\u6761\u6570, \u53ef\u4ee5\u7406\u89e3\u4e3a\u8f93\u5165\u5f20\u91cf\u7684\u7b2c\u4e00\u4e2a\u7ef4\u5ea6 self.batch_size = batch_size # \u8bbe\u5b9a\u53e5\u5b50\u957f\u5ea6 self.sentence_length = sentence_length # \u8bbe\u5b9a\u662f\u5426\u5c06batch_size\u653e\u7f6e\u5230\u77e9\u9635\u7684\u7b2c\u4e00\u7ef4\u5ea6, \u53d6\u503cTrue, \u6216False self.batch_first = batch_first # \u8bbe\u7f6e\u7f51\u7edc\u7684LSTM\u5c42\u6570 self.num_layers = num_layers # \u6784\u5efa\u8bcd\u5d4c\u5165\u5c42: \u5b57\u5411\u91cf, \u7ef4\u5ea6\u4e3a\u603b\u5355\u8bcd\u6570\u91cf\u4e0e\u8bcd\u5d4c\u5165\u7ef4\u5ea6 # \u53c2\u6570: \u603b\u4f53\u5b57\u5e93\u7684\u5355\u8bcd\u6570\u91cf, \u6bcf\u4e2a\u5b57\u88ab\u5d4c\u5165\u7684\u7ef4\u5ea6 self.embedding = nn.Embedding(vocab_size, self.embedding_size) # \u6784\u5efa\u53cc\u5411LSTM\u5c42: BiLSTM (\u53c2\u6570: input_size \u5b57\u5411\u91cf\u7ef4\u5ea6(\u5373\u8f93\u5165\u5c42\u5927\u5c0f), # hidden_size \u9690\u85cf\u5c42\u7ef4\u5ea6, # num_layers \u5c42\u6570, # bidirectional \u662f\u5426\u4e3a\u53cc\u5411, # batch_first \u662f\u5426\u6279\u6b21\u5927\u5c0f\u5728\u7b2c\u4e00\u4f4d) self.bilstm = nn.LSTM(input_size=input_feature_size, hidden_size=self.hidden_size, num_layers=num_layers, bidirectional=True, batch_first=batch_first) # \u6784\u5efa\u5168\u8fde\u63a5\u7ebf\u6027\u5c42: \u5c06BiLSTM\u7684\u8f93\u51fa\u5c42\u8fdb\u884c\u7ebf\u6027\u53d8\u6362 self.linear = nn.Linear(hidden_size, self.tag_size) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u7801\u8868\u4e0eid\u5bf9\u7167 char_to_id = {\"\u53cc\": 0, \"\u80ba\": 1, \"\u89c1\": 2, \"\u591a\": 3, \"\u53d1\": 4, \"\u6591\": 5, \"\u7247\": 6, \"\u72b6\": 7, \"\u7a0d\": 8, \"\u9ad8\": 9, \"\u5bc6\": 10, \"\u5ea6\": 11, \"\u5f71\": 12, \"\u3002\": 13} # \u53c2\u65702:\u6807\u7b7e\u7801\u8868\u5bf9\u7167 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4} # \u53c2\u65703:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u65704:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u65705:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65706:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u65707:\u5806\u53e0 LSTM \u5c42\u6570 NUM_LAYERS = 1 \u8c03\u7528: # \u521d\u59cb\u5316\u6a21\u578b model = BiLSTM(vocab_size=len(char_to_id), tag_to_id=tag_to_id, input_feature_size=EMBEDDING_DIM, hidden_size=HIDDEN_DIM, batch_size=BATCH_SIZE, sentence_length=SENTENCE_LENGTH, num_layers=NUM_LAYERS) print(model) \u8f93\u51fa\u6548\u679c: BiLSTM( (embedding): Embedding(14, 200) (bilstm): LSTM(200, 50, batch_first=True, bidirectional=True) (linear): Linear(in_features=100, out_features=5, bias=True) ) \u7b2c\u4e8c\u6b65:\u5b9e\u73b0\u6587\u672c\u5411\u91cf\u5316\u7684\u51fd\u6570. # \u672c\u51fd\u6570\u5b9e\u73b0\u5c06\u4e2d\u6587\u6587\u672c\u6620\u5c04\u4e3a\u6570\u5b57\u5316\u7684\u5f20\u91cf def sentence_map(sentence_list, char_to_id, max_length): \"\"\" description: \u5c06\u53e5\u5b50\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7b26\u6620\u5c04\u5230\u7801\u8868\u4e2d :param sentence: \u5f85\u6620\u5c04\u53e5\u5b50, \u7c7b\u578b\u4e3a\u5b57\u7b26\u4e32\u6216\u5217\u8868 :param char_to_id: \u7801\u8868, \u7c7b\u578b\u4e3a\u5b57\u5178, \u683c\u5f0f\u4e3a{\"\u5b571\": 1, \"\u5b572\": 2} :return: \u6bcf\u4e00\u4e2a\u5b57\u5bf9\u5e94\u7684\u7f16\u7801, \u7c7b\u578b\u4e3atensor \"\"\" # \u5b57\u7b26\u4e32\u6309\u7167\u9006\u5e8f\u8fdb\u884c\u6392\u5e8f, \u4e0d\u662f\u5fc5\u987b\u64cd\u4f5c sentence_list.sort(key=lambda c:len(c), reverse=True) # \u5b9a\u4e49\u53e5\u5b50\u6620\u5c04\u5217\u8868 sentence_map_list = [] for sentence in sentence_list: # \u751f\u6210\u53e5\u5b50\u4e2d\u6bcf\u4e2a\u5b57\u5bf9\u5e94\u7684 id \u5217\u8868 sentence_id_list = [char_to_id[c] for c in sentence] # \u8ba1\u7b97\u6240\u8981\u586b\u5145 0 \u7684\u957f\u5ea6 padding_list = [0] * (max_length-len(sentence)) # \u7ec4\u5408 sentence_id_list.extend(padding_list) # \u5c06\u586b\u5145\u540e\u7684\u5217\u8868\u52a0\u5165\u53e5\u5b50\u6620\u5c04\u603b\u8868\u4e2d sentence_map_list.append(sentence_id_list) # \u8fd4\u56de\u53e5\u5b50\u6620\u5c04\u96c6\u5408, \u8f6c\u4e3a\u6807\u91cf return torch.tensor(sentence_map_list, dtype=torch.long) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u53e5\u5b50\u96c6\u5408 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\"] # \u53c2\u65702:\u7801\u8868\u4e0eid\u5bf9\u7167 char_to_id = {\"<PAD>\":0} # \u53c2\u65703:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: # \u83b7\u53d6\u53e5\u5b50\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57 for _char in sentence: # \u5224\u65ad\u662f\u5426\u5728\u7801\u8868 id \u5bf9\u7167\u5b57\u5178\u4e2d\u5b58\u5728 if _char not in char_to_id: # \u52a0\u5165\u5b57\u7b26id\u5bf9\u7167\u5b57\u5178 char_to_id[_char] = len(char_to_id) # \u5c06\u53e5\u5b50\u8f6c\u4e3a id \u5e76\u7528 tensor \u5305\u88c5 sentences_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) print(\"sentences_sequence:\\n\", sentences_sequence) \u8f93\u51fa\u6548\u679c: sentences_sequence: tensor([[14, 15, 16, 17, 18, 16, 19, 20, 21, 13, 22, 23, 24, 25, 26, 27, 28, 29, 30, 0], [14, 15, 26, 27, 18, 49, 50, 12, 21, 13, 22, 51, 52, 25, 53, 54, 55, 29, 30, 0], [14, 15, 53, 56, 18, 49, 50, 18, 26, 27, 57, 58, 59, 22, 51, 52, 55, 29, 0, 0], [37, 63, 64, 65, 66, 55, 13, 22, 61, 51, 52, 25, 67, 68, 69, 70, 71, 13, 0, 0], [37, 38, 39, 7, 8, 40, 41, 42, 43, 44, 45, 46, 47, 48, 0, 0, 0, 0, 0, 0], [16, 17, 18, 53, 56, 12, 59, 60, 22, 61, 51, 52, 12, 62, 0, 0, 0, 0, 0, 0], [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 0, 0, 0, 0, 0, 0, 0], [31, 32, 24, 33, 34, 35, 36, 13, 30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]) \u7b2c\u4e09\u6b65: \u5b9e\u73b0\u7f51\u7edc\u7684\u524d\u5411\u8ba1\u7b97. # \u672c\u51fd\u6570\u5b9e\u73b0\u7c7bBiLSTM\u4e2d\u7684\u524d\u5411\u8ba1\u7b97\u51fd\u6570forward() def forward(self, sentences_sequence): \"\"\" description: \u5c06\u53e5\u5b50\u5229\u7528BiLSTM\u8fdb\u884c\u7279\u5f81\u8ba1\u7b97\uff0c\u5206\u522b\u7ecf\u8fc7Embedding->BiLSTM->Linear\uff0c \u83b7\u5f97\u53d1\u5c04\u77e9\u9635\uff08emission scores\uff09 :param sentences_sequence: \u53e5\u5b50\u5e8f\u5217\u5bf9\u5e94\u7684\u7f16\u7801\uff0c \u82e5\u8bbe\u5b9a batch_first \u4e3a True\uff0c \u5219\u6279\u91cf\u8f93\u5165\u7684 sequence \u7684 shape \u4e3a(batch_size, sequence_length) :return: \u8fd4\u56de\u5f53\u524d\u53e5\u5b50\u7279\u5f81\uff0c\u8f6c\u5316\u4e3a tag_size \u7684\u7ef4\u5ea6\u7684\u7279\u5f81 \"\"\" # \u521d\u59cb\u5316\u9690\u85cf\u72b6\u6001\u503c h0 = torch.randn(self.num_layers * 2, self.batch_size, self.hidden_size) # \u521d\u59cb\u5316\u5355\u5143\u72b6\u6001\u503c c0 = torch.randn(self.num_layers * 2, self.batch_size, self.hidden_size) # \u751f\u6210\u5b57\u5411\u91cf\uff0c shape \u4e3a(batch, sequence_length, input_feature_size) # \u6ce8\uff1aembedding cuda \u4f18\u5316\u4ec5\u652f\u6301 SGD \u3001 SparseAdam input_features = self.embedding(sentences_sequence) # \u5c06\u5b57\u5411\u91cf\u4e0e\u521d\u59cb\u503c(\u9690\u85cf\u72b6\u6001 h0 , \u5355\u5143\u72b6\u6001 c0 )\u4f20\u5165 LSTM \u7ed3\u6784\u4e2d # \u8f93\u51fa\u5305\u542b\u5982\u4e0b\u5185\u5bb9\uff1a # 1, \u8ba1\u7b97\u7684\u8f93\u51fa\u7279\u5f81\uff0cshape \u4e3a(batch, sentence_length, hidden_size) # \u987a\u5e8f\u4e3a\u8bbe\u5b9a batch_first \u4e3a True \u60c5\u51b5, \u82e5\u672a\u8bbe\u5b9a\u5219 batch \u5728\u7b2c\u4e8c\u4f4d # 2, \u6700\u540e\u5f97\u5230\u7684\u9690\u85cf\u72b6\u6001 hn \uff0c shape \u4e3a(num_layers * num_directions, batch, hidden_size) # 3, \u6700\u540e\u5f97\u5230\u7684\u5355\u5143\u72b6\u6001 cn \uff0c shape \u4e3a(num_layers * num_directions, batch, hidden_size) output, (hn, cn) = self.bilstm(input_features, (h0, c0)) # \u5c06\u8f93\u51fa\u7279\u5f81\u8fdb\u884c\u7ebf\u6027\u53d8\u6362\uff0c\u8f6c\u4e3a shape \u4e3a (batch, sequence_length, tag_size) \u5927\u5c0f\u7684\u7279\u5f81 sequence_features = self.linear(output) # \u8f93\u51fa\u7ebf\u6027\u53d8\u6362\u4e3a tag \u6620\u5c04\u957f\u5ea6\u7684\u7279\u5f81 return sequence_features \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u6807\u7b7e\u7801\u8868\u5bf9\u7167 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4} # \u53c2\u65702:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u65703:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u65704:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65705:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u65706:\u5806\u53e0 LSTM \u5c42\u6570 NUM_LAYERS = 1 char_to_id = {\"<PAD>\":0} SENTENCE_LENGTH = 20 \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM(vocab_size=len(char_to_id), tag_to_id=tag_to_id, input_feature_size=EMBEDDING_DIM, \\ hidden_size=HIDDEN_DIM, batch_size=BATCH_SIZE, sentence_length=SENTENCE_LENGTH, num_layers=NUM_LAYERS) sentence_features = model(sentence_sequence) print(\"sequence_features:\\n\", sentence_features) \u8f93\u51fa\u6548\u679c: sequence_features: tensor([[[ 4.0880e-02, -5.8926e-02, -9.3971e-02, 8.4794e-03, -2.9872e-01], [ 2.9434e-02, -2.5901e-01, -2.0811e-01, 1.3794e-02, -1.8743e-01], [-2.7899e-02, -3.4636e-01, 1.3382e-02, 2.2684e-02, -1.2067e-01], [-1.9069e-01, -2.6668e-01, -5.7182e-02, 2.1566e-01, 1.1443e-01], ... [-1.6844e-01, -4.0699e-02, 2.6328e-02, 1.3513e-01, -2.4445e-01], [-7.3070e-02, 1.2032e-01, 2.2346e-01, 1.8993e-01, 8.3171e-02], [-1.6808e-01, 2.1454e-02, 3.2424e-01, 8.0905e-03, -1.5961e-01], [-1.9504e-01, -4.9296e-02, 1.7219e-01, 8.9345e-02, -1.4214e-01]], ... [[-3.4836e-03, 2.6217e-01, 1.9355e-01, 1.8084e-01, -1.6086e-01], [-9.1231e-02, -8.4838e-04, 1.0575e-01, 2.2864e-01, 1.6104e-02], [-8.7726e-02, -7.6956e-02, -7.0301e-02, 1.7199e-01, -6.5375e-02], [-5.9306e-02, -5.4701e-02, -9.3267e-02, 3.2478e-01, -4.0474e-02], [-1.1326e-01, 4.8365e-02, -1.7994e-01, 8.1722e-02, 1.8604e-01], ... [-5.8271e-02, -6.5781e-02, 9.9232e-02, 4.8524e-02, -8.2799e-02], [-6.8400e-02, -9.1515e-02, 1.1352e-01, 1.0674e-02, -8.2739e-02], [-9.1461e-02, -1.2304e-01, 1.2540e-01, -4.2065e-02, -8.3091e-02], [-1.5834e-01, -8.7316e-02, 7.0567e-02, -8.8845e-02, -7.0867e-02]], [[-1.4069e-01, 4.9171e-02, 1.4314e-01, -1.5284e-02, -1.4395e-01], [ 6.5296e-02, 9.3255e-03, -2.8411e-02, 1.5143e-01, 7.8252e-02], [ 4.1765e-03, -1.4635e-01, -4.9798e-02, 2.7597e-01, -1.0256e-01], ... [-3.9810e-02, -7.6746e-03, 1.2418e-01, 4.9897e-02, -8.4538e-02], [-3.4474e-02, -1.0586e-02, 1.3861e-01, 4.0395e-02, -8.3676e-02], [-3.4092e-02, -2.3208e-02, 1.6097e-01, 2.3498e-02, -8.3332e-02], [-4.6900e-02, -5.0335e-02, 1.8982e-01, 3.6287e-03, -7.8078e-02], [-6.4105e-02, -4.2628e-02, 1.8999e-01, -2.9888e-02, -1.1875e-01]]], grad_fn=<AddBackward0>) \u8f93\u51fa\u7ed3\u679c\u8bf4\u660e: \u8be5\u8f93\u51fa\u7ed3\u679c\u4e3a\u8f93\u5165\u6279\u6b21\u4e2d\u53e5\u5b50\u7684\u7279\u5f81, \u5229\u7528\u7ebf\u6027\u53d8\u6362\u5206\u522b\u5bf9\u5e94\u5230\u6bcf\u4e2atag\u7684\u5f97\u5206. \u4f8b\u5982\u4e0a\u8ff0\u6807\u91cf\u7b2c\u4e00\u4e2a\u503c\uff1a [ 4.0880e-02, -5.8926e-02, -9.3971e-02, 8.4794e-03, -2.9872e-01] \u8868\u793a\u7684\u610f\u601d\u4e3a\u7b2c\u4e00\u4e2a\u53e5\u5b50\u7b2c\u4e00\u4e2a\u5b57\u5206\u522b\u88ab\u6807\u8bb0\u4e3a[\"O\", \"B-dis\", \"I-dis\", \"B-sym\", \"I-sym\"]\u7684\u5206\u6570, \u7531\u6b64\u53ef\u4ee5\u5224\u65ad, \u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d, \u7b2c\u4e00\u4e2a\u5b57\u88ab\u6807\u6ce8\u4e3a\"O\"\u7684\u5206\u6570\u6700\u9ad8. \u5c0f\u8282\u603b\u7ed3: \u4e86\u89e3\u4e86BiLSTM\u7f51\u7edc\u7ed3\u6784 \u8bbe\u7f6e\u9690\u85cf\u5c42\u7ef4\u5ea6\u7684\u65f6\u5019, \u9700\u8981\u5c06hidden_size // 2 \u603b\u5171\u67093\u5c42\u9700\u8981\u6784\u5efa, \u5206\u522b\u662f\u8bcd\u5d4c\u5165\u5c42, \u53cc\u5411LSTM\u5c42, \u5168\u8fde\u63a5\u7ebf\u6027\u5c42 \u5728\u4ee3\u7801\u5c42\u9762, \u53cc\u5411LSTM\u5c31\u662f\u5c06nn.LSTM()\u4e2d\u7684\u53c2\u6570bidirectional\u8bbe\u7f6e\u4e3aTrue \u638c\u63e1\u4e86BiLSTM\u7f51\u7edc\u7684\u4ee3\u7801\u5b9e\u73b0 \u6784\u5efa\u7c7bBiLSTM\u7684\u521d\u59cb\u5316\u51fd\u6570 \u6dfb\u52a0\u6587\u672c\u5411\u91cf\u5316\u7684\u8f85\u52a9\u51fd\u6570, \u6ce8\u610fpadding\u586b\u5145\u4e3a\u76f8\u540c\u957f\u5ea6\u7684Tensor \u8981\u6ce8\u610fforward\u51fd\u6570\u4e2d\u4e0d\u540c\u5f20\u91cf\u7684\u5f62\u72b6\u7ea6\u5b9a","title":"6.2 BiLSTM\u4ecb\u7ecd"},{"location":"6/#63-crf","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3CRF\u7684\u6982\u5ff5\u548c\u4f5c\u7528 \u4e86\u89e3\u8f6c\u79fb\u6982\u7387\u77e9\u9635 \u4e86\u89e3\u53d1\u5c04\u6982\u7387\u77e9\u9635 CRF\u7684\u6982\u5ff5\u548c\u4f5c\u7528: CRF(\u5168\u79f0Conditional Random Fields), \u6761\u4ef6\u968f\u673a\u573a. \u662f\u7ed9\u5b9a\u8f93\u5165\u5e8f\u5217\u7684\u6761\u4ef6\u4e0b, \u6c42\u89e3\u8f93\u51fa\u5e8f\u5217\u7684\u6761\u4ef6\u6982\u7387\u5206\u5e03\u6a21\u578b. \u4e0b\u9762\u4e3e\u4e24\u4e2a\u5e94\u7528\u573a\u666f\u7684\u4f8b\u5b50: \u573a\u666f\u4e00: \u5047\u8bbe\u6709\u4e00\u5806\u65e5\u5e38\u751f\u6d3b\u7684\u7ed9\u5c0f\u670b\u53cb\u6392\u62cd\u7684\u89c6\u9891\u7247\u6bb5, \u53ef\u80fd\u7684\u72b6\u6001\u6709\u7761\u89c9\u3001\u5403\u996d\u3001\u559d\u6c34\u3001\u6d17\u6fa1\u3001\u5237\u7259\u3001\u73a9\u800d\u7b49, \u5927\u90e8\u5206\u60c5\u51b5, \u6211\u4eec\u662f\u80fd\u591f\u8bc6\u522b\u51fa\u89c6\u9891\u7247\u6bb5\u7684\u72b6\u6001. \u4f46\u5982\u679c\u4f60\u53ea\u662f\u770b\u5230\u4e00\u5c0f\u6bb5\u62ff\u676f\u5b50\u7684\u89c6\u9891, \u5728\u6ca1\u6709\u524d\u540e\u76f8\u8fde\u7684\u89c6\u9891\u4f5c\u4e3a\u524d\u540e\u6587\u53c2\u7167\u7684\u60c5\u51b5\u4e0b, \u6211\u4eec\u5f88\u96be\u77e5\u9053\u62ff\u676f\u5b50\u662f\u8981\u5237\u7259\u8fd8\u662f\u559d\u6c34. \u8fd9\u65f6, \u53ef\u4ee5\u7528\u5230CRF\u6a21\u578b. \u573a\u666f\u4e8c: \u5047\u8bbe\u6709\u5206\u597d\u8bcd\u7684\u53e5\u5b50, \u6211\u4eec\u8981\u5224\u65ad\u6bcf\u4e2a\u8bcd\u7684\u8bcd\u6027, \u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e9b\u8bcd\u6765\u8bf4, \u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u76f8\u90bb\u8bcd\u7684\u8bcd\u6027\u7684\u60c5\u51b5\u4e0b, \u662f\u5f88\u96be\u51c6\u786e\u5224\u65ad\u6bcf\u4e2a\u8bcd\u7684\u8bcd\u6027\u7684. \u8fd9\u65f6, \u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u5230CRF. \u57fa\u672c\u5b9a\u4e49: \u6211\u4eec\u5c06\u968f\u673a\u53d8\u91cf\u7684\u96c6\u5408\u79f0\u4e3a\u968f\u673a\u8fc7\u7a0b. \u7531\u4e00\u4e2a\u7a7a\u95f4\u53d8\u91cf\u7d22\u5f15\u7684\u968f\u673a\u8fc7\u7a0b, \u6211\u4eec\u5c06\u5176\u79f0\u4e3a\u968f\u673a\u573a. \u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d, \u505a\u8bcd\u6027\u6807\u6ce8\u65f6, \u53ef\u4ee5\u5c06{\u540d\u8bcd\u3001\u52a8\u8bcd\u3001\u5f62\u5bb9\u8bcd\u3001\u526f\u8bcd}\u8fd9\u4e9b\u8bcd\u6027\u5b9a\u4e49\u4e3a\u968f\u673a\u53d8\u91cf, \u7136\u540e\u4ece\u4e2d\u9009\u62e9\u76f8\u5e94\u7684\u8bcd\u6027, \u800c\u8fd9\u7ec4\u968f\u673a\u53d8\u91cf\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u9075\u5faa\u67d0\u79cd\u6982\u7387\u5206\u5e03, \u5c06\u8fd9\u4e9b\u8bcd\u6027\u6309\u7167\u5bf9\u5e94\u7684\u6982\u7387\u8d4b\u503c\u7ed9\u76f8\u5e94\u7684\u8bcd, \u5c31\u5b8c\u6210\u4e86\u53e5\u5b50\u7684\u8bcd\u6027\u6807\u6ce8. \u5173\u4e8e\u6761\u4ef6\u968f\u673a\u573a\u4e0e\u9a6c\u5c14\u79d1\u592b\u5047\u8bbe: \u524d\u9762\u8bfe\u7a0b\u6211\u4eec\u4ecb\u7ecd\u8fc7\u9a6c\u5c14\u79d1\u592b\u5047\u8bbe, \u4e5f\u5c31\u662f\u5f53\u524d\u4f4d\u7f6e\u7684\u53d6\u503c\u53ea\u548c\u4e0e\u5b83\u76f8\u90bb\u7684\u4f4d\u7f6e\u7684\u503c\u6709\u5173, \u548c\u5b83\u4e0d\u76f8\u90bb\u7684\u4f4d\u7f6e\u7684\u503c\u65e0\u5173. \u5e94\u7528\u5230\u6211\u4eec\u4e0a\u9762\u7684\u8bcd\u6027\u6807\u6ce8\u4f8b\u5b50\u4e2d, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u8bcd\u7684\u8bcd\u6027\u662f\u6839\u636e\u524d\u4e00\u4e2a\u8bcd\u548c\u540e\u4e00\u4e2a\u8bcd\u7684\u8bcd\u6027\u6765\u51b3\u5b9a\u7684, \u7b49\u6548\u4e8e\u4ece\u8bcd\u6027\u524d\u540e\u6587\u7684\u6982\u7387\u6765\u7ed9\u51fa\u5f53\u524d\u8bcd\u7684\u8bcd\u6027\u5224\u65ad\u7ed3\u679c. \u73b0\u5b9e\u4e2d\u53ef\u4ee5\u505a\u5982\u4e0b\u5047\u8bbe: \u5047\u8bbe\u4e00\u4e2a\u52a8\u8bcd\u6216\u8005\u526f\u8bcd\u540e\u9762\u4e0d\u4f1a\u8fde\u63a5\u540c\u6837\u7684\u52a8\u8bcd\u6216\u8005\u526f\u8bcd, \u8fd9\u6837\u7684\u6982\u7387\u5f88\u9ad8. \u90a3\u4e48, \u53ef\u4ee5\u5047\u5b9a\u8fd9\u79cd\u7ed9\u5b9a\u9690\u85cf\u72b6\u6001(\u4e5f\u5c31\u662f\u8bcd\u6027\u5e8f\u5217)\u7684\u60c5\u51b5\u4e0b, \u6765\u8ba1\u7b97\u89c2\u6d4b\u72b6\u6001\u7684\u8ba1\u7b97\u8fc7\u7a0b. \u672c\u8d28\u4e0aCRF\u6a21\u578b\u8003\u8651\u5230\u4e86\u89c2\u6d4b\u72b6\u6001\u8fd9\u4e2a\u5148\u9a8c\u6761\u4ef6, \u8fd9\u4e5f\u662f\u6761\u4ef6\u968f\u673a\u573a\u4e2d\u7684\u6761\u4ef6\u4e00\u8bcd\u7684\u542b\u4e49. \u8f6c\u79fb\u6982\u7387\u77e9\u9635: \u9996\u5148\u5047\u8bbe\u6211\u4eec\u9700\u8981\u6807\u6ce8\u7684\u5b9e\u4f53\u7c7b\u578b\u6709\u4e00\u4e0b\u51e0\u7c7b\uff1a {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4} # \u5176\u4e2ddis\u8868\u793a\u75be\u75c5(disease), sym\u8868\u793a\u75c7\u72b6(symptom), B\u8868\u793a\u547d\u540d\u5b9e\u4f53\u5f00\u5934, I\u8868\u793a\u547d\u540d\u5b9e\u4f53\u4e2d\u95f4\u5230\u7ed3\u5c3e, O\u8868\u793a\u5176\u4ed6\u7c7b\u578b. \u56e0\u6b64\u6211\u4eec\u5f88\u5bb9\u6613\u77e5\u9053\u6bcf\u4e2a\u5b57\u7684\u53ef\u80fd\u6807\u6ce8\u7c7b\u578b\u6709\u4ee5\u4e0a\u4e94\u79cd\u53ef\u80fd\u6027, \u90a3\u4e48\u5728\u4e00\u4e2a\u53e5\u5b50\u4e2d, \u7531\u4e0a\u4e00\u4e2a\u5b57\u5230\u4e0b\u4e00\u4e2a\u5b57\u7684\u6982\u7387\u4e58\u79ef\u5c31\u67095 \u00d7 5\u79cd\u53ef\u80fd\u6027, \u5177\u4f53\u89c1\u4e0b\u56fe\u6240\u793a: \u6700\u7ec8\u8bad\u7ec3\u51fa\u6765\u7ed3\u679c\u5927\u81f4\u4f1a\u5982\u4e0a\u56fe\u6240\u793a, \u5176\u4e2d\u4e0b\u6807\u7d22\u5f15\u4e3a(i, j)\u7684\u65b9\u683c\u4ee3\u8868\u5982\u679c\u5f53\u524d\u5b57\u7b26\u662f\u7b2ci\u884c\u8868\u793a\u7684\u6807\u7b7e, \u90a3\u4e48\u4e0b\u4e00\u4e2a\u5b57\u7b26\u8868\u793a\u7b2cj\u5217\u8868\u793a\u7684\u6807\u7b7e\u6240\u5bf9\u5e94\u7684\u6982\u7387\u503c. \u4ee5\u7b2c\u4e8c\u884c\u4e3a\u4f8b, \u5047\u8bbe\u5f53\u524d\u7b2ci\u4e2a\u5b57\u7684\u6807\u7b7e\u4e3aB-dis, \u90a3\u4e48\u7b2ci+1\u4e2a\u5b57\u6700\u5927\u53ef\u80fd\u51fa\u73b0\u7684\u6982\u7387\u5e94\u8be5\u662fI-dis. \u53d1\u5c04\u6982\u7387\u77e9\u9635: \u53d1\u5c04\u6982\u7387, \u662f\u6307\u5df2\u77e5\u5f53\u524d\u6807\u7b7e\u7684\u60c5\u51b5\u4e0b, \u5bf9\u5e94\u6240\u51fa\u73b0\u5b57\u7b26\u7684\u6982\u7387. \u901a\u4fd7\u7406\u89e3\u5c31\u662f\u5f53\u524d\u6807\u7b7e\u6bd4\u8f83\u53ef\u80fd\u51fa\u73b0\u7684\u6587\u5b57\u6709\u54ea\u4e9b, \u53ca\u5176\u5bf9\u5e94\u51fa\u73b0\u7684\u6982\u7387. \u4e0b\u9762\u662f\u51e0\u6bb5\u533b\u7597\u6587\u672c\u6570\u636e\u7684\u6807\u6ce8\u7ed3\u679c: \u53ef\u4ee5\u5f97\u5230\u4ee5\u4e0a\u53e5\u5b50\u7684\u8f6c\u79fb\u77e9\u9635\u6982\u7387\u5982\u4e0b\uff1a \u5bf9\u5e94\u7684\u53d1\u5c04\u77e9\u9635\u53ef\u4ee5\u7406\u89e3\u4e3a\u5982\u4e0b\u56fe\u6240\u793a\u7ed3\u679c\uff1a \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86CRF\u7684\u6982\u5ff5\u548c\u4f5c\u7528 \u6982\u5ff5: \u6761\u4ef6\u968f\u673a\u573a, \u4e00\u79cd\u6761\u4ef6\u6982\u7387\u5206\u5e03\u6a21\u578b \u4f5c\u7528: \u589e\u52a0\u4e86\u5148\u9a8c\u6761\u4ef6, \u53ef\u4ee5\u66f4\u597d\u7684\u5b8c\u6210\u5b9e\u4f53\u5e8f\u5217\u7684\u8bc6\u522b \u5b66\u4e60\u4e86\u8f6c\u79fb\u6982\u7387\u77e9\u9635 \u5b66\u4e60\u4e86\u53d1\u5c04\u6982\u7387\u77e9\u9635","title":"6.3 CRF\u4ecb\u7ecd"},{"location":"6/#64-bilstmcrf","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1BiLSTM+CRF\u6a21\u578b\u7ed3\u6784 \u638c\u63e1\u635f\u5931\u51fd\u6570\u7684\u5b9a\u4e49 \u638c\u63e1BiLSTM_CRF\u6a21\u578b\u7684\u5b9e\u73b0 BiLSTM+CRF\u6a21\u578b\u7ed3\u6784: 1, \u6a21\u578b\u7684\u6807\u7b7e\u5b9a\u4e49\u4e0e\u6574\u4f53\u67b6\u6784 2, \u6a21\u578b\u5185\u90e8\u7684\u5206\u5c42\u5c55\u5f00 3, CRF\u5c42\u7684\u4f5c\u7528 1, \u6a21\u578b\u7684\u6807\u7b7e\u5b9a\u4e49\u4e0e\u6574\u4f53\u67b6\u6784: \u5047\u8bbe\u6211\u4eec\u7684\u6570\u636e\u96c6\u4e2d\u6709\u4e24\u7c7b\u5b9e\u4f53-\u4eba\u540d, \u5730\u540d, \u4e0e\u4e4b\u5bf9\u5e94\u7684\u5728\u8bad\u7ec3\u96c6\u4e2d\u67095\u7c7b\u6807\u7b7e\u5982\u4e0b\u6240\u793a: B-Person, I-Person, B-Organization, I-Organization, O # B-Person: \u4eba\u540d\u7684\u5f00\u59cb # I-Person: \u4eba\u540d\u7684\u4e2d\u95f4\u90e8\u5206 # B-Organization: \u5730\u540d\u7684\u5f00\u59cb # I-Organization: \u5730\u540d\u7684\u4e2d\u95f4\u90e8\u5206 # O: \u5176\u4ed6\u975e\u4eba\u540d, \u975e\u5730\u540d\u7684\u6807\u7b7e \u5047\u8bbe\u4e00\u4e2a\u53e5\u5b50\u67095\u4e2a\u5355\u8bcd\u6784\u6210, (w0, w1, w2, w3, w4), \u6bcf\u4e00\u4e2a\u5355\u5143\u90fd\u4ee3\u8868\u7740\u7531\u5b57\u5d4c\u5165\u6784\u6210\u7684\u5411\u91cf. \u5176\u4e2d\u5b57\u5d4c\u5165\u662f\u968f\u673a\u521d\u59cb\u5316\u7684, \u8bcd\u5d4c\u5165\u662f\u901a\u8fc7\u6570\u636e\u8bad\u7ec3\u5f97\u5230\u7684, \u6240\u6709\u7684\u5d4c\u5165\u5728\u8bad\u7ec3\u8fc7\u7a0b\u4e2d\u90fd\u4f1a\u8c03\u6574\u5230\u6700\u4f18\u89e3. \u8fd9\u4e9b\u5b57\u5d4c\u5165\u6216\u8bcd\u5d4c\u5165\u4f5c\u4e3aBiLSTM+CRF\u6a21\u578b\u7684\u8f93\u5165, \u800c\u8f93\u51fa\u7684\u662f\u53e5\u5b50\u4e2d\u6bcf\u4e2a\u5355\u5143\u7684\u6807\u7b7e. 2, \u6a21\u578b\u5185\u90e8\u7684\u5206\u5c42\u5c55\u5f00: \u6574\u4e2a\u6a21\u578b\u660e\u663e\u6709\u4e24\u5c42, \u7b2c\u4e00\u5c42\u662fBiLSTM\u5c42, \u7b2c\u4e8c\u5c42\u662fCRF\u5c42, \u5c06\u5c42\u7684\u5185\u90e8\u5c55\u5f00\u5982\u4e0b\u56fe\u6240\u793a: BiLSTM\u5c42\u7684\u8f93\u51fa\u4e3a\u6bcf\u4e00\u4e2a\u6807\u7b7e\u7684\u9884\u6d4b\u5206\u503c, \u4f8b\u5982\u5bf9\u4e8e\u5355\u8bcdw0, BiLSTM\u5c42\u8f93\u51fa\u662f 1.5 (B-Person), 0.9 (I-Person), 0.1 (B-Organization), 0.08 (I-Organization), 0.05 (O) \u8fd9\u4e9b\u5206\u503c\u5c06\u4f5c\u4e3aCRF\u5c42\u7684\u8f93\u5165. 3, CRF\u5c42\u7684\u4f5c\u7528: \u5982\u679c\u6ca1\u6709CRF\u5c42, \u4e5f\u53ef\u4ee5\u8bad\u7ec3\u4e00\u4e2aBiLSTM\u547d\u540d\u5b9e\u4f53\u8bc6\u522b\u6a21\u578b, \u5982\u4e0b\u56fe\u6240\u793a: \u7531\u4e8eBiLSTM\u7684\u8f93\u51fa\u4e3a\u5355\u5143\u7684\u6bcf\u4e00\u4e2a\u6807\u7b7e\u5206\u503c, \u6211\u4eec\u53ef\u4ee5\u6311\u9009\u5206\u503c\u6700\u9ad8\u7684\u4e00\u4e2a\u4f5c\u4e3a\u8be5\u5355\u5143\u7684\u6807\u7b7e.\u4f8b\u5982, \u5bf9\u4e8e\u5355\u8bcdw0, \"B-Person\"\u7684\u5206\u503c-1.5\u662f\u6240\u6709\u6807\u7b7e\u5f97\u5206\u4e2d\u6700\u9ad8\u7684, \u56e0\u6b64\u53ef\u4ee5\u6311\u9009\"B-Person\"\u4f5c\u4e3a\u5355\u8bcdw0\u7684\u9884\u6d4b\u6807\u7b7e. \u540c\u7406, \u53ef\u4ee5\u5f97\u5230w1 - \"I-Person\", w2 - \"O\", w3 - \"B-Organization\", w4 - \"O\" \u867d\u7136\u6309\u7167\u4e0a\u8ff0\u65b9\u6cd5, \u5728\u6ca1\u6709CRF\u5c42\u7684\u6761\u4ef6\u4e0b\u6211\u4eec\u4e5f\u53ef\u4ee5\u5f97\u5230x\u4e2d\u6bcf\u4e2a\u5355\u5143\u7684\u9884\u6d4b\u6807\u7b7e, \u4f46\u662f\u4e0d\u80fd\u4fdd\u8bc1\u6807\u7b7e\u7684\u9884\u6d4b\u6bcf\u6b21\u90fd\u662f\u6b63\u786e\u7684. \u5982\u679c\u51fa\u73b0\u4e0b\u56fe\u7684BiLSTM\u5c42\u8f93\u51fa\u7ed3\u679c, \u5219\u660e\u663e\u9884\u6d4b\u662f\u9519\u8bef\u7684. CRF\u5c42\u80fd\u4ece\u8bad\u7ec3\u6570\u636e\u4e2d\u83b7\u5f97\u7ea6\u675f\u6027\u7684\u89c4\u5219. CRF\u5c42\u53ef\u4ee5\u4e3a\u6700\u540e\u9884\u6d4b\u7684\u6807\u7b7e\u6dfb\u52a0\u4e00\u4e9b\u7ea6\u675f\u6765\u4fdd\u8bc1\u9884\u6d4b\u7684\u6807\u7b7e\u662f\u5408\u6cd5\u7684. \u5728\u8bad\u7ec3\u6570\u636e\u8bad\u7ec3\u7684\u8fc7\u7a0b\u4e2d, \u8fd9\u4e9b\u7ea6\u675f\u53ef\u4ee5\u901a\u8fc7CRF\u5c42\u81ea\u52a8\u5b66\u4e60\u5230. 1: \u53e5\u5b50\u4e2d\u7684\u7b2c\u4e00\u4e2a\u8bcd\u603b\u662f\u4ee5\u6807\u7b7e\"B-\"\u6216\u8005\"O\"\u5f00\u59cb, \u800c\u4e0d\u662f\"I-\"\u5f00\u59cb. 2: \u6807\u7b7e\"B-label1 I-label2 I-label3 ......\", \u5176\u4e2d\u7684label1, label2, label3\u5e94\u8be5\u5c5e\u4e8e\u540c\u4e00\u7c7b\u5b9e\u4f53. \u6bd4\u5982, \"B-Person I-Person\"\u662f\u5408\u6cd5\u7684\u5e8f\u5217, \u4f46\u662f\"B-Person I-Organization\"\u662f\u975e\u6cd5\u7684\u5e8f\u5217. 3: \u6807\u7b7e\u5e8f\u5217\"O I-label\"\u662f\u975e\u6cd5\u5e8f\u5217, \u4efb\u610f\u5b9e\u4f53\u6807\u7b7e\u7684\u9996\u4e2a\u6807\u7b7e\u5e94\u8be5\u662f\"B-\", \u800c\u4e0d\u662f\"I-\". \u6bd4\u5982, \"O B-label\"\u624d\u662f\u5408\u6cd5\u7684\u5e8f\u5217 \u6709\u4e86\u4e0a\u8ff0\u8fd9\u4e9b\u7ea6\u675f, \u6807\u7b7e\u5e8f\u5217\u7684\u9884\u6d4b\u4e2d\u975e\u6cd5\u5e8f\u5217\u51fa\u73b0\u7684\u6982\u7387\u5c06\u4f1a\u5927\u5927\u964d\u4f4e. \u635f\u5931\u51fd\u6570\u7684\u5b9a\u4e49: BiLSTM\u5c42\u7684\u8f93\u51fa\u7ef4\u5ea6\u662ftag_size, \u4e5f\u5c31\u662f\u6bcf\u4e2a\u5355\u8bcdw_i\u6620\u5c04\u5230tag\u7684\u53d1\u5c04\u6982\u7387\u503c, \u5047\u8bbeBiLSTM\u7684\u8f93\u51fa\u77e9\u9635\u662fP, \u5176\u4e2dP(i,j)\u4ee3\u8868\u5355\u8bcdw_i\u6620\u5c04\u5230tag_j\u7684\u975e\u5f52\u4e00\u5316\u6982\u7387. \u5bf9\u4e8eCRF\u5c42, \u5047\u8bbe\u5b58\u5728\u4e00\u4e2a\u8f6c\u79fb\u77e9\u9635A, \u5176\u4e2dA(i,j)\u4ee3\u8868tag_j\u8f6c\u79fb\u5230tag_i\u7684\u6982\u7387. \u5bf9\u4e8e\u8f93\u5165\u5e8f\u5217X\u5bf9\u5e94\u7684\u8f93\u51fatag\u5e8f\u5217y, \u5b9a\u4e49\u5206\u6570\u5982\u4e0b(\u672c\u8d28\u4e0a\u5c31\u662f\u53d1\u5c04\u6982\u7387\u548c\u8f6c\u79fb\u6982\u7387\u7684\u7d2f\u52a0\u548c): \u5229\u7528softmax\u51fd\u6570, \u4e3a\u6bcf\u4e00\u4e2a\u6b63\u786e\u7684tag\u5e8f\u5217y\u5b9a\u4e49\u4e00\u4e2a\u6982\u7387\u503c, \u5728\u771f\u5b9e\u7684\u8bad\u7ec3\u4e2d, \u53ea\u9700\u8981\u6700\u5927\u5316\u4f3c\u7136\u6982\u7387p(y|X)\u5373\u53ef, \u5177\u4f53\u4f7f\u7528\u5bf9\u6570\u4f3c\u7136\u5982\u4e0b: BiLSTM+CRF\u6a21\u578b\u7684\u5b9e\u73b0: \u7b2c\u4e00\u6b65: \u6784\u5efa\u795e\u7ecf\u7f51\u7edc \u7b2c\u4e8c\u6b65: \u6587\u672c\u4fe1\u606f\u5f20\u91cf\u5316 \u7b2c\u4e09\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e00\u9879\u7684\u5206\u503c \u7b2c\u56db\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e8c\u9879\u7684\u5206\u503c \u7b2c\u4e94\u6b65: \u7ef4\u7279\u6bd4\u7b97\u6cd5\u7684\u5b9e\u73b0 \u7b2c\u516d\u6b65: \u5b8c\u5584BiLSTM_CRF\u7c7b\u7684\u5168\u90e8\u529f\u80fd \u7b2c\u4e00\u6b65: \u6784\u5efa\u795e\u7ecf\u7f51\u7edc # \u5bfc\u5165\u76f8\u5173\u5305\u4e0e\u6a21\u5757 import torch import torch.nn as nn class BiLSTM_CRF(nn.Module): def __init__(self, vocab_size, tag_to_ix, embedding_dim, hidden_dim, num_layers, batch_size, sequence_length): ''' description: \u6a21\u578b\u521d\u59cb\u5316 :param vocab_size: \u6240\u6709\u53e5\u5b50\u5305\u542b\u5b57\u7b26\u5927\u5c0f :param tag_to_ix: \u6807\u7b7e\u4e0eid\u5bf9\u7167\u5b57\u5178 :param embedding_dim: \u5b57\u5d4c\u5165\u7ef4\u5ea6(\u5373LSTM\u8f93\u5165\u5c42\u7ef4\u5ea6input_size) :param hidden_dim: \u9690\u85cf\u5c42\u5411\u91cf\u7ef4\u5ea6 :param num_layers: \u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 :param batch_size: \u6279\u6b21\u7684\u6570\u91cf :param sequence_length: \u8bed\u53e5\u7684\u9650\u5236\u6700\u5927\u957f\u5ea6 ''' # \u7ee7\u627f\u51fd\u6570\u7684\u521d\u59cb\u5316 super(BiLSTM_CRF, self).__init__() # \u8bbe\u7f6e\u6807\u7b7e\u4e0eid\u5bf9\u7167 self.tag_to_ix = tag_to_ix # \u8bbe\u7f6e\u6807\u7b7e\u5927\u5c0f\uff0c\u5bf9\u5e94 BiLSTM \u6700\u7ec8\u8f93\u51fa\u5206\u6570\u77e9\u9635\u5bbd\u5ea6 self.tagset_size = len(tag_to_ix) # \u8bbe\u5b9a LSTM \u8f93\u5165\u7279\u5f81\u5927\u5c0f self.embedding_dim = embedding_dim # \u8bbe\u7f6e\u9690\u85cf\u5c42\u7ef4\u5ea6 self.hidden_dim = hidden_dim # \u8bbe\u7f6e\u5355\u8bcd\u603b\u6570\u7684\u5927\u5c0f self.vocab_size = vocab_size # \u8bbe\u7f6e\u9690\u85cf\u5c42\u7684\u6570\u91cf self.num_layers = num_layers # \u8bbe\u7f6e\u8bed\u53e5\u7684\u6700\u5927\u9650\u5236\u957f\u5ea6 self.sequence_length = sequence_length # \u8bbe\u7f6e\u6279\u6b21\u7684\u5927\u5c0f self.batch_size = batch_size # \u6784\u5efa\u8bcd\u5d4c\u5165\u5c42, \u4e24\u4e2a\u53c2\u6570\u5206\u522b\u662f\u5355\u8bcd\u603b\u6570, \u8bcd\u5d4c\u5165\u7ef4\u5ea6 self.word_embeds = nn.Embedding(vocab_size, embedding_dim) # \u6784\u5efa\u53cc\u5411LSTM\u5c42, \u8f93\u5165\u53c2\u6570\u5305\u62ec\u8bcd\u5d4c\u5165\u7ef4\u5ea6, \u9690\u85cf\u5c42\u5927\u5c0f, \u5806\u53e0\u7684LSTM\u5c42\u6570, \u662f\u5426\u53cc\u5411\u6807\u5fd7\u4f4d self.lstm = nn.LSTM(embedding_dim, hidden_dim // 2, num_layers=self.num_layers, bidirectional=True) # \u6784\u5efa\u5168\u8fde\u63a5\u7ebf\u6027\u5c42, \u4e00\u7aef\u5bf9\u63a5LSTM\u9690\u85cf\u5c42, \u53e6\u4e00\u7aef\u5bf9\u63a5\u8f93\u51fa\u5c42, \u76f8\u5e94\u7684\u7ef4\u5ea6\u5c31\u662f\u6807\u7b7e\u6570\u91cftagset_size self.hidden2tag = nn.Linear(hidden_dim, self.tagset_size) # \u521d\u59cb\u5316\u8f6c\u79fb\u77e9\u9635, \u8f6c\u79fb\u77e9\u9635\u662f\u4e00\u4e2a\u65b9\u9635[tagset_size, tagset_size] self.transitions = nn.Parameter(torch.randn(self.tagset_size, self.tagset_size)) # \u6309\u7167\u635f\u5931\u51fd\u6570\u5c0f\u8282\u7684\u5b9a\u4e49, \u4efb\u610f\u7684\u5408\u6cd5\u53e5\u5b50\u4e0d\u4f1a\u8f6c\u79fb\u5230\"START_TAG\", \u56e0\u6b64\u8bbe\u7f6e\u4e3a-10000 # \u540c\u7406, \u4efb\u610f\u5408\u6cd5\u7684\u53e5\u5b50\u4e0d\u4f1a\u4ece\"STOP_TAG\"\u7ee7\u7eed\u5411\u4e0b\u8f6c\u79fb, \u4e5f\u8bbe\u7f6e\u4e3a-10000 self.transitions.data[tag_to_ix[START_TAG], :] = -10000 self.transitions.data[:, tag_to_ix[STOP_TAG]] = -10000 # \u521d\u59cb\u5316\u9690\u85cf\u5c42, \u5229\u7528\u5355\u72ec\u7684\u7c7b\u51fd\u6570init_hidden()\u6765\u5b8c\u6210 self.hidden = self.init_hidden() # \u5b9a\u4e49\u7c7b\u5185\u90e8\u4e13\u95e8\u7528\u4e8e\u521d\u59cb\u5316\u9690\u85cf\u5c42\u7684\u51fd\u6570 def init_hidden(self): # \u4e3a\u4e86\u7b26\u5408LSTM\u7684\u8f93\u5165\u8981\u6c42, \u6211\u4eec\u8fd4\u56deh0, c0, \u8fd9\u4e24\u4e2a\u5f20\u91cf\u7684shape\u5b8c\u5168\u4e00\u81f4 # \u9700\u8981\u6ce8\u610f\u7684\u662fshape: [2 * num_layers, batch_size, hidden_dim / 2] return (torch.randn(2 * self.num_layers, self.batch_size, self.hidden_dim // 2), torch.randn(2 * self.num_layers, self.batch_size, self.hidden_dim // 2)) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: # \u5f00\u59cb\u5b57\u7b26\u548c\u7ed3\u675f\u5b57\u7b26 START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u5b57\u7b26\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 char_to_id = {\"\u53cc\": 0, \"\u80ba\": 1, \"\u89c1\": 2, \"\u591a\": 3, \"\u53d1\": 4, \"\u6591\": 5, \"\u7247\": 6, \"\u72b6\": 7, \"\u7a0d\": 8, \"\u9ad8\": 9, \"\u5bc6\": 10, \"\u5ea6\": 11, \"\u5f71\": 12, \"\u3002\": 13} \u8c03\u7528: model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, sequence_length=SENTENCE_LENGTH) print(model) \u8f93\u51fa\u6548\u679c: BiLSTM( (word_embeds): Embedding(14, 200) (lstm): LSTM(200, 50, bidirectional=True) (hidden2tag): Linear(in_features=100, out_features=7, bias=True) ) \u7b2c\u4e8c\u6b65: \u6587\u672c\u4fe1\u606f\u5f20\u91cf\u5316 # \u51fd\u6570sentence_map\u5b8c\u6210\u4e2d\u6587\u6587\u672c\u4fe1\u606f\u7684\u6570\u5b57\u7f16\u7801, \u53d8\u6210\u5f20\u91cf def sentence_map(sentence_list, char_to_id, max_length): # \u5bf9\u4e00\u4e2a\u6279\u6b21\u7684\u6240\u6709\u8bed\u53e5\u6309\u7167\u957f\u77ed\u8fdb\u884c\u6392\u5e8f, \u6b64\u6b65\u9aa4\u975e\u5fc5\u987b sentence_list.sort(key=lambda c:len(c), reverse=True) # \u5b9a\u4e49\u4e00\u4e2a\u6700\u7ec8\u5b58\u50a8\u7ed3\u679c\u7279\u5f81\u5411\u91cf\u7684\u7a7a\u5217\u8868 sentence_map_list = [] # \u5faa\u73af\u904d\u5386\u4e00\u4e2a\u6279\u6b21\u5185\u7684\u6240\u6709\u8bed\u53e5 for sentence in sentence_list: # \u91c7\u7528\u5217\u8868\u751f\u6210\u5f0f\u5b8c\u6210\u5b57\u7b26\u5230id\u7684\u6620\u5c04 sentence_id_list = [char_to_id[c] for c in sentence] # \u957f\u5ea6\u4e0d\u591f\u7684\u90e8\u5206\u75280\u586b\u5145 padding_list = [0] * (max_length-len(sentence)) # \u5c06\u6bcf\u4e00\u4e2a\u8bed\u53e5\u5411\u91cf\u6269\u5145\u6210\u76f8\u540c\u957f\u5ea6\u7684\u5411\u91cf sentence_id_list.extend(padding_list) # \u8ffd\u52a0\u8fdb\u6700\u7ec8\u5b58\u50a8\u7ed3\u679c\u7684\u5217\u8868\u4e2d sentence_map_list.append(sentence_id_list) # \u8fd4\u56de\u4e00\u4e2a\u6807\u91cf\u7c7b\u578b\u503c\u7684\u5f20\u91cf return torch.tensor(sentence_map_list, dtype=torch.long) # \u5728\u7c7b\u4e2d\u5c06\u6587\u672c\u4fe1\u606f\u7ecf\u8fc7\u8bcd\u5d4c\u5165\u5c42, BiLSTM\u5c42, \u7ebf\u6027\u5c42\u7684\u5904\u7406, \u6700\u7ec8\u8f93\u51fa\u53e5\u5b50\u5f20\u91cf def _get_lstm_features(self, sentence): self.hidden = self.init_hidden() # a = self.word_embeds(sentence) # print(a.shape) torch.Size([8, 20, 200]) # LSTM\u7684\u8f93\u5165\u8981\u6c42\u5f62\u72b6\u4e3a [sequence_length, batch_size, embedding_dim] # LSTM\u7684\u9690\u85cf\u5c42h0\u8981\u6c42\u5f62\u72b6\u4e3a [num_layers * direction, batch_size, hidden_dim] embeds = self.word_embeds(sentence).view(self.sequence_length, self.batch_size, -1) # LSTM\u7684\u4e24\u4e2a\u8f93\u5165\u53c2\u6570: \u8bcd\u5d4c\u5165\u540e\u7684\u5f20\u91cf, \u968f\u673a\u521d\u59cb\u5316\u7684\u9690\u85cf\u5c42\u5f20\u91cf lstm_out, self.hidden = self.lstm(embeds, self.hidden) # \u8981\u4fdd\u8bc1\u8f93\u51fa\u5f20\u91cf\u7684shape: [sequence_length, batch_size, hidden_dim] lstm_out = lstm_out.view(self.sequence_length, self.batch_size, self.hidden_dim) # \u5c06BiLSTM\u7684\u8f93\u51fa\u7ecf\u8fc7\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42, \u5f97\u5230\u8f93\u51fa\u5f20\u91cfshape:[sequence_length, batch_size, tagset_size] lstm_feats = self.hidden2tag(lstm_out) return lstm_feats \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] \u8c03\u7528: char_to_id = {\"<PAD>\":0} if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) print(\"sentence_sequence:\\n\", sentence_sequence) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) sentence_features = model._get_lstm_features(sentence_sequence) print(\"sequence_features:\\n\", sentence_features) \u8f93\u51fa\u6548\u679c: sentence_sequence: tensor([[14, 15, 16, 17, 18, 16, 19, 20, 21, 13, 22, 23, 24, 25, 26, 27, 28, 29, 30, 0], [14, 15, 26, 27, 18, 49, 50, 12, 21, 13, 22, 51, 52, 25, 53, 54, 55, 29, 30, 0], [14, 15, 53, 56, 18, 49, 50, 18, 26, 27, 57, 58, 59, 22, 51, 52, 55, 29, 0, 0], [37, 63, 64, 65, 66, 55, 13, 22, 61, 51, 52, 25, 67, 68, 69, 70, 71, 13, 0, 0], [37, 38, 39, 7, 8, 40, 41, 42, 43, 44, 45, 46, 47, 48, 0, 0, 0, 0, 0, 0], [16, 17, 18, 53, 56, 12, 59, 60, 22, 61, 51, 52, 12, 62, 0, 0, 0, 0, 0, 0], [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 0, 0, 0, 0, 0, 0, 0], [31, 32, 24, 33, 34, 35, 36, 13, 30, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]) sequence_features: tensor([[[ 0.5118, 0.0895, -0.2030, ..., -0.2605, -0.2138, -0.0192], [ 0.1473, -0.0844, -0.1976, ..., -0.0260, -0.1921, 0.0378], [-0.2201, 0.0790, -0.0173, ..., 0.1551, -0.0899, 0.2035], ..., [-0.2387, 0.4015, -0.1882, ..., -0.0473, -0.0399, -0.2642], [ 0.1203, 0.2065, 0.0764, ..., 0.1412, -0.0817, 0.1800], [ 0.0362, 0.1477, -0.0596, ..., 0.1640, -0.0790, 0.0359]], [[ 0.1481, -0.0057, -0.1339, ..., 0.0348, -0.1515, 0.0797], [ 0.1469, 0.0430, -0.1578, ..., -0.0599, -0.1647, 0.2721], [-0.1601, 0.2572, 0.0821, ..., 0.0455, -0.0430, 0.2123], ..., [-0.0230, 0.3032, -0.2572, ..., -0.1670, -0.0009, -0.1256], [-0.0643, 0.1889, 0.0266, ..., -0.1044, -0.2333, 0.1548], [ 0.1969, 0.4262, -0.0194, ..., 0.1344, 0.0094, -0.0583]], [[ 0.2893, -0.0850, -0.1214, ..., 0.0855, 0.0234, 0.0684], [-0.0185, 0.0532, -0.1170, ..., 0.2265, -0.0688, 0.2116], [-0.0882, -0.0393, -0.0658, ..., 0.0006, -0.1219, 0.1954], ..., [ 0.0035, 0.0627, -0.1165, ..., -0.1742, -0.1552, -0.0772], [-0.1099, 0.2375, -0.0568, ..., -0.0636, -0.1998, 0.1747], [ 0.1005, 0.3047, -0.0009, ..., 0.1359, -0.0076, -0.1088]], ..., [[ 0.3587, 0.0157, -0.1612, ..., 0.0327, -0.3009, -0.2104], [ 0.2939, -0.1935, -0.1481, ..., 0.0349, -0.1136, 0.0226], [ 0.1832, -0.0890, -0.3369, ..., 0.0113, -0.1601, -0.1295], ..., [ 0.1462, 0.0905, -0.1082, ..., 0.1253, -0.0416, -0.0082], [ 0.2161, 0.0444, 0.0300, ..., 0.2624, -0.0970, 0.0016], [-0.0896, -0.0905, -0.1790, ..., 0.0711, -0.0477, -0.1236]], [[ 0.2954, 0.0616, -0.0810, ..., -0.0213, -0.1283, -0.1051], [-0.0038, -0.1580, -0.0555, ..., -0.1327, -0.1139, 0.2161], [ 0.1022, 0.1964, -0.1896, ..., -0.1081, -0.1491, -0.1872], ..., [ 0.3404, -0.0456, -0.2569, ..., 0.0701, -0.1644, -0.0731], [ 0.4573, 0.1885, -0.0779, ..., 0.1605, -0.1966, -0.0589], [ 0.1448, -0.1581, -0.3021, ..., 0.0837, -0.0334, -0.2364]], [[ 0.3556, 0.0299, -0.1570, ..., 0.0512, -0.3286, -0.2882], [ 0.2074, -0.1521, -0.1487, ..., 0.0637, -0.2674, -0.0174], [ 0.0976, -0.0754, -0.2779, ..., -0.1588, -0.2096, -0.3432], ..., [ 0.4961, 0.0583, -0.2965, ..., 0.0363, -0.2933, -0.1551], [ 0.4594, 0.3354, -0.0093, ..., 0.1681, -0.2508, -0.1423], [ 0.0957, -0.0486, -0.2616, ..., 0.0578, -0.0737, -0.2259]]], grad_fn=<AddBackward0>) \u7b2c\u4e09\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e00\u9879\u7684\u5206\u503c # \u82e5\u5e72\u8f85\u52a9\u51fd\u6570, \u5728\u7c7bBiLSTM\u5916\u90e8\u5b9a\u4e49, \u76ee\u7684\u662f\u8f85\u52a9log_sum_exp()\u51fd\u6570\u7684\u8ba1\u7b97 # \u5c06Variable\u7c7b\u578b\u53d8\u91cf\u5185\u90e8\u7684\u771f\u5b9e\u503c, \u4ee5python float\u7c7b\u578b\u8fd4\u56de def to_scalar(var): # var\u662fVariable, \u7ef4\u5ea6\u662f\uff11 # \u8fd4\u56de\u4e00\u4e2apython float\u7c7b\u578b\u7684\u503c return var.view(-1).data.tolist()[0] # \u83b7\u53d6\u6700\u5927\u503c\u7684\u4e0b\u6807 def argmax(vec): # \u8fd4\u56de\u5217\u7684\u7ef4\u5ea6\u4e0a\u7684\u6700\u5927\u503c\u4e0b\u6807, \u6b64\u4e0b\u6807\u662f\u4e00\u4e2a\u6807\u91cffloat _, idx = torch.max(vec, 1) return to_scalar(idx) # \u8f85\u52a9\u5b8c\u6210\u635f\u5931\u51fd\u6570\u4e2d\u7684\u516c\u5f0f\u8ba1\u7b97 def log_sum_exp(vec): # vec\u662f1 * 7, type\u662fVariable max_score = vec[0, argmax(vec)] #max_score\u7ef4\u5ea6\u662f1, max_score.view(1,-1)\u7ef4\u5ea6\u662f1 * 1, max_score.view(1, -1).expand(1, vec.size()[1])\u7684\u7ef4\u5ea61 * 7 # \u7ecf\u8fc7expand()\u4e4b\u540e\u7684\u5f20\u91cf, \u91cc\u9762\u6240\u6709\u7684\u503c\u90fd\u76f8\u540c, \u90fd\u662f\u6700\u5927\u503cmax_score max_score_broadcast = max_score.view(1, -1).expand(1, vec.size()[1]) # vec.size()\u7ef4\u5ea6\u662f1 * 7 # \u5148\u51cf\u53bbmax_score,\u6700\u540e\u518d\u52a0\u4e0amax_score, \u662f\u4e3a\u4e86\u9632\u6b62\u6570\u503c\u7206\u70b8, \u7eaf\u7cb9\u662f\u4ee3\u7801\u4e0a\u7684\u5c0f\u6280\u5de7 return max_score + torch.log(torch.sum(torch.exp(vec - max_score_broadcast))) # \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e00\u9879\u7684\u5206\u503c\u51fd\u6570, \u672c\u8d28\u4e0a\u662f\u53d1\u5c04\u77e9\u9635\u548c\u8f6c\u79fb\u77e9\u9635\u7684\u7d2f\u52a0\u548c def _forward_alg(self, feats): # \u521d\u59cb\u5316\u4e00\u4e2aalphas\u5f20\u91cf, \u4ee3\u8868\u8f6c\u79fb\u77e9\u9635\u7684\u8d77\u59cb\u4f4d\u7f6e init_alphas = torch.full((1, self.tagset_size), -10000.) # init_alphas: [1, 7] , [-10000, -10000, -10000, -10000, -10000, -10000, -10000] # \u4ec5\u4ec5\u628aSTART_TAG\u8d4b\u503c\u4e3a0, \u4ee3\u8868\u7740\u63a5\u4e0b\u6765\u7684\u8f6c\u79fb\u53ea\u80fd\u4eceSTART_TAG\u5f00\u59cb init_alphas[0][self.tag_to_ix[START_TAG]] = 0. # \u524d\u5411\u8ba1\u7b97\u53d8\u91cf\u7684\u8d4b\u503c, \u8fd9\u6837\u5728\u53cd\u5411\u6c42\u5bfc\u7684\u8fc7\u7a0b\u4e2d\u5c31\u53ef\u4ee5\u81ea\u52a8\u66f4\u65b0\u53c2\u6570 forward_var = init_alphas # \u8f93\u5165\u8fdb\u6765\u7684feats: [20, 8, 7], \u4e3a\u4e86\u63a5\u4e0b\u6765\u6309\u53e5\u5b50\u8fdb\u884c\u8ba1\u7b97, \u8981\u5c06batch_size\u653e\u5728\u7b2c\u4e00\u4e2a\u7ef4\u5ea6\u4e0a feats = feats.transpose(1, 0) # feats: [8, 20, 7]\u662f\u4e00\u4e2a3\u7ef4\u77e9\u9635, \u6700\u5916\u5c42\u4ee3\u88688\u4e2a\u53e5\u5b50, \u5185\u5c42\u4ee3\u8868\u6bcf\u4e2a\u53e5\u5b50\u670920\u4e2a\u5b57\u7b26, # \u6bcf\u4e00\u4e2a\u5b57\u7b26\u6620\u5c04\u62107\u4e2a\u6807\u7b7e\u7684\u53d1\u5c04\u6982\u7387 # \u521d\u59cb\u5316\u6700\u7ec8\u7684\u7ed3\u679c\u5f20\u91cf, \u6bcf\u4e2a\u53e5\u5b50\u5bf9\u5e94\u4e00\u4e2a\u5206\u6570 result = torch.zeros((1, self.batch_size)) idx = 0 # \u6309\u884c\u904d\u5386, \u603b\u5171\u5faa\u73afbatch_size\u6b21 for feat_line in feats: # \u904d\u5386\u4e00\u884c\u8bed\u53e5, \u6bcf\u4e00\u4e2afeat\u4ee3\u8868\u4e00\u4e2atime_step for feat in feat_line: # \u5f53\u524dtime_step\u7684\u4e00\u4e2aforward tensors alphas_t = [] # \u5728\u5f53\u524dtime_step, \u904d\u5386\u6240\u6709\u53ef\u80fd\u7684\u8f6c\u79fb\u6807\u7b7e, \u8fdb\u884c\u7d2f\u52a0\u8ba1\u7b97 for next_tag in range(self.tagset_size): # \u5e7f\u64ad\u53d1\u5c04\u77e9\u9635\u7684\u5206\u6570 emit_score = feat[next_tag].view(1, -1).expand(1, self.tagset_size) # \u7b2ci\u4e2atime_step\u5faa\u73af\u65f6, \u8f6c\u79fb\u5230next_tag\u6807\u7b7e\u7684\u8f6c\u79fb\u6982\u7387 trans_score = self.transitions[next_tag].view(1, -1) # \u5c06\u524d\u5411\u77e9\u9635, \u8f6c\u79fb\u77e9\u9635, \u53d1\u5c04\u77e9\u9635\u7d2f\u52a0 next_tag_var = forward_var + trans_score + emit_score # \u8ba1\u7b97log_sum_exp()\u51fd\u6570\u503c # a = log_sum_exp(next_tag_var), \u6ce8\u610f: log_sum_exp()\u51fd\u6570\u4ec5\u4ec5\u8fd4\u56de\u4e00\u4e2a\u5b9e\u6570\u503c # print(a.shape) : tensor(1.0975) , ([]) # b = a.view(1) : tensor([1.0975]), \u6ce8\u610f: a.view(1)\u7684\u64cd\u4f5c\u5c31\u662f\u5c06\u4e00\u4e2a\u6570\u5b57\u53d8\u6210\u4e00\u4e2a\u4e00\u9636\u77e9\u9635, ([]) -> ([1]) # print(b.shape) : ([1]) alphas_t.append(log_sum_exp(next_tag_var).view(1)) # print(alphas_t) : [tensor([337.6004], grad_fn=<ViewBackward>), tensor([337.0469], grad_fn=<ViewBackward>), tensor([337.8497], grad_fn=<ViewBackward>), tensor([337.8668], grad_fn=<ViewBackward>), tensor([338.0186], grad_fn=<ViewBackward>), tensor([-9662.2734], grad_fn=<ViewBackward>), tensor([337.8692], grad_fn=<ViewBackward>)] # temp = torch.cat(alphas_t) # print(temp) : tensor([[ 337.6004, 337.0469, 337.8497, 337.8668, 338.0186, -9662.2734, 337.8692]]) # \u5c06\u5217\u8868\u5f20\u91cf\u8f6c\u53d8\u4e3a\u4e8c\u7ef4\u5f20\u91cf forward_var = torch.cat(alphas_t).view(1, -1) # print(forward_var.shape) : [1, 7] # print(forward_var) : tensor([[ 13.7928, 16.0067, 14.1092, -9984.7852, 15.8380]]) # \u6dfb\u52a0\u6700\u540e\u4e00\u6b65\u8f6c\u79fb\u5230\"STOP_TAG\"\u7684\u5206\u6570, \u5c31\u5b8c\u6210\u4e86\u6574\u6761\u8bed\u53e5\u7684\u5206\u6570\u8ba1\u7b97 terminal_var = forward_var + self.transitions[self.tag_to_ix[STOP_TAG]] # print(terminal_var) : tensor([[ 339.2167, 340.8612, 340.2773, 339.0194, 340.8908, -9659.5732, -9660.0527]]) # \u8ba1\u7b97log_sum_exp()\u51fd\u6570\u503c, \u4f5c\u4e3a\u4e00\u6761\u6837\u672c\u8bed\u53e5\u7684\u6700\u7ec8\u5f97\u5206 alpha = log_sum_exp(terminal_var) # print(alpha) : tensor(341.9394) # \u5c06\u5f97\u5206\u6dfb\u52a0\u8fdb\u7ed3\u679c\u5217\u8868\u4e2d, \u4f5c\u4e3a\u51fd\u6570\u7ed3\u679c\u8fd4\u56de result[0][idx] = alpha idx += 1 return result \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) for epoch in range(1): model.zero_grad() feats = model._get_lstm_features(sentence_sequence) forward_score = model._forward_alg(feats) print(forward_score) \u8f93\u51fa\u6548\u679c: tensor([[ 44.0279, 87.6439, 132.7635, 176.7535, 221.1325, 265.4456, 309.8346, 355.9332]], grad_fn=<CopySlices>) \u7b2c\u56db\u6b65: \u8ba1\u7b97\u635f\u5931\u51fd\u6570\u7b2c\u4e8c\u9879\u7684\u5206\u503c def _score_sentence(self, feats, tags): # feats: [20, 8, 7] , tags: [8, 20] # \u521d\u59cb\u5316\u4e00\u4e2a0\u503c\u7684tensor, \u4e3a\u540e\u7eed\u7d2f\u52a0\u505a\u51c6\u5907 score = torch.zeros(1) # \u5c06START_TAG\u548c\u771f\u5b9e\u6807\u7b7etags\u505a\u5217\u7ef4\u5ea6\u4e0a\u7684\u62fc\u63a5 temp = torch.tensor(torch.full((self.batch_size, 1), self.tag_to_ix[START_TAG]), dtype=torch.long) tags = torch.cat((temp, tags), dim=1) # \u5c06\u4f20\u5165\u7684feats\u5f62\u72b6\u8f6c\u53d8\u4e3a[bathc_size, sequence_length, tagset_size] feats = feats.transpose(1, 0) # feats: [8, 20, 7] idx = 0 # \u521d\u59cb\u5316\u6700\u7ec8\u7684\u7ed3\u679c\u5206\u6570\u5f20\u91cf, \u6bcf\u4e00\u4e2a\u53e5\u5b50\u5f97\u5230\u4e00\u4e2a\u5206\u6570 result = torch.zeros((1, self.batch_size)) for feat_line in feats: # \u6ce8\u610f: \u6b64\u5904\u533a\u522b\u4e8e\u7b2c\u4e09\u6b65\u7684\u5faa\u73af, \u6700\u91cd\u8981\u7684\u662f\u8fd9\u662f\u5728\u771f\u5b9e\u6807\u7b7e\u6307\u5bfc\u4e0b\u7684\u8f6c\u79fb\u77e9\u9635\u548c\u53d1\u5c04\u77e9\u9635\u7684\u7d2f\u52a0\u5206\u6570 for i, feat in enumerate(feat_line): score = score + self.transitions[tags[idx][i + 1], tags[idx][i]] + feat[tags[idx][i + 1]] # \u6700\u540e\u52a0\u4e0a\u8f6c\u79fb\u5230STOP_TAG\u7684\u5206\u6570 score = score + self.transitions[self.tag_to_ix[STOP_TAG], tags[idx][-1]] result[0][idx] = score idx += 1 return result \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] # \u771f\u5b9e\u6807\u7b7e\u6570\u636e, \u5bf9\u5e94\u4e3atag_to_ix\u4e2d\u7684\u6570\u5b57\u6807\u7b7e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u5c06\u6807\u7b7e\u8f6c\u4e3a\u6807\u91cftags tags = torch.tensor(tag_list, dtype=torch.long) \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) for epoch in range(1): model.zero_grad() feats = model._get_lstm_features(sentence_sequence) gold_score = model._score_sentence(feats, tags) print(gold_score) \u8f93\u51fa\u6548\u679c: tensor([[ 5.3102, 9.0228, 14.7486, 19.5984, 32.4324, 37.9789, 57.8647, 66.8853]], grad_fn=<CopySlices>) \u7b2c\u4e94\u6b65: \u7ef4\u7279\u6bd4\u7b97\u6cd5\u7684\u5b9e\u73b0 # \u6839\u636e\u4f20\u5165\u7684\u8bed\u53e5\u7279\u5f81feats, \u63a8\u65ad\u51fa\u6807\u7b7e\u5e8f\u5217 def _viterbi_decode(self, feats): # \u521d\u59cb\u5316\u6700\u4f73\u8def\u5f84\u7ed3\u679c\u7684\u5b58\u653e\u5217\u8868 result_best_path = [] # \u5c06\u8f93\u5165\u5f20\u91cf\u53d8\u5f62\u4e3a[batch_size, sequence_length, tagset_size] feats = feats.transpose(1, 0) # \u5bf9\u6279\u6b21\u4e2d\u7684\u6bcf\u4e00\u884c\u8bed\u53e5\u8fdb\u884c\u904d\u5386, \u6bcf\u4e2a\u8bed\u53e5\u4ea7\u751f\u4e00\u4e2a\u6700\u4f18\u6807\u6ce8\u5e8f\u5217 for feat_line in feats: backpointers = [] # \u521d\u59cb\u5316\u524d\u5411\u4f20\u64ad\u7684\u5f20\u91cf, \u8bbe\u7f6eSTART_TAG\u7b49\u4e8e0, \u7ea6\u675f\u5408\u6cd5\u5e8f\u5217\u53ea\u80fd\u4eceSTART_TAG\u5f00\u59cb init_vvars = torch.full((1, self.tagset_size), -10000.) init_vvars[0][self.tag_to_ix[START_TAG]] = 0 # \u5728\u7b2ci\u4e2atime_step, \u5f20\u91cfforward_var\u4fdd\u5b58\u7b2ci-1\u4e2atime_step\u7684viterbi\u53d8\u91cf forward_var = init_vvars # \u4f9d\u6b21\u904d\u5386i=0, \u5230\u5e8f\u5217\u6700\u540e\u7684\u6bcf\u4e00\u4e2atime_step for feat in feat_line: # \u4fdd\u5b58\u5f53\u524dtime_step\u7684\u56de\u6eaf\u6307\u9488 bptrs_t = [] # \u4fdd\u5b58\u5f53\u524dtime_step\u7684viterbi\u53d8\u91cf viterbivars_t = [] for next_tag in range(self.tagset_size): # next_tag_var[i]\u4fdd\u5b58\u4e86tag_i \u5728\u524d\u4e00\u4e2atime_step\u7684viterbi\u53d8\u91cf # \u524d\u5411\u4f20\u64ad\u5f20\u91cfforward_var\u52a0\u4e0a\u4ecetag_i\u8f6c\u79fb\u5230next_tag\u7684\u5206\u6570, \u8d4b\u503c\u7ed9next_tag_var # \u6ce8\u610f\u6b64\u5904\u6ca1\u6709\u52a0\u53d1\u5c04\u77e9\u9635\u5206\u6570, \u56e0\u4e3a\u6c42\u6700\u5927\u503c\u4e0d\u9700\u8981\u53d1\u5c04\u77e9\u9635 next_tag_var = forward_var + self.transitions[next_tag] # \u5c06\u6700\u5927\u7684\u6807\u7b7eid\u52a0\u5165\u5230\u5f53\u524dtime_step\u7684\u56de\u6eaf\u5217\u8868\u4e2d best_tag_id = argmax(next_tag_var) bptrs_t.append(best_tag_id) viterbivars_t.append(next_tag_var[0][best_tag_id].view(1)) # \u6b64\u5904\u518d\u5c06\u53d1\u5c04\u77e9\u9635\u5206\u6570feat\u52a0\u4e0a, \u8d4b\u503c\u7ed9forward_var, \u4f5c\u4e3a\u4e0b\u4e00\u4e2atime_step\u7684\u524d\u5411\u4f20\u64ad\u5f20\u91cf forward_var = (torch.cat(viterbivars_t) + feat).view(1, -1) # \u5f53\u524dtime_step\u7684\u56de\u6eaf\u6307\u9488\u6dfb\u52a0\u8fdb\u5f53\u524d\u8fd9\u4e00\u884c\u6837\u672c\u7684\u603b\u4f53\u56de\u6eaf\u6307\u9488\u4e2d backpointers.append(bptrs_t) # \u6700\u540e\u52a0\u4e0a\u8f6c\u79fb\u5230STOP_TAG\u7684\u5206\u6570 terminal_var = forward_var + self.transitions[self.tag_to_ix[STOP_TAG]] best_tag_id = argmax(terminal_var) # path_score\u662f\u6574\u4e2a\u8def\u5f84\u7684\u603b\u5f97\u5206 path_score = terminal_var[0][best_tag_id] # \u6839\u636e\u56de\u6eaf\u6307\u9488, \u89e3\u7801\u6700\u4f73\u8def\u5f84 # \u9996\u5148\u628a\u6700\u540e\u4e00\u6b65\u7684id\u503c\u52a0\u5165 best_path = [best_tag_id] # \u4ece\u540e\u5411\u524d\u56de\u6eaf\u6700\u4f73\u8def\u5f84 for bptrs_t in reversed(backpointers): # \u901a\u8fc7\u7b2ci\u4e2atime_step\u5f97\u5230\u7684\u6700\u4f73id, \u627e\u5230\u7b2ci-1\u4e2atime_step\u7684\u6700\u4f73id best_tag_id = bptrs_t[best_tag_id] best_path.append(best_tag_id) # \u5c06START_TAG\u5220\u9664 start = best_path.pop() # \u786e\u8ba4\u4e00\u4e0b\u6700\u4f73\u8def\u5f84\u4e2d\u7684\u7b2c\u4e00\u4e2a\u6807\u7b7e\u662fSTART_TAG assert start == self.tag_to_ix[START_TAG] # \u56e0\u4e3a\u662f\u4ece\u540e\u5411\u524d\u56de\u6eaf, \u6240\u4ee5\u518d\u6b21\u9006\u5e8f\u5f97\u5230\u603b\u524d\u5411\u540e\u7684\u771f\u5b9e\u8def\u5f84 best_path.reverse() # \u5f53\u524d\u8fd9\u4e00\u884c\u7684\u6837\u672c\u7ed3\u679c\u6dfb\u52a0\u5230\u6700\u7ec8\u7684\u7ed3\u679c\u5217\u8868\u91cc result_best_path.append(best_path) return result_best_path \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e/data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] # \u771f\u5b9e\u6807\u7b7e\u6570\u636e, \u5bf9\u5e94\u4e3atag_to_ix\u4e2d\u7684\u6570\u5b57\u6807\u7b7e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u5c06\u6807\u7b7e\u8f6c\u4e3a\u6807\u91cftags tags = torch.tensor(tag_list, dtype=torch.long) \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) for epoch in range(1): model.zero_grad() feats = model._get_lstm_features(sentence_sequence) result_tags = model._viterbi_decode(feats) print(result_tags) \u8f93\u51fa\u6548\u679c: [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2]] \u7b2c\u516d\u6b65: \u5b8c\u5584BiLSTM\u7c7b\u7684\u5168\u90e8\u529f\u80fd # \u5bf9\u6570\u4f3c\u7136\u51fd\u6570\u7684\u8ba1\u7b97, \u8f93\u5165\u7684\u662f\u6570\u5b57\u5316\u7f16\u7801\u540e\u7684\u8bed\u53e5, \u548c\u771f\u5b9e\u7684\u6807\u7b7e # \u6ce8\u610f: \u8fd9\u4e2a\u51fd\u6570\u662f\u672a\u6765\u771f\u5b9e\u8bad\u7ec3\u4e2d\u8981\u7528\u5230\u7684\"\u865a\u62df\u5316\u7684forward()\" def neg_log_likelihood(self, sentence, tags): # \u7b2c\u4e00\u6b65\u5148\u5f97\u5230BiLSTM\u5c42\u7684\u8f93\u51fa\u7279\u5f81\u5f20\u91cf feats = self._get_lstm_features(sentence) # feats : [20, 8, 7] \u4ee3\u8868\u4e00\u4e2a\u6279\u6b21\u67098\u4e2a\u6837\u672c, \u6bcf\u4e2a\u6837\u672c\u957f\u5ea620 # \u6bcf\u4e00\u4e2aword\u6620\u5c04\u52307\u4e2a\u6807\u7b7e\u7684\u6982\u7387, \u53d1\u5c04\u77e9\u9635 # forward_score \u4ee3\u8868\u516c\u5f0f\u63a8\u5bfc\u4e2d\u635f\u5931\u51fd\u6570loss\u7684\u7b2c\u4e00\u9879 forward_score = self._forward_alg(feats) # gold_score \u4ee3\u8868\u516c\u5f0f\u63a8\u5bfc\u4e2d\u635f\u5931\u51fd\u6570loss\u7684\u7b2c\u4e8c\u9879 gold_score = self._score_sentence(feats, tags) # \u6309\u884c\u6c42\u548c, \u5728torch.sum()\u51fd\u6570\u503c\u4e2d, \u9700\u8981\u8bbe\u7f6edim=1 ; \u540c\u7406, dim=0\u4ee3\u8868\u6309\u5217\u6c42\u548c # \u6ce8\u610f: \u5728\u8fd9\u91cc, \u901a\u8fc7forward_score\u548cgold_score\u7684\u5dee\u503c\u6765\u4f5c\u4e3aloss, \u7528\u6765\u68af\u5ea6\u4e0b\u964d\u8bad\u7ec3\u6a21\u578b return torch.sum(forward_score - gold_score, dim=1) # \u6b64\u5904\u7684forward()\u771f\u5b9e\u573a\u666f\u662f\u7528\u5728\u9884\u6d4b\u90e8\u5206, \u8bad\u7ec3\u7684\u65f6\u5019\u5e76\u6ca1\u6709\u7528\u5230 def forward(self, sentence): # \u83b7\u53d6\u4eceBiLSTM\u5c42\u5f97\u5230\u7684\u53d1\u5c04\u77e9\u9635 lstm_feats = self._get_lstm_features(sentence) # \u901a\u8fc7\u7ef4\u7279\u6bd4\u7b97\u6cd5\u76f4\u63a5\u89e3\u7801\u6700\u4f73\u8def\u5f84 tag_seq = self._viterbi_decode(lstm_feats) return tag_seq \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/bilstm_crf.py \u8f93\u5165\u53c2\u6570: START_TAG = \"<START>\" STOP_TAG = \"<STOP>\" # \u6807\u7b7e\u548c\u5e8f\u53f7\u7684\u5bf9\u5e94\u7801\u8868 tag_to_ix = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, START_TAG: 5, STOP_TAG: 6} # \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u9690\u85cf\u5c42\u795e\u7ecf\u5143\u7684\u6570\u91cf HIDDEN_DIM = 100 # \u6279\u6b21\u7684\u5927\u5c0f BATCH_SIZE = 8 # \u8bbe\u7f6e\u6700\u5927\u8bed\u53e5\u9650\u5236\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u9ed8\u8ba4\u795e\u7ecf\u7f51\u7edc\u7684\u5c42\u6570 NUM_LAYERS = 1 # \u521d\u59cb\u5316\u7684\u793a\u4f8b\u8bed\u53e5, \u51718\u884c, \u53ef\u4ee5\u7406\u89e3\u4e3a\u5f53\u524d\u6279\u6b21batch_size=8 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] # \u771f\u5b9e\u6807\u7b7e\u6570\u636e, \u5bf9\u5e94\u4e3atag_to_ix\u4e2d\u7684\u6570\u5b57\u6807\u7b7e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u5c06\u6807\u7b7e\u8f6c\u4e3a\u6807\u91cftags tags = torch.tensor(tag_list, dtype=torch.long) \u8c03\u7528: if __name__ == '__main__': for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentence_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag_to_ix, embedding_dim=EMBEDDING_DIM, \\ hidden_dim=HIDDEN_DIM, num_layers=NUM_LAYERS, batch_size=BATCH_SIZE, \\ sequence_length=SENTENCE_LENGTH) optimizer = optim.SGD(model.parameters(), lr=0.01, weight_decay=1e-4) for epoch in range(1): model.zero_grad() loss = model.neg_log_likelihood(sentence_sequence, tags) print(loss) loss.backward() optimizer.step() result = model(sentence_sequence) print(result) \u8f93\u51fa\u6548\u679c: tensor([2347.2678], grad_fn=<SumBackward1>) [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]]","title":"6.4 BiLSTM+CRF\u6a21\u578b"},{"location":"6/#65","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u6570\u636e\u7684\u9884\u5904\u7406\u6d41\u7a0b \u638c\u63e1\u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e\u7684\u65b9\u6cd5 \u638c\u63e1\u6a21\u578b\u8bad\u7ec3\u4ee3\u7801 \u6a21\u578b\u8bad\u7ec3\u7684\u6d41\u7a0b \u7b2c\u4e00\u6b65: \u719f\u6089\u5b57\u7b26\u5230\u6570\u5b57\u7f16\u7801\u7684\u7801\u8868 \u7b2c\u4e8c\u6b65: \u719f\u6089\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u548c\u542b\u4e49\u89e3\u91ca \u7b2c\u4e09\u6b65: \u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e \u7b2c\u56db\u6b65: \u5b8c\u6210\u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u7684\u8bc4\u4f30\u4ee3\u7801 \u7b2c\u4e94\u6b65: \u5b8c\u6210\u8bad\u7ec3\u6a21\u578b\u7684\u4ee3\u7801 \u7b2c\u516d\u6b65: \u7ed8\u5236\u635f\u5931\u66f2\u7ebf\u548c\u8bc4\u4f30\u66f2\u7ebf\u56fe \u7b2c\u4e00\u6b65: \u719f\u6089\u5b57\u7b26\u5230\u6570\u5b57\u7f16\u7801\u7684\u7801\u8868. # \u4ee3\u8868\u4e86\u6570\u636e\u96c6\u4e2d\u6240\u6709\u5b57\u7b26\u5230\u6570\u5b57\u7f16\u7801\u7684\u5b57\u5178\u6620\u5c04 # \u7801\u8868\u53ef\u4ee5\u5305\u542b\u4e2d\u6587\u7b80\u4f53\u3001\u7e41\u4f53\u3001\u82f1\u6587\u5927\u5c0f\u5199\u5b57\u6bcd\u3001\u6570\u5b57\u3001\u4e2d\u82f1\u6587\u6807\u70b9\u7b26\u53f7\u7b49\u7b49 # <PAD>\u4e3a\u586b\u5145\u6807\u8bc6, \u8bad\u7ec3\u65f6\u9700\u8981\u5c06\u53e5\u5b50\u8f6c\u5316\u6210\u77e9\u9635, \u800c\u53e5\u5b50\u957f\u77ed\u4e0d\u4e00, \u9700\u8981\u505apadding\u5904\u7406 { \"<PAD>\": 0, \"\u5391\": 1, \"\u5416\": 2, \"\u5475\": 3, \"\u554a\": 4, \"\u55c4\": 5, \"\u5b36\": 6, ... } \u7801\u8868\u6240\u5728\u4f4d\u7f6e: /data/doctor_offline/ner_model/data/char_to_id.json \u7b2c\u4e8c\u6b65: \u719f\u6089\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u548c\u542b\u4e49\u89e3\u91ca. \u8368 B-dis \u9ebb I-dis \u75b9 I-dis \u8fd9 O \u4e48 O \u75d2 O \u548b O \u529e O \u3002 O \u7a81 O \u7136 O \u5934 B-sym \u6655 I-sym \u5455 B-sym \u5410 I-sym \u3002 O \u8bad\u7ec3\u6570\u636e\u96c6\u7684\u542b\u4e49\u89e3\u91ca: \u6bcf\u4e00\u884c\u5305\u542b\u4e00\u4e2a\u5b57\u4ee5\u53ca\u4e0e\u4e4b\u5bf9\u5e94\u7684\u6807\u7b7e, \u5b57\u4e0e\u6807\u7b7e\u4e4b\u95f4\u901a\u8fc7\\t\u5206\u9694 \u53e5\u5b50\u4e0e\u53e5\u5b50\u4e4b\u95f4\u901a\u8fc7\u7a7a\u884c\u5206\u9694 \u6807\u7b7e\u8bf4\u660e: B-dis: \u75be\u75c5\u5b9e\u4f53\u540d\u8bcd\u8d77\u59cb\u6807\u8bc6 I-dis: \u75be\u75c5\u5b9e\u4f53\u540d\u8bcd\u4e2d\u95f4\u5230\u7ed3\u5c3e\u6807\u8bc6 B-sym: \u75c7\u72b6\u5b9e\u4f53\u540d\u8bcd\u8d77\u59cb\u6807\u8bc6 I-sym: \u75c7\u72b6\u5b9e\u4f53\u540d\u8bcd\u4e2d\u95f4\u5230\u7ed3\u5c3e\u6807\u8bc6 O: \u5176\u4ed6\u975e\u5b9e\u4f53\u90e8\u5206\u6807\u8bc6 \u6570\u636e\u96c6\u6240\u5728\u4f4d\u7f6e: /data/doctor_offline/ner_model/data/train.txt \u5c06\u8bad\u7ec3\u6570\u636e\u96c6\u8f6c\u6362\u4e3a\u6570\u5b57\u5316\u7f16\u7801\u96c6: # \u5bfc\u5165\u5305 import json import numpy as np # \u521b\u5efa\u8bad\u7ec3\u6570\u636e\u96c6, \u4ece\u539f\u59cb\u8bad\u7ec3\u6587\u4ef6\u4e2d\u5c06\u4e2d\u6587\u5b57\u7b26\u8fdb\u884c\u6570\u5b57\u7f16\u7801, \u5e76\u5c06\u6807\u7b7e\u9875\u8fdb\u884c\u6570\u5b57\u7f16\u7801 def create_train_data(train_data_file, result_file, json_file, tag2id, max_length=20): # \u5bfc\u5165json\u683c\u5f0f\u7684\u4e2d\u6587\u5b57\u7b26\u5230id\u7684\u6620\u5c04\u8868 char2id = json.load(open(json_file, mode='r', encoding='utf-8')) char_data, tag_data = [], [] # \u6253\u5f00\u539f\u59cb\u8bad\u7ec3\u6587\u4ef6 with open(train_data_file, mode='r', encoding='utf-8') as f: # \u521d\u59cb\u5316\u4e00\u6761\u8bed\u53e5\u6570\u5b57\u5316\u7f16\u7801\u540e\u7684\u5217\u8868 char_ids = [0] * max_length tag_ids = [0] * max_length idx = 0 for line in f.readlines(): line = line.strip('\\n').strip() # \u5982\u679c\u4e0d\u662f\u7a7a\u884c, \u5e76\u4e14\u5f53\u524d\u8bed\u53e5\u957f\u5ea6\u6ca1\u6709\u8d85\u8fc7max_length, \u5219\u8fdb\u884c\u5b57\u7b26\u5230id\u7684\u6620\u5c04 if len(line) > 0 and line and idx < max_length: ch, tag = line.split('\\t') # \u5982\u679c\u5f53\u524d\u5b57\u7b26\u5b58\u5728\u4e8e\u6620\u5c04\u8868\u4e2d, \u5219\u76f4\u63a5\u6620\u5c04\u4e3a\u5bf9\u5e94\u7684id\u503c if char2id.get(ch): char_ids[idx] = char2id[ch] # \u5426\u5219\u76f4\u63a5\u7528\"UNK\"\u7684id\u503c\u6765\u4ee3\u66ff\u8fd9\u4e2a\u672a\u77e5\u5b57\u7b26 else: char_ids[idx] = char2id['UNK'] # \u5c06\u6807\u7b7e\u4e5f\u8fdb\u884c\u5bf9\u5e94\u7684\u8f6c\u6362 tag_ids[idx] = tag2id[tag] idx += 1 # \u5982\u679c\u662f\u7a7a\u884c, \u6216\u8005\u5f53\u524d\u8bed\u53e5\u957f\u5ea6\u8d85\u8fc7max_length else: # \u5982\u679c\u5f53\u524d\u8bed\u53e5\u957f\u5ea6\u8d85\u8fc7max_length, \u76f4\u63a5\u5c06[0: max_langth]\u7684\u90e8\u5206\u4f5c\u4e3a\u7ed3\u679c if idx <= max_length: char_data.append(char_ids) tag_data.append(tag_ids) # \u9047\u5230\u7a7a\u884c, \u8bf4\u660e\u5f53\u524d\u53e5\u5b50\u5df2\u7ecf\u7ed3\u675f, \u521d\u59cb\u5316\u6e05\u96f6, \u4e3a\u4e0b\u4e00\u4e2a\u53e5\u5b50\u7684\u6620\u5c04\u505a\u51c6\u5907 char_ids = [0] * max_length tag_ids = [0] * max_length idx = 0 # \u5c06\u6570\u5b57\u5316\u7f16\u7801\u540e\u7684\u6570\u636e\u5c01\u88c5\u6210numpy\u7684\u6570\u7ec4\u7c7b\u578b, \u6570\u5b57\u7f16\u7801\u91c7\u7528np.int32 x_data = np.array(char_data, dtype=np.int32) y_data = np.array(tag_data, dtype=np.int32) # \u76f4\u63a5\u5229\u7528np.savez()\u5c06\u6570\u636e\u5b58\u50a8\u4e3a.npz\u7c7b\u578b\u7684\u6587\u4ef6 np.savez(result_file, x_data=x_data, y_data=y_data) print(\"create_train_data Finished!\".center(100, \"-\")) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/preprocess_data.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def json_file = './data/char_to_id.json' # \u53c2\u65702:\u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178 tag2id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65703:\u8bad\u7ec3\u6570\u636e\u6587\u4ef6\u8def\u5f84 train_data_file = './data/train.txt' # \u53c2\u65704:\u521b\u5efa\u7684npz\u6587\u4ef6\u4fdd\u8def\u5f84(\u8bad\u7ec3\u6570\u636e) result_file = './data/train.npz' \u8c03\u7528: if __name__ == '__main__': create_train_data(train_data_file, result_file, json_file, tag2id) \u8f93\u51fa\u6548\u679c: ------------------------------------create_train_data Finished!------------------------------------- \u751f\u6210\u4e86\u65b0\u7684\u6570\u636e\u96c6\u6587\u4ef6: /data/doctor_offline/ner_model/data/train.npz \u7b2c\u4e09\u6b65: \u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e. # \u5bfc\u5165\u76f8\u5173\u7684\u5305 import numpy as np import torch import torch.utils.data as Data # \u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e def load_dataset(data_file, batch_size): # \u5c06\u7b2c\u4e8c\u6b65\u751f\u6210\u7684train.npz\u6587\u4ef6\u5bfc\u5165\u5185\u5b58 data = np.load(data_file) # \u5206\u522b\u53d6\u51fa\u7279\u5f81\u503c\u548c\u6807\u7b7e x_data = data['x_data'] y_data = data['y_data'] # \u5c06\u6570\u636e\u5c01\u88c5\u6210tensor\u5f20\u91cf x = torch.tensor(x_data, dtype=torch.long) y = torch.tensor(y_data, dtype=torch.long) # \u5c06\u6570\u636e\u5c01\u88c5\u6210Tensor\u6570\u636e\u96c6 dataset = Data.TensorDataset(x, y) total_length = len(dataset) # \u91c7\u752880%\u7684\u6570\u636e\u4f5c\u4e3a\u8bad\u7ec3\u96c6, 20%\u7684\u6570\u636e\u4f5c\u4e3a\u6d4b\u8bd5\u96c6 train_length = int(total_length * 0.8) validation_length = total_length - train_length # \u5229\u7528Data.random_split()\u76f4\u63a5\u5207\u5206\u96c6\u5408, \u6309\u716780%, 20%\u7684\u6bd4\u4f8b\u5212\u5206 train_dataset, validation_dataset = Data.random_split(dataset=dataset, lengths=[train_length, validation_length]) # \u5c06\u8bad\u7ec3\u96c6\u8fdb\u884cDataLoader\u5c01\u88c5 # \u53c2\u6570\u8bf4\u660e\u5982\u4e0b: # dataset: \u8bad\u7ec3\u6570\u636e\u96c6 # batch_size: \u4ee3\u8868\u6279\u6b21\u5927\u5c0f, \u82e5\u6570\u636e\u96c6\u603b\u6837\u672c\u6570\u91cf\u65e0\u6cd5\u88abbatch_size\u6574\u9664, \u5219\u6700\u540e\u4e00\u6279\u6570\u636e\u4e3a\u4f59\u6570 # \u82e5\u8bbe\u7f6edrop_last\u4e3aTrue\uff0c \u5219\u81ea\u52a8\u62b9\u53bb\u6700\u540e\u4e0d\u80fd\u88ab\u6574\u9664\u7684\u5269\u4f59\u6279\u6b21 # shuffle: \u662f\u5426\u6bcf\u4e2a\u6279\u6b21\u4e3a\u968f\u673a\u62bd\u53d6, \u82e5\u4e3aTrue, \u5219\u6bcf\u6b21\u8fed\u4ee3\u65f6\u6570\u636e\u4e3a\u968f\u673a\u62bd\u53d6 # num_workers: \u8bbe\u5b9a\u6709\u591a\u5c11\u5b50\u8fdb\u7a0b\u7528\u6765\u505a\u6570\u636e\u52a0\u8f7d, \u9ed8\u8ba4\u4e3a0, \u5373\u6570\u636e\u5c06\u88ab\u52a0\u8f7d\u5230\u4e3b\u8fdb\u7a0b\u4e2d # drop_last: \u662f\u5426\u53bb\u9664\u4e0d\u80fd\u88ab\u6574\u9664\u540e\u7684\u6700\u540e\u6279\u6b21, \u82e5\u4e3aTrue, \u5219\u4e0d\u751f\u6210\u6700\u540e\u4e0d\u80fd\u88ab\u6574\u9664\u5269\u4f59\u7684\u6570\u636e\u5185\u5bb9 # \u4f8b\u5982: dataset\u957f\u5ea6\u4e3a1028, batch_size\u4e3a8, # \u82e5drop_last=True, \u5219\u6700\u540e\u5269\u4f59\u76844(1028/8=128\u4f594)\u6761\u6570\u636e\u5c06\u88ab\u629b\u5f03\u4e0d\u7528 train_loader = Data.DataLoader(dataset=train_dataset, batch_size=batch_size, shuffle=True, num_workers=4, drop_last=True) validation_loader = Data.DataLoader(dataset=validation_dataset, batch_size=batch_size, shuffle=True, num_workers=4, drop_last=True) # \u5c06\u4e24\u4e2a\u6570\u636e\u751f\u6210\u5668\u5c01\u88c5\u4e3a\u4e00\u4e2a\u5b57\u5178\u7c7b\u578b data_loaders = {'train': train_loader, 'validation': validation_loader} # \u5c06\u4e24\u4e2a\u6570\u636e\u96c6\u7684\u957f\u5ea6\u4e5f\u5c01\u88c5\u4e3a\u4e00\u4e2a\u5b57\u5178\u7c7b\u578b data_size = {'train': train_length, 'validation': validation_length} return data_loaders, data_size \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/loader_data.py \u8f93\u5165\u53c2\u6570: # \u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u7f16\u7801\u540e\u7684\u8bad\u7ec3\u6570\u636e\u6587\u4ef6\u8def\u5f84 DATA_FILE = './data/train.npz' \u8c03\u7528: if __name__ == '__main__': data_loader, data_size = load_dataset(DATA_FILE, BATCH_SIZE) print('data_loader:', data_loader, '\\ndata_size:', data_size) \u8f93\u51fa\u6548\u679c: data_loader: {'train': <torch.utils.data.dataloader.DataLoader object at 0x7f29eaafb3d0>, 'validation': <torch.utils.data.dataloader.DataLoader object at 0x7f29eaafb5d0>} data_size: {'train': 5368, 'validation': 1343} \u7b2c\u56db\u6b65: \u5b8c\u6210\u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u7684\u8bc4\u4f30\u4ee3\u7801. # \u8bc4\u4f30\u6a21\u578b\u7684\u51c6\u786e\u7387, \u53ec\u56de\u7387, F1, \u7b49\u6307\u6807 def evaluate(sentence_list, true_tag, predict_tag, id2char, id2tag): ''' sentence_list: \u6587\u672c\u5411\u91cf\u5316\u540e\u7684\u53e5\u5b50\u5411\u91cf\u5217\u8868 true_tag: \u771f\u5b9e\u7684\u6807\u7b7e predict_tag: \u6a21\u578b\u9884\u6d4b\u7684\u6807\u7b7e id2char: id\u503c\u5230\u4e2d\u6587\u5b57\u7b26\u7684\u6620\u5c04\u8868 id2tag: id\u503c\u5230\u6807\u7b7e\u7684\u6620\u5c04\u8868 ''' # \u521d\u59cb\u5316\u771f\u5b9e\u7684\u547d\u540d\u5b9e\u4f53, \u9884\u6d4b\u7684\u547d\u540d\u5b9e\u4f53, \u63a5\u4e0b\u6765\u6bd4\u8f83\u4e24\u8005\u6765\u8bc4\u4f30\u5404\u9879\u6307\u6807 true_entities, true_entity = [], [] predict_entities, predict_entity = [], [] # \u9010\u6761\u904d\u5386\u6279\u6b21\u4e2d\u6240\u6709\u7684\u8bed\u53e5 for line_num, sentence in enumerate(sentence_list): # \u904d\u5386\u4e00\u6761\u6837\u672c\u8bed\u53e5\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5b57\u7b26\u7f16\u7801(\u8fd9\u91cc\u9762\u662f\u6570\u5b57\u5316\u7f16\u7801) for char_num in range(len(sentence)): # \u7f16\u7801\u4e3a0, \u8868\u793a\u540e\u9762\u90fd\u662f\u586b\u5145\u76840, \u53ef\u4ee5\u7ed3\u675ffor\u5faa\u73af if sentence[char_num]==0: break # \u4f9d\u6b21\u53d6\u51fa\u771f\u5b9e\u7684\u6837\u672c\u5b57\u7b26, \u771f\u5b9e\u7684\u6807\u7b7e, \u9884\u6d4b\u7684\u6807\u7b7e char_text = id2char[sentence[char_num]] true_tag_type = id2tag[true_tag[line_num][char_num]] predict_tag_type = id2tag[predict_tag[line_num][char_num]] # \u5bf9\u771f\u5b9e\u6807\u7b7e\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"B\", \u8868\u793a\u4e00\u4e2a\u5b9e\u4f53\u7684\u5f00\u59cb, \u5c06\"\u5b57\u7b26/\u6807\u7b7e\"\u7684\u683c\u5f0f\u6dfb\u52a0\u8fdb\u5b9e\u4f53\u5217\u8868\u4e2d if true_tag_type[0] == \"B\": true_entity = [char_text + \"/\" + true_tag_type] # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"I\", \u8868\u793a\u5904\u4e8e\u4e00\u4e2a\u5b9e\u4f53\u7684\u4e2d\u95f4 # \u5982\u679c\u771f\u5b9e\u547d\u540d\u5b9e\u4f53\u5217\u8868\u975e\u7a7a, \u5e76\u4e14\u6700\u540e\u4e00\u4e2a\u6dfb\u52a0\u8fdb\u53bb\u7684\u6807\u7b7e\u7c7b\u578b\u548c\u5f53\u524d\u7684\u6807\u7b7e\u7c7b\u578b\u4e00\u6837, \u5219\u7ee7\u7eed\u6dfb\u52a0 # \u610f\u601d\u5c31\u662f\u6bd4\u5982true_entity = [\"\u4e2d/B-Person\", \"\u56fd/I-Person\"], \u6b64\u65f6\u7684\"\u4eba/I-Person\"\u5c31\u53ef\u4ee5\u6dfb\u52a0\u8fdb\u53bb, \u56e0\u4e3a\u90fd\u5c5e\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53 elif true_tag_type[0] == \"I\" and len(true_entity) != 0 and true_entity[-1].split(\"/\")[1][1:] == true_tag_type[1:]: true_entity.append(char_text + \"/\" + true_tag_type) # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"O\", \u5e76\u4e14true_entity\u975e\u7a7a, \u8868\u793a\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u7ed3\u675f\u4e86 elif true_tag_type[0] == \"O\" and len(true_entity) != 0 : # \u6700\u540e\u589e\u52a0\u8fdb\u53bb\u4e00\u4e2a\"\u884c\u53f7_\u5217\u53f7\", \u4f5c\u4e3a\u533a\u5206\u5b9e\u4f53\u7684\u6807\u5fd7 true_entity.append(str(line_num) + \"_\" + str(char_num)) # \u5c06\u8fd9\u4e2a\u5339\u914d\u51fa\u6765\u7684\u5b9e\u4f53\u52a0\u5165\u5230\u7ed3\u679c\u5217\u8868\u4e2d true_entities.append(true_entity) # \u6e05\u7a7atrue_entity, \u4e3a\u4e0b\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u505a\u51c6\u5907 true_entity=[] # \u9664\u4e86\u4e0a\u9762\u4e09\u79cd\u60c5\u51b5, \u8bf4\u660e\u5f53\u524d\u6ca1\u6709\u5339\u914d\u51fa\u4efb\u4f55\u547d\u540d\u5b9e\u4f53, \u5219\u6e05\u7a7atrue_entity, \u7ee7\u7eed\u4e0b\u4e00\u6b21\u5339\u914d else: true_entity=[] # \u5bf9\u9884\u6d4b\u6807\u7b7e\u8fdb\u884c\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"B\", \u8868\u793a\u4e00\u4e2a\u5b9e\u4f53\u7684\u5f00\u59cb, \u5c06\"\u5b57\u7b26/\u9884\u6d4b\u6807\u7b7e\"\u7684\u683c\u5f0f\u6dfb\u52a0\u8fdb\u5b9e\u4f53\u5217\u8868\u4e2d if predict_tag_type[0] == \"B\": predict_entity = [char_text + \"/\" + predict_tag_type] # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"I\", \u8868\u793a\u5904\u4e8e\u4e00\u4e2a\u5b9e\u4f53\u7684\u4e2d\u95f4 # \u5982\u679c\u9884\u6d4b\u547d\u540d\u5b9e\u4f53\u5217\u8868\u975e\u7a7a, \u5e76\u4e14\u6700\u540e\u4e00\u4e2a\u6dfb\u52a0\u8fdb\u53bb\u7684\u6807\u7b7e\u7c7b\u578b\u548c\u5f53\u524d\u7684\u6807\u7b7e\u7c7b\u578b\u4e00\u6837, \u5219\u7ee7\u7eed\u6dfb\u52a0 # \u610f\u601d\u5c31\u662f\u6bd4\u5982predict_entity = [\"\u4e2d/B-Person\", \"\u56fd/I-Person\"], \u6b64\u65f6\u7684\"\u4eba/I-Person\"\u5c31\u53ef\u4ee5\u6dfb>\u52a0\u8fdb\u53bb, \u56e0\u4e3a\u90fd\u5c5e\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53 elif predict_tag_type[0] == \"I\" and len(predict_entity) != 0 and predict_entity[-1].split(\"/\")[1][1:] == predict_tag_type[1:]: predict_entity.append(char_text + \"/\" + predict_tag_type) # \u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f\"O\", \u5e76\u4e14predict_entity\u975e\u7a7a, \u8868\u793a\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u7ed3\u675f\u4e86 elif predict_tag_type[0] == \"O\" and len(predict_entity) != 0: # \u6700\u540e\u589e\u52a0\u8fdb\u53bb\u4e00\u4e2a\"\u884c\u53f7_\u5217\u53f7\", \u4f5c\u4e3a\u533a\u5206\u5b9e\u4f53\u7684\u6807\u5fd7 predict_entity.append(str(line_num) + \"_\" + str(char_num)) # \u5c06\u8fd9\u4e2a\u5339\u914d\u51fa\u6765\u7684\u5b9e\u4f53\u52a0\u5165\u5230\u7ed3\u679c\u5217\u8868\u4e2d predict_entities.append(predict_entity) # \u6e05\u7a7apredict_entity, \u4e3a\u4e0b\u4e00\u4e2a\u547d\u540d\u5b9e\u4f53\u7684\u5339\u914d\u505a\u51c6\u5907 predict_entity = [] # \u9664\u4e86\u4e0a\u9762\u4e09\u79cd\u60c5\u51b5, \u8bf4\u660e\u5f53\u524d\u6ca1\u6709\u5339\u914d\u51fa\u4efb\u4f55\u547d\u540d\u5b9e\u4f53, \u5219\u6e05\u7a7apredict_entity, \u7ee7\u7eed\u4e0b\u4e00\u6b21\u5339\u914d else: predict_entity = [] # \u904d\u5386\u6240\u6709\u9884\u6d4b\u5b9e\u4f53\u7684\u5217\u8868, \u53ea\u6709\u90a3\u4e9b\u5728\u771f\u5b9e\u547d\u540d\u5b9e\u4f53\u4e2d\u7684\u624d\u662f\u6b63\u786e\u7684 acc_entities = [entity for entity in predict_entities if entity in true_entities] # \u8ba1\u7b97\u6b63\u786e\u5b9e\u4f53\u7684\u4e2a\u6570, \u9884\u6d4b\u5b9e\u4f53\u7684\u603b\u4e2a\u6570, \u771f\u5b9e\u5b9e\u4f53\u7684\u603b\u4e2a\u6570 acc_entities_length = len(acc_entities) predict_entities_length = len(predict_entities) true_entities_length = len(true_entities) # \u81f3\u5c11\u6b63\u786e\u9884\u6d4b\u4e86\u4e00\u4e2a, \u624d\u8ba1\u7b973\u4e2a\u6307\u6807, \u51c6\u786e\u7387 if acc_entities_length > 0: accuracy = float(acc_entities_length / predict_entities_length) recall = float(acc_entities_length / true_entities_length) f1_score = 2 * accuracy * recall / (accuracy + recall) return accuracy, recall, f1_score, acc_entities_length, predict_entities_length, true_entities_length else: return 0, 0, 0, acc_entities_length, predict_entities_length, true_entities_length \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/evaluate_model.py \u8f93\u5165\u53c2\u6570: # \u771f\u5b9e\u6807\u7b7e\u6570\u636e tag_list = [ [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u9884\u6d4b\u6807\u7b7e\u6570\u636e predict_tag_list = [ [0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0], [0, 0, 3, 4, 0, 3, 4, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], [3, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 2, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 3, 4, 0, 0, 0, 0, 0], [3, 4, 0, 3, 4, 0, 0, 1, 2, 0, 0, 3, 4, 0, 0, 0, 0, 0, 0, 0], [0, 0, 1, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] ] # \u7f16\u7801\u4e0e\u5b57\u7b26\u5bf9\u7167\u5b57\u5178 id2char = {0: '<PAD>', 1: '\u786e', 2: '\u8bca', 3: '\u5f25', 4: '\u6f2b', 5: '\u5927', 6: 'b', 7: '\u7ec6', 8: '\u80de', 9: '\u6dcb', 10: '\u5df4', 11: '\u7624', 12: '1', 13: '\u5e74', 14: '\u53cd', 15: '\u590d', 16: '\u54b3', 17: '\u55fd', 18: '\u3001', 19: '\u75f0', 20: '4', 21: '0', 22: ',', 23: '\u518d', 24: '\u53d1', 25: '\u4f34', 26: '\u6c14', 27: '\u4fc3', 28: '5', 29: '\u5929', 30: '\u3002', 31: '\u751f', 32: '\u957f', 33: '\u80b2', 34: '\u8fdf', 35: '\u7f13', 36: '9', 37: '\u53f3', 38: '\u4fa7', 39: '\u5c0f', 40: '\u80ba', 41: '\u764c', 42: '\u7b2c', 43: '\u4e09', 44: '\u6b21', 45: '\u5316', 46: '\u7597', 47: '\u5165', 48: '\u9662', 49: '\u5fc3', 50: '\u60b8', 51: '\u52a0', 52: '\u91cd', 53: '\u80f8', 54: '\u75db', 55: '3', 56: '\u95f7', 57: '2', 58: '\u591a', 59: '\u6708', 60: '\u4f59', 61: ' ', 62: '\u5468', 63: '\u4e0a', 64: '\u80a2', 65: '\u65e0', 66: '\u529b', 67: '\u808c', 68: '\u8089', 69: '\u840e', 70: '\u7f29', 71: '\u534a'} # \u7f16\u7801\u4e0e\u6807\u7b7e\u5bf9\u7167\u5b57\u5178 id2tag = {0: 'O', 1: 'B-dis', 2: 'I-dis', 3: 'B-sym', 4: 'I-sym'} # \u8f93\u5165\u7684\u6570\u5b57\u5316sentences_sequence, \u7531\u4e0b\u9762\u7684sentence_list\u7ecf\u8fc7\u6620\u5c04\u51fd\u6570sentence_map()\u8f6c\u5316\u540e\u5f97\u5230 sentence_list = [ \"\u786e\u8bca\u5f25\u6f2b\u5927b\u7ec6\u80de\u6dcb\u5df4\u76241\u5e74\", \"\u53cd\u590d\u54b3\u55fd\u3001\u54b3\u75f040\u5e74,\u518d\u53d1\u4f34\u6c14\u4fc35\u5929\u3002\", \"\u751f\u957f\u53d1\u80b2\u8fdf\u7f139\u5e74\u3002\", \"\u53f3\u4fa7\u5c0f\u7ec6\u80de\u80ba\u764c\u7b2c\u4e09\u6b21\u5316\u7597\u5165\u9662\", \"\u53cd\u590d\u6c14\u4fc3\u3001\u5fc3\u60b810\u5e74,\u52a0\u91cd\u4f34\u80f8\u75db3\u5929\u3002\", \"\u53cd\u590d\u80f8\u95f7\u3001\u5fc3\u60b8\u3001\u6c14\u4fc32\u591a\u6708,\u52a0\u91cd3\u5929\", \"\u54b3\u55fd\u3001\u80f8\u95f71\u6708\u4f59, \u52a0\u91cd1\u5468\", \"\u53f3\u4e0a\u80a2\u65e0\u529b3\u5e74, \u52a0\u91cd\u4f34\u808c\u8089\u840e\u7f29\u534a\u5e74\" ] \u8c03\u7528: def sentence_map(sentence_list, char_to_id, max_length): sentence_list.sort(key=lambda c:len(c), reverse=True) sentence_map_list = [] for sentence in sentence_list: sentence_id_list = [char_to_id[c] for c in sentence] padding_list = [0] * (max_length-len(sentence)) sentence_id_list.extend(padding_list) sentence_map_list.append(sentence_id_list) return torch.tensor(sentence_map_list, dtype=torch.long) char_to_id = {\"<PAD>\":0} SENTENCE_LENGTH = 20 for sentence in sentence_list: for _char in sentence: if _char not in char_to_id: char_to_id[_char] = len(char_to_id) sentences_sequence = sentence_map(sentence_list, char_to_id, SENTENCE_LENGTH) if __name__ == '__main__': accuracy, recall, f1_score, acc_entities_length, predict_entities_length, true_entities_length = evaluate(sentences_sequence.tolist(), tag_list, predict_tag_list, id2char, id2tag) print(\"accuracy:\", accuracy, \"\\nrecall:\", recall, \"\\nf1_score:\", f1_score, \"\\nacc_entities_length:\", acc_entities_length, \"\\npredict_entities_length:\", predict_entities_length, \"\\ntrue_entities_length:\", true_entities_length) \u8f93\u51fa\u6548\u679c: step_acc: 0.8823529411764706 step_recall: 0.9375 f1_score: 0.9090909090909091 acc_entities_length: 15 predict_entities_length: 17 true_entities_length: 16 \u7b2c\u4e94\u6b65: \u5b8c\u6210\u8bad\u7ec3\u6a21\u578b\u7684\u4ee3\u7801. # \u5bfc\u5165\u5305 import json import time from tqdm import tqdm import matplotlib.pyplot as plt import torch import torch.optim as optim from torch.autograd import Variable # \u5bfc\u5165\u4e4b\u524d\u7f16\u5199\u597d\u7684\u5305, \u5305\u62ec\u7c7b, \u6570\u636e\u96c6\u52a0\u8f7d, \u8bc4\u4f30\u51fd\u6570 from bilstm_crf import BiLSTM_CRF from loader_data import load_dataset from evaluate_model import evaluate # \u8bad\u7ec3\u6a21\u578b\u7684\u51fd\u6570 def train(data_loader, data_size, batch_size, embedding_dim, hidden_dim, sentence_length, num_layers, epochs, learning_rate, tag2id, model_saved_path, train_log_path, validate_log_path, train_history_image_path): ''' data_loader: \u6570\u636e\u96c6\u7684\u52a0\u8f7d\u5668, \u4e4b\u524d\u5df2\u7ecf\u901a\u8fc7load_dataset\u5b8c\u6210\u4e86\u6784\u9020 data_size: \u8bad\u7ec3\u96c6\u548c\u6d4b\u8bd5\u96c6\u7684\u6837\u672c\u6570\u91cf batch_size: \u6279\u6b21\u7684\u6837\u672c\u4e2a\u6570 embedding_dim: \u8bcd\u5d4c\u5165\u7684\u7ef4\u5ea6 hidden_dim: \u9690\u85cf\u5c42\u7684\u7ef4\u5ea6 sentence_length: \u6587\u672c\u9650\u5236\u7684\u957f\u5ea6 num_layers: \u795e\u7ecf\u7f51\u7edc\u5806\u53e0\u7684LSTM\u5c42\u6570 epochs: \u8bad\u7ec3\u8fed\u4ee3\u7684\u8f6e\u6b21 learning_rate: \u5b66\u4e60\u7387 tag2id: \u6807\u7b7e\u5230id\u7684\u6620\u5c04\u5b57\u5178 model_saved_path: \u6a21\u578b\u4fdd\u5b58\u7684\u8def\u5f84 train_log_path: \u8bad\u7ec3\u65e5\u5fd7\u4fdd\u5b58\u7684\u8def\u5f84 validate_log_path: \u6d4b\u8bd5\u96c6\u65e5\u5fd7\u4fdd\u5b58\u7684\u8def\u5f84 train_history_image_path: \u8bad\u7ec3\u6570\u636e\u7684\u76f8\u5173\u56fe\u7247\u4fdd\u5b58\u8def\u5f84 ''' # \u5c06\u4e2d\u6587\u5b57\u7b26\u548cid\u7684\u5bf9\u5e94\u7801\u8868\u52a0\u8f7d\u8fdb\u5185\u5b58 char2id = json.load(open(\"./data/char_to_id.json\", mode=\"r\", encoding=\"utf-8\")) # \u521d\u59cb\u5316BiLSTM_CRF\u6a21\u578b model = BiLSTM_CRF(vocab_size=len(char2id), tag_to_ix=tag2id, embedding_dim=embedding_dim, hidden_dim=hidden_dim, batch_size=batch_size, num_layers=num_layers, sequence_length=sentence_length) # \u5b9a\u4e49\u4f18\u5316\u5668, \u4f7f\u7528SGD\u4f5c\u4e3a\u4f18\u5316\u5668(pytorch\u4e2dEmbedding\u652f\u6301\u7684GPU\u52a0\u901f\u4e3aSGD, SparseAdam\uff09 # \u53c2\u6570\u8bf4\u660e\u5982\u4e0b: # lr: \u4f18\u5316\u5668\u5b66\u4e60\u7387 # momentum: \u4f18\u5316\u4e0b\u964d\u7684\u52a8\u91cf\u56e0\u5b50, \u52a0\u901f\u68af\u5ea6\u4e0b\u964d\u8fc7\u7a0b optimizer = optim.SGD(params=model.parameters(), lr=learning_rate, momentum=0.85) # \u8bbe\u5b9a\u4f18\u5316\u5668\u5b66\u4e60\u7387\u66f4\u65b0\u7b56\u7565 # \u53c2\u6570\u8bf4\u660e\u5982\u4e0b: # optimizer: \u4f18\u5316\u5668 # step_size: \u66f4\u65b0\u9891\u7387, \u6bcf\u8fc7\u591a\u5c11\u4e2aepoch\u66f4\u65b0\u4e00\u6b21\u4f18\u5316\u5668\u5b66\u4e60\u7387 # gamma: \u5b66\u4e60\u7387\u8870\u51cf\u5e45\u5ea6, # \u6309\u7167\u4ec0\u4e48\u6bd4\u4f8b\u8c03\u6574(\u8870\u51cf)\u5b66\u4e60\u7387(\u76f8\u5bf9\u4e8e\u4e0a\u4e00\u8f6eepoch), \u9ed8\u8ba40.1 # \u4f8b\u5982: # \u521d\u59cb\u5b66\u4e60\u7387 lr = 0.5, step_size = 20, gamma = 0.1 # lr = 0.5 if epoch < 20 # lr = 0.05 if 20 <= epoch < 40 # lr = 0.005 if 40 <= epoch < 60 scheduler = optim.lr_scheduler.StepLR(optimizer=optimizer, step_size=5, gamma=0.2) # \u521d\u59cb\u5316\u5b58\u653e\u8bad\u7ec3\u4e2d\u635f\u5931, \u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u7b49\u6570\u503c\u6307\u6807 train_loss_list = [] train_acc_list = [] train_recall_list = [] train_f1_list = [] train_log_file = open(train_log_path, mode=\"w\", encoding=\"utf-8\") # \u521d\u59cb\u5316\u5b58\u653e\u6d4b\u8bd5\u4e2d\u635f\u5931, \u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u7b49\u6570\u503c\u6307\u6807 validate_loss_list = [] validate_acc_list = [] validate_recall_list = [] validate_f1_list = [] validate_log_file = open(validate_log_path, mode=\"w\", encoding=\"utf-8\") # \u5229\u7528tag2id\u751f\u6210id\u5230tag\u7684\u6620\u5c04\u5b57\u5178 id2tag = {v:k for k, v in tag2id.items()} # \u5229\u7528char2id\u751f\u6210id\u5230\u5b57\u7b26\u7684\u6620\u5c04\u5b57\u5178 id2char = {v:k for k, v in char2id.items()} # \u6309\u7167\u53c2\u6570epochs\u7684\u8bbe\u5b9a\u6765\u5faa\u73afepochs\u6b21 for epoch in range(epochs): # \u5728\u8fdb\u5ea6\u6761\u6253\u5370\u524d, \u5148\u8f93\u51fa\u5f53\u524d\u6240\u6267\u884c\u6279\u6b21 tqdm.write(\"Epoch {}/{}\".format(epoch + 1, epochs)) # \u5b9a\u4e49\u8981\u8bb0\u5f55\u7684\u6b63\u786e\u603b\u5b9e\u4f53\u6570, \u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length, \\ total_predict_entities_length, \\ total_gold_entities_length = 0, 0, 0 # \u5b9a\u4e49\u6bcfbatch\u6b65\u6570, \u6279\u6b21loss\u603b\u503c, \u51c6\u786e\u5ea6, f1\u503c step, total_loss, correct, f1 = 1, 0.0, 0, 0 # \u5f00\u542f\u5f53\u524depochs\u7684\u8bad\u7ec3\u90e8\u5206 for inputs, labels in tqdm(data_loader[\"train\"]): # \u5c06\u6570\u636e\u4ee5Variable\u8fdb\u884c\u5c01\u88c5 inputs, labels = Variable(inputs), Variable(labels) # \u5728\u8bad\u7ec3\u6a21\u578b\u671f\u95f4, \u8981\u5728\u6bcf\u4e2a\u6837\u672c\u8ba1\u7b97\u68af\u5ea6\u524d\u5c06\u4f18\u5316\u5668\u5f52\u96f6, \u4e0d\u7136\u68af\u5ea6\u4f1a\u88ab\u7d2f\u52a0 optimizer.zero_grad() # \u6b64\u5904\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684neg_log_likelihood()\u51fd\u6570 loss = model.neg_log_likelihood(inputs, labels) # \u83b7\u53d6\u5f53\u524d\u6b65\u7684loss, \u7531tensor\u8f6c\u4e3a\u6570\u5b57 step_loss = loss.data # \u7d2f\u8ba1\u6bcf\u6b65\u635f\u5931\u503c total_loss += step_loss # \u83b7\u53d6\u89e3\u7801\u6700\u4f73\u8def\u5f84\u5217\u8868, \u6b64\u65f6\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684forward()\u51fd\u6570 best_path_list = model(inputs) # \u6a21\u578b\u8bc4\u4f30\u6307\u6807\u503c\u83b7\u53d6\u5305\u62ec:\u5f53\u524d\u6279\u6b21\u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u503c\u4ee5\u53ca\u5bf9\u5e94\u7684\u5b9e\u4f53\u4e2a\u6570 step_acc, step_recall, f1_score, acc_entities_length, \\ predict_entities_length, gold_entities_length = evaluate(inputs.tolist(), labels.tolist(), best_path_list, id2char, id2tag) # \u8bad\u7ec3\u65e5\u5fd7\u5185\u5bb9 log_text = \"Epoch: %s | Step: %s \" \\ \"| loss: %.5f \" \\ \"| acc: %.5f \" \\ \"| recall: %.5f \" \\ \"| f1 score: %.5f\" % \\ (epoch, step, step_loss, step_acc, step_recall,f1_score) # \u5206\u522b\u7d2f\u8ba1\u6b63\u786e\u603b\u5b9e\u4f53\u6570\u3001\u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length += acc_entities_length total_predict_entities_length += predict_entities_length total_gold_entities_length += gold_entities_length # \u5bf9\u635f\u5931\u51fd\u6570\u8fdb\u884c\u53cd\u5411\u4f20\u64ad loss.backward() # \u901a\u8fc7optimizer.step()\u8ba1\u7b97\u635f\u5931, \u68af\u5ea6\u548c\u66f4\u65b0\u53c2\u6570 optimizer.step() # \u8bb0\u5f55\u8bad\u7ec3\u65e5\u5fd7 train_log_file.write(log_text + \"\\n\") step += 1 # \u83b7\u53d6\u5f53\u524depochs\u5e73\u5747\u635f\u5931\u503c(\u6bcf\u4e00\u8f6e\u8fed\u4ee3\u7684\u635f\u5931\u603b\u503c\u9664\u4ee5\u603b\u6570\u636e\u91cf) epoch_loss = total_loss / data_size[\"train\"] # \u8ba1\u7b97\u5f53\u524depochs\u51c6\u786e\u7387 total_acc = total_acc_entities_length / total_predict_entities_length # \u8ba1\u7b97\u5f53\u524depochs\u53ec\u56de\u7387 total_recall = total_acc_entities_length / total_gold_entities_length # \u8ba1\u7b97\u5f53\u524depochs\u7684F1\u503c total_f1 = 0 if total_acc + total_recall != 0: total_f1 = 2 * total_acc * total_recall / (total_acc + total_recall) log_text = \"Epoch: %s \" \\ \"| mean loss: %.5f \" \\ \"| total acc: %.5f \" \\ \"| total recall: %.5f \" \\ \"| total f1 scroe: %.5f\" % (epoch, epoch_loss, total_acc, total_recall, total_f1) # \u5f53\u524depochs\u8bad\u7ec3\u540e\u66f4\u65b0\u5b66\u4e60\u7387, \u5fc5\u987b\u5728\u4f18\u5316\u5668\u66f4\u65b0\u4e4b\u540e scheduler.step() # \u8bb0\u5f55\u5f53\u524depochs\u8bad\u7ec3loss\u503c(\u7528\u4e8e\u56fe\u8868\u5c55\u793a), \u51c6\u786e\u7387, \u53ec\u56de\u7387, f1\u503c train_loss_list.append(epoch_loss) train_acc_list.append(total_acc) train_recall_list.append(total_recall) train_f1_list.append(total_f1) train_log_file.write(log_text + \"\\n\") # \u5b9a\u4e49\u8981\u8bb0\u5f55\u7684\u6b63\u786e\u603b\u5b9e\u4f53\u6570, \u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length, \\ total_predict_entities_length, \\ total_gold_entities_length = 0, 0, 0 # \u5b9a\u4e49\u6bcfbatch\u6b65\u6570, \u6279\u6b21loss\u603b\u503c, \u51c6\u786e\u5ea6, f1\u503c step, total_loss, correct, f1 = 1, 0.0, 0, 0 # \u5f00\u542f\u5f53\u524depochs\u7684\u9a8c\u8bc1\u90e8\u5206 for inputs, labels in tqdm(data_loader[\"validation\"]): # \u5c06\u6570\u636e\u4ee5Variable\u8fdb\u884c\u5c01\u88c5 inputs, labels = Variable(inputs), Variable(labels) # \u6b64\u5904\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684neg_log_likelihood \u51fd\u6570 # \u8fd4\u56de\u6700\u7ec8\u7684CRF\u7684\u5bf9\u6570\u4f3c\u7136\u7ed3\u679c loss = model.neg_log_likelihood(inputs, labels) # \u83b7\u53d6\u5f53\u524d\u6b65\u7684loss\u503c, \u7531tensor\u8f6c\u4e3a\u6570\u5b57 step_loss = loss.data # \u7d2f\u8ba1\u6bcf\u6b65\u635f\u5931\u503c total_loss += step_loss # \u83b7\u53d6\u89e3\u7801\u6700\u4f73\u8def\u5f84\u5217\u8868, \u6b64\u65f6\u8c03\u7528\u7684\u662fBiLSTM_CRF\u7c7b\u4e2d\u7684forward()\u51fd\u6570 best_path_list = model(inputs) # \u6a21\u578b\u8bc4\u4f30\u6307\u6807\u503c\u83b7\u53d6: \u5f53\u524d\u6279\u6b21\u51c6\u786e\u7387, \u53ec\u56de\u7387, F1\u503c\u4ee5\u53ca\u5bf9\u5e94\u7684\u5b9e\u4f53\u4e2a\u6570 step_acc, step_recall, f1_score, acc_entities_length, \\ predict_entities_length, gold_entities_length = evaluate(inputs.tolist(), labels.tolist(), best_path_list, id_to_char, id_to_tag) # \u8bad\u7ec3\u65e5\u5fd7\u5185\u5bb9 log_text = \"Epoch: %s | Step: %s \" \\ \"| loss: %.5f \" \\ \"| acc: %.5f \" \\ \"| recall: %.5f \" \\ \"| f1 score: %.5f\" % \\ (epoch, step, step_loss, step_acc, step_recall,f1_score) # \u5206\u522b\u7d2f\u8ba1\u6b63\u786e\u603b\u5b9e\u4f53\u6570\u3001\u8bc6\u522b\u5b9e\u4f53\u6570\u4ee5\u53ca\u771f\u5b9e\u5b9e\u4f53\u6570 total_acc_entities_length += acc_entities_length total_predict_entities_length += predict_entities_length total_gold_entities_length += gold_entities_length # \u8bb0\u5f55\u9a8c\u8bc1\u96c6\u635f\u5931\u65e5\u5fd7 validate_log_file.write(log_text + \"\\n\") step += 1 # \u83b7\u53d6\u5f53\u524d\u6279\u6b21\u5e73\u5747\u635f\u5931\u503c(\u6bcf\u4e00\u6279\u6b21\u635f\u5931\u603b\u503c\u9664\u4ee5\u6570\u636e\u91cf) epoch_loss = total_loss / data_size[\"validation\"] # \u8ba1\u7b97\u603b\u6279\u6b21\u51c6\u786e\u7387 total_acc = total_acc_entities_length / total_predict_entities_length # \u8ba1\u7b97\u603b\u6279\u6b21\u53ec\u56de\u7387 total_recall = total_acc_entities_length / total_gold_entities_length # \u8ba1\u7b97\u603b\u6279\u6b21F1\u503c total_f1 = 0 if total_acc + total_recall != 0: total_f1 = 2 * total_acc * total_recall / (total_acc + total_recall) log_text = \"Epoch: %s \" \\ \"| mean loss: %.5f \" \\ \"| total acc: %.5f \" \\ \"| total recall: %.5f \" \\ \"| total f1 scroe: %.5f\" % (epoch, epoch_loss, total_acc, total_recall, total_f1) # \u8bb0\u5f55\u5f53\u524d\u6279\u6b21\u9a8c\u8bc1loss\u503c(\u7528\u4e8e\u56fe\u8868\u5c55\u793a)\u51c6\u786e\u7387, \u53ec\u56de\u7387, f1\u503c validate_loss_list.append(epoch_loss) validate_acc_list.append(total_acc) validate_recall_list.append(total_recall) validate_f1_list.append(total_f1) validate_log_file.write(log_text + \"\\n\") # \u4fdd\u5b58\u6a21\u578b torch.save(model.state_dict(), model_saved_path) # \u5c06loss\u4e0b\u964d\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_loss_list, validate_loss_list, train_history_image_path, \"Loss\") # \u5c06\u51c6\u786e\u7387\u63d0\u5347\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_acc_list, validate_acc_list, train_history_image_path, \"Acc\") # \u5c06\u53ec\u56de\u7387\u63d0\u5347\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_recall_list, validate_recall_list, train_history_image_path, \"Recall\") # \u5c06F1\u4e0a\u5347\u5386\u53f2\u6570\u636e\u8f6c\u4e3a\u56fe\u7247\u5b58\u50a8 save_train_history_image(train_f1_list, validate_f1_list, train_history_image_path, \"F1\") print(\"train Finished\".center(100, \"-\")) # \u6309\u7167\u4f20\u5165\u7684\u4e0d\u540c\u8def\u5f84, \u7ed8\u5236\u4e0d\u540c\u7684\u8bad\u7ec3\u66f2\u7ebf def save_train_history_image(train_history_list, validate_history_list, history_image_path, data_type): # \u6839\u636e\u8bad\u7ec3\u96c6\u7684\u6570\u636e\u5217\u8868, \u7ed8\u5236\u6298\u7ebf\u56fe plt.plot(train_history_list, label=\"Train %s History\" % (data_type)) # \u6839\u636e\u6d4b\u8bd5\u96c6\u7684\u6570\u636e\u5217\u8868, \u7ed8\u5236\u6298\u7ebf\u56fe plt.plot(validate_history_list, label=\"Validate %s History\" % (data_type)) # \u5c06\u56fe\u7247\u653e\u7f6e\u5728\u6700\u4f18\u4f4d\u7f6e plt.legend(loc=\"best\") # \u8bbe\u7f6ex\u8f74\u7684\u56fe\u6807\u4e3a\u8f6e\u6b21Epochs plt.xlabel(\"Epochs\") # \u8bbe\u7f6ey\u8f74\u7684\u56fe\u6807\u4e3a\u53c2\u6570data_type plt.ylabel(data_type) # \u5c06\u7ed8\u5236\u597d\u7684\u56fe\u7247\u4fdd\u5b58\u5728\u7279\u5b9a\u7684\u8def\u5f84\u4e0b\u9762, \u5e76\u4fee\u6539\u56fe\u7247\u540d\u5b57\u4e2d\u7684\"plot\"\u4e3a\u5bf9\u5e94\u7684data_type plt.savefig(history_image_path.replace(\"plot\", data_type)) plt.close() \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/train.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65702:\u8bad\u7ec3\u6570\u636e\u6587\u4ef6\u8def\u5f84 train_data_file_path = \"data/train.npz\" # \u53c2\u65703:\u52a0\u8f7d DataLoader \u6570\u636e data_loader, data_size = load_dataset(train_data_file_path, BATCH_SIZE) # \u53c2\u65704:\u8bb0\u5f55\u5f53\u524d\u8bad\u7ec3\u65f6\u95f4\uff08\u62fc\u6210\u5b57\u7b26\u4e32\u7528\uff09 time_str = time.strftime(\"%Y%m%d_%H%M%S\", time.localtime(time.time())) # \u53c2\u65705:\u6807\u7b7e\u7801\u8868\u5bf9\u7167 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65706:\u8bad\u7ec3\u6587\u4ef6\u5b58\u653e\u8def\u5f84 model_saved_path = \"model/bilstm_crf_state_dict_%s.pt\" % (time_str) # \u53c2\u65707:\u8bad\u7ec3\u65e5\u5fd7\u6587\u4ef6\u5b58\u653e\u8def\u5f84 train_log_path = \"log/train_%s.log\" % (time_str) # \u53c2\u65708:\u9a8c\u8bc1\u6253\u5370\u65e5\u5fd7\u5b58\u653e\u8def\u5f84 validate_log_path = \"log/validate_%s.log\" % (time_str) # \u53c2\u65709:\u8bad\u7ec3\u5386\u53f2\u8bb0\u5f55\u56fe\u5b58\u653e\u8def\u5f84 train_history_image_path = \"log/bilstm_crf_train_plot_%s.png\" % (time_str) # \u53c2\u657010:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u657011:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u657012:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u657013:\u5806\u53e0 LSTM \u5c42\u6570 NUM_LAYERS = 1 # \u53c2\u657014:\u8bad\u7ec3\u6279\u6b21 EPOCHS = 100 # \u53c2\u657015:\u521d\u59cb\u5316\u5b66\u4e60\u7387 LEARNING_RATE = 0.5 \u8c03\u7528: if __name__ == '__main__': train(data_loader, data_size, BATCH_SIZE, EMBEDDING_DIM, HIDDEN_DIM, SENTENCE_LENGTH, NUM_LAYERS, EPOCHS, LEARNING_RATE, tag_to_id, model_saved_path, train_log_path, validate_log_path, train_history_image_path) \u8f93\u51fa\u6548\u679c: \u6a21\u578b\u8bad\u7ec3\u7ed3\u679c\u6587\u4ef6\u4fdd\u5b58\u4f4d\u7f6e:model/bilstm_crf_state_dict_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].pt \u6a21\u578b\u8bad\u7ec3\u65e5\u5fd7\u6587\u4ef6\u4fdd\u5b58\u4f4d\u7f6e:log/train_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].log \u6a21\u578b\u9a8c\u8bc1\u65e5\u5fd7\u6587\u4ef6\u4fdd\u5b58\u4f4d\u7f6e:log/validate_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].log \u6a21\u578b\u8bad\u7ec3\u635f\u5931\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_Loss_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u6a21\u578b\u8bad\u7ec3\u51c6\u786e\u7387\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_Acc_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u6a21\u578b\u8bad\u7ec3\u53ec\u56de\u7387\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_Recall_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u6a21\u578b\u8bad\u7ec3F1\u503c\u5386\u53f2\u8bb0\u5f55\u56fe\u7247\u4fdd\u5b58\u4f4d\u7f6e:log/bilstm_crf_train_F1_[\u5e74\u6708\u65e5\u65f6\u5206\u79d2\u65f6\u95f4\u5b57\u7b26\u4e32].png \u8bad\u7ec3\u65e5\u5fd7: Epoch: 0 | train loss: 366.58832 |acc: 0.632 |recall: 0.503 |f1 score: 0.56 | validate loss: 666.032 |acc: 0.591 |recall: 0.457 |f1 score: 0.515 Epoch: 1 | train loss: 123.87159 |acc: 0.743 |recall: 0.687 |f1 score: 0.714 | validate loss: 185.021 |acc: 0.669 |recall: 0.606 |f1 score: 0.636 Epoch: 2 | train loss: 113.04003 |acc: 0.738 |recall: 0.706 |f1 score: 0.722 | validate loss: 107.393 |acc: 0.711 |recall: 0.663 |f1 score: 0.686 Epoch: 3 | train loss: 119.14317 |acc: 0.751 |recall: 0.692 |f1 score: 0.721 | validate loss: 158.381 |acc: 0.713 |recall: 0.64 |f1 score: 0.674 Epoch: 4 | train loss: 105.81506 |acc: 0.741 |recall: 0.699 |f1 score: 0.72 | validate loss: 118.99 |acc: 0.669 |recall: 0.624 |f1 score: 0.646 Epoch: 5 | train loss: 86.67545 |acc: 0.773 |recall: 0.751 |f1 score: 0.762 | validate loss: 123.636 |acc: 0.64 |recall: 0.718 |f1 score: 0.676 Epoch: 6 | train loss: 79.66924 |acc: 0.808 |recall: 0.772 |f1 score: 0.789 | validate loss: 89.771 |acc: 0.735 |recall: 0.714 |f1 score: 0.724 Epoch: 7 | train loss: 85.35771 |acc: 0.766 |recall: 0.752 |f1 score: 0.759 | validate loss: 141.233 |acc: 0.675 |recall: 0.7 |f1 score: 0.687 Epoch: 8 | train loss: 82.38535 |acc: 0.787 |recall: 0.748 |f1 score: 0.767 | validate loss: 108.429 |acc: 0.717 |recall: 0.673 |f1 score: 0.694 Epoch: 9 | train loss: 82.46296 |acc: 0.783 |recall: 0.751 |f1 score: 0.767 | validate loss: 74.716 |acc: 0.692 |recall: 0.702 |f1 score: 0.697 Epoch: 10 | train loss: 75.12292 |acc: 0.814 |recall: 0.779 |f1 score: 0.796 | validate loss: 90.693 |acc: 0.672 |recall: 0.7 |f1 score: 0.686 Epoch: 11 | train loss: 74.89426 |acc: 0.813 |recall: 0.77 |f1 score: 0.791 | validate loss: 77.161 |acc: 0.729 |recall: 0.718 |f1 score: 0.724 Epoch: 12 | train loss: 76.39055 |acc: 0.814 |recall: 0.785 |f1 score: 0.799 | validate loss: 132.545 |acc: 0.806 |recall: 0.685 |f1 score: 0.74 Epoch: 13 | train loss: 75.01093 |acc: 0.814 |recall: 0.787 |f1 score: 0.8 | validate loss: 101.596 |acc: 0.765 |recall: 0.681 |f1 score: 0.721 Epoch: 14 | train loss: 74.35796 |acc: 0.83 |recall: 0.802 |f1 score: 0.816 | validate loss: 92.535 |acc: 0.745 |recall: 0.777 |f1 score: 0.761 Epoch: 15 | train loss: 73.27102 |acc: 0.818 |recall: 0.791 |f1 score: 0.804 | validate loss: 109.51 |acc: 0.68 |recall: 0.76 |f1 score: 0.717 Epoch: 16 | train loss: 67.66725 |acc: 0.841 |recall: 0.811 |f1 score: 0.826 | validate loss: 93.047 |acc: 0.768 |recall: 0.738 |f1 score: 0.753 Epoch: 17 | train loss: 63.75809 |acc: 0.83 |recall: 0.813 |f1 score: 0.822 | validate loss: 76.231 |acc: 0.784 |recall: 0.776 |f1 score: 0.78 Epoch: 18 | train loss: 60.30417 |acc: 0.845 |recall: 0.829 |f1 score: 0.837 | validate loss: 76.019 |acc: 0.806 |recall: 0.758 |f1 score: 0.781 Epoch: 19 | train loss: 60.30238 |acc: 0.849 |recall: 0.823 |f1 score: 0.836 | validate loss: 90.269 |acc: 0.748 |recall: 0.733 |f1 score: 0.741 Epoch: 20 | train loss: 60.20072 |acc: 0.847 |recall: 0.82 |f1 score: 0.833 | validate loss: 61.756 |acc: 0.81 |recall: 0.77 |f1 score: 0.79 Epoch: 21 | train loss: 58.98606 |acc: 0.844 |recall: 0.82 |f1 score: 0.832 | validate loss: 60.799 |acc: 0.765 |recall: 0.754 |f1 score: 0.759 Epoch: 22 | train loss: 60.23671 |acc: 0.848 |recall: 0.828 |f1 score: 0.838 | validate loss: 65.676 |acc: 0.787 |recall: 0.781 |f1 score: 0.784 Epoch: 23 | train loss: 58.57862 |acc: 0.849 |recall: 0.827 |f1 score: 0.838 | validate loss: 65.975 |acc: 0.794 |recall: 0.754 |f1 score: 0.774 Epoch: 24 | train loss: 58.93968 |acc: 0.848 |recall: 0.827 |f1 score: 0.838 | validate loss: 66.994 |acc: 0.784 |recall: 0.746 |f1 score: 0.764 Epoch: 25 | train loss: 59.91834 |acc: 0.862 |recall: 0.828 |f1 score: 0.845 | validate loss: 68.794 |acc: 0.795 |recall: 0.756 |f1 score: 0.775 Epoch: 26 | train loss: 59.09166 |acc: 0.84 |recall: 0.823 |f1 score: 0.831 | validate loss: 68.508 |acc: 0.746 |recall: 0.758 |f1 score: 0.752 Epoch: 27 | train loss: 58.0584 |acc: 0.856 |recall: 0.84 |f1 score: 0.848 | validate loss: 53.158 |acc: 0.802 |recall: 0.774 |f1 score: 0.788 Epoch: 28 | train loss: 54.2857 |acc: 0.858 |recall: 0.834 |f1 score: 0.845 | validate loss: 60.243 |acc: 0.816 |recall: 0.772 |f1 score: 0.793 Epoch: 29 | train loss: 56.44759 |acc: 0.845 |recall: 0.838 |f1 score: 0.841 | validate loss: 56.497 |acc: 0.768 |recall: 0.77 |f1 score: 0.769 Epoch: 30 | train loss: 57.90492 |acc: 0.868 |recall: 0.832 |f1 score: 0.85 | validate loss: 75.158 |acc: 0.773 |recall: 0.762 |f1 score: 0.768 Epoch: 31 | train loss: 56.81468 |acc: 0.861 |recall: 0.835 |f1 score: 0.847 | validate loss: 56.742 |acc: 0.796 |recall: 0.784 |f1 score: 0.79 Epoch: 32 | train loss: 54.72623 |acc: 0.86 |recall: 0.844 |f1 score: 0.852 | validate loss: 63.175 |acc: 0.757 |recall: 0.78 |f1 score: 0.768 Epoch: 33 | train loss: 60.10299 |acc: 0.846 |recall: 0.813 |f1 score: 0.829 | validate loss: 68.994 |acc: 0.768 |recall: 0.724 |f1 score: 0.745 Epoch: 34 | train loss: 59.67491 |acc: 0.849 |recall: 0.826 |f1 score: 0.837 | validate loss: 58.662 |acc: 0.8 |recall: 0.739 |f1 score: 0.769 Epoch: 35 | train loss: 65.01099 |acc: 0.857 |recall: 0.83 |f1 score: 0.844 | validate loss: 69.299 |acc: 0.772 |recall: 0.752 |f1 score: 0.762 Epoch: 36 | train loss: 61.52783 |acc: 0.856 |recall: 0.828 |f1 score: 0.842 | validate loss: 82.373 |acc: 0.761 |recall: 0.777 |f1 score: 0.769 Epoch: 37 | train loss: 66.19576 |acc: 0.844 |recall: 0.822 |f1 score: 0.833 | validate loss: 79.853 |acc: 0.791 |recall: 0.77 |f1 score: 0.781 Epoch: 38 | train loss: 60.32529 |acc: 0.841 |recall: 0.828 |f1 score: 0.835 | validate loss: 69.346 |acc: 0.773 |recall: 0.755 |f1 score: 0.764 Epoch: 39 | train loss: 63.8836 |acc: 0.837 |recall: 0.819 |f1 score: 0.828 | validate loss: 74.759 |acc: 0.732 |recall: 0.759 |f1 score: 0.745 Epoch: 40 | train loss: 67.28363 |acc: 0.838 |recall: 0.824 |f1 score: 0.831 | validate loss: 63.027 |acc: 0.768 |recall: 0.764 |f1 score: 0.766 Epoch: 41 | train loss: 61.40488 |acc: 0.852 |recall: 0.826 |f1 score: 0.839 | validate loss: 58.976 |acc: 0.802 |recall: 0.755 |f1 score: 0.778 Epoch: 42 | train loss: 61.04982 |acc: 0.856 |recall: 0.817 |f1 score: 0.836 | validate loss: 58.47 |acc: 0.783 |recall: 0.74 |f1 score: 0.761 Epoch: 43 | train loss: 64.40567 |acc: 0.849 |recall: 0.821 |f1 score: 0.835 | validate loss: 63.506 |acc: 0.764 |recall: 0.765 |f1 score: 0.765 Epoch: 44 | train loss: 65.09746 |acc: 0.845 |recall: 0.805 |f1 score: 0.825 | validate loss: 65.535 |acc: 0.773 |recall: 0.743 |f1 score: 0.758 Epoch: 45 | train loss: 63.26585 |acc: 0.848 |recall: 0.808 |f1 score: 0.827 | validate loss: 62.477 |acc: 0.789 |recall: 0.733 |f1 score: 0.76 Epoch: 46 | train loss: 63.91504 |acc: 0.847 |recall: 0.812 |f1 score: 0.829 | validate loss: 59.916 |acc: 0.779 |recall: 0.751 |f1 score: 0.765 Epoch: 47 | train loss: 62.3592 |acc: 0.845 |recall: 0.824 |f1 score: 0.835 | validate loss: 63.363 |acc: 0.775 |recall: 0.761 |f1 score: 0.768 Epoch: 48 | train loss: 63.13221 |acc: 0.843 |recall: 0.823 |f1 score: 0.833 | validate loss: 65.71 |acc: 0.767 |recall: 0.755 |f1 score: 0.761 Epoch: 49 | train loss: 64.9964 |acc: 0.845 |recall: 0.811 |f1 score: 0.828 | validate loss: 65.174 |acc: 0.768 |recall: 0.74 |f1 score: 0.754 Epoch: 50 | train loss: 62.40605 |acc: 0.847 |recall: 0.817 |f1 score: 0.832 | validate loss: 60.761 |acc: 0.776 |recall: 0.746 |f1 score: 0.761 Epoch: 51 | train loss: 63.05476 |acc: 0.845 |recall: 0.812 |f1 score: 0.828 | validate loss: 64.217 |acc: 0.764 |recall: 0.748 |f1 score: 0.756 Epoch: 52 | train loss: 59.77727 |acc: 0.84 |recall: 0.831 |f1 score: 0.836 | validate loss: 60.48 |acc: 0.79 |recall: 0.759 |f1 score: 0.774 Epoch: 53 | train loss: 62.7249 |acc: 0.828 |recall: 0.813 |f1 score: 0.821 | validate loss: 64.584 |acc: 0.757 |recall: 0.757 |f1 score: 0.757 Epoch: 54 | train loss: 61.1763 |acc: 0.842 |recall: 0.832 |f1 score: 0.837 | validate loss: 61.088 |acc: 0.775 |recall: 0.768 |f1 score: 0.771 Epoch: 55 | train loss: 64.04366 |acc: 0.835 |recall: 0.816 |f1 score: 0.826 | validate loss: 68.183 |acc: 0.784 |recall: 0.742 |f1 score: 0.762 Epoch: 56 | train loss: 66.76939 |acc: 0.84 |recall: 0.813 |f1 score: 0.827 | validate loss: 67.284 |acc: 0.77 |recall: 0.748 |f1 score: 0.759 Epoch: 57 | train loss: 67.85329 |acc: 0.826 |recall: 0.789 |f1 score: 0.807 | validate loss: 69.961 |acc: 0.766 |recall: 0.732 |f1 score: 0.749 Epoch: 58 | train loss: 64.79573 |acc: 0.84 |recall: 0.812 |f1 score: 0.826 | validate loss: 73.358 |acc: 0.754 |recall: 0.735 |f1 score: 0.745 Epoch: 59 | train loss: 65.36249 |acc: 0.862 |recall: 0.826 |f1 score: 0.844 | validate loss: 66.552 |acc: 0.783 |recall: 0.766 |f1 score: 0.774 Epoch: 60 | train loss: 63.43061 |acc: 0.835 |recall: 0.811 |f1 score: 0.823 | validate loss: 63.138 |acc: 0.771 |recall: 0.746 |f1 score: 0.759 Epoch: 61 | train loss: 62.34639 |acc: 0.848 |recall: 0.825 |f1 score: 0.836 | validate loss: 59.656 |acc: 0.783 |recall: 0.756 |f1 score: 0.769 Epoch: 62 | train loss: 61.83451 |acc: 0.83 |recall: 0.814 |f1 score: 0.822 | validate loss: 60.443 |acc: 0.765 |recall: 0.751 |f1 score: 0.758 Epoch: 63 | train loss: 64.78461 |acc: 0.854 |recall: 0.818 |f1 score: 0.836 | validate loss: 61.125 |acc: 0.786 |recall: 0.748 |f1 score: 0.767 Epoch: 64 | train loss: 63.43409 |acc: 0.838 |recall: 0.818 |f1 score: 0.828 | validate loss: 62.396 |acc: 0.77 |recall: 0.757 |f1 score: 0.764 Epoch: 65 | train loss: 61.20197 |acc: 0.854 |recall: 0.815 |f1 score: 0.834 | validate loss: 59.019 |acc: 0.79 |recall: 0.75 |f1 score: 0.769 Epoch: 66 | train loss: 59.69791 |acc: 0.851 |recall: 0.82 |f1 score: 0.836 | validate loss: 55.06 |acc: 0.789 |recall: 0.754 |f1 score: 0.771 Epoch: 67 | train loss: 63.16074 |acc: 0.836 |recall: 0.811 |f1 score: 0.823 | validate loss: 61.48 |acc: 0.764 |recall: 0.745 |f1 score: 0.755 Epoch: 68 | train loss: 62.15521 |acc: 0.845 |recall: 0.824 |f1 score: 0.835 | validate loss: 62.407 |acc: 0.778 |recall: 0.761 |f1 score: 0.769 Epoch: 69 | train loss: 61.90574 |acc: 0.847 |recall: 0.828 |f1 score: 0.838 | validate loss: 59.801 |acc: 0.781 |recall: 0.762 |f1 score: 0.771 Epoch: 70 | train loss: 60.51348 |acc: 0.852 |recall: 0.827 |f1 score: 0.839 | validate loss: 56.632 |acc: 0.781 |recall: 0.761 |f1 score: 0.771 Epoch: 71 | train loss: 62.78683 |acc: 0.856 |recall: 0.823 |f1 score: 0.84 | validate loss: 62.867 |acc: 0.796 |recall: 0.757 |f1 score: 0.776 Epoch: 72 | train loss: 62.11708 |acc: 0.845 |recall: 0.82 |f1 score: 0.833 | validate loss: 57.211 |acc: 0.784 |recall: 0.754 |f1 score: 0.769 Epoch: 73 | train loss: 63.2298 |acc: 0.839 |recall: 0.816 |f1 score: 0.828 | validate loss: 60.247 |acc: 0.764 |recall: 0.752 |f1 score: 0.758 Epoch: 74 | train loss: 61.87119 |acc: 0.848 |recall: 0.828 |f1 score: 0.838 | validate loss: 59.692 |acc: 0.782 |recall: 0.765 |f1 score: 0.774 Epoch: 75 | train loss: 59.88628 |acc: 0.851 |recall: 0.821 |f1 score: 0.836 | validate loss: 59.461 |acc: 0.78 |recall: 0.755 |f1 score: 0.767 Epoch: 76 | train loss: 61.97182 |acc: 0.858 |recall: 0.812 |f1 score: 0.835 | validate loss: 59.748 |acc: 0.78 |recall: 0.749 |f1 score: 0.765 Epoch: 77 | train loss: 62.2035 |acc: 0.836 |recall: 0.811 |f1 score: 0.823 | validate loss: 56.778 |acc: 0.768 |recall: 0.748 |f1 score: 0.758 Epoch: 78 | train loss: 59.90309 |acc: 0.846 |recall: 0.823 |f1 score: 0.835 | validate loss: 59.424 |acc: 0.771 |recall: 0.76 |f1 score: 0.765 Epoch: 79 | train loss: 62.48097 |acc: 0.844 |recall: 0.821 |f1 score: 0.833 | validate loss: 57.535 |acc: 0.769 |recall: 0.755 |f1 score: 0.762 Epoch: 80 | train loss: 65.83723 |acc: 0.853 |recall: 0.83 |f1 score: 0.842 | validate loss: 60.798 |acc: 0.782 |recall: 0.762 |f1 score: 0.772 Epoch: 81 | train loss: 67.69897 |acc: 0.848 |recall: 0.812 |f1 score: 0.83 | validate loss: 62.135 |acc: 0.78 |recall: 0.746 |f1 score: 0.763 Epoch: 82 | train loss: 64.45554 |acc: 0.863 |recall: 0.845 |f1 score: 0.854 | validate loss: 62.102 |acc: 0.793 |recall: 0.775 |f1 score: 0.784 Epoch: 83 | train loss: 59.9239 |acc: 0.857 |recall: 0.84 |f1 score: 0.848 | validate loss: 57.003 |acc: 0.788 |recall: 0.771 |f1 score: 0.779 Epoch: 84 | train loss: 65.42567 |acc: 0.859 |recall: 0.831 |f1 score: 0.845 | validate loss: 61.993 |acc: 0.788 |recall: 0.763 |f1 score: 0.775 Epoch: 85 | train loss: 62.69893 |acc: 0.852 |recall: 0.828 |f1 score: 0.84 | validate loss: 59.489 |acc: 0.786 |recall: 0.761 |f1 score: 0.773 Epoch: 86 | train loss: 64.58199 |acc: 0.858 |recall: 0.831 |f1 score: 0.845 | validate loss: 60.414 |acc: 0.789 |recall: 0.764 |f1 score: 0.776 Epoch: 87 | train loss: 58.41865 |acc: 0.875 |recall: 0.838 |f1 score: 0.856 | validate loss: 56.525 |acc: 0.805 |recall: 0.768 |f1 score: 0.786 Epoch: 88 | train loss: 61.39529 |acc: 0.848 |recall: 0.824 |f1 score: 0.836 | validate loss: 56.678 |acc: 0.783 |recall: 0.759 |f1 score: 0.771 Epoch: 89 | train loss: 63.69639 |acc: 0.857 |recall: 0.818 |f1 score: 0.837 | validate loss: 59.014 |acc: 0.787 |recall: 0.751 |f1 score: 0.769 Epoch: 90 | train loss: 61.78225 |acc: 0.841 |recall: 0.84 |f1 score: 0.84 | validate loss: 59.58 |acc: 0.773 |recall: 0.775 |f1 score: 0.774 Epoch: 91 | train loss: 58.19114 |acc: 0.845 |recall: 0.826 |f1 score: 0.836 | validate loss: 55.284 |acc: 0.776 |recall: 0.758 |f1 score: 0.767 Epoch: 92 | train loss: 58.67227 |acc: 0.857 |recall: 0.82 |f1 score: 0.838 | validate loss: 54.982 |acc: 0.787 |recall: 0.753 |f1 score: 0.77 Epoch: 93 | train loss: 60.79532 |acc: 0.858 |recall: 0.83 |f1 score: 0.844 | validate loss: 57.808 |acc: 0.792 |recall: 0.764 |f1 score: 0.778 Epoch: 94 | train loss: 56.71145 |acc: 0.872 |recall: 0.851 |f1 score: 0.861 | validate loss: 53.551 |acc: 0.804 |recall: 0.785 |f1 score: 0.795 Epoch: 95 | train loss: 58.791 |acc: 0.864 |recall: 0.83 |f1 score: 0.847 | validate loss: 54.284 |acc: 0.793 |recall: 0.765 |f1 score: 0.779 Epoch: 96 | train loss: 60.07491 |acc: 0.849 |recall: 0.828 |f1 score: 0.839 | validate loss: 55.524 |acc: 0.78 |recall: 0.764 |f1 score: 0.772 Epoch: 97 | train loss: 61.53479 |acc: 0.86 |recall: 0.825 |f1 score: 0.842 | validate loss: 56.891 |acc: 0.796 |recall: 0.759 |f1 score: 0.777 Epoch: 98 | train loss: 61.94878 |acc: 0.85 |recall: 0.836 |f1 score: 0.843 | validate loss: 57.019 |acc: 0.783 |recall: 0.771 |f1 score: 0.777 Epoch: 99 | train loss: 58.49541 |acc: 0.86 |recall: 0.834 |f1 score: 0.847 | validate loss: 56.162 |acc: 0.795 |recall: 0.767 |f1 score: 0.781 \u7b2c\u516d\u6b65: \u7ed8\u5236\u635f\u5931\u66f2\u7ebf\u548c\u8bc4\u4f30\u66f2\u7ebf\u56fe \u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u635f\u5931\u5bf9\u7167\u66f2\u7ebf\u4e00\u76f4\u4e0b\u964d, \u4ece\u7b2c5\u4e2aepoch\u5f00\u59cb, \u8fc5\u901f\u964d\u5230\u6bd4\u8f83\u7406\u60f3\u7684\u4f4d\u7f6e, \u8bf4\u660e\u6a21\u578b\u80fd\u591f\u4ece\u6570\u636e\u4e2d\u83b7\u53d6\u89c4\u5f8b\u4e86, \u5230\u7b2c40\u4e2a\u6279\u6b21\u4e4b\u540e, \u6a21\u578b\u8d8b\u4e8e\u7a33\u5b9a, \u8bf4\u660e\u53c2\u6570\u57fa\u672c\u80fd\u591f\u5df2\u7ecf\u5f97\u5230\u6700\u4f18\u5316\u6548\u679c, \u6b64\u65f6, \u6839\u636e\u5bf9scheduler\u7684\u8bbe\u7f6e, \u901a\u8fc7\u8be5\u65b9\u6cd5\u5df2\u7ecf\u5bf9\u4f18\u5316\u5668\u8fdb\u884c\u4e86\u8fd18\u6b21\u7684\u8fed\u4ee3, \u5e94\u8be5\u5728\u6211\u4eec\u539f\u672c\u8bbe\u7f6e\u7684\u521d\u59cb\u5b66\u4e60\u7387\u57fa\u7840\u4e0a\u7f29\u5c0f\u4e860.2\u76848\u6b21\u65b9\u500d, \u6b64\u65f6\u5e94\u8be5\u627e\u5230\u4e86\u5f53\u524d\u6700\u4f18\u89e3, \u56e0\u6b64\u4e5f\u5c31\u8d8b\u4e8e\u7a33\u5b9a\u4e86. \u8bad\u7ec3\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u9996\u5148\uff0c\u51c6\u786e\u7387\u662f\u6307\u8bc6\u522b \u6b63\u786e\u7684\u5b9e\u4f53 \u5360 \u8bc6\u522b\u51fa\u7684\u5b9e\u4f53 \u4e2d\u7684\u6bd4\u4f8b. \u6839\u636e\u5bf9\u7167\u66f2\u7ebf\u6765\u770b\uff0c\u6574\u4f53\u5b66\u4e60\u7ed3\u679c\u90fd\u5728\u8d8b\u4e8e\u51c6\u786e\u7387\u4e0a\u5347\u65b9\u5411\u589e\u52a0\uff0c\u800c\u4e14\u968f\u7740\u6279\u6b21\u7684\u589e\u52a0\u66f2\u7ebf\u9707\u52a8\u76f8\u5bf9\u5e73\u7a33\uff0c\u4e0d\u8fc7\u53ef\u80fd\u7531\u4e8e\u8bad\u7ec3\u4e0e\u9a8c\u8bc1\u6837\u672c\u5206\u5e03\u4e0d\u5747\u8861\u6216\u8005\u566a\u58f0\u7b49\u539f\u56e0\uff0c\u5bfc\u81f4\u6700\u7ec8\u9a8c\u8bc1\u96c6\u7684\u51c6\u786e\u5ea6\u6ca1\u6709\u8fbe\u5230\u4e0e\u8bad\u7ec3\u96c6\u76f8\u540c\u7684\u60c5\u51b5. \u6700\u7ec8\u7684\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u53ec\u56de\u7387\u5206\u522b\u5728\uff1a0.85\u548c0.78\u5de6\u53f3. \u8bad\u7ec3\u548c\u9a8c\u8bc1\u53ec\u56de\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u5728\u6b64\u53ec\u56de\u7387\u662f\u6307 \u8bc6\u522b\u6b63\u786e\u7684\u5b9e\u4f53 \u5360\u5f53\u524d\u6279\u6b21\u6240\u5305\u542b\u7684 \u6240\u6709\u5b9e\u4f53\u603b\u6570 \u7684\u6bd4\u4f8b. \u5173\u4e8e\u8bad\u7ec3\u548c\u9a8c\u8bc1\u53ec\u56de\u7387\u5bf9\u7167\u66f2\u7ebf\uff0c\u53ef\u4ee5\u770b\u51fa\u53ec\u56de\u7387\u7684\u53d8\u5316\u76f8\u5bf9\u6bd4\u8f83\u5e73\u6ed1\uff0c\u57fa\u672c\u4e0a\u4e5f\u572840\u6b65\u5de6\u53f3\u8d8b\u4e8e\u7a33\u5b9a. \u6700\u7ec8\u7684\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u53ec\u56de\u7387\u5206\u522b\u5728\uff1a0.83\u548c0.75\u5de6\u53f3. \u8bad\u7ec3\u548c\u9a8c\u8bc1F1\u503c\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: F1\u503c\u4e3b\u8981\u662f\u6307\u8bad\u7ec3\u6548\u679c\u800c\u8a00\uff0c\u5728\u4e0d\u591a\u8bc6\u522b\u5b9e\u4f53\u7684\u60c5\u51b5\u4e0b\u540c\u65f6\u63d0\u9ad8\u51c6\u786e\u5ea6\u7684\u8861\u91cf\u6307\u6807. \u5176\u516c\u5f0f\u4e3a\uff1a2\u00d7\u51c6\u786e\u7387\u00d7\u53ec\u56de\u7387 / (\u51c6\u786e\u7387 + \u53ec\u56de\u7387) \u4ece\u66f2\u7ebf\u53ef\u89c1\u6574\u4f53F1\u503c\u4e0a\u5347\u4e0e\u635f\u5931\u3001\u53ec\u56de\u7387\u7684\u66f2\u7ebf\u6bd4\u8f83\u63a5\u8fd1\uff0c\u8bf4\u660e\u5728\u8bc6\u522b\u51fa\u7684\u5b9e\u4f53\u4e2d\uff0c\u6b63\u786e\u7387\u6bd4\u8f83\u95ee\u9898\uff0c\u4e0d\u8fc7\u6839\u636e\u524d\u9762\u7684\u51c6\u786e\u5ea6\u6765\u5206\u6790\uff0c\u53ef\u80fd\u5728\u8bc6\u522b\u8fc7\u7a0b\u4e2d\uff0c\u589e\u52a0\u4e86\u8bc6\u522b\u51fa\u7684\u5b9e\u4f53\u4e2a\u6570\u800c\u5bfc\u81f4\u4e0d\u7a33\u5b9a\u3002\u4ece\u8fd9\u65b9\u9762\u6765\u8bf4\uff0c\u53ef\u4ee5\u9a8c\u8bc1\u6837\u672c\u4e0d\u5747\u8861\u95ee\u9898\u4ee5\u53ca\u566a\u58f0\u5bf9\u6a21\u578b\u7684\u5f71\u54cd\u8fd8\u662f\u6bd4\u8f83\u5927\u7684\u3002 \u4ece\u6574\u4f53\u800c\u8a00\uff0cF1\u503c\u57fa\u672c\u4e5f\u5728\u7b2c40\u6b65\u4e4b\u540e\u8d8b\u4e8e\u7a33\u5b9a\uff0c\u6700\u7ec8\u7684\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u7ed3\u679c\u5728\uff1a0.85\u548c0.75\u5de6\u53f3\u3002 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u6570\u636e\u9884\u5904\u7406\u7684\u76f8\u5173\u65b9\u6cd5 \u539f\u59cb\u6570\u636e\u96c6\u7684\u5b57\u7b26\u7ecf\u8fc7\u6570\u5b57\u5316\u7f16\u7801\u53d8\u6210\u5411\u91cf \u6807\u6ce8\u6570\u636e\u96c6\u7684\u5b57\u7b26\u7ecf\u8fc7\u6570\u5b57\u5316\u7f16\u7801\u53d8\u6210\u5411\u91cf \u5b66\u4e60\u751f\u6210\u6279\u91cf\u8bad\u7ec3\u6570\u636e\u7684\u65b9\u6cd5 \u5b66\u4e60\u4e86\u6a21\u578b\u8bad\u7ec3\u76f8\u5173\u4ee3\u7801\u7684\u5b9e\u73b0 \u51c6\u786e\u7387\u548c\u53ec\u56de\u7387\u8bc4\u4f30\u7684\u4ee3\u7801 \u6a21\u578b\u6784\u5efa\u7c7b\u7684\u5168\u90e8\u5185\u90e8\u51fd\u6570\u4ee3\u7801 \u542f\u52a8\u8bad\u7ec3\u6d41\u7a0b\u7684\u4ee3\u7801","title":"6.5 \u6a21\u578b\u8bad\u7ec3"},{"location":"6/#66","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u6a21\u578b\u5355\u6761\u6587\u672c\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0 \u638c\u63e1\u6279\u91cf\u6587\u4ef6\u5939\u6587\u4ef6\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0 \u6a21\u578b\u5355\u6761\u6587\u672c\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0: import os import torch import json from bilstm_crf import BiLSTM_CRF def singel_predict(model_path, content, char_to_id_json_path, batch_size, embedding_dim, hidden_dim, num_layers, sentence_length, offset, target_type_list, tag2id): char_to_id = json.load(open(char_to_id_json_path, mode=\"r\", encoding=\"utf-8\")) # \u5c06\u5b57\u7b26\u4e32\u8f6c\u4e3a\u7801\u8868id\u5217\u8868 char_ids = content_to_id(content, char_to_id) # \u5904\u7406\u6210 batch_size * sentence_length \u7684 tensor \u6570\u636e # \u5b9a\u4e49\u6a21\u578b\u8f93\u5165\u5217\u8868 model_inputs_list, model_input_map_list = build_model_input_list(content, char_ids, batch_size, sentence_length, offset) # \u52a0\u8f7d\u6a21\u578b model = BiLSTM_CRF(vocab_size=len(char_to_id), tag_to_ix=tag2id, embedding_dim=embedding_dim, hidden_dim=hidden_dim, batch_size=batch_size, num_layers=num_layers, sequence_length=sentence_length) # \u52a0\u8f7d\u6a21\u578b\u5b57\u5178 model.load_state_dict(torch.load(model_path)) tag_id_dict = {v: k for k, v in tag_to_id.items() if k[2:] in target_type_list} # \u5b9a\u4e49\u8fd4\u56de\u5b9e\u4f53\u5217\u8868 entities = [] with torch.no_grad(): for step, model_inputs in enumerate(model_inputs_list): prediction_value = model(model_inputs) # \u83b7\u53d6\u6bcf\u4e00\u884c\u9884\u6d4b\u7ed3\u679c for line_no, line_value in enumerate(prediction_value): # \u5b9a\u4e49\u5c06\u8981\u8bc6\u522b\u7684\u5b9e\u4f53 entity = None # \u83b7\u53d6\u5f53\u524d\u884c\u6bcf\u4e2a\u5b57\u7684\u9884\u6d4b\u7ed3\u679c for char_idx, tag_id in enumerate(line_value): # \u82e5\u9884\u6d4b\u7ed3\u679c tag_id \u5c5e\u4e8e\u76ee\u6807\u5b57\u5178\u6570\u636e key \u4e2d if tag_id in tag_id_dict: # \u53d6\u7b26\u5408\u5339\u914d\u5b57\u5178id\u7684\u7b2c\u4e00\u4e2a\u5b57\u7b26\uff0c\u5373B, I tag_index = tag_id_dict[tag_id][0] # \u8ba1\u7b97\u5f53\u524d\u5b57\u7b26\u786e\u5207\u7684\u4e0b\u6807\u4f4d\u7f6e current_char = model_input_map_list[step][line_no][char_idx] # \u82e5\u5f53\u524d\u5b57\u6807\u7b7e\u8d77\u59cb\u4e3a B, \u5219\u8bbe\u7f6e\u4e3a\u5b9e\u4f53\u5f00\u59cb if tag_index == \"B\": entity = current_char # \u82e5\u5f53\u524d\u5b57\u6807\u7b7e\u8d77\u59cb\u4e3a I, \u5219\u8fdb\u884c\u5b57\u7b26\u4e32\u8ffd\u52a0 elif tag_index == \"I\" and entity: entity += current_char # \u5f53\u5b9e\u4f53\u4e0d\u4e3a\u7a7a\u4e14\u5f53\u524d\u6807\u7b7e\u7c7b\u578b\u4e3a O \u65f6\uff0c\u52a0\u5165\u5b9e\u4f53\u5217\u8868 if tag_id == tag_to_id[\"O\"] and entity: # \u6ee1\u8db3\u5f53\u524d\u5b57\u7b26\u4e3aO\uff0c\u4e0a\u4e00\u4e2a\u5b57\u7b26\u4e3a\u76ee\u6807\u63d0\u53d6\u5b9e\u4f53\u7ed3\u5c3e\u65f6\uff0c\u5c06\u5176\u52a0\u5165\u5b9e\u4f53\u5217\u8868 entities.append(entity) # \u91cd\u7f6e\u5b9e\u4f53 entity = None return entities def content_to_id(content, char_to_id): # \u5b9a\u4e49\u5b57\u7b26\u4e32\u5bf9\u5e94\u7684\u7801\u8868 id \u5217\u8868 char_ids = [] for char in list(content): # \u5224\u65ad\u82e5\u5b57\u7b26\u4e0d\u5728\u7801\u8868\u5bf9\u5e94\u5b57\u5178\u4e2d\uff0c\u5219\u53d6 NUK \u7684\u7f16\u7801\uff08\u5373 unknown\uff09\uff0c\u5426\u5219\u53d6\u5bf9\u5e94\u7684\u5b57\u7b26\u7f16\u7801 if char_to_id.get(char): char_ids.append(char_to_id[char]) else: char_ids.append(char_to_id[\"UNK\"]) return char_ids def build_model_input_list(content, char_ids, batch_size, sentence_length, offset): # \u5b9a\u4e49\u6a21\u578b\u8f93\u5165\u6570\u636e\u5217\u8868 model_input_list = [] # \u5b9a\u4e49\u6bcf\u4e2a\u6279\u6b21\u53e5\u5b50 id \u6570\u636e batch_sentence_list = [] # \u5c06\u6587\u672c\u5185\u5bb9\u8f6c\u4e3a\u5217\u8868 content_list = list(content) # \u5b9a\u4e49\u4e0e\u6a21\u578b char_id \u5bf9\u7167\u7684\u6587\u5b57 model_input_map_list = [] # \u5b9a\u4e49\u6bcf\u4e2a\u6279\u6b21\u53e5\u5b50\u5b57\u7b26\u6570\u636e batch_sentence_char_list = [] # \u5224\u65ad\u662f\u5426\u9700\u8981 padding if len(char_ids) % sentence_length > 0: # \u5c06\u4e0d\u8db3 batch_size * sentence_length \u7684\u90e8\u5206\u586b\u51450 padding_length = (batch_size * sentence_length - len(char_ids) % batch_size * sentence_length - len(char_ids) % sentence_length) char_ids.extend([0] * padding_length) content_list.extend([\"#\"] * padding_length) # \u8fed\u4ee3\u5b57\u7b26 id \u5217\u8868 # \u6570\u636e\u6ee1\u8db3 batch_size * sentence_length \u5c06\u52a0\u5165 model_input_list for step, idx in enumerate(range(0, len(char_ids) + 1, sentence_length)): # \u8d77\u59cb\u4e0b\u6807\uff0c\u4ece\u7b2c\u4e00\u53e5\u5f00\u59cb\u589e\u52a0 offset \u4e2a\u5b57\u7684\u504f\u79fb start_idx = 0 if idx == 0 else idx - step * offset # \u83b7\u53d6\u957f\u5ea6\u4e3a sentence_length \u7684\u5b57\u7b26 id \u6570\u636e\u96c6 sub_list = char_ids[start_idx:start_idx + sentence_length] # \u83b7\u53d6\u957f\u5ea6\u4e3a sentence_length \u7684\u5b57\u7b26\u6570\u636e\u96c6 sub_char_list = content_list[start_idx:start_idx + sentence_length] # \u52a0\u5165\u6279\u6b21\u6570\u636e\u96c6\u4e2d batch_sentence_list.append(sub_list) # \u6279\u91cf\u53e5\u5b50\u5305\u542b\u5b57\u7b26\u5217\u8868 batch_sentence_char_list.append(sub_char_list) # \u6bcf\u5f53\u6279\u6b21\u957f\u5ea6\u8fbe\u5230 batch_size \u65f6\u5019\uff0c\u5c06\u5176\u52a0\u5165 model_input_list if len(batch_sentence_list) == batch_size: # \u5c06\u6570\u636e\u683c\u5f0f\u8f6c\u4e3a tensor \u683c\u5f0f\uff0c\u5927\u5c0f\u4e3a batch_size * sentence_length model_input_list.append(torch.tensor(batch_sentence_list)) # \u91cd\u7f6e batch_sentence_list batch_sentence_list = [] # \u5c06 char_id \u5bf9\u5e94\u7684\u5b57\u7b26\u52a0\u5165\u6620\u5c04\u8868\u4e2d model_input_map_list.append(batch_sentence_char_list) # \u91cd\u7f6e\u6279\u5b57\u7b26\u4e32\u5185\u5bb9 batch_sentence_char_list = [] # \u8fd4\u56de\u6a21\u578b\u8f93\u5165\u5217\u8868 return model_input_list, model_input_map_list \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/predict.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u5f85\u8bc6\u522b\u6587\u672c content = \"\u672c\u75c5\u662f\u7531DNA\u75c5\u6bd2\u7684\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u6240\u81f4\u3002\u4eba\u7c7b\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u5206\u4e3a\u4e24\u578b\uff0c\" \\ \"\u5373\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u2160\u578b\uff08HSV-\u2160\uff09\u548c\u5355\u7eaf\u75b1\u75b9\u75c5\u6bd2\u2161\u578b\uff08HSV-\u2161\uff09\u3002\" \\ \"\u2160\u578b\u4e3b\u8981\u5f15\u8d77\u751f\u6b96\u5668\u4ee5\u5916\u7684\u76ae\u80a4\u9ecf\u819c\uff08\u53e3\u8154\u9ecf\u819c\uff09\u548c\u5668\u5b98\uff08\u8111\uff09\u7684\u611f\u67d3\u3002\" \\ \"\u2161\u578b\u4e3b\u8981\u5f15\u8d77\u751f\u6b96\u5668\u90e8\u4f4d\u76ae\u80a4\u9ecf\u819c\u611f\u67d3\u3002\" \\ \"\u75c5\u6bd2\u7ecf\u547c\u5438\u9053\u3001\u53e3\u8154\u3001\u751f\u6b96\u5668\u9ecf\u819c\u4ee5\u53ca\u7834\u635f\u76ae\u80a4\u8fdb\u5165\u4f53\u5185\uff0c\" \\ \"\u6f5c\u5c45\u4e8e\u4eba\u4f53\u6b63\u5e38\u9ecf\u819c\u3001\u8840\u6db2\u3001\u553e\u6db2\u53ca\u611f\u89c9\u795e\u7ecf\u8282\u7ec6\u80de\u5185\u3002\" \\ \"\u5f53\u673a\u4f53\u62b5\u6297\u529b\u4e0b\u964d\u65f6\uff0c\u5982\u53d1\u70ed\u80c3\u80a0\u529f\u80fd\u7d0a\u4e71\u3001\u6708\u7ecf\u3001\u75b2\u52b3\u7b49\u65f6\uff0c\" \\ \"\u4f53\u5185\u6f5c\u4f0f\u7684HSV\u88ab\u6fc0\u6d3b\u800c\u53d1\u75c5\u3002\" # \u53c2\u65702:\u6a21\u578b\u4fdd\u5b58\u6587\u4ef6\u8def\u5f84 model_path = \"model/bilstm_crf_state_dict_20200129_210417.pt\" # \u53c2\u65703:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65704:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 300 # \u53c2\u65705:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 128 # \u53c2\u65706:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 100 # \u53c2\u65707:\u504f\u79fb\u91cf OFFSET = 10 # \u53c2\u65708:\u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65709:\u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def\u5f84 char_to_id_json_path = \"./data/char_to_id.json\" # \u53c2\u657010:\u9884\u6d4b\u7ed3\u679c\u5b58\u50a8\u8def\u5f84 prediction_result_path = \"prediction_result\" # \u53c2\u657011:\u5f85\u5339\u914d\u6807\u7b7e\u7c7b\u578b target_type_list = [\"sym\"] \u8c03\u7528: # \u5355\u72ec\u6587\u672c\u9884\u6d4b, \u83b7\u5f97\u5b9e\u4f53\u7ed3\u679c entities = singel_predict(model_path, content, char_to_id_json_path, BATCH_SIZE, EMBEDDING_DIM, HIDDEN_DIM, SENTENCE_LENGTH, OFFSET, target_type_list, tag_to_id) # \u6253\u5370\u5b9e\u4f53\u7ed3\u679c print(\"entities:\\n\", entities) \u8f93\u51fa\u6548\u679c: entities: ['\u611f\u67d3', '\u53d1\u70ed', '##'] \u6279\u91cf\u6587\u4ef6\u5939\u6587\u4ef6\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0: def batch_predict(data_path, model_path, char_to_id_json_path, batch_size, embedding_dim, hidden_dim, sentence_length, offset, target_type_list, prediction_result_path, tag_to_id): \"\"\" description: \u6279\u91cf\u9884\u6d4b\uff0c\u67e5\u8be2\u6587\u4ef6\u76ee\u5f55\u4e0b\u6570\u636e, \u4ece\u4e2d\u63d0\u53d6\u7b26\u5408\u6761\u4ef6\u7684\u5b9e\u4f53\u5e76\u5b58\u50a8\u81f3\u65b0\u7684\u76ee\u5f55\u4e0bprediction_result_path :param data_path: \u6570\u636e\u6587\u4ef6\u8def\u5f84 :param model_path: \u6a21\u578b\u6587\u4ef6\u8def\u5f84 :param char_to_id_json_path: \u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def\u5f84 :param batch_size: \u8bad\u7ec3\u6279\u6b21\u5927\u5c0f :param embedding_dim: \u5b57\u5411\u91cf\u7ef4\u5ea6 :param hidden_dim: BiLSTM \u9690\u85cf\u5c42\u5411\u91cf\u7ef4\u5ea6 :param sentence_length: \u53e5\u5b50\u957f\u5ea6(\u53e5\u5b50\u505a\u4e86padding) :param offset: \u8bbe\u5b9a\u504f\u79fb\u91cf, \u5f53\u5b57\u7b26\u4e32\u8d85\u51fasentence_length\u65f6, \u6362\u884c\u65f6\u589e\u52a0\u504f\u79fb\u91cf :param target_type_list: \u5f85\u5339\u914d\u7c7b\u578b\uff0c\u7b26\u5408\u6761\u4ef6\u7684\u5b9e\u4f53\u5c06\u4f1a\u88ab\u63d0\u53d6\u51fa\u6765 :param prediction_result_path: \u9884\u6d4b\u7ed3\u679c\u4fdd\u5b58\u8def\u5f84 :param tag_to_id: \u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178, \u6807\u7b7e\u5bf9\u5e94 id :return: \u65e0\u8fd4\u56de \"\"\" # \u8fed\u4ee3\u8def\u5f84, \u8bfb\u53d6\u6587\u4ef6\u540d for fn in os.listdir(data_path): # \u62fc\u88c5\u5168\u8def\u5f84 fullpath = os.path.join(data_path, fn) # \u5b9a\u4e49\u8f93\u51fa\u7ed3\u679c\u6587\u4ef6 entities_file = open(os.path.join(prediction_result_path, fn), mode=\"w\", encoding=\"utf-8\") with open(fullpath, mode=\"r\", encoding=\"utf-8\") as f: # \u8bfb\u53d6\u6587\u4ef6\u5185\u5bb9 content = f.readline() # \u8c03\u7528\u5355\u4e2a\u9884\u6d4b\u6a21\u578b\uff0c\u8f93\u51fa\u4e3a\u76ee\u6807\u7c7b\u578b\u5b9e\u4f53\u6587\u672c\u5217\u8868 entities = singel_predict(model_path, content, char_to_id_json_path, batch_size, embedding_dim, hidden_dim, sentence_length, offset, target_type_list, tag_to_id) # \u5199\u5165\u8bc6\u522b\u7ed3\u679c\u6587\u4ef6 entities_file.write(\"\\n\".join(entities)) print(\"batch_predict Finished\".center(100, \"-\")) \u4ee3\u7801\u5b9e\u73b0\u4f4d\u7f6e: /data/doctor_offline/ner_model/predict.py \u8f93\u5165\u53c2\u6570: # \u53c2\u65701:\u6a21\u578b\u4fdd\u5b58\u8def\u5f84 model_path = \"model/bilstm_crf_state_dict_20191219_220256.pt\" # \u53c2\u65702:\u6279\u6b21\u5927\u5c0f BATCH_SIZE = 8 # \u53c2\u65703:\u5b57\u5411\u91cf\u7ef4\u5ea6 EMBEDDING_DIM = 200 # \u53c2\u65704:\u9690\u5c42\u7ef4\u5ea6 HIDDEN_DIM = 100 # \u53c2\u65705:\u53e5\u5b50\u957f\u5ea6 SENTENCE_LENGTH = 20 # \u53c2\u65706:\u504f\u79fb\u91cf OFFSET = 10 # \u53c2\u65707:\u6807\u7b7e\u7801\u8868\u5bf9\u7167\u5b57\u5178 tag_to_id = {\"O\": 0, \"B-dis\": 1, \"I-dis\": 2, \"B-sym\": 3, \"I-sym\": 4, \"<START>\": 5, \"<STOP>\": 6} # \u53c2\u65708:\u5b57\u7b26\u7801\u8868\u6587\u4ef6\u8def\u5f84 char_to_id_json_path = \"./data/char_to_id.json\" # \u53c2\u65709:\u9884\u6d4b\u7ed3\u679c\u5b58\u50a8\u8def\u5f84 prediction_result_path = \"prediction_result\" # \u53c2\u657010:\u5f85\u5339\u914d\u6807\u7b7e\u7c7b\u578b target_type_list = [\"sym\"] # \u53c2\u657011:\u5f85\u9884\u6d4b\u6587\u672c\u6587\u4ef6\u6240\u5728\u76ee\u5f55 data_path = \"origin_data\" \u8c03\u7528: # \u6279\u91cf\u6587\u672c\u9884\u6d4b, \u5e76\u5c06\u7ed3\u679c\u5199\u5165\u6587\u4ef6\u4e2d batch_predict(data_path, model_path, char_to_id_json_path, BATCH_SIZE, EMBEDDING_DIM, HIDDEN_DIM, SENTENCE_LENGTH, OFFSET, target_type_list, prediction_result_path, tag_to_id) \u8f93\u51fa\u6548\u679c: \u5c06\u8bc6\u522b\u7ed3\u679c\u4fdd\u5b58\u81f3prediction_result_path\u6307\u5b9a\u7684\u76ee\u5f55\u4e0b, \u540d\u79f0\u4e0e\u6e90\u6587\u4ef6\u4e00\u81f4, \u5185\u5bb9\u4e3a\u6bcf\u884c\u5b58\u50a8\u8bc6\u522b\u5b9e\u4f53\u540d\u79f0 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u6a21\u578b\u5355\u6761\u6587\u672c\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0 \u5b66\u4e60\u4e86\u6279\u91cf\u6587\u4ef6\u5939\u6587\u4ef6\u9884\u6d4b\u4ee3\u7801\u5b9e\u73b0","title":"6.6 \u6a21\u578b\u4f7f\u7528"},{"location":"7/","text":"7.1 \u5728\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u5728\u7ebf\u90e8\u5206\u7684\u6838\u5fc3\u7ec4\u6210. \u4e86\u89e3\u5404\u4e2a\u6838\u5fc3\u7ec4\u6210\u90e8\u5206\u7684\u4f5c\u7528. \u5728\u7ebf\u90e8\u5206\u67b6\u6784\u56fe: \u5728\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790: \u6839\u636e\u67b6\u6784\u56fe\uff0c\u5728\u7ebf\u90e8\u5206\u7684\u6838\u5fc3\u7531\u4e09\u4e2a\u670d\u52a1\u7ec4\u6210\uff0c\u5206\u522b\u662fwerobot\u670d\u52a1\uff0c\u4e3b\u8981\u903b\u8f91\u670d\u52a1\uff0c\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1. \u8fd9\u4e09\u4e2a\u670d\u52a1\u8d2f\u7a7f\u8fde\u63a5\u6574\u4e2a\u5728\u7ebf\u90e8\u5206\u7684\u5404\u4e2a\u6a21\u5757. werobot\u670d\u52a1\u4f5c\u7528: \u7528\u4e8e\u8fde\u63a5\u5fae\u4fe1\u5ba2\u6237\u7aef\u4e0e\u540e\u7aef\u670d\u52a1, \u5411\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53d1\u9001\u7528\u6237\u8bf7\u6c42\uff0c\u5e76\u63a5\u6536\u7ed3\u6784\u8fd4\u56de\u7ed9\u7528\u6237. \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4f5c\u7528: \u7528\u4e8e\u5904\u7406\u6838\u5fc3\u4e1a\u52a1\u903b\u8f91, \u5305\u62ec\u4f1a\u8bdd\u7ba1\u7406\uff0c\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\uff0c\u67e5\u8be2\u56fe\u6570\u636e\u5e93\uff0c\u8c03\u7528Unit API\u7b49. \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1: \u7528\u4e8e\u5c01\u88c5\u8bad\u7ec3\u597d\u7684\u53e5\u5b50\u76f8\u5173\u5224\u65ad\u6a21\u578b, \u63a5\u6536\u6765\u81ea\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8bf7\u6c42, \u8fd4\u56de\u5224\u65ad\u7ed3\u679c. 7.2 werobot\u670d\u52a1\u6784\u5efa \u5b66\u4e60\u76ee\u6807: \u638c\u63e1werobot\u670d\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b. werobot\u670d\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b\u53ef\u5206\u4e3a\u56db\u6b65: \u7b2c\u4e00\u6b65: \u83b7\u53d6\u670d\u52a1\u5668\u516c\u7f51IP \u7b2c\u4e8c\u6b65: \u914d\u7f6e\u5fae\u4fe1\u516c\u4f17\u53f7 \u7b2c\u4e09\u6b65: \u4f7f\u7528werobot\u542f\u52a8\u670d\u52a1\u811a\u672c \u7b2c\u56db\u6b65: \u4f7f\u7528\u5fae\u4fe1\u516c\u4f17\u53f7\u8fdb\u884c\u6d4b\u8bd5 \u7b2c\u4e00\u6b65: \u83b7\u53d6\u670d\u52a1\u5668\u516c\u7f51IP \u767b\u9646\u963f\u91cc\u4e91\u5b98\u7f51(https://www.aliyun.com/product/ecs): \u8fdb\u884c\u57fa\u672c\u914d\u7f6e, \u9009\u62e9\u6240\u5728\u5730\u57df, \u5b9e\u4f8b\u7c7b\u578b, \u955c\u50cf, \u5b58\u50a8, \u8d2d\u4e70\u65f6\u957f \u9009\u62e9\u7f51\u7edc\u548c\u5b89\u5168\u7ec4(\u9ed8\u8ba4\u914d\u7f6e) \u8bbe\u7f6e\u5bc6\u7801, \u5b9e\u4f8b\u540d\u79f0, \u4e3b\u673a\u540d \u914d\u7f6e\u5206\u7ec4\u8bbe\u7f6e(\u9ed8\u8ba4\u914d\u7f6e) \u786e\u8ba4\u8ba2\u5355\u5e76\u652f\u4ed8 \u67e5\u770b\u670d\u52a1\u5668\u516c\u7f51IP \u7b2c\u4e8c\u6b65: \u4f7f\u7528\u516c\u7f51IP\u914d\u7f6e\u5fae\u4fe1\u516c\u4f17\u53f7 \u6ce8\u518c\u5fae\u4fe1\u8ba2\u9605\u53f7(https://mp.weixin.qq.com) \u5728\u57fa\u672c\u914d\u7f6e\u4e2d\u8fdb\u884cURL\u548cToken\u8bbe\u5b9a \u7b2c\u4e09\u6b65: \u4f7f\u7528werobot\u542f\u52a8\u670d\u52a1\u811a\u672c \u5b89\u88c5werobot pip install werobot \u8fdb\u884c\u542f\u52a8\u811a\u672c\u7684\u7f16\u5199 # \u5bfc\u5165werobot\u548c\u53d1\u9001\u8bf7\u6c42\u7684requests import werobot import requests # \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u8bf7\u6c42\u5730\u5740 url = \"http://161.117.187.37:5000/v1/main_serve/\" # \u670d\u52a1\u8d85\u65f6\u65f6\u95f4 TIMEOUT = 3 # \u58f0\u660e\u5fae\u4fe1\u8bbf\u95ee\u8bf7\u6c42\u3010\u6846\u67b6\u5c06\u8f85\u52a9\u5b8c\u6210\u5fae\u4fe1\u8054\u901a\u9a8c\u8bc1\u3011 robot = werobot.WeRoBot(token=\"doctoraitoken\") # \u8bbe\u7f6e\u6240\u6709\u8bf7\u6c42\uff08\u5305\u542b\u6587\u672c\u3001\u8bed\u97f3\u3001\u56fe\u7247\u7b49\u6d88\u606f\uff09\u5165\u53e3 @robot.handler def doctor(message, session): try: # \u83b7\u5f97\u7528\u6237uid uid = message.source try: # \u68c0\u67e5session\uff0c\u5224\u65ad\u8be5\u7528\u6237\u662f\u5426\u7b2c\u4e00\u6b21\u53d1\u8a00 # \u521d\u59cbsession\u4e3a{} # \u5982\u679csession\u4e2d\u6ca1\u6709{uid:\"1\"} if session.get(uid, None) != \"1\": # \u5c06\u6dfb\u52a0{uid:\"1\"} session[uid] = \"1\" # \u5e76\u8fd4\u56de\u6253\u62db\u547c\u7528\u8bed return '\u60a8\u597d, \u6211\u662f\u667a\u80fd\u5ba2\u670d\u5c0f\u827e, \u6709\u4ec0\u4e48\u9700\u8981\u5e2e\u5fd9\u7684\u5417?' # \u83b7\u53d6message\u4e2d\u7684\u7528\u6237\u53d1\u8a00\u5185\u5bb9 text = message.content except: # \u8fd9\u91cc\u4f7f\u7528try...except\u662f\u56e0\u4e3a\u6211\u7528\u6237\u5f88\u53ef\u80fd\u51fa\u73b0\u53d6\u6d88\u5173\u6ce8\u53c8\u91cd\u65b0\u5173\u6ce8\u7684\u73b0\u8c61 # \u6b64\u65f6\u901a\u8fc7session\u5224\u65ad\uff0c\u8be5\u7528\u6237\u5e76\u4e0d\u662f\u7b2c\u4e00\u6b21\u53d1\u8a00\uff0c\u4f1a\u83b7\u53d6message.content # \u4f46\u7528\u6237\u5176\u5b9e\u53c8\u6ca1\u6709\u8bf4\u8bdd, \u83b7\u53d6message.content\u65f6\u4f1a\u62a5\u9519 # \u8be5\u60c5\u51b5\u4e5f\u662f\u76f4\u63a5\u8fd4\u56de\u6253\u62db\u547c\u7528\u8bed return '\u60a8\u597d, \u6211\u662f\u667a\u80fd\u5ba2\u670d\u5c0f\u827e, \u6709\u4ec0\u4e48\u9700\u8981\u5e2e\u5fd9\u7684\u5417 ?' # \u83b7\u5f97\u53d1\u9001\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u6570\u636e\u4f53 data = {\"uid\": uid, \"text\": text} # \u5411\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53d1\u9001post\u8bf7\u6c42 res = requests.post(url, data=data, timeout=TIMEOUT) # \u8fd4\u56de\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u7ed3\u679c return res.text except Exception as e: print(\"\u51fa\u73b0\u5f02\u5e38:\", e) return \"\u5bf9\u4e0d\u8d77, \u673a\u5668\u4eba\u5ba2\u670d\u6b63\u5728\u4f11\u606f...\" # \u8ba9\u670d\u52a1\u5668\u76d1\u542c\u5728 0.0.0.0:80 robot.config[\"HOST\"] = \"0.0.0.0\" robot.config[\"PORT\"] = 80 robot.run() \u4ee3\u7801\u4f4d\u7f6e: /data/wr.py \u542f\u52a8\u670d\u52a1\u811a\u672c python /data/wr.py \u7b2c\u56db\u6b65: \u4f7f\u7528\u5fae\u4fe1\u8fdb\u884c\u6d4b\u8bd5 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86werobot\u670d\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u83b7\u53d6\u670d\u52a1\u5668\u516c\u7f51IP \u7b2c\u4e8c\u6b65: \u914d\u7f6e\u5fae\u4fe1\u516c\u4f17\u53f7 \u7b2c\u4e09\u6b65: \u4f7f\u7528werobot\u542f\u52a8\u670d\u52a1\u811a\u672c \u7b2c\u56db\u6b65: \u4f7f\u7528\u5fae\u4fe1\u516c\u4f17\u53f7\u8fdb\u884c\u6d4b\u8bd5 7.3 \u4e3b\u8981\u903b\u8f91\u670d\u52a1 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8be5\u670d\u52a1\u4e2d\u7684\u4e3b\u8981\u903b\u8f91. \u638c\u63e1\u6784\u5efa\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8fc7\u7a0b. \u4e3b\u8981\u903b\u8f91\u56fe: \u903b\u8f91\u56fe\u5206\u6790: \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u63a5\u6536werobot\u53d1\u9001\u7684\u8bf7\u6c42\u540e\uff0c\u6839\u636e\u7528\u6237id\u67e5\u8be2redis\u67e5\u627e\u7528\u6237\u4e0a\u4e00\u6b21\u8bf4\u8fc7\u7684\u8bdd\uff0c\u6839\u636e\u7ed3\u679c\u5224\u65ad\u662f\u5426\u4e3a\u4ed6\u7684\u7b2c\u4e00\u53e5. \u5982\u679c\u662f\u7b2c\u4e00\u53e5\u8bdd\uff0c\u76f4\u63a5\u67e5\u8be2\u6570\u636e\u5e93\uff0c\u5224\u65ad\u53e5\u5b50\u4e2d\u662f\u5426\u5305\u542b\u75c7\u72b6\u5b9e\u4f53\uff0c\u5e76\u8fd4\u56de\u8be5\u75c7\u72b6\u8fde\u63a5\u7684\u75be\u75c5\uff0c\u5e76\u586b\u5145\u5728\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\uff0c\u5982\u679c\u67e5\u8be2\u4e0d\u5230\u5219\u8c03\u7528Unit API\u8fd4\u56de\u7ed3\u679c. \u5982\u679c\u4e0d\u662f\u8be5\u7528\u6237\u7684\u7b2c\u4e00\u53e5\u8bdd,\u5219\u8fde\u540c\u4e0a\u4e00\u53e5\u8bdd\u7684\u5185\u5bb9\u4e00\u8d77\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\uff0c\u5224\u65ad\u4e24\u53e5\u8bdd\u662f\u5426\u8ba8\u8bba\u540c\u4e00\u4e3b\u9898,\u5982\u679c\u662f,\u5219\u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93\uff0c\u5982\u679c\u4e0d\u662f\uff0c\u4f7f\u7528unit api\u8fd4\u56de\u7ed3\u679c. \u6784\u5efa\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u5bfc\u5165\u5fc5\u5907\u5de5\u5177\u548c\u914d\u7f6e \u7b2c\u4e8c\u6b65: \u5b8c\u6210\u67e5\u8be2neo4j\u6570\u636e\u5e93\u7684\u51fd\u6570 \u7b2c\u4e09\u6b65: \u7f16\u5199\u4e3b\u8981\u903b\u8f91\u5904\u7406\u7c7b \u7b2c\u56db\u6b65: \u7f16\u5199\u670d\u52a1\u4e2d\u7684\u4e3b\u51fd\u6570 \u7b2c\u4e94\u6b65: \u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1 \u7b2c\u516d\u6b65: \u7f16\u5199\u6d4b\u8bd5\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5: \u7b2c\u4e00\u6b65: \u5bfc\u5165\u5fc5\u5907\u5de5\u5177\u548c\u914d\u7f6e # \u670d\u52a1\u6846\u67b6\u4f7f\u7528Flask # \u5bfc\u5165\u5fc5\u5907\u7684\u5de5\u5177 from flask import Flask from flask import request app = Flask(__name__) # \u5bfc\u5165\u53d1\u9001http\u8bf7\u6c42\u7684requests\u5de5\u5177 import requests # \u5bfc\u5165\u64cd\u4f5credis\u6570\u636e\u5e93\u7684\u5de5\u5177 import redis # \u5bfc\u5165\u52a0\u8f7djson\u6587\u4ef6\u7684\u5de5\u5177 import json # \u5bfc\u5165\u5df2\u5199\u597d\u7684Unit API\u8c03\u7528\u6587\u4ef6 from unit import unit_chat # \u5bfc\u5165\u64cd\u4f5cneo4j\u6570\u636e\u5e93\u7684\u5de5\u5177 from neo4j import GraphDatabase # \u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u5bfc\u5165\u9700\u8981\u7684\u914d\u7f6e # NEO4J\u7684\u8fde\u63a5\u914d\u7f6e from config import NEO4J_CONFIG # REDIS\u7684\u8fde\u63a5\u914d\u7f6e from config import REDIS_CONFIG # \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u7684\u8bf7\u6c42\u5730\u5740 from config import model_serve_url # \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u7684\u8d85\u65f6\u65f6\u95f4 from config import TIMEOUT # \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u7684\u52a0\u8f7d\u8def\u5f84 from config import reply_path # \u7528\u6237\u5bf9\u8bdd\u4fe1\u606f\u4fdd\u5b58\u7684\u8fc7\u671f\u65f6\u95f4 from config import ex_time # \u5efa\u7acbREDIS\u8fde\u63a5\u6c60 pool = redis.ConnectionPool(**REDIS_CONFIG) # \u521d\u59cb\u5316NEO4J\u9a71\u52a8\u5bf9\u8c61 _driver = GraphDatabase.driver(**NEO4J_CONFIG) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b: REDIS_CONFIG = { \"host\": \"0.0.0.0\", \"port\": 6379 } NEO4J_CONFIG = { \"uri\": \"bolt://0.0.0.0:7687\", \"auth\": (\"neo4j\", \"********\"), \"encrypted\": False } model_serve_url = \"http://0.0.0.0:5001/v1/recognition/\" TIMEOUT = 2 reply_path = \"./reply.json\" ex_time = 36000 \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/config.py \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u6587\u4ef6reply.json\u5185\u5bb9\u5982\u4e0b: { \"1\": \"\u4eb2\u7231\u7684\u7528\u6237, \u5728\u7ebf\u533b\u751f\u4e00\u4e2a\u533b\u60a3\u95ee\u7b54\u673a\u5668\u4eba\uff0c\u8bf7\u60a8\u8bf4\u4e00\u4e9b\u5f53\u524d\u7684\u75c7\u72b6\u5427\uff01\", \"2\": \"\u6839\u636e\u60a8\u5f53\u524d\u7684\u75c7\u72b6\u63cf\u8ff0, \u60a8\u53ef\u80fd\u60a3\u6709\u4ee5\u4e0b\u75be\u75c5, %s, \u518d\u60f3\u60f3\u8fd8\u6709\u66f4\u591a\u7684\u75c7\u72b6\u5417?\", \"3\": \"\u5bf9\u4e0d\u8d77, \u60a8\u6240\u8bf4\u7684\u5185\u5bb9\u8d85\u51fa\u4e86\u5728\u7ebf\u533b\u751f\u7684\u77e5\u8bc6\u8303\u56f4. \u8bf7\u5c1d\u8bd5\u6362\u4e00\u4e9b\u63cf\u8ff0\u65b9\u5f0f\uff01\", \"4\": \"\u60a8\u7684\u8fd9\u6b21\u63cf\u8ff0\u5e76\u6ca1\u6709\u7ed9\u6211\u5e26\u6765\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u60a8\u7ee7\u7eed\u63cf\u8ff0\u60a8\u7684\u75c7\u72b6.\" } \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/reply.json \u7b2c\u4e8c\u6b65: \u5b8c\u6210\u67e5\u8be2neo4j\u6570\u636e\u5e93\u7684\u51fd\u6570 def query_neo4j(text): \"\"\" description: \u6839\u636e\u7528\u6237\u5bf9\u8bdd\u6587\u672c\u4e2d\u7684\u53ef\u80fd\u5b58\u5728\u7684\u75c7\u72b6\u67e5\u8be2\u56fe\u6570\u636e\u5e93. :param text: \u7528\u6237\u7684\u8f93\u5165\u6587\u672c. :return: \u7528\u6237\u63cf\u8ff0\u7684\u75c7\u72b6\u5bf9\u5e94\u7684\u75be\u75c5\u5217\u8868. \"\"\" # \u5f00\u542f\u4e00\u4e2asession\u64cd\u4f5c\u56fe\u6570\u636e\u5e93 with _driver.session() as session: # cypher\u8bed\u53e5, \u5339\u914d\u53e5\u5b50\u4e2d\u5b58\u5728\u7684\u6240\u6709\u75c7\u72b6\u8282\u70b9, # \u4fdd\u5b58\u8fd9\u4e9b\u8282\u70b9\u5e76\u9010\u4e00\u901a\u8fc7\u5173\u7cfbdis_to_sym\u8fdb\u884c\u5bf9\u5e94\u75c5\u75c7\u7684\u67e5\u627e, \u8fd4\u56de\u627e\u5230\u7684\u75be\u75c5\u540d\u5b57\u5217\u8868. cypher = \"MATCH(a:Symptom) WHERE(%r contains a.name) WITH \\ a MATCH(a)-[r:dis_to_sym]-(b:Disease) RETURN b.name LIMIT 5\" %text # \u8fd0\u884c\u8fd9\u6761cypher\u8bed\u53e5 record = session.run(cypher) # \u4ecerecord\u5bf9\u8c61\u4e2d\u83b7\u5f97\u7ed3\u679c\u5217\u8868 result = list(map(lambda x: x[0], record)) return result \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u8c03\u7528: if __name__ == \"__main__\": text = \"\u6211\u6700\u8fd1\u8179\u75db!\" result = query_neo4j(text) print(\"\u75be\u75c5\u5217\u8868:\", result) \u8f93\u51fa\u6548\u679c: \u75be\u75c5\u5217\u8868: ['\u80c3\u80a0\u9053\u764c\u8f6c\u79fb\u5375\u5de2', '\u80c3\u80a0\u9053\u529f\u80fd\u7d0a\u4e71', '\u80c3\u80a0\u79ef\u6db2', '\u80c3\u80a0\u578b\u98df\u7269\u4e2d\u6bd2', '\u80c3\u7ed3\u6838'] \u7b2c\u4e09\u6b65: \u7f16\u5199\u4e3b\u8981\u903b\u8f91\u5904\u7406\u7c7b class Handler(object): \"\"\"\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u5904\u7406\u7c7b\"\"\" def __init__(self, uid, text, r, reply): \"\"\" :param uid: \u7528\u6237\u552f\u4e00\u6807\u793auid :param text: \u8be5\u7528\u6237\u672c\u6b21\u8f93\u5165\u7684\u6587\u672c :param r: redis\u6570\u636e\u5e93\u7684\u8fde\u63a5\u5bf9\u8c61 :param reply: \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u5bf9\u8c61(\u5b57\u5178) \"\"\" self.uid = uid self.text = text self.r = r self.reply = reply def non_first_sentence(self, previous): \"\"\" description: \u975e\u9996\u53e5\u5904\u7406\u51fd\u6570 :param previous: \u8be5\u7528\u6237\u5f53\u524d\u53e5(\u8f93\u5165\u6587\u672c)\u7684\u4e0a\u4e00\u53e5\u6587\u672c :return: \u6839\u636e\u903b\u8f91\u56fe\u8fd4\u56de\u975e\u9996\u53e5\u60c5\u51b5\u4e0b\u7684\u8f93\u51fa\u8bed\u53e5 \"\"\" # \u5c1d\u8bd5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u82e5\u5931\u8d25\u5219\u6253\u5370\u9519\u8bef\u7ed3\u679c try: data = {\"text1\": previous, \"text2\": self.text} result = requests.post(model_serve_url, data=data, timeout=TIMEOUT) if not result.text: return unit_chat(self.text) except Exception as e: print(\"\u6a21\u578b\u670d\u52a1\u5f02\u5e38:\", e) return unit_chat(self.text) # \u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c s = query_neo4j(self.text) # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u82e5\u7ed3\u679c\u4e0d\u4e3a\u7a7a, \u83b7\u53d6\u4e0a\u4e00\u6b21\u5df2\u56de\u590d\u7684\u75be\u75c5old_disease old_disease = self.r.hget(str(self.uid), \"previous_d\") if old_disease: # new_disease\u662f\u672c\u6b21\u9700\u8981\u5b58\u50a8\u7684\u75be\u75c5, \u662f\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u4e0e\u672c\u6b21\u67e5\u8be2\u5230\u75be\u75c5\u7684\u5e76\u96c6 new_disease = list(set(s) | set(eval(old_disease))) # res\u662f\u9700\u8981\u8fd4\u56de\u7684\u75be\u75c5, \u662f\u672c\u6b21\u67e5\u8be2\u5230\u7684\u75be\u75c5\u4e0e\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u7684\u5dee\u96c6 res = list(set(s) - set(eval(old_disease))) else: # \u5982\u679cold_disease\u4e3a\u7a7a, \u5219\u5b83\u4eec\u76f8\u540c\u90fd\u662f\u672c\u6b21\u67e5\u8be2\u7ed3\u679cs res = new_disease = list(set(s)) # \u5b58\u50a8new_disease\u8986\u76d6\u4e4b\u524d\u7684old_disease self.r.hset(str(self.uid), \"previous_d\", str(new_disease)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de if not res: return self.reply[\"4\"] else: res = \",\".join(res) return self.reply[\"2\"] %res def first_sentence(self): \"\"\"\u9996\u53e5\u5904\u7406\u51fd\u6570\"\"\" # \u76f4\u63a5\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c s = query_neo4j(self.text) # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u5c06s\u5b58\u50a8\u4e3a\"\u4e0a\u4e00\u6b21\u8fd4\u56de\u7684\u75be\u75c5\" self.r.hset(str(self.uid), \"previous_d\", str(s)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de res = \",\".join(s) return self.reply[\"2\"] %res \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u7b2c\u56db\u6b65: \u7f16\u5199\u670d\u52a1\u4e2d\u7684\u4e3b\u51fd\u6570 # \u8bbe\u5b9a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8def\u7531\u548c\u8bf7\u6c42\u65b9\u6cd5 @app.route('/v1/main_serve/', methods=[\"POST\"]) def main_serve(): # \u63a5\u6536\u6765\u81eawerobot\u670d\u52a1\u7684\u5b57\u6bb5 uid = request.form['uid'] text = request.form['text'] # \u4eceredis\u8fde\u63a5\u6c60\u4e2d\u83b7\u5f97\u4e00\u4e2a\u6d3b\u8dc3\u8fde\u63a5 r = redis.StrictRedis(connection_pool=pool) # \u6839\u636e\u8be5uid\u83b7\u53d6\u4ed6\u7684\u4e0a\u4e00\u53e5\u8bdd(\u53ef\u80fd\u4e0d\u5b58\u5728) previous = r.hget(str(uid), \"previous\") # \u5c06\u5f53\u524d\u8f93\u5165\u7684\u6587\u672c\u8bbe\u7f6e\u6210\u4e0a\u4e00\u53e5 r.hset(str(uid), \"previous\", text) # \u8bfb\u53d6\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u5185\u5bb9\u5230\u5185\u5b58 reply = json.load(open(reply_path, \"r\")) # \u5b9e\u4f8b\u5316\u4e3b\u8981\u903b\u8f91\u5904\u7406\u5bf9\u8c61 handler = Handler(uid, text, r, reply) # \u5982\u679cprevious\u5b58\u5728, \u8bf4\u660e\u4e0d\u662f\u7b2c\u4e00\u53e5\u8bdd if previous: # \u8c03\u7528non_first_sentence\u65b9\u6cd5 return handler.non_first_sentence(previous) else: # \u5426\u5219\u8c03\u7528first_sentence()\u65b9\u6cd5 return handler.first_sentence() \u7b2c\u4e94\u6b65: \u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1 gunicorn -w 1 -b 0.0.0.0:5001 app:app # -w \u4ee3\u8868\u5f00\u542f\u7684\u8fdb\u7a0b\u6570, \u6211\u4eec\u53ea\u5f00\u542f\u4e00\u4e2a\u8fdb\u7a0b # -b \u670d\u52a1\u7684IP\u5730\u5740\u548c\u7aef\u53e3 # app:app \u662f\u6307\u6267\u884c\u7684\u4e3b\u8981\u5bf9\u8c61\u4f4d\u7f6e, \u5728app.py\u4e2d\u7684app\u5bf9\u8c61 \u4ee3\u7801\u4f4d\u7f6e: \u5728/data/doctor_online/main_serve/\u8def\u5f84\u4e0b\u6267\u884c. \u7b2c\u516d\u6b65: \u7f16\u5199\u6d4b\u8bd5\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5 \u7f16\u5199\u6d4b\u8bd5\u811a\u672c: import requests # \u5b9a\u4e49\u8bf7\u6c42url\u548c\u4f20\u5165\u7684data url = \"http://0.0.0.0:5000/v1/main_serve/\" data = {\"uid\":\"13424\", \"text\": \"\u5934\u6655\"} # \u5411\u670d\u52a1\u53d1\u9001post\u8bf7\u6c42 res = requests.post(url, data=data) # \u6253\u5370\u8fd4\u56de\u7684\u7ed3\u679c print(res.text) \u8fd0\u884c\u811a\u672c: python test.py \u8f93\u51fa\u6548\u679c: \u6839\u636e\u60a8\u5f53\u524d\u7684\u75c7\u72b6\u63cf\u8ff0, \u60a8\u53ef\u80fd\u60a3\u6709\u4ee5\u4e0b\u75be\u75c5, \u4e2d\u6bd2,\u866b\u5a92\u4f20\u67d3\u75c5,\u5c0f\u513f\u80a5\u539a\u578b\u5fc3\u808c\u75c5,\u8840\u7ea2\u86cb\u767dE\u75c5,\u94cd\u4e2d\u6bd2, \u518d\u60f3\u60f3\u8fd8\u6709\u66f4\u591a\u7684\u75c7\u72b6\u5417? \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u670d\u52a1\u7684\u4e3b\u8981\u903b\u8f91: \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u63a5\u6536werobot\u53d1\u9001\u7684\u8bf7\u6c42\u540e\uff0c\u6839\u636e\u7528\u6237id\u67e5\u8be2redis\u67e5\u627e\u7528\u6237\u4e0a\u4e00\u6b21\u8bf4\u8fc7\u7684\u8bdd\uff0c\u6839\u636e\u7ed3\u679c\u5224\u65ad\u662f\u5426\u4e3a\u4ed6\u7684\u7b2c\u4e00\u53e5. \u5982\u679c\u662f\u7b2c\u4e00\u53e5\u8bdd\uff0c\u76f4\u63a5\u67e5\u8be2\u6570\u636e\u5e93\uff0c\u5224\u65ad\u53e5\u5b50\u4e2d\u662f\u5426\u5305\u542b\u75c7\u72b6\u5b9e\u4f53\uff0c\u5e76\u8fd4\u56de\u8be5\u75c7\u72b6\u8fde\u63a5\u7684\u75be\u75c5\uff0c\u5e76\u586b\u5145\u5728\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\uff0c\u5982\u679c\u67e5\u8be2\u4e0d\u5230\u5219\u8c03\u7528Unit API\u8fd4\u56de\u7ed3\u679c. \u5982\u679c\u4e0d\u662f\u8be5\u7528\u6237\u7684\u7b2c\u4e00\u53e5\u8bdd,\u5219\u8fde\u540c\u4e0a\u4e00\u53e5\u8bdd\u7684\u5185\u5bb9\u4e00\u8d77\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\uff0c\u5224\u65ad\u4e24\u53e5\u8bdd\u662f\u5426\u8ba8\u8bba\u540c\u4e00\u4e3b\u9898,\u5982\u679c\u662f,\u5219\u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93\uff0c\u5982\u679c\u4e0d\u662f\uff0c\u4f7f\u7528unit api\u8fd4\u56de\u7ed3\u679c. \u6784\u5efa\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u5bfc\u5165\u5fc5\u5907\u5de5\u5177\u548c\u914d\u7f6e \u7b2c\u4e8c\u6b65: \u5b8c\u6210\u67e5\u8be2neo4j\u6570\u636e\u5e93\u7684\u51fd\u6570 \u7b2c\u4e09\u6b65: \u7f16\u5199\u4e3b\u8981\u903b\u8f91\u5904\u7406\u7c7b \u7b2c\u56db\u6b65: \u7f16\u5199\u670d\u52a1\u4e2d\u7684\u4e3b\u51fd\u6570 \u7b2c\u4e94\u6b65: \u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1 \u7b2c\u516d\u6b65: \u7f16\u5199\u6d4b\u8bd5\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5 7.4 \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1 \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u7684\u4efb\u52a1\u7684\u5de5\u4f5c\u5728\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528AI\u6a21\u578b\u5b9e\u73b0, \u5305\u62ec\u6a21\u578b\u8bad\u7ec3\u548c\u4f7f\u7528\u7684\u6574\u4e2a\u8fc7\u7a0b, \u56e0\u6b64\u8fd9\u91cc\u5185\u5bb9\u4ee5\u72ec\u7acb\u4e00\u7ae0\u7684\u5f62\u6210\u5448\u73b0\u7ed9\u5927\u5bb6, \u5177\u4f53\u5185\u5bb9\u5728 \u7b2c\u516b\u7ae0: \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1","title":"\u7b2c\u4e03\u7ae0:\u5728\u7ebf\u90e8\u5206"},{"location":"7/#71","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u5728\u7ebf\u90e8\u5206\u7684\u6838\u5fc3\u7ec4\u6210. \u4e86\u89e3\u5404\u4e2a\u6838\u5fc3\u7ec4\u6210\u90e8\u5206\u7684\u4f5c\u7528. \u5728\u7ebf\u90e8\u5206\u67b6\u6784\u56fe: \u5728\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790: \u6839\u636e\u67b6\u6784\u56fe\uff0c\u5728\u7ebf\u90e8\u5206\u7684\u6838\u5fc3\u7531\u4e09\u4e2a\u670d\u52a1\u7ec4\u6210\uff0c\u5206\u522b\u662fwerobot\u670d\u52a1\uff0c\u4e3b\u8981\u903b\u8f91\u670d\u52a1\uff0c\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1. \u8fd9\u4e09\u4e2a\u670d\u52a1\u8d2f\u7a7f\u8fde\u63a5\u6574\u4e2a\u5728\u7ebf\u90e8\u5206\u7684\u5404\u4e2a\u6a21\u5757. werobot\u670d\u52a1\u4f5c\u7528: \u7528\u4e8e\u8fde\u63a5\u5fae\u4fe1\u5ba2\u6237\u7aef\u4e0e\u540e\u7aef\u670d\u52a1, \u5411\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53d1\u9001\u7528\u6237\u8bf7\u6c42\uff0c\u5e76\u63a5\u6536\u7ed3\u6784\u8fd4\u56de\u7ed9\u7528\u6237. \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4f5c\u7528: \u7528\u4e8e\u5904\u7406\u6838\u5fc3\u4e1a\u52a1\u903b\u8f91, \u5305\u62ec\u4f1a\u8bdd\u7ba1\u7406\uff0c\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\uff0c\u67e5\u8be2\u56fe\u6570\u636e\u5e93\uff0c\u8c03\u7528Unit API\u7b49. \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1: \u7528\u4e8e\u5c01\u88c5\u8bad\u7ec3\u597d\u7684\u53e5\u5b50\u76f8\u5173\u5224\u65ad\u6a21\u578b, \u63a5\u6536\u6765\u81ea\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8bf7\u6c42, \u8fd4\u56de\u5224\u65ad\u7ed3\u679c.","title":"7.1 \u5728\u7ebf\u90e8\u5206\u7b80\u8981\u5206\u6790"},{"location":"7/#72-werobot","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1werobot\u670d\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b. werobot\u670d\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b\u53ef\u5206\u4e3a\u56db\u6b65: \u7b2c\u4e00\u6b65: \u83b7\u53d6\u670d\u52a1\u5668\u516c\u7f51IP \u7b2c\u4e8c\u6b65: \u914d\u7f6e\u5fae\u4fe1\u516c\u4f17\u53f7 \u7b2c\u4e09\u6b65: \u4f7f\u7528werobot\u542f\u52a8\u670d\u52a1\u811a\u672c \u7b2c\u56db\u6b65: \u4f7f\u7528\u5fae\u4fe1\u516c\u4f17\u53f7\u8fdb\u884c\u6d4b\u8bd5 \u7b2c\u4e00\u6b65: \u83b7\u53d6\u670d\u52a1\u5668\u516c\u7f51IP \u767b\u9646\u963f\u91cc\u4e91\u5b98\u7f51(https://www.aliyun.com/product/ecs): \u8fdb\u884c\u57fa\u672c\u914d\u7f6e, \u9009\u62e9\u6240\u5728\u5730\u57df, \u5b9e\u4f8b\u7c7b\u578b, \u955c\u50cf, \u5b58\u50a8, \u8d2d\u4e70\u65f6\u957f \u9009\u62e9\u7f51\u7edc\u548c\u5b89\u5168\u7ec4(\u9ed8\u8ba4\u914d\u7f6e) \u8bbe\u7f6e\u5bc6\u7801, \u5b9e\u4f8b\u540d\u79f0, \u4e3b\u673a\u540d \u914d\u7f6e\u5206\u7ec4\u8bbe\u7f6e(\u9ed8\u8ba4\u914d\u7f6e) \u786e\u8ba4\u8ba2\u5355\u5e76\u652f\u4ed8 \u67e5\u770b\u670d\u52a1\u5668\u516c\u7f51IP \u7b2c\u4e8c\u6b65: \u4f7f\u7528\u516c\u7f51IP\u914d\u7f6e\u5fae\u4fe1\u516c\u4f17\u53f7 \u6ce8\u518c\u5fae\u4fe1\u8ba2\u9605\u53f7(https://mp.weixin.qq.com) \u5728\u57fa\u672c\u914d\u7f6e\u4e2d\u8fdb\u884cURL\u548cToken\u8bbe\u5b9a \u7b2c\u4e09\u6b65: \u4f7f\u7528werobot\u542f\u52a8\u670d\u52a1\u811a\u672c \u5b89\u88c5werobot pip install werobot \u8fdb\u884c\u542f\u52a8\u811a\u672c\u7684\u7f16\u5199 # \u5bfc\u5165werobot\u548c\u53d1\u9001\u8bf7\u6c42\u7684requests import werobot import requests # \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u8bf7\u6c42\u5730\u5740 url = \"http://161.117.187.37:5000/v1/main_serve/\" # \u670d\u52a1\u8d85\u65f6\u65f6\u95f4 TIMEOUT = 3 # \u58f0\u660e\u5fae\u4fe1\u8bbf\u95ee\u8bf7\u6c42\u3010\u6846\u67b6\u5c06\u8f85\u52a9\u5b8c\u6210\u5fae\u4fe1\u8054\u901a\u9a8c\u8bc1\u3011 robot = werobot.WeRoBot(token=\"doctoraitoken\") # \u8bbe\u7f6e\u6240\u6709\u8bf7\u6c42\uff08\u5305\u542b\u6587\u672c\u3001\u8bed\u97f3\u3001\u56fe\u7247\u7b49\u6d88\u606f\uff09\u5165\u53e3 @robot.handler def doctor(message, session): try: # \u83b7\u5f97\u7528\u6237uid uid = message.source try: # \u68c0\u67e5session\uff0c\u5224\u65ad\u8be5\u7528\u6237\u662f\u5426\u7b2c\u4e00\u6b21\u53d1\u8a00 # \u521d\u59cbsession\u4e3a{} # \u5982\u679csession\u4e2d\u6ca1\u6709{uid:\"1\"} if session.get(uid, None) != \"1\": # \u5c06\u6dfb\u52a0{uid:\"1\"} session[uid] = \"1\" # \u5e76\u8fd4\u56de\u6253\u62db\u547c\u7528\u8bed return '\u60a8\u597d, \u6211\u662f\u667a\u80fd\u5ba2\u670d\u5c0f\u827e, \u6709\u4ec0\u4e48\u9700\u8981\u5e2e\u5fd9\u7684\u5417?' # \u83b7\u53d6message\u4e2d\u7684\u7528\u6237\u53d1\u8a00\u5185\u5bb9 text = message.content except: # \u8fd9\u91cc\u4f7f\u7528try...except\u662f\u56e0\u4e3a\u6211\u7528\u6237\u5f88\u53ef\u80fd\u51fa\u73b0\u53d6\u6d88\u5173\u6ce8\u53c8\u91cd\u65b0\u5173\u6ce8\u7684\u73b0\u8c61 # \u6b64\u65f6\u901a\u8fc7session\u5224\u65ad\uff0c\u8be5\u7528\u6237\u5e76\u4e0d\u662f\u7b2c\u4e00\u6b21\u53d1\u8a00\uff0c\u4f1a\u83b7\u53d6message.content # \u4f46\u7528\u6237\u5176\u5b9e\u53c8\u6ca1\u6709\u8bf4\u8bdd, \u83b7\u53d6message.content\u65f6\u4f1a\u62a5\u9519 # \u8be5\u60c5\u51b5\u4e5f\u662f\u76f4\u63a5\u8fd4\u56de\u6253\u62db\u547c\u7528\u8bed return '\u60a8\u597d, \u6211\u662f\u667a\u80fd\u5ba2\u670d\u5c0f\u827e, \u6709\u4ec0\u4e48\u9700\u8981\u5e2e\u5fd9\u7684\u5417 ?' # \u83b7\u5f97\u53d1\u9001\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u6570\u636e\u4f53 data = {\"uid\": uid, \"text\": text} # \u5411\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53d1\u9001post\u8bf7\u6c42 res = requests.post(url, data=data, timeout=TIMEOUT) # \u8fd4\u56de\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u7ed3\u679c return res.text except Exception as e: print(\"\u51fa\u73b0\u5f02\u5e38:\", e) return \"\u5bf9\u4e0d\u8d77, \u673a\u5668\u4eba\u5ba2\u670d\u6b63\u5728\u4f11\u606f...\" # \u8ba9\u670d\u52a1\u5668\u76d1\u542c\u5728 0.0.0.0:80 robot.config[\"HOST\"] = \"0.0.0.0\" robot.config[\"PORT\"] = 80 robot.run() \u4ee3\u7801\u4f4d\u7f6e: /data/wr.py \u542f\u52a8\u670d\u52a1\u811a\u672c python /data/wr.py \u7b2c\u56db\u6b65: \u4f7f\u7528\u5fae\u4fe1\u8fdb\u884c\u6d4b\u8bd5 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86werobot\u670d\u52a1\u7684\u6784\u5efa\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u83b7\u53d6\u670d\u52a1\u5668\u516c\u7f51IP \u7b2c\u4e8c\u6b65: \u914d\u7f6e\u5fae\u4fe1\u516c\u4f17\u53f7 \u7b2c\u4e09\u6b65: \u4f7f\u7528werobot\u542f\u52a8\u670d\u52a1\u811a\u672c \u7b2c\u56db\u6b65: \u4f7f\u7528\u5fae\u4fe1\u516c\u4f17\u53f7\u8fdb\u884c\u6d4b\u8bd5","title":"7.2 werobot\u670d\u52a1\u6784\u5efa"},{"location":"7/#73","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8be5\u670d\u52a1\u4e2d\u7684\u4e3b\u8981\u903b\u8f91. \u638c\u63e1\u6784\u5efa\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8fc7\u7a0b. \u4e3b\u8981\u903b\u8f91\u56fe: \u903b\u8f91\u56fe\u5206\u6790: \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u63a5\u6536werobot\u53d1\u9001\u7684\u8bf7\u6c42\u540e\uff0c\u6839\u636e\u7528\u6237id\u67e5\u8be2redis\u67e5\u627e\u7528\u6237\u4e0a\u4e00\u6b21\u8bf4\u8fc7\u7684\u8bdd\uff0c\u6839\u636e\u7ed3\u679c\u5224\u65ad\u662f\u5426\u4e3a\u4ed6\u7684\u7b2c\u4e00\u53e5. \u5982\u679c\u662f\u7b2c\u4e00\u53e5\u8bdd\uff0c\u76f4\u63a5\u67e5\u8be2\u6570\u636e\u5e93\uff0c\u5224\u65ad\u53e5\u5b50\u4e2d\u662f\u5426\u5305\u542b\u75c7\u72b6\u5b9e\u4f53\uff0c\u5e76\u8fd4\u56de\u8be5\u75c7\u72b6\u8fde\u63a5\u7684\u75be\u75c5\uff0c\u5e76\u586b\u5145\u5728\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\uff0c\u5982\u679c\u67e5\u8be2\u4e0d\u5230\u5219\u8c03\u7528Unit API\u8fd4\u56de\u7ed3\u679c. \u5982\u679c\u4e0d\u662f\u8be5\u7528\u6237\u7684\u7b2c\u4e00\u53e5\u8bdd,\u5219\u8fde\u540c\u4e0a\u4e00\u53e5\u8bdd\u7684\u5185\u5bb9\u4e00\u8d77\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\uff0c\u5224\u65ad\u4e24\u53e5\u8bdd\u662f\u5426\u8ba8\u8bba\u540c\u4e00\u4e3b\u9898,\u5982\u679c\u662f,\u5219\u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93\uff0c\u5982\u679c\u4e0d\u662f\uff0c\u4f7f\u7528unit api\u8fd4\u56de\u7ed3\u679c. \u6784\u5efa\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u5bfc\u5165\u5fc5\u5907\u5de5\u5177\u548c\u914d\u7f6e \u7b2c\u4e8c\u6b65: \u5b8c\u6210\u67e5\u8be2neo4j\u6570\u636e\u5e93\u7684\u51fd\u6570 \u7b2c\u4e09\u6b65: \u7f16\u5199\u4e3b\u8981\u903b\u8f91\u5904\u7406\u7c7b \u7b2c\u56db\u6b65: \u7f16\u5199\u670d\u52a1\u4e2d\u7684\u4e3b\u51fd\u6570 \u7b2c\u4e94\u6b65: \u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1 \u7b2c\u516d\u6b65: \u7f16\u5199\u6d4b\u8bd5\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5: \u7b2c\u4e00\u6b65: \u5bfc\u5165\u5fc5\u5907\u5de5\u5177\u548c\u914d\u7f6e # \u670d\u52a1\u6846\u67b6\u4f7f\u7528Flask # \u5bfc\u5165\u5fc5\u5907\u7684\u5de5\u5177 from flask import Flask from flask import request app = Flask(__name__) # \u5bfc\u5165\u53d1\u9001http\u8bf7\u6c42\u7684requests\u5de5\u5177 import requests # \u5bfc\u5165\u64cd\u4f5credis\u6570\u636e\u5e93\u7684\u5de5\u5177 import redis # \u5bfc\u5165\u52a0\u8f7djson\u6587\u4ef6\u7684\u5de5\u5177 import json # \u5bfc\u5165\u5df2\u5199\u597d\u7684Unit API\u8c03\u7528\u6587\u4ef6 from unit import unit_chat # \u5bfc\u5165\u64cd\u4f5cneo4j\u6570\u636e\u5e93\u7684\u5de5\u5177 from neo4j import GraphDatabase # \u4ece\u914d\u7f6e\u6587\u4ef6\u4e2d\u5bfc\u5165\u9700\u8981\u7684\u914d\u7f6e # NEO4J\u7684\u8fde\u63a5\u914d\u7f6e from config import NEO4J_CONFIG # REDIS\u7684\u8fde\u63a5\u914d\u7f6e from config import REDIS_CONFIG # \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u7684\u8bf7\u6c42\u5730\u5740 from config import model_serve_url # \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u7684\u8d85\u65f6\u65f6\u95f4 from config import TIMEOUT # \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u7684\u52a0\u8f7d\u8def\u5f84 from config import reply_path # \u7528\u6237\u5bf9\u8bdd\u4fe1\u606f\u4fdd\u5b58\u7684\u8fc7\u671f\u65f6\u95f4 from config import ex_time # \u5efa\u7acbREDIS\u8fde\u63a5\u6c60 pool = redis.ConnectionPool(**REDIS_CONFIG) # \u521d\u59cb\u5316NEO4J\u9a71\u52a8\u5bf9\u8c61 _driver = GraphDatabase.driver(**NEO4J_CONFIG) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u914d\u7f6e\u6587\u4ef6\u5185\u5bb9\u5982\u4e0b: REDIS_CONFIG = { \"host\": \"0.0.0.0\", \"port\": 6379 } NEO4J_CONFIG = { \"uri\": \"bolt://0.0.0.0:7687\", \"auth\": (\"neo4j\", \"********\"), \"encrypted\": False } model_serve_url = \"http://0.0.0.0:5001/v1/recognition/\" TIMEOUT = 2 reply_path = \"./reply.json\" ex_time = 36000 \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/config.py \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u6587\u4ef6reply.json\u5185\u5bb9\u5982\u4e0b: { \"1\": \"\u4eb2\u7231\u7684\u7528\u6237, \u5728\u7ebf\u533b\u751f\u4e00\u4e2a\u533b\u60a3\u95ee\u7b54\u673a\u5668\u4eba\uff0c\u8bf7\u60a8\u8bf4\u4e00\u4e9b\u5f53\u524d\u7684\u75c7\u72b6\u5427\uff01\", \"2\": \"\u6839\u636e\u60a8\u5f53\u524d\u7684\u75c7\u72b6\u63cf\u8ff0, \u60a8\u53ef\u80fd\u60a3\u6709\u4ee5\u4e0b\u75be\u75c5, %s, \u518d\u60f3\u60f3\u8fd8\u6709\u66f4\u591a\u7684\u75c7\u72b6\u5417?\", \"3\": \"\u5bf9\u4e0d\u8d77, \u60a8\u6240\u8bf4\u7684\u5185\u5bb9\u8d85\u51fa\u4e86\u5728\u7ebf\u533b\u751f\u7684\u77e5\u8bc6\u8303\u56f4. \u8bf7\u5c1d\u8bd5\u6362\u4e00\u4e9b\u63cf\u8ff0\u65b9\u5f0f\uff01\", \"4\": \"\u60a8\u7684\u8fd9\u6b21\u63cf\u8ff0\u5e76\u6ca1\u6709\u7ed9\u6211\u5e26\u6765\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u60a8\u7ee7\u7eed\u63cf\u8ff0\u60a8\u7684\u75c7\u72b6.\" } \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/reply.json \u7b2c\u4e8c\u6b65: \u5b8c\u6210\u67e5\u8be2neo4j\u6570\u636e\u5e93\u7684\u51fd\u6570 def query_neo4j(text): \"\"\" description: \u6839\u636e\u7528\u6237\u5bf9\u8bdd\u6587\u672c\u4e2d\u7684\u53ef\u80fd\u5b58\u5728\u7684\u75c7\u72b6\u67e5\u8be2\u56fe\u6570\u636e\u5e93. :param text: \u7528\u6237\u7684\u8f93\u5165\u6587\u672c. :return: \u7528\u6237\u63cf\u8ff0\u7684\u75c7\u72b6\u5bf9\u5e94\u7684\u75be\u75c5\u5217\u8868. \"\"\" # \u5f00\u542f\u4e00\u4e2asession\u64cd\u4f5c\u56fe\u6570\u636e\u5e93 with _driver.session() as session: # cypher\u8bed\u53e5, \u5339\u914d\u53e5\u5b50\u4e2d\u5b58\u5728\u7684\u6240\u6709\u75c7\u72b6\u8282\u70b9, # \u4fdd\u5b58\u8fd9\u4e9b\u8282\u70b9\u5e76\u9010\u4e00\u901a\u8fc7\u5173\u7cfbdis_to_sym\u8fdb\u884c\u5bf9\u5e94\u75c5\u75c7\u7684\u67e5\u627e, \u8fd4\u56de\u627e\u5230\u7684\u75be\u75c5\u540d\u5b57\u5217\u8868. cypher = \"MATCH(a:Symptom) WHERE(%r contains a.name) WITH \\ a MATCH(a)-[r:dis_to_sym]-(b:Disease) RETURN b.name LIMIT 5\" %text # \u8fd0\u884c\u8fd9\u6761cypher\u8bed\u53e5 record = session.run(cypher) # \u4ecerecord\u5bf9\u8c61\u4e2d\u83b7\u5f97\u7ed3\u679c\u5217\u8868 result = list(map(lambda x: x[0], record)) return result \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u8c03\u7528: if __name__ == \"__main__\": text = \"\u6211\u6700\u8fd1\u8179\u75db!\" result = query_neo4j(text) print(\"\u75be\u75c5\u5217\u8868:\", result) \u8f93\u51fa\u6548\u679c: \u75be\u75c5\u5217\u8868: ['\u80c3\u80a0\u9053\u764c\u8f6c\u79fb\u5375\u5de2', '\u80c3\u80a0\u9053\u529f\u80fd\u7d0a\u4e71', '\u80c3\u80a0\u79ef\u6db2', '\u80c3\u80a0\u578b\u98df\u7269\u4e2d\u6bd2', '\u80c3\u7ed3\u6838'] \u7b2c\u4e09\u6b65: \u7f16\u5199\u4e3b\u8981\u903b\u8f91\u5904\u7406\u7c7b class Handler(object): \"\"\"\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u5904\u7406\u7c7b\"\"\" def __init__(self, uid, text, r, reply): \"\"\" :param uid: \u7528\u6237\u552f\u4e00\u6807\u793auid :param text: \u8be5\u7528\u6237\u672c\u6b21\u8f93\u5165\u7684\u6587\u672c :param r: redis\u6570\u636e\u5e93\u7684\u8fde\u63a5\u5bf9\u8c61 :param reply: \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u5bf9\u8c61(\u5b57\u5178) \"\"\" self.uid = uid self.text = text self.r = r self.reply = reply def non_first_sentence(self, previous): \"\"\" description: \u975e\u9996\u53e5\u5904\u7406\u51fd\u6570 :param previous: \u8be5\u7528\u6237\u5f53\u524d\u53e5(\u8f93\u5165\u6587\u672c)\u7684\u4e0a\u4e00\u53e5\u6587\u672c :return: \u6839\u636e\u903b\u8f91\u56fe\u8fd4\u56de\u975e\u9996\u53e5\u60c5\u51b5\u4e0b\u7684\u8f93\u51fa\u8bed\u53e5 \"\"\" # \u5c1d\u8bd5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u82e5\u5931\u8d25\u5219\u6253\u5370\u9519\u8bef\u7ed3\u679c try: data = {\"text1\": previous, \"text2\": self.text} result = requests.post(model_serve_url, data=data, timeout=TIMEOUT) if not result.text: return unit_chat(self.text) except Exception as e: print(\"\u6a21\u578b\u670d\u52a1\u5f02\u5e38:\", e) return unit_chat(self.text) # \u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c s = query_neo4j(self.text) # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u82e5\u7ed3\u679c\u4e0d\u4e3a\u7a7a, \u83b7\u53d6\u4e0a\u4e00\u6b21\u5df2\u56de\u590d\u7684\u75be\u75c5old_disease old_disease = self.r.hget(str(self.uid), \"previous_d\") if old_disease: # new_disease\u662f\u672c\u6b21\u9700\u8981\u5b58\u50a8\u7684\u75be\u75c5, \u662f\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u4e0e\u672c\u6b21\u67e5\u8be2\u5230\u75be\u75c5\u7684\u5e76\u96c6 new_disease = list(set(s) | set(eval(old_disease))) # res\u662f\u9700\u8981\u8fd4\u56de\u7684\u75be\u75c5, \u662f\u672c\u6b21\u67e5\u8be2\u5230\u7684\u75be\u75c5\u4e0e\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u7684\u5dee\u96c6 res = list(set(s) - set(eval(old_disease))) else: # \u5982\u679cold_disease\u4e3a\u7a7a, \u5219\u5b83\u4eec\u76f8\u540c\u90fd\u662f\u672c\u6b21\u67e5\u8be2\u7ed3\u679cs res = new_disease = list(set(s)) # \u5b58\u50a8new_disease\u8986\u76d6\u4e4b\u524d\u7684old_disease self.r.hset(str(self.uid), \"previous_d\", str(new_disease)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de if not res: return self.reply[\"4\"] else: res = \",\".join(res) return self.reply[\"2\"] %res def first_sentence(self): \"\"\"\u9996\u53e5\u5904\u7406\u51fd\u6570\"\"\" # \u76f4\u63a5\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c s = query_neo4j(self.text) # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u5c06s\u5b58\u50a8\u4e3a\"\u4e0a\u4e00\u6b21\u8fd4\u56de\u7684\u75be\u75c5\" self.r.hset(str(self.uid), \"previous_d\", str(s)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de res = \",\".join(s) return self.reply[\"2\"] %res \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u7b2c\u56db\u6b65: \u7f16\u5199\u670d\u52a1\u4e2d\u7684\u4e3b\u51fd\u6570 # \u8bbe\u5b9a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8def\u7531\u548c\u8bf7\u6c42\u65b9\u6cd5 @app.route('/v1/main_serve/', methods=[\"POST\"]) def main_serve(): # \u63a5\u6536\u6765\u81eawerobot\u670d\u52a1\u7684\u5b57\u6bb5 uid = request.form['uid'] text = request.form['text'] # \u4eceredis\u8fde\u63a5\u6c60\u4e2d\u83b7\u5f97\u4e00\u4e2a\u6d3b\u8dc3\u8fde\u63a5 r = redis.StrictRedis(connection_pool=pool) # \u6839\u636e\u8be5uid\u83b7\u53d6\u4ed6\u7684\u4e0a\u4e00\u53e5\u8bdd(\u53ef\u80fd\u4e0d\u5b58\u5728) previous = r.hget(str(uid), \"previous\") # \u5c06\u5f53\u524d\u8f93\u5165\u7684\u6587\u672c\u8bbe\u7f6e\u6210\u4e0a\u4e00\u53e5 r.hset(str(uid), \"previous\", text) # \u8bfb\u53d6\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u5185\u5bb9\u5230\u5185\u5b58 reply = json.load(open(reply_path, \"r\")) # \u5b9e\u4f8b\u5316\u4e3b\u8981\u903b\u8f91\u5904\u7406\u5bf9\u8c61 handler = Handler(uid, text, r, reply) # \u5982\u679cprevious\u5b58\u5728, \u8bf4\u660e\u4e0d\u662f\u7b2c\u4e00\u53e5\u8bdd if previous: # \u8c03\u7528non_first_sentence\u65b9\u6cd5 return handler.non_first_sentence(previous) else: # \u5426\u5219\u8c03\u7528first_sentence()\u65b9\u6cd5 return handler.first_sentence() \u7b2c\u4e94\u6b65: \u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1 gunicorn -w 1 -b 0.0.0.0:5001 app:app # -w \u4ee3\u8868\u5f00\u542f\u7684\u8fdb\u7a0b\u6570, \u6211\u4eec\u53ea\u5f00\u542f\u4e00\u4e2a\u8fdb\u7a0b # -b \u670d\u52a1\u7684IP\u5730\u5740\u548c\u7aef\u53e3 # app:app \u662f\u6307\u6267\u884c\u7684\u4e3b\u8981\u5bf9\u8c61\u4f4d\u7f6e, \u5728app.py\u4e2d\u7684app\u5bf9\u8c61 \u4ee3\u7801\u4f4d\u7f6e: \u5728/data/doctor_online/main_serve/\u8def\u5f84\u4e0b\u6267\u884c. \u7b2c\u516d\u6b65: \u7f16\u5199\u6d4b\u8bd5\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5 \u7f16\u5199\u6d4b\u8bd5\u811a\u672c: import requests # \u5b9a\u4e49\u8bf7\u6c42url\u548c\u4f20\u5165\u7684data url = \"http://0.0.0.0:5000/v1/main_serve/\" data = {\"uid\":\"13424\", \"text\": \"\u5934\u6655\"} # \u5411\u670d\u52a1\u53d1\u9001post\u8bf7\u6c42 res = requests.post(url, data=data) # \u6253\u5370\u8fd4\u56de\u7684\u7ed3\u679c print(res.text) \u8fd0\u884c\u811a\u672c: python test.py \u8f93\u51fa\u6548\u679c: \u6839\u636e\u60a8\u5f53\u524d\u7684\u75c7\u72b6\u63cf\u8ff0, \u60a8\u53ef\u80fd\u60a3\u6709\u4ee5\u4e0b\u75be\u75c5, \u4e2d\u6bd2,\u866b\u5a92\u4f20\u67d3\u75c5,\u5c0f\u513f\u80a5\u539a\u578b\u5fc3\u808c\u75c5,\u8840\u7ea2\u86cb\u767dE\u75c5,\u94cd\u4e2d\u6bd2, \u518d\u60f3\u60f3\u8fd8\u6709\u66f4\u591a\u7684\u75c7\u72b6\u5417? \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u670d\u52a1\u7684\u4e3b\u8981\u903b\u8f91: \u4e3b\u8981\u903b\u8f91\u670d\u52a1\u63a5\u6536werobot\u53d1\u9001\u7684\u8bf7\u6c42\u540e\uff0c\u6839\u636e\u7528\u6237id\u67e5\u8be2redis\u67e5\u627e\u7528\u6237\u4e0a\u4e00\u6b21\u8bf4\u8fc7\u7684\u8bdd\uff0c\u6839\u636e\u7ed3\u679c\u5224\u65ad\u662f\u5426\u4e3a\u4ed6\u7684\u7b2c\u4e00\u53e5. \u5982\u679c\u662f\u7b2c\u4e00\u53e5\u8bdd\uff0c\u76f4\u63a5\u67e5\u8be2\u6570\u636e\u5e93\uff0c\u5224\u65ad\u53e5\u5b50\u4e2d\u662f\u5426\u5305\u542b\u75c7\u72b6\u5b9e\u4f53\uff0c\u5e76\u8fd4\u56de\u8be5\u75c7\u72b6\u8fde\u63a5\u7684\u75be\u75c5\uff0c\u5e76\u586b\u5145\u5728\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\uff0c\u5982\u679c\u67e5\u8be2\u4e0d\u5230\u5219\u8c03\u7528Unit API\u8fd4\u56de\u7ed3\u679c. \u5982\u679c\u4e0d\u662f\u8be5\u7528\u6237\u7684\u7b2c\u4e00\u53e5\u8bdd,\u5219\u8fde\u540c\u4e0a\u4e00\u53e5\u8bdd\u7684\u5185\u5bb9\u4e00\u8d77\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\uff0c\u5224\u65ad\u4e24\u53e5\u8bdd\u662f\u5426\u8ba8\u8bba\u540c\u4e00\u4e3b\u9898,\u5982\u679c\u662f,\u5219\u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93\uff0c\u5982\u679c\u4e0d\u662f\uff0c\u4f7f\u7528unit api\u8fd4\u56de\u7ed3\u679c. \u6784\u5efa\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u5bfc\u5165\u5fc5\u5907\u5de5\u5177\u548c\u914d\u7f6e \u7b2c\u4e8c\u6b65: \u5b8c\u6210\u67e5\u8be2neo4j\u6570\u636e\u5e93\u7684\u51fd\u6570 \u7b2c\u4e09\u6b65: \u7f16\u5199\u4e3b\u8981\u903b\u8f91\u5904\u7406\u7c7b \u7b2c\u56db\u6b65: \u7f16\u5199\u670d\u52a1\u4e2d\u7684\u4e3b\u51fd\u6570 \u7b2c\u4e94\u6b65: \u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1 \u7b2c\u516d\u6b65: \u7f16\u5199\u6d4b\u8bd5\u811a\u672c\u5e76\u8fdb\u884c\u6d4b\u8bd5","title":"7.3 \u4e3b\u8981\u903b\u8f91\u670d\u52a1"},{"location":"7/#74","text":"\u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u7684\u4efb\u52a1\u7684\u5de5\u4f5c\u5728\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528AI\u6a21\u578b\u5b9e\u73b0, \u5305\u62ec\u6a21\u578b\u8bad\u7ec3\u548c\u4f7f\u7528\u7684\u6574\u4e2a\u8fc7\u7a0b, \u56e0\u6b64\u8fd9\u91cc\u5185\u5bb9\u4ee5\u72ec\u7acb\u4e00\u7ae0\u7684\u5f62\u6210\u5448\u73b0\u7ed9\u5927\u5bb6, \u5177\u4f53\u5185\u5bb9\u5728 \u7b2c\u516b\u7ae0: \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1","title":"7.4 \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1"},{"location":"8/","text":"8.1 \u4efb\u52a1\u4ecb\u7ecd\u4e0e\u6a21\u578b\u9009\u7528 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1\u7684\u76f8\u5173\u77e5\u8bc6. \u4e86\u89e3\u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0. \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1: \u5728\u591a\u8f6e\u5bf9\u8bdd\u7cfb\u7edf\u4e2d, \u5f80\u5f80\u9700\u8981\u5224\u65ad\u7528\u6237\u7684\u6700\u8fd1\u4e24\u6b21\u56de\u590d\u662f\u5426\u56f4\u7ed5\u540c\u4e00\u4e3b\u9898, \u6765\u51b3\u5b9a\u95ee\u7b54\u673a\u5668\u4eba\u662f\u5426\u4e5f\u6839\u636e\u81ea\u5df1\u4e0a\u4e00\u6b21\u7684\u56de\u590d\u6765\u8ba8\u8bba\u76f8\u5173\u5185\u5bb9. \u5728\u7ebf\u533b\u751f\u95ee\u7b54\u8fc7\u7a0b\u4e2d, \u540c\u6837\u9700\u8981\u8fd9\u6837\u7684\u5904\u7406, \u786e\u4fdd\u7528\u6237\u4e00\u76f4\u8ba8\u8bba\u75be\u75c5\u6709\u5173\u7684\u5185\u5bb9, \u6765\u6839\u636e\u75c7\u72b6\u63a8\u65ad\u75c5\u60c5. \u8fd9\u79cd\u4efb\u52a1\u7684\u5f62\u5f0f\u4e0e\u5224\u65ad\u4e24\u4e2a\u53e5\u5b50\u662f\u5426\u8fde\u8d2f\u7684\u5f62\u5f0f\u76f8\u540c, \u4ed6\u4eec\u90fd\u9700\u8981\u8f93\u5165\u4e24\u6bb5\u6587\u672c\u5185\u5bb9, \u8fd4\u56de'\u662f'\u6216'\u5426'\u7684\u4e8c\u5206\u7c7b\u6807\u7b7e. \u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0: \u5bf9\u8bdd\u7cfb\u7edf\u662f\u5f00\u653e\u7684\u8bed\u8a00\u5904\u7406\u7cfb\u7edf, \u53ef\u80fd\u51fa\u73b0\u5404\u79cd\u6587\u5b57, \u5f53\u6211\u4eec\u7684\u8bad\u7ec3\u96c6\u6709\u9650\u65e0\u6cd5\u8986\u76d6\u5927\u591a\u6570\u60c5\u51b5\u65f6, \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u8fdb\u884c\u6587\u5b57\u8868\u793a. \u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86bert-chinese\u9884\u8bad\u7ec3\u6a21\u578b, \u540c\u65f6\u4e3a\u4e86\u9002\u5e94\u6211\u4eec\u7814\u7a76\u7684\u5782\u76f4\u9886\u57df, \u6211\u4eec\u5728\u540e\u9762\u81ea\u5b9a\u4e49\u6d45\u5c42\u7684\u5fae\u8c03\u6a21\u578b, \u5b83\u5c06\u7531\u4e24\u5c42\u5168\u8fde\u63a5\u7f51\u7edc\u7ec4\u6210, \u4e4b\u540e\u6211\u4eec\u4f1a\u8be6\u7ec6\u4ecb\u7ecd. 8.2 \u8bad\u7ec3\u6570\u636e\u96c6 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u53ca\u5176\u76f8\u5173\u89e3\u91ca. \u4e86\u89e3\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6765\u6e90\u548c\u6269\u5145\u65b9\u5f0f. \u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f: 1 \u8179\u80a1\u6c9f\u6dcb\u5df4\u7ed3\u80bf\u5927\u8179\u80a1\u6c9f\u76ae\u4e0b\u5305\u5757 \u60f3\u8bf7\u60a8\u5e2e\u5fd9\u89e3\u8bfb\u4e00\u4e0b\u4e0a\u9762\u7684b\u8d85\u7ed3\u679c\uff0c\u662f\u5426\u8981\u6cbb\u7597\uff0c\u6216\u505a\u8fdb\u4e00\u6b65\u7684\u68c0\u67e5\uff1f>\u56e0\u4e3a\u505a\u5b8cb\u8d85\u533b\u751f\u4e0b\u73ed\u4e86 1 \u60f3\u8bf7\u60a8\u5e2e\u5fd9\u89e3\u8bfb\u4e00\u4e0b\u4e0a\u9762\u7684b\u8d85\u7ed3\u679c\uff0c\u662f\u5426\u8981\u6cbb\u7597\uff0c\u6216\u505a\u8fdb\u4e00\u6b65\u7684\u68c0\u67e5\uff1f\u56e0\u4e3a\u505a\u5b8cb\u8d85\u533b\u751f\u4e0b\u73ed\u4e86 \u5de6\u4fa7\u7684\u5305 \u5757\u662f\u5426\u662f\u666e\u901a\u7684\u6dcb\u5df4\u7ed3\u80bf\u5927\uff1f 1 \u5de6\u4fa7\u7684\u5305\u5757\u662f\u5426\u662f\u666e\u901a\u7684\u6dcb\u5df4\u7ed3\u80bf\u5927\uff1f \u6309\u538b\u4e0d\u75bc\uff0c\u4f46\u7528\u624b\u6572\u4f1a\u6709\u70b9\u523a\u75db 1 \u6309\u538b\u4e0d\u75bc\uff0c\u4f46\u7528\u624b\u6572\u4f1a\u6709\u70b9\u523a\u75db \uff1f 1 \u6297\u8c2c\u808b\u6c0f\u7ba1\u6fc0\u7d20\u504f\u4f4e\u6297\u7f2a\u808b\u6c0f\u7ba1\u6fc0\u7d20\u504f\u4f4e \u6628\u5929\u540c\u623f\u540e\u51fa\u8840\u4e86\uff0c\u4ee5\u524d\u90fd\u4e0d\u4f1a\uff0c\u5148\u662f\u9c9c\u7ea2\u8272\uff0c\u4eca\u5929\u53d8\u8910\u8272\uff0c\u5c11 \u91cf\uff0c\u4e0d\u60f3\u53bb\u533b\u9662\u68c0\u67e5\uff0c\u8fc7\u51e0\u5929\u5b83\u4f1a\u81ea\u5df1\u505c\u5427\uff1f\u8fd8\u662f\u8981\u5403\u4ec0\u4e48\u836f\uff1f 0 \u6c34\u75d8\u6c34\u75d8\u540e\u7b2c\u4e03\u5929\u8138\u4e0a\u8272\u7d20\u4e25\u91cd \u4e94\u9669\u4e00\u91d1\u4f1a\u4e0b\u8c03\u5417 0 \u817a\u6837\u4f53\u91cd\u5ea6\u80a5\u5927\uff0c\u5206\u6ccc\u6027\u4e2d\u8033\u708e\u5b9d\u5b9d\u817a\u6837\u4f53\u80a5\u5927\u600e\u4e48\u529e \u6211\u7238\u56e0\u8f66\u7978\u6b7b\u4ea1\u610f\u5916\u9669\u80fd\u8d54\u507f\u5417 0 \u5c3f\u8840\u5c3f\u8840\u8fd9\u79cd\u60c5\u51b5\u8981\u6c42\u9ad8\u4e0d\u9ad8\u6cbb\u7597 \u8f66\u8f86\u4fdd\u9669\u7406\u8d54\u56de\u6267\u5f04\u4e22\u4e86\u53ef\u4ee5\u8865\u5417 0 \u5c3f\u8def\u611f\u67d3\u5c3f\u8def\u611f\u67d3\u5907\u5b55\u4e2d \u5728\u5355\u4f4d\u8f9e\u804c\u4e86\uff0c\u5f53\u65f6\u6ca1\u529e\u533b\u4fdd\uff0c\u662f\u5426\u80fd\u7533\u529e\u5c45\u6c11\u533b\u4fdd\uff1f 0 \u773c\u89d2\u6709\u8840\u5757\u5de6\u773c\u89d2\u6709\u8840\u5757\u72b6 \u6709\u8c01\u77e5\u9053\uff0c\u5b89*\u957f*\u6811\u51fa\u9669\u4e86\u9700\u8981\u63d0\u4f9b\u54ea\u4e9b\u533b\u9662\u8bc1\u660e\uff1f \u6570\u636e\u96c6\u7684\u76f8\u5173\u89e3\u91ca: \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e00\u5217\u4ee3\u8868\u6807\u7b7e, 1\u4e3a\u6b63\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u4e24\u53e5\u8bdd\u662f\u5728\u8ba8\u8bba\u540c\u4e00\u4e3b\u9898. 0\u4e3a\u8d1f\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u4e24\u53e5\u8bdd\u4e0d\u76f8\u5173. \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e8c\u5217\u662f\u7528\u6237\u56de\u590d\u7684\u6587\u672c\u4fe1\u606f, \u7b2c\u4e09\u5217\u662f\u4e0e\u4e0a\u4e00\u53e5\u76f8\u5173\u6216\u4e0d\u76f8\u5173\u7684\u6587\u672c. \u6b63\u8d1f\u6837\u672c\u7684\u6bd4\u4f8b\u662f1:1\u5de6\u53f3 \u6570\u636e\u96c6\u6240\u5728\u4f4d\u7f6e: /data/doctor_online/bert_serve/train_data.csv \u6570\u636e\u96c6\u6765\u6e90\u53ca\u5176\u6269\u5145\u65b9\u5f0f: \u6765\u6e90: \u6b63\u6837\u672c\u6570\u636e\u6765\u81ea\u7f51\u7edc\u533b\u60a3\u5728\u7ebf\u95ee\u7b54\u7684\u771f\u5b9e\u8bed\u6599. \u8d1f\u6837\u672c\u6765\u81ea\u5176\u4ed6\u4f7f\u7528\u5176\u4ed6\u95ee\u7b54\u8bed\u6599\u7684\u56de\u590d\u4fe1\u606f, \u4fdd\u8bc1\u4e24\u6bb5\u6587\u672c\u4e0d\u76f8\u5173. \u6269\u5145\u65b9\u5f0f: \u6839\u636e\u6765\u6e90, \u53ef\u901a\u8fc7\u6570\u636e\u6293\u53d6\u6280\u672f\u5bf9\u8bed\u6599\u96c6\u8fdb\u884c\u6269\u5145. 8.3 BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6\u548c\u4f5c\u7528. \u638c\u63e1\u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u8fc7\u7a0b. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b: BERT\u6a21\u578b\u6574\u4f53\u67b6\u6784\u57fa\u4e8eTransformer\u6a21\u578b\u67b6\u6784, BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u89e3\u7801\u5668\u548c\u7f16\u7801\u5668\u5177\u670912\u5c42, \u8f93\u51fa\u5c42\u4e2d\u7684\u7ebf\u6027\u5c42\u5177\u6709768\u4e2a\u8282\u70b9, \u5373\u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u7ef4\u5ea6\u662f768. \u5b83\u4f7f\u7528\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7ed3\u6784\u4e2d, \u5934\u7684\u6570\u91cf\u4e3a12, \u6a21\u578b\u603b\u53c2\u6570\u91cf\u4e3a110M. \u540c\u65f6, \u5b83\u5728\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4e0a\u8fdb\u884c\u8bad\u7ec3, \u56e0\u6b64\u9002\u5408\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4efb\u52a1. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u4f5c\u7528: \u5728\u5b9e\u9645\u7684\u6587\u672c\u4efb\u52a1\u5904\u7406\u4e2d, \u6709\u4e9b\u8bad\u7ec3\u8bed\u6599\u5f88\u96be\u83b7\u5f97, \u4ed6\u4eec\u7684\u603b\u4f53\u6570\u91cf\u548c\u5305\u542b\u7684\u8bcd\u6c47\u603b\u6570\u90fd\u975e\u5e38\u5c11, \u4e0d\u9002\u5408\u7528\u4e8e\u8bad\u7ec3\u5e26\u6709Embedding\u5c42\u7684\u6a21\u578b, \u4f46\u8fd9\u4e9b\u6570\u636e\u4e2d\u5374\u53c8\u8574\u542b\u8fd9\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u89c4\u5f8b\u53ef\u4ee5\u88ab\u6a21\u578b\u6316\u6398, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b,\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9, \u56e0\u4e3a\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u81ea\u5927\u578b\u8bed\u6599, \u80fd\u591f\u4f7f\u5f97\u5f53\u524d\u6587\u672c\u5177\u6709\u610f\u4e49, \u867d\u7136\u8fd9\u4e9b\u610f\u4e49\u53ef\u80fd\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e2a\u7279\u5b9a\u9886\u57df, \u4f46\u662f\u8fd9\u79cd\u7f3a\u9677\u53ef\u4ee5\u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u6765\u8fdb\u884c\u5f25\u8865. \u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u4e24\u4e2a\u53e5\u5b50\u8fdb\u884c\u7f16\u7801: import torch import torch.nn as nn # \u4f7f\u7528torch.hub\u52a0\u8f7dbert\u4e2d\u6587\u6a21\u578b\u7684\u5b57\u6620\u5c04\u5668 tokenizer = torch.hub.load('huggingface/pytorch-transformers', 'tokenizer', 'bert-base-chinese') # \u4f7f\u7528torch.hub\u52a0\u8f7dbert\u4e2d\u6587\u6a21\u578b model = torch.hub.load('huggingface/pytorch-transformers', 'model', 'bert-base-chinese') def get_bert_encode(text_1, text_2, mark=102, max_len=10): \"\"\" description: \u4f7f\u7528bert\u4e2d\u6587\u6a21\u578b\u5bf9\u8f93\u5165\u7684\u6587\u672c\u5bf9\u8fdb\u884c\u7f16\u7801 :param text_1: \u4ee3\u8868\u8f93\u5165\u7684\u7b2c\u4e00\u53e5\u8bdd :param text_2: \u4ee3\u8868\u8f93\u5165\u7684\u7b2c\u4e8c\u53e5\u8bdd :param mark: \u5206\u9694\u6807\u8bb0, \u662f\u9884\u8bad\u7ec3\u6a21\u578btokenizer\u672c\u8eab\u7684\u6807\u8bb0\u7b26\u53f7, \u5f53\u8f93\u5165\u662f\u4e24\u4e2a\u6587\u672c\u65f6, \u5f97\u5230\u7684index_tokens\u4f1a\u4ee5102\u8fdb\u884c\u5206\u9694 :param max_len: \u6587\u672c\u7684\u5141\u8bb8\u6700\u5927\u957f\u5ea6, \u4e5f\u662f\u6587\u672c\u7684\u89c4\u8303\u957f\u5ea6\u5373\u5927\u4e8e\u8be5\u957f\u5ea6\u8981\u88ab\u622a\u65ad, \u5c0f\u4e8e\u8be5\u957f\u5ea6\u8981\u8fdb\u884c0\u8865\u9f50 :return \u8f93\u5165\u6587\u672c\u7684bert\u7f16\u7801 \"\"\" # \u4f7f\u7528tokenizer\u7684encode\u65b9\u6cd5\u5bf9\u8f93\u5165\u7684\u4e24\u53e5\u6587\u672c\u8fdb\u884c\u5b57\u6620\u5c04. indexed_tokens = tokenizer.encode(text_1, text_2) # \u51c6\u5907\u5bf9\u6620\u5c04\u540e\u7684\u6587\u672c\u8fdb\u884c\u89c4\u8303\u957f\u5ea6\u5904\u7406\u5373\u5927\u4e8e\u8be5\u957f\u5ea6\u8981\u88ab\u622a\u65ad, \u5c0f\u4e8e\u8be5\u957f\u5ea6\u8981\u8fdb\u884c0\u8865\u9f50 # \u6240\u4ee5\u9700\u8981\u5148\u627e\u5230\u5206\u9694\u6807\u8bb0\u7684\u7d22\u5f15\u4f4d\u7f6e k = indexed_tokens.index(mark) # \u9996\u5148\u5bf9\u7b2c\u4e00\u53e5\u8bdd\u8fdb\u884c\u957f\u5ea6\u89c4\u8303\u56e0\u6b64\u5c06indexed_tokens\u622a\u53d6\u5230[:k]\u5224\u65ad if len(indexed_tokens[:k]) >= max_len: # \u5982\u679c\u5927\u4e8emax_len, \u5219\u8fdb\u884c\u622a\u65ad indexed_tokens_1 = indexed_tokens[:max_len] else: # \u5426\u5219\u4f7f\u7528[0]\u8fdb\u884c\u8865\u9f50, \u8865\u9f50\u76840\u7684\u4e2a\u6570\u5c31\u662fmax_len-len(indexed_tokens[:k]) indexed_tokens_1 = indexed_tokens[:k] + (max_len-len(indexed_tokens[:k]))*[0] # \u540c\u7406\u4e0b\u9762\u662f\u5bf9\u7b2c\u4e8c\u53e5\u8bdd\u8fdb\u884c\u89c4\u8303\u957f\u5ea6\u5904\u7406, \u56e0\u6b64\u622a\u53d6[k:] if len(indexed_tokens[k:]) >= max_len: # \u5982\u679c\u5927\u4e8emax_len, \u5219\u8fdb\u884c\u622a\u65ad indexed_tokens_2 = indexed_tokens[k:k+max_len] else: # \u5426\u5219\u4f7f\u7528[0]\u8fdb\u884c\u8865\u9f50, \u8865\u9f50\u76840\u7684\u4e2a\u6570\u5c31\u662fmax_len-len(indexed_tokens[:k]) indexed_tokens_2 = indexed_tokens[k:] + (max_len-len(indexed_tokens[k:]))*[0] # \u6700\u540e\u5c06\u5904\u7406\u540e\u7684indexed_tokens_1\u548cindexed_tokens_2\u518d\u8fdb\u884c\u76f8\u52a0 indexed_tokens = indexed_tokens_1 + indexed_tokens_2 # \u4e3a\u4e86\u8ba9\u6a21\u578b\u5728\u7f16\u7801\u65f6\u80fd\u591f\u66f4\u597d\u7684\u533a\u5206\u8fd9\u4e24\u53e5\u8bdd, \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5206\u9694ids, # \u5b83\u662f\u4e00\u4e2a\u4e0eindexed_tokens\u7b49\u957f\u7684\u5411\u91cf, 0\u5143\u7d20\u7684\u4f4d\u7f6e\u4ee3\u8868\u662f\u7b2c\u4e00\u53e5\u8bdd # 1\u5143\u7d20\u7684\u4f4d\u7f6e\u4ee3\u8868\u662f\u7b2c\u4e8c\u53e5\u8bdd, \u957f\u5ea6\u90fd\u662fmax_len segments_ids = [0]*max_len + [1]*max_len # \u5c06segments_ids\u548cindexed_tokens\u8f6c\u6362\u6210\u6a21\u578b\u9700\u8981\u7684\u5f20\u91cf\u5f62\u5f0f segments_tensor = torch.tensor([segments_ids]) tokens_tensor = torch.tensor([indexed_tokens]) # \u6a21\u578b\u4e0d\u81ea\u52a8\u6c42\u89e3\u68af\u5ea6 with torch.no_grad(): # \u4f7f\u7528bert model\u8fdb\u884c\u7f16\u7801, \u4f20\u5165\u53c2\u6570tokens_tensor\u548csegments_tensor\u5f97\u5230encoded_layers encoded_layers, _ = model(tokens_tensor, token_type_ids=segments_tensor) return encoded_layers \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/bert_chinese_encode.py \u8f93\u5165\u53c2\u6570: text_1 = \"\u4eba\u751f\u8be5\u5982\u4f55\u8d77\u5934\" text_2 = \"\u6539\u53d8\u8981\u5982\u4f55\u8d77\u624b\" \u8c03\u7528: encoded_layers = get_bert_encode(text_1, text_2) print(encoded_layers) print(encoded_layers.shape) \u8f93\u51fa\u6548\u679c: tensor([[[ 1.0210, 0.0659, -0.3472, ..., 0.5131, -0.7699, 0.0202], [-0.1966, 0.2660, 0.3689, ..., -0.0650, -0.2853, -0.1777], [ 0.9295, -0.3890, -0.1026, ..., 1.3917, 0.4692, -0.0851], ..., [ 1.4777, 0.7781, -0.4310, ..., 0.7403, 0.2006, -0.1198], [ 0.3867, -0.2031, -0.0721, ..., 1.0050, -0.2479, -0.3525], [ 0.0599, 0.2883, -0.4011, ..., -0.1875, -0.2546, 0.0453]]]) torch.Size([1, 20, 768]) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6\u548c\u4f5c\u7528. \u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u51fd\u6570: get_bert_encode 8.4 \u5fae\u8c03\u6a21\u578b \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u5fae\u8c03\u6a21\u578b\u7684\u4f5c\u7528. \u638c\u63e1\u6784\u5efa\u5168\u8fde\u63a5\u5fae\u8c03\u6a21\u578b\u7684\u8fc7\u7a0b. \u5fae\u8c03\u6a21\u578b\u7684\u4f5c\u7528: \u5fae\u8c03\u6a21\u578b\u4e00\u822c\u7528\u5728\u8fc1\u79fb\u5b66\u4e60\u4e2d\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u4e4b\u540e, \u56e0\u4e3a\u5355\u7eaf\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u5f80\u5f80\u4e0d\u80fd\u9488\u5bf9\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u83b7\u5f97\u9884\u671f\u7ed3\u679c, \u9700\u8981\u901a\u8fc7\u5fae\u8c03\u6a21\u578b\u5728\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u4e0a\u8c03\u8282\u6574\u4f53\u6a21\u578b\u529f\u80fd, \u4f7f\u5176\u9002\u5e94\u5f53\u4e0b\u95ee\u9898. \u6784\u5efa\u5168\u8fde\u63a5\u5fae\u8c03\u6a21\u578b\u7684\u4ee3\u7801\u5206\u6790: import torch import torch.nn as nn import torch.nn.functional as F class Net(nn.Module): \"\"\"\u5b9a\u4e49\u5fae\u8c03\u7f51\u7edc\u7684\u7c7b\"\"\" def __init__(self, char_size=20, embedding_size=768, dropout=0.2): \"\"\" :param char_size: \u8f93\u5165\u53e5\u5b50\u4e2d\u7684\u5b57\u7b26\u6570\u91cf, \u56e0\u4e3a\u89c4\u8303\u540e\u6bcf\u6761\u53e5\u5b50\u957f\u5ea6\u662fmax_len, \u56e0\u6b64char_size\u4e3a2*max_len :param embedding_size: \u5b57\u5d4c\u5165\u7684\u7ef4\u5ea6, \u56e0\u4e3a\u4f7f\u7528\u7684bert\u4e2d\u6587\u6a21\u578b\u5d4c\u5165\u7ef4\u5ea6\u662f768, \u56e0\u6b64embedding_size\u4e3a768 :param dropout: \u4e3a\u4e86\u9632\u6b62\u8fc7\u62df\u5408, \u7f51\u7edc\u4e2d\u5c06\u5f15\u5165Dropout\u5c42, dropout\u4e3a\u7f6e0\u6bd4\u7387, \u9ed8\u8ba4\u662f0.2 \"\"\" super(Net, self).__init__() # \u5c06char_size\u548cembedding_size\u4f20\u5165\u5176\u4e2d self.char_size = char_size self.embedding_size = embedding_size # \u5b9e\u4f8b\u5316\u5316\u5fc5\u8981\u7684\u5c42\u548c\u5c42\u53c2\u6570: # \u5b9e\u4f8b\u5316Dropout\u5c42 self.dropout = nn.Dropout(p=dropout) # \u5b9e\u4f8b\u5316\u7b2c\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42 self.fc1 = nn.Linear(char_size*embedding_size, 8) # \u5b9e\u4f8b\u5316\u7b2c\u4e8c\u4e2a\u5168\u8fde\u63a5\u5c42 self.fc2 = nn.Linear(8, 2) def forward(self, x): # \u5bf9\u8f93\u5165\u7684\u5f20\u91cf\u5f62\u72b6\u8fdb\u884c\u53d8\u6362, \u4ee5\u6ee1\u8db3\u63a5\u4e0b\u6765\u5c42\u7684\u8f93\u5165\u8981\u6c42 x = x.view(-1, self.char_size*self.embedding_size) # \u4f7f\u7528dropout\u5c42 x = self.dropout(x) # \u4f7f\u7528\u7b2c\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42\u5e76\u4f7f\u7528relu\u51fd\u6570 x = F.relu(self.fc1(x)) # \u4f7f\u7528dropout\u5c42 x = self.dropout(x) # \u4f7f\u7528\u7b2c\u4e8c\u4e2a\u5168\u8fde\u63a5\u5c42\u5e76\u4f7f\u7528relu\u51fd\u6570 x = F.relu(self.fc2(x)) return x \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/finetuning_net.py \u5b9e\u4f8b\u5316\u53c2\u6570: embedding_size = 768 char_size = 20 dropout = 0.2 \u8f93\u5165\u53c2\u6570: x = torch.randn(1, 20, 768) \u8c03\u7528: net = Net(char_size, embedding_size, dropout) nr = net(x) print(nr) \u8f93\u51fa\u6548\u679c: tensor([[0.0000, 0.4061]], grad_fn=<ReluBackward0>) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u5fae\u8c03\u6a21\u578b\u7684\u4f5c\u7528: \u5fae\u8c03\u6a21\u578b\u4e00\u822c\u7528\u5728\u8fc1\u79fb\u5b66\u4e60\u4e2d\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u4e4b\u540e, \u56e0\u4e3a\u5355\u7eaf\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u5f80\u5f80\u4e0d\u80fd\u9488\u5bf9\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u83b7\u5f97\u9884\u671f\u7ed3\u679c, \u9700\u8981\u901a\u8fc7\u5fae\u8c03\u6a21\u578b\u5728\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u4e0a\u8c03\u8282\u6574\u4f53\u6a21\u578b\u529f\u80fd, \u4f7f\u5176\u9002\u5e94\u5f53\u4e0b\u95ee\u9898. \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86\u6784\u5efa\u5168\u8fde\u63a5\u5fae\u8c03\u6a21\u578b\u7684\u7c7b: class Net(nn.Module) 8.5 \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3 \u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4. \u638c\u63e1\u6a21\u578b\u8bad\u7ec3\u4e2d\u6bcf\u4e2a\u6b65\u9aa4\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u6570\u636e\u52a0\u8f7d\u5668\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58. \u7b2c\u4e00\u6b65: \u6784\u5efa\u6570\u636e\u52a0\u8f7d\u5668\u51fd\u6570 import pandas as pd from sklearn.utils import shuffle from functools import reduce from collections import Counter from bert_chinese_encode import get_bert_encode import torch import torch.nn as nn def data_loader(data_path, batch_size, split=0.2): \"\"\" description: \u4ece\u6301\u4e45\u5316\u6587\u4ef6\u4e2d\u52a0\u8f7d\u6570\u636e, \u5e76\u5212\u5206\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u53ca\u5176\u6279\u6b21\u5927\u5c0f :param data_path: \u8bad\u7ec3\u6570\u636e\u7684\u6301\u4e45\u5316\u8def\u5f84 :param batch_size: \u8bad\u7ec3\u548c\u9a8c\u8bc1\u6570\u636e\u96c6\u7684\u6279\u6b21\u5927\u5c0f :param split: \u8bad\u7ec3\u96c6\u4e0e\u9a8c\u8bc1\u7684\u5212\u5206\u6bd4\u4f8b :return: \u8bad\u7ec3\u6570\u636e\u751f\u6210\u5668, \u9a8c\u8bc1\u6570\u636e\u751f\u6210\u5668, \u8bad\u7ec3\u6570\u636e\u6570\u91cf, \u9a8c\u8bc1\u6570\u636e\u6570\u91cf \"\"\" # \u4f7f\u7528pd\u8fdb\u884ccsv\u6570\u636e\u7684\u8bfb\u53d6 data = pd.read_csv(data_path, header=None, sep=\"\\t\") # \u6253\u5370\u6574\u4f53\u6570\u636e\u96c6\u4e0a\u7684\u6b63\u8d1f\u6837\u672c\u6570\u91cf print(\"\u6570\u636e\u96c6\u7684\u6b63\u8d1f\u6837\u672c\u6570\u91cf:\") print(dict(Counter(data[0].values))) # \u6253\u4e71\u6570\u636e\u96c6\u7684\u987a\u5e8f data = shuffle(data).reset_index(drop=True) # \u5212\u5206\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6 split_point = int(len(data)*split) valid_data = data[:split_point] train_data = data[split_point:] # \u9a8c\u8bc1\u6570\u636e\u96c6\u4e2d\u7684\u6570\u636e\u603b\u6570\u81f3\u5c11\u80fd\u591f\u6ee1\u8db3\u4e00\u4e2a\u6279\u6b21 if len(valid_data) < batch_size: raise(\"Batch size or split not match!\") def _loader_generator(data): \"\"\" description: \u83b7\u5f97\u8bad\u7ec3\u96c6/\u9a8c\u8bc1\u96c6\u7684\u6bcf\u4e2a\u6279\u6b21\u6570\u636e\u7684\u751f\u6210\u5668 :param data: \u8bad\u7ec3\u6570\u636e\u6216\u9a8c\u8bc1\u6570\u636e :return: \u4e00\u4e2a\u6279\u6b21\u7684\u8bad\u7ec3\u6570\u636e\u6216\u9a8c\u8bc1\u6570\u636e\u7684\u751f\u6210\u5668 \"\"\" # \u4ee5\u6bcf\u4e2a\u6279\u6b21\u7684\u95f4\u9694\u904d\u5386\u6570\u636e\u96c6 for batch in range(0, len(data), batch_size): # \u9884\u5b9a\u4e8ebatch\u6570\u636e\u7684\u5f20\u91cf\u5217\u8868 batch_encoded = [] batch_labels = [] # \u5c06\u4e00\u4e2abitch_size\u5927\u5c0f\u7684\u6570\u636e\u8f6c\u6362\u6210\u5217\u8868\u5f62\u5f0f\uff0c[[label, text_1, text_2]] # \u5e76\u8fdb\u884c\u9010\u6761\u904d\u5386 for item in data[batch: batch+batch_size].values.tolist(): # \u6bcf\u6761\u6570\u636e\u4e2d\u90fd\u5305\u542b\u4e24\u53e5\u8bdd, \u4f7f\u7528bert\u4e2d\u6587\u6a21\u578b\u8fdb\u884c\u7f16\u7801 encoded = get_bert_encode(item[1], item[2]) # \u5c06\u7f16\u7801\u540e\u7684\u6bcf\u6761\u6570\u636e\u88c5\u8fdb\u9884\u5148\u5b9a\u4e49\u597d\u7684\u5217\u8868\u4e2d batch_encoded.append(encoded) # \u540c\u6837\u5c06\u5bf9\u5e94\u7684\u8be5batch\u7684\u6807\u7b7e\u88c5\u8fdblabels\u5217\u8868\u4e2d batch_labels.append([item[0]]) # \u4f7f\u7528reduce\u9ad8\u9636\u51fd\u6570\u5c06\u5217\u8868\u4e2d\u7684\u6570\u636e\u8f6c\u6362\u6210\u6a21\u578b\u9700\u8981\u7684\u5f20\u91cf\u5f62\u5f0f # encoded\u7684\u5f62\u72b6\u662f(batch_size, 2*max_len, embedding_size) encoded = reduce(lambda x, y : torch.cat((x, y), dim=0), batch_encoded) labels = torch.tensor(reduce(lambda x, y : x + y, batch_labels)) # \u4ee5\u751f\u6210\u5668\u7684\u65b9\u5f0f\u8fd4\u56de\u6570\u636e\u548c\u6807\u7b7e yield (encoded, labels) # \u5bf9\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u5206\u522b\u4f7f\u7528_loader_generator\u51fd\u6570, \u8fd4\u56de\u5bf9\u5e94\u7684\u751f\u6210\u5668 # \u6700\u540e\u8fd8\u8981\u8fd4\u56de\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u6837\u672c\u6570\u91cf return _loader_generator(train_data), _loader_generator(valid_data), len(train_data), len(valid_data) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8f93\u5165\u53c2\u6570: # \u6570\u636e\u6240\u5728\u8def\u5f84 data_path = \"./train_data.csv\" # \u5b9a\u4e49batch_size\u5927\u5c0f batch_size = 32 \u8c03\u7528: train_data_labels, valid_data_labels, \\ train_data_len, valid_data_len = data_loader(data_path, batch_size) print(next(train_data_labels)) print(next(valid_data_labels)) print(\"train_data_len:\", train_data_len) print(\"valid_data_len:\", valid_data_len) \u8f93\u51fa\u6548\u679c: (tensor([[[-0.7295, 0.8199, 0.8320, ..., 0.0933, 1.2171, 0.4833], [ 0.8707, 1.0131, -0.2556, ..., 0.2179, -1.0671, 0.1946], [ 0.0344, -0.5605, -0.5658, ..., 1.0855, -0.9122, 0.0222]]], tensor([0, 0, 1, 1, 1, 1, 0, 1, 0, 0, ..., 1, 0, 1, 0, 1, 1, 1, 1])) (tensor([[[-0.5263, -0.3897, -0.5725, ..., 0.5523, -0.2289, -0.8796], [ 0.0468, -0.5291, -0.0247, ..., 0.4221, -0.2501, -0.0796], [-0.2133, -0.5552, -0.0584, ..., -0.8031, 0.1753, -0.3476]]]), tensor([0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, ..., 0, 0, 1, 0, 1,1, 1])) train_data_len: 22186 valid_data_len: 5546 \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570 # \u52a0\u8f7d\u5fae\u8c03\u7f51\u7edc from finetuning_net import Net import torch.optim as optim # \u5b9a\u4e49embedding_size, char_size embedding_size = 768 char_size = 2 * max_len # \u5b9e\u4f8b\u5316\u5fae\u8c03\u7f51\u7edc net = Net(embedding_size, char_size) # \u5b9a\u4e49\u4ea4\u53c9\u71b5\u635f\u5931\u51fd\u6570 criterion = nn.CrossEntropyLoss() # \u5b9a\u4e49SGD\u4f18\u5316\u65b9\u6cd5 optimizer = optim.SGD(net.parameters(), lr=0.001, momentum=0.9) def train(train_data_labels): \"\"\" description: \u8bad\u7ec3\u51fd\u6570, \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u5c06\u66f4\u65b0\u6a21\u578b\u53c2\u6570, \u5e76\u6536\u96c6\u51c6\u786e\u7387\u548c\u635f\u5931 :param train_data_labels: \u8bad\u7ec3\u6570\u636e\u548c\u6807\u7b7e\u7684\u751f\u6210\u5668\u5bf9\u8c61 :return: \u6574\u4e2a\u8bad\u7ec3\u8fc7\u7a0b\u7684\u5e73\u5747\u635f\u5931\u4e4b\u548c\u4ee5\u53ca\u6b63\u786e\u6807\u7b7e\u7684\u7d2f\u52a0\u6570 \"\"\" # \u5b9a\u4e49\u8bad\u7ec3\u8fc7\u7a0b\u7684\u521d\u59cb\u635f\u5931\u548c\u51c6\u786e\u7387\u7d2f\u52a0\u6570 train_running_loss = 0.0 train_running_acc = 0.0 # \u5faa\u73af\u904d\u5386\u8bad\u7ec3\u6570\u636e\u548c\u6807\u7b7e\u751f\u6210\u5668, \u6bcf\u4e2a\u6279\u6b21\u66f4\u65b0\u4e00\u6b21\u6a21\u578b\u53c2\u6570 for train_tensor, train_labels in train_data_labels: # \u521d\u59cb\u5316\u8be5\u6279\u6b21\u7684\u4f18\u5316\u5668 optimizer.zero_grad() # \u4f7f\u7528\u5fae\u8c03\u7f51\u7edc\u83b7\u5f97\u8f93\u51fa train_outputs = net(train_tensor) # \u5f97\u5230\u8be5\u6279\u6b21\u4e0b\u7684\u5e73\u5747\u635f\u5931 train_loss = criterion(train_outputs, train_labels) # \u5c06\u8be5\u6279\u6b21\u7684\u5e73\u5747\u635f\u5931\u52a0\u5230train_running_loss\u4e2d train_running_loss += train_loss.item() # \u635f\u5931\u53cd\u5411\u4f20\u64ad train_loss.backward() # \u4f18\u5316\u5668\u66f4\u65b0\u6a21\u578b\u53c2\u6570 optimizer.step() # \u5c06\u8be5\u6279\u6b21\u4e2d\u6b63\u786e\u7684\u6807\u7b7e\u6570\u91cf\u8fdb\u884c\u7d2f\u52a0, \u4ee5\u4fbf\u4e4b\u540e\u8ba1\u7b97\u51c6\u786e\u7387 train_running_acc += (train_outputs.argmax(1) == train_labels).sum().item() return train_running_loss, train_running_acc \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u7b2c\u4e09\u6b65: \u6a21\u578b\u9a8c\u8bc1\u51fd\u6570 def valid(valid_data_labels): \"\"\" description: \u9a8c\u8bc1\u51fd\u6570, \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u5c06\u9a8c\u8bc1\u6a21\u578b\u7684\u5728\u65b0\u6570\u636e\u96c6\u4e0a\u7684\u6807\u7b7e, \u6536\u96c6\u635f\u5931\u548c\u51c6\u786e\u7387 :param valid_data_labels: \u9a8c\u8bc1\u6570\u636e\u548c\u6807\u7b7e\u7684\u751f\u6210\u5668\u5bf9\u8c61 :return: \u6574\u4e2a\u9a8c\u8bc1\u8fc7\u7a0b\u7684\u5e73\u5747\u635f\u5931\u4e4b\u548c\u4ee5\u53ca\u6b63\u786e\u6807\u7b7e\u7684\u7d2f\u52a0\u6570 \"\"\" # \u5b9a\u4e49\u8bad\u7ec3\u8fc7\u7a0b\u7684\u521d\u59cb\u635f\u5931\u548c\u51c6\u786e\u7387\u7d2f\u52a0\u6570 valid_running_loss = 0.0 valid_running_acc = 0.0 # \u5faa\u73af\u904d\u5386\u9a8c\u8bc1\u6570\u636e\u548c\u6807\u7b7e\u751f\u6210\u5668 for valid_tensor, valid_labels in valid_data_labels: # \u4e0d\u81ea\u52a8\u66f4\u65b0\u68af\u5ea6 with torch.no_grad(): # \u4f7f\u7528\u5fae\u8c03\u7f51\u7edc\u83b7\u5f97\u8f93\u51fa valid_outputs = net(valid_tensor) # \u5f97\u5230\u8be5\u6279\u6b21\u4e0b\u7684\u5e73\u5747\u635f\u5931 valid_loss = criterion(valid_outputs, valid_labels) # \u5c06\u8be5\u6279\u6b21\u7684\u5e73\u5747\u635f\u5931\u52a0\u5230valid_running_loss\u4e2d valid_running_loss += valid_loss.item() # \u5c06\u8be5\u6279\u6b21\u4e2d\u6b63\u786e\u7684\u6807\u7b7e\u6570\u91cf\u8fdb\u884c\u7d2f\u52a0, \u4ee5\u4fbf\u4e4b\u540e\u8ba1\u7b97\u51c6\u786e\u7387 valid_running_acc += (valid_outputs.argmax(1) == valid_labels).sum().item() return valid_running_loss, valid_running_acc \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7 # \u5b9a\u4e49\u8bad\u7ec3\u8f6e\u6570 epochs = 20 # \u5b9a\u4e49\u76db\u88c5\u6bcf\u8f6e\u6b21\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5217\u8868, \u7528\u4e8e\u5236\u56fe all_train_losses = [] all_valid_losses = [] all_train_acc = [] all_valid_acc = [] # \u8fdb\u884c\u6307\u5b9a\u8f6e\u6b21\u7684\u8bad\u7ec3 for epoch in range(epochs): # \u6253\u5370\u8f6e\u6b21 print(\"Epoch:\", epoch + 1) # \u901a\u8fc7\u6570\u636e\u52a0\u8f7d\u5668\u83b7\u5f97\u8bad\u7ec3\u6570\u636e\u548c\u9a8c\u8bc1\u6570\u636e\u751f\u6210\u5668, \u4ee5\u53ca\u5bf9\u5e94\u7684\u6837\u672c\u6570\u91cf train_data_labels, valid_data_labels, train_data_len, valid_data_len = data_loader(data_path, batch_size) # \u8c03\u7528\u8bad\u7ec3\u51fd\u6570\u8fdb\u884c\u8bad\u7ec3 train_running_loss, train_running_acc = train(train_data_labels) # \u8c03\u7528\u9a8c\u8bc1\u51fd\u6570\u8fdb\u884c\u9a8c\u8bc1 valid_running_loss, valid_running_acc = valid(valid_data_labels) # \u8ba1\u7b97\u6bcf\u4e00\u8f6e\u7684\u5e73\u5747\u635f\u5931, train_running_loss\u548cvalid_running_loss\u662f\u6bcf\u4e2a\u6279\u6b21\u7684\u5e73\u5747\u635f\u5931\u4e4b\u548c # \u56e0\u6b64\u5c06\u5b83\u4eec\u4e58\u4ee5batch_size\u5c31\u5f97\u5230\u4e86\u8be5\u8f6e\u7684\u603b\u635f\u5931, \u9664\u4ee5\u6837\u672c\u6570\u5373\u8be5\u8f6e\u6b21\u7684\u5e73\u5747\u635f\u5931 train_average_loss = train_running_loss * batch_size / train_data_len valid_average_loss = valid_running_loss * batch_size / valid_data_len # train_running_acc\u548cvalid_running_acc\u662f\u6bcf\u4e2a\u6279\u6b21\u7684\u6b63\u786e\u6807\u7b7e\u7d2f\u52a0\u548c, # \u56e0\u6b64\u53ea\u9700\u9664\u4ee5\u5bf9\u5e94\u6837\u672c\u603b\u6570\u5373\u662f\u8be5\u8f6e\u6b21\u7684\u51c6\u786e\u7387 train_average_acc = train_running_acc / train_data_len valid_average_acc = valid_running_acc / valid_data_len # \u5c06\u8be5\u8f6e\u6b21\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u88c5\u8fdb\u5168\u5c40\u635f\u5931\u548c\u51c6\u786e\u7387\u5217\u8868\u4e2d, \u4ee5\u4fbf\u5236\u56fe all_train_losses.append(train_average_loss) all_valid_losses.append(valid_average_loss) all_train_acc.append(train_average_acc) all_valid_acc.append(valid_average_acc) # \u6253\u5370\u8be5\u8f6e\u6b21\u4e0b\u7684\u8bad\u7ec3\u635f\u5931\u548c\u51c6\u786e\u7387\u4ee5\u53ca\u9a8c\u8bc1\u635f\u5931\u548c\u51c6\u786e\u7387 print(\"Train Loss:\", train_average_loss, \"|\", \"Train Acc:\", train_average_acc) print(\"Valid Loss:\", valid_average_loss, \"|\", \"Valid Acc:\", valid_average_acc) print('Finished Training') \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8f93\u51fa\u6548\u679c: Epoch: 1 Train Loss: 0.693169563147374 | Train Acc: 0.5084898843930635 Valid Loss: 0.6931480603018824 | Valid Acc: 0.5042777377521613 {1: 14015, 0: 13720} Epoch: 2 Train Loss: 0.6931440165277162 | Train Acc: 0.514992774566474 Valid Loss: 0.6931474804019379 | Valid Acc: 0.5026567002881844 {1: 14015, 0: 13720} Epoch: 3 Train Loss: 0.6931516138804441 | Train Acc: 0.5 Valid Loss: 0.69314516217633 | Valid Acc: 0.5065291786743515 {1: 14015, 0: 13720} Epoch: 4 Train Loss: 0.6931474804878235 | Train Acc: 0.5065028901734104 Valid Loss: 0.6931472256650842 | Valid Acc: 0.5052233429394812 {1: 14015, 0: 13720} Epoch: 5 Train Loss: 0.6931474804878235 | Train Acc: 0.5034320809248555 Valid Loss: 0.6931475739314165 | Valid Acc: 0.5055385446685879 {1: 14015, 0: 13720} Epoch: 6 Train Loss: 0.6931492934337241 | Train Acc: 0.5126445086705202 Valid Loss: 0.6931462547277512 | Valid Acc: 0.5033771613832853 {1: 14015, 0: 13720} Epoch: 7 Train Loss: 0.6931459204309938 | Train Acc: 0.5095736994219653 Valid Loss: 0.6931174922229921 | Valid Acc: 0.5065742074927954 {1: 14015, 0: 13720} Epoch: 8 Train Loss: 0.5545259035391614 | Train Acc: 0.759393063583815 Valid Loss: 0.4199462383770805 | Valid Acc: 0.9335374639769453 {1: 14015, 0: 13720} Epoch: 9 Train Loss: 0.4011955714294676 | Train Acc: 0.953757225433526 Valid Loss: 0.3964169790877045 | Valid Acc: 0.9521793948126801 {1: 14015, 0: 13720} Epoch: 10 Train Loss: 0.3893018603497158 | Train Acc: 0.9669436416184971 Valid Loss: 0.3928600374491139 | Valid Acc: 0.9525846541786743 {1: 14015, 0: 13720} Epoch: 11 Train Loss: 0.3857506763383832 | Train Acc: 0.9741690751445087 Valid Loss: 0.38195425426582097 | Valid Acc: 0.9775306195965417 {1: 14015, 0: 13720} Epoch: 12 Train Loss: 0.38368317760484066 | Train Acc: 0.9772398843930635 Valid Loss: 0.37680484129046155 | Valid Acc: 0.9780259365994236 {1: 14015, 0: 13720} Epoch: 13 Train Loss: 0.37407022137517876 | Train Acc: 0.9783236994219653 Valid Loss: 0.3750278927192564 | Valid Acc: 0.9792867435158501 {1: 14015, 0: 13720} Epoch: 14 Train Loss: 0.3707401707682306 | Train Acc: 0.9801300578034682 Valid Loss: 0.37273150721097886 | Valid Acc: 0.9831592219020173 {1: 14015, 0: 13720} Epoch: 15 Train Loss: 0.37279492521906177 | Train Acc: 0.9817557803468208 Valid Loss: 0.3706809586123362 | Valid Acc: 0.9804574927953891 {1: 14015, 0: 13720} Epoch: 16 Train Loss: 0.37660940017314315 | Train Acc: 0.9841040462427746 Valid Loss: 0.3688154769390392 | Valid Acc: 0.984600144092219 {1: 14015, 0: 13720} Epoch: 17 Train Loss: 0.3749892661681754 | Train Acc: 0.9841040462427746 Valid Loss: 0.3688570175760074 | Valid Acc: 0.9817633285302594 {1: 14015, 0: 13720} Epoch: 18 Train Loss: 0.37156562515765945 | Train Acc: 0.9826589595375722 Valid Loss: 0.36880484627028365 | Valid Acc: 0.9853656340057637 {1: 14015, 0: 13720} Epoch: 19 Train Loss: 0.3674713007976554 | Train Acc: 0.9830202312138728 Valid Loss: 0.366314563545954 | Valid Acc: 0.9850954610951008 {1: 14015, 0: 13720} Epoch: 20 Train Loss: 0.36878046806837095 | Train Acc: 0.9842846820809249 Valid Loss: 0.367835852100114 | Valid Acc: 0.9793317723342939 Finished Training \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf # \u5bfc\u5165\u5236\u56fe\u5de5\u5177\u5305 import matplotlib.pyplot as plt from matplotlib.pyplot import MultipleLocator # \u521b\u5efa\u7b2c\u4e00\u5f20\u753b\u5e03 plt.figure(0) # \u7ed8\u5236\u8bad\u7ec3\u635f\u5931\u66f2\u7ebf plt.plot(all_train_losses, label=\"Train Loss\") # \u7ed8\u5236\u9a8c\u8bc1\u635f\u5931\u66f2\u7ebf, \u989c\u8272\u4e3a\u7ea2\u8272 plt.plot(all_valid_losses, color=\"red\", label=\"Valid Loss\") # \u5b9a\u4e49\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694\u5bf9\u8c61, \u95f4\u9694\u4e3a1, \u4ee3\u8868\u6bcf\u4e00\u8f6e\u6b21 x_major_locator=MultipleLocator(1) # \u83b7\u5f97\u5f53\u524d\u5750\u6807\u56fe\u53e5\u67c4 ax=plt.gca() # \u8bbe\u7f6e\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694 ax.xaxis.set_major_locator(x_major_locator) # \u8bbe\u7f6e\u6a2a\u5750\u6807\u53d6\u503c\u8303\u56f4 plt.xlim(1,epochs) # \u66f2\u7ebf\u8bf4\u660e\u5728\u5de6\u4e0a\u65b9 plt.legend(loc='upper left') # \u4fdd\u5b58\u56fe\u7247 plt.savefig(\"./loss.png\") # \u521b\u5efa\u7b2c\u4e8c\u5f20\u753b\u5e03 plt.figure(1) # \u7ed8\u5236\u8bad\u7ec3\u51c6\u786e\u7387\u66f2\u7ebf plt.plot(all_train_acc, label=\"Train Acc\") # \u7ed8\u5236\u9a8c\u8bc1\u51c6\u786e\u7387\u66f2\u7ebf, \u989c\u8272\u4e3a\u7ea2\u8272 plt.plot(all_valid_acc, color=\"red\", label=\"Valid Acc\") # \u5b9a\u4e49\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694\u5bf9\u8c61, \u95f4\u9694\u4e3a1, \u4ee3\u8868\u6bcf\u4e00\u8f6e\u6b21 x_major_locator=MultipleLocator(1) # \u83b7\u5f97\u5f53\u524d\u5750\u6807\u56fe\u53e5\u67c4 ax=plt.gca() # \u8bbe\u7f6e\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694 ax.xaxis.set_major_locator(x_major_locator) # \u8bbe\u7f6e\u6a2a\u5750\u6807\u53d6\u503c\u8303\u56f4 plt.xlim(1,epochs) # \u66f2\u7ebf\u8bf4\u660e\u5728\u5de6\u4e0a\u65b9 plt.legend(loc='upper left') # \u4fdd\u5b58\u56fe\u7247 plt.savefig(\"./acc.png\") \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u5bf9\u7167\u66f2\u7ebf: \u8bad\u7ec3\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u6839\u636e\u635f\u5931\u5bf9\u7167\u66f2\u7ebf, \u5fae\u8c03\u6a21\u578b\u5728\u7b2c6\u8f6e\u5de6\u53f3\u5f00\u59cb\u638c\u63e1\u6570\u636e\u89c4\u5f8b\u8fc5\u901f\u4e0b\u964d, \u8bf4\u660e\u6a21\u578b\u80fd\u591f\u4ece\u6570\u636e\u4e2d\u83b7\u53d6\u8bed\u6599\u7279\u5f81\uff0c\u6b63\u5728\u6536\u655b. \u6839\u636e\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf\u4e2d\u9a8c\u8bc1\u51c6\u786e\u7387\u5728\u7b2c10\u8f6e\u5de6\u53f3\u533a\u57df\u7a33\u5b9a\uff0c\u6700\u7ec8\u7ef4\u6301\u572898%\u5de6\u53f3. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58 # \u6a21\u578b\u4fdd\u5b58\u65f6\u95f4 time_ = int(time.time()) # \u4fdd\u5b58\u8def\u5f84 MODEL_PATH = './model/BERT_net_%d.pth' % time_ # \u4fdd\u5b58\u6a21\u578b\u53c2\u6570 torch.save(rnn.state_dict(), MODEL_PATH) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8f93\u51fa\u6548\u679c: \u5728/data/bert_serve/\u8def\u5f84\u4e0b\u751f\u6210BERT_net_ + \u65f6\u95f4\u6233.pth\u7684\u6587\u4ef6. \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u6570\u636e\u52a0\u8f7d\u5668\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58. 8.6 \u6a21\u578b\u90e8\u7f72 \u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u4f7f\u7528Flask\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u90e8\u7f72\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u4f7f\u7528Flask\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u90e8\u7f72\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u90e8\u7f72\u6a21\u578b\u9884\u6d4b\u4ee3\u7801. \u7b2c\u4e8c\u6b65: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1. \u7b2c\u4e09\u6b65: \u8fdb\u884c\u6d4b\u8bd5. \u7b2c\u4e00\u6b65: \u90e8\u7f72\u6a21\u578b\u9884\u6d4b\u4ee3\u7801 from flask import Flask from flask import request app = Flask(__name__) import torch # \u5bfc\u5165\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7f16\u7801\u51fd\u6570 from bert_chinese_encode import get_bert_encode # \u5bfc\u5165\u5fae\u8c03\u7f51\u7edc from finetuning_net import Net # \u5bfc\u5165\u8bad\u7ec3\u597d\u7684\u6a21\u578b MODEL_PATH = \"./model/BERT_net.pth\" # \u5b9a\u4e49\u5b9e\u4f8b\u5316\u6a21\u578b\u53c2\u6570 embedding_size = 768 char_size = 20 dropout = 0.2 # \u521d\u59cb\u5316\u5fae\u8c03\u7f51\u7edc\u6a21\u578b net = Net(embedding_size, char_size, dropout) # \u52a0\u8f7d\u6a21\u578b\u53c2\u6570 net.load_state_dict(torch.load(MODEL_PATH)) # \u4f7f\u7528\u8bc4\u4f30\u6a21\u5f0f net.eval() # \u5b9a\u4e49\u670d\u52a1\u8bf7\u6c42\u8def\u5f84\u548c\u65b9\u5f0f @app.route('/v1/recognition/', methods=[\"POST\"]) def recognition(): # \u63a5\u6536\u6570\u636e text_1 = request.form['text1'] text_2 = request.form['text2'] # \u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801 inputs = get_bert_encode(text_1, text_2, mark=102, max_len=10) # \u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u8fdb\u884c\u9884\u6d4b outputs = net(inputs) # \u83b7\u5f97\u9884\u6d4b\u7ed3\u679c _, predicted = torch.max(outputs, 1) # \u8fd4\u56de\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u7ed3\u679c return str(predicted.item()) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/app.py \u7b2c\u4e8c\u6b65: \u542f\u52a8\u670d\u52a1 gunicorn -w 1 -b 0.0.0.0:5001 app:app \u7b2c\u4e09\u6b65: \u8fdb\u884c\u6d4b\u8bd5 \u6d4b\u8bd5\u811a\u672c: import requests url = \"http://0.0.0.0:5001/v1/recognition/\" data = {\"text1\":\"\u4eba\u751f\u8be5\u5982\u4f55\u8d77\u5934\", \"text2\": \"\u6539\u53d8\u8981\u5982\u4f55\u8d77\u624b\"} res = requests.post(url, data=data) print(\"\u9884\u6d4b\u6837\u672c:\", data[\"text_1\"], \"|\", data[\"text_2\"]) print(\"\u9884\u6d4b\u7ed3\u679c:\", res.text) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/test.py \u8fd0\u884c\u811a\u672c: python test.py \u8f93\u51fa\u6548\u679c: \u9884\u6d4b\u6837\u672c: \u4eba\u751f\u8be5\u5982\u4f55\u8d77\u5934 | \u6539\u53d8\u8981\u5982\u4f55\u8d77\u624b \u9884\u6d4b\u7ed3\u679c: 1 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u4f7f\u7528Flask\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u90e8\u7f72\u7684\u5b9e\u73b0\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u90e8\u7f72\u6a21\u578b\u9884\u6d4b\u4ee3\u7801. \u7b2c\u4e8c\u6b65: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1. \u7b2c\u4e09\u6b65: \u8fdb\u884c\u6d4b\u8bd5.","title":"\u7b2c\u516b\u7ae0:\u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1"},{"location":"8/#81","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1\u7684\u76f8\u5173\u77e5\u8bc6. \u4e86\u89e3\u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0. \u53e5\u5b50\u4e3b\u9898\u76f8\u5173\u4efb\u52a1: \u5728\u591a\u8f6e\u5bf9\u8bdd\u7cfb\u7edf\u4e2d, \u5f80\u5f80\u9700\u8981\u5224\u65ad\u7528\u6237\u7684\u6700\u8fd1\u4e24\u6b21\u56de\u590d\u662f\u5426\u56f4\u7ed5\u540c\u4e00\u4e3b\u9898, \u6765\u51b3\u5b9a\u95ee\u7b54\u673a\u5668\u4eba\u662f\u5426\u4e5f\u6839\u636e\u81ea\u5df1\u4e0a\u4e00\u6b21\u7684\u56de\u590d\u6765\u8ba8\u8bba\u76f8\u5173\u5185\u5bb9. \u5728\u7ebf\u533b\u751f\u95ee\u7b54\u8fc7\u7a0b\u4e2d, \u540c\u6837\u9700\u8981\u8fd9\u6837\u7684\u5904\u7406, \u786e\u4fdd\u7528\u6237\u4e00\u76f4\u8ba8\u8bba\u75be\u75c5\u6709\u5173\u7684\u5185\u5bb9, \u6765\u6839\u636e\u75c7\u72b6\u63a8\u65ad\u75c5\u60c5. \u8fd9\u79cd\u4efb\u52a1\u7684\u5f62\u5f0f\u4e0e\u5224\u65ad\u4e24\u4e2a\u53e5\u5b50\u662f\u5426\u8fde\u8d2f\u7684\u5f62\u5f0f\u76f8\u540c, \u4ed6\u4eec\u90fd\u9700\u8981\u8f93\u5165\u4e24\u6bb5\u6587\u672c\u5185\u5bb9, \u8fd4\u56de'\u662f'\u6216'\u5426'\u7684\u4e8c\u5206\u7c7b\u6807\u7b7e. \u9009\u7528\u7684\u6a21\u578b\u53ca\u5176\u539f\u56e0: \u5bf9\u8bdd\u7cfb\u7edf\u662f\u5f00\u653e\u7684\u8bed\u8a00\u5904\u7406\u7cfb\u7edf, \u53ef\u80fd\u51fa\u73b0\u5404\u79cd\u6587\u5b57, \u5f53\u6211\u4eec\u7684\u8bad\u7ec3\u96c6\u6709\u9650\u65e0\u6cd5\u8986\u76d6\u5927\u591a\u6570\u60c5\u51b5\u65f6, \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u8fdb\u884c\u6587\u5b57\u8868\u793a. \u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86bert-chinese\u9884\u8bad\u7ec3\u6a21\u578b, \u540c\u65f6\u4e3a\u4e86\u9002\u5e94\u6211\u4eec\u7814\u7a76\u7684\u5782\u76f4\u9886\u57df, \u6211\u4eec\u5728\u540e\u9762\u81ea\u5b9a\u4e49\u6d45\u5c42\u7684\u5fae\u8c03\u6a21\u578b, \u5b83\u5c06\u7531\u4e24\u5c42\u5168\u8fde\u63a5\u7f51\u7edc\u7ec4\u6210, \u4e4b\u540e\u6211\u4eec\u4f1a\u8be6\u7ec6\u4ecb\u7ecd.","title":"8.1 \u4efb\u52a1\u4ecb\u7ecd\u4e0e\u6a21\u578b\u9009\u7528"},{"location":"8/#82","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f\u53ca\u5176\u76f8\u5173\u89e3\u91ca. \u4e86\u89e3\u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6765\u6e90\u548c\u6269\u5145\u65b9\u5f0f. \u8bad\u7ec3\u6570\u636e\u96c6\u7684\u6837\u5f0f: 1 \u8179\u80a1\u6c9f\u6dcb\u5df4\u7ed3\u80bf\u5927\u8179\u80a1\u6c9f\u76ae\u4e0b\u5305\u5757 \u60f3\u8bf7\u60a8\u5e2e\u5fd9\u89e3\u8bfb\u4e00\u4e0b\u4e0a\u9762\u7684b\u8d85\u7ed3\u679c\uff0c\u662f\u5426\u8981\u6cbb\u7597\uff0c\u6216\u505a\u8fdb\u4e00\u6b65\u7684\u68c0\u67e5\uff1f>\u56e0\u4e3a\u505a\u5b8cb\u8d85\u533b\u751f\u4e0b\u73ed\u4e86 1 \u60f3\u8bf7\u60a8\u5e2e\u5fd9\u89e3\u8bfb\u4e00\u4e0b\u4e0a\u9762\u7684b\u8d85\u7ed3\u679c\uff0c\u662f\u5426\u8981\u6cbb\u7597\uff0c\u6216\u505a\u8fdb\u4e00\u6b65\u7684\u68c0\u67e5\uff1f\u56e0\u4e3a\u505a\u5b8cb\u8d85\u533b\u751f\u4e0b\u73ed\u4e86 \u5de6\u4fa7\u7684\u5305 \u5757\u662f\u5426\u662f\u666e\u901a\u7684\u6dcb\u5df4\u7ed3\u80bf\u5927\uff1f 1 \u5de6\u4fa7\u7684\u5305\u5757\u662f\u5426\u662f\u666e\u901a\u7684\u6dcb\u5df4\u7ed3\u80bf\u5927\uff1f \u6309\u538b\u4e0d\u75bc\uff0c\u4f46\u7528\u624b\u6572\u4f1a\u6709\u70b9\u523a\u75db 1 \u6309\u538b\u4e0d\u75bc\uff0c\u4f46\u7528\u624b\u6572\u4f1a\u6709\u70b9\u523a\u75db \uff1f 1 \u6297\u8c2c\u808b\u6c0f\u7ba1\u6fc0\u7d20\u504f\u4f4e\u6297\u7f2a\u808b\u6c0f\u7ba1\u6fc0\u7d20\u504f\u4f4e \u6628\u5929\u540c\u623f\u540e\u51fa\u8840\u4e86\uff0c\u4ee5\u524d\u90fd\u4e0d\u4f1a\uff0c\u5148\u662f\u9c9c\u7ea2\u8272\uff0c\u4eca\u5929\u53d8\u8910\u8272\uff0c\u5c11 \u91cf\uff0c\u4e0d\u60f3\u53bb\u533b\u9662\u68c0\u67e5\uff0c\u8fc7\u51e0\u5929\u5b83\u4f1a\u81ea\u5df1\u505c\u5427\uff1f\u8fd8\u662f\u8981\u5403\u4ec0\u4e48\u836f\uff1f 0 \u6c34\u75d8\u6c34\u75d8\u540e\u7b2c\u4e03\u5929\u8138\u4e0a\u8272\u7d20\u4e25\u91cd \u4e94\u9669\u4e00\u91d1\u4f1a\u4e0b\u8c03\u5417 0 \u817a\u6837\u4f53\u91cd\u5ea6\u80a5\u5927\uff0c\u5206\u6ccc\u6027\u4e2d\u8033\u708e\u5b9d\u5b9d\u817a\u6837\u4f53\u80a5\u5927\u600e\u4e48\u529e \u6211\u7238\u56e0\u8f66\u7978\u6b7b\u4ea1\u610f\u5916\u9669\u80fd\u8d54\u507f\u5417 0 \u5c3f\u8840\u5c3f\u8840\u8fd9\u79cd\u60c5\u51b5\u8981\u6c42\u9ad8\u4e0d\u9ad8\u6cbb\u7597 \u8f66\u8f86\u4fdd\u9669\u7406\u8d54\u56de\u6267\u5f04\u4e22\u4e86\u53ef\u4ee5\u8865\u5417 0 \u5c3f\u8def\u611f\u67d3\u5c3f\u8def\u611f\u67d3\u5907\u5b55\u4e2d \u5728\u5355\u4f4d\u8f9e\u804c\u4e86\uff0c\u5f53\u65f6\u6ca1\u529e\u533b\u4fdd\uff0c\u662f\u5426\u80fd\u7533\u529e\u5c45\u6c11\u533b\u4fdd\uff1f 0 \u773c\u89d2\u6709\u8840\u5757\u5de6\u773c\u89d2\u6709\u8840\u5757\u72b6 \u6709\u8c01\u77e5\u9053\uff0c\u5b89*\u957f*\u6811\u51fa\u9669\u4e86\u9700\u8981\u63d0\u4f9b\u54ea\u4e9b\u533b\u9662\u8bc1\u660e\uff1f \u6570\u636e\u96c6\u7684\u76f8\u5173\u89e3\u91ca: \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e00\u5217\u4ee3\u8868\u6807\u7b7e, 1\u4e3a\u6b63\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u4e24\u53e5\u8bdd\u662f\u5728\u8ba8\u8bba\u540c\u4e00\u4e3b\u9898. 0\u4e3a\u8d1f\u6807\u7b7e, \u4ee3\u8868\u540e\u9762\u7684\u4e24\u53e5\u8bdd\u4e0d\u76f8\u5173. \u6570\u636e\u96c6\u4e2d\u7684\u7b2c\u4e8c\u5217\u662f\u7528\u6237\u56de\u590d\u7684\u6587\u672c\u4fe1\u606f, \u7b2c\u4e09\u5217\u662f\u4e0e\u4e0a\u4e00\u53e5\u76f8\u5173\u6216\u4e0d\u76f8\u5173\u7684\u6587\u672c. \u6b63\u8d1f\u6837\u672c\u7684\u6bd4\u4f8b\u662f1:1\u5de6\u53f3 \u6570\u636e\u96c6\u6240\u5728\u4f4d\u7f6e: /data/doctor_online/bert_serve/train_data.csv \u6570\u636e\u96c6\u6765\u6e90\u53ca\u5176\u6269\u5145\u65b9\u5f0f: \u6765\u6e90: \u6b63\u6837\u672c\u6570\u636e\u6765\u81ea\u7f51\u7edc\u533b\u60a3\u5728\u7ebf\u95ee\u7b54\u7684\u771f\u5b9e\u8bed\u6599. \u8d1f\u6837\u672c\u6765\u81ea\u5176\u4ed6\u4f7f\u7528\u5176\u4ed6\u95ee\u7b54\u8bed\u6599\u7684\u56de\u590d\u4fe1\u606f, \u4fdd\u8bc1\u4e24\u6bb5\u6587\u672c\u4e0d\u76f8\u5173. \u6269\u5145\u65b9\u5f0f: \u6839\u636e\u6765\u6e90, \u53ef\u901a\u8fc7\u6570\u636e\u6293\u53d6\u6280\u672f\u5bf9\u8bed\u6599\u96c6\u8fdb\u884c\u6269\u5145.","title":"8.2 \u8bad\u7ec3\u6570\u636e\u96c6"},{"location":"8/#83-bert","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6\u548c\u4f5c\u7528. \u638c\u63e1\u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u8fc7\u7a0b. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b: BERT\u6a21\u578b\u6574\u4f53\u67b6\u6784\u57fa\u4e8eTransformer\u6a21\u578b\u67b6\u6784, BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u89e3\u7801\u5668\u548c\u7f16\u7801\u5668\u5177\u670912\u5c42, \u8f93\u51fa\u5c42\u4e2d\u7684\u7ebf\u6027\u5c42\u5177\u6709768\u4e2a\u8282\u70b9, \u5373\u8f93\u51fa\u5f20\u91cf\u6700\u540e\u4e00\u7ef4\u7684\u7ef4\u5ea6\u662f768. \u5b83\u4f7f\u7528\u7684\u591a\u5934\u6ce8\u610f\u529b\u673a\u5236\u7ed3\u6784\u4e2d, \u5934\u7684\u6570\u91cf\u4e3a12, \u6a21\u578b\u603b\u53c2\u6570\u91cf\u4e3a110M. \u540c\u65f6, \u5b83\u5728\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4e0a\u8fdb\u884c\u8bad\u7ec3, \u56e0\u6b64\u9002\u5408\u4e2d\u6587\u7b80\u4f53\u548c\u7e41\u4f53\u4efb\u52a1. BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u4f5c\u7528: \u5728\u5b9e\u9645\u7684\u6587\u672c\u4efb\u52a1\u5904\u7406\u4e2d, \u6709\u4e9b\u8bad\u7ec3\u8bed\u6599\u5f88\u96be\u83b7\u5f97, \u4ed6\u4eec\u7684\u603b\u4f53\u6570\u91cf\u548c\u5305\u542b\u7684\u8bcd\u6c47\u603b\u6570\u90fd\u975e\u5e38\u5c11, \u4e0d\u9002\u5408\u7528\u4e8e\u8bad\u7ec3\u5e26\u6709Embedding\u5c42\u7684\u6a21\u578b, \u4f46\u8fd9\u4e9b\u6570\u636e\u4e2d\u5374\u53c8\u8574\u542b\u8fd9\u4e00\u4e9b\u6709\u4ef7\u503c\u7684\u89c4\u5f8b\u53ef\u4ee5\u88ab\u6a21\u578b\u6316\u6398, \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b,\u4f7f\u7528\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801\u662f\u975e\u5e38\u4e0d\u9519\u7684\u9009\u62e9, \u56e0\u4e3a\u9884\u8bad\u7ec3\u6a21\u578b\u6765\u81ea\u5927\u578b\u8bed\u6599, \u80fd\u591f\u4f7f\u5f97\u5f53\u524d\u6587\u672c\u5177\u6709\u610f\u4e49, \u867d\u7136\u8fd9\u4e9b\u610f\u4e49\u53ef\u80fd\u5e76\u4e0d\u9488\u5bf9\u67d0\u4e2a\u7279\u5b9a\u9886\u57df, \u4f46\u662f\u8fd9\u79cd\u7f3a\u9677\u53ef\u4ee5\u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u6765\u8fdb\u884c\u5f25\u8865. \u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u4e24\u4e2a\u53e5\u5b50\u8fdb\u884c\u7f16\u7801: import torch import torch.nn as nn # \u4f7f\u7528torch.hub\u52a0\u8f7dbert\u4e2d\u6587\u6a21\u578b\u7684\u5b57\u6620\u5c04\u5668 tokenizer = torch.hub.load('huggingface/pytorch-transformers', 'tokenizer', 'bert-base-chinese') # \u4f7f\u7528torch.hub\u52a0\u8f7dbert\u4e2d\u6587\u6a21\u578b model = torch.hub.load('huggingface/pytorch-transformers', 'model', 'bert-base-chinese') def get_bert_encode(text_1, text_2, mark=102, max_len=10): \"\"\" description: \u4f7f\u7528bert\u4e2d\u6587\u6a21\u578b\u5bf9\u8f93\u5165\u7684\u6587\u672c\u5bf9\u8fdb\u884c\u7f16\u7801 :param text_1: \u4ee3\u8868\u8f93\u5165\u7684\u7b2c\u4e00\u53e5\u8bdd :param text_2: \u4ee3\u8868\u8f93\u5165\u7684\u7b2c\u4e8c\u53e5\u8bdd :param mark: \u5206\u9694\u6807\u8bb0, \u662f\u9884\u8bad\u7ec3\u6a21\u578btokenizer\u672c\u8eab\u7684\u6807\u8bb0\u7b26\u53f7, \u5f53\u8f93\u5165\u662f\u4e24\u4e2a\u6587\u672c\u65f6, \u5f97\u5230\u7684index_tokens\u4f1a\u4ee5102\u8fdb\u884c\u5206\u9694 :param max_len: \u6587\u672c\u7684\u5141\u8bb8\u6700\u5927\u957f\u5ea6, \u4e5f\u662f\u6587\u672c\u7684\u89c4\u8303\u957f\u5ea6\u5373\u5927\u4e8e\u8be5\u957f\u5ea6\u8981\u88ab\u622a\u65ad, \u5c0f\u4e8e\u8be5\u957f\u5ea6\u8981\u8fdb\u884c0\u8865\u9f50 :return \u8f93\u5165\u6587\u672c\u7684bert\u7f16\u7801 \"\"\" # \u4f7f\u7528tokenizer\u7684encode\u65b9\u6cd5\u5bf9\u8f93\u5165\u7684\u4e24\u53e5\u6587\u672c\u8fdb\u884c\u5b57\u6620\u5c04. indexed_tokens = tokenizer.encode(text_1, text_2) # \u51c6\u5907\u5bf9\u6620\u5c04\u540e\u7684\u6587\u672c\u8fdb\u884c\u89c4\u8303\u957f\u5ea6\u5904\u7406\u5373\u5927\u4e8e\u8be5\u957f\u5ea6\u8981\u88ab\u622a\u65ad, \u5c0f\u4e8e\u8be5\u957f\u5ea6\u8981\u8fdb\u884c0\u8865\u9f50 # \u6240\u4ee5\u9700\u8981\u5148\u627e\u5230\u5206\u9694\u6807\u8bb0\u7684\u7d22\u5f15\u4f4d\u7f6e k = indexed_tokens.index(mark) # \u9996\u5148\u5bf9\u7b2c\u4e00\u53e5\u8bdd\u8fdb\u884c\u957f\u5ea6\u89c4\u8303\u56e0\u6b64\u5c06indexed_tokens\u622a\u53d6\u5230[:k]\u5224\u65ad if len(indexed_tokens[:k]) >= max_len: # \u5982\u679c\u5927\u4e8emax_len, \u5219\u8fdb\u884c\u622a\u65ad indexed_tokens_1 = indexed_tokens[:max_len] else: # \u5426\u5219\u4f7f\u7528[0]\u8fdb\u884c\u8865\u9f50, \u8865\u9f50\u76840\u7684\u4e2a\u6570\u5c31\u662fmax_len-len(indexed_tokens[:k]) indexed_tokens_1 = indexed_tokens[:k] + (max_len-len(indexed_tokens[:k]))*[0] # \u540c\u7406\u4e0b\u9762\u662f\u5bf9\u7b2c\u4e8c\u53e5\u8bdd\u8fdb\u884c\u89c4\u8303\u957f\u5ea6\u5904\u7406, \u56e0\u6b64\u622a\u53d6[k:] if len(indexed_tokens[k:]) >= max_len: # \u5982\u679c\u5927\u4e8emax_len, \u5219\u8fdb\u884c\u622a\u65ad indexed_tokens_2 = indexed_tokens[k:k+max_len] else: # \u5426\u5219\u4f7f\u7528[0]\u8fdb\u884c\u8865\u9f50, \u8865\u9f50\u76840\u7684\u4e2a\u6570\u5c31\u662fmax_len-len(indexed_tokens[:k]) indexed_tokens_2 = indexed_tokens[k:] + (max_len-len(indexed_tokens[k:]))*[0] # \u6700\u540e\u5c06\u5904\u7406\u540e\u7684indexed_tokens_1\u548cindexed_tokens_2\u518d\u8fdb\u884c\u76f8\u52a0 indexed_tokens = indexed_tokens_1 + indexed_tokens_2 # \u4e3a\u4e86\u8ba9\u6a21\u578b\u5728\u7f16\u7801\u65f6\u80fd\u591f\u66f4\u597d\u7684\u533a\u5206\u8fd9\u4e24\u53e5\u8bdd, \u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5206\u9694ids, # \u5b83\u662f\u4e00\u4e2a\u4e0eindexed_tokens\u7b49\u957f\u7684\u5411\u91cf, 0\u5143\u7d20\u7684\u4f4d\u7f6e\u4ee3\u8868\u662f\u7b2c\u4e00\u53e5\u8bdd # 1\u5143\u7d20\u7684\u4f4d\u7f6e\u4ee3\u8868\u662f\u7b2c\u4e8c\u53e5\u8bdd, \u957f\u5ea6\u90fd\u662fmax_len segments_ids = [0]*max_len + [1]*max_len # \u5c06segments_ids\u548cindexed_tokens\u8f6c\u6362\u6210\u6a21\u578b\u9700\u8981\u7684\u5f20\u91cf\u5f62\u5f0f segments_tensor = torch.tensor([segments_ids]) tokens_tensor = torch.tensor([indexed_tokens]) # \u6a21\u578b\u4e0d\u81ea\u52a8\u6c42\u89e3\u68af\u5ea6 with torch.no_grad(): # \u4f7f\u7528bert model\u8fdb\u884c\u7f16\u7801, \u4f20\u5165\u53c2\u6570tokens_tensor\u548csegments_tensor\u5f97\u5230encoded_layers encoded_layers, _ = model(tokens_tensor, token_type_ids=segments_tensor) return encoded_layers \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/bert_chinese_encode.py \u8f93\u5165\u53c2\u6570: text_1 = \"\u4eba\u751f\u8be5\u5982\u4f55\u8d77\u5934\" text_2 = \"\u6539\u53d8\u8981\u5982\u4f55\u8d77\u624b\" \u8c03\u7528: encoded_layers = get_bert_encode(text_1, text_2) print(encoded_layers) print(encoded_layers.shape) \u8f93\u51fa\u6548\u679c: tensor([[[ 1.0210, 0.0659, -0.3472, ..., 0.5131, -0.7699, 0.0202], [-0.1966, 0.2660, 0.3689, ..., -0.0650, -0.2853, -0.1777], [ 0.9295, -0.3890, -0.1026, ..., 1.3917, 0.4692, -0.0851], ..., [ 1.4777, 0.7781, -0.4310, ..., 0.7403, 0.2006, -0.1198], [ 0.3867, -0.2031, -0.0721, ..., 1.0050, -0.2479, -0.3525], [ 0.0599, 0.2883, -0.4011, ..., -0.1875, -0.2546, 0.0453]]]) torch.Size([1, 20, 768]) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7684\u6709\u5173\u77e5\u8bc6\u548c\u4f5c\u7528. \u4f7f\u7528BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u5bf9\u53e5\u5b50\u7f16\u7801\u7684\u51fd\u6570: get_bert_encode","title":"8.3 BERT\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b"},{"location":"8/#84","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u5fae\u8c03\u6a21\u578b\u7684\u4f5c\u7528. \u638c\u63e1\u6784\u5efa\u5168\u8fde\u63a5\u5fae\u8c03\u6a21\u578b\u7684\u8fc7\u7a0b. \u5fae\u8c03\u6a21\u578b\u7684\u4f5c\u7528: \u5fae\u8c03\u6a21\u578b\u4e00\u822c\u7528\u5728\u8fc1\u79fb\u5b66\u4e60\u4e2d\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u4e4b\u540e, \u56e0\u4e3a\u5355\u7eaf\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u5f80\u5f80\u4e0d\u80fd\u9488\u5bf9\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u83b7\u5f97\u9884\u671f\u7ed3\u679c, \u9700\u8981\u901a\u8fc7\u5fae\u8c03\u6a21\u578b\u5728\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u4e0a\u8c03\u8282\u6574\u4f53\u6a21\u578b\u529f\u80fd, \u4f7f\u5176\u9002\u5e94\u5f53\u4e0b\u95ee\u9898. \u6784\u5efa\u5168\u8fde\u63a5\u5fae\u8c03\u6a21\u578b\u7684\u4ee3\u7801\u5206\u6790: import torch import torch.nn as nn import torch.nn.functional as F class Net(nn.Module): \"\"\"\u5b9a\u4e49\u5fae\u8c03\u7f51\u7edc\u7684\u7c7b\"\"\" def __init__(self, char_size=20, embedding_size=768, dropout=0.2): \"\"\" :param char_size: \u8f93\u5165\u53e5\u5b50\u4e2d\u7684\u5b57\u7b26\u6570\u91cf, \u56e0\u4e3a\u89c4\u8303\u540e\u6bcf\u6761\u53e5\u5b50\u957f\u5ea6\u662fmax_len, \u56e0\u6b64char_size\u4e3a2*max_len :param embedding_size: \u5b57\u5d4c\u5165\u7684\u7ef4\u5ea6, \u56e0\u4e3a\u4f7f\u7528\u7684bert\u4e2d\u6587\u6a21\u578b\u5d4c\u5165\u7ef4\u5ea6\u662f768, \u56e0\u6b64embedding_size\u4e3a768 :param dropout: \u4e3a\u4e86\u9632\u6b62\u8fc7\u62df\u5408, \u7f51\u7edc\u4e2d\u5c06\u5f15\u5165Dropout\u5c42, dropout\u4e3a\u7f6e0\u6bd4\u7387, \u9ed8\u8ba4\u662f0.2 \"\"\" super(Net, self).__init__() # \u5c06char_size\u548cembedding_size\u4f20\u5165\u5176\u4e2d self.char_size = char_size self.embedding_size = embedding_size # \u5b9e\u4f8b\u5316\u5316\u5fc5\u8981\u7684\u5c42\u548c\u5c42\u53c2\u6570: # \u5b9e\u4f8b\u5316Dropout\u5c42 self.dropout = nn.Dropout(p=dropout) # \u5b9e\u4f8b\u5316\u7b2c\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42 self.fc1 = nn.Linear(char_size*embedding_size, 8) # \u5b9e\u4f8b\u5316\u7b2c\u4e8c\u4e2a\u5168\u8fde\u63a5\u5c42 self.fc2 = nn.Linear(8, 2) def forward(self, x): # \u5bf9\u8f93\u5165\u7684\u5f20\u91cf\u5f62\u72b6\u8fdb\u884c\u53d8\u6362, \u4ee5\u6ee1\u8db3\u63a5\u4e0b\u6765\u5c42\u7684\u8f93\u5165\u8981\u6c42 x = x.view(-1, self.char_size*self.embedding_size) # \u4f7f\u7528dropout\u5c42 x = self.dropout(x) # \u4f7f\u7528\u7b2c\u4e00\u4e2a\u5168\u8fde\u63a5\u5c42\u5e76\u4f7f\u7528relu\u51fd\u6570 x = F.relu(self.fc1(x)) # \u4f7f\u7528dropout\u5c42 x = self.dropout(x) # \u4f7f\u7528\u7b2c\u4e8c\u4e2a\u5168\u8fde\u63a5\u5c42\u5e76\u4f7f\u7528relu\u51fd\u6570 x = F.relu(self.fc2(x)) return x \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/finetuning_net.py \u5b9e\u4f8b\u5316\u53c2\u6570: embedding_size = 768 char_size = 20 dropout = 0.2 \u8f93\u5165\u53c2\u6570: x = torch.randn(1, 20, 768) \u8c03\u7528: net = Net(char_size, embedding_size, dropout) nr = net(x) print(nr) \u8f93\u51fa\u6548\u679c: tensor([[0.0000, 0.4061]], grad_fn=<ReluBackward0>) \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u5fae\u8c03\u6a21\u578b\u7684\u4f5c\u7528: \u5fae\u8c03\u6a21\u578b\u4e00\u822c\u7528\u5728\u8fc1\u79fb\u5b66\u4e60\u4e2d\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u4e4b\u540e, \u56e0\u4e3a\u5355\u7eaf\u7684\u9884\u8bad\u7ec3\u6a21\u578b\u5f80\u5f80\u4e0d\u80fd\u9488\u5bf9\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u83b7\u5f97\u9884\u671f\u7ed3\u679c, \u9700\u8981\u901a\u8fc7\u5fae\u8c03\u6a21\u578b\u5728\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u4e0a\u8c03\u8282\u6574\u4f53\u6a21\u578b\u529f\u80fd, \u4f7f\u5176\u9002\u5e94\u5f53\u4e0b\u95ee\u9898. \u5b66\u4e60\u5e76\u5b9e\u73b0\u4e86\u6784\u5efa\u5168\u8fde\u63a5\u5fae\u8c03\u6a21\u578b\u7684\u7c7b: class Net(nn.Module)","title":"8.4 \u5fae\u8c03\u6a21\u578b"},{"location":"8/#85","text":"\u5b66\u4e60\u76ee\u6807: \u4e86\u89e3\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4. \u638c\u63e1\u6a21\u578b\u8bad\u7ec3\u4e2d\u6bcf\u4e2a\u6b65\u9aa4\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u6570\u636e\u52a0\u8f7d\u5668\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58. \u7b2c\u4e00\u6b65: \u6784\u5efa\u6570\u636e\u52a0\u8f7d\u5668\u51fd\u6570 import pandas as pd from sklearn.utils import shuffle from functools import reduce from collections import Counter from bert_chinese_encode import get_bert_encode import torch import torch.nn as nn def data_loader(data_path, batch_size, split=0.2): \"\"\" description: \u4ece\u6301\u4e45\u5316\u6587\u4ef6\u4e2d\u52a0\u8f7d\u6570\u636e, \u5e76\u5212\u5206\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u53ca\u5176\u6279\u6b21\u5927\u5c0f :param data_path: \u8bad\u7ec3\u6570\u636e\u7684\u6301\u4e45\u5316\u8def\u5f84 :param batch_size: \u8bad\u7ec3\u548c\u9a8c\u8bc1\u6570\u636e\u96c6\u7684\u6279\u6b21\u5927\u5c0f :param split: \u8bad\u7ec3\u96c6\u4e0e\u9a8c\u8bc1\u7684\u5212\u5206\u6bd4\u4f8b :return: \u8bad\u7ec3\u6570\u636e\u751f\u6210\u5668, \u9a8c\u8bc1\u6570\u636e\u751f\u6210\u5668, \u8bad\u7ec3\u6570\u636e\u6570\u91cf, \u9a8c\u8bc1\u6570\u636e\u6570\u91cf \"\"\" # \u4f7f\u7528pd\u8fdb\u884ccsv\u6570\u636e\u7684\u8bfb\u53d6 data = pd.read_csv(data_path, header=None, sep=\"\\t\") # \u6253\u5370\u6574\u4f53\u6570\u636e\u96c6\u4e0a\u7684\u6b63\u8d1f\u6837\u672c\u6570\u91cf print(\"\u6570\u636e\u96c6\u7684\u6b63\u8d1f\u6837\u672c\u6570\u91cf:\") print(dict(Counter(data[0].values))) # \u6253\u4e71\u6570\u636e\u96c6\u7684\u987a\u5e8f data = shuffle(data).reset_index(drop=True) # \u5212\u5206\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6 split_point = int(len(data)*split) valid_data = data[:split_point] train_data = data[split_point:] # \u9a8c\u8bc1\u6570\u636e\u96c6\u4e2d\u7684\u6570\u636e\u603b\u6570\u81f3\u5c11\u80fd\u591f\u6ee1\u8db3\u4e00\u4e2a\u6279\u6b21 if len(valid_data) < batch_size: raise(\"Batch size or split not match!\") def _loader_generator(data): \"\"\" description: \u83b7\u5f97\u8bad\u7ec3\u96c6/\u9a8c\u8bc1\u96c6\u7684\u6bcf\u4e2a\u6279\u6b21\u6570\u636e\u7684\u751f\u6210\u5668 :param data: \u8bad\u7ec3\u6570\u636e\u6216\u9a8c\u8bc1\u6570\u636e :return: \u4e00\u4e2a\u6279\u6b21\u7684\u8bad\u7ec3\u6570\u636e\u6216\u9a8c\u8bc1\u6570\u636e\u7684\u751f\u6210\u5668 \"\"\" # \u4ee5\u6bcf\u4e2a\u6279\u6b21\u7684\u95f4\u9694\u904d\u5386\u6570\u636e\u96c6 for batch in range(0, len(data), batch_size): # \u9884\u5b9a\u4e8ebatch\u6570\u636e\u7684\u5f20\u91cf\u5217\u8868 batch_encoded = [] batch_labels = [] # \u5c06\u4e00\u4e2abitch_size\u5927\u5c0f\u7684\u6570\u636e\u8f6c\u6362\u6210\u5217\u8868\u5f62\u5f0f\uff0c[[label, text_1, text_2]] # \u5e76\u8fdb\u884c\u9010\u6761\u904d\u5386 for item in data[batch: batch+batch_size].values.tolist(): # \u6bcf\u6761\u6570\u636e\u4e2d\u90fd\u5305\u542b\u4e24\u53e5\u8bdd, \u4f7f\u7528bert\u4e2d\u6587\u6a21\u578b\u8fdb\u884c\u7f16\u7801 encoded = get_bert_encode(item[1], item[2]) # \u5c06\u7f16\u7801\u540e\u7684\u6bcf\u6761\u6570\u636e\u88c5\u8fdb\u9884\u5148\u5b9a\u4e49\u597d\u7684\u5217\u8868\u4e2d batch_encoded.append(encoded) # \u540c\u6837\u5c06\u5bf9\u5e94\u7684\u8be5batch\u7684\u6807\u7b7e\u88c5\u8fdblabels\u5217\u8868\u4e2d batch_labels.append([item[0]]) # \u4f7f\u7528reduce\u9ad8\u9636\u51fd\u6570\u5c06\u5217\u8868\u4e2d\u7684\u6570\u636e\u8f6c\u6362\u6210\u6a21\u578b\u9700\u8981\u7684\u5f20\u91cf\u5f62\u5f0f # encoded\u7684\u5f62\u72b6\u662f(batch_size, 2*max_len, embedding_size) encoded = reduce(lambda x, y : torch.cat((x, y), dim=0), batch_encoded) labels = torch.tensor(reduce(lambda x, y : x + y, batch_labels)) # \u4ee5\u751f\u6210\u5668\u7684\u65b9\u5f0f\u8fd4\u56de\u6570\u636e\u548c\u6807\u7b7e yield (encoded, labels) # \u5bf9\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u5206\u522b\u4f7f\u7528_loader_generator\u51fd\u6570, \u8fd4\u56de\u5bf9\u5e94\u7684\u751f\u6210\u5668 # \u6700\u540e\u8fd8\u8981\u8fd4\u56de\u8bad\u7ec3\u96c6\u548c\u9a8c\u8bc1\u96c6\u7684\u6837\u672c\u6570\u91cf return _loader_generator(train_data), _loader_generator(valid_data), len(train_data), len(valid_data) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8f93\u5165\u53c2\u6570: # \u6570\u636e\u6240\u5728\u8def\u5f84 data_path = \"./train_data.csv\" # \u5b9a\u4e49batch_size\u5927\u5c0f batch_size = 32 \u8c03\u7528: train_data_labels, valid_data_labels, \\ train_data_len, valid_data_len = data_loader(data_path, batch_size) print(next(train_data_labels)) print(next(valid_data_labels)) print(\"train_data_len:\", train_data_len) print(\"valid_data_len:\", valid_data_len) \u8f93\u51fa\u6548\u679c: (tensor([[[-0.7295, 0.8199, 0.8320, ..., 0.0933, 1.2171, 0.4833], [ 0.8707, 1.0131, -0.2556, ..., 0.2179, -1.0671, 0.1946], [ 0.0344, -0.5605, -0.5658, ..., 1.0855, -0.9122, 0.0222]]], tensor([0, 0, 1, 1, 1, 1, 0, 1, 0, 0, ..., 1, 0, 1, 0, 1, 1, 1, 1])) (tensor([[[-0.5263, -0.3897, -0.5725, ..., 0.5523, -0.2289, -0.8796], [ 0.0468, -0.5291, -0.0247, ..., 0.4221, -0.2501, -0.0796], [-0.2133, -0.5552, -0.0584, ..., -0.8031, 0.1753, -0.3476]]]), tensor([0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, ..., 0, 0, 1, 0, 1,1, 1])) train_data_len: 22186 valid_data_len: 5546 \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570 # \u52a0\u8f7d\u5fae\u8c03\u7f51\u7edc from finetuning_net import Net import torch.optim as optim # \u5b9a\u4e49embedding_size, char_size embedding_size = 768 char_size = 2 * max_len # \u5b9e\u4f8b\u5316\u5fae\u8c03\u7f51\u7edc net = Net(embedding_size, char_size) # \u5b9a\u4e49\u4ea4\u53c9\u71b5\u635f\u5931\u51fd\u6570 criterion = nn.CrossEntropyLoss() # \u5b9a\u4e49SGD\u4f18\u5316\u65b9\u6cd5 optimizer = optim.SGD(net.parameters(), lr=0.001, momentum=0.9) def train(train_data_labels): \"\"\" description: \u8bad\u7ec3\u51fd\u6570, \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u5c06\u66f4\u65b0\u6a21\u578b\u53c2\u6570, \u5e76\u6536\u96c6\u51c6\u786e\u7387\u548c\u635f\u5931 :param train_data_labels: \u8bad\u7ec3\u6570\u636e\u548c\u6807\u7b7e\u7684\u751f\u6210\u5668\u5bf9\u8c61 :return: \u6574\u4e2a\u8bad\u7ec3\u8fc7\u7a0b\u7684\u5e73\u5747\u635f\u5931\u4e4b\u548c\u4ee5\u53ca\u6b63\u786e\u6807\u7b7e\u7684\u7d2f\u52a0\u6570 \"\"\" # \u5b9a\u4e49\u8bad\u7ec3\u8fc7\u7a0b\u7684\u521d\u59cb\u635f\u5931\u548c\u51c6\u786e\u7387\u7d2f\u52a0\u6570 train_running_loss = 0.0 train_running_acc = 0.0 # \u5faa\u73af\u904d\u5386\u8bad\u7ec3\u6570\u636e\u548c\u6807\u7b7e\u751f\u6210\u5668, \u6bcf\u4e2a\u6279\u6b21\u66f4\u65b0\u4e00\u6b21\u6a21\u578b\u53c2\u6570 for train_tensor, train_labels in train_data_labels: # \u521d\u59cb\u5316\u8be5\u6279\u6b21\u7684\u4f18\u5316\u5668 optimizer.zero_grad() # \u4f7f\u7528\u5fae\u8c03\u7f51\u7edc\u83b7\u5f97\u8f93\u51fa train_outputs = net(train_tensor) # \u5f97\u5230\u8be5\u6279\u6b21\u4e0b\u7684\u5e73\u5747\u635f\u5931 train_loss = criterion(train_outputs, train_labels) # \u5c06\u8be5\u6279\u6b21\u7684\u5e73\u5747\u635f\u5931\u52a0\u5230train_running_loss\u4e2d train_running_loss += train_loss.item() # \u635f\u5931\u53cd\u5411\u4f20\u64ad train_loss.backward() # \u4f18\u5316\u5668\u66f4\u65b0\u6a21\u578b\u53c2\u6570 optimizer.step() # \u5c06\u8be5\u6279\u6b21\u4e2d\u6b63\u786e\u7684\u6807\u7b7e\u6570\u91cf\u8fdb\u884c\u7d2f\u52a0, \u4ee5\u4fbf\u4e4b\u540e\u8ba1\u7b97\u51c6\u786e\u7387 train_running_acc += (train_outputs.argmax(1) == train_labels).sum().item() return train_running_loss, train_running_acc \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u7b2c\u4e09\u6b65: \u6a21\u578b\u9a8c\u8bc1\u51fd\u6570 def valid(valid_data_labels): \"\"\" description: \u9a8c\u8bc1\u51fd\u6570, \u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u5c06\u9a8c\u8bc1\u6a21\u578b\u7684\u5728\u65b0\u6570\u636e\u96c6\u4e0a\u7684\u6807\u7b7e, \u6536\u96c6\u635f\u5931\u548c\u51c6\u786e\u7387 :param valid_data_labels: \u9a8c\u8bc1\u6570\u636e\u548c\u6807\u7b7e\u7684\u751f\u6210\u5668\u5bf9\u8c61 :return: \u6574\u4e2a\u9a8c\u8bc1\u8fc7\u7a0b\u7684\u5e73\u5747\u635f\u5931\u4e4b\u548c\u4ee5\u53ca\u6b63\u786e\u6807\u7b7e\u7684\u7d2f\u52a0\u6570 \"\"\" # \u5b9a\u4e49\u8bad\u7ec3\u8fc7\u7a0b\u7684\u521d\u59cb\u635f\u5931\u548c\u51c6\u786e\u7387\u7d2f\u52a0\u6570 valid_running_loss = 0.0 valid_running_acc = 0.0 # \u5faa\u73af\u904d\u5386\u9a8c\u8bc1\u6570\u636e\u548c\u6807\u7b7e\u751f\u6210\u5668 for valid_tensor, valid_labels in valid_data_labels: # \u4e0d\u81ea\u52a8\u66f4\u65b0\u68af\u5ea6 with torch.no_grad(): # \u4f7f\u7528\u5fae\u8c03\u7f51\u7edc\u83b7\u5f97\u8f93\u51fa valid_outputs = net(valid_tensor) # \u5f97\u5230\u8be5\u6279\u6b21\u4e0b\u7684\u5e73\u5747\u635f\u5931 valid_loss = criterion(valid_outputs, valid_labels) # \u5c06\u8be5\u6279\u6b21\u7684\u5e73\u5747\u635f\u5931\u52a0\u5230valid_running_loss\u4e2d valid_running_loss += valid_loss.item() # \u5c06\u8be5\u6279\u6b21\u4e2d\u6b63\u786e\u7684\u6807\u7b7e\u6570\u91cf\u8fdb\u884c\u7d2f\u52a0, \u4ee5\u4fbf\u4e4b\u540e\u8ba1\u7b97\u51c6\u786e\u7387 valid_running_acc += (valid_outputs.argmax(1) == valid_labels).sum().item() return valid_running_loss, valid_running_acc \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7 # \u5b9a\u4e49\u8bad\u7ec3\u8f6e\u6570 epochs = 20 # \u5b9a\u4e49\u76db\u88c5\u6bcf\u8f6e\u6b21\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5217\u8868, \u7528\u4e8e\u5236\u56fe all_train_losses = [] all_valid_losses = [] all_train_acc = [] all_valid_acc = [] # \u8fdb\u884c\u6307\u5b9a\u8f6e\u6b21\u7684\u8bad\u7ec3 for epoch in range(epochs): # \u6253\u5370\u8f6e\u6b21 print(\"Epoch:\", epoch + 1) # \u901a\u8fc7\u6570\u636e\u52a0\u8f7d\u5668\u83b7\u5f97\u8bad\u7ec3\u6570\u636e\u548c\u9a8c\u8bc1\u6570\u636e\u751f\u6210\u5668, \u4ee5\u53ca\u5bf9\u5e94\u7684\u6837\u672c\u6570\u91cf train_data_labels, valid_data_labels, train_data_len, valid_data_len = data_loader(data_path, batch_size) # \u8c03\u7528\u8bad\u7ec3\u51fd\u6570\u8fdb\u884c\u8bad\u7ec3 train_running_loss, train_running_acc = train(train_data_labels) # \u8c03\u7528\u9a8c\u8bc1\u51fd\u6570\u8fdb\u884c\u9a8c\u8bc1 valid_running_loss, valid_running_acc = valid(valid_data_labels) # \u8ba1\u7b97\u6bcf\u4e00\u8f6e\u7684\u5e73\u5747\u635f\u5931, train_running_loss\u548cvalid_running_loss\u662f\u6bcf\u4e2a\u6279\u6b21\u7684\u5e73\u5747\u635f\u5931\u4e4b\u548c # \u56e0\u6b64\u5c06\u5b83\u4eec\u4e58\u4ee5batch_size\u5c31\u5f97\u5230\u4e86\u8be5\u8f6e\u7684\u603b\u635f\u5931, \u9664\u4ee5\u6837\u672c\u6570\u5373\u8be5\u8f6e\u6b21\u7684\u5e73\u5747\u635f\u5931 train_average_loss = train_running_loss * batch_size / train_data_len valid_average_loss = valid_running_loss * batch_size / valid_data_len # train_running_acc\u548cvalid_running_acc\u662f\u6bcf\u4e2a\u6279\u6b21\u7684\u6b63\u786e\u6807\u7b7e\u7d2f\u52a0\u548c, # \u56e0\u6b64\u53ea\u9700\u9664\u4ee5\u5bf9\u5e94\u6837\u672c\u603b\u6570\u5373\u662f\u8be5\u8f6e\u6b21\u7684\u51c6\u786e\u7387 train_average_acc = train_running_acc / train_data_len valid_average_acc = valid_running_acc / valid_data_len # \u5c06\u8be5\u8f6e\u6b21\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u88c5\u8fdb\u5168\u5c40\u635f\u5931\u548c\u51c6\u786e\u7387\u5217\u8868\u4e2d, \u4ee5\u4fbf\u5236\u56fe all_train_losses.append(train_average_loss) all_valid_losses.append(valid_average_loss) all_train_acc.append(train_average_acc) all_valid_acc.append(valid_average_acc) # \u6253\u5370\u8be5\u8f6e\u6b21\u4e0b\u7684\u8bad\u7ec3\u635f\u5931\u548c\u51c6\u786e\u7387\u4ee5\u53ca\u9a8c\u8bc1\u635f\u5931\u548c\u51c6\u786e\u7387 print(\"Train Loss:\", train_average_loss, \"|\", \"Train Acc:\", train_average_acc) print(\"Valid Loss:\", valid_average_loss, \"|\", \"Valid Acc:\", valid_average_acc) print('Finished Training') \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8f93\u51fa\u6548\u679c: Epoch: 1 Train Loss: 0.693169563147374 | Train Acc: 0.5084898843930635 Valid Loss: 0.6931480603018824 | Valid Acc: 0.5042777377521613 {1: 14015, 0: 13720} Epoch: 2 Train Loss: 0.6931440165277162 | Train Acc: 0.514992774566474 Valid Loss: 0.6931474804019379 | Valid Acc: 0.5026567002881844 {1: 14015, 0: 13720} Epoch: 3 Train Loss: 0.6931516138804441 | Train Acc: 0.5 Valid Loss: 0.69314516217633 | Valid Acc: 0.5065291786743515 {1: 14015, 0: 13720} Epoch: 4 Train Loss: 0.6931474804878235 | Train Acc: 0.5065028901734104 Valid Loss: 0.6931472256650842 | Valid Acc: 0.5052233429394812 {1: 14015, 0: 13720} Epoch: 5 Train Loss: 0.6931474804878235 | Train Acc: 0.5034320809248555 Valid Loss: 0.6931475739314165 | Valid Acc: 0.5055385446685879 {1: 14015, 0: 13720} Epoch: 6 Train Loss: 0.6931492934337241 | Train Acc: 0.5126445086705202 Valid Loss: 0.6931462547277512 | Valid Acc: 0.5033771613832853 {1: 14015, 0: 13720} Epoch: 7 Train Loss: 0.6931459204309938 | Train Acc: 0.5095736994219653 Valid Loss: 0.6931174922229921 | Valid Acc: 0.5065742074927954 {1: 14015, 0: 13720} Epoch: 8 Train Loss: 0.5545259035391614 | Train Acc: 0.759393063583815 Valid Loss: 0.4199462383770805 | Valid Acc: 0.9335374639769453 {1: 14015, 0: 13720} Epoch: 9 Train Loss: 0.4011955714294676 | Train Acc: 0.953757225433526 Valid Loss: 0.3964169790877045 | Valid Acc: 0.9521793948126801 {1: 14015, 0: 13720} Epoch: 10 Train Loss: 0.3893018603497158 | Train Acc: 0.9669436416184971 Valid Loss: 0.3928600374491139 | Valid Acc: 0.9525846541786743 {1: 14015, 0: 13720} Epoch: 11 Train Loss: 0.3857506763383832 | Train Acc: 0.9741690751445087 Valid Loss: 0.38195425426582097 | Valid Acc: 0.9775306195965417 {1: 14015, 0: 13720} Epoch: 12 Train Loss: 0.38368317760484066 | Train Acc: 0.9772398843930635 Valid Loss: 0.37680484129046155 | Valid Acc: 0.9780259365994236 {1: 14015, 0: 13720} Epoch: 13 Train Loss: 0.37407022137517876 | Train Acc: 0.9783236994219653 Valid Loss: 0.3750278927192564 | Valid Acc: 0.9792867435158501 {1: 14015, 0: 13720} Epoch: 14 Train Loss: 0.3707401707682306 | Train Acc: 0.9801300578034682 Valid Loss: 0.37273150721097886 | Valid Acc: 0.9831592219020173 {1: 14015, 0: 13720} Epoch: 15 Train Loss: 0.37279492521906177 | Train Acc: 0.9817557803468208 Valid Loss: 0.3706809586123362 | Valid Acc: 0.9804574927953891 {1: 14015, 0: 13720} Epoch: 16 Train Loss: 0.37660940017314315 | Train Acc: 0.9841040462427746 Valid Loss: 0.3688154769390392 | Valid Acc: 0.984600144092219 {1: 14015, 0: 13720} Epoch: 17 Train Loss: 0.3749892661681754 | Train Acc: 0.9841040462427746 Valid Loss: 0.3688570175760074 | Valid Acc: 0.9817633285302594 {1: 14015, 0: 13720} Epoch: 18 Train Loss: 0.37156562515765945 | Train Acc: 0.9826589595375722 Valid Loss: 0.36880484627028365 | Valid Acc: 0.9853656340057637 {1: 14015, 0: 13720} Epoch: 19 Train Loss: 0.3674713007976554 | Train Acc: 0.9830202312138728 Valid Loss: 0.366314563545954 | Valid Acc: 0.9850954610951008 {1: 14015, 0: 13720} Epoch: 20 Train Loss: 0.36878046806837095 | Train Acc: 0.9842846820809249 Valid Loss: 0.367835852100114 | Valid Acc: 0.9793317723342939 Finished Training \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf # \u5bfc\u5165\u5236\u56fe\u5de5\u5177\u5305 import matplotlib.pyplot as plt from matplotlib.pyplot import MultipleLocator # \u521b\u5efa\u7b2c\u4e00\u5f20\u753b\u5e03 plt.figure(0) # \u7ed8\u5236\u8bad\u7ec3\u635f\u5931\u66f2\u7ebf plt.plot(all_train_losses, label=\"Train Loss\") # \u7ed8\u5236\u9a8c\u8bc1\u635f\u5931\u66f2\u7ebf, \u989c\u8272\u4e3a\u7ea2\u8272 plt.plot(all_valid_losses, color=\"red\", label=\"Valid Loss\") # \u5b9a\u4e49\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694\u5bf9\u8c61, \u95f4\u9694\u4e3a1, \u4ee3\u8868\u6bcf\u4e00\u8f6e\u6b21 x_major_locator=MultipleLocator(1) # \u83b7\u5f97\u5f53\u524d\u5750\u6807\u56fe\u53e5\u67c4 ax=plt.gca() # \u8bbe\u7f6e\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694 ax.xaxis.set_major_locator(x_major_locator) # \u8bbe\u7f6e\u6a2a\u5750\u6807\u53d6\u503c\u8303\u56f4 plt.xlim(1,epochs) # \u66f2\u7ebf\u8bf4\u660e\u5728\u5de6\u4e0a\u65b9 plt.legend(loc='upper left') # \u4fdd\u5b58\u56fe\u7247 plt.savefig(\"./loss.png\") # \u521b\u5efa\u7b2c\u4e8c\u5f20\u753b\u5e03 plt.figure(1) # \u7ed8\u5236\u8bad\u7ec3\u51c6\u786e\u7387\u66f2\u7ebf plt.plot(all_train_acc, label=\"Train Acc\") # \u7ed8\u5236\u9a8c\u8bc1\u51c6\u786e\u7387\u66f2\u7ebf, \u989c\u8272\u4e3a\u7ea2\u8272 plt.plot(all_valid_acc, color=\"red\", label=\"Valid Acc\") # \u5b9a\u4e49\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694\u5bf9\u8c61, \u95f4\u9694\u4e3a1, \u4ee3\u8868\u6bcf\u4e00\u8f6e\u6b21 x_major_locator=MultipleLocator(1) # \u83b7\u5f97\u5f53\u524d\u5750\u6807\u56fe\u53e5\u67c4 ax=plt.gca() # \u8bbe\u7f6e\u6a2a\u5750\u6807\u523b\u5ea6\u95f4\u9694 ax.xaxis.set_major_locator(x_major_locator) # \u8bbe\u7f6e\u6a2a\u5750\u6807\u53d6\u503c\u8303\u56f4 plt.xlim(1,epochs) # \u66f2\u7ebf\u8bf4\u660e\u5728\u5de6\u4e0a\u65b9 plt.legend(loc='upper left') # \u4fdd\u5b58\u56fe\u7247 plt.savefig(\"./acc.png\") \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8bad\u7ec3\u548c\u9a8c\u8bc1\u635f\u5931\u5bf9\u7167\u66f2\u7ebf: \u8bad\u7ec3\u548c\u9a8c\u8bc1\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf: \u5206\u6790: \u6839\u636e\u635f\u5931\u5bf9\u7167\u66f2\u7ebf, \u5fae\u8c03\u6a21\u578b\u5728\u7b2c6\u8f6e\u5de6\u53f3\u5f00\u59cb\u638c\u63e1\u6570\u636e\u89c4\u5f8b\u8fc5\u901f\u4e0b\u964d, \u8bf4\u660e\u6a21\u578b\u80fd\u591f\u4ece\u6570\u636e\u4e2d\u83b7\u53d6\u8bed\u6599\u7279\u5f81\uff0c\u6b63\u5728\u6536\u655b. \u6839\u636e\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf\u4e2d\u9a8c\u8bc1\u51c6\u786e\u7387\u5728\u7b2c10\u8f6e\u5de6\u53f3\u533a\u57df\u7a33\u5b9a\uff0c\u6700\u7ec8\u7ef4\u6301\u572898%\u5de6\u53f3. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58 # \u6a21\u578b\u4fdd\u5b58\u65f6\u95f4 time_ = int(time.time()) # \u4fdd\u5b58\u8def\u5f84 MODEL_PATH = './model/BERT_net_%d.pth' % time_ # \u4fdd\u5b58\u6a21\u578b\u53c2\u6570 torch.save(rnn.state_dict(), MODEL_PATH) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/train.py \u8f93\u51fa\u6548\u679c: \u5728/data/bert_serve/\u8def\u5f84\u4e0b\u751f\u6210BERT_net_ + \u65f6\u95f4\u6233.pth\u7684\u6587\u4ef6. \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u8fdb\u884c\u6a21\u578b\u8bad\u7ec3\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u6784\u5efa\u6570\u636e\u52a0\u8f7d\u5668\u51fd\u6570. \u7b2c\u4e8c\u6b65: \u6784\u5efa\u6a21\u578b\u8bad\u7ec3\u51fd\u6570. \u7b2c\u4e09\u6b65: \u6784\u5efa\u6a21\u578b\u9a8c\u8bc1\u51fd\u6570. \u7b2c\u56db\u6b65: \u8c03\u7528\u8bad\u7ec3\u548c\u9a8c\u8bc1\u51fd\u6570\u5e76\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e94\u6b65: \u7ed8\u5236\u8bad\u7ec3\u548c\u9a8c\u8bc1\u7684\u635f\u5931\u548c\u51c6\u786e\u7387\u5bf9\u7167\u66f2\u7ebf. \u7b2c\u516d\u6b65: \u6a21\u578b\u4fdd\u5b58.","title":"8.5 \u8fdb\u884c\u6a21\u578b\u8bad\u7ec3"},{"location":"8/#86","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u4f7f\u7528Flask\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u90e8\u7f72\u7684\u5b9e\u73b0\u8fc7\u7a0b. \u4f7f\u7528Flask\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u90e8\u7f72\u7684\u6b65\u9aa4: \u7b2c\u4e00\u6b65: \u90e8\u7f72\u6a21\u578b\u9884\u6d4b\u4ee3\u7801. \u7b2c\u4e8c\u6b65: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1. \u7b2c\u4e09\u6b65: \u8fdb\u884c\u6d4b\u8bd5. \u7b2c\u4e00\u6b65: \u90e8\u7f72\u6a21\u578b\u9884\u6d4b\u4ee3\u7801 from flask import Flask from flask import request app = Flask(__name__) import torch # \u5bfc\u5165\u4e2d\u6587\u9884\u8bad\u7ec3\u6a21\u578b\u7f16\u7801\u51fd\u6570 from bert_chinese_encode import get_bert_encode # \u5bfc\u5165\u5fae\u8c03\u7f51\u7edc from finetuning_net import Net # \u5bfc\u5165\u8bad\u7ec3\u597d\u7684\u6a21\u578b MODEL_PATH = \"./model/BERT_net.pth\" # \u5b9a\u4e49\u5b9e\u4f8b\u5316\u6a21\u578b\u53c2\u6570 embedding_size = 768 char_size = 20 dropout = 0.2 # \u521d\u59cb\u5316\u5fae\u8c03\u7f51\u7edc\u6a21\u578b net = Net(embedding_size, char_size, dropout) # \u52a0\u8f7d\u6a21\u578b\u53c2\u6570 net.load_state_dict(torch.load(MODEL_PATH)) # \u4f7f\u7528\u8bc4\u4f30\u6a21\u5f0f net.eval() # \u5b9a\u4e49\u670d\u52a1\u8bf7\u6c42\u8def\u5f84\u548c\u65b9\u5f0f @app.route('/v1/recognition/', methods=[\"POST\"]) def recognition(): # \u63a5\u6536\u6570\u636e text_1 = request.form['text1'] text_2 = request.form['text2'] # \u5bf9\u539f\u59cb\u6587\u672c\u8fdb\u884c\u7f16\u7801 inputs = get_bert_encode(text_1, text_2, mark=102, max_len=10) # \u4f7f\u7528\u5fae\u8c03\u6a21\u578b\u8fdb\u884c\u9884\u6d4b outputs = net(inputs) # \u83b7\u5f97\u9884\u6d4b\u7ed3\u679c _, predicted = torch.max(outputs, 1) # \u8fd4\u56de\u5b57\u7b26\u4e32\u7c7b\u578b\u7684\u7ed3\u679c return str(predicted.item()) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/app.py \u7b2c\u4e8c\u6b65: \u542f\u52a8\u670d\u52a1 gunicorn -w 1 -b 0.0.0.0:5001 app:app \u7b2c\u4e09\u6b65: \u8fdb\u884c\u6d4b\u8bd5 \u6d4b\u8bd5\u811a\u672c: import requests url = \"http://0.0.0.0:5001/v1/recognition/\" data = {\"text1\":\"\u4eba\u751f\u8be5\u5982\u4f55\u8d77\u5934\", \"text2\": \"\u6539\u53d8\u8981\u5982\u4f55\u8d77\u624b\"} res = requests.post(url, data=data) print(\"\u9884\u6d4b\u6837\u672c:\", data[\"text_1\"], \"|\", data[\"text_2\"]) print(\"\u9884\u6d4b\u7ed3\u679c:\", res.text) \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/test.py \u8fd0\u884c\u811a\u672c: python test.py \u8f93\u51fa\u6548\u679c: \u9884\u6d4b\u6837\u672c: \u4eba\u751f\u8be5\u5982\u4f55\u8d77\u5934 | \u6539\u53d8\u8981\u5982\u4f55\u8d77\u624b \u9884\u6d4b\u7ed3\u679c: 1 \u5c0f\u8282\u603b\u7ed3: \u5b66\u4e60\u4e86\u4f7f\u7528Flask\u6846\u67b6\u8fdb\u884c\u6a21\u578b\u90e8\u7f72\u7684\u5b9e\u73b0\u8fc7\u7a0b: \u7b2c\u4e00\u6b65: \u90e8\u7f72\u6a21\u578b\u9884\u6d4b\u4ee3\u7801. \u7b2c\u4e8c\u6b65: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1. \u7b2c\u4e09\u6b65: \u8fdb\u884c\u6d4b\u8bd5.","title":"8.6 \u6a21\u578b\u90e8\u7f72"},{"location":"9/","text":"9.1 \u7cfb\u7edf\u8054\u8c03\u4e0e\u6d4b\u8bd5 \u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u5982\u4f55\u542f\u52a8\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u670d\u52a1. \u638c\u63e1\u5bf9\u8fd0\u884c\u670d\u52a1\u5206\u522b\u8fdb\u884c\u6d4b\u8bd5\u7684\u8fc7\u7a0b. \u7cfb\u7edf\u67b6\u6784\u56fe: \u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u4e3b\u8981\u670d\u52a1: werobot\u670d\u52a1 \u4e3b\u8981\u903b\u8f91\u670d\u52a1 \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1 redis\u670d\u52a1(\u4f1a\u8bdd\u7ba1\u7406) neo4j\u670d\u52a1(\u56fe\u6570\u636e\u67e5\u8be2) \u8bf4\u660e: \u7cfb\u7edf\u8054\u8c03\u4e0e\u6d4b\u8bd5\u662f\u5bf9\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u670d\u52a1\u7684\u8054\u8c03\u4e0e\u6d4b\u8bd5, \u4e0d\u5305\u542b\u79bb\u7ebf\u90e8\u5206\u7684\u5185\u5bb9. \u542f\u52a8\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u670d\u52a1: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1 \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1 \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1 \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u9ed8\u8ba4\u5df2\u542f\u52a8) \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1: nohup python /data/wr.py & \u8fd0\u884c\u4f4d\u7f6e: /dara/\u76ee\u5f55\u4e0b. \u901a\u8fc7\u7aef\u53e3\u67e5\u770b\u6302\u8d77\u7684\u670d\u52a1\u8fdb\u7a0b: # \u901a\u8fc7yum\u5b89\u88c5lsof\u547d\u4ee4 sudo yum install lsof -y # \u67e5\u770b80\u7aef\u53e3\u7684\u8fdb\u7a0b lsof -i:80 \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1 supervisor\u914d\u7f6e\u6587\u4ef6\u7b80\u8981\u5206\u6790: ... ; \u4f7f\u7528gunicorn\u542f\u52a8\u57fa\u4e8eFlask\u6846\u67b6\u7684\u4e3b\u8981\u903b\u8f91\u670d\u52a1 [program:main_server] command=gunicorn -w 1 -b 0.0.0.0:5000 app:app ; the program (relative uses PATH, can take args) stopsignal=QUIT ; signal used to kill process (default TERM) stopasgroup=false ; send stop signal to the UNIX process group (default false) killasgroup=false ; SIGKILL the UNIX process group (def false) stdout_logfile=./log/main_server_out ; stdout log path, NONE for none; default AUTO stdout_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) stderr_logfile=./log/main_server_error ; stderr log path, NONE for none; default AUTO stderr_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ; \u542f\u52a8redis\u670d\u52a1\uff0c\u4f5c\u4e3a\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93 [program:redis] command=redis-server \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_online/main_serve/supervisor.conf \u542f\u52a8\u670d\u52a1: # \u4f7f\u7528supervisord\u547d\u4ee4, \u8bfb\u53d6\u6307\u5b9a\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 supervisord -c /data/doctor_online/main_serve/supervisor.conf \u67e5\u770b\u542f\u52a8\u7684\u670d\u52a1\u72b6\u6001 supervisorctl status all \u8f93\u51fa\u6548\u679c: main_server RUNNING pid 31609, uptime 0:32:20 redis RUNNING pid 31613, uptime 0:32:18 \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1: \u7f16\u5199\u542f\u52a8\u811a\u672cstart.sh # \u811a\u672c\u4e2d\u662f\u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1\u7684\u547d\u4ee4 gunicorn -w 1 -b 0.0.0.0:5001 app:app \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/start.sh \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1 nohup sh /data/doctor_online/bert_serve/start.sh & \u8fd0\u884c\u4f4d\u7f6e: /data/doctor_online/bert_serve/\u76ee\u5f55\u4e0b. \u901a\u8fc7\u7aef\u53e3\u67e5\u770b\u6302\u8d77\u7684\u670d\u52a1\u8fdb\u7a0b # \u901a\u8fc7yum\u5b89\u88c5lsof\u547d\u4ee4 sudo yum install lsof -y # \u67e5\u770b5001\u7aef\u53e3\u7684\u8fdb\u7a0b lsof -i:5001 \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u56fe\u6570\u636e\u67e5\u8be2): # neo4j\u670d\u52a1\u5728\u4e4b\u524d\u5e94\u8be5\u4e00\u76f4\u5904\u5728\u542f\u52a8\u72b6\u6001 neo4j start # \u67e5\u770b\u670d\u52a1\u542f\u52a8\u72b6\u6001: neo4j status \u8fdb\u884c\u6d4b\u8bd5: \u7b2c\u4e00\u6b65: \u660e\u786e\u6d4b\u8bd5\u8bf4\u660e. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9. \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1. \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e00\u6b65: \u6d4b\u8bd5\u8bf4\u660e \u56e0\u4e3a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u662f\u6240\u6709\u5728\u7ebf\u670d\u52a1\u7684\u4e2d\u5fc3\u670d\u52a1(\u8be5\u670d\u52a1\u5c06\u63a5\u6536\u6216\u53d1\u9001\u8bf7\u6c42\u7ed9\u5176\u4ed6\u670d\u52a1), \u56e0\u6b64\u6211\u4eec\u7684\u6d4b\u8bd5\u6253\u5370\u4fe1\u606f\u90fd\u5728\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8fdb\u884c. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9 class Handler(object): \"\"\"\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u5904\u7406\u7c7b\"\"\" def __init__(self, uid, text, r, reply): \"\"\" :param uid: \u7528\u6237\u552f\u4e00\u6807\u793auid :param text: \u8be5\u7528\u6237\u672c\u6b21\u8f93\u5165\u7684\u6587\u672c :param r: redis\u6570\u636e\u5e93\u7684\u8fde\u63a5\u5bf9\u8c61 :param reply: \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u5bf9\u8c61(\u5b57\u5178) \"\"\" self.uid = uid self.text = text self.r = r self.reply = reply def non_first_sentence(self, previous): \"\"\" description: \u975e\u9996\u53e5\u5904\u7406\u51fd\u6570 :param previous: \u8be5\u7528\u6237\u5f53\u524d\u53e5(\u8f93\u5165\u6587\u672c)\u7684\u4e0a\u4e00\u53e5\u6587\u672c :return: \u6839\u636e\u903b\u8f91\u56fe\u8fd4\u56de\u975e\u9996\u53e5\u60c5\u51b5\u4e0b\u7684\u8f93\u51fa\u8bed\u53e5 \"\"\" # \u5c1d\u8bd5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u82e5\u5931\u8d25\u5219\u6253\u5370\u9519\u8bef\u7ed3\u679c ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u5df2\u7ecf\u8fdb\u5165\u975e\u9996\u53e5\u5904\u7406\u51fd\u6570. print(\"\u51c6\u5907\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1!\") ################################################### try: data = {\"text1\": previous, \"text2\": self.text} result = requests.post(model_serve_url, data=data) if not result.text: return unit_chat(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u8bf7\u6c42\u6210\u529f. print(\"\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a:\", result.text) ################################################### except Exception as e: print(\"\u6a21\u578b\u670d\u52a1\u5f02\u5e38:\", e) return unit_chat(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u5f00\u59cb\u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1. print(\"\u8bf7\u6c42\u6a21\u578b\u670d\u52a1\u540e, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1!\") ################################################### # \u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c s = query_neo4j(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eneo4j\u67e5\u8be2\u6210\u529f. print(\"neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c:\", s) ################################################### # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u82e5\u7ed3\u679c\u4e0d\u4e3a\u7a7a, \u83b7\u53d6\u4e0a\u4e00\u6b21\u5df2\u56de\u590d\u7684\u75be\u75c5old_disease old_disease = self.r.hget(str(self.uid), \"previous_d\") if old_disease: # new_disease\u662f\u672c\u6b21\u9700\u8981\u5b58\u50a8\u7684\u75be\u75c5, \u662f\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u4e0e\u672c\u6b21\u67e5\u8be2\u5230\u75be\u75c5\u7684\u5e76\u96c6 new_disease = list(set(s) | set(eval(old_disease))) # res\u662f\u9700\u8981\u8fd4\u56de\u7684\u75be\u75c5, \u662f\u672c\u6b21\u67e5\u8be2\u5230\u7684\u75be\u75c5\u4e0e\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u7684\u5dee\u96c6 res = list(set(s) - set(eval(old_disease))) else: # \u5982\u679cold_disease\u4e3a\u7a7a, \u5219\u5b83\u4eec\u76f8\u540c\u90fd\u662f\u672c\u6b21\u67e5\u8be2\u7ed3\u679cs res = new_disease = list(set(s)) # \u5b58\u50a8new_disease\u8986\u76d6\u4e4b\u524d\u7684old_disease self.r.hset(str(self.uid), \"previous_d\", str(new_disease)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de res = \",\".join(s) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eneo4j\u67e5\u8be2\u540e\u6709\u7ed3\u679c\u5e76\u5c06\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248. print(\"\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u8fdb\u884c\u8fd4\u56de\u5bf9\u8bdd\u7684\u751f\u6210!\") ################################################### print(\"###################################################\") return self.reply[\"2\"] %res def first_sentence(self): \"\"\"\u9996\u53e5\u5904\u7406\u51fd\u6570\"\"\" # \u76f4\u63a5\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u8fdb\u5165\u4e86\u9996\u53e5\u5904\u7406\u51fd\u6570\u5e76\u9a6c\u4e0a\u8fdb\u884cneo4j\u67e5\u8be2 print(\"\u8be5\u7528\u6237\u8fd1\u671f\u9996\u6b21\u53d1\u8a00, \u4e0d\u5fc5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1!\") ################################################### s = query_neo4j(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u5df2\u7ecf\u5b8c\u6210neo4j\u67e5\u8be2. print(\"neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a:\", s) ################################################### # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u5c06s\u5b58\u50a8\u4e3a\"\u4e0a\u4e00\u6b21\u8fd4\u56de\u7684\u75be\u75c5\" self.r.hset(str(self.uid), \"previous_d\", str(s)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de res = \",\".join(s) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eneo4j\u67e5\u8be2\u540e\u6709\u7ed3\u679c\u5e76\u5c06\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248. print(\"\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u751f\u6210\u6a21\u7248\u8fdb\u884c\u8fd4\u56de\u5bf9\u8bdd\u7684\u751f\u6210!\") ################################################### print(\"###################################################\") return self.reply[\"2\"] %res # \u8bbe\u5b9a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8def\u7531\u548c\u8bf7\u6c42\u65b9\u6cd5 @app.route('/v1/main_serve/', methods=[\"POST\"]) def main_serve(): ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660ewerobot\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u6210\u529f. print(\"\u5df2\u7ecf\u8fdb\u5165\u4e3b\u8981\u903b\u8f91\u670d\u52a1, werobot\u670d\u52a1\u8fd0\u884c\u6b63\u5e38!\") ################################################### # \u63a5\u6536\u6765\u81eawerobot\u670d\u52a1\u7684\u5b57\u6bb5 uid = request.form['uid'] text = request.form['text'] # \u4eceredis\u8fde\u63a5\u6c60\u4e2d\u83b7\u5f97\u4e00\u4e2a\u6d3b\u8dc3\u8fde\u63a5 r = redis.StrictRedis(connection_pool=pool) # \u6839\u636e\u8be5uid\u83b7\u53d6\u4ed6\u7684\u4e0a\u4e00\u53e5\u8bdd(\u53ef\u80fd\u4e0d\u5b58\u5728) previous = r.hget(str(uid), \"previous\") # \u5c06\u5f53\u524d\u8f93\u5165\u7684\u6587\u672c\u8bbe\u7f6e\u6210\u4e0a\u4e00\u53e5 r.hset(str(uid), \"previous\", text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eredis\u80fd\u591f\u6b63\u5e38\u8bfb\u53d6\u548c\u5199\u5165\u6570\u636e. print(\"\u5df2\u7ecf\u5b8c\u6210\u521d\u6b21\u4f1a\u8bdd\u7ba1\u7406, redis\u8fd0\u884c\u6b63\u5e38!\") ################################################### # \u8bfb\u53d6\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u5185\u5bb9\u5230\u5185\u5b58 reply = json.load(open(reply_path, \"r\")) # \u5b9e\u4f8b\u5316\u4e3b\u8981\u903b\u8f91\u5904\u7406\u5bf9\u8c61 handler = Handler(uid, text, r, reply) # \u5982\u679cprevious\u5b58\u5728, \u8bf4\u660e\u4e0d\u662f\u7b2c\u4e00\u53e5\u8bdd if previous: # \u8c03\u7528non_first_sentence\u65b9\u6cd5 return handler.non_first_sentence(previous) else: # \u5426\u5219\u8c03\u7528first_sentence()\u65b9\u6cd5 return handler.first_sentence() \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1 supervisorctl restart all \u8fd0\u884c\u4f4d\u7f6e: /data/doctor_online/main_serve \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7 \u6d4b\u8bd5\u8bf7\u6c421: \u7528\u6237\u5173\u6ce8\u516c\u4f17\u53f7\u540e\u9996\u6b21\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u6d4b\u8bd5\u8bf7\u6c422: \u9996\u6b21\u53d1\u9001\u540e\u7528\u6237\u7ee7\u7eed\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u6d4b\u8bd5\u8bf7\u6c421: \u7528\u6237\u5173\u6ce8\u516c\u4f17\u53f7\u540e\u9996\u6b21\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u5bf9\u5e94\u6570\u636e\u6d41: werobot\u670d\u52a1-->\u8bf7\u6c42\u4e3b\u8981\u903b\u8f91\u670d\u52a1-->\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8bf7\u6c42redis\u670d\u52a1-->\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1-->\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248/UnitAPI. \u5bf9\u5e94\u64cd\u4f5c: \u5173\u6ce8\u516c\u4f17\u53f7(\u4f7f\u7528\u65b0\u7528\u6237), \u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\". \u67e5\u770b\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u65e5\u5fd7: cat /data/doctor_online/main_serve/log/main_server_out \u65e5\u5fd7\u6253\u5370\u7ed3\u679c: ## \u6253\u5370\u5982\u4e0b\u7ed3\u679c\u8bf4\u660e\u6d4b\u8bd5\u6210\u529f! \u5df2\u7ecf\u8fdb\u5165\u4e3b\u8981\u903b\u8f91\u670d\u52a1, werobot\u670d\u52a1\u8fd0\u884c\u6b63\u5e38! \u5df2\u7ecf\u5b8c\u6210\u521d\u6b21\u4f1a\u8bdd\u7ba1\u7406, redis\u8fd0\u884c\u6b63\u5e38! \u8be5\u7528\u6237\u8fd1\u671f\u9996\u6b21\u53d1\u8a00, \u4e0d\u5fc5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1! neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a: ['\u766b\u75eb', '\u5c0f\u513f\u7cd6\u5c3f\u75c5', '\u80be\u4e0a\u817a\u5371\u8c61', '\u5f02\u4f4d\u6025\u6027\u9611\u5c3e\u708e', '\u6025\u6027\u80c6\u56ca\u708e'] \u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u8fdb\u884c\u8fd4\u56de\u751f\u6210\u7684\u5bf9\u8bdd! \u6d4b\u8bd5\u8bf7\u6c422: \u9996\u6b21\u53d1\u9001\u540e\u7528\u6237\u7ee7\u7eed\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u5bf9\u5e94\u6570\u636e\u6d41: werobot\u670d\u52a1-->\u8bf7\u6c42\u4e3b\u8981\u903b\u8f91\u670d\u52a1-->\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8bf7\u6c42redis\u670d\u52a1-->\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1-->\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1-->\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248/UnitAPI. \u5bf9\u5e94\u64cd\u4f5c: \u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\"\u540e, \u7ee7\u7eed\u53d1\u9001\"\u5e76\u4e14\u5de6\u8179\u90e8\u6709\u4e00\u4e9b\u7ea2\u70b9\". \u67e5\u770b\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u65e5\u5fd7: cat /data/doctor_online/main_serve/log/main_server_out \u65e5\u5fd7\u6253\u5370\u7ed3\u679c: ## \u6253\u5370\u5982\u4e0b\u7ed3\u679c\u8bf4\u660e\u6d4b\u8bd5\u6210\u529f!(\u4f7f\u7528UnitAPI\u8fd4\u56de\u7ed3\u679c) \u5df2\u7ecf\u8fdb\u5165\u4e3b\u8981\u903b\u8f91\u670d\u52a1, werobot\u670d\u52a1\u8fd0\u884c\u6b63\u5e38! \u5df2\u7ecf\u5b8c\u6210\u521d\u6b21\u4f1a\u8bdd\u7ba1\u7406, redis\u8fd0\u884c\u6b63\u5e38! \u51c6\u5907\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1! \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a: 1 \u8bf7\u6c42\u6a21\u578b\u670d\u52a1\u540e, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1! neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c: [] \u6ce8\u610f: \u6253\u5370\u65e5\u5fd7\u82e5\u4e0d\u80fd\u5373\u65f6\u51fa\u73b0, \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u5373\u53ef. \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u638c\u63e1\u5982\u4f55\u542f\u52a8\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u670d\u52a1: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1 \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1 \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1 \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u9ed8\u8ba4\u5df2\u542f\u52a8) \u5b66\u4e60\u4e86\u5982\u4f55\u8fdb\u884c\u6d4b\u8bd5: \u7b2c\u4e00\u6b65: \u660e\u786e\u6d4b\u8bd5\u8bf4\u660e. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9. \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1. \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e00\u6b65: \u6d4b\u8bd5\u8bf4\u660e \u56e0\u4e3a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u662f\u6240\u6709\u5728\u7ebf\u670d\u52a1\u7684\u4e2d\u5fc3\u670d\u52a1(\u8be5\u670d\u52a1\u5c06\u63a5\u6536\u6216\u53d1\u9001\u8bf7\u6c42\u7ed9\u5176\u4ed6\u670d\u52a1), \u56e0\u6b64\u6211\u4eec\u7684\u6d4b\u8bd5\u6253\u5370\u4fe1\u606f\u90fd\u5728\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8fdb\u884c. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9 \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1 \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7 \u6d4b\u8bd5\u8bf7\u6c421: \u7528\u6237\u5173\u6ce8\u516c\u4f17\u53f7\u540e\u9996\u6b21\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u6d4b\u8bd5\u8bf7\u6c422: \u9996\u6b21\u53d1\u9001\u540e\u7528\u6237\u7ee7\u7eed\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0.","title":"\u7b2c\u4e5d\u7ae0:\u7cfb\u7edf\u8054\u8c03\u4e0e\u6d4b\u8bd5"},{"location":"9/#91","text":"\u5b66\u4e60\u76ee\u6807: \u638c\u63e1\u5982\u4f55\u542f\u52a8\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u670d\u52a1. \u638c\u63e1\u5bf9\u8fd0\u884c\u670d\u52a1\u5206\u522b\u8fdb\u884c\u6d4b\u8bd5\u7684\u8fc7\u7a0b. \u7cfb\u7edf\u67b6\u6784\u56fe: \u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u4e3b\u8981\u670d\u52a1: werobot\u670d\u52a1 \u4e3b\u8981\u903b\u8f91\u670d\u52a1 \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1 redis\u670d\u52a1(\u4f1a\u8bdd\u7ba1\u7406) neo4j\u670d\u52a1(\u56fe\u6570\u636e\u67e5\u8be2) \u8bf4\u660e: \u7cfb\u7edf\u8054\u8c03\u4e0e\u6d4b\u8bd5\u662f\u5bf9\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u670d\u52a1\u7684\u8054\u8c03\u4e0e\u6d4b\u8bd5, \u4e0d\u5305\u542b\u79bb\u7ebf\u90e8\u5206\u7684\u5185\u5bb9. \u542f\u52a8\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u670d\u52a1: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1 \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1 \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1 \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u9ed8\u8ba4\u5df2\u542f\u52a8) \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1: nohup python /data/wr.py & \u8fd0\u884c\u4f4d\u7f6e: /dara/\u76ee\u5f55\u4e0b. \u901a\u8fc7\u7aef\u53e3\u67e5\u770b\u6302\u8d77\u7684\u670d\u52a1\u8fdb\u7a0b: # \u901a\u8fc7yum\u5b89\u88c5lsof\u547d\u4ee4 sudo yum install lsof -y # \u67e5\u770b80\u7aef\u53e3\u7684\u8fdb\u7a0b lsof -i:80 \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1 supervisor\u914d\u7f6e\u6587\u4ef6\u7b80\u8981\u5206\u6790: ... ; \u4f7f\u7528gunicorn\u542f\u52a8\u57fa\u4e8eFlask\u6846\u67b6\u7684\u4e3b\u8981\u903b\u8f91\u670d\u52a1 [program:main_server] command=gunicorn -w 1 -b 0.0.0.0:5000 app:app ; the program (relative uses PATH, can take args) stopsignal=QUIT ; signal used to kill process (default TERM) stopasgroup=false ; send stop signal to the UNIX process group (default false) killasgroup=false ; SIGKILL the UNIX process group (def false) stdout_logfile=./log/main_server_out ; stdout log path, NONE for none; default AUTO stdout_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) stderr_logfile=./log/main_server_error ; stderr log path, NONE for none; default AUTO stderr_logfile_maxbytes=1MB ; max # logfile bytes b4 rotation (default 50MB) ; \u542f\u52a8redis\u670d\u52a1\uff0c\u4f5c\u4e3a\u4f1a\u8bdd\u7ba1\u7406\u6570\u636e\u5e93 [program:redis] command=redis-server \u6587\u4ef6\u4f4d\u7f6e: /data/doctor_online/main_serve/supervisor.conf \u542f\u52a8\u670d\u52a1: # \u4f7f\u7528supervisord\u547d\u4ee4, \u8bfb\u53d6\u6307\u5b9a\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6 supervisord -c /data/doctor_online/main_serve/supervisor.conf \u67e5\u770b\u542f\u52a8\u7684\u670d\u52a1\u72b6\u6001 supervisorctl status all \u8f93\u51fa\u6548\u679c: main_server RUNNING pid 31609, uptime 0:32:20 redis RUNNING pid 31613, uptime 0:32:18 \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1: \u7f16\u5199\u542f\u52a8\u811a\u672cstart.sh # \u811a\u672c\u4e2d\u662f\u4f7f\u7528gunicorn\u542f\u52a8\u670d\u52a1\u7684\u547d\u4ee4 gunicorn -w 1 -b 0.0.0.0:5001 app:app \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/bert_serve/start.sh \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u670d\u52a1 nohup sh /data/doctor_online/bert_serve/start.sh & \u8fd0\u884c\u4f4d\u7f6e: /data/doctor_online/bert_serve/\u76ee\u5f55\u4e0b. \u901a\u8fc7\u7aef\u53e3\u67e5\u770b\u6302\u8d77\u7684\u670d\u52a1\u8fdb\u7a0b # \u901a\u8fc7yum\u5b89\u88c5lsof\u547d\u4ee4 sudo yum install lsof -y # \u67e5\u770b5001\u7aef\u53e3\u7684\u8fdb\u7a0b lsof -i:5001 \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u56fe\u6570\u636e\u67e5\u8be2): # neo4j\u670d\u52a1\u5728\u4e4b\u524d\u5e94\u8be5\u4e00\u76f4\u5904\u5728\u542f\u52a8\u72b6\u6001 neo4j start # \u67e5\u770b\u670d\u52a1\u542f\u52a8\u72b6\u6001: neo4j status \u8fdb\u884c\u6d4b\u8bd5: \u7b2c\u4e00\u6b65: \u660e\u786e\u6d4b\u8bd5\u8bf4\u660e. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9. \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1. \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e00\u6b65: \u6d4b\u8bd5\u8bf4\u660e \u56e0\u4e3a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u662f\u6240\u6709\u5728\u7ebf\u670d\u52a1\u7684\u4e2d\u5fc3\u670d\u52a1(\u8be5\u670d\u52a1\u5c06\u63a5\u6536\u6216\u53d1\u9001\u8bf7\u6c42\u7ed9\u5176\u4ed6\u670d\u52a1), \u56e0\u6b64\u6211\u4eec\u7684\u6d4b\u8bd5\u6253\u5370\u4fe1\u606f\u90fd\u5728\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8fdb\u884c. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9 class Handler(object): \"\"\"\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u5904\u7406\u7c7b\"\"\" def __init__(self, uid, text, r, reply): \"\"\" :param uid: \u7528\u6237\u552f\u4e00\u6807\u793auid :param text: \u8be5\u7528\u6237\u672c\u6b21\u8f93\u5165\u7684\u6587\u672c :param r: redis\u6570\u636e\u5e93\u7684\u8fde\u63a5\u5bf9\u8c61 :param reply: \u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u5bf9\u8c61(\u5b57\u5178) \"\"\" self.uid = uid self.text = text self.r = r self.reply = reply def non_first_sentence(self, previous): \"\"\" description: \u975e\u9996\u53e5\u5904\u7406\u51fd\u6570 :param previous: \u8be5\u7528\u6237\u5f53\u524d\u53e5(\u8f93\u5165\u6587\u672c)\u7684\u4e0a\u4e00\u53e5\u6587\u672c :return: \u6839\u636e\u903b\u8f91\u56fe\u8fd4\u56de\u975e\u9996\u53e5\u60c5\u51b5\u4e0b\u7684\u8f93\u51fa\u8bed\u53e5 \"\"\" # \u5c1d\u8bd5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u82e5\u5931\u8d25\u5219\u6253\u5370\u9519\u8bef\u7ed3\u679c ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u5df2\u7ecf\u8fdb\u5165\u975e\u9996\u53e5\u5904\u7406\u51fd\u6570. print(\"\u51c6\u5907\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1!\") ################################################### try: data = {\"text1\": previous, \"text2\": self.text} result = requests.post(model_serve_url, data=data) if not result.text: return unit_chat(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u8bf7\u6c42\u6210\u529f. print(\"\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a:\", result.text) ################################################### except Exception as e: print(\"\u6a21\u578b\u670d\u52a1\u5f02\u5e38:\", e) return unit_chat(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u5f00\u59cb\u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1. print(\"\u8bf7\u6c42\u6a21\u578b\u670d\u52a1\u540e, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1!\") ################################################### # \u7ee7\u7eed\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c s = query_neo4j(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eneo4j\u67e5\u8be2\u6210\u529f. print(\"neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c:\", s) ################################################### # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u82e5\u7ed3\u679c\u4e0d\u4e3a\u7a7a, \u83b7\u53d6\u4e0a\u4e00\u6b21\u5df2\u56de\u590d\u7684\u75be\u75c5old_disease old_disease = self.r.hget(str(self.uid), \"previous_d\") if old_disease: # new_disease\u662f\u672c\u6b21\u9700\u8981\u5b58\u50a8\u7684\u75be\u75c5, \u662f\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u4e0e\u672c\u6b21\u67e5\u8be2\u5230\u75be\u75c5\u7684\u5e76\u96c6 new_disease = list(set(s) | set(eval(old_disease))) # res\u662f\u9700\u8981\u8fd4\u56de\u7684\u75be\u75c5, \u662f\u672c\u6b21\u67e5\u8be2\u5230\u7684\u75be\u75c5\u4e0e\u5df2\u7ecf\u5b58\u50a8\u7684\u75be\u75c5\u7684\u5dee\u96c6 res = list(set(s) - set(eval(old_disease))) else: # \u5982\u679cold_disease\u4e3a\u7a7a, \u5219\u5b83\u4eec\u76f8\u540c\u90fd\u662f\u672c\u6b21\u67e5\u8be2\u7ed3\u679cs res = new_disease = list(set(s)) # \u5b58\u50a8new_disease\u8986\u76d6\u4e4b\u524d\u7684old_disease self.r.hset(str(self.uid), \"previous_d\", str(new_disease)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de res = \",\".join(s) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eneo4j\u67e5\u8be2\u540e\u6709\u7ed3\u679c\u5e76\u5c06\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248. print(\"\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u8fdb\u884c\u8fd4\u56de\u5bf9\u8bdd\u7684\u751f\u6210!\") ################################################### print(\"###################################################\") return self.reply[\"2\"] %res def first_sentence(self): \"\"\"\u9996\u53e5\u5904\u7406\u51fd\u6570\"\"\" # \u76f4\u63a5\u67e5\u8be2\u56fe\u6570\u636e\u5e93, \u5e76\u83b7\u5f97\u7ed3\u679c ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u8fdb\u5165\u4e86\u9996\u53e5\u5904\u7406\u51fd\u6570\u5e76\u9a6c\u4e0a\u8fdb\u884cneo4j\u67e5\u8be2 print(\"\u8be5\u7528\u6237\u8fd1\u671f\u9996\u6b21\u53d1\u8a00, \u4e0d\u5fc5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1!\") ################################################### s = query_neo4j(self.text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660e\u5df2\u7ecf\u5b8c\u6210neo4j\u67e5\u8be2. print(\"neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a:\", s) ################################################### # \u5224\u65ad\u7ed3\u679c\u4e3a\u7a7a\u5217\u8868, \u5219\u76f4\u63a5\u4f7f\u7528UnitAPI\u8fd4\u56de if not s: return unit_chat(self.text) # \u5c06s\u5b58\u50a8\u4e3a\"\u4e0a\u4e00\u6b21\u8fd4\u56de\u7684\u75be\u75c5\" self.r.hset(str(self.uid), \"previous_d\", str(s)) # \u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4 self.r.expire(str(self.uid), ex_time) # \u5c06\u5217\u8868\u8f6c\u5316\u4e3a\u5b57\u7b26\u4e32, \u6dfb\u52a0\u5230\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u4e2d\u8fd4\u56de res = \",\".join(s) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eneo4j\u67e5\u8be2\u540e\u6709\u7ed3\u679c\u5e76\u5c06\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248. print(\"\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u751f\u6210\u6a21\u7248\u8fdb\u884c\u8fd4\u56de\u5bf9\u8bdd\u7684\u751f\u6210!\") ################################################### print(\"###################################################\") return self.reply[\"2\"] %res # \u8bbe\u5b9a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u7684\u8def\u7531\u548c\u8bf7\u6c42\u65b9\u6cd5 @app.route('/v1/main_serve/', methods=[\"POST\"]) def main_serve(): ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660ewerobot\u670d\u52a1\u53d1\u9001\u8bf7\u6c42\u6210\u529f. print(\"\u5df2\u7ecf\u8fdb\u5165\u4e3b\u8981\u903b\u8f91\u670d\u52a1, werobot\u670d\u52a1\u8fd0\u884c\u6b63\u5e38!\") ################################################### # \u63a5\u6536\u6765\u81eawerobot\u670d\u52a1\u7684\u5b57\u6bb5 uid = request.form['uid'] text = request.form['text'] # \u4eceredis\u8fde\u63a5\u6c60\u4e2d\u83b7\u5f97\u4e00\u4e2a\u6d3b\u8dc3\u8fde\u63a5 r = redis.StrictRedis(connection_pool=pool) # \u6839\u636e\u8be5uid\u83b7\u53d6\u4ed6\u7684\u4e0a\u4e00\u53e5\u8bdd(\u53ef\u80fd\u4e0d\u5b58\u5728) previous = r.hget(str(uid), \"previous\") # \u5c06\u5f53\u524d\u8f93\u5165\u7684\u6587\u672c\u8bbe\u7f6e\u6210\u4e0a\u4e00\u53e5 r.hset(str(uid), \"previous\", text) ################################################### # \u80fd\u591f\u6253\u5370\u8be5\u4fe1\u606f, \u8bf4\u660eredis\u80fd\u591f\u6b63\u5e38\u8bfb\u53d6\u548c\u5199\u5165\u6570\u636e. print(\"\u5df2\u7ecf\u5b8c\u6210\u521d\u6b21\u4f1a\u8bdd\u7ba1\u7406, redis\u8fd0\u884c\u6b63\u5e38!\") ################################################### # \u8bfb\u53d6\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u5185\u5bb9\u5230\u5185\u5b58 reply = json.load(open(reply_path, \"r\")) # \u5b9e\u4f8b\u5316\u4e3b\u8981\u903b\u8f91\u5904\u7406\u5bf9\u8c61 handler = Handler(uid, text, r, reply) # \u5982\u679cprevious\u5b58\u5728, \u8bf4\u660e\u4e0d\u662f\u7b2c\u4e00\u53e5\u8bdd if previous: # \u8c03\u7528non_first_sentence\u65b9\u6cd5 return handler.non_first_sentence(previous) else: # \u5426\u5219\u8c03\u7528first_sentence()\u65b9\u6cd5 return handler.first_sentence() \u4ee3\u7801\u4f4d\u7f6e: /data/doctor_online/main_serve/app.py \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1 supervisorctl restart all \u8fd0\u884c\u4f4d\u7f6e: /data/doctor_online/main_serve \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7 \u6d4b\u8bd5\u8bf7\u6c421: \u7528\u6237\u5173\u6ce8\u516c\u4f17\u53f7\u540e\u9996\u6b21\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u6d4b\u8bd5\u8bf7\u6c422: \u9996\u6b21\u53d1\u9001\u540e\u7528\u6237\u7ee7\u7eed\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u6d4b\u8bd5\u8bf7\u6c421: \u7528\u6237\u5173\u6ce8\u516c\u4f17\u53f7\u540e\u9996\u6b21\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u5bf9\u5e94\u6570\u636e\u6d41: werobot\u670d\u52a1-->\u8bf7\u6c42\u4e3b\u8981\u903b\u8f91\u670d\u52a1-->\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8bf7\u6c42redis\u670d\u52a1-->\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1-->\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248/UnitAPI. \u5bf9\u5e94\u64cd\u4f5c: \u5173\u6ce8\u516c\u4f17\u53f7(\u4f7f\u7528\u65b0\u7528\u6237), \u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\". \u67e5\u770b\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u65e5\u5fd7: cat /data/doctor_online/main_serve/log/main_server_out \u65e5\u5fd7\u6253\u5370\u7ed3\u679c: ## \u6253\u5370\u5982\u4e0b\u7ed3\u679c\u8bf4\u660e\u6d4b\u8bd5\u6210\u529f! \u5df2\u7ecf\u8fdb\u5165\u4e3b\u8981\u903b\u8f91\u670d\u52a1, werobot\u670d\u52a1\u8fd0\u884c\u6b63\u5e38! \u5df2\u7ecf\u5b8c\u6210\u521d\u6b21\u4f1a\u8bdd\u7ba1\u7406, redis\u8fd0\u884c\u6b63\u5e38! \u8be5\u7528\u6237\u8fd1\u671f\u9996\u6b21\u53d1\u8a00, \u4e0d\u5fc5\u8bf7\u6c42\u6a21\u578b\u670d\u52a1, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1! neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a: ['\u766b\u75eb', '\u5c0f\u513f\u7cd6\u5c3f\u75c5', '\u80be\u4e0a\u817a\u5371\u8c61', '\u5f02\u4f4d\u6025\u6027\u9611\u5c3e\u708e', '\u6025\u6027\u80c6\u56ca\u708e'] \u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248\u8fdb\u884c\u8fd4\u56de\u751f\u6210\u7684\u5bf9\u8bdd! \u6d4b\u8bd5\u8bf7\u6c422: \u9996\u6b21\u53d1\u9001\u540e\u7528\u6237\u7ee7\u7eed\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u5bf9\u5e94\u6570\u636e\u6d41: werobot\u670d\u52a1-->\u8bf7\u6c42\u4e3b\u8981\u903b\u8f91\u670d\u52a1-->\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8bf7\u6c42redis\u670d\u52a1-->\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1-->\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1-->\u4f7f\u7528\u89c4\u5219\u5bf9\u8bdd\u6a21\u7248/UnitAPI. \u5bf9\u5e94\u64cd\u4f5c: \u53d1\u9001\"\u6211\u6700\u8fd1\u6709\u4e9b\u8179\u75db\"\u540e, \u7ee7\u7eed\u53d1\u9001\"\u5e76\u4e14\u5de6\u8179\u90e8\u6709\u4e00\u4e9b\u7ea2\u70b9\". \u67e5\u770b\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u65e5\u5fd7: cat /data/doctor_online/main_serve/log/main_server_out \u65e5\u5fd7\u6253\u5370\u7ed3\u679c: ## \u6253\u5370\u5982\u4e0b\u7ed3\u679c\u8bf4\u660e\u6d4b\u8bd5\u6210\u529f!(\u4f7f\u7528UnitAPI\u8fd4\u56de\u7ed3\u679c) \u5df2\u7ecf\u8fdb\u5165\u4e3b\u8981\u903b\u8f91\u670d\u52a1, werobot\u670d\u52a1\u8fd0\u884c\u6b63\u5e38! \u5df2\u7ecf\u5b8c\u6210\u521d\u6b21\u4f1a\u8bdd\u7ba1\u7406, redis\u8fd0\u884c\u6b63\u5e38! \u51c6\u5907\u8bf7\u6c42\u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1! \u53e5\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c\u4e3a: 1 \u8bf7\u6c42\u6a21\u578b\u670d\u52a1\u540e, \u51c6\u5907\u8bf7\u6c42neo4j\u67e5\u8be2\u670d\u52a1! neo4j\u67e5\u8be2\u670d\u52a1\u8bf7\u6c42\u6210\u529f, \u8fd4\u56de\u7ed3\u679c: [] \u6ce8\u610f: \u6253\u5370\u65e5\u5fd7\u82e5\u4e0d\u80fd\u5373\u65f6\u51fa\u73b0, \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u5373\u53ef. \u672c\u7ae0\u603b\u7ed3: \u5b66\u4e60\u4e86\u638c\u63e1\u5982\u4f55\u542f\u52a8\u7cfb\u7edf\u5728\u7ebf\u90e8\u5206\u7684\u670d\u52a1: \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8werobot\u670d\u52a1 \u4f7f\u7528supervisor\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u53ca\u5176redis\u670d\u52a1 \u4ee5\u6302\u8d77\u7684\u65b9\u5f0f\u542f\u52a8\u5b50\u76f8\u5173\u6a21\u578b\u670d\u52a1 \u542f\u52a8\u548c\u67e5\u770bneo4j\u670d\u52a1(\u9ed8\u8ba4\u5df2\u542f\u52a8) \u5b66\u4e60\u4e86\u5982\u4f55\u8fdb\u884c\u6d4b\u8bd5: \u7b2c\u4e00\u6b65: \u660e\u786e\u6d4b\u8bd5\u8bf4\u660e. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9. \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1. \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7. \u7b2c\u4e00\u6b65: \u6d4b\u8bd5\u8bf4\u660e \u56e0\u4e3a\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u662f\u6240\u6709\u5728\u7ebf\u670d\u52a1\u7684\u4e2d\u5fc3\u670d\u52a1(\u8be5\u670d\u52a1\u5c06\u63a5\u6536\u6216\u53d1\u9001\u8bf7\u6c42\u7ed9\u5176\u4ed6\u670d\u52a1), \u56e0\u6b64\u6211\u4eec\u7684\u6d4b\u8bd5\u6253\u5370\u4fe1\u606f\u90fd\u5728\u4e3b\u8981\u903b\u8f91\u670d\u52a1\u4e2d\u8fdb\u884c. \u7b2c\u4e8c\u6b65: \u6dfb\u52a0\u6253\u5370\u6d4b\u8bd5\u5185\u5bb9 \u7b2c\u4e09\u6b65: \u91cd\u65b0\u542f\u52a8\u4e3b\u8981\u903b\u8f91\u670d\u52a1 \u7b2c\u56db\u6b65: \u8fdb\u884c\u6570\u636e\u6d41\u6d4b\u8bd5\u5e76\u67e5\u770b\u6253\u5370\u65e5\u5fd7 \u6d4b\u8bd5\u8bf7\u6c421: \u7528\u6237\u5173\u6ce8\u516c\u4f17\u53f7\u540e\u9996\u6b21\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0. \u6d4b\u8bd5\u8bf7\u6c422: \u9996\u6b21\u53d1\u9001\u540e\u7528\u6237\u7ee7\u7eed\u53d1\u9001\u4e00\u4e9b\u75c7\u72b6\u63cf\u8ff0.","title":"9.1 \u7cfb\u7edf\u8054\u8c03\u4e0e\u6d4b\u8bd5"}]}